'use strict';(function(o){function V(a,b){var c=a.indexOfPoint(thrSvg.pointFromEvent(b,a.$svg[0],a.smgInv));this.textEd=a;a.sel(c,c)}function M(a,b){if(this.justText=b)this.$tx=$(a.currentTarget),this.s="Text",this.r={x:0,y:0,width:200,height:48};else{var c=this;this.$g=$(a.target).closest("g");this.$shapePicker=this.$g.closest(".thrAccordeon").parent();this.$shapePicker.data("dragging",!0);this.acceptDropShape=this.$shapePicker.data("acceptdropshape");thrShapes.getShape(this.$g.data("uuid").toString(),
function(a){c.s=a;c.r=a.bounds?{x:a.bounds.x,y:a.bounds.y,width:a.bounds.width*(a.bounds.initialSize||3),height:a.bounds.height*(a.bounds.initialSize||3)}:{x:0,y:0,width:48,height:48};a.spec&&"sankey"===a.spec.cmd&&(c.r["width"===a.spec.auto?"height":"width"]=20)})}this.pt={x:a.clientX,y:a.clientY}}function N(a){return a&&(1===a.d||thrMath.rexFixed.test(a.s)||a.f)}function x(a,b){return Math.abs(a-b)<=1E-9*Math.max(Math.abs(a),Math.abs(b))}function y(a,b,c){var d=!0;b=b.slice(0);var e=0;for(c=a.length-
(c||0);e<c;e++)(d=d&&b.length&&b[0]===a[e])?b.shift():b.unshift("..");return b}function q(a,b,c){a=a.slice(0,a.length-(c||0));void 0!==b&&($.isArray(b)?b:[b]).forEach(function(a){".."===a?this.pop():this.push(a)},a);return a}function J(a,b){this.a=a||[];void 0!==b&&(this.adj=b)}function O(a,b,c){this.clear(a,c);b&&(this.d=b)}function W(a,b){this.mEnv=a;this.clear(b)}function X(a,b,c,d){this.mEnv=a;this.ctx=b.slice(0);this.onError=c;this.onWarning=d;this.clear()}function D(a){return a?"inputs":"outputs"}
function P(a,b){this.sd=a;this.con=b}function Y(a,b){this.sd=a;this.item=b}function Z(a,b,c){this.id=c;this.settings={itemBoxPadding:0.3,legendBoxPadding:5,tagBoxPadding:3,textLinePadding:0,selPathWidth:3,selLineWidth:2,selSize:15,selHeadSize:16};this.mc=b;this.createSvg(a);this.clearGUI();this.clearSelection()}function Q(a){var b=$.Event("getMathInfo");a.trigger(b);return b.mInfo}function G(a){var b=$.Event("getUserform");a.trigger(b);return b.userform}function aa(a,b,c,d){c.sub.forEach(function(c){for(var f,
g=b.length-1,h=c.name;0<=g;g--)if(b[g].getText(a)===h){f=b[g];break}f?f.getMValDiff(a,c,d):d.err.push(c)});return d}function ba(a){var b=$(a.target).closest("tr");b.parent().is("thead")&&(b=b.parent().closest("tr"));this.$tr=b;this.rowRect=b[0].getBoundingClientRect();this.$savParent=b.parent();this.savIx=b.index();this.wasSelected=b.hasClass("thrSelected");b.addClass("thrSelected");this.$formtbody=b.closest(".thrUserform").find("\x3etbody");this.formRect=this.$formtbody[0].getBoundingClientRect();
this.$scrollBox=this.$formtbody.parent().parent();this.scrollTop=this.$scrollBox.scrollTop();this.scrollBoxRect=this.$scrollBox[0].getBoundingClientRect();this.scrollMax=this.formRect.height-this.scrollBoxRect.height;this.lastY=a.clientY;this.doSelect=!0}function v(a){return"ib:"===a.slice(0,3)?a.slice(3):a}function R(a,b,c){var d=new ThrTreeNode(c),e=0;b.forEach(function(b){d.add(b.path?b.path.split("/"):[],a?void 0:b);a&&(e+=b.id)});d.sort();d.fileCount=a?e:b.length;return d}function E(a,b,c){return(b||
thr0.getKeyArray(a.config.objTypes,"name")).reduce(function(a,b){var c=b.toLowerCase();a.push(c+"revs");a.push(c+"sesrevs");return a},c?[]:["buckets","metarevs","metasesrevs"])}function ca(a,b){var c=thr0.getUserInfo(),c={uuid:a,userId:c.id,id:1,sessionId:1,dispName:c.dispName,userRight:0};b&&b(c);return c}function da(a,b,c,d,e,f,g){try{var h=a.getEditor(c),i=thr0.inflateObject(e),j=new ThrFile({uuid:c,userId:h.userId,path:d,name:b,editor:h}),k=i.objs.filter(function(a){return a.revisions&&a.revisions.length}).map(function(a){return{id:a.id,
type:a.type,revData:a.revisions[0].revData}});j.addRevision({objs:k});i.objs.forEach(function(a){this.getObject(a,!0)},j);a.createFile(j,!1,f)}catch(l){g&&g(l)}}function ea(a,b,c){a.getHead({uuid:b},!1,function(d){d.editor=a.getEditor(b);d.userId=d.editor.userId;d.metaSesRevs.length&&d.mergeSessionRevsToRevision();d.mergeRevisions();thr0.triggerDownloadLink(c,thr0.deflateObject(d.getData()),thrDatastore.mimeTypes.gfiles)})}function fa(a,b){var c=b&&b.simpleTables?thr0.arrayObjByKey(b.simpleTables,
"name",a):void 0;return c&&c.isSysTable}function C(a){function b(a){return a?a.match(/^sfs([0-9]+)(S?\D)(\d*)_*(\D*)(\d*)/):void 0}if(a.length){var c=b(a.attr("id"));for(this.isEdText=a.is("tspan, text")||a.hasClass("thrTextBkg")||a.hasClass("thrSelText");!a.is("svg")&&(!c||!c.length);)a=a.parent(),c=b(a.attr("id"));if(c&&c.length&&(this.sd=sfsSvgDiagram.getDiagram(parseInt(c[1],10)))){this.isSelector="S"===c[2].charAt(0);this.elementType=c[2].match(/.$/)[0];"B"===this.elementType&&"rand"===c[4]&&
(this.elementType="0");if(0<="LC0".indexOf(this.elementType)&&(this.isEdText=!1,"0"===this.elementType))return;this.id=parseInt(c[3],10);c[4]?(this.subType=c[4],this.subId=c[5]?parseInt(c[5],10):0):"I"===this.elementType&&this.isEdText&&(a=this.getObj(),a instanceof SfsItem&&1<a.textPos&&(this.subType="tx"))}}}function H(){this.clear()}function ga(a,b){this.sd=a;this.invCtm=(b||a.$svg)[0].getScreenCTM().inverse();this.limitRect={x:0,y:0,width:a.diagram.width,height:a.diagram.height};this.lastContainerPt=
{x:0,y:0}}function F(a,b,c,d){var e=a.$getGroup("H"),f={"class":"sfsActionHint"};this.sd=a;this.zoom=d;this.$bkg=thrSvg.$appendElement(e,"rect",f);this.$tx=thrSvg.$appendElement(e,"text",f,b||"");c&&this.adjustToPt(c,b)}function S(a,b,c,d,e){var f=a.diagram,g=f.snapBoxBorder,h=$.extend(new o.SfsItem(f.defaultItem),{x:0,y:0}),i=h.getCenter(),j=c instanceof SfsItem?{items:[{id:c.id,x:c.x,y:c.y,width:c.width,height:c.height}]}:c instanceof SfsConnection?{connections:[{id:c.id,points:[],stretches:[]}]}:
void 0;a.hoverElement&&(a.hoverElement=void 0,sfsEditorUI.renderHoverSelectors(a),c instanceof SfsItem&&sfsEditorUI.select(a,{items:[c.id]}));this.snapInfo=(new H).initSnapLines(a);u.initialize(this,a,b,j,this.getHintTx(this.snapInfo.targetCaption()));thr0.setXY(h,-i.x,-i.y);this.i0=h;this.i0d=thr0.vectorLength(i)+g;this.i0Frame=thrShapes.canSnapToFrame(h.shape)?thr0.expandedFrame(h.getFrame(a),{x:0,y:0},g):void 0;this.i0Cpts=h.getConPts(this.i0Frame,a)||sfsEditorUI.defaultConPts(h,h.rot,f.snapBoxBorder);
this.el=c;if(c instanceof SfsItem){if(b=c.getBoundsRect(a),this.itemFrame=thr0.expandedFrame(c.getFrame(a),thr0.rectCenter(b),g),this.itemPts=c.getConPts(this.itemFrame,a)||sfsEditorUI.defaultConPts(c,c.rot,f.snapBoxBorder))this.newStartPt=thr0.closestPt(this.startPt,this.itemPts)}else c instanceof SfsConnection&&(f=a.findConRenderer(c.id),c=c.stretches[d],this.newStartPt=thr0.closestLinePt(this.startPt,[f.getPt(c.a),f.getPt(c.b)]));this.stx=d;this.isSource=e;this.$connectLine=thrSvg.$appendElement(a.$getGroup("H"),
"path",{d:"M0,0Z","stroke-width":a.selStrokeWidth(),"class":"sfsConnect"});this.angleHint=new F(a,"0\u00b0",this.startPt,this.zoom)}function ha(a,b,c){u.initialize(this,a,b,void 0,this.getHintTx(b));this.$lassoRect=thrSvg.$appendElement(a.$getGroup("H"),"rect",{x:this.startPt.x,y:this.startPt.y,width:0,height:0,"stroke-width":a.selStrokeWidth(),"class":"sfsLasso"});this.isEmpty=a.diagram.isEmpty();this.defaultSelObj=c;this.changed=!0}function K(a,b,c,d,e,f,g){c=$.extend(!0,new SfsConnection,JSON.parse(JSON.stringify(c)));
this.dt=new Date;u.initialize(this,a,b,{connections:[{id:c.id,points:[],stretches:[]}]});this.con=c;c.points.forEach(function(a,b){thr0.setXYFromPt(a,this.getPt(b))},a.findConRenderer(c.id));this.conRenderer=a.makeConRenderer(c);this.stx=[];this.$selSt=[];this.angleHint=[];this.isNewEndPt=g;e&&!g?(b=c.points[d],this.way=b.way,this.ptx=d,this.$selPt=$(e),this.findOrthoAlignments(b),this.initSnapInfo(void 0!==b.itemId?a.diagram.getItem(b.itemId):void 0),this.$selPt.closest("g").find(".sfsRoutePt").attr("r",
100*a.settings.selSize/(4*this.zoom)),a.$svg.find(".sfsNewRoutePt").remove()):(this.isNewPt=!0,g?(this.way=c.points[d].way,this.ptx=d):this.stxNewPt=d,f||this.showNewPt())}function L(a,b,c,d){var e,f={};this.$tempHidden=a.$svg.find(".sfsSizer, .sfsConnector, .sfsRouteSt, .sfsRoutePt, .sfsRotate, .thrSelText");this.mouseInfo=c;this.dt=new Date;this.isConTag=c&&c.subType&&0<=SfsConnection.prototype.tagTypes.indexOf(c.subType);this.isText=c&&"tx"===c.subType||!c&&"tx"===a.selection.sub;this.isLegend=
c&&"L"===c.elementType;if((this.objs=e=c&&c.subType?[c.getObj()]:a.selectedObjects())&&e.length)if(e[0]instanceof SfsItem){if(1<e.length||e[0].hiddenShape)this.isText=!1;f.items=e.map(function(a){return this.isText?{id:a.id,text:{x:a.text.x,y:a.text.y}}:{id:a.id,x:a.x,y:a.y}},this)}else e[0]instanceof SfsConnection&&(f.connections=e.map(function(a){return{id:a.id,points:[]}}));this.isItems=!this.isConTag&&!this.isText&&!this.isLegend;u.initialize(this,a,b,f,"");this.icInfo=this.isItems?sfsEditorMC.prepareItemChange(a.diagram,
f.items,{allMovedDelta:{x:0,y:0},selRect:thr0.boundingRect(e)}):void 0;this.e0={clientX:b.clientX,clientY:b.clientY};this.$selectors=this.isText?$("#sfs"+a.id+"SI"+e[0].id+"_tx"):c&&"C"===c.elementType?$("#sfs"+a.id+"SC"+c.id+"_"+c.subType+c.subId):$(".sfsSel");this.bounds=this.isConTag?thr0.expandedRect(thrSvg.bboxToRect(b.target.getBBox()),"text"===b.target.tagName?a.settings.tagBoxPadding:0):sfsEditorUI.selectionBounds(a,e,this.isText);if(!c||"C"!==c.elementType)b=1===e.length&&e[0]instanceof SfsItem,
this.isText&&b?(this.$tempHidden=this.$tempHidden.add(this.$selectors),this.$tempCreated=thrSvg.$appendElement(a.$svg,"g"),this.$selectors.clone().appendTo(this.$tempCreated).attr("transform",this.$selectors.parent().parent().attr("transform")),this.$selectors=this.$tempCreated):(this.$selectors=this.$selectors.parent(),b&&(this.$selectors=this.$selectors.parent(),e[0].rot&&(this.hidePosInd=!0,this.bounds=thr0.boundingRect(e[0].getFrame(a)))));this.selTransform=this.$selectors.map(function(){return $(this).attr("transform")||
""});this.$sbMain=sfsEditorUI.$findSelectorBox(a);this.ctx.limitRect={x:this.startPt.x-this.bounds.x,y:this.startPt.y-this.bounds.y,width:this.ctx.limitRect.width-this.bounds.width,height:this.ctx.limitRect.height-this.bounds.height};d&&(this.snapInfo=this.isConTag?(new H).initFromConTags(a,c):(new H).initFromItems(a,void 0,this.isText?void 0:e,"I"===c.elementType&&!c.subType).addOrthoPts(e));this.$tempHidden.css("display","none");this.posInd=[];if(!this.hidePosInd){for(c=0;4>c;c++)this.posInd.push(new F(a,
"0",void 0,this.zoom));this.adjustPosInd({x:0,y:0})}}function T(a,b,c,d){function e(a,b){var c=thr0.expandedRect(b,-1),d=thr0.boundsPt(b,a.szType),e=thr0.boundsPt(c,a.szType+3),c=thr0.boundsPt(c,a.szType+5),f=thr0.angle(e,c)-90,e=Math.min(thr0.cutFrameLine(e,f,a.ctx.limitRect).d,thr0.cutFrameLine(c,f,a.ctx.limitRect).d)+1;b.rot&&(d=thr0.rotatePt(d,b.cPt,-b.rot));switch(a.szType){case 3:return{x:d.x+b.width-e,y:d.y,width:e-a.minWidth,height:0};case 5:return{x:d.x,y:d.y+b.height-e,width:0,height:e-
a.minHeight};case 7:return{x:d.x-(b.width-a.minWidth),y:d.y,width:e-a.minWidth,height:0};default:return{x:d.x,y:d.y-(b.height-a.minHeight),width:0,height:e-a.minHeight}}}var f,g,h,i,j=[];this.szType=c?c.subId:0;h=this.szType&1;this.isText=g="tx"===a.selection.sub;this.isLegend="l"===a.selection.sub;!c&&g&&(c=new C($("#sfs"+a.id+"SI"+a.selection.items[0]+"_tx")));this.mouseInfo=c;if(this.objs=c=this.isText?[c.getObj()]:a.selectedObjects()){if(1<c.length||c.length&&c[0].hiddenShape)this.isText=!1;1===
c.length&&(f=c[0],f.shape&&f.shape.bounds&&(this.origWHRatio=f.shape.bounds.width/(f.shape.bounds.height||1)));i={items:c.filter(function(a){return a instanceof SfsItem}).map(function(a){return g?{id:a.id,text:{x:a.text.x,y:a.text.y,width:a.text.width,height:a.text.height}}:{id:a.id,x:a.x,y:a.y,width:a.width,height:a.height}})}}this.isItems=!this.isText&&!this.isLegend;u.initialize(this,a,b,i,void 0,f&&f.rot?$("#sfs"+a.id+"SI"+f.id):void 0);this.$selectors=f&&!this.isLegend?$("#sfs"+a.id+"SI"+f.id+
(this.isText?"_tx":"_")):$(".sfsSel");this.selRects=this.$selectors.map(function(){var b=(new C($(this))).getObj();return b instanceof SfsItem?g?b.getTextrect(a.diagram,0,0,a):b.getBoundsRect(a):thrSvg.rectFromElementAttrs($(this))}).get();this.bounds=f=1===this.selRects.length?this.selRects[0]:thr0.boundingRect(this.selRects);this.icInfo=this.isItems?sfsEditorMC.prepareItemChange(a.diagram,i.items,{allSizedDelta:{x:0,y:0},selRect:thr0.boundingRect(c),boundsRect:f,szType:this.szType}):void 0;void 0===
this.origWHRatio&&(this.origWHRatio=f.width/(f.height||1));this.minWidth=SfsItem.prototype.minSize*f.width/thr0.minOfArray(this.selRects,"width",a.diagram.width);this.minHeight=SfsItem.prototype.minSize*f.height/thr0.minOfArray(this.selRects,"height",a.diagram.height);this.snapRelevants=[0,0,0,0,0,0];i=this.ctx;var k;if(h)k=e(this,f);else{var l;l={x:f.x+thr0.szRight[this.szType]*this.minWidth,y:f.y+thr0.szBottom[this.szType]*this.minHeight,width:f.width-this.minWidth,height:f.height-this.minHeight,
rot:f.rot,cPt:f.cPt};var m=thr0.boundsPt(l,this.szType+4),n=this.ctx.limitRect;f.rot&&0.02<Math.abs(Math.sin(f.rot*thr0.deg2rad))&&0.02<Math.abs(Math.cos(f.rot*thr0.deg2rad))?(k=thr0.boundsPt(l,this.szType+2),l=thr0.boundsPt(l,this.szType+6),k=k.x<m.x&&l.x<m.x?{x:0,y:0,width:m.x,height:n.height}:k.x>m.x&&l.x>m.x?{x:m.x,y:0,width:n.width-m.x,height:n.height}:k.y<m.y&&l.y<m.y?{x:0,y:0,width:n.width,height:m.y}:{x:0,y:m.y,width:n.width,height:n.height-m.y}):(k=thr0.boundsPt(l,this.szType),l={x:k.x<m.x?
0:n.width,y:k.y<m.y?0:n.height},k={x:Math.min(l.x,m.x),y:Math.min(l.y,m.y),width:Math.abs(l.x-m.x),height:Math.abs(l.y-m.y)});k.rot=f.rot;k.cPt=f.cPt}i.limitRect=k;this.startPt=this.ctx.containerPt(b,thr0.boundsPt(h?{x:f.x,y:f.y,width:f.width,height:f.height}:f,this.szType));!f.rot&&!thr0.szHeight[this.szType]&&(j.push("v"),this.snapRelevants[thr0.szRight[this.szType]?2:0]=1);!f.rot&&!thr0.szWidth[this.szType]&&(j.push("h"),this.snapRelevants[thr0.szTop[this.szType]?3:5]=1);this.sd=a;a.activeAction=
this;d&&!f.rot&&(this.snapInfo=(new H).initFromItems(a,j,c));this.sizeInd=new F(a,f.width+" x "+f.height,void 0,this.zoom);this.adjustSizeInd({x:0,y:0})}function ia(a,b){var c,d,e=a.selectedObjects()[0],f=e.getCenter();this.obj=e;u.initialize(this,a,b,{items:[{id:e.id,shape:e.shape}]},"");this.dir=c=e.shape.spec.rot||0;d=thr0.verticalAngle(c,!0);this.cLine=thr0.getLine(f,thr0.verticalAngle(c,!0),100);this.size=a.getObjSize(e)/2;this.previewPts=[thr0.movedPt(f,d,-this.size),f,thr0.movedPt(f,d,this.size),
thr0.movedPt(f,d,this.size),f,thr0.movedPt(f,d,-this.size)];this.arrowAngle=thrShapes.getArrowAngle(e.shape);this.$arrowAngle=thrSvg.$appendElement(a.$svg.find("#sfs"+a.id+"S"),"path",{d:this.getPreviewPath(this.arrowAngle),"stroke-width":a.selStrokeWidth(),"class":"sfsConnect"})}function ja(a,b){var c=thr0.filterArrayByType(a.selectedObjects(),SfsItem),d={items:c.map(function(a){return{id:a.id,x:a.x,y:a.y,rot:a.rot||0}})},e=1===c.length?c[0]:void 0,f="#sfs"+a.id;this.objs=c;this.rot=e?e.rot||0:0;
u.initialize(this,a,b,d,"");this.$sel=a.$svg.find(f+"S"+(e?"I"+e.id:""));this.$b=a.$svg.find(f+"B");this.cPt=thr0.rectCenter(sfsEditorUI.selectionBounds(a,this.objs));this.icInfo=sfsEditorMC.prepareItemChange(a.diagram,d.items,{allRotate:1,cPt:this.cPt});this.startAngle=thr0.angle(this.cPt,this.startPt)}$.ajaxSetup({cache:!1});$.ajaxTransport("+*",function(a,b,c){if(o.FormData&&(a.dataType&&("blob"===a.dataType||"arraybuffer"===a.dataType)||a.data&&(o.Blob&&a.data instanceof Blob||o.ArrayBuffer&&
a.data instanceof ArrayBuffer)))return{send:function(b,c){var f=new XMLHttpRequest,g=a.dataType||"text",h;f.addEventListener("load",function(){var a={};200<=f.status&&300>f.status||304===f.status?a[g]=f.response:a.text=String.fromCharCode.apply(null,new Uint8Array(f.response));c(f.status,f.statusText,a,f.getAllResponseHeaders())});f.open(a.type||"GET",a.url||o.location.href,a.async||!0);f.responseType=g;for(h in b)b.hasOwnProperty(h)&&f.setRequestHeader(h,b[h]);f.send(a.data||null)},abort:function(){c.abort()}}});
o.ThrTreeNode=function(a){a&&(this.name=a);this.sub=[]};ThrTreeNode.prototype={name:"",initFromObject:function(a,b){function c(a,b){if(a&&b){var c=thr0.findInArray(b,function(a){return void 0!==this[a]},a);return c?a[c]:void 0}return a||""}this.name=c(a[b.name],b.nameProps);a[b.nodes]&&(this.sub=a[b.nodes].map(function(a){var c=new ThrTreeNode;c.initFromObject(a,b);return c}));a[b.items]&&(this.sub=this.sub.concat(a[b.items].map(function(a){return{name:c(a[b.name],b.nameProps),val:b.val?c(a[b.val],
b.valProps):void 0}})))},nodes:function(){return this.sub.filter(function(a){return a instanceof ThrTreeNode})},items:function(){return this.sub.filter(function(a){return!(a instanceof ThrTreeNode)})},hasSubNodes:function(){return this.sub.some(function(a){return a instanceof ThrTreeNode})},add:function(a,b){var c=a.reduce(function(a,b){return a.findSubNode(b)||a.addNode(b)},this);void 0!==b&&c.sub.push(b)},addNode:function(a){a=new ThrTreeNode(a);this.sub.push(a);return a},findSubNode:function(a){for(var b=
this.sub,c=b.length-1;0<=c;c--){var d=b[c];if(d instanceof ThrTreeNode&&d.name===a)return d}},findNode:function(a){return a.reduce(function(a,c){return a?a.findSubNode(c):a},this)},findItem:function(a){var b=a.pop();return(a=this.findNode(a))&&0<=b&&b<a.sub.length&&!(a.sub[b]instanceof ThrTreeNode)?a.sub[b]:void 0},deleteItem:function(a){return thr0.removeFromArray(this.sub,a)||this.sub.some(function(a){if(a instanceof ThrTreeNode)return a.deleteItem(this.it)},{it:a})},getPathList:function(a){return this.nodes().reduce(function(b,
c){return b.concat(c.getPathList(a+"/"+c.name))},[a])},getItemList:function(){return this.sub.reduce(function(a,b){if(b instanceof ThrTreeNode)return a.concat(b.getItemList());a.push(b);return a},[])},forEachItem:function(a){this.sub.forEach(function(b){b instanceof ThrTreeNode?b.forEachItem(a):a(b)})},sort:function(){this.sub.sort(function(a,b){function c(a){return(a instanceof ThrTreeNode?"0"+(a.name||""):"object"===typeof a?"1"+(a.name||""):"1").toLowerCase()}var d=c(a),e=c(b);return d===e?0:d<
e?-1:1});this.sub.forEach(function(a){a instanceof ThrTreeNode&&a.sort()})},count:function(a){return this.sub.reduce(function(b,c){return b+(c instanceof ThrTreeNode?c.count(a):1)},a?0:1)}};o.thrNtx={registry:[],iso639_1:"en",availableIso639_1:["en","de"],availableLangs:["English","Deutsch"],url:{ntxFolder:"resources/ntx/",userLang:"accountsvc/userlang"},derivedLocale:function(){return/de/i.test(this.iso639_1)?"de-DE":"en-US"},register:function(a){a.ntx&&this.registry.push(a)},unregister:function(a){thr0.removeFromArray(this.registry,
a)},tempAppendFormCache:function(a){if(a){var b,c=$("\x3cdiv class\x3d'thrNoDisplay'\x3e\x3c/div\x3e").appendTo("body");for(b in a)a.hasOwnProperty(b)&&"string"===typeof a[b].html&&c.append("\x3cdiv data-formname\x3d'"+b+"'\x3e"+a[b].html+"\x3c/div\x3e");return c}},countriesNtxFileName:function(a){return"ntx_countries_"+a+".json"},loadCountries:function(a,b){this.countries?b&&b(this.countries):thr0.getCachedRes(this.url.ntxFolder+this.countriesNtxFileName(a),1,function(c){thrNtx.iso639_1===a&&("string"===
typeof c&&(c=JSON.parse(c)),thrNtx.countries=c,b&&b(c))},function(){"en"!==a&&thrNtx.loadCountries("en",b)})},getCountries:function(a){this.loadCountries(this.iso639_1,a)},getCountriesList:function(){var a=[],b=this.countries,c;for(c in b)b.hasOwnProperty(c)&&a.push(b[c]);a.sort(function(a,b){return a.localeCompare(b)});return a},countryToIso639_1:function(a){var b=this.countries,c;for(c in b)if(b.hasOwnProperty(c)&&b[c]===a)return c},iso639_1ToCountry:function(a){return this.countries&&this.countries.hasOwnProperty(a)?
this.countries[a]:a},indexOfIso639_1:function(a){var b=this.countries,c=0;a=(a||"").toLowerCase();for(var d in b)if(b.hasOwnProperty(d)){if(d===a)return c;c++}return-1},dumpCountriesNtx:function(){this.getCountries(function(a){thr0.triggerDownloadLink(thrNtx.countriesNtxFileName(thrNtx.iso639_1),a,"application/json")})},isPageLangAvailable:function(a){var b=$("head\x3emeta[name\x3davailableNtx]");return b.length&&0<=b.attr("content").split(",").indexOf(a.toLowerCase())},showAlternatLangPage:function(a){var b=
$("head\x3emeta[name\x3d'thrlang']"),c=$("head\x3emeta[name\x3d'pagename']");if(b.length){var d=a.toLowerCase(),e="en"===d;if(d!==b.attr("content").toLowerCase()&&1===c.length){b=c.attr("content");c=o.location.href;d="";if("/"===c.charAt(c.length-1))c+=b.split("/").pop();else{var f=c.match(/^([^#\?=]*)[#\?=].*$/);f&&(d=c.substring(f[1].length),c=f[1])}o.location.href=c.substring(0,c.length-b.length-(e?3:0))+(e?"":"/"+a.toUpperCase())+b+d}return!0}},pageNtxFilename:function(a){var b=$("head\x3emeta[name\x3d'pagename']"),
b=(b.length?b.attr("content"):o.location.pathname).split("/"),c=b.pop();if(!c||/^index\./.test(c))c=b.pop();c=c.split(".");1<c.length&&c.pop();c.unshift("ntx");c.push(a.toLowerCase());return c.join("_")+".json"},setPageNtx:function(a,b){var c=this.tempAppendFormCache(b);a.hasOwnProperty("metaTitle")&&$("html\x3ehead").append("\x3ctitle\x3e"+a.metaTitle+"\x3c/title\x3e\x3cmeta itemprop\x3d'name' content\x3d'"+a.metaTitle+"'/\x3e\x3cmeta property\x3d'og:title' content\x3d'"+a.metaTitle+"'/\x3e");a.hasOwnProperty("metaDescription")&&
$("html\x3ehead").append("\x3cmeta itemprop\x3d'description' content\x3d'"+a.metaDescription+"'/\x3e\x3cmeta property\x3d'og:description' content\x3d'"+a.metaDescription+"'/\x3e");[function(a,b){a.text(b)},function(a,b){a.prop("title",b)},function(a,b){var c=a.data("control");a[0].dataset.options=b;!a.is(".thrInitControl")&&c&&thrUI.hasOwnProperty(c)&&thrUI[c].setOptions?thrUI[c].setOptions(a,b.split(",")):a.data("options",b)},function(a,b){thrUI&&thrUI.setUnit(a,b)},function(a,b){a.attr("placeholder",
b)}].forEach(function(b,c){var f="ntx"+(c||"");$("[data-"+f+"").each(function(){var c=$(this).data(f);a.hasOwnProperty(c)&&b($(this),a[c])})},this);b&&(c.children().each(function(){b[$(this).data("formname")].html=$(this).html()}),c.remove())},setPageLanguage:function(a,b){this.isPageLangAvailable(a)&&(thr0.ajax("GET",this.url.ntxFolder+this.pageNtxFilename(a)).done(function(a){thrNtx.setPageNtx(a,b)}),thr0.ajax("GET",this.url.ntxFolder+"ntx_thr0_"+a.toLowerCase()+".json").done(function(a){thrNtx.setHeaderNtx(a)}).fail(function(a){thrUI.message.show(a.responseText)}))},
dumpPageNtx:function(a){var b={};a=this.tempAppendFormCache(a);[{p:"text"},{p:"prop",a:"title"},{p:"data",a:"options"},{p:"data",a:"unit"},{p:"attr",a:"placeholder"}].forEach(function(a,d){$("[data-ntx"+(d||"")+"]").each(function(){b[$(this).data("ntx"+(d||""))]=void 0!==a.a?$(this)[a.p](a.a):$(this)[a.p]()})});a&&a.remove();thr0.triggerDownloadLink(this.pageNtxFilename(this.iso639_1),b,"application/json")},setUnitsNtx:function(a){this.registry.forEach(function(b){if(b.hasOwnProperty("ntx"))for(var c in b.ntx)b.ntx.hasOwnProperty(c)&&
a.hasOwnProperty(c)&&(b.ntx[c]=a[c]);"function"===typeof b.notifyNtxChanged&&b.notifyNtxChanged()})},setUnitsLanguage:function(a){thr0.ajax("GET",this.url.ntxFolder+"ntx_thr_"+a.toLowerCase()+".json").done(function(a){thrNtx.setUnitsNtx(a)})},dumpRegisteredUnitsNtx:function(){var a={};this.registry.forEach(function(b){for(var c in b.ntx)if(b.ntx.hasOwnProperty(c)){var d=b.ntx[c];a[c]?a[c]!==d&&(a["ERROR_"+c]=d):a[c]=d}});thr0.triggerDownloadLink("ntx_thr_"+this.iso639_1+".json",a,"application/json")},
setHeaderNtx:function(a){$("[data-ntx0]").each(function(){var b=$(this).data("ntx0");a.hasOwnProperty(b)&&$(this).text(a[b])})},dumpHeaderNtx:function(a){var b={};a=this.tempAppendFormCache(a);$("[data-ntx0]").each(function(){b[$(this).data("ntx0")]=$(this).text()});a&&a.remove();thr0.triggerDownloadLink("ntx_thr0_"+this.iso639_1+".json",b,"application/json")},setLanguage:function(a,b){var c=thr0.getUserInfo(),d=a||(c?c.iso639_1:null)||(localStorage.thrIso639_1||navigator.language||navigator.userLanguage).substring(0,
2).toLowerCase();0<=this.availableIso639_1.indexOf(d)&&(c&&c.iso639_1!==d&&(c.iso639_1=d,thr0.setUserInfo(c),thr0.ajax("PUT",this.url.userLang,{id:c.id,iso639_1:d})),this.iso639_1!==d&&(!c&&a&&(localStorage.thrIso639_1=d),this.iso639_1=d,this.countries=void 0,this.showAlternatLangPage(d)||this.setPageLanguage(d,b),this.setUnitsLanguage(d)))}};o.thr0={thrSysId:0,funcLicenses:{},notifiers:[],decSep:(1.1).toLocaleString().charAt(1),thousandSep:","===(1.1).toLocaleString().charAt(1)?".":",",listSep:","===
(1.1).toLocaleString().charAt(1)?";":",",regExpFloat:function(a){a=a||this.decSep;return RegExp("^[+-]?[0-9]*("+("."===a?"\\.":a)+"[0-9]+)?([eE][+-]?[0-9]+)?","g")},numPrecision:5,snapTolerance:5,fontFamilies:"Arial, Helvetica, sans-serif;'Arial Black', Gadget, sans-serif;'Comic Sans MS', cursive, sans-serif;'Courier New', Courier, monospace;Georgia, serif;Helvetica, sans-serif;Impact, Charcoal, sans-serif;'Lucida Console', Monaco, monospace;'Lucida Sans Unicode', 'Lucida Grande', sans-serif;'Palatino Linotype', 'Book Antiqua', Palatino, serif;Tahoma, Geneva, sans-serif;'Trebuchet MS', Helvetica, sans-serif;'Times New Roman', Times, serif;Verdana, Geneva, sans-serif".split(";"),
url:{thrUserInfo:"accountsvc/userinfo",signout:"logout",thrDetails:"details",thrPing:"ping",gRegister:"ssoauth/gregister",fbRegister:"ssoauth/fbregister",notifications:"app/accountInfo.html?tab\x3d4"},ntx:{signingIn:"Signing in...",synchronizing:"Synchronizing...",tellAFriendMail:"Hi,\n\nsee what I discovered in the web:\nIt is a cool web application to create flow diagrams. Discover more at http://www.sankeyflowshow.com\n\nCheers",tellAFriendSubject:"New web application discovered",defaultEmailAddr:"a_friend@www.com",
ssoSigninFail:"Login with SSO failed",ssoNoAuth:"Please authorize Sankey Flow Show to access your SSO profile and email.",ssoNoLogin:"Please log into SSO.",download:"Download",downloadHint:"Right klick here and select 'Download linked file as'",downloadHint2:"IMPORTANT: Enter a filename with a valid suffix:",browserUpdateHint:"Please update your browser!",months:"January February March April May June July August September October November December".split(" "),days:"Sunday Monday Tuesday Wednesday Thursday Friday Saturday".split(" ")},
getTabId:function(){this.tabId||(this.tabId=this.generateThrID());return this.tabId},gSigninStatusChanged:function(a){if(a&&(a=gapi.auth2.getAuthInstance().currentUser.get())&&thr0.gSigninNotifier)(a=a.getAuthResponse())&&thr0.gSigninNotifier(a.id_token)},initGSignin:function(a){o.thrInitGapi=function(){o.thrInitGapi=void 0;gapi.load("auth2",function(){gapi.auth2.init({client_id:thrPK.gapi.oauthClientId,scope:thrPK.gapi.scope}).isSignedIn.listen(thr0.gSigninStatusChanged);a&&a()})};$("head").append("\x3cscript type\x3d'text/javascript' async\x3d'true' src\x3d'https://apis.google.com/js/api.js?onload\x3dthrInitGapi'\x3e\x3c/script\x3e")},
ssoSigninFailMessage:function(a,b){return thr0.ntx.ssoSigninFail.replace("SSO",a||"SSO")+(b?": "+b:".")},gSigninClick:function(a){a&&(thr0.gSigninNotifier=a);o.gapi&&gapi.auth2&&(a=gapi.auth2.getAuthInstance(),a.isSignedIn.get()?thr0.gSigninStatusChanged(!0):a.signIn())},gRegisterClick:function(a){gapi.auth2.getAuthInstance().grantOfflineAccess({scope:thrPK.gapi.scope}).then(function(b){!b.error&&(b.code&&a)&&a(b.code)})},initFbSignin:function(){o.fbAsyncInit=function(){FB.init(thrPK.fb);FB.AppEvents.logPageView()};
$("#facebook-jssdk").length||$("script").first().before("\x3cscript id\x3d'facebook-jssdk' type\x3d'text/javascript' async\x3d'true' src\x3d'https://connect.facebook.net/en_US/sdk.js'\x3e\x3c/script\x3e")},fbLogin:function(a,b){FB.login(function(){FB.getLoginStatus(function(c){"connected"===c.status?a(c):b&&b(("not_authorized"===c.status?thr0.ntx.ssoNoAuth:thr0.ntx.ssoNoLogin).replace("SSO","Facebook"))})},{scope:"public_profile,email"})},ssoRegister:function(a,b,c,d,e){var f="Google"===c?thr0.url.gRegister:
"Facebook"===c?thr0.url.fbRegister:void 0;f&&(e&&e(thr0.ntx.synchronizing),thr0.ajax("POST",f+"?code\x3d"+encodeURIComponent(a)+"\x26state\x3d"+encodeURIComponent(b)).done(d).fail(function(a){e&&e(thr0.ssoSigninFailMessage(c,JSON.parse(a.responseText).message))}))},setSignedIn:function(a,b){var c=sessionStorage;c.thrSignedIn=a?"1":0;b&&(c.ssoTok=b);a||c.removeItem("thrUserInfo")},isSignedIn:function(){return sessionStorage.thrSignedIn&&"0"!==sessionStorage.thrSignedIn},sign:function(a){return 0<a?
1:0>a?-1:0},numEqual:function(a,b){return Math.abs(a-b)<=1E-9*Math.max(Math.abs(a),Math.abs(b))},numInRange:function(a,b,c){return a>=b&&a<=c},numInRangeEx:function(a,b,c){return a>b&&a<c},intoRange:function(a,b,c){return Math.min(Math.max(a,b),c)},minAbs:function(a,b){return Math.abs(b)<Math.abs(a)?b:a},round:function(a,b){return Number(Math.round(a+"e"+-1*b)+"e"+b)},round100:function(a){return Math.round(100*a)/100},roundToStep:function(a,b){var c=0===b%1?a%b:a-Math.round(a/b)*b;return a-c+(2*c>
b?b:0)},changeProperty:function(a,b,c){var d=a[b]!==c;a[b]=c;return d},strToPojo:function(a,b){return a?JSON.parse(a):b},idStr:function(a,b){var c=b.toString();return a.slice(0,a.length-c.length)+c},isOpera:function(){return!!o.opera||0<=navigator.userAgent.indexOf(" OPR/")},isFirefox:function(){return"undefined"!==typeof InstallTrigger},isSafari:function(){return 0<Object.prototype.toString.call(o.HTMLElement).indexOf("Constructor")},isChrome:function(){return!!o.chrome&&!this.isOpera()&&!this.isEdge()},
isIE:function(){return!!document.documentMode},isEdge:function(){return!this.isIE()&&!!o.StyleMedia},breakEvent:function(a){a.stopPropagation();a.preventDefault()},generateThrID:function(a){for(var b="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_".charAt((this.thrSysId||0)%64),c=(new Date).getTime(),d=8;0<d;c=Math.floor(c/64),d--)b+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_".charAt(c%64);a="number"===typeof a?Math.floor(a):1E9*Math.random();for(c=5;0<c;a=
Math.floor(a/64),c--)b+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_".charAt(a%64);for(a=18;0<a;a--)b+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_".charAt(Math.floor(64*Math.random()));return b},evalCondition:function(a,b){var c=/^\d*$/,d=/^([^<>=#]*)([<>=#]*)([^<>=#])$/.exec(a),e=c.test(d[1])?parseInt(d[1]):b(d[1]),c=c.test(d[3])?parseInt(d[3]):b(d[3]);switch(d[2]){case "\x3d":return e===c;case "\x3c":return e<c;case "\x3c\x3d":return e<=c;case "\x3e":return e>
c;case "\x3e\x3d":return e>=c;case "#":return e!==c;default:return!1}},ajax:function(a,b,c,d){a={type:a,url:thr0.makeUrl(b)};c&&(a.contentType="application/json",a.data=JSON.stringify(c));d&&(a.dataType="arraybuffer",a.processData=!1);return $.ajax(a)},makeUrl:function(a){void 0===thr0.urlBase&&(thr0.urlBase="",$("script").each(function(){var a=this.src.search(/\/script\/(thr|sfs)/);if(0<=a)return thr0.urlBase=this.src.substring(0,a+1).replace(/^.*\/\/[^\/]*\//,"/"),!1}));return thr0.urlBase+(a||
"")},makeUrlParameters:function(a){var b=[],c;for(c in a)if(a.hasOwnProperty(c)){var d=a[c];void 0!==d&&""!==d&&b.push(encodeURIComponent(c)+"\x3d"+encodeURIComponent(d))}return"?"+b.join("\x26")},getUrlParameters:function(){var a={};o.location.search.substring(1).split("\x26").forEach(function(b){b=b.split("\x3d");a[b[0]]=decodeURIComponent(b[1])});return a},addNotifier:function(a){a&&thr0.pushIfNEx(this.notifiers,a)},removeNotifier:function(a){thr0.removeFromArray(this.notifiers,a)},notify:function(a,
b){this.notifiers.forEach(function(c){if("function"===typeof c[a])try{c[a](b)}catch(d){c="string"===typeof d?d:"object"===typeof d?JSON.stringify(d):"",console.error("ERROR occured in notify handler ("+a+"): "+c)}})},askNotifier:function(a,b,c,d){this.notifiers.some(function(a){return a.ask&&a.ask(b,c,d)})},showMsgNotifier:function(a,b,c){this.notifiers.some(function(a){return a.showMsg&&a.showMsg(b,c)})},setResCache:function(a){this.resCache=a},removeResCache:function(a){this.resCache===a&&(this.resCache=
void 0)},getCachedRes:function(a,b,c,d){this.resCache?this.resCache.getCachedRes(a,b,c,d):thr0.ajax("GET",a).done(c).fail(d)},getUserInfo:function(){return thr0.strToPojo(sessionStorage.thrUserInfo)},notifyUserCreatedFile:function(){var a=this.getUserInfo();a.fileCount++;sessionStorage.thrUserInfo=JSON.stringify(a)},getUserDispname:function(a){return[a.title,a.firstname,a.lastname].filter(function(a){return a}).join(" ")},initUserInfo:function(){this.storageEventsInitialized||($(o).on("storage",function(a){if("thrUserChange"===
a.originalEvent.key&&(a=JSON.parse(a.originalEvent.newValue),a.tabId!==thr0.getTabId()))if(a.user){var b=thr0.getUserInfo();thr0.setSignedIn(!0);b&&(b.details&&b.id===a.user.id&&!a.user.details)&&(a.user.details=b.details,a.user.oldPwd=b.oldPwd);thr0.equalObjects(b,a.user)||(sessionStorage.thrUserInfo=JSON.stringify(a.user),thr0.notify("notifyUserChange",a.user))}else thr0.signOut(0)}),this.storageEventsInitialized=!0);sessionStorage.thrUserInfo?thr0.notify("notifyUserChange",this.getUserInfo()):
sessionStorage.thrSignedIn&&"0"!==sessionStorage.thrSignedIn&&(sessionStorage.ssoTok&&sessionStorage.removeItem("ssoTok"),this.refreshUserInfos())},assertUserDetailsLoaded:function(a,b){a||(a=this.getUserInfo());a&&!a.details&&!this.assertUserDetailsRequested?(this.assertUserDetailsRequested=!0,thr0.ajax("GET",thr0.url.thrUserInfo+"/"+thr0.url.thrDetails).done(function(c){a.details=c.details||{};a.oldPwd=c.oldPwd;thr0.setUserInfo(a);b(a)}).always(function(){delete thr0.assertUserDetailsRequested}).fail(function(){b(a)})):
b(a)},refreshUserInfos:function(a){this.requestedUserInfos||(this.requestedUserInfos=!0,thr0.ajax("GET",this.url.thrUserInfo+(a?"/"+this.url.thrDetails:"")).done(function(a){a.roles=a.roles?a.roles.split(","):[];0>=a.id?thr0.setSignedIn(!1):(a.dispName=thr0.getUserDispname(a),thr0.setUserInfo(a,!0))}).always(function(){thr0.requestedUserInfos=!1}))},setUserInfo:function(a,b){sessionStorage.thrUserInfo=JSON.stringify(a);localStorage.thrUserChange=JSON.stringify({user:a,tabId:this.getTabId()});a&&(this.signoutMode=
void 0);b&&this.notify("notifyUserChange",a)},saveUserInfo:function(a,b,c,d){var e=$.extend(!0,{},a),f=$.extend(!0,{},e);f.dispName=thr0.getUserDispname(f);e.roles=a.roles?a.roles.join(","):void 0;delete e.glogin;delete e.dispName;delete e.country;thr0.ajax("PUT",thr0.url.thrUserInfo+(b?"/"+thr0.url.thrDetails:""),e).done(function(){thr0.setUserInfo(f,!0);c&&c()}).fail(d)},signOut:function(a){if(void 0===this.signoutMode){var b=this.getUserInfo();this.signoutMode=a;thr0.setSignedIn(!1);a&&(localStorage.thrUserChange=
JSON.stringify({tabId:this.getTabId()}));b&&(b.glogin&&o.gapi&&gapi.auth2)&&gapi.auth2.getAuthInstance().signOut();this.notify("notifyUserChange");1===a?o.location.href=this.makeUrl(this.url.signout):2===a&&thr0.ajax("GET",this.url.signout)}},isLicensed:function(a){var b=this.getUserInfo();return(this.funcLicenses[a]||[]).some(function(a){return 0<=this.indexOf(a)},b?b.roles:[])},notifyActivity:function(){localStorage.thrLastActivity=(new Date).getTime()},hasActivity:function(){var a=localStorage.thrLastActivity;
return a&&18E5>(new Date).getTime()-parseInt(a,10)},startPing:function(){this.notifyActivity();this.stopPing();this.pingIntervall=setInterval(function(){thr0.doPing()},12E4)},doPing:function(){this.hasActivity()?thr0.ajax("GET",thr0.url.thrPing).done(function(a){"OK"!==a&&thr0.notify("notifySystemMsg",a)}).fail(function(){thr0.stopPing();thr0.signOut(2)}):thr0.signOut(2)},stopPing:function(){this.pingIntervall&&clearInterval(this.pingIntervall)},triggerDownloadLink:function(a,b,c){var d;d="object"===
typeof b&&(!o.ArrayBuffer||!(b instanceof ArrayBuffer));var e="dataURL"===c||"string"===typeof b&&"data:"===b.substring(0,5);d&&(b=JSON.stringify(b));c||(c=d?"application/json":"text/plain");if((this.isIE()||this.isEdge())&&navigator.msSaveBlob)return navigator.msSaveBlob(e?this.dataURLtoBlob(b):new Blob([b],c),a);$("#thrDownloadButton").remove();d=$("\x3ca id\x3d'thrDownloadButton'\x3e\x3c/a\x3e").appendTo("body")[0];d.href=e?b:this.asDataURL(b,c);"undefined"!==typeof d.download?(d.download=a,d.click()):
"undefined"!==typeof thrUI?($(d).html(thr0.ntx.downloadHint+"\x3cbr/\x3e"+thr0.ntx.downloadHint2+" ."+/[^.]+$/.exec(a)).attr("target","_blank").css({display:"inline-block","background-color":"#a9bf04",color:"#fff","text-decoration":"none","font-weight":"bold",padding:"10px","box-sizing":"border-box"}),thrUI.dialog.show(thr0.ntx.download,0,2,d)):o.alert(thr0.ntx.browserUpdateHint)},sendMail:function(a,b,c){o.location.href="mailto:"+(c||thr0.ntx.defaultEmailAddr)+"\x26subject\x3d"+encodeURIComponent(a||
thr0.ntx.tellAFriendSubject)+"\x26body\x3d"+encodeURIComponent(b||thr0.ntx.tellAFriendMail)},popupWindow:function(a,b,c,d){var e=document.documentElement;a=o.open(a,b,"width\x3d"+c+", height\x3d"+d+", top\x3d"+((o.innerHeight||(e.clientHeight?e.clientHeight:screen.height))-d)/2+(void 0!==o.screenTop?o.screenTop:screen.top)+", left\x3d"+((o.innerWidth||(e.clientWidth?e.clientWidth:screen.width))-c)/2+(void 0!==o.screenLeft?o.screenLeft:screen.left));o.focus&&a.focus()},splitLines:function(a){return a?
a.split(/[\n\v\f\r\x85\u2028\u2029]/).map(function(a){var c=a.trim();return c?/^\t*/.exec(a)+c:0}).filter(function(a){return a}):[]},guessColSep:function(a){var b=["\t",",",";"];return b[thr0.indexOfMax(a.reduce(function(a,d){a[thr0.indexOfMax(b.map(function(a){return d.split(a).length}))]++;return a},[0,0,0]))]},splitArray:function(a,b){var c=thr0.splitLines(a);b.sep||(b.sep=thr0.guessColSep(c));return c.map(function(a){return a.split(this)},b.sep)},parseTree:function(a,b){var c=new ThrTreeNode,
d=[c];thr0.splitArray(a,b).forEach(function(a){if(a.length){var c=d.length,g=d[c-1],h;if(b.format){h=c;for(var i=0;i<h&&a.length&&!a[0];)a.shift(),i++;h=i}else h=c,i=parseInt(a.shift(),10),h=isNaN(i)?h:Math.max(0,i);if(h>=c)for(i=g.sub.length?g.sub.pop():{};c++<=h;)g=g.addNode(i.name),g.val=i.val,d.push(g),i={};else{for(;--c>h;)d.pop();g=d[c]}g.sub.push({name:a.shift(),val:a})}});return c},formatInt:function(a,b){for(var c=a.toString();c.length<b;)c="0"+c;return c},formatLocalFloat:function(a,b){var c,
d,e,f,g,h,i=a.toString().split("e"),j=i[0];if(!0!==b){e=j.indexOf(".");if(void 0===b||!1===b)b=Math.max((0<e?e:j.length)-(0>a?1:0),this.numPrecision);0>e&&(e=j.length);d=0;f=j.length;h=!0;for(g=0;d<b&&b<=f;d++)c=j.charAt(d),/^[-\.0]$/.test(c)?(g++,(h||"0"!==c)&&b++):(g=0,h=!1);h||(b-=g);c=j.charAt(b);"."===c&&(c=j.charAt(b+1));if("5"<=c&&"9">=c){for(d=b-1;0<=d&&!(c=j.charAt(d),"9"!==c&&"."!==c);d--);0>d&&e++;j=0>d?"1":j.slice(0,d)+ ++c}for(j=j.slice(0,b);j.length<e;)j+="0"}i[0]="."===this.decSep?
j:j.replace(".",this.decSep);return i.join("e")},addThousandSeps:function(a){for(var b=a.indexOf(this.decSep),b=(0>b?a.length:b)-3,c=/^-/.test(a)?1:0;b>c;b-=3)a=a.substring(0,b)+this.thousandSep+a.substring(b);return a},formatLocalPrice:function(a,b){return a?this.addThousandSeps(a.toFixed(2).replace(".",this.decSep)+(b?" "+b:"")):""},formatUV:function(a,b,c,d,e,f){if(a)return a=thr0.formatLocalFloat(b?thr0.round(a,d):a,b?!0:c),e&&(a=thr0.addThousandSeps(a)),f&&(a+=" "+f),a},scanDenom:function(a,
b){var c,d=/[a-zA-Z_\x7f-\xff][a-zA-Z0-9_\x7f-\xff]*/g;b&&(d.lastIndex=b);c=d.exec(a);return!c||c.index!==(b||0)?{ix:b||0,result:""}:{ix:d.lastIndex,result:c[0]}},scanQuotedStr:function(a,b){var c,d;c=a.charAt(b);if("'"!==c&&'"'!==c)return{ix:b,result:""};d=RegExp(c+"([^"+c+"]*"+c+"{2})*[^"+c+"]*"+c,"g");b&&(d.lastIndex=b);c=d.exec(a);return{ix:c?d.lastIndex:b||0,result:c?c[0]:""}},scanLastRef:function(a){for(var b=!1,c=a.length-1,d=/[a-zA-Z_.\"\x7f-\xff0-9]/;0<=c&&(b||d.test(a.charAt(c)));)'"'===
a.charAt(c)&&(b=!b),c--;return a.slice(c+1)},scanToChar:function(a,b,c){b=RegExp("["+b+"]","g");c&&(b.lastIndex=c);b=b.exec(a);return{ix:b?b.index:c||0,result:b?a.slice(c,b.index):""}},scanChars:function(a,b,c){var d,e;d=c=c||0;for(e=a.length;d<e&&!(0>b.indexOf(a.charAt(d)));d++);return{ix:d,result:d>c?a.slice(c,d):""}},scanBlanks:function(a,b){return this.scanChars(a," \n\t\f",b)},scanInt:function(a,b){var c=/^[+-]?[0-9]+/g,d=c.exec(b?a.slice(b):a);return{ix:(b||0)+c.lastIndex,result:c.lastIndex?
parseInt(d[0],10):0}},scanFloat:function(a,b,c){c=this.regExpFloat(c);a=c.exec(b?a.slice(b):a);return{ix:(b||0)+c.lastIndex,result:c.lastIndex?this.parseLocalFloat(a[0]):0}},parseLocalFloat:function(a,b){var c=b||this.decSep,c="number"===typeof a?a:parseFloat("."===c?a:a.replace(c,"."));return isNaN(c)?0:c},splitNumberUnit:function(a){var b;if("number"===typeof a)return[a,""];a=a.trim();b=this.scanFloat(a,0);return[b.result,a.slice(b.ix).trim()]},parseLocalUnitFloat:function(a,b){var c=thr0.splitNumberUnit(a);
return"undefined"===typeof thrUnits?c[0]:c[0]/(""!==c[1]&&thrUnits.isConvertible(c[1],b)?thrUnits.getFactor(c[1]):thrUnits.getFactor(b))},firstCharToUpperCase:function(a){return a.charAt(0).toUpperCase()+a.slice(1)},limitedText:function(a,b){return a.length>b?a.slice(0,b)+"...":a},firstLine:function(a){return a?a.match(/^.*$/m)[0]:""},quotedString:function(a,b){b||(b='"');return b+a.replace(/\"/g,'""')+b},unquotedString:function(a,b){b||(b="'"===a.charAt(0)?"'":'"');if(a.charAt(0)===b){var c=this.scanQuotedStr(a).result;
if(c.length)return c.slice(1,c.length-1).replace(RegExp(b+b,"g"),b)}return a},formatDate:function(a){var b=a.getFullYear();return((new Date).getFullYear()===b?"":b+", ")+thr0.ntx.months[a.getMonth()]+" "+a.getDate()},formatDateRaw:function(a){return a.getFullYear()+"/"+this.formatInt(a.getMonth()+1,2)+"/"+this.formatInt(a.getDate(),2)},formatDateTime:function(a){return this.formatDate(a)+", "+a.getHours()+":"+("0"+a.getMinutes()).slice(-2)},weekNo:function(a){a=new Date(Date.UTC(a.getFullYear(),a.getMonth(),
a.getDate()));var b=a.getUTCDay()||7;a.setUTCDate(a.getUTCDate()+4-b);return Math.ceil(((a-new Date(Date.UTC(a.getUTCFullYear(),0,1)))/864E5+1)/7)},isValidFilename:function(a){return!/^\./.test(a)&&/^[^\\/:\*\?"<>\|]+$/.test(a)},isValidEmail:function(a){return/^[_A-Za-z0-9-\+]+(\.[_A-Za-z0-9-]+)*@[A-Za-z0-9-]+(\.[A-Za-z0-9]+)*(\.[A-Za-z]{2,})$/.test(a)},splitWords:function(a){return a&&a.length?a.match(/[^\n\S]*[^\-\n\s]*\-?[^\n\S]*[\n]?/g).filter(function(a){return""!==a}):[]},escapeHtml:function(a){var b=
{"\x26":"\x26amp;","\x3c":"\x26lt;","\x3e":"\x26gt;",'"':"\x26quot;","'":"\x26#39;","/":"\x26#x2F;","`":"\x26#x60;","\x3d":"\x26#x3D;"};return String(a).replace(/[&<>"'`=\/]/g,function(a){return b[a]})},asDataURL:function(a,b){b||(b="text/plain");return o.ArrayBuffer&&a instanceof ArrayBuffer?"data:"+b+";base64,"+this.base64ArrayBuffer(a):"data:"===a.slice(0,5)?a:"data:"+b+";charset\x3dutf-8,"+(/^text\/(csv|tab\-separated\-values)/i.test(b)?"%EF%BB%BF":"")+encodeURIComponent(a)},dataURLtoBlob:function(a){a=
a.split(",");for(var b=atob(a[1]),c=b.length,d=new ArrayBuffer(c),e=new Uint8Array(d),f=0;f<c;f++)e[f]=b.charCodeAt(f);return new Blob([d],{type:a[0].split(":")[1].split(";")[0]})},base64ArrayBuffer:function(a){var b,c="";a=new Uint8Array(a);b=a.byteLength;for(var d=b%3,e=b-d,f=0;f<e;f+=3)b=a[f]<<16|a[f+1]<<8|a[f+2],c+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"[(b&16515072)>>18]+"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"[(b&258048)>>12]+"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"[(b&
4032)>>6]+"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"[b&63];1==d?(b=a[e],c+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"[(b&252)>>2]+"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"[(b&3)<<4]+"\x3d\x3d"):2==d&&(b=a[e]<<8|a[e+1],c+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"[(b&64512)>>10]+"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"[(b&1008)>>4]+"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"[(b&
15)<<2]+"\x3d");return c},inflateObject:function(a){var b=a.indexOf("base64,");a=o.atob(0<=b?a.slice(b+7):a);b=a.slice(0,5);"data:"===b&&(b=a.indexOf("base64,"),a=o.atob(a.slice(b+7)),b=a.slice(0,5));if("thr00"!==b)throw"File signature missing!";return JSON.parse(pako.inflate(a.slice(5),{to:"string"}))},deflateObject:function(a){return"data:;base64,"+o.btoa("thr00"+pako.deflate(JSON.stringify(a),{to:"string",gzip:!0}))},getThrClsName:function(a){return $.isArray(a)&&a.length?a.reduce(function(a,c){return 0===
a?c.thrClsName:a===c.thrClsName?a:""},0)||"":""},getThrClsCaption:function(a){var b=a.length?a[0]:void 0,c=a.filter(function(a){return a.constructor.name===this.c},{c:b?b.constructor.name:""});return b&&"function"===typeof b.getClsCaption&&c.length===a.length?b.getClsCaption(1<c.length):""},clearObject:function(a){for(var b in a)if(a.hasOwnProperty(b)){var c=a[b];$.isArray(c)?a[b]=[]:"object"===typeof c&&void 0!==Object.getPrototypeOf(c)?this.clearObject(c):delete a[b]}},assertProp:function(a,b,c){var d=
a[b];d||(d=c,a[b]=d);return d},copyProps:function(a,b,c,d){c.forEach(function(c){if(d||void 0!==b[c])a[c]=b[c]});return a},addToProps:function(a,b,c){c.forEach(function(c){a[c]+=b[c]})},aggregateToProps:function(a,b,c,d){c.forEach(function(c,f){void 0===a[c]?a[c]=b[c]:a[c]!==b[c]&&(a[c]=d[f])})},isDefined:function(a){return void 0!==a},cleanDiff:function(a,b){if(a){var c=!0,d;for(d in a)if(a.hasOwnProperty(d)&&d!==b){var e=a[d];void 0===e||"object"===typeof e&&$.isEmptyObject(e)?delete a[d]:c=!1}return c?
void 0:a}},indexOfSorted:function(a,b,c,d){function e(c){return b?a[c][b]:a[c]}for(var f=0,g=a.length-1,h=f+g>>1,i=f<g?e(h):c;i!==c;)i>c?g=h-1:f=h+1,h=f+g>>1,i=f<g?e(h):c;return!d?a.length&&0<=h&&e(h)===c?h:-1:a.length&&0<=g?(e(h)<c&&h++,h):0},arraySwap:function(a,b,c){var d=a[b];a[b]=a[c];a[c]=d},indexOfKey:function(a,b,c){for(var d=a.length-1;0<=d;d--)if(a[d][b]===c)return d;return-1},indexOfArrayInArray:function(a,b){for(var c=a.length-1;0<=c;c--)if(this.equalArrays(a[c],b))return c;return-1},
indexOfArrayPropInArray:function(a,b,c){for(var d=a.length-1;0<=d;d--)if(this.equalArrays(a[d][b],c))return d;return-1},arrayObjByKey:function(a,b,c){b=this.indexOfKey(a,b,c);if(0<=b)return a[b]},assertArrayObj:function(a,b,c){var d=this.arrayObjByKey(a,b,c);d||(d={},d[b]=c,a.push(d));return d},pushIfNEx:function(a,b){0>a.indexOf(b)&&a.push(b)},appendToUniqueArray:function(a,b){b.forEach(function(a){0>this.indexOf(a)&&this.push(a)},a)},removeKeyFromArray:function(a,b,c){b=this.indexOfKey(a,b,c);if(0<=
b)return a.splice(b,1)[0]},removeFromArray:function(a,b){var c=a.indexOf(b);if(0<=c)return a.splice(c,1)[0]},findInArray:function(a,b,c){for(var d=0,e=a.length;d<e;d++)if(b.apply(c,[a[d],d,a]))return a[d]},findIndexInArray:function(a,b,c){for(var d=0,e=a.length;d<e;d++)if(b.apply(c,[a[d],d,a]))return d;return-1},countInArray:function(a,b){return a.reduce(function(a,d){return a+(b(d)?1:0)},0)},maxOfArray:function(a,b,c){return a.length?a.reduce(function(a,c){var f=b?c[b]:c;return void 0===a||void 0!==
f&&f>a?f:a},c):c},minOfArray:function(a,b,c){return a.length?a.reduce(function(a,c){var f=b?c[b]:c;return void 0===a||void 0!==f&&f<a?f:a},c):c},indexOfMax:function(a,b){return a.reduce(function(a,d,e){d=b?d[b]:d;return 0>a.ix||a.v<d?{ix:e,v:d}:a},{ix:-1}).ix},filterArrayByType:function(a,b){return a.filter(function(a){return a instanceof b})},getKeyArray:function(a,b,c){return(c?a.filter(function(a){return c(a)}):a).map(function(a){return a[b]})},hasKey:function(a,b){return"string"===typeof b?void 0!==
a[b]:b.some(function(a){return void 0!==this[a]},a)},equalObjects:function(a,b){if(!a||!b)return a===b;for(var c in a)if(a.hasOwnProperty(c)){if(!b.hasOwnProperty(c))return!1;var d=a[c],e=b[c];switch(typeof d){case "object":if(!this.equalObjects(d,e))return!1;break;case "function":if(void 0===e||d.toString()!==e.toString())return!1;break;default:if(d!==e)return!1}}for(var f in b)if(!a.hasOwnProperty(f)&&b.hasOwnProperty(f))return!1;return!0},compareArrays:function(a,b){for(var c=0,d=a.length,e=b.length;c<
d&&c<e;c++)if(a[c]!==b[c])return a[c]>b[c]?1:-1;return d>e?1:d<e?-1:0},equalArrays:function(a,b){return a.length===b.length&&a.every(function(a,b){return a===this[b]},b)},arrayStartsWith:function(a,b){return a.length>=b.length&&b.every(function(a,b){return a===this[b]},a)},deg2rad:Math.PI/180,szLeft:[0,0,1,1,1,0,0,0],szTop:[0,0,0,0,1,1,1,0],szRight:[1,0,0,0,0,0,1,1],szBottom:[1,1,1,0,0,0,0,0],szWidth:[0,0,0,1,0,0,0,1],szHeight:[0,1,0,0,0,1,0,0],distance:function(a,b){var c=a.x-b.x,d=a.y-b.y;return Math.sqrt(c*
c+d*d)},vectorLength:function(a){return Math.sqrt(a.x*a.x+a.y*a.y)},closestPt:function(a,b){return b.reduce(function(b,d){var e=thr0.distance(a,d);return 0>b.d||e<b.d?{pt:d,d:e}:b},{pt:a,d:-1}).pt},distanceToLine:function(a,b,c){return this.distance(a,this.closestLinePt(a,b,c))},closestLinePt:function(a,b,c){var d=b[0];b=b[1];var e=b.x-d.x,f=b.y-d.y;a=((a.x-d.x)*e+(a.y-d.y)*f)/(e*e+f*f);return c||0<=a&&1>=a?{x:d.x+a*e,y:d.y+a*f}:0>a||d.x===b.x&&d.y===b.y?d:b},deltaVec:function(a,b){return{x:this.round100(b.x-
a.x),y:this.round100(b.y-a.y)}},normalizedDeltaVec:function(a){var b=Math.sqrt(a.x*a.x+a.y*a.y)||1;return{x:a.x/b,y:a.y/b}},boundingRect:function(a){function b(a,b){if(b.ellipse&&b.rot){var c=b,d=c.rot*thr0.deg2rad,i=Math.sin(d),j=Math.cos(d),k=c.height/2,l=c.width/2,m=Math.atan(-k*Math.tan(d)/l),d=Math.atan(k*(j/i)/l),m=l*Math.cos(m)*j-k*Math.sin(m)*i,i=k*Math.sin(d)*j+l*Math.cos(d)*i;b={x:c.cPt.x-m,y:c.cPt.y-i,width:2*m,height:2*i}}b.hasOwnProperty("width")?(a.push(thr0.rectPt(b,0)),a.push(thr0.rectPt(b,
2)),b.rot&&(a.push(thr0.rectPt(b,1)),a.push(thr0.rectPt(b,3)))):a.push(b);return a}a=$.isArray(a)?a.reduce(function(a,c){return b(a,c)},[]):b([],a);if(a.length){var c=thr0.minOfArray(a,"x"),d=thr0.minOfArray(a,"y");return{x:c,y:d,width:thr0.maxOfArray(a,"x")-c,height:thr0.maxOfArray(a,"y")-d}}},rotatedRectFromBounds:function(a,b){var c=thr0.normalizeAngle(b),c=180<=c?c-180:c,c=(90>=c?90-c:c-90)*thr0.deg2rad,d=Math.cos(c),e=Math.sin(c),f=d*d-e*e,c=(a.width*d-a.height*e)/f,d=(a.height*d-a.width*e)/
f,e=thr0.rectCenter(a);return{x:e.x-d/2,y:e.y-c/2,width:d,height:c,rot:b,cPt:e}},pointInLineRect:function(a,b){var c=b[0],d=b[1];return thr0.numInRange(a.x,Math.min(c.x,d.x)-0.1,Math.max(c.x,d.x)+0.1)&&thr0.numInRange(a.y,Math.min(c.y,d.y)-0.1,Math.max(c.y,d.y)+0.1)},pointInRect:function(a,b){b.rot&&(a=thr0.rotatePt(a,thr0.rectCenter(b),-b.rot));return a.x>=b.x&&a.y>=b.y&&a.x<=b.x+b.width&&a.y<=b.y+b.height},pointInEllipse:function(a,b){var c=b.width/2,d=b.height/2,e=a.x-(b.x+c),f=a.y-(b.y+d);return 1>=
e*e/(c*c)+f*f/(d*d)},rectInRect:function(a,b){b.rot&&(a={x:a.x,y:a.y,width:a.width,height:a.height,rot:(a.rot||0)-b.rot});return this.pointInRect(thr0.rectPt(a,0),b)&&this.pointInRect(thr0.rectPt(a,2),b)&&(!a.rot||this.pointInRect(thr0.rectPt(a,1),b)&&this.pointInRect(thr0.rectPt(a,3),b))},expandedRect:function(a,b){return{x:a.x-b,y:a.y-b,width:a.width+2*b,height:a.height+2*b}},rotatedRect:function(a){return{x:a.x+(a.width-a.height)/2,y:a.y+(a.height-a.width)/2,width:a.height,height:a.width}},deltaRect:function(a,
b){var c=Math.min(a.x,b.x),d=Math.min(a.y,b.y);return{x:c,y:d,width:Math.max(a.x,b.x)-c,height:Math.max(a.y,b.y)-d}},angle:function(a,b){return this.round100((360+Math.atan2(a.y-b.y,b.x-a.x)/thr0.deg2rad)%360)},lineAngle:function(a){return this.angle(a[0],a[1])},angleQuadrant:function(a){return Math.floor((3600+a)%360/90)},getLine:function(a,b,c){return[a,this.movedPt(a,b,c||100)]},normalizeAngle:function(a){return(3600+a)%360},reverseAngle:function(a){return 180<=a?a-180:a+180},verticalAngle:function(a,
b){return this.normalizeAngle(a+(b?-90:90))},isAngleBetween:function(a,b,c,d){return d?this.normalizeAngle(b-c)>=this.normalizeAngle(a-c):this.normalizeAngle(c-b)>=this.normalizeAngle(a-b)},absAngleDelta:function(a,b){var c=(3600+b-a)%360;return 180<c?360-c:c},significantAngleDelta:function(a,b,c){a=(360+b-a)%180;return a>c&&a<180-c},isVertical:function(a){return 1>Math.abs(a[1].x-a[0].x)},isHorizontal:function(a){return 1>Math.abs(a[1].y-a[0].y)},roundAngle:function(a,b){var c=b?(a+5)%15-5:100;return thr0.normalizeAngle(Math.round(10*
(5>c?a-c:a))/10)},isSmallAngleDelta180:function(a,b){var c=thr0.normalizeAngle(b-a);return 15>c||345<c||165<c&&195>c},setXY:function(a,b,c){a.x=b;a.y=c},setXYFromPt:function(a,b,c){c?(a.x=thr0.round100(b.x),a.y=thr0.round100(b.y)):(a.x=b.x,a.y=b.y)},addXY:function(a,b,c){c?(a.x+=b.x*c,a.y+=b.y*c):(a.x+=b.x,a.y+=b.y)},movedPt:function(a,b,c,d){b*=thr0.deg2rad;c=c?{x:this.round100(a.x+c*Math.cos(b)),y:this.round100(a.y-c*Math.sin(b))}:{x:a.x,y:a.y};return d&&this.distance(a,d)<this.distance(a,c)?d:
c},movedPtDelta:function(a,b,c){void 0===c&&(c=1);return{x:this.round100(a.x+b.x*c),y:this.round100(a.y+b.y*c)}},movedLine:function(a,b,c){return[this.movedPt(a[0],b,c),this.movedPt(a[1],b,c)]},movedLineDelta:function(a,b,c){return[this.movedPtDelta(a[0],b,c),this.movedPtDelta(a[1],b,c)]},movedRect:function(a,b,c){return{x:a.x+b,y:a.y+c,width:a.width,height:a.height}},multipliedRect:function(a,b,c){return{x:a.x*b,y:a.y*c,width:a.width*b,height:a.height*c}},zoomedRect:function(a,b){return this.multipliedRect(a,
b,b)},rectCenter:function(a){return{x:this.round100(a.x+a.width/2),y:this.round100(a.y+a.height/2)}},addRectBounds:function(a,b){var c=b.x,d=b.y,e=a.x,f=a.y,g=a.width,h=a.height,c=e>c?c-e:e+g<c?c-(e+g):0,d=f>d?d-f:f+h<d?d-(f+h):0,d=Math.abs(c)>Math.abs(d)?c:d;return{x:e-d,y:f-d,width:g+2*d,height:h+2*d}},centeredPt:function(a){var b=a?a.length:0;if(b)return a=a.reduce(function(a,b){return{x:a.x+b.x,y:a.y+b.y}},{x:0,y:0}),{x:this.round100(a.x/b),y:this.round100(a.y/b)}},sizedPt:function(a,b,c,d){var e=
c.width||1,f=c.height||1,g=c.x+this.szLeft[d]*e;c=c.y+this.szTop[d]*f;return{x:this.round100(g+(a.x-g)*(1+b.x/e)),y:this.round100(c+(a.y-c)*(1+b.y/f))}},sizedRect:function(a,b,c,d,e){var f=c.width||1,g=c.height||1,h=c.x+this.szLeft[d]*f,i=c.y+this.szTop[d]*g,j=a.rot!==c.rot?thr0.boundingRect(a):a;b={x:this.round100(h+(j.x-h)*(1+b.x/f)),y:this.round100(i+(j.y-i)*(1+b.y/g)),width:this.round100(j.width+(this.szHeight[d]?0:b.x*j.width/f)),height:this.round100(j.height+(this.szWidth[d]?0:b.y*j.height/
g))};b.width<e&&(this.szLeft[d]&&(b.x+=b.width-e),b.width=e);b.height<e&&(this.szTop[d]&&(b.y+=b.height-e),b.height=e);a.rot?(c=a.rot-(c.rot||0),d=thr0.normalizeAngle(c)%180,d=(90>=d?d:180-d)*thr0.deg2rad,f=Math.cos(d),g=Math.sin(d),h=(b.width-j.width)/(f+g),i=(b.height-j.height)/(f+g),d=Math.max(a.width+f*h+g*i,e),e=Math.max(a.height+f*i+g*h,e),j=thr0.rectCenter(j),b=thr0.rectCenter(b),j=thr0.movedPt(thr0.movedPt(thr0.rectCenter(a),c-a.rot,b.x-j.x),270+c-a.rot,b.y-j.y),a={x:j.x-d/2,y:j.y-e/2,width:d,
height:e,rot:a.rot,cPt:j}):a=b;return a},triangle:function(a,b){var c=a.dir||0,d=thr0.movedPt(a,c,0.4330127*b);return[d,thr0.movedPt(d,c+210,b),thr0.movedPt(d,c+150,b)]},lineIntersection:function(a,b){var c,d=a[0],e=a[1];c=b[0];var f=b[1],g=(f.y-c.y)*(e.x-d.x)-(f.x-c.x)*(e.y-d.y);if(g)return c=((f.x-c.x)*(d.y-c.y)-(f.y-c.y)*(d.x-c.x))/g,{x:thr0.round100(d.x+c*(e.x-d.x)),y:thr0.round100(d.y+c*(e.y-d.y))}},normalizeVec:function(a){var b=Math.sqrt(a.x*a.x+a.y*a.y);return b?{x:a.x/b,y:a.y/b}:a},lineCircleIntersection:function(a,
b,c){var d=this.normalizeVec({x:a[1].x-a[0].x,y:a[1].y-a[0].y});if(d.x||d.y){a=this.closestLinePt(b,a,!0);b=this.distance(b,a);if(b<c)return b=Math.sqrt(c*c-b*b),c=b*d.x,d=b*d.y,[{x:a.x-c,y:a.y-d},{x:a.x+c,y:a.y+d}];if(b===c)return[a]}},lineEllipseIntersection:function(a,b,c,d){var e;if(!c||!d)return(a=this.lineIntersection(a,[b,c?{x:b.x,y:b.y+100}:{x:b.x+100,y:b.y}]))&&Math.abs(c?a.x-b.x:a.y-b.y)<=(c||d)?[a]:void 0;e=c/d;return(c=this.lineCircleIntersection([{x:a[0].x,y:b.y+(a[0].y-b.y)*e},{x:a[1].x,
y:b.y+(a[1].y-b.y)*e}],b,c))?c.map(function(a){return{x:a.x,y:b.y+(a.y-b.y)/e}}):void 0},circleIntersection:function(a,b,c,d,e){var f,g;g={x:c.x-a.x,y:c.y-a.y};f=Math.sqrt(g.y*g.y+g.x*g.x);if(this.numEqual(f,b+d))return[this.movedPtDelta(a,g,b+d?b/(b+d):1)];if(this.numEqual(f,Math.abs(b-d)))return!f?[{x:a.x+b,y:a.y}]:[this.movedPtDelta(a,g,b/f)];if(f>b+d)return e?[this.movedPtDelta(a,g,(f+b-d)/(2*f))]:void 0;if(f<Math.abs(b-d))return e?[this.movedPtDelta(b>=d?a:c,g,(f+d+b)/(2*f)*(b>=d?1:-1))]:void 0;
c=(b*b-d*d+f*f)/(2*f);a=this.movedPtDelta(a,g,c/f);f=Math.sqrt(b*b-c*c)/f;b=-g.y*f;g=g.x*f;return[{x:this.round100(a.x+b),y:this.round100(a.y+g)},{x:this.round100(a.x-b),y:this.round100(a.y-g)}]},rotatePt:function(a,b,c){return this.movedPt(b,this.angle(b,a)-c,this.distance(b,a))},rectPt:function(a,b){var c={x:a.x+(b+1&2?a.width:0),y:a.y+(b&2?a.height:0)};return a.rot?this.rotatePt(c,a.cPt||this.rectCenter(a),a.rot):c},rectPoints:function(a){return[0,1,2,3].map(function(a){return thr0.rectPt(this,
a)},a)},boundsPt:function(a,b){var c=((b>>1)+2)%4,d=this.rectPt(a,c);return b&1?this.centeredPt([d,this.rectPt(a,c+1)]):d},countFrameLines:function(a){return $.isArray(a)?a.length:"object"===typeof a?4:0},frameLine:function(a,b){var c=this.countFrameLines(a);return $.isArray(a)?[a[b%c],a[(b+1)%c]]:c?[this.rectPt(a,(b+1)%c),this.rectPt(a,(b+2)%c)]:void 0},cutFrameLine:function(a,b,c){var d=thr0.getLine(a,b,1E5);return"object"===typeof c&&c.ellipse?(b=(b=thr0.lineEllipseIntersection(d,thr0.rectCenter(c),
c.width/2,c.height/2))&&b.length?thr0.pointInLineRect(b[0],d)?b[0]:2===b.length&&thr0.pointInLineRect(b[1],d)?b[1]:a:a,{pt:b,d:thr0.distance(b,a)}):this.getFrameLines(c).reduce(function(b,c){var g=thr0.lineIntersection(d,c);if(g&&thr0.pointInLineRect(g,c)&&thr0.pointInLineRect(g,d)){var h=thr0.distance(a,g);if(0>b.d||h<b.d)return{d:h,pt:g,l:c}}return b},{d:-1,pt:a})},associatedFrameLine:function(a,b,c){var d,e,f;if(void 0!==a.dir)return{ix:-1,dir:a.dir};if($.isArray(c))d=c.reduce(function(a,c){return Math.max(a,
thr0.distance(c,b))},0),e=thr0.distance(b,a);else{if(c.ellipse)return{ix:-1,dir:thr0.ellipseOrtho(c,a)};e=Math.abs(a.x-b.x);d=Math.abs(a.y-b.y);e>d?d=Math.abs(c.x-b.x):(e=d,d=Math.abs(c.y-b.y))}if(!d)return{ix:-1,dir:0};f=thr0.getFrameLines(e>d?thr0.expandedFrame(c,b,e-d):c);a=thr0.indexOfClosestLine(a,f);c=e>d?thr0.frameLine(c,a):f[a];return{ix:a,l:c,dir:thr0.normalizeAngle(thr0.lineAngle(c)+90)}},indexOfClosestLine:function(a,b){return b.reduce(function(b,d,e){d=thr0.distanceToLine(a,d);return 0>
b.d||d<b.d?{d:d,ix:e}:b},{d:-1,ix:0}).ix},getFrameLines:function(a){for(var b=[],c=0,d=this.countFrameLines(a);c<d;c++)b.push(this.frameLine(a,c));return b},closestFrameLine:function(a,b){if("object"===typeof a&&a.ellipse)return this.ellipseOrtho(a,this.closestEllipsePt(a,b));var c=this.getFrameLines(a),d=this.indexOfClosestLine(b,c);return 0<=d?c[d]:void 0},mirrorFrame:function(a,b,c){if($.isArray(a))return a.map(function(a){var e=$.extend({},a);b?e.y=2*c.y-a.y:e.x=2*c.x-a.x;void 0!==a.dir&&(a=thr0.movedPt(a,
a.dir,100),b?a.y=2*c.y-a.y:a.x=2*c.x-a.x,e.dir=thr0.angle(e,a));return e});a=$.extend({},a);b?a.y=2*c.y-a.y-a.height:a.x=2*c.x-a.x-a.width;return a},expandedFrame:function(a,b,c){if(!c)return a;if($.isArray(a)){for(var d=[],e=thr0.getFrameLines(a),f=e.reduce(function(a,c){var d=thr0.centeredPt(c),e=thr0.distance(b,d);e>a.d&&(a={d:e,l:c,cPt:d});return a},{d:-1}),g=180>thr0.normalizeAngle(thr0.angle(b,f.cPt)-thr0.lineAngle(f.l))?90:-90,e=e.map(function(a){return thr0.movedLine(a,thr0.lineAngle(a)+g,
c)}),f=e.length-1;0<=f;f--){var h=thr0.lineIntersection(e[f],e[(0<f?f:e.length)-1]);h&&(h.dir=a[f].dir,d.unshift(h))}return d}return $.extend(!0,{},a,thr0.expandedRect(a,c))},ellipseOrtho:function(a,b){var c=a.width,d=a.height,e=a.rot||0;if(d&&c){var f=a.cPt||thr0.rectCenter(a),g=e?thr0.rotatePt(b,f,-e):b,h=g.x-f.x,f=g.y-f.y,g={x:h,y:f*c/d},g=thr0.movedPt(g,thr0.lineAngle([{x:0,y:0},g])+90,100);return thr0.normalizeAngle(thr0.lineAngle([{x:h,y:f},{x:g.x,y:g.y*d/c}])-90-e)}return thr0.normalizeAngle((d?
0:90)-e)},closestEllipsePt:function(a,b){var c,d=a.rot,e=a.width/2,f=a.cPt||thr0.rectCenter(a);c=d?thr0.rotatePt(b,f,-d):b;var g=c.y-f.y;if(g){var g=Math.abs((c.x-f.x)/g),h=a.height/2,e=e*e,h=h*h,e=Math.sqrt(e*h/(g*g*h+e));c={x:f.x+(c.x>f.x?e:-e)*g,y:f.y+(c.y>f.y?e:-e)}}else c={x:f.x+(c.x<=f.x?-e:e),y:f.y};return d?thr0.rotatePt(c,f,d):c},snapToFrame:function(a,b,c){var d=$.isArray(b)||!b.ellipse?this.closestFrameLine(b,a):0,e=d?this.closestLinePt(a,d):this.closestEllipsePt(b,a);return!c||this.distance(a,
e)<=c?{pt:e,snapObj:d||b}:{pt:a}},snapInLineToFrame:function(a,b,c){if(c.ellipse){var d=thr0.rectCenter(c),e=c.rot?thr0.rotatePt(a,d,-c.rot):a,f=[e,c.rot?thr0.rotatePt(b,d,-c.rot):b];if((b=thr0.lineEllipseIntersection(f,d,c.width/2,c.height/2))&&b.length){a=b[0];if(1<b.length){var g=thr0.pointInLineRect(b[0],f);if((f=thr0.pointInLineRect(b[1],f))&&!g||g===f&&thr0.distance(e,b[1])<thr0.distance(e,b[0]))a=b[1]}return c.rot?thr0.rotatePt(a,d,c.rot):a}return a}d=thr0.angle(b,a);e=thr0.cutFrameLine(b,
d,c);return 0>e.d?thr0.cutFrameLine(b,thr0.reverseAngle(d),c).pt:e.pt}};thrNtx.register(thr0);o.ThrUnitValAggregator=function(a){this.defaultUnit=a;this.uv={}};ThrUnitValAggregator.prototype={add:function(a,b,c){var d=thrUnits.getBaseUnit(b);a=c?a:a*thrUnits.getFactor(b);(c=this.uv[d])?(c.c++,c.v+=a,c.uc.hasOwnProperty(b)?c.uc[b]++:c.uc[b]=1):(c={c:1,v:a,uc:{}},c.uc[b]=1,this.uv[d]=c)},majorUnit:function(){function a(a,b){var c,d=0,e=b;for(c in a)a.hasOwnProperty(c)&&a[c]>d&&(e=c,d=a[c]);return e}
var b,c,d=0,e=this.defaultUnit,f=thrUnits.getBaseUnit(e);if(this.uv.hasOwnProperty(f))return a(this.uv[f].uc,e);for(b in this.uv)this.uv.hasOwnProperty(b)&&this.uv[b].c>d&&(e=b,c=this.uv[b].uc,d=this.uv[b].c);return c?a(c,e):e},getSum:function(a){var b;a||(a=this.majorUnit());b=thrUnits.getBaseUnit(a);return this.uv.hasOwnProperty(b)?this.uv[b].v*thrUnits.getFactor(a):0}};o.thrUnits={data:[{kg:1,cg:1E5,ct:5E3,centner:0.02,dag:100,dg:1E4,dwt:643.01493137,g:1E3,gr:15432.358353,hg:10,lb:2.20462262,"long ton":9.8421E-4,
"metric carat":5E3,mg:1E6,Mg:0.001,"\u00b5g":1E9,ng:1E12,oz:35.27396195,"short ton":0.0011023,t:0.001,u:6.0221E26,Zentner:0.02},{MJ:1,Btu:947.81712031,cal:238845.89663,erg:1E13,eV:6.24150636E24,GJ:0.001,GWh:2.7777778E-7,J:1E6,kcal:238.84589663,kJ:1E3,kpm:101971.6213,kWh:0.27777778,MWh:2.7777778E-4,Nm:1E6,PJ:1E-9,PSh:377670,Quad:9.4781712031E-13,TJ:1E-6,TOE:2.3885E-5,TWh:2.7777778E-10,Wh:277.77778,Ws:1E6},{m:1,A:1E10,AE:6.6845E-12,cm:100,ft:3.2808399,"in":39.37007874,km:0.001,lj:1.057E-16,mi:6.2139E-4,
mm:1E3,"\u00b5m":1E6,nm:1E9,pica:236.22047244,pc:3.2408E-17,sm:5.3996E-4,XE:9979E9,yd:1.0936133},{m3:1,"bbl\x3cuk\x3e":6.1102569,"bbl\x3cus\x3e":8.38641436,"bbl\x3coil\x3e":6.28981077,bushel:27.49616,ccm:1E6,cl:1E5,ft3:35.315,"gal\x3cUK\x3e":219.969,"gal\x3cUS\x3e":264.172,in3:6102.4,l:1E3,ml:1E6,yd3:1.308},{h:1,year:1.1408E-4,Jahr:1.1408E-4,years:1.1408E-4,Jahre:1.1408E-4,min:60,month:0.0013889,Monat:0.0013889,months:0.0013889,Monate:0.0013889,ms:36E5,ns:36E11,s:3600,sec:3600,day:0.041667,Tag:0.041667,
days:0.041667,Tage:0.041667},{kB:1,bit:8192,"byte":1024,GB:9.53674316E-7,MB:9.7656E-4,PB:9.09494702E-13,TB:9.31322575E-10},{Nm3:1},{Bq:1,Ci:2.7027027E-11,kBq:0.001,kCi:2.7027027E-14,mBq:1E3,mCi:2.7027027E-8},{qm:1,ha:1E-4,m2:1,qkm:1E6},{pieces:1,"St\u00fcck":1,unit:1,pcs:1},{cases:1,"F\u00e4lle":1}],findUnit:function(a){if(a&&""!==a){var b=thr0.findIndexInArray(this.data,function(a){return void 0!==a[this]},a);if(0<=b)return[b,a];a=a.toLowerCase();for(b=0;b<this.data.length;b++){var c=this.data[b],
d;for(d in c)if(c.hasOwnProperty(d)&&d.toLowerCase()===a)return[b,d]}}},getCaseSensitiveUnit:function(a){var b=this.findUnit(a);return b?b[1]:a},getBaseUnit:function(a){var b=this.findUnit(a);if(b){a=this.data[b[0]];for(var c in a)if(a.hasOwnProperty(c)&&1===a[c])return c;return"[]"}return a},getFactor:function(a){return(a=this.findUnit(a))?this.data[a[0]][a[1]]:1},getConversion:function(a,b){var c,d,e;if(!a||!b||""===a||""===b||a.toLowerCase()===b.toLowerCase())return 1;if(c=this.findUnit(a)){d=
this.data[c[0]];if(0===d[c[1]])return 0;if(void 0!==d[b])return d[b]/d[c[1]];b=b.toLowerCase();for(e in d)if(d.hasOwnProperty(e)&&e.toLowerCase()===b)return d[e]/d[c[1]]}return 0},isConvertible:function(a,b){var c,d,e;if(!a||!b||""===a||""===b||a.toLowerCase()===b.toLowerCase())return!0;if(c=this.findUnit(a)){d=this.data[c[0]];if(0===d[c[1]])return!1;if(void 0!==d[b])return!0;b=b.toLowerCase();for(e in d)if(d.hasOwnProperty(e)&&e.toLowerCase()===b)return!0}return!1}};o._h={attrs:function(a){if("string"===
typeof a)return" class\x3d'"+a+"'";if(a){var b=[],c;for(c in a)a.hasOwnProperty(c)&&void 0!==a[c]&&b.push(" "+c+"\x3d'"+a[c]+"'");return b.join("")}return""},style:function(a){var b=[],c;for(c in a)a.hasOwnProperty(c)&&void 0!==a[c]&&b.push(c+":"+a[c]+";");return b.join("")},tag:function(a,b,c){return"\x3c"+a+_h.attrs(c)+"\x3e"+(void 0===b?"":b)+"\x3c/"+a+"\x3e"},tags:function(a,b,c){return _h.tag(a[0],1<a.length?_h.tags(a.slice(1),b,c?c.slice(1):void 0):b,c?c[0]:void 0)},div:function(a,b){return"\x3cdiv"+
_h.attrs(b)+"\x3e"+(void 0===a?"":a)+"\x3c/div\x3e"},span:function(a,b){return"\x3cspan"+_h.attrs(b)+"\x3e"+(void 0===a?"":a)+"\x3c/span\x3e"},inp:function(a){return"\x3cinput"+(!a||"object"!==typeof a||!a.type?' type\x3d"text"':"")+_h.attrs(a)+"/\x3e"},img:function(a){return"\x3cimg"+_h.attrs(a)+"/\x3e"},basicIAttrs:function(a,b){var c={},d=b?b["class"]:void 0,d=d?d.split(" "):[];a&&(d.unshift("thrInitControl"),c["data-control"]=a);d.length&&(c["class"]=d.join(" "));if(b)for(var e in b)b.hasOwnProperty(e)&&
"class"!==e&&(d=b[e],d instanceof Date&&(d=d.getTime()),/^(prop|options|values|rootname)$/.test(e)||"value"===e&&(void 0===a||!/^(textInput|numberInput)$/.test(a))?c["data-"+e]=d:c[e]=d);return c},btnAttrs:function(a,b){var c="string"===typeof a?{"class":a}:a||{};c["class"]=b+(c["class"]?" "+c["class"]:"");c.tabindex="0";return c},btn:function(a,b,c){b=this.btnAttrs(b,"thrButton");return _h.tag(c||(b.href?"a":"span"),a,b)},iconBtn:function(a,b){return _h.div(_h.icon(a),this.btnAttrs(b,"thrIconButton"))},
delBtn:function(a){a=this.btnAttrs(a,"thrDelButton");a.title||(a.title=thrUI.ntx.remove);return _h.span("",a)},upgradeBtn:function(a){var b={onclick:'thrUI.openTab("'+thrUI.url.upgradeInfos+'", true);'};a&&(b["class"]="thrAccent");return this.btn(thrUI.ntx.upgradeInfos,b)},icon:function(a,b){return _h.span("",{"class":"thrIcon",style:a?"background-position:"+-24*a+"px 0;"+(b||""):b})},flag:function(a){a=a.toLowerCase();return _h.span("",{"class":"thrFlag24x18",style:"background-position-y: "+-18*
thrNtx.indexOfIso639_1(a)+"px;",title:thrNtx.iso639_1ToCountry(a)})},tableRow:function(a,b,c){var d=b?"th":"td";return _h.tag("tr",a.map(function(a){return $.isArray(a)?_h.tag(d,a[0]||"",a[1]):_h.tag(d,a||"")}).join(""),c)},table:function(a,b,c){return _h.tag("table",(a?_h.tag("thead",_h.tableRow(a,!0)):"")+(b?_h.tag("tbody",b.map(function(a){return _h.tableRow(a)}).join("")):""),c)}};o.thrUI={lastCtrlId:0,shortCuts:[],temp:{},ntx:{ok:"OK",close:"Close",cancel:"Cancel",del:"Delete",signin:"Login",
signout:"Logout",remove:"Remove",hint:"Hint",copyToClipboard:"Copy to clipboard",copyHint:"Please use the right mouse menu or your browsers keyboard short cut to copy the text below to the clipboard.",pasteFromClipboard:"Paste from clipboard",pasteHint:"Please use the right mouse menu or your browsers keyboard short cut to paste text from the clipboard into the field below.",separator:"Separator",separatorOpts:"Tab,Comma,Semicolon",treeFormat:"Tree format",treeFormatOpts:"Level column,Indented",account:"Account",
notifications:"Notifications",devTools:"Developer tools",adminTools:"Admin tools",licRestriction:"License restriction",licHint:"Upgrade your license for the use of this function:;Change the size of your diagrams;Hide subtitle 'created with';Create an unrestricted number of diagrams;Use cloud storage;Access more than 10 revisions of your diagram;Use wizards;Add logic to your diagrams".split(";"),licLimit1:"You did already create ",licLimit2:". The limit of your current license is reached.",licLimitInfo1:"Info: You did already create ",
licLimitInfo2:". Current limit: Create max. ",dontShowAgain:"Don't show me this message again",openTabHint1:"The selected information will be displayed in a new browser tab.",openTabHint2:"To return to the app, please close the new tab or manually activate the current tab.",upgradeInfos:"Upgrade infos",addNewFolder:"Add a new folder",addFolder:"Add folder",folderName:"Folder name",newFolder:"New Folder",invalidFolderName:"Invalid folder name",folderNameHint:"Please enter a valid folder name!",invalidChars:"Following special characters are not allowed",
orderboxHint:"Drag a row up or down to change the order. Or use the arrow keys: left, right (select); up, down (move)",multipleValues:"(multiple values)",pageLangNotAvailable:"This page is not available in English"},notifyNtxChanged:function(){var a=thr0.getUserInfo();$(".thrUserInfo").each(function(){thrUI.userinfo.fill($(this),a)});$(".thrLanguageSelector").each(function(){thrUI.languageSelector.fill($(this),thrNtx.iso639_1)})},devTools:[{caption:"Dump native texts",onclick:"thrNtx.dumpPageNtx(window.thrUI ? thrUI.form.cache : undefined);"},
{caption:"Dump header ntx",onclick:"thrNtx.dumpHeaderNtx(window.thrUI ? thrUI.form.cache : undefined);"}],url:{admin:"admin",upgradeInfos:"pages/licenses.html"},mimeTypes:{gfolder:"application/vnd.google-apps.folder",gfiles:"application/vnd.google.drive.ext-type.sankey"},initFormCache:function(a){a.children().each(function(){thrUI.form.addToCache($(this).data("formname"),$(this).data("ctx"),$(this).html())});a.remove()},initControls:function(a){(a?a.find(".thrInitControl"):$(".thrInitControl")).each(function(){var a=
$(this),c=a.data("control");c&&thrUI[c].create(a);a.removeClass("thrInitControl")})},notifyUserChange:function(a){$(".thrUserInfo").each(function(){thrUI.userinfo.fill($(this),a)});thrNtx.setLanguage(a?a.iso639_1:void 0,this.form.cache)},ihtml:function(a,b,c){return this[a]&&this[a].ihtml?this[a].ihtml(b):_h.tag(/^(optionButton)$/.test(a)?"span":"div",c||"",_h.basicIAttrs(a,b))},createControl:function(a,b,c,d,e,f,g){a.data("control",b).addClass(c);e&&a.empty().append(e);f&&a.attr("tabindex",0);d&&
d.forEach(function(c){a.on(c,"click"===c?function(a){thr0.notifyActivity();thrUI[b][c](a)}:function(a){thrUI[b][c](a)})});g&&this.setActionMaker(g,function(a){return thrUI[b].makeAction(a)});return a},getRelativeWidth:function(a){return 100*a.width()/a.offsetParent().width()},getFocusables:function(a){return a.find("input, textarea, *[tabindex \x3d '0']")},setFocus:function(a){this.getFocusables(a).first().focus().select()},clearSelection:function(){o.getSelection?o.getSelection().removeAllRanges():
document.selection&&document.selection.empty()},setElementDisplay:function(a,b){b?a.removeClass("thrNoDisplay"):a.addClass("thrNoDisplay")},hideDropdowns:function(){$(".thrDropdown").each(function(){$(this).parent().addClass("thrCollapsed")});$(".thrDropdownButton").removeClass("thrHighlight")},doChange:function(a,b,c){a.data("value")!==c&&this.triggerChange(a,b,c)&&this[b].fill(a,c)},triggerChange:function(a,b,c){b=$.Event("change",{prop:a.data("prop"),func:a.data("func"),value:void 0!==c?c:this[b].getValue(a)});
a.trigger(b);return!b.err},tableGroupRowClick:function(a){var b=a.toggleClass("thrCollapsed").hasClass("thrCollapsed");for(a=a.next();a.length&&!a.hasClass("thrTableGroupRow");a=a.next())this.setElementDisplay(a,!b)},adjustIFrameWidth:function(a,b,c,d){var e=b.height*c/d;b=e>b.width?100:thr0.round100(100*e/b.width);a.width(b+"%").css("padding-top",thr0.round100(b*d/c)+"%")},copyData:function(a,b,c){(a=a.data(c))&&b.data(c,a)},numberConstraints:function(a){function b(a,b){return"number"===typeof a?
a:a?/\./.test(a)?parseFloat(a):parseInt(a,10):b}var c={min:b(a.data("min"),0),max:b(a.data("max"),100),step:b(a.data("step"),1)},d=c.step%1;c.delta=c.max-c.min;c.range=b(a.data("range"),c.delta);if(d){for(a=-1;0>d;)d*=10,a++;for(;0<d;)d=10*(d%1),a++;c.decimals=a}return c},setUnit:function(a,b){var c=a.attr("data-unit",b).find(".thrUnit");b?c.length?c.text(" "+b):a.find("input[type\x3d'text']").addBack("input[type\x3d'text']").after(_h.span(b,"thrUnit")):c.remove()},listdata:function(a,b){var c=a.data(b);
return c?"string"===typeof c?"["===c.charAt(0)?JSON.parse(c):c.split(","):c:[]},indexOfOptionDiv:function(a,b){var c=b.toLowerCase(),d=c.length,e=-1;(a.is(".thrListbox")?a.children():a.find(".thrDropdown\x3e*")).each(function(a){if($(this).text().slice(0,d).toLowerCase()===c)return e=a,!1});return e},changeSelection:function(a,b,c,d){a=a.find(".thrSelected");b||(b=c?a.prev():a.next());b.length&&(a.removeClass("thrSelected"),b.addClass("thrSelected"),d||b[0].scrollIntoView())},getSelected:function(a,
b,c){a=a.find(".thrSelected");return a.length?b?a[b]():a:c},createSub:function(a,b,c,d){var e=a.data("value"+c);b=b.find(".thrIx"+c);b.data("prop",a.data("prop"+(c||"")));thrUI[d].create(b);void 0!==e&&thrUI[d].fill(b,"true"===e?!0:"false"===e?!1:e);return b},elementsHeight:function(a){return a.toArray().reduce(function(a,c){return a+c.getBoundingClientRect().height},0)},centerElement:function(a){var b=a.parent()[0].getBoundingClientRect();a.css({"margin-left":Math.max((b.width-a.outerWidth())/2,
0)+"px","margin-top":Math.max((b.height-a.outerHeight())/2,0)+"px"})},setElementSubHeight:function(a,b,c){var d=b-this.elementsHeight(a.find("\x3eh1"));a.find("\x3ediv").each(function(){$(this).css(c||"max-height",d-parseInt($(this).css("padding-top"),10)-parseInt($(this).css("padding-bottom"),10))})},showHint:function(a,b){var c=a[0].getBoundingClientRect(),d=$(_h.div(b,"thrPopupHint")).appendTo($("body")).css({left:c.left+c.width/2-100,top:c.top-20});setTimeout(function(){d.remove()},5E3)},openTab:function(a,
b){this.dialog.showHint(_h.div(_h.tag("strong",this.ntx.openTabHint1)+"\x3cbr/\x3e"+_h.tag("strong",this.ntx.openTabHint2),{style:"margin: 5px;"}),"openTab",function(){o.open(thr0.makeUrl(a),"_blank")},!b)},registerShortCut:function(a,b,c,d,e){this.shortCuts.push({keyCode:a,shiftKey:b,ctrlKey:c,altKey:d,fn:e})},unregisterShortCuts:function(){this.shortCuts=[]},getCtrlId:function(a){return a.data("ctrl-id")},getNewCtrlId:function(){return++this.lastCtrlId},getTempDataPath:function(a,b){return this.getCtrlId(a)+
"."+b},setTempData:function(a,b,c){var d=this.getCtrlId(a),e="object"===typeof b;if(void 0!==c||e)d||(d="c"+this.getNewCtrlId(),thrUI.temp[d]={},a.data("ctrl-id",d)),e?$.extend(thrUI.temp[d],b):thrUI.temp[d][b]=c},getTempData:function(a,b){var c=this.getCtrlId(a);if(void 0!==c)return c=thrUI.temp[c],b?c[b]:c},callTempDataFunc:function(a,b,c,d){a=this.getTempData(a,b);return"function"===typeof a?a.apply(null,c):d},deleteTempData:function(a){a=this.getCtrlId(a);void 0!==a&&delete thrUI.temp[a]},init:function(){function a(a){thrUI.endAction(a,
!1)}var b=$(document).click(function(a){0===$(a.target).closest(".thrDropdown").length&&0===$(a.target).closest(".sfsReadOnlyHint").length&&thrUI.hideDropdowns()}).keydown(function(a){thrUI.keydown(a)}).keyup(function(a){if(thrUI.action){var b=a.keyCode||a.which;if(16===b||17===b)thrUI.action.move(a),thr0.breakEvent(a)}});if(o.PointerEvent)b.on("pointerup",a);else if(b.on("mouseup",a),o.TouchEvent&&"ontouchend"in document)b.on("touchend",a);thr0.getUserInfo()||thrNtx.setLanguage(void 0,this.form.cache);
this.initFormCache($(".thrFormCache"));this.initControls()},keydown:function(a){var b=a.keyCode||a.which,c=thrUI.action;if(c){if(27===b)thrUI.endAction(a,!0);else if(16===b||17===b)c.move(a),a.preventDefault();a.stopPropagation()}else thrUI.standby||(c=$(a.target),13===b&&c.is(".thrButton, .thrDelButton, .thrIconButton")?(thr0.breakEvent(a),c.click()):13===b&&!a.shiftKey&&c.is("input")?(c.blur().focus(),thr0.breakEvent(a)):thrUI.shortCuts.some(function(c){if(c=c.keyCode===b&&c.shiftKey===a.shiftKey&&
c.ctrlKey===a.ctrlKey&&c.altKey===a.altKey?c.fn:void 0)c(),thr0.breakEvent(a);return void 0!==c}))},cacheOptionsKey:function(a,b,c){var d=(a.data("keyCache")||"")+String.fromCharCode(b),e=thrUI.indexOfOptionDiv(a,d);0>e&&(d=String.fromCharCode(b),e=thrUI.indexOfOptionDiv(a,d));0<=e&&(b=this.listdata(a,"values"),thrUI.doChange(a,c,b.length?b[e]:e));a.data("keyCache",d)},initGDrive:function(){function a(){thrUI.gDriveInitialized=!0;gapi.load("picker")}thrPK&&(thrPK.gapi&&!this.gDriveInitialized)&&(o.gapi?
a():thr0.initGSignin(a))},wrapActionEvent:function(a,b){if(a){if(/^touch/.test(a.type)){var c=a.changedTouches;return(c=void 0!==b?thr0.arrayObjByKey(c,"identifier",b):c.length?c[0]:void 0)?{type:a.type,clientX:c.clientX,clientY:c.clientY,target:c.target,currentTarget:a.currentTarget,shiftKey:a.shiftKey,ctrlKey:a.ctrlKey,altKey:a.altKey,identifier:c.identifier}:void 0}return void 0===b||b===this.getActionEventId(a)?a:void 0}},getActionEventId:function(a){return/^pointer/.test(a.type)?a.pointerId:
/^touch/.test(a.type)?a.identifier:a.type.substring(0,5)},setActionMaker:function(a,b){function c(a){if(!thrUI.action){var c=thrUI.wrapActionEvent(a),f=c?b(c):void 0;/^(object|function)$/.test(typeof f)&&(thrUI.action=f,f.eventId=thrUI.getActionEventId(c),f.moveEvent=(/^pointer/.test(c.type)?"pointer":c.type.substring(0,5))+"move",$(document).on(f.moveEvent,thrUI.moveAction));f&&thr0.breakEvent(a)}}if(o.PointerEvent)a.on("pointerdown",c);else if(a.on("mousedown",c),o.TouchEvent&&"ontouchstart"in o)a.on("touchstart",
c)},moveAction:function(a){var b=thrUI.action;if(b){var c=thrUI.wrapActionEvent(a,b.eventId);c&&(b.move(c),thr0.breakEvent(a))}},endAction:function(a,b){var c=this.action,d=c?this.wrapActionEvent(a,c.id):void 0;if(c&&(!a||d))thr0.notifyActivity(),c.end(d,b),this.action=void 0,c.moveEvent&&$(document).off(c.moveEvent,thrUI.moveAction),a&&thr0.breakEvent(a)},gPicker:{create:function(a,b,c,d){d=(new google.picker.DocsView).setIncludeFolders(!0).setMimeTypes(d?thrUI.mimeTypes.gfolder:thrUI.mimeTypes.gfiles).setSelectFolderEnabled(d);
(new google.picker.PickerBuilder).setTitle(b).enableFeature(google.picker.Feature.NAV_HIDDEN).setAppId(thrPK.gapi.appId).setOAuthToken(a).addView(d).setDeveloperKey(thrPK.gapi.devKey).setCallback(c).build().setVisible(!0)}},hourglass:{show:function(a,b){var c=a[0].getBoundingClientRect(),d=$(_h.div("",{"class":"thrHourglass"+(b?" thrNoBkgImg":""),style:"width: "+c.width+"px; height: "+c.height+"px;"})).appendTo(a),e=d[0].getBoundingClientRect();return d.css({left:c.left-e.left,top:c.top-e.top})},
hide:function(a,b){var c=a.find(".thrHourglass");c.length?c.remove():setTimeout(function(){thrUI.hourglass.hide(a,(b||0)+1)},1E3)}},imageView:{show:function(a,b,c){b=thrUI.createControl($(_h.div("",{"class":"thrDark","data-max":b})).appendTo("body"),"imageView","thrDlgBack",["click"],"\x3cimg/\x3e"+_h.div(_h.div(),"thrPrev")+_h.div(_h.div(),"thrNext")+_h.div(_h.div(),"thrDescription thrCollapsed")+_h.div(_h.div()+_h.div(),"thrClose")).css("text-align","center");thrUI.setTempData(b,"getImageInfos",
c);this.setImage(b,a);return b},setImage:function(a,b){var c=thrUI.getTempData(a,"getImageInfos"),d=a.data("max"),c=c(b),e=a[0].getBoundingClientRect(),e=Math.round(90*Math.min(e.width/c.width,e.height/c.height)*c.width/e.width);a.data("current",b).data("max",d).find("img").attr("src",c.src).css("width",e+"%");thrUI.setElementDisplay(a.find(".thrPrev"),0<b);thrUI.setElementDisplay(a.find(".thrNext"),b<d-1);thrUI.setElementDisplay(a.find(".thrDescription").empty().append(c.desc||""),void 0!==c.desc)},
click:function(a){a=$(a.target);var b=a.closest(".thrDlgBack");a.closest(".thrPrev").length?this.setImage(b,parseInt(b.data("current"),10)-1):a.closest(".thrNext").length?this.setImage(b,parseInt(b.data("current"),10)+1):a.closest(".thrDescription").length?a.closest(".thrDescription").toggleClass("thrCollapsed"):this.hide()},hide:function(){var a=$("body").find(".thrDlgBack");thrUI.deleteTempData(a);a.remove()}},userinfo:{create:function(a){var b=thr0.getUserInfo();thrUI.createControl(a,"userinfo",
"thrUserInfo",["click"],this.getHtml(a,b));b&&a.addClass("thrCollapsed")},fill:function(a,b){a.empty().append(this.getHtml(a,b));b&&a.addClass("thrCollapsed")},isAdmin:function(a){return a.roles?0<=a.roles.indexOf("sfsAdmin"):a.permissions&1},isDev:function(a){return a.roles?0<=a.roles.indexOf("sfsDev"):a.permissions&2},getHtml:function(a,b){var c=thrUI.ntx;if(!b)return _h.tag("a",c.signin,{href:thr0.makeUrl(a.data("signinurl"))});var d={colspan:2},e=[[[thr0.escapeHtml(b.dispName),{"class":"thrUsername",
colspan:2}]],[[thr0.escapeHtml(b.email),{"class":"thrUsermail",colspan:2}]]];b.flags&&e.push([[_h.btn(_h.span(c.notifications,"thrNotification"),{href:thr0.makeUrl(thr0.url.notifications),target:"_blank"}),d]]);this.isDev(b)&&e.push([[_h.btn(c.devTools,{"data-cmd":"devtools"}),d]]);this.isAdmin(b)&&e.push([[_h.btn(c.adminTools,{href:thr0.makeUrl(thrUI.url.admin),target:"_blank"}),d]]);e.push([_h.btn(c.account,{onclick:'thrUI.openTab("'+a.data("accounturl")+'");'}),_h.btn(c.signout,{"data-cmd":"signout",
"class":"thrAccent"})]);return thrUI.ihtml("dropdownButton",{bn:_h.span(thr0.escapeHtml(b.dispName),b.flags?"thrNotification":void 0),dd:_h.table(0,e)})},click:function(a){a=$(a.target).data("cmd");"signout"===a?thr0.signOut(1):"devtools"===a&&thrUI.dialog.show("Developer tools",0,2,thrUI.devTools.map(function(a){return _h.btn(a.caption,{onclick:a.onclick+" event.stopPropagation();"})}).join(""))}},languageSelector:{flagCls:function(a){return"thrFlag"+thr0.firstCharToUpperCase(a.toLowerCase())},create:function(a){var b=
(thrNtx?thrNtx.iso639_1:"en").toLowerCase(),c=thrNtx?thrNtx.availableLangs:["English"],d="\x3ctable\x3e\x3ctbody\x3e"+(thrNtx?thrNtx.availableIso639_1:["en"]).map(function(a,b){return _h.tableRow([c.length>b?c[b]:a,_h.div("","thrFlag "+this.flagCls(a))],!1,{"data-flag":a})},this).join("")+_h.tableRow([["",{colspan:2}]],!1,"thrHint thrNoDisplay")+"\x3c/tbody\x3e\x3c/table\x3e";a.addClass("thrCollapsed");thrUI.createControl(a,"languageSelector","thrLanguageSelector",["click"],thrUI.ihtml("dropdownButton",
{bn:_h.div("","thrFlag "+this.flagCls(b)),dd:d}))},fill:function(a,b){var c=a.find(".thrHint");thrNtx&&thrNtx.setLanguage(b,thrUI.form.cache);a.find(".thrDropdownButton .thrFlag").removeClass().addClass("thrFlag").addClass(this.flagCls(b));"en"===b||thrNtx.isPageLangAvailable(b)?c.addClass("thrNoDisplay"):c.removeClass("thrNoDisplay").find("\x3etd").text(thrUI.ntx.pageLangNotAvailable)},click:function(a){var b=$(a.currentTarget);if((a=$(a.target).closest("tr").data("flag"))&&b.data("value")!==a)this.fill(b,
a),thrUI.dropdownButton.toggleDropdown(b)}},form:{cache:{},addToCache:function(a,b,c){this.cache[a]={ctx:b,html:c}},clearCache:function(){this.cache=[]},initialize:function(a,b,c,d,e){thrUI.setTempData(a,{changesAllowed:b,formChange:c,saveSettings:d,initForm:e});a.off("change").change(function(a){thrUI.form.change(a)}).off("click").click(function(a){thrUI.form.click(a)})},finalize:function(a){thrUI.deleteTempData(a)},setHtml:function(a,b,c,d){var e=a.data("formtype"),f=a.data("cls");b=b||e;if(e!==
b||f!=c&&"*"!==f){var g=this.cache[b+thr0.firstCharToUpperCase(c)],h=a.find("\x3e.thrTabpanel"),i=c,j=(e||"")+thr0.firstCharToUpperCase(f||"");g||(g=this.cache[b+"*"],i="*");j&&(this.cache[j]&&h.length)&&(this.cache[j].tabix=thrUI.tabpanel.getValue(h));thrUI.callTempDataFunc(a,"saveSettings",[e,f,a]);a.empty().data("formtype",b).data("cls",i);g&&(h=g.html,a.data("ctx",g.ctx),h&&(d=void 0!==d?d:g.tabix,a.html($.isFunction(h)?h():h),thrUI.callTempDataFunc(a,"initForm",[b,c,a]),thrUI.initControls(a),
h=a.find("\x3e.thrTabpanel"),h.length&&void 0!==d&&(h.find("ul\x3eli\x3e*:first-child").removeData("value"),thrUI.tabpanel.activateTabNo(h,d<thrUI.tabpanel.tabCount(h)?d:0,!0))))}else f!==c&&(a.data("formtype",b).data("cls",c),thrUI.callTempDataFunc(a,"initForm",[b,c,a]))},fill:function(a,b,c,d){var e=this;a.children().each(function(){var a=$(this),g=a.data("prop"),h=a.data("control");if("grid"===h)thrUI.grid.fill(a,b,d);else if(g){var h=h?thrUI[h]:{fill:function(a,b){a.is("input, textarea")?a.val(b):
a.text(b)}},i=a.data("if");i&&thrUI.setElementDisplay(a,thr0.evalCondition(i,function(a){return c(a,b)}));for(var i=0,j=h.fieldcount||1;i<j;i++)if(0<i&&(g=a.data("prop"+i)),g){var k,l,m,n=c(g,b);void 0===n?n="":"object"===typeof n&&void 0!==n.val&&(h.setUnit&&a.data("unit")!==n.unit&&(h.setUnit(a,n.unit||""),m=!0),n=n.val);k=JSON.stringify(n);l="valstr"+(i?i:"");if(m||k!==a.data(l))h.fill&&h.fill(a,n,i),a.data(l,k)}}else!a.hasClass("thrSub")&&this.hasChildNodes()&&e.fill(a,b,c,d)})},change:function(a){var b=
$(a.target),c=b.data("control"),d="grid"===c,e=a.prop||b.data("prop"),f=a.func;if(e||f||d){var g=c?thrUI[c]:{getValue:function(a){return a.is("input, textarea")?a.val():a.text()}},c=$(a.currentTarget),h=void 0!==a.value?a.value:g.getValue(b);a.stopPropagation();if(d)e=b.data("gridcontent"),h={rowid:a.rowid,prop:a.gridprop,value:h};else if(b.data("prop")===e)b.data("valstr",JSON.stringify(h));else if(1<(g.fieldcount||1))for(g=g.fieldcount-1;0<g;g--)if("prop"===b.data("prop"+g)){b.data("valstr"+g,JSON.stringify(h));
break}if(!thrUI.callTempDataFunc(c,"changesAllowed",[b.data("ctx"),e,f,h,d],!0)||!1===thrUI.callTempDataFunc(c,"formChange",[c.data("ctx")||c,e,f,h,d]))a.err=!0}},click:function(a){var b=$(a.currentTarget),c=$(a.target),d=a.func||c.data("func");d?thrUI.callTempDataFunc(b,"formChange",[b.data("ctx")||b,void 0,d,c.data("funcno"),!1]):0>=b.closest(".thrDropdown, .thrDropdownButton, .thrDropdownSelect").length&&thrUI.hideDropdowns(a)}},dialog:{create:function(a,b,c,d){var e=thrUI.ntx,f=$.isArray(c)?_h.table(void 0,
c,"thrDlgBody"):_h.div("string"===typeof c?c:"","thrDlgBody");b=("number"===typeof b?[[e.ok],[e.ok,e.cancel],[e.close],[e.del,e.cancel]][b]:b).map(function(a,b){return a?_h.btn(a,{"class":b?void 0:"thrAccent","data-dlgcmd":a}):_h.upgradeBtn(!b)}).join("");b=_h.table(void 0,[["",b]],"thrDlgButtons");a=thrUI.createControl($(_h.div()).appendTo("body"),"dialog","thrDlgBack",["change","click"],_h.div(_h.div(a,"thrDlgTitle")+f+b,"thrDialog"));f=a.find("\x3e.thrDialog").keydown(function(a){thrUI.dialog.keydown(a)});
b=f.find("\x3e.thrDlgBody");thrUI.hideDropdowns();$.isFunction(c)?c(b):c instanceof Element&&b.append(c);b.css("max-height",thrUI.elementsHeight(a)-thrUI.elementsHeight(f.find("\x3e.thrDlgTitle, \x3e.thrDlgButtons"))-20+"px");d&&thrUI.initControls(f);this.center(f);return a},show:function(a,b,c,d,e){a=this.create(a,c,d,e);c=thrUI.getFocusables(a.find(".thrDlgBody"));thrUI.setTempData(a,{activeElement:document.activeElement,callback:b});c.length?c.first().focus().select():a.find(".thrAccent").focus();
return a},showHint:function(a,b,c,d){var e=thrUI.ntx,f=b?thr0.strToPojo(localStorage.thrHintSetting)||{}:void 0;!b||!f[b]?(a+=b?_h.div(thrUI.ihtml("checkbox",{"class":"thrDlgResult",prop:"dsa"},e.dontShowAgain),{style:"margin: 10px 0 0 5px;"}):"",this.show(e.hint,function(a){a.dsa&&(f[b]=!0,localStorage.thrHintSetting=JSON.stringify(f));c()},d?1:0,a,b)):c()},showLicenseRestriction:function(){var a=thrUI.ntx;this.show(a.licRestriction,void 0,[0,a.close],_h.tag("h2",a.licHint[0],{style:"color: #a9bf04; margin: 10px;"})+
_h.tag("ul",a.licHint.slice(1).map(function(a){return _h.tag("li",a)}).join("")+_h.tag("li","..."))).find(".thrDlgBody").css("background-color","#fff")},checkShowCreateRestriction:function(a,b,c){if(b>c-4){var d=thrUI.ntx;thrUI.dialog.show(d.licRestriction,0,[0,d.close],b>=c?d.licLimit1+b+" "+a+d.licLimit2:d.licLimitInfo1+b+" "+a+d.licLimitInfo2+c+" "+a+".")}},showValueQuestion:function(a,b,c,d,e,f){var g,h="password"===f;g="number"===typeof e;e={"class":"thrDlgResult thrInitControl","data-control":g?
"numberInput":"textInput","data-prop":"val","data-unit":!h?f:void 0,"data-value":e,style:"display: inline-block;"};a=this.show(a,b,1,_h.div((c?_h.div(c,"thrDlgText"):"")+_h.table(0,[[d,["",e]]])));thrUI.initControls(a);g=a.find("input").attr("size",g?15:30);h&&g.attr("type","password");thrUI.setFocus(a)},showImExport:function(a,b){var c,d=thrUI.ntx,e=thr0.strToPojo(localStorage.imexSpec,{sep:"\t",format:0});c=[[d.separator+":",["",{"class":"thrInitControl","data-control":"optionGroup","data-options":d.separatorOpts,
"data-prop":"sep","data-value":"\t,;".indexOf(e.sep)}]],[d.treeFormat+":",["",{"class":"thrInitControl","data-control":"optionGroup","data-options":d.treeFormatOpts,"data-prop":"fmt","data-value":e.format}]]];c=_h.div(_h.table(0,c,{style:"border-spacing: 5px;"})+_h.div(b?d.copyHint:d.pasteHint,{style:"margin: 20px 0 0 0;"})+"\x3ctextarea"+_h.attrs({"class":"thrDlgResult",readonly:b?"readonly":void 0,"data-prop":"text",style:"width: 100%; height: 200px; margin: 10px 0; box-sizing: border-box;"})+"/\x3e",
{style:"max-width: 700px;"});var f=this.show(b?d.copyToClipboard:d.pasteFromClipboard,function(b){b.cmd===d.ok&&b.text&&a.setFromExString(b.text,thr0.strToPojo(localStorage.imexSpec,{sep:"\t",format:0}))},b?2:1,c,!0);c=f.find("textarea");b&&c.val(a.getExString(e));c.focus().select();f.find(".thrDlgBody").change(function(c){var d=thr0.strToPojo(localStorage.imexSpec,{sep:"\t",format:0});thr0.breakEvent(c);"sep"===c.prop?d.sep="\t,;".charAt(c.value):"fmt"===c.prop&&(d.format=c.value);localStorage.imexSpec=
JSON.stringify(d);b&&$(c.currentTarget).find("textarea").val(a.getExString(d)).focus().select()})},keydown:function(a){if(13===(a.keyCode||a.which)){var b=$(a.target);b.hasClass(".thrButton")||(b=b.closest(".thrDialog"),b=1>=thrUI.getFocusables(b.find("\x3e.thrDlgBody")).length?b.find(".thrButton.thrAccent"):[]);1===b.length&&(thr0.breakEvent(a),b.click())}},close:function(a){var b=thrUI.getTempData(a,"activeElement");b&&$(b).focus();thrUI.deleteTempData(a);a.data("isPropDlg")&&thrUI.form.finalize(a.find(".thrDlgBody"));
a.closest(".thrDlgBack").remove()},center:function(a){var b=a.parent()[0].getBoundingClientRect(),c=a[0].getBoundingClientRect(),c={left:b.left+Math.round((b.width-c.width)/2),top:b.top+Math.round(0.382*(b.height-c.height))};10>c.left&&(c.left=0,c.width=b.width-10);10>c.top&&(c.top=0,c.height=b.height-10);a.css(c)},change:function(a){if(a.dlgCmd){var b,c=thrUI.ntx,d=$(a.currentTarget),e=thrUI.getTempData(d,"callback");e&&0>[c.close,c.cancel].indexOf(a.dlgCmd)&&(b=d.data("isPropDlg")?thrUI.getTempData(d,
"obj"):this.getResult(d,a.dlgCmd));this.close(d);e&&b&&e(b)}},propChange:function(a,b,c,d){(a=thrUI.getTempData(a.closest(".thrDlgBack"),"obj"))&&b&&(a[b]=d)},getResult:function(a,b){var c={cmd:b};a.find(".thrDlgResult").each(function(){var a=$(this),b=a.data("control");c[a.data("prop")]=b?thrUI[b].getValue(a):a.is("input, textarea")?a.val():a.data("value")});return c},click:function(a){var b=$(a.target),c=b.hasClass("thrDlgTitle")&&a.offsetX>b[0].offsetWidth-32?thrUI.ntx.close:b.data("dlgcmd");c&&
(b.is("a")||a.preventDefault(),a.stopPropagation(),b.closest(".thrDialog").trigger($.Event("change",{dlgCmd:c})))}},message:{create:function(a){a=thrUI.createControl($(_h.div()).appendTo("body"),"message","thrDlgBack",void 0,_h.div(_h.span(a,"thrMessageText"),"thrMessage"));thrUI.hideDropdowns();thrUI.dialog.center(a.find("\x3e.thrMessage"));return a},show:function(a,b,c){if(a){var d=this.create(a);b&&d.find(".thrMessage").click(function(a){thrUI.message.click(a)});c&&(this.timeout=setTimeout(function(){thrUI.message.close(d)},
c));return d}},hide:function(a){this.timeout&&clearTimeout(this.timeout);this.close(a)},hideAll:function(){this.hide($(".thrMessage"))},close:function(a){a.closest(".thrDlgBack").remove();this.timeout=void 0},click:function(a){this.hide($(a.currentTarget));thr0.breakEvent(a)}},grid:{create:function(a){var b=a.find("\x3etbody");thrUI.createControl(a,"grid","thrGrid","focus blur keydown keypress click dblclick change".split(" "),void 0,!0);thrUI.setActionMaker(a,function(a){thrUI.grid.pseudoActionMaker(a)});
b.length?b.find("\x3etr:not(:first-child)").remove():a.append(_h.tag("tbody"))},fillCell:function(a,b){var c=a.data("prop");if(c){var d=a.data("control"),d=d?thrUI[d]:{},c="object"===typeof b?b[c]:b;if("number"===$.type(c)){var e=a.data("options");a.data("value",c);e&&(e=e.split(","));if(e&&c<e.length){var f=a.data("values");f&&(c=f.split(",")[c]);c=e[c]}else c=thr0.addThousandSeps(thr0.formatLocalFloat(c))}d.showInGrid?(d.create(a),d.fill(a,c)):(void 0===c?(c=a.data("hint")||"",a.addClass("thrHint")):
a.removeClass("thrHint"),d=JSON.stringify(c),d!==a.data("valstr")&&(this.hideInplace(a),a.text(c),a.data("valstr",d)))}else{var g=this;b.isTotal?a.addClass("thrTotal"):a.removeClass("thrTotal");a.children().each(function(){g.fillCell($(this),b)})}},fill:function(a,b,c){var d=a.data("gridcontent");if(d){var e,f=c(d,b),d=a.find("\x3etbody"),g=d.find("\x3etr"),h=f.length&&f[0].hasOwnProperty("id");b=0<d.find(".thrFocusedCell").length;a.data("changing")&&f.length===g.length&&(e=[],g.each(function(){var a=
h?thr0.indexOfKey(f,"id",$(this).data("rowid")):$(this).index();if(0>a)return e=void 0,!1;e.push(f[a])}),e&&(f=e));if("string"==typeof f||f.length!==g.length||0<d.find(".thrGridMultiValues").length)d.find("\x3etr:not(:first-child)").remove(),g=d.find("\x3etr"),g.find("td").each(function(){$(this).data("prop")&&$(this).text("").removeData("valstr")});c=$(g[0]);if("string"==typeof f||!f.length)c.css("display","none"),"string"==typeof f&&d.append("\x3ctr class\x3d'thrGridMultiValues'\x3e\x3ctd colspan\x3d'"+
c.children().length+"'\x3e"+f+"\x3c/td\x3e\x3c/tr\x3e");else{var i,j;c.css("display","");j=a.data("emptyrows")||0;for(i=f.length-1;0<=i;i--)if($.isEmptyObject(f[i]))j--;else break;for(i=0;i<j;i++)f.push({});for(i=0;i<f.length;i++)i<g.length?j=$(g[i]):(j=c.clone(),d.append(j),j.find(".thrFocusedCell").removeClass("thrFocusedCell")),j.data("rowid",h?f[i].id:i),this.fillCell(j,f[i])}e||(c=1,d=a.find("\x3ethead\x3etr\x3e.thrAsc"),d.length||(c=-1,d=a.find("\x3ethead\x3etr\x3e.thrDesc")),d.length&&this.sort(a,
d,c));b&&this.focusFirstCellIfNoCellFocus(a)}},focusFirstCellIfNoCellFocus:function(a){0>=a.find(".thrFocusedCell").length&&a.find("tbody\x3etr:first-child\x3etd:first-child").addClass("thrFocusedCell")},setCellFocus:function(a,b){a.find(".thrFocusedCell").removeClass("thrFocusedCell");b.addClass("thrFocusedCell");/^(textInput|numberInput)$/.test(b.data("control"))&&this.showInplace(a,b)},moveCellFocus:function(a,b,c){var d,e;this.hideInplace(a);this.focusFirstCellIfNoCellFocus(a);e=a.find(".thrFocusedCell");
d=e.parent();37===b?e=e.prev():38===b?e=d.prev().children().eq(e.index()):39===b?e=e.next():40===b?e=d.next().children().eq(e.index()):c&&9===b?(e=e.prev(),e.length||(e=d.prev().children().last())):(e=e.next(),e.length||(e=d.next().children().first()));if(e.length)return this.setCellFocus(a,e),!0},hideInplace:function(a){var b=a.find(".thrInplaceEdit"),c=b.data("changed"),d=b.closest("td");b.remove();void 0!==c&&this.triggerChange(a,d,c)},triggerChange:function(a,b,c){b=$.Event("change",{rowid:b.closest("tr").data("rowid"),
gridprop:b.data("prop"),value:c});a.data("changing",1).trigger(b).removeData("changing");return!b.err},getCellValue:function(a){var b=a.data("value");void 0===b&&(b=(b=$(a).data("control"))&&thrUI[b].showInGrid?thrUI[b].getValue(a):a.hasClass("thrHint")?void 0:a.text());return b},startCustomEditing:function(a,b){var c=a.data("onstartediting");if(c){var d=c.split("."),c=d.pop(),d=d.reduce(function(a,b){return"object"===typeof a?a[b]:void 0},o);if("object"===typeof d&&"function"===typeof d[c]){var e=
{rowid:b.closest("tr").data("rowid"),gridprop:b.data("prop"),value:this.getCellValue(b)};return d[c].call(d,e)}}},showInplace:function(a,b){if(0<a.length&&(b||(b=a.find(".thrFocusedCell")),!b.closest("tr").hasClass("thrTotal")&&!this.startCustomEditing(a,b))){var c=b.data("control"),d=c?thrUI[c]:{};if(!d.showInGrid){var e,f,g;this.hideInplace(a);e=b[0].getBoundingClientRect();g=$(_h.div("","thrInplaceEdit")).appendTo(b);thrUI.copyData(b,g,"options");thrUI.copyData(b,g,"values");d.create(g);g.css({left:"0",
top:"0",width:e.width+"px",height:e.height+"px",margin:"0"});f=g[0].getBoundingClientRect();c=/^(textInput|numberInput)$/.test(c)?-1:1;g.css({top:Math.round(e.top-f.top+c)+"px",left:Math.round(e.left-f.left+c)+"px"});g.find("*").blur(function(a){thrUI.grid.hideInplace($(a.currentTarget).closest(".thrGrid"))});thrUI.setFocus(g);d.fill(g,this.getCellValue(b));return g}}},focus:function(a){this.focusFirstCellIfNoCellFocus($(a.currentTarget))},blur:function(a){a=$(a.currentTarget);0>=a.find(".thrInplaceEdit").length&&
a.find(".thrFocusedCell").removeClass("thrFocusedCell")},keydown:function(a){var b=a.keyCode||a.which,c=$(a.currentTarget),d=$(a.target).closest(".thrInplaceEdit");if(0<d.length)if(27===b)document.queryCommandSupported("undo")&&document.execCommand("undo"),d.removeData("changed"),c.focus(),this.hideInplace(c);else{if(9===b||13===b||113===b)c.focus(),this.hideInplace(c),(9!==b||this.moveCellFocus(c,b,a.shiftKey))&&thr0.breakEvent(a)}else 37<=b&&40>=b||9===b?this.moveCellFocus(c,b,a.shiftKey)&&thr0.breakEvent(a):
113===b&&this.showInplace(c)},keypress:function(a){var b=$(a.target);if(0>=b.closest(".thrInplaceEdit").length&&0>=b.closest(".thrFocusedCell").length){var c=a.keyCode||a.which;if((b=this.showInplace($(a.currentTarget)))&&b.length&&13!==c){var d=b.closest("td"),e=d.data("value"),d=d.data("control"),c=String.fromCharCode(c);(void 0===e||e.toString()!==c)&&b.data("changed",c);thrUI.setFocus(b);thrUI[d].fill(b,c);/^(textInput|numberInput)$/.test(d)&&(b=b.find("input")[0],b.selectionStart=1,b.selectionEnd=
1);thr0.breakEvent(a)}}},pseudoActionMaker:function(a){var b=$(a.target);if(!b.closest(".thrInplaceEdit").length){var c=$(a.currentTarget),d=b.closest("td"),e=d.hasClass("thrFocusedCell");c.focus();this.hideInplace(c);if(b.is("th"))this.sort(c,b,b.hasClass("thrAsc")?-1:1);else if(!e||a.shiftKey)e?d.removeClass("thrFocusedCell"):(this.setCellFocus(c,d),d.addClass("thrJustFocused"));return!0}},click:function(a){var b=$(a.target).closest("td").removeClass("thrSkipDblClick");b.hasClass("thrJustFocused")?
b.removeClass("thrJustFocused"):b.hasClass("thrFocusedCell")&&(this.dblclick(a),b.addClass("thrSkipDblClick"))},dblclick:function(a){var b=$(a.target),c=$(a.target).closest("td, th");!b.hasClass("thrSkipDblClick")&&(!c.is("th")&&0>=b.closest(".thrInplaceEdit").length&&!c.closest("tr").hasClass("thrTotal"))&&(this.showInplace($(a.currentTarget),c),thr0.breakEvent(a))},change:function(a){var b,c=a.target?$(a.target):a;b=c.closest(".thrInplaceEdit");var c=c.closest("td"),d=c.data("valstr"),e=c.closest(".thrGrid");
c.data("prop")&&(b.removeData("changed"),b=void 0!==a.value?a.value:thrUI[c.data("control")].getValue(b),this.setCellFocus(e,c),a.stopPropagation(),this.triggerChange(e,c,b)&&d===c.data("valstr")&&this.fillCell(c,b))},sort:function(a,b,c){var d=this,e=a.find("tbody"),f=b.index()+1,g=[],h=[];a.find("\x3ethead\x3etr\x3eth").removeClass("thrAsc").removeClass("thrDesc");e.find("\x3etr").each(function(){g.push({$r:$(this),v:d.getCellValue($(this).find("\x3etd:nth-child("+f+")"))})});for(a=(a.data("emptyrows")||
0)-1;0<=a;a--)h.push(g.pop());g.length&&g[g.length-1].$r.hasClass("thrTotal")&&h.push(g.pop());for(g.sort(function(a,b){return c*(a.v<b.v?-1:a.v===b.v?0:1)});h.length;)g.push(h.pop());g.forEach(function(a){e.append(a.$r)});b.addClass(0<c?"thrAsc":"thrDesc")}},treeTable:{create:function(a){a.find("\x3ethead, table:not(.thrTreeTable, .thrInitControl)\x3ethead").click(function(a){thrUI.treeTable.click(a)});a.addClass("thrTreeTable").find("table").removeClass("thrInitControl").addClass("thrTreeTable")},
click:function(a){$(a.target).is("input, textarea")||($(a.currentTarget).parent().toggleClass("thrCollapsed"),thr0.breakEvent(a))}},treeview:{create:function(a){a.addClass("thrTreeview").attr("tabindex",0).find("ul").each(function(){var a=$(this).parent();a.is("li")&&a.addClass("thrTreenode")});thrUI.setActionMaker(a,function(a){thrUI.treeview.pseudoActionMaker(a)});a.find(".thrTreenode").click(function(a){thrUI.treeview.click(a)})},refresh:function(a,b){this.refreshNode(a.empty(),b);a.find(".thrTreenode").click(function(a){thrUI.treeview.click(a)})},
refreshNode:function(a,b){b.sub.forEach(function(b){var d;b instanceof ThrTreeNode?(d=$(_h.tag("li",_h.div(b.name)+_h.tag("ul"),"thrTreenode thrCollapsed")).appendTo(a),this.refreshNode(d.find("ul"),b)):d=$(_h.tag("li",b.name)).appendTo(a);void 0!==b.val&&d.data("value",b.val)},this)},click:function(a){$(a.target).closest("li").parent().parent().is(a.currentTarget)||$(a.currentTarget).toggleClass("thrCollapsed");thr0.breakEvent(a)},pseudoActionMaker:function(a){var b=$(a.target).closest("li"),c=b.parent();
a=$(a.currentTarget);if((c.is(a)||c.parent().hasClass("thrTreenode"))&&(!b.hasClass("thrTreenode")||a.hasClass("thrSelectableNodes")))thrUI.changeSelection(a,b,0,!0),thrUI.triggerChange(a,"treeview",b)},getValue:function(a){return thrUI.getSelected(a)}},dropdownTreeview:{create:function(a,b){var c;thrUI.createControl(a.addClass("thrCollapsed"),"dropdownTreeview","thrDropdownSelect",["click","change","blur"],_h.div("","thrDropdownValue")+_h.div(_h.tag("ul"),"thrDropdown"),!0);thrUI.setActionMaker(a,
function(a){$(a.currentTarget).data("innerblur",!0)});c=a.find(".thrDropdown\x3eul");thrUI.treeview.create(c);thrUI.treeview.refresh(c,b)},fill:function(a,b,c){a.data("value",b).find(".thrDropdownValue").text(c||b)},getValue:function(a){return a.data("value")},click:function(a){$(a.currentTarget).toggleClass("thrCollapsed");thr0.breakEvent(a)},change:function(a){if(a.value){for(var b=$(a.currentTarget),c=a.value,d=c.text(),e=c.data("value"),f=b.data("charlimit")||99,c=c.parent();!c.hasClass("thrTreeview");)c=
c.parent(),d=c.find("\x3ediv").text()+" - "+d,c=c.parent();d.length>f&&(d=d.substring(0,f-3)+"...");this.fill(b,e,d);b.addClass("thrCollapsed");thr0.breakEvent(a)}},blur:function(a){a=$(a.currentTarget);a.data("innerblur")?a.data("innerblur",""):a.addClass("thrCollapsed")}},path:{create:function(a){thrUI.createControl(a.empty(),"path","thrPath",["click"])},fill:function(a,b,c,d){a.empty().append(_h.div(a.data("rootname")||"[]"));b.forEach(function(b){a.append(_h.div("","thrPathDelim")+_h.div(b))});
c&&this.setLastOptions(a,c,d)},setLastOptions:function(a,b,c){var d=a.find("\x3ediv:last-child")[0].getBoundingClientRect().width;b&&b.length&&(b=b.map(function(a,b){return _h.div(a,this?{"data-id":this[b]}:void 0)},c),a.find(".thrArrowDown").remove(),a.append(_h.div(_h.div(b.join(""),"thrDropdown"),"thrArrowDown thrCollapsed")),d+=a.find(".thrArrowDown")[0].getBoundingClientRect().width,a.find(".thrDropdown").css({left:-d+"px"}))},getValue:function(a){a=a.children().filter(":not(.thrPathDelim):not(.thrArrowDown)").map(function(){return $(this).text()}).get();
a.shift();return a},click:function(a){var b=$(a.currentTarget),c=$(a.target);thr0.breakEvent(a);c.parent().hasClass("thrDropdown")?(b.append(_h.div("","thrPathDelim")+_h.div(c.text())),c.closest(".thrArrowDown").remove(),thrUI.triggerChange(b,"path",c.data("id"))):!c.hasClass("thrPathDelim")&&(!c.hasClass("thrDropdown")&&!c.hasClass("thrPath"))&&(a=c.next().addBack().filter(".thrArrowDown"),a.length?a.toggleClass("thrCollapsed"):c.next().hasClass("thrPathDelim")&&(b.find("\x3e*:nth-child(n+"+(c.index()+
2)+")").remove(),thrUI.triggerChange(b,"path")))}},folderList:{create:function(a,b,c){thrUI.createControl(a,"folderList","thrFolderList",["change","dblclick"],_h.div()+_h.div("",c?{style:"height: "+c+"px"}:void 0));thrUI.path.create(a.find("\x3ediv:first-child").data("rootname",a.data("rootname")));thrUI.listbox.create(a.find("\x3ediv:nth-child(2)"));b&&$(_h.div("",{"class":"thrNewFolder",title:thrUI.ntx.addNewFolder})).prependTo(a).click(function(a){thrUI.folderList.newFolder(a)})},fill:function(a,
b,c){var d=a.data("temp"),e=a.find(".thrPath"),f=b&&!$.isEmptyObject(b)?b.pop():-1;c&&d!==c&&(a.data("temp",c),e.data("temp",c));thrUI.path.fill(e,b||[]);this.setLbOptions(a,b||[]);thrUI.listbox.fill(a.find(".thrListbox"),f)},getTempData:function(a){return a.split(".").reduce(function(a,c){return a[c]},thrUI.temp)},getTreeNode:function(a,b){var c=a.data("temp");return(c=c?this.getTempData(c):void 0)?c.findNode(b):void 0},setLbOptions:function(a,b){var c=[],d=[],e=this.getTreeNode(a,b);e&&(c=e.nodes().map(function(a){return a.name}),
c.length&&thrUI.path.setLastOptions(a.find(".thrPath"),c),d=e.sub.map(function(a){return a.name}),c=e.sub.map(function(a){return a.icon||(a instanceof ThrTreeNode?"thrIconFolder":"thrIconApp")}));thrUI.listbox.setOptions(a.find(".thrListbox").data("value",-1),d,c)},getValue:function(a){var b=thrUI.path.getValue(a.find(".thrPath"));b.push(thrUI.listbox.getValue(a.find(".thrListbox")));return b},drilldown:function(a,b){var c=a.find(".thrPath"),d=thrUI.path.getValue(c),e=this.getTreeNode(a,d),f=e&&0<=
b&&b<e.sub.length&&e.sub[b]instanceof ThrTreeNode;f&&(d.push(e.sub[b].name),thrUI.path.fill(c,d),this.setLbOptions(a,d));return f},change:function(a){var b=$(a.currentTarget),c=$(a.target);c.hasClass("thrFolderList")||(c.hasClass("thrListbox")?this.drilldown(b,a.value)&&(a.err=!0):c.hasClass("thrPath")&&this.setLbOptions(b,a.value),a.stopPropagation())},dblclick:function(a){var b=$(a.currentTarget),c=b.find(".thrListbox");0<c.length&&(thr0.breakEvent(a),this.drilldown(b,thrUI.listbox.getValue(c))||
thrUI.triggerChange(b,"folderList"))},newFolder:function(a){var b=thrUI.ntx;thr0.breakEvent(a);thrUI.dialog.show(b.addNewFolder,function(b){thrUI.folderList.createFolder($(a.currentTarget).closest(".thrFolderList"),b.name)},[b.addFolder,b.cancel],_h.div(_h.span(b.folderName+": ")+_h.inp({"class":"thrDlgResult","data-prop":"name",size:"30",value:b.newFolder})))},createFolder:function(a,b){if(thr0.isValidFilename(b)){var c=thrUI.path.getValue(a.find(".thrPath"));c.push(b);this.getTempData(a.data("temp")).add(c);
c.push(-1);thrUI.folderList.fill(a,c)}else c=thrUI.ntx,thrUI.dialog.show(c.invalidFolderName,0,0,c.folderNameHint+"\x3cbr/\x3e"+c.invalidChars+': \\ / : * ? " \x3c \x3e |')}},accordeon:{create:function(a,b){thrUI.createControl(a,"accordeon","thrAccordeon",["click"],b?this.headingsHtml(b):void 0);b||a.children().addClass("thrArea").find("\x3e*:first-child").addClass("thrAreaHead")},headingsHtml:function(a){return a.map(function(a){return _h.div(_h.tag("h1",a,"thrAreaHead")+_h.div(),"thrArea")})},setHeadings:function(a,
b){a.empty().html(this.headingsHtml(b))},fill:function(a,b){this.expand(a,a.find("\x3e*:nth-child("+(b||"1")+")"))},getValue:function(a){return a.find("\x3e*:not(.thrCollapsed)").index()+1},click:function(a){var b=$(a.target);b.hasClass("thrAreaHead")&&(this.toggle($(a.currentTarget),b.parent()),thr0.breakEvent(a))},expand:function(a,b){1===b.length&&(b.find("\x3e.thrAreaHead").removeClass("thrBlinkingBack"),b.hasClass("thrCollapsed")&&(a.children().addClass("thrCollapsed"),b.removeClass("thrCollapsed"),
a.trigger($.Event("change",{value:b.parent().find("\x3e*:first-child").text()}))))},toggle:function(a,b){b.hasClass("thrCollapsed")?this.expand(a,b):b.addClass("thrCollapsed")},blinkIfClosed:function(a){a.hasClass("thrCollapsed")&&a.find("\x3e.thrAreaHead").addClass("thrBlinkingBack")}},textInput:{create:function(a){var b=a.data("value");thrUI.createControl(a,"textInput","thrInput",["change"],a.is("input[type\x3d'text']")?void 0:_h.inp());void 0!==b&&this.fill(a,b)},ihtml:function(a){return _h.inp(_h.basicIAttrs("textInput",
a))},fill:function(a,b){var c="number"===typeof b?thr0.formatLocalFloat(b,!0):b;a.data("value",c).find("input").addBack("input").val(c)},getValue:function(a){return a.find("input").addBack("input").val()},change:function(a){if(void 0===a.value){var b=$(a.currentTarget);thr0.breakEvent(a);thrUI.triggerChange(b,"textInput")||this.fill(b,b.data("value"))}}},numberInput:{create:function(a){var b=a.data("value");thrUI.createControl(a,"numberInput","thrInput",["change"],a.is("input[type\x3d'text']")?void 0:
_h.inp());thrUI.setUnit(a,a.data("unit"));void 0!==b&&this.fill(a,b)},ihtml:function(a){return _h.inp(_h.basicIAttrs("numberInput",a))},fill:function(a,b){var c=thr0.formatLocalFloat(b*(o.thrUnits?thrUnits.getFactor(a.data("unit")):1));a.data("value",b).find("input").addBack("input").val(c)},getValue:function(a){return thr0.parseLocalUnitFloat(a.find("input").addBack("input").val(),a.data("unit"))},change:function(a){if(void 0===a.value){var b=$(a.currentTarget),c=this.getValue(b);thr0.breakEvent(a);
this.fill(b,thrUI.triggerChange(b,"numberInput",c)?c:b.data("value"))}}},numberFormatSelection:{create:function(a){thrUI.createControl(a,"numberFormatSelection","thrNumberFormatSelection",["change"],_h.inp({placeholder:ph})+_h.tag("ul","thrAutoDropdown")).addClass("thrCollapsed").find("input").change(function(a){thr0.breakEvent(a)}).blur(function(a){thrUI.autoComplete.blur(a)})}},autoComplete:{create:function(a){var b=a.data("placeholder");thrUI.createControl(a,"autoComplete","thrAutoComplete",["click",
"keydown","input"],_h.inp({placeholder:b})+_h.tag("ul","thrAutoDropdown")).addClass("thrCollapsed").find("input").change(function(a){thr0.breakEvent(a)}).blur(function(a){thrUI.autoComplete.blur(a)});thrUI.setActionMaker(a,function(a){return $(a.target).parent().hasClass("thrAutoDropdown")});this.fill(a)},fill:function(a,b){b=b||"";a.data("sav",b).find("input").val(b).select()},getValue:function(a){return a.find("input").val()},blur:function(a){a=$(a.target).closest(".thrAutoComplete");a.addClass("thrCollapsed").find("input").val(a.data("sav"))},
getOptions:function(a){var b=eval,c=a.data("ongetoptions");return c?b(c):a.data("options").split(",")},refreshDD:function(a,b){var c=this.getOptions(a),d=[];if(b&&b.length&&c){var e=[];c.forEach(function(a){var b=a.toLowerCase().indexOf(this);0===b?d.push(a):0<b&&e.push(a)},b.toLowerCase());d=d.concat(e)}else c&&(d=c);d.length?(a.find(".thrAutoDropdown").empty().append(d.map(function(a,b){return _h.tag("li",a,b?void 0:"thrSelected")}).join("")),a.removeClass("thrCollapsed")):a.addClass("thrCollapsed")},
input:function(a){var b=$(a.currentTarget);(a=$(a.target).val())&&a.length?this.refreshDD(b,a):b.addClass("thrCollapsed")},keydown:function(a){var b=a.keyCode||a.which,c=$(a.currentTarget);0<=[13,27,38,40].indexOf(b)&&(27===b?(c.find("input").val(c.data("sav")),c.addClass("thrCollapsed")):13===b?this.accept(c):c.hasClass("thrCollapsed")?40===b&&this.refreshDD(c):thrUI.changeSelection(c,0,38===b),thr0.breakEvent(a))},click:function(a){var b=$(a.currentTarget),c=$(a.target);c.parent().hasClass("thrAutoDropdown")&&
(thrUI.changeSelection(b,c,0,!0),this.accept(b),b.find("input").focus().select(),thr0.breakEvent(a))},accept:function(a){if(!a.hasClass("thrCollapsed")){var b=thrUI.getSelected(a,"text");b&&(this.fill(a,b),thrUI.triggerChange(a.addClass("thrCollapsed"),"autoComplete",b))}}},counter:{create:function(a){var b=0,c=thrUI.listdata(a,"values"),d=a.data("value")||b;c.length&&(b=c.indexOf(d),0>b&&(b=$.isNumeric(d)&&0<=d&&d<c.length?d:0,d=c[b]),a.removeData("value").data("valix",b));thrUI.createControl(a,
"counter","thrCounter",["click"],_h.span("","thrDown")+_h.span(d,"thrValue")+_h.span("","thrUp"),!0)},setVal:function(a,b,c){void 0!==c?a.data("valix",c):a.data("value",b);a.find(".thrValue").html(b)},getValIx:function(a){a=a.data("valix");return void 0===a?-1:a},indexOf:function(a,b){return thrUI.listdata(a,"values").indexOf(b)},getValue:function(a){var b=thrUI.listdata(a,"values");return b.length?b[this.getValIx(a)]:a.data("value")},fill:function(a,b){var c=thrUI.listdata(a,"values");c.length?0<=
b&&b<c.length&&this.setVal(a,c[b],b):this.setVal(a,b)},click:function(a){var b=$(a.currentTarget);a=$(a.target);var c=a.hasClass("thrDown")?-1:a.hasClass("thrUp")?1:0;c&&(a=thrUI.listdata(b,"values"),a.length?(c=this.getValIx(b)+c,b.data("infinite")&&(c=(c+a.length)%a.length),0<=c&&c<a.length&&thrUI.triggerChange(b,"counter",a[c])&&this.setVal(b,a[c],c)):(a=b.data("value")+c,thrUI.triggerChange(b,"counter",a)&&this.setVal(b,a)));thrUI.clearSelection()}},checkbox:{create:function(a){var b="thrCtrl"+
thrUI.getNewCtrlId(),c=a.html(),d=a.data("ntx");d&&(a.removeData("ntx"),a.length&&(a[0].dataset&&a[0].dataset.hasOwnProperty("ntx"))&&delete a[0].dataset.ntx);thrUI.createControl(a,"checkbox","thrCheckbox",["change","keypress"],(c?_h.tag("label",c,{"for":b,"data-ntx":d}):"")+_h.inp({type:"checkbox",id:b})+_h.tag("label","",{"for":b}),!0);a.data("value")&&this.fill(a,!0)},fill:function(a,b){a.find("input").prop("checked",b)},getValue:function(a){return a.find("input").prop("checked")},keypress:function(a){if(0<=
[13,32].indexOf(a.keyCode||a.which)){var b=$(a.currentTarget),c=this.getValue(b);thr0.breakEvent(a);this.fill(b,!c);thrUI.triggerChange(b,"checkbox")||this.fill(b,c)}},change:function(a){if(a.target!==a.currentTarget){var b=$(a.currentTarget);a.stopPropagation();thrUI.triggerChange(b,"checkbox")||this.fill(b,!this.getValue(b))}}},optionGroup:{create:function(a){var b=thrUI.listdata(a,"options"),c=a.data("value");thrUI.createControl(a,"optionGroup","thrOptionGroup",["change"]);this.setOptions(a,b,
c,!0);void 0!==c&&a.removeData("value")},getValue:function(a){return thrUI.getSelected(a,"index",-1)},fill:function(a,b){a.find(".thrSelected").removeClass("thrSelected");"number"===typeof b&&0<=b&&a.find("\x3e*:nth-child("+(b+1)+")").addClass("thrSelected")},setOptions:function(a,b,c,d){var e=a.data("iconixs");void 0===c&&(c=this.getValue(a));if(e){e=e.split(",");d=0;for(var f=Math.max(b?b.length:0,e.length);d<f;d++)thrUI.createControl($(_h.div("",b?{title:b[d]}:void 0)).appendTo(a),"optionButton",
"thrIconButton",["click"],_h.icon(e[d]),!0)}else a.empty().append(b.map(function(a){return _h.span(a)}).join("")),d&&a.click(function(a){thrUI.optionGroup.txOptClick(a)});void 0!==c&&-1<c&&this.fill(a,c)},change:function(a){var b=$(a.currentTarget),c=$(a.target),d=c.index();"optionButton"===c.data("control")&&(thr0.breakEvent(a),thrUI.triggerChange(b,"optionGroup",d)&&this.fill(b,d))},txOptClick:function(a){var b=$(a.currentTarget),c=$(a.target).index();thr0.breakEvent(a);thrUI.triggerChange(b,"optionGroup",
c)&&this.fill(b,c)}},optionButton:{create:function(a){var b=a.data("value");thrUI.createControl(a,"optionButton",a.find("\x3e.thrIcon")?"thrIconButton":"thrButton",["click"],void 0,!0);b&&"false"!==b&&this.fill(!0)},fill:function(a,b){b?a.addClass("thrSelected"):a.removeClass("thrSelected")},getValue:function(a){return a.hasClass("thrSelected")},click:function(a){var b=$(a.currentTarget),c=!this.getValue(b);thr0.breakEvent(a);thrUI.triggerChange(b,"optionButton",c)&&this.fill(b,c)}},"switch":{create:function(a){var b=
a.data("value");thrUI.createControl(a,"switch","thrSwitch",["click"]);b&&void 0!==b&&this.fill(a,b)},fill:function(a,b){!b===!a.data("inverse")?a.removeClass("thrOn"):a.addClass("thrOn")},getValue:function(a){return a.hasClass("thrOn")===!a.data("inverse")},click:function(a){var b=$(a.currentTarget),c=!this.getValue(b);thr0.breakEvent(a);thrUI.triggerChange(b,"optionButton",c)&&this.fill(b,c)}},dropdownButton:{create:function(a){var b=a.data("control"),c=a.data("iconix"),c=void 0!==c?{"class":"thrIcon",
style:"background-position:"+-24*parseInt(c,10)+"px 0'"}:void 0;thrUI.createControl(a,"dropdownButton","thrDropdownButton",["click","keydown"],_h.div("",c),!0);a.addClass("thrCollapsed");b&&a.data("control",b);return a},ihtml:function(a){return _h.div(a.bn,{"class":"thrDropdownButton",onclick:"thrUI.dropdownButton.toggleDropdown($(this).parent()); event.stopPropagation();"})+_h.div(a.dd,"thrDropdown")},fill:function(a,b){a.data("value",b)},createLazySub:function(a,b){var c=a.data("dd-xoffset"),d=
a.data("control");b=b||a.find("\x3e.thrDropdown");b.length||(b=$(_h.div("","thrDropdown")).appendTo(a));d&&("dropdownButton"!==d&&thrUI[d].createLazySub)&&(c&&b.css("left",c),thrUI[d].createLazySub(a,b));return b},click:function(a){var b=$(a.currentTarget);$(a.target).closest(".thrDropdown").is(b.find(".thrDropdown"))||(this.toggleDropdown(b),a.preventDefault());a.stopPropagation()},keydown:function(a){13===(a.keyCode||a.which)&&this.click(a)},toggleDropdown:function(a){var b=a.data("control"),c=
a.find("\x3e.thrDropdown"),d=!a.hasClass("thrCollapsed");thrUI.hideDropdowns();if(!d){if(0>=c.length||c.is(":empty"))c=this.createLazySub(a,c);a.removeClass("thrCollapsed");b&&(a=c.parent().data("value"),void 0!==a&&(d=parseInt(a,10),thrUI[b].fill(c.parent(),isNaN(d)?a:d)))}},getValue:function(a){return parseInt(a.data("value"),10)}},ddFunctions:{create:function(a){thrUI.dropdownButton.create(a)},createLazySub:function(a,b){return b.empty().append(a.data("fnnames").split(",").map(function(a){return _h.div(a)}).join("")).click(function(a){thrUI.ddFunctions.click(a)})},
fill:function(){},click:function(a){var b,c=$(a.currentTarget).parent();void 0===a.func&&(thr0.breakEvent(a),b=c.data("functions").split(","),c.trigger($.Event("change",{func:b[$(a.target).index()]})))},getValue:function(){}},dropdownSelect:{create:function(a){var b=thrUI.listdata(a,"options"),c=a.data("iconixs"),d=a.data("value");thrUI.createControl(a.addClass("thrCollapsed"),"dropdownSelect","thrDropdownSelect",["click","keydown","blur"],_h.div("","thrDropdownValue")+_h.div("","thrDropdown"),!0);
thrUI.setActionMaker(a,function(b){function c(a){this.$el=a;a.addClass("thrInAction")}c.prototype={move:function(){},end:function(){this.$el.removeClass("thrInAction")}};return $(b.target).hasClass("thrDropdown")||$(b.target).parent().hasClass("thrDropdown")?new c(a):!1});if(b||c)this.setOptions(a,b.length?b:void 0,c?c.split(","):void 0);void 0!==d&&this.fill(a,d)},setOptions:function(a,b,c,d){var e=a.find(".thrDropdownValue"),f=a.find("\x3e.thrDropdown").empty(),g=a.data("value");b&&a.data("options",
b.join(","));c?(a.addClass("thrNoText"),a.data("iconixs",c.join(",")),e.find(".thrIcon").length||e.append(_h.icon()),c.forEach(function(a){f.append(_h.div(_h.icon(a)))})):(a.removeClass("thrNoText"),e.find(".thrIcon").remove(),b&&b.forEach(function(a){f.append(_h.div(a))}));d&&a.data("values",d.join(","));"number"===typeof g&&this.fill(a,g)},fill:function(a,b){var c,d;d=a.find(".thrDropdown\x3e*");var e=a.find(".thrDropdownValue"),f=a.data("iconixs");if(c=a.data("values")){var g;c=c.split(",");g=
c.indexOf("number"===typeof b?b.toString():b);if(0<=g||"string"!==typeof b)b=g}"string"===typeof b?this.setText(a,b,!0):(d.filter(".thrSelected").removeClass("thrSelected"),b===thrUI.ntx.multipleValues?c=f?0:b:(d=d.eq(b),1===d.length?(c&&0<=b&&(b=c[b]),d.addClass("thrSelected")[0].scrollIntoView(),c=f?b:d.text(),a.data("value",b)):c=f?0:""),f?e.find(".thrIcon").css("background-position",-24*f.split(",")[c]):e.text(c))},valueOfIx:function(a,b){var c=a.data("values");return 0<=b&&c?(c=c.split(",")[b],
"string"===typeof c&&c.length&&/^[0-9]*$/.test(c)?parseInt(c,10):c):b},getOptionText:function(a,b){return a.find("\x3e.thrDropdown\x3e*:nth-child("+(b+1)+")").text()},getText:function(a){return a.find(".thrDropdownValue").text()},setText:function(a,b,c){var d=b?this.valueOfIx(a,thrUI.indexOfOptionDiv(a,b)):-1;b=0>d?b:d;if(c)return b;this.fill(a,b)},click:function(a){var b=$(a.currentTarget),c=$(a.target),d=c.parent();for(b.toggleClass("thrCollapsed");d.length&&!d.hasClass("thrDropdown")&&!d.hasClass("thrDropdownSelect");)c=
d,d=c.parent();d.hasClass("thrDropdown")&&this.accept(b,this.valueOfIx(b,c.index()));thr0.breakEvent(a)},keydown:function(a){var b=a.keyCode||a.which;a=$(a.currentTarget);if(27===b)a.addClass("thrCollapsed");else if(13===b)this.accept(a);else if(38===b&&0<d.length||40===b){var c=a.find("\x3e.thrDropdown\x3e*"),d=c.find(".thrSelected");d.removeClass("thrSelected");40===b&&a.hasClass("thrCollapsed")?(a.removeClass("thrCollapsed"),b=this.getValue(a),"number"!==typeof b&&(b=a.data("values").split(",").indexOf(b))):
b=c.index(d)+(40===b?1:-1);b=Math.min(c.length-1,Math.max(0,b));$(c[b]).addClass("thrSelected");c[b].scrollIntoView()}else thrUI.cacheOptionsKey(a,b,"dropdownSelect")},getValue:function(a){return a.data("values")?a.data("value"):parseInt(a.data("value"),10)},blur:function(a){a=$(a.currentTarget);!a.hasClass("thrCollapsed")&&!a.hasClass("thrInAction")&&this.accept(a)},accept:function(a,b){void 0===b&&(b=this.valueOfIx(a,a.find(".thrSelected").index()));if(0<=b||"string"===typeof b)b!==this.getValue(a)&&
thrUI.triggerChange(a,"dropdownSelect",b)&&this.fill(a,b),a.addClass("thrCollapsed")}},listbox:{create:function(a){var b=thrUI.listdata(a,"options");thrUI.createControl(a.empty(),"listbox","thrListbox",["click","keydown","blur"],void 0,!0);b.length&&this.setOptions(a,b)},setOptions:function(a,b,c){a.empty().data("options",b.join(",")).append(b.map(function(a,b){return _h.div((c?_h.div("",c[b]):"")+a)}).join(""))},refreshOptions:function(a){a.data("options").split(",").forEach(function(b,c){a.find("nth-child("+
(c+1)+")").text(b)})},fill:function(a,b){var c=a.children();b===thrUI.ntx.multipleValues?this.setText(a,b):0<=b&&b<c.length&&(thrUI.changeSelection(a,c.eq(b),0,!0),a.data("value",b))},setText:function(a,b){this.fill(a,thrUI.indexOfOptionDiv(a,b))},click:function(a){var b=$(a.target);b.parent().hasClass("thrListbox")&&this.accept($(a.currentTarget),b.index())},keydown:function(a){var b=a.keyCode||a.which;a=$(a.currentTarget);27===b?(b=a.data("value"),void 0!==b&&this.fill(a,parseInt(b,10))):13===b?
this.accept(a):38===b||40===b?thrUI.changeSelection(a,0,38===b,!0):thrUI.cacheOptionsKey(a,b,"listbox")},getValue:function(a){return parseInt(a.data("value"),10)},blur:function(a){this.accept($(a.currentTarget))},accept:function(a,b){void 0===b&&(b=a.find(".thrSelected").index());0<=b&&(b!==this.getValue(a)&&thrUI.triggerChange(a,"listbox",b))&&this.fill(a,b)}},orderbox:{create:function(a){thrUI.createControl(a,"orderbox","thrOrderbox",["keydown"],void 0,!0,a);a.after(_h.tag("p",thrUI.ntx.orderboxHint))},
fill:function(a,b){"string"===typeof b&&(b=b.split(","));if($.isArray(b)){var c=a.children().map(function(){var a=$(this);return{$l:a,v:a.data("value")}});b.reverse();b.forEach(function(b){(b=thr0.removeKeyFromArray(c,"v",b))&&a.prepend(b.$l)})}},getLine:function(a){if(!a.hasClass("thrOrderbox")){for(var b=a.parent();!b.hasClass("thrOrderbox");)a=b,b=b.parent();return a}},makeAction:function(a){function b(a){this.$ob=a.parent();this.$l=a;this.ix=a.index()}b.prototype={move:function(a){a=$(a.target);
(a=a.closest(".thrOrderbox").is(this.$ob)?thrUI.orderbox.getLine(a):void 0)&&(this.$l.index()>a.index()?this.$l.insertBefore(a):this.$l.insertAfter(a))},end:function(a,b){b&&(this.ix?this.$l.index()!==this.ix&&this.$el.insertBefore(this.$ob.children().get(this.ix)):this.$ob.prepend(this.$l));thrUI.triggerChange(this.$ob,"orderbox")}};if(a=this.getLine($(a.target)))return thrUI.changeSelection(a.parent(),a,0,!0),new b(a)},keydown:function(a){var b=a.keyCode||a.which;a=$(a.currentTarget);var c=a.find(".thrSelected"),
d=39===b||40===b?c.next():c.prev();if(d.length)if(37===b||39===b)thrUI.changeSelection(a,d,0,!0);else if(38===b||40===b)38===b?c.insertBefore(d):c.insertAfter(d),thrUI.triggerChange(a,"orderbox")},getValue:function(a){return a.children().map(function(){return $(this).data("value")}).get()}},popupSlider:{svgContent:"\x3cdefs\x3e\x3clinearGradient id\x3d'active' x1\x3d'0%' y1\x3d'0%' x2\x3d'0%' y2\x3d'100%'\x3e\x3cstop offset\x3d'0%' style\x3d'stop-color:#f0ff80;stop-opacity:1' /\x3e\x3cstop offset\x3d'100%' style\x3d'stop-color:#c7e105;stop-opacity:1' /\x3e\x3c/linearGradient\x3e\x3c/defs\x3e\x3cpath class\x3d'thrSliderBar' d\x3d'm 19,38 0,204 10,0 0,-204 z'/\x3e\x3cpath class\x3d'thrSliderPlus' d\x3d'm 24,10 -10,20 20,0 z'/\x3e\x3cpath class\x3d'thrSliderMinus' d\x3d'm 24,270 10,-20 -20,0 z'/\x3e\x3crect class\x3d'thrSliderIndicator' x\x3d'22' y\x3d'140' width\x3d'4' height\x3d'100'/\x3e\x3ccircle class\x3d'thrSliderHandle' cx\x3d'24' cy\x3d'140' r\x3d'8' style\x3d'fill: url(#active);'/\x3e",
create:function(a){var b=a.data("value"),c=a.data("unit"),d=a.data("unitleft");thrUI.createControl(a,"popupSlider","thrPopupSlider",["change"],(d?_h.span(c,"thrUnit"):"")+_h.inp({value:b})+_h.icon(76,"touch-action: none;"));d||thrUI.setUnit(a,a.data("unit"));thrUI.setActionMaker(a.find(".thrIcon"),function(a){return thrUI.popupSlider.makeAction(a)})},fill:function(a,b){var c=thrUI.numberConstraints(a),c=thr0.intoRange(b,c.min,c.max);a.data("value",c).find("input").val(c)},makeAction:function(a){function b(a){var b,
e=$(a.target).closest(".thrPopupSlider"),f=a.target.getBoundingClientRect();this.$el=e;this.$svg=$(thrSvg.svgHtml(48,280,0,!0,void 0,thrUI.popupSlider.svgContent)).appendTo(e).css({top:0,left:0});this.yOffset=40;this.height=200;this.changed=!1;this.nc=thrUI.numberConstraints(e);this.startY=a.clientY;this.startVal=thrUI.popupSlider.getValue(e);this.visMin=thr0.roundToStep(this.startVal-this.nc.range/2,this.nc.step);this.visMax=thr0.roundToStep(this.visMin+this.nc.range,this.nc.step);this.visMin<this.nc.min&&
(this.visMax+=this.nc.min-this.visMin,this.visMin=this.nc.min);this.visMax>this.nc.max&&(this.visMin=Math.max(this.nc.min,this.visMin-(this.visMax-this.nc.max)));a=this.setValue(this.startVal,!0);b=this.$svg[0].getBoundingClientRect();this.$svg.css({top:f.top-b.top+f.height/2-a,left:f.left-b.left+(f.width-b.width)/2});this.ctmInv=this.$svg[0].getScreenCTM().inverse();this.$inp=e.find("input")}b.prototype={setValue:function(a,b){var e=this.yOffset+(this.visMax-a)*this.height/(this.visMax-this.visMin);
this.$svg.find(".thrSliderHandle").attr("cy",e);this.$svg.find(".thrSliderIndicator").attr({y:e,height:this.yOffset+this.height-e});b||this.$inp.val(this.nc.decimals?a.toFixed(this.nc.decimals):a);return e},checkMoveRangeDelta:function(){var a=this.moveRangeDelta,b=this;this.moveRangeDelta=a=0<a?Math.min(a,this.nc.max-this.visMax):Math.max(a,this.nc.min-this.visMin);this.moveRangeTimer?a||this.clearMoveRangeTimer():a&&(this.$svg.find(0<a?".thrSliderPlus":".thrSliderMinus").css("fill","url(#active)"),
this.moveRangeTimer=setInterval(function(){b.moveRange()},100))},clearMoveRangeTimer:function(){this.moveRangeTimer&&(clearInterval(this.moveRangeTimer),this.moveRangeTimer=void 0,this.$svg.find(".thrSliderPlus, .thrSliderMinus").css("fill",""))},moveRange:function(){var a=this.moveRangeDelta;this.visMin+=a;this.visMax+=a;this.setValue(0>=a?this.visMin:this.visMax);this.checkMoveRangeDelta()},move:function(a){var b=thrSvg.pointFromEvent(a,this.$svg[0],this.ctmInv).y-this.yOffset,e=this.visMax-this.visMin;
if(!this.changed){if(5>=Math.abs(a.clientY-this.startY))return;this.changed=!0}0<=b&&b<=this.height?(this.moveRangeTimer&&this.clearMoveRangeTimer(),a=thr0.roundToStep(this.visMin+e*(this.height-b)/this.height,this.nc.step),this.setValue(a)):(this.setValue(0>=b?this.visMax:this.visMin),this.moveRangeDelta=thr0.roundToStep((0>=b?-b:this.height-b)*e/this.height,this.nc.step),this.checkMoveRangeDelta())},end:function(a,b){b?(this.clearMoveRangeTimer(),this.changed&&this.$inp.val(this.startVal)):(this.move(a),
this.clearMoveRangeTimer(),this.changed&&(thrUI.triggerChange(this.$el,"popupSlider",this.val)||this.$inp.val(this.startVal)));this.$svg.remove()}};return new b(a)},change:function(a){var b=$(a.currentTarget);a.target!==a.currentTarget&&(a.stopPropagation(),thrUI.doChange(b,"popupSlider",this.getValue(b)))},getValue:function(a){return parseInt(a.find("input").val(),10)}},datePicker:{create:function(a){var b=a.data("value"),c=b?new Date(b):new Date,d=_h.tag("div",thrUI.ihtml("counter",{"class":"thrMonth",
values:thr0.ntx.months,value:c.getMonth(),"data-infinite":!0})+thrUI.ihtml("counter",{"class":"thrYear",value:c.getFullYear()}),"thrMonthYear")+this.tableHtml(c,c);b||a.data("value",c.toString());thrUI.createControl(a,"datePicker","thrDatePicker",["click"],d,!0).find(".thrMonthYear").change(function(a){thrUI.datePicker.changeMY(a)});thrUI.initControls(a)},tableHtml:function(a,b){var c,d=[],e=a.getFullYear(),f=a.getMonth();a.getDate();var g=new Date(e,f,1),h=(new Date(b.getFullYear(),b.getMonth(),
b.getDate())).getTime();c=g.getDay();var e=new Date(e+(11===f?1:0),(f+1)%12,0),i=thr0.ntx.days.map(function(a){return a.substring(0,2)});i.push(i.shift());i.unshift("");g.setDate(g.getDate()-(c?c-1:6));for(c=thr0.weekNo(g);g<=e;c++){for(var j=[c.toString()],k=0;7>k;k++){var l=g.getDate();g.getMonth();var m=[];g.getTime()===h&&m.push("thrSelected");g.getMonth()!==f&&m.push(g<a?"thrPrevMonth":"thrNextMonth");j.push(m.length?[l.toString(),m.join(" ")]:l.toString());g.setDate(l+1)}d.push(j)}return _h.table(i,
d)},refreshTable:function(a,b,c){a.find("\x3etable").remove();a.append(this.tableHtml(b,c))},fill:function(a,b){a.data("value",b.toString());this.refreshTable(a,b,b);[0,1].forEach(function(c){thrUI.counter.fill(this.counter(a,c),c?b.getMonth():b.getFullYear())},this)},getValue:function(a){return new Date(a.data("value"))},counter:function(a,b){return a.find("\x3e.thrMonthYear\x3e."+(b?"thrMonth":"thrYear"))},visibleYear:function(a){return thrUI.counter.getValue(this.counter(a,!1))},visibleMonth:function(a){return thrUI.counter.getValIx(this.counter(a,
!0))},click:function(a){var b=$(a.target);if(b.is("td")&&b.index()){var c=$(a.currentTarget),d=b.hasClass("thrPrevMonth")?-1:b.hasClass("thrNextMonth")?1:0,e=new Date(this.visibleYear(c),this.visibleMonth(c)+d,parseInt(b.text()));thrUI.triggerChange(c,"counter",e)&&(d?this.fill(c,e):(c.data("value",e.toString()),thrUI.changeSelection(c.find("\x3etable\x3etbody"),b,!1,!0)))}a.stopPropagation()},changeMY:function(a){var b=$(a.target),c=b.closest(".thrDatePicker"),d=this.visibleMonth(c),e=b.hasClass("thrYear")?
a.value:this.visibleYear(c);b.hasClass("thrMonth")&&(b=thrUI.counter.indexOf(b,a.value),1<Math.abs(b-d)&&(e+=b<d?1:-1,thrUI.counter.fill(this.counter(c,!1),e)),d=b);this.refreshTable(c,new Date(e,d,1),new Date(c.data("value")));a.stopPropagation()}},tabpanel:{ihtml:function(a){function b(a){return _h.div("object"===typeof a?thrUI[a.ctrl].ihtml(a.data):a)}var c=a.content?a.content.map(b):a.tabs.map(function(){return _h.div()});return _h.div(_h.tag("ul",a.tabs.map(function(a){return _h.tag("li",a)}).join(""))+
_h.div(c.join("")),_h.basicIAttrs("tabpanel"))},create:function(a){var b=a.find("\x3eul\x3e.thrActive");thrUI.createControl(a,"tabpanel","thrTabpanel",[]);this.activateTab(1===b.length?b:a.find("\x3eul\x3eli:first-child"),a.data("quietcreate"));thrUI.setActionMaker(a.find("\x3eul"),function(a){a=$(a.target);a.is("ul")||(thr0.notifyActivity(),thrUI.tabpanel.activateTab(a.closest("li")))})},createLazyTab:function(a,b){var c=a.find("\x3ediv"),d=c.data("iconix");a.data("lazySub",b);void 0!==d&&c.addClass("thrIcon").css("background-position",
-24*parseInt(d,10)+"px 0")},tabCount:function(a){return a.find("\x3eul\x3eli").length},activateTab:function(a,b){var c,d=a.parent().parent(),e=a.data("lazySub");d.find("\x3eul\x3eli").removeClass("thrActive");a.addClass("thrActive");d.find("\x3ediv\x3ediv").addClass("thrNoDisplay");c=this.tabToPanel(d,a).removeClass("thrNoDisplay");if(e&&c.is(":empty")){var f=a.find("\x3e*:first-child");thrUI[e].createLazySub(f,c);c=f.data("value");void 0!==c&&thrUI[e].fill(f,c)}!b&&d.data("triggerchange")&&thrUI.triggerChange(d,
"tabpanel",a.index())},activateTabNo:function(a,b,c){this.activateTab(a.find("\x3eul\x3eli:nth-child("+(b+1)+")"),c)},tabToPanel:function(a,b){return a.find("\x3ediv\x3ediv:nth-child("+(b.index()+1)+")")},getValue:function(a){a=a.find("\x3eul\x3e.thrActive");return 1===a.length?a.index():-1}}};thrNtx.register(thrUI);thr0.addNotifier(thrUI);$(document).ready(function(){thrUI.init()});o.ThrColor=function(a){"number"===typeof a?(this.n=-1,this.rgb=a):this.setAsString(a)};ThrColor.prototype={rgb:0,opacity:100,
n:0,mode:0,setAsString:function(a){var b=a.match(/^thr\(([0-9]+),?\s?([0-9]+)?,?\s?([0-9]+,*)?\)$/i);if(b)b[1]&&(this.n=parseInt(b[1],10)),b[2]&&(this.mode=parseInt(b[2],10)),b[3]&&(this.opacity=parseInt(b[3],10));else if(b=a.match(/^rgba\(([0-9]+),([0-9]+),([0-9]+),([0-9\.]+)\)$/i))this.n=-1,this.rgb=(parseInt(b[1],10)<<16)+(parseInt(b[2],10)<<8)+parseInt(b[3],10),this.opacity=Math.round(100*parseFloat(b[4]));else if("#"===a.charAt(0)){if(4===a.length){var b=a.charAt(1),c=a.charAt(2);a=a.charAt(3);
a="#"+b+b+c+c+a+a}this.n=-1;this.rgb=parseInt(a.slice(1),16)}},toColorString:function(){return 0<=this.n&&0<=this.mode?"thr("+this.n+(0!==this.mode||100>this.opacity?","+this.mode+(100>this.opacity?","+this.opacity:""):"")+")":thrColors.rgbToColorString(this.rgb,this.opacity)},modifiedCssColor:function(a){var b=this.toRgb(),c=this.opacity;a.hasOwnProperty("dl")||a.hasOwnProperty("ds")||a.hasOwnProperty("dh")||a.hasOwnProperty("da")?(b=thrColors.rgbToHsl(b),c=a.da?thr0.intoRange(c+a.da,0,100):c,b=
thrColors.hslToRgb([a.dh?(100*b[0]+a.dh)%100/100:b[0],a.ds?thr0.intoRange(100*b[1]+a.ds,0,100)/100:b[1],a.dl?thr0.intoRange(100*b[2]+a.dl,0,100)/100:b[2]])):a.hasOwnProperty("rgb")&&(b=a.rgb);return thrColors.rgbToColorString(b,c)},toRgb:function(){return 0<=this.n&&0<=this.mode?thrColors.modifyRgb(thrColors.activePal[this.n],this.mode):this.rgb},toCssColor:function(a){return thrColors.rgbToColorString(this.toRgb(),a?this.opacity:100)},toSvgCss:function(a,b){var c={};c[a]=this.toCssColor();b&&100>
this.opacity&&(c[a+"-opacity"]=this.opacity/100);return c}};o.thrColors={ntx:{swapColors:"swap",opacity:"Opacity",style:"Style",width:"Width",size:"Size",angle:"Angle",bold:"Bold",italic:"Italic",underline:"Underline",font:"Font",gradient:"Gradient",direction:"Direction",colors:"Colors",selColor:"Select a color",preview:"Preview",lineOpts:["no line","solid","dashed","dotted","dash-dot"],textAlignOpts:["left","center","right"],textVAlignOpts:["top","middle","bottom"],textPosOpts:"text hidden;text inside;text left;text above;text right;text below;custom".split(";"),
textAngleOpts:["normal","90\u00b0 - top to bottom","180\u00b0 - rotated","270\u00b0 - bottom to top"]},palettes:[[12699040,11124484,15903949,10898293,9591487,11859954,5480699,15588749,11303985,8011780],[16093819,16444610,12903885,12114391,14268603,11217678,13475346,4297560,4620928,8537676],[15063781,7761830,15917486,14261142,12528183,14869978,10912879,11465202,9886124,2801475],[5022681,19878,14674423,6591520,16172617,14240935,10878976,16244720,9730336,16183625],[6738268,13238141,16776061,16763519,
15890444,13720720,16743927,13467135,10125311,3607794],[9961472,16711680,16750848,16776960,65280,65535,4884200,255,10027263,16711935],[16773184,16751162,16723E3,6806015,6789631,16772517,16761759,16750504,11662847,11654399],[5096378,303519,13100505,10418091,380784,12823373,10587396,15062727,16228510,13589253],[16248009,15063480,13092526,9016977,7109242,13227255,12109029,11448263,9865614,8023148],[10992014,9682329,6986885,15790781,12551004,12166542,12433555,10257258,15919037,8818837],[13158,3885642,
422705,6889499,5386352,3014758,3882058,413299,6842651,7352401],[9187877,3881785,7039849,9078886,14397291,9204005,2379344,5396610,6718346,14403179],[3423034,7235926,8881271,4734280,6981507,5456413,8155464,11706188,5974619,8874617],[75588,1398628,5801601,9215112,15915950,3211288,5913649,8617032,11449952,15068857],[468288,1332364,2520486,5284031,7981017,1785664,4363929,5554115,6545893,7273215],[3424263,7834644,10004006,12566096,14274425,1785893,4364633,5555057,6546821,7274388],[4200967,9190932,10902566,
12553296,14268025,4201255,10043999,12801145,15033230,16739998]],gradientTypes:[[{x1:"0",y1:"0",x2:"1",y2:"1"},{x1:"0",y1:"0",x2:"0",y2:"1"},{x1:"1",y1:"0",x2:"0",y2:"1"},{x1:"1",y1:"0",x2:"0",y2:"0"},{x1:"1",y1:"1",x2:"0",y2:"0"},{x1:"0",y1:"1",x2:"0",y2:"0"},{x1:"0",y1:"1",x2:"1",y2:"0"},{x1:"0",y1:"0",x2:"1",y2:"0"}],[{cx:"0.4",cy:"0.4",fx:"0",fy:"0",r:"1"},{cx:"0.5",cy:"0.4",fx:"0.5",fy:"0",r:"1"},{cx:"0.6",cy:"0.4",fx:"1",fy:"0",r:"1"},{cx:"0.6",cy:"0.5",fx:"1",fy:"0.5",r:"1"},{cx:"0.6",cy:"0.6",
fx:"1",fy:"1",r:"1"},{cx:"0.5",cy:"0.6",fx:"0.5",fy:"1",r:"1"},{cx:"0.4",cy:"0.6",fx:"0",fy:"1",r:"1"},{cx:"0.4",cy:"0.5",fx:"0",fy:"0.5",r:"1"},{cx:"0.5",cy:"0.5",fx:"0.5",fy:"0.5",r:"1"}],[{cx:"0.4",cy:"0.4",fx:"0.2",fy:"0.2",r:"1"},{cx:"0.5",cy:"0.4",fx:"0.5",fy:"0.2",r:"1"},{cx:"0.6",cy:"0.4",fx:"0.8",fy:"0.2",r:"1"},{cx:"0.6",cy:"0.5",fx:"0.8",fy:"0.5",r:"1"},{cx:"0.6",cy:"0.6",fx:"0.8",fy:"0.8",r:"1"},{cx:"0.5",cy:"0.6",fx:"0.5",fy:"0.8",r:"1"},{cx:"0.4",cy:"0.6",fx:"0.2",fy:"0.8",r:"1"},{cx:"0.4",
cy:"0.5",fx:"0.2",fy:"0.5",r:"1"},{cx:"0.5",cy:"0.5",fx:"0.5",fy:"0.5",r:"0.7"}]],gradientColors:[[[{o:0,dl:10},{o:100}],[{o:0,dl:20},{o:100}],[{o:0,dl:30},{o:100}],[{o:0,dl:40},{o:100}],[{o:0,dl:50},{o:100}],[{o:0,dl:60},{o:100}],[{o:0,dl:70},{o:100}],[{o:0,dl:80},{o:100}],[{o:0,dl:90},{o:100}]],[[{o:0,dl:-10},{o:100}],[{o:0,dl:-20},{o:100}],[{o:0,dl:-30},{o:100}],[{o:0,dl:-40},{o:100}],[{o:0,dl:-50},{o:100}],[{o:0,dl:-60},{o:100}],[{o:0,dl:-70},{o:100}],[{o:0,dl:-80},{o:100}],[{o:0,dl:-90},{o:100}]],
[[{o:0,ds:-100},{o:100}],[{o:0,ds:-80},{o:100}],[{o:0,ds:-60},{o:100}],[{o:0,ds:-40},{o:100}],[{o:0,ds:-20},{o:100}],[{o:0,ds:25},{o:100}],[{o:0,ds:50},{o:100}],[{o:0,ds:75},{o:100}],[{o:0,ds:100},{o:100}]],[[{o:0,dl:20,ds:100,dh:80},{o:100}],[{o:0,dl:20,ds:100,dh:85},{o:100}],[{o:0,dl:20,ds:100,dh:90},{o:100}],[{o:0,dl:20,ds:100,dh:95},{o:100}],[{o:0,dl:20,ds:100},{o:100}],[{o:0,dl:20,ds:100,dh:5},{o:100}],[{o:0,dl:20,ds:100,dh:10},{o:100}],[{o:0,dl:20,ds:100,dh:15},{o:100}],[{o:0,dl:20,ds:100,dh:20},
{o:100}]],[[{o:0},{o:100,rgb:16711680}],[{o:0},{o:100,rgb:16750848}],[{o:0},{o:100,rgb:13434624}],[{o:0},{o:100,rgb:3407616}],[{o:0},{o:100,rgb:65382}],[{o:0},{o:100,rgb:65535}],[{o:0},{o:100,rgb:26367}],[{o:0},{o:100,rgb:3342591}],[{o:0},{o:100,rgb:13369599}]],[[{o:0},{o:50,rgb:16777215},{o:100,rgb:16711680}],[{o:0},{o:50,rgb:16777215},{o:100,rgb:16750848}],[{o:0},{o:50,rgb:16777215},{o:100,rgb:13434624}],[{o:0},{o:50,rgb:16777215},{o:100,rgb:3407616}],[{o:0},{o:50,rgb:16777215},{o:100,rgb:65382}],
[{o:0},{o:50,rgb:16777215},{o:100,rgb:65535}],[{o:0},{o:50,rgb:16777215},{o:100,rgb:26367}],[{o:0},{o:50,rgb:16777215},{o:100,rgb:3342591}],[{o:0},{o:50,rgb:16777215},{o:100,rgb:13369599}]],[[{o:0},{o:50,dl:10},{o:100}],[{o:0},{o:50,dl:20},{o:100}],[{o:0},{o:50,dl:30},{o:100}],[{o:0},{o:50,dl:40},{o:100}],[{o:0},{o:50,dl:50},{o:100}],[{o:0},{o:50,dl:60},{o:100}],[{o:0},{o:50,dl:70},{o:100}],[{o:0},{o:50,dl:80},{o:100}],[{o:0},{o:50,dl:90},{o:100}]]],stdGradient:{cx:"0.4",cy:"0.4",fx:"0",fy:"0",r:"1",
stops:[{o:0,dl:20},{o:100}]},getPalette:function(a,b){var c=this.palettes[a];return b?1===b?c.slice(5).concat(c.slice(0,5)):2===b?c.slice(0,5).reverse().concat(c.slice(5).reverse()):c.slice(5).reverse().concat(c.slice(0,5).reverse()):c},setActivePalette:function(a,b){this.activePal=this.getPalette(a,b)},indexOfGradient:function(a,b){return thr0.findIndexInArray(a,function(a){return thr0.equalObjects(a,this)},b)},activeGradients:function(){return this.actGradients||[this.stdGradient]},setActiveGradients:function(a){this.actGradients=
a},getActiveGradient:function(a){var b=this.activeGradients();return 0<=a&&a<b.length?b[a]:void 0},gradientDef:function(a,b,c){function d(a){return a.map(function(a){return"\x3cstop offset\x3d'"+a.o+"%' stop-color\x3d'"+c.modifiedCssColor(a)+"' /\x3e"}).join("")}return a.hasOwnProperty("x1")?"\x3clinearGradient id\x3d'gradient"+b+"' x1\x3d'"+a.x1+"' x2\x3d'"+a.x2+"' y1\x3d'"+a.y1+"' y2\x3d'"+a.y2+"'\x3e"+d(a.stops,c)+"\x3c/linearGradient\x3e":"\x3cradialGradient id\x3d'gradient"+b+"' cx\x3d'"+a.cx+
"' cy\x3d'"+a.cy+"' fx\x3d'"+a.fx+"' fy\x3d'"+a.fy+"' r\x3d'"+a.r+"'\x3e"+d(a.stops,c)+"\x3c/radialGradient\x3e"},gradientSpec:function(a,b){var c,d=$.extend({},a);delete d.stops;c=a.stops.map(function(a){return{tag:"stop",attrs:{offset:a.o+"%","stop-color":b.modifiedCssColor(a)}}});return{tag:a.hasOwnProperty("x1")?"linearGradient":"radialGradient",attrs:d,subs:c}},rgbArray:function(a){return[(a&16711680)>>16,(a&65280)>>8,a&255]},mixRgb:function(a,b,c,d){var e=this.rgbArray(a),f=this.rgbArray(b);
e.unshift((a&4278190080)>>24);f.unshift((a&4278190080)>>24);!c&&!d&&(d=c=1);return e.reduce(function(a,b,e){return(a<<8)+Math.round((b*c+f[e]*d)/(c+d))},0)},hslToRgb:function(a){function b(a,b,c){c=6*(0>c?c+1:1<c?c-1:c);return Math.round(255*(1>c?a+(b-a)*c:3>c?b:4>c?a+(b-a)*(4-c):a))}var c,d,e,f;d=a[0];c=a[1];a=a[2];0===c?d=a=c=Math.round(255*a):(e=0.5>a?a*(1+c):a+c-a*c,f=2*a-e,c=b(f,e,d+1/3),a=b(f,e,d),d=b(f,e,d-1/3));return(c<<16)+(a<<8)+d},colorStringToHsl:function(a){return this.rgbToHsl((new ThrColor(a)).toRgb())},
rgbToHsl:function(a){var b=this.rgbArray(a);a=Math.max.apply(null,b);var c=Math.min.apply(null,b),d=0,e=0,f=(a+c)/510;if(a!==c)var d=b[0],g=b[1],b=b[2],h=a-c,e=0.5<f?h/(510-a-c):h/(a+c),d=d===a?(g-b)/(6*h)+(g<b?1:0):a===g?(b-d+2*h)/(6*h):(d-g+4*h)/(6*h);return[d,e,f]},rgbToColorString:function(a,b){if(void 0!==b&&100>b)return"rgba("+thrColors.rgbArray(a).join(",")+","+Math.round(b)/100+")";var c=a.toString(16);return"#000000".slice(0,7-c.length)+c},isDark:function(a){return 0.6>this.colorStringToHsl(a)[2]},
darkenRgb:function(a,b){var c=this.rgbToHsl(a);c[2]-=c[2]*b/100;return this.hslToRgb(c)},lightenRgb:function(a,b){var c=this.rgbToHsl(a);c[2]+=(1-c[2])*b/100;return this.hslToRgb(c)},modifyRgbLight:function(a,b){var c=this.rgbToHsl(a);c[2]=b;return this.hslToRgb(c)},modifyRgb:function(a,b){var c=this.rgbToHsl(a);0<b&&4>b?c[2]+=(1-c[2])*(4-b)/4:4<=b&&7>b&&(c[2]-=c[2]*(b-3)/4);return this.hslToRgb(c)},contrastBlackWhite:function(a){return 0.5>this.colorStringToHsl(a)[2]?"#fff":"#000"},cssColorFromNumber:function(a,
b){var c=this.palettes[b],c=this.darkenRgb(c[Math.floor(Math.abs(a))%c.length],28).toString(16);return"#000000".slice(0,7-c.length)+c},colorStringToSvgCss:function(a,b,c){return(new ThrColor(a)).toSvgCss(b,!c)},colorStringToCssColor:function(a,b){return(new ThrColor(a)).toCssColor(!b)},getOpacity:function(a){return(new ThrColor(a)).opacity},changeOpacity:function(a,b){var c=new ThrColor(a);c.opacity=b;return c.toColorString()},createLS:function(a,b){a.parent().parent().parent().hasClass("thrTabpanel")?
thrUI.tabpanel.createLazyTab(a.addClass("thrColorIndicator").parent(),b):thrUI.dropdownButton.create(a).find(".thrIcon").addClass("thrColorIndicator")},fillLS:function(a,b,c){var d=a.parent().parent().parent(),d=d.hasClass("thrTabpanel")?thrUI.tabpanel.tabToPanel(d,a.parent()):a.find("\x3e.thrDropdown");a.data("value"+(c?c:""),b);!c||3>c?(c&&(b=a.data("value")),a.find(".thrColorIndicator").addBack(".thrColorIndicator").css("border-bottom-color",(new ThrColor(b)).toCssColor()),0<d.length&&!d.is(":empty")&&
(a=d.find(".thrIx0"),c&&thrUI.colorPicker.refresh(a),thrUI.colorPicker.fill(a,b))):(c=d.find(".thrIx"+c),c.length&&thrUI[c.data("control")].fill(c,b))}};thrNtx.register(thrColors);thrUI.opacityPicker={create:function(a,b,c){thrUI.createControl(a,"opacityPicker","thrOpacityPicker",void 0,_h.table(0,[[[_h.div(_h.div("","thrCaption")+_h.div("","thrSliderHandle")),"thrOpacityBack"],"",[_h.div(),"thrOpacityIndicator"]]]));b&&a.addClass("thrSmall");c&&a.data("prop",c);thrUI.setActionMaker(a.find(".thrOpacityBack\x3ediv"),
function(a){return thrUI.opacityPicker.makeAction(a)});a.find(".thrOpacityIndicator\x3ediv").click(function(a){var b=$(a.target);thrUI.dialog.showHSLPicker(thrColors.ntx.selColor,new ThrColor(thrUI.opacityPicker.getValue(b.closest(".thrOpacityPicker"))),function(a){thrUI.colorPicker.changeColor(b.closest(".thrPicker"),a.color)});thr0.breakEvent(a)})},setCaption:function(a,b){a.find(".thrOpacityBack\x3ediv\x3e.thrCaption").html(thrColors.ntx.opacity+": "+b.opacity+"%").css("color",thrColors.contrastBlackWhite(b.toCssColor(!1)))},
fill:function(a,b){var c,d,e,f=a.find(".thrOpacityBack\x3ediv"),g=f[0].getBoundingClientRect().width;b instanceof ThrColor||(b=new ThrColor(b));0>=g?g=parseInt(a.data("cachedWidth"),10):a.data("cachedWidth",g);c=b.opacity;d=b.toCssColor();b.opacity=0;e=b.toCssColor(!0);b.opacity=c;f.attr({style:"background: linear-gradient(to right, "+d+", "+e+");"}).data("value",b.toColorString()).find(".thrSliderHandle").css("left",Math.round(g*(100-c)/100)-3+"px");this.setCaption(a,b);a.find(".thrOpacityIndicator\x3ediv").css("background-color",
b.toCssColor(!0))},makeAction:function(a){function b(b){this.rect=b.getBoundingClientRect();this.$el=$(b).closest(".thrOpacityPicker");b=thrUI.opacityPicker.getValue(this.$el);this.cl=new ThrColor(b);this.changedCl=new ThrColor(b);this.move(a)}b.prototype={move:function(a){this.changedCl.opacity=Math.max(0,Math.min(100,100-Math.round(100*(a.clientX-this.rect.left)/this.rect.width)));thrUI.opacityPicker.fill(this.$el,this.changedCl)},end:function(a,b){b?thrUI.opacityPicker.fill(this.$el,this.cl):this.cl.opacity!==
this.changedCl.opacity&&(this.move(a),this.$el.trigger($.Event("change",{value:this.changedCl.toColorString(),prop:this.$el.data("prop"),func:"setOpacity"})))}};return new b(a.currentTarget)},getValue:function(a){return a.find(".thrOpacityBack\x3ediv").data("value")}};thrUI.lsLineprops={fieldcount:5,create:function(a){thrColors.createLS(a,"lsLineprops")},createLazySub:function(a,b){var c,d=a.data("value");b.empty().addClass("thrSub").click(thr0.breakEvent).append(_h.table(void 0,[[thrColors.ntx.style,
_h.div("",{"class":"thrIx3","data-control":"optionGroup","data-options":thrColors.ntx.lineOpts.join(","),"data-iconixs":"60,66,67,68,77"})],[thrColors.ntx.width,_h.div("",{"class":"thrIx4 thrSmall","data-control":"popupSlider","data-min":"1","data-max":"20","data-unit":"px"})]],{style:"margin-bottom: 8px;"})+_h.div("",{"class":"thrIx0","data-control":"colorPicker"}));thrUI.createSub(a,b,3,"optionGroup");thrUI.createSub(a,b,4,"popupSlider").find("input").css("width","20px");c=b.find(".thrIx0");thrUI.colorPicker.create(c,
b.is(".thrDropdown"),a.data("prop"));void 0!==d&&thrUI.colorPicker.fill(c,d);return b},fill:function(a,b,c){thrColors.fillLS(a,b,c)},getValue:function(a,b){return 0>=b?a.data("value"):parseInt(a.data("value"+b),10)}};thrUI.lsFillprops={fieldcount:4,create:function(a){thrColors.createLS(a,"lsFillprops")},createLazySub:function(a,b){var c,d=a.data("value");b.empty().addClass("thrSub").click(thr0.breakEvent).append(_h.div("",{"class":"thrIx0","data-control":"colorPicker"})+_h.div(_h.tag("strong",thrColors.ntx.gradient)+
_h.div("",{"class":"thrIx3",style:"width: 100%;"}),{style:"margin: 15px 5px 5px 5px;"}));c=b.find(".thrIx0");thrUI.colorPicker.create(c,b.is(".thrDropdown"),a.data("prop"));void 0!==d&&thrUI.colorPicker.fill(c,d);c=b.find(".thrIx3");thrUI.gradientPicker.create(c.data("prop",a.data("prop3")),d);d=a.data("value3");void 0!==d&&thrUI.gradientPicker.fill(c,d);return b},fill:function(a,b,c){var d=a.parent().parent().parent(),d=(d.hasClass("thrTabpanel")?thrUI.tabpanel.tabToPanel(d,a.parent()):a.find("\x3e.thrDropdown")).find(".thrIx3");
thrColors.fillLS(a,b,c);3>c&&d.length&&thrUI.gradientPicker.setBaseColor(d,a.data("value"))},getValue:function(a){return a.data("value")}};thrUI.lsTextprops={fieldcount:12,create:function(a){thrColors.createLS(a,"lsTextprops")},createLazySub:function(a,b){var c,d=a.data("value");c=a.data("prop11");var e=[{ix:5,t:thrColors.ntx.bold,ico:42},{ix:6,t:thrColors.ntx.italic,ico:43},{ix:7,t:thrColors.ntx.underline,ico:44}],f=[[[_h.div("",{"class":"thrIx8","data-control":"optionGroup","data-options":thrColors.ntx.textAlignOpts.join(","),
"data-iconixs":"50,51,52",style:"float: left;"})+_h.div("",{"class":"thrIx9","data-control":"optionGroup","data-options":thrColors.ntx.textVAlignOpts.join(","),"data-iconixs":"53,54,55",style:"float: right;"}),{colspan:2}]],[thrColors.ntx.size,_h.div("",{"class":"thrIx4"+(250>b.width()?" thrSmall":""),"data-control":"popupSlider","data-min":"6","data-max":"720","data-range":"114","data-unit":"pt"})]];c&&f.splice(1,0,[[_h.div("",{"class":"thrIx11","data-control":"optionGroup","data-options":thrColors.ntx.textPosOpts.join(","),
"data-iconixs":"60,87,62,63,61,64,65"}),{colspan:2}]]);b.empty().addClass("thrSub").click(thr0.breakEvent).append(_h.table(void 0,f)+_h.div("",{"class":"thrIx0","data-control":"colorPicker"})+_h.table(void 0,[[thrColors.ntx.angle,_h.div("",{"class":"thrIx10","data-control":"optionGroup","data-options":thrColors.ntx.textAngleOpts,"data-iconixs":"56,57,58,59"})],[thrColors.ntx.style,e.map(function(a){return _h.div(_h.icon(a.ico),{"class":"thrIx"+a.ix,"data-control":"optionButton",title:a.t})}).join("")],
[thrColors.ntx.font,_h.div("",{"class":"thrIx3",style:"width: 100%","data-control":"listbox","data-options":thr0.fontFamilies.map(function(a){return thr0.unquotedString(a.split(",")[0],"'")}).join(",")})]],{style:"width: 100%;"}));thrUI.createSub(a,b,8,"optionGroup");thrUI.createSub(a,b,9,"optionGroup");c&&thrUI.createSub(a,b,11,"optionGroup");thrUI.createSub(a,b,4,"popupSlider").find("input").css("width","30px");c=b.find(".thrIx0");thrUI.colorPicker.create(c,b.is(".thrDropdown"),a.data("prop"));
void 0!==d&&thrUI.colorPicker.fill(c,d);thrUI.createSub(a,b,10,"optionGroup");thrUI.createSub(a,b,5,"optionButton");thrUI.createSub(a,b,6,"optionButton");thrUI.createSub(a,b,7,"optionButton");thrUI.createSub(a,b,3,"listbox").children().each(function(a){$(this).css("font-family",thr0.fontFamilies[a])});b.find("\x3etable:last-child\x3etbody\x3etr").css("height","30px");b.find(".thrIx3").closest("tr").find("\x3etd:first-child").css("vertical-align","top");return b},fill:function(a,b,c){thrColors.fillLS(a,
b,c)},getValue:function(a,b){var c=a.data("value"+(b?b:""));return 0<b&&6>b?parseInt(c,10):c}};thrUI.colorPicker={create:function(a,b,c){thrUI.createControl(a,"colorPicker","thrPicker",["click"],_h.table(0,this.colorField(),"thrColorPicker"+(b?" thrSmall":""))+_h.div());c&&a.data("prop",c);thrUI.opacityPicker.create(a.find("\x3ediv"),b,c)},refresh:function(a){a.find("\x3e.thrColorPicker\x3etbody").empty().append(this.colorField().map(function(a){return _h.tableRow(a)}).join(""))},colorField:function(){function a(a){return{style:"background-color: "+
a.toCssColor()+";","data-value":a.toColorString()}}var b,c,d=new ThrColor("thr(0)"),e=new ThrColor("#000"),f=thrColors.activePal.length,g=[["",{"class":"thrSpacer",colspan:f}]],h=Math.sqrt(f-1);c=[];for(b=0;b<f;b++){if(b<f-1){var i=Math.round(255*Math.sqrt(b)/h);e.rgb=(i<<16)+(i<<8)+i}else e.rgb=16777215;c.push(["",a(e)])}b=[c,g];for(d.mode=0;7>d.mode;d.mode++){c=[];for(d.n=0;d.n<f;d.n++)c.push(["",a(d)]);b.push(c);d.mode||b.push(g)}return b},fill:function(a,b){thrUI.opacityPicker.fill(a,b)},click:function(a){var b,
c,d,e=$(a.target);a=a||o.event;if(e.is("td:not(.thrSpacer)")||e.parent().hasClass("thrOpacityIndicator"))c=e.closest("table").parent(),b=new ThrColor(thrUI.opacityPicker.getValue(c)),e.parent().hasClass("thrOpacityIndicator")||(d=b.opacity,b=new ThrColor(e.data("value")),b.opacity=d),this.changeColor(c,b.toColorString());a.stopPropagation()},changeColor:function(a,b){a.trigger($.Event("change",{prop:a.data("prop"),value:b}))}};thrUI.colorPalettePicker={create:function(a,b,c,d,e){function f(a,b){var c=
b.map(function(a){return["",{style:"background-color: "+thrColors.rgbToColorString(a)+";"}]});return _h.table(0,[c.slice(0,5),c.slice(5)],{"data-val":a})}var g,h=0;b=Math.floor((b-2)/40);var i=[];d?a.data("isswapper",!0):d=a.data("isswapper");for(var j=0,k=d?4:thrColors.palettes.length;j<k;j++)0>=--h&&(g=[],i.push(g),h=b),g.push(f(j,thrColors.getPalette(d?e:j,d?j:0)));thrUI.createControl(a.data("prop",c),"colorPalettePicker","thrPalettePicker",["click"],_h.table(void 0,i))},fill:function(a,b){var c=
a.find("\x3etable\x3etbody"),d=c.find("tr:first\x3etd").length;c.find("table").removeClass("thrSelected");isNaN(b)||(a.data("value",b),c.find("\x3etr:nth-child("+(Math.floor(b/d)+1)+")\x3etd:nth-child("+(b%d+1)+")\x3etable").addClass("thrSelected"))},click:function(a){var b,c;a=a||o.event;b=$(a.target).closest("table");c=b.data("val");void 0!==c&&(b=b.parent().closest("table").parent(),this.fill(b,c),b.trigger($.Event("change",{prop:b.data("prop"),value:c})));a.stopPropagation()}};thrUI.ddPalette=
{fieldcount:2,create:function(a,b,c,d){thrUI.dropdownButton.create(a);d&&a.data("isswapper",!0);a.addClass("thrDDPalette")},createLazySub:function(a,b){var c,d=a.data("value"),e=a.data("isswapper");0>=b.children().length&&b.click(thr0.breakEvent).change(function(a){thrUI.ddPalette.change(a)});b.empty();e&&b.css("width","auto");c=$(_h.div("",{"data-control":"colorPalettePicker"})).appendTo(b);thrUI.colorPalettePicker.create(c,202,a.data("prop"),e,e?a.data("value1"):void 0);void 0!==d&&thrUI.colorPalettePicker.fill(b.find("div"),
parseInt(d,10));return b},fill:function(a,b,c){var d=a.find("\x3e.thrDropdown"),e=a.children().first();a.data("value"+(c?c:""),b);a.data("isswapper")?(e.text(thrColors.ntx.swapColors),c&&a.find(".thrDropdown").remove()):e.empty().append(_h.table(0,[thrColors.getPalette(b,0).map(function(a){return["",{style:"background-color: "+thrColors.rgbToColorString(a)+";"}]})]));0<d.length&&thrUI.colorPalettePicker.fill(d.find("div"),b)},getValue:function(a){return parseInt(a.data("value"),10)},change:function(a){var b=
$(a.target).parent().parent();this.fill(b,a.value);b.trigger($.Event("change",{prop:b.data("prop"),value:a.value}));a.stopPropagation()}};thrUI.gradientPicker={icons:{none:"m 6.5,18.53 a 12,12 0 1 1 24,0 12,12 0 0 1 -24,0 z m 19.11,4.64 a 8.5,8.5 0 0 0 -11.75,-11.75 z m -14.23,-9.27 a 8.5,8.5 0 0 0 11.75,11.75 z",set:"m 8,16 0,4 4,0 0,-4z m 8,0 0,4 4,0 0,-4 z m 8,0 0,4 4,0 0,-4 z"},svgEl:function(a,b,c,d){c="\x3crect x\x3d'"+(5+42*b)+"' y\x3d'"+(5+42*a)+"' width\x3d'37' height\x3d'37' rx\x3d'5' ry\x3d'5' "+
(c?" style\x3d'fill: "+c+";'":"")+"/\x3e";return d?"\x3cg\x3e"+c+"\x3cpath d\x3d'"+d+"' transform\x3d'translate("+(5+42*b)+","+(5+42*a)+")'/\x3e\x3c/g\x3e":c},makeSvg:function(a,b){var c=a[0].getBoundingClientRect(),d=new ThrColor(b||"thr(0)"),e=thrColors.activeGradients().map(function(a,b){return thrColors.gradientDef(a,b,d)}),f=e.length+1,g=Math.floor((c.width-5)/42),h=1+Math.floor(f/g),i=e.map(function(a,b){return this.svgEl(Math.floor((b+1)/g),(b+1)%g,"url(#gradient"+b+")")},this);i.unshift(this.svgEl(0,
0,void 0,this.icons.none));i.push(this.svgEl(h-1,f%g,void 0,this.icons.set));a.empty().append(thrSvg.svgHtml(c.width,42*h+5,0,!0,void 0,"\x3cdefs\x3e"+e.join("")+"\x3c/defs\x3e"+i.join(""))).data("rgb",d.toRgb()).data("color",b)},create:function(a,b){this.makeSvg(a.addClass("thrGradientPicker").data("control","gradientPicker").click(function(a){thrUI.gradientPicker.click(a)}),b)},setBaseColor:function(a,b){var c=(new ThrColor(b)).toRgb(),d=this.indexOfSelection(a);a.data("rgb")!==c&&(this.makeSvg(a,
b),this.select(a,d))},select:function(a,b){var c=a.find("svg\x3e*:nth-child("+(b+3)+")");c.is("rect")||(c=c.find("rect"));thrSvg.removeClass(a.find("\x3esvg .thrSelected"),"thrSelected");thrSvg.addClass(c,"thrSelected")},fill:function(a,b){var c=thrColors.activeGradients();a.find("svg\x3erect").length-2!==c.length&&this.makeSvg(a,a.data("color"));this.select(a,thrColors.indexOfGradient(c,b))},indexOfSelection:function(a){a=a.find("\x3esvg .thrSelected");a.parent().is("svg")||(a=a.closest("g"));return a.length?
a.index()-2:-1},getValue:function(a){thrColors.getActiveGradient(this.indexOfSelection(a))},triggerChange:function(a,b){a.trigger($.Event("change",{value:b,prop:a.data("prop")}));this.makeSvg(a,a.data("color"));this.select(a,thrColors.indexOfGradient(thrColors.activeGradients(),b))},click:function(a){a=$(a.target);a.parent().is("svg")||(a=a.closest("g"));if(a.length&&!a.is(".thrSelected")&&!a.find(".thrSelected").length){var b=a.closest(".thrGradientPicker");a=a.index()-2;var c=thrColors.getActiveGradient(a);
a>=thrColors.activeGradients().length&&!c?(a=thrUI.dialog.show(thrColors.ntx.gradient,function(a){thrUI.gradientPicker.triggerChange(b,a.gradient)},1,_h.div("",{"class":"thrDlgResult","data-prop":"gradient"})).find(".thrDialog"),thrUI.gradientConfigurator.create(a.find(".thrDlgBody .thrDlgResult"),thrColors.getActiveGradient(this.indexOfSelection(b))||thrColors.stdGradient,b.data("rgb")),thrUI.initControls(a),thrUI.dialog.center(a)):thrUI.gradientPicker.triggerChange(b,c)}}};thrUI.gradientConfigurator=
{create:function(a,b,c){b=$.extend({},b||thrColors.stdGradient);var d=_h.table(void 0,[[_h.div(thrColors.ntx.preview)+thrSvg.svgHtml(150,150,0,!0,void 0,"\x3cdefs /\x3e\x3crect x\x3d'0' y\x3d'0' width\x3d'150' height\x3d'150' rx\x3d'5' ry\x3d'5' style\x3d'fill:url(#gradientPrev)'/\x3e"),thrUI.ihtml("tabpanel",{tabs:[thrColors.ntx.direction,thrColors.ntx.colors],content:[this.gradientField(b,c,0),this.gradientField(b,c,0)]})]]);thrUI.setTempData(a.closest(".thrDlgBack"),"gradient",b);thrUI.createControl(a.data("color",
c),"gradientConfigurator","thrGradientConfigurator",["click","change"],d);thrUI.initControls(a);a.find("\x3etable\x3etbody\x3etr\x3etd:first-child").css("padding","10px").find("\x3esvg").addClass("thrPreview");this.setPreview(a,b,c);c=a.find("\x3etable\x3etbody\x3etr\x3etd:last-child\x3e.thrTabpanel").data("triggerchange",1).addClass("thrTexttabs");c.find("\x3ediv\x3ediv:first-child").addClass("thrTabDirection");c.find("\x3ediv\x3ediv:last-child").addClass("thrTabColor");this.showSel(a,b,0)},setPreview:function(a,
b,c){c=new ThrColor(c);c.opacity=100;b=thrColors.gradientSpec(b,c);b.attrs.id="gradientPrev";(new ThrSvgSpec(b)).$appendTo(a.find(".thrPreview\x3edefs").empty())},fill:function(a,b){var c=thrUI.tabpanel.getValue(a.find(".thrTabpanel"))-1,d=a.data("color");thrUI.setTempData(a.closest(".thrDlgBack"),"gradient",b);this.showSel(a,b,c);this.setPreview(a,b,d);a.find(c?".thrTabColor":".thrTabDirection").empty().append(this.gradientField(b,d,c))},getValue:function(a){return thrUI.getTempData(a.closest(".thrDlgBack"),
"gradient")},showSel:function(a,b,c){var d,e,f=0,g=c?thrColors.gradientColors:thrColors.gradientTypes,h=c?".thrTabColor":".thrTabDirection";b=c?b.stops:$.extend({},b);c||delete b.stops;thrSvg.removeClass(a.find(h+" .thrSelected"),"thrSelected");for(c=0;c<g.length;c++){d=0;for(e=g[c].length;d<e;d++)if(f++,thr0.equalObjects(g[c][d],b)){a.find(h+" rect:nth-child("+(f+1)+")").addClass("thrSelected");return}}},click:function(a){var b=$(a.target);if(b.is("rect")&&!b.parent().is(".thrPreview")){var c=(b.attr("x")-
5)/42,d=(b.attr("y")-5)/42,e=b.closest(".thrGradientConfigurator"),f=e.data("color"),g=thrUI.getTempData(e.closest(".thrDlgBack"),"gradient");(b=b.closest("svg").parent().hasClass("thrTabDirection")?0:1)?g.stops=thrColors.gradientColors[d][c]:(g=$.extend({stops:g.stops},thrColors.gradientTypes[d][c]),thrUI.setTempData(e.closest(".thrDlgBack"),"gradient",g));this.showSel(e,g,b);this.setPreview(e,g,f);thr0.breakEvent(a)}},change:function(a){var b=$(a.currentTarget),c=$(a.target);if(c.is(".thrTabpanel")){var d=
a.value-1,e=thrUI.getTempData(b.closest(".thrDlgBack"),"gradient"),f=b.data("color");c.find(d?".thrTabColor":".thrTabDirection").empty().append(this.gradientField(e,f,d));this.showSel(b,e,d);thr0.breakEvent(a)}},gradientField:function(a,b,c){var d=new ThrColor(b);b=c?thrColors.gradientColors:thrColors.gradientTypes;var e=b.reduce(function(a,b){return Math.max(a,b.length)},0),f=c?"Clr":"Dir",g=$.extend(!0,{},a);a=b.map(function(a,b){return a.map(function(a,e){c&&(g.stops=a);return thrColors.gradientDef(c?
g:$.extend({stops:g.stops},a),f+b+"_"+e,d)}).join("")});return thrSvg.svgHtml(42*e+5,42*a.length+5,0,!0,void 0,"\x3cdefs\x3e"+a.join("")+"\x3c/defs\x3e"+b.map(function(a,b){return a.map(function(a,c){return"\x3crect x\x3d'"+(42*c+5)+"' y\x3d'"+(42*b+5)+"' width\x3d'37' height\x3d'37' rx\x3d'5' ry\x3d'5' style\x3d'fill: url(#gradient"+f+b+"_"+c+")' /\x3e"}).join("")}).join(""))}};thrUI.hslPicker={create:function(a){var b,c=a.data("value");b=_h.table(void 0,[[_h.div(_h.div(),"thrOpacityIndicator")+
_h.div("","thrColorString"),"\x3ctable class\x3d'thrColorSliders'\x3e\x3ctbody\x3e"+["thrHue","thrSaturation","thrLight","thrOpacity"].map(function(a){return _h.tableRow([[_h.div(_h.div("","thrSliderHandle")),"thrOpacityBack"],""],!1,a)}).join("")+"\x3c/tbody\x3e\x3c/table\x3e"]]);thrUI.createControl(a,"hslPicker","thrHslPicker",[],b);b=a.find(".thrColorString");thrUI.textInput.create(b);b.change(function(a){thrUI.hslPicker.changeClString(a)});a.find(".thrColorSliders\x3etbody\x3etr").each(function(){thrUI.numberInput.create($(this).find("td:last-child"))});
thrUI.setActionMaker(a.find(".thrColorSliders .thrOpacityBack\x3ediv"),function(a){return thrUI.hslPicker.makeAction(a)});a.find(".thrColorSliders .thrInput").change(function(a){thrUI.hslPicker.changeHSLA(a)});c&&this.fill(a,c)},fill:function(a,b){var c=new ThrColor(b),d=thrColors.rgbToHsl(c.toRgb());d.push(c.opacity/100);a.data("value",b).data("hsla",d);this.fillControls(a,d)},fillControls:function(a,b){function c(a,b,c,d){var e=b[c],f=[],g=[360,100,100,100][c],p=[10,20,20,100][c];thrUI.numberInput.fill(a.find(".thrInput"),
e);for(var t=0;t<=g;t+=p)b[c]=t,f.push("hsla("+b[0]+", "+b[1]+"%, "+b[2]+"%, "+b[3]/100+")");a.find(".thrOpacityBack\x3ediv").css("background","linear-gradient(to right,"+f.join(",")+")");a.find(".thrSliderHandle").css("left",Math.round(d*e/g)-4+"px");b[c]=e}var d=a.find(".thrHue"),e=d.find(".thrOpacityBack\x3ediv")[0].getBoundingClientRect().width-2,f=new ThrColor(thrColors.hslToRgb(b)),g=b.map(function(a,b){return Math.round(a*(b?100:360))});f.opacity=100*b[3];0>=e&&(e=parseInt(d.attr("width"),
10)||300);a.find(".thrOpacityIndicator\x3ediv").css("background-color",f.toCssColor(!0));thrUI.textInput.fill(a.find(".thrColorString"),f.toCssColor(!0));c(a.find(".thrOpacity"),g,3,e);g[3]=100;c(d,g,0,e);c(a.find(".thrSaturation"),g,1,e);c(a.find(".thrLight"),g,2,e)},getValue:function(a){return a.data("value")},hslaIx:function(a){a=a.closest("tr");return a.hasClass("thrHue")?0:a.hasClass("thrSaturation")?1:a.hasClass("thrLight")?2:3},notifyHslChange:function(a,b){var c=new ThrColor(thrColors.hslToRgb(b));
c.opacity=100*b[3];a.data("value",c.toColorString()).data("hsla",b).trigger($.Event("change",{value:c.toColorString(),prop:a.data("prop")}))},makeAction:function(a){function b(a,b){this.k=b;this.rect=a.currentTarget.getBoundingClientRect();this.$el=$(a.currentTarget).closest(".thrHslPicker");this.hsla=this.$el.data("hsla");this.savHsla=$.extend([],this.hsla);this.move(a)}b.prototype={move:function(a){this.hsla[this.k]=Math.max(0,Math.min(1,(a.clientX-this.rect.left)/this.rect.width));thrUI.hslPicker.fillControls(this.$el,
this.hsla)},end:function(a,b){b?thrUI.hslPicker.fillControls(this.$el,this.savHsla):(this.move(a),thr0.compareArrays(this.hsla,this.savHsla)&&thrUI.hslPicker.notifyHslChange(this.$el,this.hsla))}};return new b(a,this.hslaIx($(a.currentTarget)))},changeHSLA:function(a){if(void 0!==a.value){var b=$(a.currentTarget).closest(".thrHslPicker"),c=b.data("hsla"),d=this.hslaIx($(a.target));a=thr0.intoRange(a.value,0,d?100:360)/(d?100:360);c[d]!==a?(c[d]=a,this.fillControls(b,c),this.notifyHslChange(b,c)):
this.fillControls(b,c)}},changeClString:function(a){if(void 0!==a.value){var b=new ThrColor(a.value);if(0>b.n){a=$(a.target).closest(".thrHslPicker");var c=thrColors.rgbToHsl(b.rgb);c.push(b.opacity/100);thr0.compareArrays(c,a.data("hsla"))&&(this.fillControls(a,c),this.notifyHslChange(a,c))}}}};thrUI.dialog.showHSLPicker=function(a,b,c){thrUI.dialog.show(a,c,1,_h.div("",{"class":"thrInitControl thrDlgResult","data-control":"hslPicker","data-value":b.toColorString(),"data-prop":"color"}),!0).find(".thrDialog .thrHslPicker").change(thr0.breakEvent)};
if("undefined"!==typeof thr0){o.ThrTextWrapper=function(a){a=a?a.split(","):[];a.length&&(this.spaceWidth=parseFloat(a.shift()));if(a.length){var b=a.shift().split("#");this.lineHeight=parseInt(b[0],10);this.baseline=1<b.length?parseInt(b[1],10):Math.round(this.lineHeight/5)}this.infos=a.map(function(a){var b=a.split("#");if(1>=b.length)return parseInt(a,10);a={ix:parseInt(b[0],10),x:parseFloat(b[1]),cr:2<b.length&&"0"!==b[2]?1:0};3<b.length&&(a.w=parseInt(b[3],10));return a})};ThrTextWrapper.prototype=
{spaceWidth:6,lineHeight:20,baseline:4,toString:function(){return this.spaceWidth+","+this.lineHeight+"#"+this.baseline+(this.infos.length?","+this.infos.map(function(a){return"object"===typeof a?a.ix+"#"+a.x+"#"+a.cr+(void 0!==a.w?"#"+a.w:""):a}).join(","):"")},totalHeight:function(a){var b=this,c=this.infos.reduce(function(a,c,f){return a+(b.newline(f)?1:0)},0)||1;return Math.floor(this.lineHeight*c+(a||0)*(c-1))},ix:function(a){return"object"===typeof this.infos[a]?this.infos[a].ix:this.infos[a]},
isPositioned:function(a){return"object"===typeof this.infos[a]},newline:function(a){return"object"!==typeof this.infos[a]||this.infos[a].cr},x:function(a){return"object"===typeof this.infos[a]?this.infos[a].x:0},lastLineSpan:function(a){for(a+=1;a<this.infos.length;a++)if(this.newline(a))return a-1;return this.infos.length-1},tx:function(a,b){return""===b?"":b.substring(this.ix(a),a+1<this.infos.length?this.ix(a+1):b.length)},getWrapInfos:function(a,b,c,d){function e(a,b){if(b.length){var c,d,e,f=
b.shift();c=f.trim();d=c.length;a.textContent=c;c=a.getBBox();0<d?(e=a.getExtentOfChar(d-1),d=j.getExtentOfChar(0).x,e=e.x+e.width):(d=c.x,e=c.width);return{tx:f,bb:{x:d,y:c.y,width:e,height:c.height},l:f.match(/^\s*/)[0].length,r:f.match(/\s*$/)[0].length,ix0:0,cr:f&&"\n"===f.charAt(f.length-1)}}}function f(a,b,c,d){var e=b.x||b.l?{ix:b.ix,x:b.x+b.l,cr:b.x?0:1}:b.ix;if(1<c.r&&!c.cr&&b.w<d)b.x+=b.w;else{if(b.x||b.l)e.w=b.w-b.l;b.x=0}a.infos.push(e);b.ix+=b.tx.length;b.tx="";b.w=0;b.l=0}var g,h,i=
{ix:0,tx:"",w:0,x:0,l:0};b=thr0.splitWords(b);a=thrSvg.$appendElement(a,"text",{x:0,y:0,visibility:"hidden"},"x AaEeOoYy").css(d);var j=a[0];d=j.getBBox();this.spaceWidth=j.getExtentOfChar(1).width;this.baseline=Math.round(d.y+d.height);this.lineHeight=Math.round(d.height);this.infos=[];for(g=e(j,b);g;){var k=g.bb.width+g.l*this.spaceWidth;h=g.cr;i.x&&(i.x+k>c&&""===i.tx)&&(d=this.infos.length-1,this.isPositioned(d)&&(this.infos[d].w=i.x-this.x(d)),i.x=0);if(i.x+i.w+k>c)if(""===i.tx){for(d=Math.max(g.tx.length-
2,1);0<d&&!(d<g.l?i.w=this.spaceWidth*(d+1):d>=g.tx.length-g.r?i.w=g.bb.width-this.spaceWidth*(g.l+g.tx.length-d):(k=j.getExtentOfChar(d-g.l+g.ix0),i.w=this.spaceWidth*g.l+k.x+k.width-g.bb.x),i.w<c);d--);i.tx=g.tx.substring(0,d+1);g.tx=g.tx.substring(d+1);g.bb.x+=i.w;g.bb.width-=i.w;g.l&&(d>=g.l?(d-=g.l,g.l=0):(g.l-=d,d=0));g.r>=g.tx.length?(i.tx+=g.tx,g.tx=""):g.ix0+=d;f(this,i,g,c);""===g.tx&&(g=e(j,b))}else f(this,i,g,c);else i.tx+=g.tx,i.w+=g.bb.width+(g.l+g.r)*this.spaceWidth,g.l&&(i.l=g.l*this.spaceWidth),
(!b.length||1<g.r||g.cr||i.w>=c)&&f(this,i,g,c),g=e(j,b)}a.remove();d=this.infos.length-1;0<=d&&(i.x&&this.isPositioned(d))&&(this.infos[d].w=i.x-this.x(d));h&&this.infos.push(i.ix);return this.toString()},$createWrappedSvgText:function(a,b,c,d,e,f){function g(a,b){thrSvg.addClass(thrSvg.$createElement("rect",b).prependTo(a),"thrTextBkg")}function h(a,c,d,e,f,h,i){var j=(i||1)*a.spaceWidth;f={x:e-(2===b.hAlign?j:b.hAlign?j/2:0),y:f+a.baseline-h,width:j,height:h};g(c,f);a.tagInfos&&(j=i*a.spaceWidth,
f.x=e+(1===b.hAlign?j/2:b.hAlign?0:j),f.width=0,a.tagInfos.push({box:f,ix:d,l:i}))}var i,j,k,l,m,n,p=this.infos,t=c.x+(b.hAlign?2===b.hAlign?c.width:Math.round(c.width/2):0),r=this.lineHeight+f;f=c.height-this.totalHeight(f);f=c.y+(2===b.vAlign?f:b.vAlign?f/2:0)+this.lineHeight-this.baseline;var s=thrSvg.$appendElement(a,"g",void 0,"").attr(b.getTextStyle());this.tagInfos&&(this.tagInfos=[]);a=0;for(j=this.ix(a);a<p.length;a++){a&&this.newline(a)&&(f+=r);a+1<p.length?(k=this.ix(a+1),m=b.tx.substring(j,
k)):m=b.tx.substring(j);n=""===m?0:m.match(/^[^\S\n]*/)[0].length;l=m.trim();if(""!==l){if(this.isPositioned(a)||b.hAlign&&a+1<p.length&&!this.newline(a+1)&&this.isPositioned(a+1))i=this.lastLineSpan(a),m=p[i].x+(p[i].w||0),i=b.hAlign?c.width-(m-(this.tx(i,b.tx).match(/[\s\n]$/)?this.spaceWidth:0)):0,i={x:c.x+this.x(a)+(1===b.hAlign?i/2:i),y:f,"text-anchor":"start"},(!a||this.newline(a))&&g(s,{x:i.x-n*this.spaceWidth,y:f-r,width:m,height:r});else{if(i=b.hAlign?m.match(/[\s\n]*$/)[0].length:0)i--,
1===b.hAlign&&(i=(i-n)/2);i={x:thr0.round100(t-i*this.spaceWidth),y:f,"text-anchor":2===b.hAlign?"end":b.hAlign?"middle":"start"}}l=thrSvg.$appendElement(s,"text",i,l)[0];this.tagInfos&&this.tagInfos.push({t:l,box:thrSvg.bboxToRect(l.getBBox()),ix:j,l:n})}else h(this,s,j,t,f,r,n);j=k}p.length||h(this,s,0,t,f,r,0);if(d||b.orientation)s.attr("transform",(d?thrSvg.strRotate(d,e):"")+(b.orientation?thrSvg.strRotate(90*b.orientation,thr0.rectCenter(c)):""));return s}};o.ThrSvgTrafo=function(a){var b=typeof a;
"string"===b?this.setAsString(a):$.isArray(a)?this.setAsArray(a):a&&"object"===b&&$.extend(this.data)};ThrSvgTrafo.prototype={a:1,b:0,c:0,d:1,e:0,f:0,setAsArray:function(a){a.forEach(function(a,c){this[String.fromCharCode(97+c)]=a},this)},getAsArray:function(){return[this.a,this.b,this.c,this.d,this.e,this.f]},reset:function(){this.setAsArray(ThrSvgTrafo.prototype.getAsArray())},clone:function(){return new ThrSvgTrafo(this.getAsArray())},isChanged:function(){return this.b||this.c||this.e||this.f||
1!==this.a||1!==this.d},multiply:function(a){var b=this.a,c=this.b,d=this.c,e=this.d,f=a.a,g=a.b,h=a.c,i=a.d,j=a.e;a=a.f;this.a=b*f+d*g;this.b=c*f+e*g;this.c=b*h+d*i;this.d=c*h+e*i;this.e+=b*j+d*a;this.f+=c*j+e*a},rotate:function(a,b,c){var d=b||c,e=a*Math.PI/180;a=Math.sin(e);e=Math.cos(e);d&&(b=b||0,c=c||0,this.multiply({a:1,b:0,c:0,d:1,e:b,f:c}));this.multiply({a:e,b:a,c:-a,d:e,e:0,f:0});d&&this.multiply({a:1,b:0,c:0,d:1,e:-b,f:-c})},translate:function(a,b){this.multiply({a:1,b:0,c:0,d:1,e:a,f:b})},
scale:function(a,b){this.multiply({a:a,b:0,c:0,d:b,e:0,f:0})},skewX:function(a){this.multiply({a:1,b:0,c:Math.tan(a*Math.PI/180),d:1,e:0,f:0})},skewY:function(a){this.multiply({a:1,b:Math.tan(a*Math.PI/180),c:0,d:1,e:0,f:0})},apply:function(a){var b=a.x;a=a.y;return{x:b*this.a+a*this.c+this.e,y:b*this.b+a*this.d+this.f}},applyToRect:function(a){var b=this.apply({x:a.x,y:a.y},!0),c=this.apply({x:a.x+a.width,y:a.y+a.height},!0),b={x:Math.min(b.x,c.x),y:Math.min(b.y,c.y),width:Math.abs(c.x-b.x),height:Math.abs(c.y-
b.y)};a.ellipse&&(b.ellipse=!0);return b},averageScale:function(){var a=this.apply({x:0,y:0}),b=this.apply({x:1,y:1});return(Math.abs(b.x-a.x)+Math.abs(b.y-a.y))/2},setAsString:function(a){var b=this;this.reset();a.replace(/([^\(]*)\(([^\)]*)\)/ig,function(a,d,e){a=e.split(/\s*[ ,]s*/).map(function(a){return+a.trim()});e=a[0];/rotate/i.test(d)?(d=2<a.length,b.rotate(e,d?a[1]:0,d?a[2]:0)):b.multiply(/translate/i.test(d)?{a:1,b:0,c:0,d:1,e:e,f:1<a.length?a[1]:0}:/scale/i.test(d)?{a:e,b:0,c:0,d:1<a.length?
a[1]:e,e:0,f:0}:/skewx/i.test(d)?{a:1,b:0,c:Math.tan(e*Math.PI/180),d:1,e:0,f:0}:/skewy/i.test(d)?{a:1,b:Math.tan(e*Math.PI/180),c:0,d:1,e:0,f:0}:new ThrSvgTrafo(a))})}};o.ThrText=function(a){if(a&&($.extend(this,a),this.tx&&void 0===this.p)){var b=0;this.tx=this.tx.replace(/\#attribute:([^#]+)#/ig,function(a,d){b=1;return"{{info."+d+"}}"});this.p=b}};ThrText.prototype={x:0,y:0,width:0,height:0,font:0,size:12,orientation:0,isBold:!1,isItalic:!1,isUnderline:!1,color:"#000",hAlign:1,vAlign:1,getFormat:function(a){return thr0.copyProps({},
this,"font size orientation isBold isItalic isUnderline color vAlign hAlign".split(" "),a)},addLine:function(a){void 0!==this.wi&&(this.wi+=","+(this.tx?this.tx.length:0));this.tx+=a},getTextWrapper:function(){return new ThrTextWrapper(this.wi)},isParameterized:function(){return/\{\{[^\}]+\}\}/.test(this.tx)},dispText:function(a,b){var c=a&&a.length&&this.p,d=b||c?this.clone():this;c&&(d.tx=d.tx.replace(/\{\{([^\}]+)\}\}/g,function(b,c){var d=c.split(".");return(d=2===d.length&&"info"===d[0]?thr0.arrayObjByKey(a,
"key",(d[1]||"").toLowerCase()):void 0)?d.v:b}));return d},clone:function(){return new ThrText(JSON.parse(JSON.stringify(this)))},getTextStyle:function(){var a=$.extend(thrColors.colorStringToSvgCss(this.color,"fill"),{"font-family":thr0.fontFamilies[Math.max(0,Math.min(thr0.fontFamilies.length,this.font))],"font-size":this.size+"px","font-weight":this.isBold?"bold":"normal"});this.isItalic&&(a["font-style"]="italic");this.isUnderline&&(a["text-decoration"]="underline");return a},getWrapInfos:function(a,
b){return(new ThrTextWrapper).getWrapInfos(a,this.tx,1===this.orientation%2?b.height:b.width,this.getTextStyle(),this.hAlign)},$createWrappedSvgText:function(a,b,c,d,e,f){b=1===this.orientation%2?thr0.rotatedRect(b):b;return(f||new ThrTextWrapper(this.wi||this.getWrapInfos(a,b))).$createWrappedSvgText(a,this,b,d,e,c)}};o.ThrLine=function(a){a&&$.extend(this,a)};ThrLine.prototype={width:2,color:"#000",style:0,getFormat:function(a){return thr0.copyProps({},this,["width","color","style"],a)}};o.ThrSvgSpec=
function(a){var b=typeof a;a&&"object"===b?a.documentElement?this.initFromDom(a.documentElement):"svg"===a.nodeName?this.initFromDom(a):($.extend(this,a),a.subs&&(this.subs=a.subs.map(function(a){return new ThrSvgSpec(a)}))):"string"===b&&(this.tag=a)};ThrSvgSpec.prototype={clear:function(){this.subs=this.cdata=this.text=this.attrs=void 0},addAttr:function(a,b){this.attrs||(this.attrs={});this.attrs[a]=b},addSub:function(a){this.subs||(this.subs=[]);this.subs.push(a)},addText:function(a){this.text=
this.text?this.text+("\n"+a):a},addCData:function(a){this.cdata||(this.cdata=[]);this.cdata.push(a)},initFromDom:function(a){if(9===a.nodeType)this.initFromDom(a.documentElement);else if(1===a.nodeType){this.tag=a.nodeName;for(var b=0,c=a.attributes,d=c.length;b<d;b++){var e=c[b];this.addAttr(e.nodeName,(e.nodeValue||"").toString())}for(a=a.firstChild;a;a=a.nextSibling)c=(b=1===a.nodeType)?new ThrSvgSpec:this,c.initFromDom(a),b&&!c.isEmpty()&&this.addSub(c)}else 3===a.nodeType&&a.nodeValue.match(/[^ \f\n\r\t\v]/)?
this.addText(a.nodeValue):4==a.nodeType&&this.addCData(a.nodeValue);return parent},isEmpty:function(){return!(this.attrs||this.subs||this.cdata||this.text)},clone:function(){var a=new ThrSvgSpec(this.tag);this.attrs&&(a.attrs=$.extend({},this.attrs));this.subs&&(a.subs=this.subs.map(function(a){return a.clone()}));this.cdata&&(a.cdata=$.extend([],this.cdata));this.text&&(a.text=this.text);return a},findId:function(a){if(this.attrs&&this.attrs.id===a)return this;if(this.subs){for(var b,c=this.subs.length-
1;!b&&0<=c;c--)b=this.subs[c].findId(a);return b}},removeTag:function(a){this.subs&&(this.subs=this.subs.filter(function(b){return b.tag!==a}),this.subs.forEach(function(b){b.removeTag(a)}))},removeAttr:function(a,b){(!b||this.tag===b)&&(this.attrs&&void 0!==this.attrs[a])&&delete this.attrs[a];this.subs&&this.subs.forEach(function(c){c.removeAttr(a,b)},this)},expandUses:function(){function a(b,c){if("use"===b.tag&&b.attrs){var d=b.attrs["xlink:href"];d&&(d=d.trim());if(d&&"#"===d.charAt(0)&&(d=c.findId(d.substring(1)))){var e=
+b.attrs.x,f=+b.attrs.y;void 0!==e&&delete b.attrs.x;void 0!==f&&delete b.attrs.y;b.tag="g";delete b.attrs["xlink:href"];if(void 0!==e||void 0!==f)b.attrs.transform=("translate("+(e||0)+","+(f||0)+") "+(b.attrs.transform||"")).trim();b.subs=[d.clone()]}}else b.subs&&b.subs.forEach(function(b){a(b,c)})}a(this,this)},removeUselessGroups:function(){if(this.subs){var a=[];this.subs.forEach(function(b){(b=b.removeUselessGroups())&&(a=a.concat(b))},this);this.attrs&&$.isEmptyObject(this.attrs)&&delete this.attrs;
if(this.attrs)this.subs=a;else return a}return[this]},asXml:function(){var a="";if(this.attrs)for(var b in this.attrs)this.attrs.hasOwnProperty(b)&&(a+=" "+b+'\x3d"'+this.attrs[b].replace(/"/g,"'")+'"');return"\x3c"+this.tag+a+"\x3e"+(this.cdata?"\x3c![CDATA["+this.cdata.join("\n")+"]]\x3e":"")+(this.subs?this.subs.map(function(a){return a.asXml()}).join(""):"")+(this.text?this.text.replace(/&/g,"\x26amp;").replace(/</g,"\x26lt;").replace(/>/g,"\x26gt;"):"")+"\x3c/"+this.tag+"\x3e"},$appendTo:function(a){var b=
thrSvg.$appendElement(a,this.tag,this.attrs,this.text);this.subs&&this.subs.forEach(function(a){a.$appendTo(b)})}};o.thrSvg={svgNS:"http://www.w3.org/2000/svg",svgDoctype:"\x3c?xml version\x3d'1.0' encoding\x3d'UTF-8' standalone\x3d'no'?\x3e\x3c!DOCTYPE svg PUBLIC '-//W3C//DTD SVG 1.1//EN' 'http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd'\x3e",pathCommand:/([achlmqstvz])[\x09\x0a\x0b\x0c\x0d\x20\xa0\u1680\u180e\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u202f\u205f\u3000\u2028\u2029,]*((-?\d*\.?\d*(?:e[\-+]?\d+)?[\x09\x0a\x0b\x0c\x0d\x20\xa0\u1680\u180e\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u202f\u205f\u3000\u2028\u2029]*,?[\x09\x0a\x0b\x0c\x0d\x20\xa0\u1680\u180e\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u202f\u205f\u3000\u2028\u2029]*)+)/ig,
pathValues:/(-?\d*\.?\d*(?:e[\-+]?\d+)?)[\x09\x0a\x0b\x0c\x0d\x20\xa0\u1680\u180e\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u202f\u205f\u3000\u2028\u2029]*,?[\x09\x0a\x0b\x0c\x0d\x20\xa0\u1680\u180e\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u202f\u205f\u3000\u2028\u2029]*/ig,zoomsteps:[25,33,50,67,75,90,100,110,125,150,175,200,250,300],ptToPx:1.3281472327365,filterSpecs:[[{tag:"filter",attrs:{id:"innerShadow",filterUnits:"objectBoundingBox",x:"0",y:"0",
width:"100%",height:"100%"},subs:[{tag:"feGaussianBlur",attrs:{"in":"SourceGraphic",result:"r0",stdDeviation:"3"}},{tag:"feOffset",attrs:{"in":"r0",result:"r1",dx:"2.5",dy:"2.5"}},{tag:"feComposite",attrs:{"in":"r1",in2:"SourceGraphic",result:"r2",operator:"in"}},{tag:"feMerge",attrs:{},subs:[{tag:"feMergeNode",attrs:{"in":"SourceAlpha"}},{tag:"feMergeNode",attrs:{"in":"r2"}}]}]},{tag:"filter",attrs:{id:"bevel","color-interpolation-filters":"sRGB"},subs:[{tag:"feGaussianBlur",attrs:{"in":"SourceGraphic",
stdDeviation:"1.5",result:"r0"}},{tag:"feDiffuseLighting",attrs:{diffuseConstant:"1",surfaceScale:"10",result:"r1"},subs:[{tag:"feDistantLight",attrs:{azimuth:"235",elevation:"25"}}]},{tag:"feComposite",attrs:{"in":"r1",in2:"SourceGraphic",operator:"arithmetic",k1:"1",k2:"0",k3:"0.6",result:"r2"}}]},{tag:"filter",attrs:{id:"emboss",filterUnits:"objectBoundingBox",x:"0",y:"0",width:"100%",height:"100%","color-interpolation-filters":"sRGB"},subs:[{tag:"feGaussianBlur",attrs:{"in":"SourceAlpha",result:"r0",
stdDeviation:"6"}},{tag:"feSpecularLighting",attrs:{"in":"r0",result:"r1","lighting-color":"#FFFFFF",surfaceScale:"3",specularConstant:"1",specularExponent:"25"},subs:[{tag:"feDistantLight",attrs:{azimuth:"235",elevation:"45"}}]},{tag:"feComposite",attrs:{"in":"SourceGraphic",in2:"r1",result:"r2",k2:"1",k3:"1",operator:"arithmetic"}},{tag:"feComposite",attrs:{"in":"r2",in2:"SourceAlpha",result:"r3",operator:"in"}}]},{tag:"filter",attrs:{id:"marble",x:"0",y:"0",width:"100%",height:"100%","color-interpolation-filters":"sRGB"},
subs:[{tag:"feGaussianBlur",attrs:{"in":"SourceGraphic",result:"r0",stdDeviation:"4"}},{tag:"feTurbulence",attrs:{result:"r1",seed:"50",type:"turbulence",numOctaves:"7",baseFrequency:"0.01 0.01"}},{tag:"feColorMatrix",attrs:{"in":"r1",result:"r2",values:"1 0 0 0 0 0 1 0 0 0 0 0 1 0 0 0 0 0 1.4 0 "}},{tag:"feComposite",attrs:{"in":"r2",in2:"r0",result:"r3",operator:"in"}},{tag:"feDisplacementMap",attrs:{"in":"r2",in2:"r3",result:"r4",xChannelSelector:"A",yChannelSelector:"A",scale:"100"}},{tag:"feFlood",
attrs:{result:"r5","flood-opacity":"1","flood-color":"rgb(224,224,224)"}},{tag:"feComposite",attrs:{"in":"r5",in2:"r4",result:"r6",operator:"atop"}},{tag:"feComposite",attrs:{"in":"r6",in2:"SourceGraphic",result:"r7",operator:"atop"}},{tag:"feBlend",attrs:{"in":"r7",in2:"r7",result:"r8",mode:"darken"}},{tag:"feGaussianBlur",attrs:{"in":"r8",result:"r9",stdDeviation:"5"}},{tag:"feSpecularLighting",attrs:{"in":"r9",result:"r10","lighting-color":"rgb(255,255,255)",surfaceScale:"8",specularConstant:"0.8",
specularExponent:"30"},subs:[{tag:"feDistantLight",attrs:{azimuth:"235",elevation:"55"}}]},{tag:"feComposite",attrs:{"in":"r10",in2:"r8",result:"r11",operator:"in"}},{tag:"feComposite",attrs:{"in":"r8",in2:"r11",result:"r12",operator:"arithmetic",k2:"1",k3:"1"}}]},{tag:"filter",attrs:{id:"liquid",x:"-0.2",y:"-0.2",width:"1.4",height:"1.4","color-interpolation-filters":"sRGB"},subs:[{tag:"feGaussianBlur",attrs:{"in":"SourceGraphic",result:"r0",stdDeviation:"4"}},{tag:"feTurbulence",attrs:{"in":"r0",
result:"r1",baseFrequency:"0.016 0.052",numOctaves:"2",type:"fractalNoise",seed:"0"}},{tag:"feColorMatrix",attrs:{"in":"r1",result:"r2",values:"1 0 0 0 0 0 1 0 0 0 0 0 1 0 0 0 0 0 2 -0.75 "}},{tag:"feComposite",attrs:{"in":"r0",in2:"r1",operator:"out",result:"r3"}},{tag:"feDisplacementMap",attrs:{"in":"r2",in2:"r3",result:"r4",scale:"120",yChannelSelector:"A",xChannelSelector:"A"}},{tag:"feComposite",attrs:{"in":"r0",in2:"r4",operator:"arithmetic",result:"r5",k1:"1",k3:"0.5"}},{tag:"feComposite",
attrs:{"in":"SourceGraphic",in2:"r5",result:"r6",operator:"in"}},{tag:"feComponentTransfer",attrs:{"in":"SourceGraphic",result:"r7"},subs:[{tag:"feFuncR",attrs:{type:"linear",slope:"50"}},{tag:"feFuncG",attrs:{type:"linear",slope:"50"}},{tag:"feFuncB",attrs:{type:"linear",slope:"50"}}]},{tag:"feMerge",attrs:{},subs:[{tag:"feMergeNode",attrs:{"in":"r7"}},{tag:"feMergeNode",attrs:{"in":"r6"}}]}]},{tag:"filter",attrs:{id:"watercolor",filterUnits:"objectBoundingBox",x:"0",y:"0",width:"100%",height:"100%",
"color-interpolation-filters":"sRGB"},subs:[{tag:"feTurbulence",attrs:{type:"fractalNoise",baseFrequency:"0.1",numOctaves:"3",result:"r0"}},{tag:"feColorMatrix",attrs:{"in":"r0",values:"0",result:"r1",type:"saturate"}},{tag:"feColorMatrix",attrs:{"in":"r1",values:"1 0 0 0 0 0 1 0 0 0 0 0 1 0 0 0 0 0 20 -12 ",result:"r2",type:"matrix"}},{tag:"feGaussianBlur",attrs:{"in":"r2",stdDeviation:"2",result:"r3"}},{tag:"feColorMatrix",attrs:{"in":"r3",values:"1 0 0 0 0 0 1 0 0 0 0 0 1 0 0 0 0 0 10 -0.1 ",result:"r4",
type:"matrix"}},{tag:"feComposite",attrs:{"in":"r4",in2:"SourceGraphic",k1:"0.8",k2:"1",operator:"arithmetic",result:"r5"}},{tag:"feComposite",attrs:{"in":"r5",in2:"r1",operator:"atop",result:"r6"}},{tag:"feBlend",attrs:{"in":"r6",in2:"SourceGraphic",mode:"normal",result:"r7"}},{tag:"feComposite",attrs:{"in":"r7",in2:"SourceGraphic",operator:"atop",result:"r8"}}]},{tag:"filter",attrs:{id:"arched",x:"-0.2",y:"-0.2",width:"1.4",height:"1.4","color-interpolation-filters":"sRGB"},subs:[{tag:"feGaussianBlur",
attrs:{"in":"SourceGraphic",result:"r0",stdDeviation:"10"}},{tag:"feComposite",attrs:{"in":"r0",in2:"SourceGraphic",operator:"xor",result:"r1"}},{tag:"feGaussianBlur",attrs:{"in":"r1",result:"r2",stdDeviation:"10"}},{tag:"feComposite",attrs:{"in":"r2",in2:"SourceGraphic",operator:"atop",result:"r3"}},{tag:"feComposite",attrs:{"in":"r2",in2:"r3",result:"r4",operator:"xor"}},{tag:"feGaussianBlur",attrs:{"in":"r4",result:"r5",stdDeviation:"5"}},{tag:"feSpecularLighting",attrs:{"lighting-color":"rgb(255,255,255)",
"in":"r5",result:"r6",specularExponent:"35",specularConstant:"3",surfaceScale:"12"},subs:[{tag:"feDistantLight",attrs:{elevation:"45",azimuth:"235"}}]},{tag:"feComposite",attrs:{"in":"SourceGraphic",in2:"r6",k3:"0.7",k2:"0.8",operator:"arithmetic",result:"r7"}},{tag:"feComposite",attrs:{"in":"r7",in2:"SourceGraphic",operator:"in",result:"r8"}}]},{tag:"filter",attrs:{id:"plastering",filterUnits:"objectBoundingBox",x:"0",y:"0",width:"100%",height:"100%","color-interpolation-filters":"sRGB"},subs:[{tag:"feGaussianBlur",
attrs:{result:"r0","in":"SourceGraphic",stdDeviation:"0.5"}},{tag:"feTurbulence",attrs:{baseFrequency:"0.2",seed:"300",numOctaves:"10",result:"r1",type:"fractalNoise"}},{tag:"feGaussianBlur",attrs:{"in":"r1",stdDeviation:"0.5",result:"r2"}},{tag:"feDisplacementMap",attrs:{"in":"r0",in2:"r2",xChannelSelector:"R",scale:"5",result:"r3"}},{tag:"feComposite",attrs:{"in":"r3",in2:"r1",result:"r4",operator:"in"}},{tag:"feComposite",attrs:{"in":"r0",in2:"r4",k3:"3",operator:"arithmetic",result:"r5"}},{tag:"feBlend",
attrs:{"in":"r5",in2:"r4",result:"r6",mode:"multiply"}},{tag:"feColorMatrix",attrs:{values:"1 0 0 -1 0 1 0 1 -1 0 1 0 0 -1 0 -1.8 -0.5 0 5.7 -3.5 ","in":"r6",result:"r7"}},{tag:"feGaussianBlur",attrs:{stdDeviation:"0.5","in":"r7",result:"r8"}},{tag:"feDiffuseLighting",attrs:{"in":"r8",result:"r9",surfaceScale:"50",diffuseConstant:"0.6"},subs:[{tag:"feDistantLight",attrs:{azimuth:"225",elevation:"10"}}]},{tag:"feComposite",attrs:{"in":"r9",in2:"r7",result:"r10",operator:"in"}},{tag:"feComposite",attrs:{"in":"r6",
in2:"r10",result:"r11",operator:"arithmetic",k2:"1",k3:"0.7"}}]},{tag:"filter",attrs:{id:"canvas",filterUnits:"objectBoundingBox",x:"0",y:"0",width:"100%",height:"100%","color-interpolation-filters":"sRGB"},subs:[{tag:"feTurbulence",attrs:{baseFrequency:"0.2",seed:"300",numOctaves:"7",result:"r0",type:"turbulence"}},{tag:"feDisplacementMap",attrs:{"in":"r0",in2:"r0",xChannelSelector:"R",result:"r1"}},{tag:"feBlend",attrs:{"in":"r1",in2:"SourceGraphic",result:"r2",mode:"screen"}},{tag:"feColorMatrix",
attrs:{"in":"r2",values:"1 0 0 -1 0 1 0 1 -1 0 1 0 0 -1 0 -0.8 -1 0 4 -2.5 ",result:"r3"}},{tag:"feGaussianBlur",attrs:{stdDeviation:"0.5","in":"r3",result:"r4"}},{tag:"feDiffuseLighting",attrs:{"in":"r4",result:"r5",surfaceScale:"15",diffuseConstant:"0.4"},subs:[{tag:"feDistantLight",attrs:{azimuth:"235",elevation:"25"}}]},{tag:"feComposite",attrs:{"in":"r5",in2:"SourceGraphic",result:"r6",operator:"arithmetic",k2:"0.9",k3:"0.9"}},{tag:"feComposite",attrs:{"in":"r6",in2:"SourceGraphic",result:"r7",
operator:"in"}}]},{tag:"filter",attrs:{id:"washed",x:"0",y:"0",width:"100%",height:"100%"},subs:[{tag:"feTurbulence",attrs:{baseFrequency:".05,.004",width:"200%",height:"200%",top:"-50%",type:"fractalNoise",numOctaves:"4",seed:"0",result:"r1"}},{tag:"feColorMatrix",attrs:{type:"matrix",values:"0 0 0 0 0, 0 0 0 0 0, 0 0 0 0 0, 0 0 0 -1.2 1.1","in":"r1",result:"r2"}},{tag:"feComposite",attrs:{"in":"SourceGraphic",in2:"r2",operator:"in",result:"r3"}}]}],[{tag:"filter",attrs:{id:"dropshadow",filterUnits:"userSpaceOnUse"},
subs:[{tag:"feGaussianBlur",attrs:{"in":"SourceAlpha",result:"r0",stdDeviation:"4"}},{tag:"feOffset",attrs:{"in":"r0",result:"r1",dx:"4",dy:"4"}},{tag:"feFlood",attrs:{result:"r2","flood-color":"#444"}},{tag:"feComposite",attrs:{"in":"r2",in2:"r1",result:"r3",operator:"in"}}]},{tag:"filter",attrs:{id:"glow",filterUnits:"userSpaceOnUse"},subs:[{tag:"feGaussianBlur",attrs:{"in":"SourceGraphic",result:"r0",stdDeviation:"8"}},{tag:"feMerge",attrs:{},subs:[{tag:"feMergeNode",attrs:{"in":"r0"}},{tag:"feMergeNode",
attrs:{"in":"r0"}}]}]},{tag:"filter",attrs:{id:"airbrush",filterUnits:"userSpaceOnUse",x:"-20",y:"-20",width:"140%",height:"140%","color-interpolation-filters":"sRGB"},subs:[{tag:"feGaussianBlur",attrs:{"in":"SourceGraphic",result:"r0",stdDeviation:"0.01"}},{tag:"feBlend",attrs:{"in":"r0",in2:"r0",result:"r1",mode:"multiply"}},{tag:"feTurbulence",attrs:{result:"r2",baseFrequency:"0.8",type:"fractalNoise",seed:"0",numOctaves:"3"}},{tag:"feDisplacementMap",attrs:{"in":"r1",in2:"r2",result:"r3",xChannelSelector:"A",
yChannelSelector:"A",scale:"50"}},{tag:"feBlend",attrs:{"in":"r3",in2:"r3",result:"r4",mode:"screen"}}]}]],getCTM:function(a,b){return b.getScreenCTM().inverse().multiply(a.getScreenCTM())},bboxToRect:function(a){return{x:thr0.round100(a.x),y:thr0.round100(a.y),width:thr0.round100(a.width),height:thr0.round100(a.height)}},svgHtml:function(a,b,c,d,e,f){return"\x3csvg xmlns:svg\x3d'"+this.svgNS+"' xmlns\x3d'"+this.svgNS+"' xmlns:xlink\x3d'http://www.w3.org/1999/xlink'"+(void 0!==e?" id\x3d'"+e+"'":
"")+" viewBox\x3d'"+(c?c:"0 0 "+a+" "+b)+"'"+(d?" width\x3d'"+a+"' height\x3d'"+b+"'":"")+"\x3e"+(f||"")+"\x3c/svg\x3e"},getZoom:function(a,b){var c;if("number"===typeof a)c=a;else try{var d=a[0];c=Math.round(100*d.getBoundingClientRect().width/parseInt(d.getAttribute("viewBox").split(" ")[2],10))}catch(e){c=100}if(b){var d=this.zoomsteps,f=d.length,g=thr0.indexOfSorted(d,void 0,c,!0),g=0<g?g<f?Math.abs(c-d[g-1])>Math.abs(d[g]-c)?g:g-1:f-1:0;return d[Math.max(0,Math.min(f-1,g+("+"===b?1:-1)))]}return c},
viewBoxSize:function(a){a=a.split(" ");return{width:parseInt(a[2],10),height:parseInt(a[3],10)}},$createElement:function(a,b,c){a=document.createElementNS(this.svgNS,a);c&&(a.textContent=c);if(b)for(var d in b)b.hasOwnProperty(d)&&a.setAttribute(d,b[d]);return $(a)},$appendElement:function(a,b,c,d){return this.$createElement(b,c,d).appendTo(a)},$appendBounds:function(a,b,c){var d=c||{};if($.isArray(b))c="path",d.d=b.map(function(a,b){return(b?"L":"M")+thr0.round100(a.x)+","+thr0.round100(a.y)}).join(" ")+
"z";else{var e=thr0.rectCenter(b);b.ellipse?(c="ellipse",d.cx=e.x,d.cy=e.y,d.rx=b.width/2,d.ry=b.height/2):(c="rect",thr0.setXYFromPt(d,b),d.width=b.width,d.height=b.height);b.rot&&(d.transform=thrSvg.strRotate(b.rot,e))}return this.$appendElement(a,c,d)},getInnerSVG:function(a){if(thr0.isIE()||thr0.isEdge()){var b=[];a=a[0].firstChild;for(var c=new ThrSvgSpec;a;)c.clear(),c.initFromDom(a),b.push(c.asXml()),a=a.nextSibling;return b.join("")}return a.html()},clientSideSvgAs:function(a,b,c){function d(b){var d,
h=document.createElement("canvas");h.width=e.width;h.height=e.height;d=h.getContext("2d");"jpg"===c&&(d.fillStyle="#FFFFFF",d.fillRect(0,0,e.width,e.height));d.drawImage(e,0,0);b.isMsNavigator&&$("#thrClientSideSvgImg").remove();thr0.triggerDownloadLink(a,h.toDataURL("jpg"===c?"image/jpeg":"image/png"),"dataURL")}var e=new Image;thr0.isEdge()?($("body").append("\x3cdiv id\x3d'thrClientSideSvgImg' style\x3d'position: absolute; top: 0;'\x3e\x3c/div\x3e"),e.onload=function(){setTimeout(function(){d({target:e,
isMsNavigator:!0})},200)},document.getElementById("thrClientSideSvgImg").appendChild(e)):e.onload=d;e.src="data:image/svg+xml;charset\x3dutf-8,"+encodeURIComponent(b)},addClass:function(a,b){var c=a.attr("class");if(!c||0>c.indexOf(b))a.attr("class",(c?c+" ":"")+b)},strRotate:function(a,b){return"rotate("+a+","+b.x+","+b.y+")"},removeClass:function(a,b){var c=a.attr("class");c&&(c=c.split(" "),thr0.removeFromArray(c,b)&&a.attr("class",c.join(" ")))},pointFromEvent:function(a,b,c){var d=b.createSVGPoint();
thr0.setXY(d,a.clientX,a.clientY);return d.matrixTransform(c||b.getScreenCTM().inverse())},rectFromElementAttrs:function(a){return{x:parseInt(a.attr("x"),10),y:parseInt(a.attr("y"),10),width:parseInt(a.attr("width"),10),height:parseInt(a.attr("height"),10)}},pathFromPtArray:function(a){return"M"+a.map(function(a){return a.x+","+a.y}).join("L")},pathFromCmds:function(a){var b;return"M"+a.map(function(a){var d=$.isArray(a),e=d?a[0]:a;b=e.hasOwnProperty("pt")?e.pt:e.hasOwnProperty("ptx")?this[e.ptx]:
b;b=d?a.reduce(function(a,b){return thr0.movedPt(a,b.a,b.m)},b):e.hasOwnProperty("a")?thr0.movedPt(b,e.a,e.m):{x:b.x,y:b.y};this.push(b);return b.x+","+b.y},[]).join("L")},ellipsePath:function(a,b,c,d){var e=a-c;a+=c;c=thrSvg.pathAtoC(e,b,c,d,0,0,1,a,b).concat(thrSvg.pathAtoC(a,b,c,d,0,0,1,e,b));for(b=[["M",e,b]];6<=c.length;)b.push(["C"].concat(c.splice(0,6)));b.push(["Z"]);return thrSvg.dataToPath(b)},rectPath:function(a,b,c,d,e,f){var g="number"===typeof e&&Infinity!==e&&0<=e,h="number"===typeof f&&
Infinity!==f&&0<=f;!g&&!h?e=f=0:g&&!h?f=e:h&&!g?e=f:(e>c/2&&(e=c/2),f>d/2&&(f=d/2));if(!e&&!f)return thrSvg.dataToPath([["M",a,b],["L",a+c,b],["L",a+c,b+d],["L",a,b+d],["L",a,b],["Z"]]);f||(f=e);return thrSvg.dataToPath([["M",a,b+f],["C"].concat(thrSvg.pathAtoC(a,b+f,e,f,0,0,1,a+e,b).splice(0,6)),["L",a+c-e,b],["C"].concat(thrSvg.pathAtoC(a+c-e,b,e,f,0,0,1,a+c,b+f).splice(0,6)),["L",a+c,b+d-f],["C"].concat(thrSvg.pathAtoC(a+c,b+d-f,e,f,0,0,1,a+c-e,b+d).splice(0,6)),["L",a+e,b+d],["C"].concat(thrSvg.pathAtoC(a+
e,b+d,e,f,0,0,1,a,b+d-f).splice(0,6)),["L",a,b+f],["Z"]])},polygonPath:function(a,b,c){var d=thr0.rectCenter(a),e=d.x,f=d.y,g=e,h=f,i=[];c=90+c;var j=-360/b;for(b-=1;0<=b;b--){var k=thr0.movedPt(d,c,100);i.push(k);k.x<e&&(e=k.x);k.x>g&&(g=k.x);k.y<f&&(f=k.y);k.y>h&&(h=k.y);c+=j}g=a.width/(g-e);h=a.height/(h-f);return thrSvg.dataToPath(i.map(function(b,c){return[c?"L":"M",a.x+(b.x-e)*g,a.y+(b.y-f)*h]}).concat([["Z"]]))},dataToPath:function(a,b){return a.map(function(a){return 1<a.length?a[0]+a.slice(1).map(function(a){return b?
b(a):a.toFixed(2).replace(/\.?0+$/,"")}).join(" "):a[0]}).join("")},pathToData:function(a){if(a){var b={a:7,c:6,h:1,l:2,m:2,r:4,q:4,s:4,t:2,v:1,z:0},c=[];String(a).replace(this.pathCommand,function(a,e,f){var g=[];a=e.toLowerCase();f.replace(thrSvg.pathValues,function(a,b){b&&g.push(+b)});"m"===a&&2<g.length&&(f=g.splice(0,2),f.unshift(e),c.push(f),a="l",e="m"===e?"l":"L");if(f=b[a])for(;g.length>=f;){a=c;var h=g.splice(0,f);h.unshift(e);a.push(h)}else c.push([e])});return c}},pathDataToAbsolute:function(a,
b,c){if(/[amlcsqthv]/.test(c[0]))switch(c[0]){case "a":return c.map(function(c,e){return e?6>e?c:c+(7>e?a:b):"A"});case "v":return["V",c[1]+b];case "h":return["H",c[1]+a];default:return c.map(function(c,e){return e?c+(e%2?a:b):c.toUpperCase()})}return c},pathDataToRelative:function(a,b,c){if(/[AMLCSQTHV]/.test(c[0]))switch(c[0]){case "A":return c.map(function(c,e){return e?6>e?c:c-(7>e?a:b):"a"});case "V":return["v",c[1]-b];case "H":return["h",c[1]-a];default:return c.map(function(c,e){return e?c-
(e%2?a:b):c.toLowerCase()})}return c},pathAtoC:function(a,b,c,d,e,f,g,h,i,j){var k,l,m,n,p=120*Math.PI/180,t=Math.PI/180*(+e||0),r=[];if(j)f=j[0],n=j[1],l=j[2],m=j[3];else{var s;k=2*Math.PI;n=Math.cos(-t);l=Math.sin(-t);a=a*n-b*l;b=a*l+b*n;h=h*n-i*l;i=h*l+i*n;n=(a-h)/2;l=(b-i)/2;m=n*n/(c*c)+l*l/(d*d);1<m&&(m=Math.sqrt(m),c*=m,d*=m);m=c*c;s=d*d;f=(f===g?-1:1)*Math.sqrt(Math.abs((m*s-m*l*l-s*n*n)/(m*l*l+s*n*n)));l=f*c*l/d+(a+h)/2;m=f*-d*n/c+(b+i)/2;f=Math.asin(((b-m)/d).toFixed(9));n=Math.asin(((i-
m)/d).toFixed(9));f=a<l?Math.PI-f:f;n=h<l?Math.PI-n:n;0>f&&(f=k+f);0>n&&(n=k+n);g&&f>n&&(f-=k);!g&&n>f&&(n-=k)}k=n-f;Math.abs(k)>p&&(r=n,k=h,s=i,n=f+p*(g&&n>f?1:-1),h=l+c*Math.cos(n),i=m+d*Math.sin(n),r=this.pathAtoC(h,i,c,d,e,0,g,k,s,[n,r,l,m]),k=n-f);e=4*Math.tan(k/4)/3;c*=e;d*=e;r=[[a-c*Math.sin(f),b+d*Math.cos(f)],[h+c*Math.sin(n),i-d*Math.cos(n)],[h,i]].concat(r);if(j)return r;var U=[],z=Math.cos(t),w=Math.sin(t);r.forEach(function(a){U.push(a[0]*z-a[1]*w);U.push(a[0]*w+a[1]*z)});return U},transformPath:function(a,
b,c){function d(a,b,c){var d=b[0],e=[d];if(/z/i.test(d))a.pt0=$.extend({},a.sub0),a.pt1=$.extend({},a.sub1);else{var f,m=a.pt0;/[VH]/.test(d)&&(e[0]="L");for(var n=1;n<b.length;n+=2)"V"==d?m.y=b[n]:"H"==d?m.x=b[n]:thr0.setXY(m,b[n],b[n+1]),f=a.trafo.apply(m),e[n]=f.x,e[n+1]=f.y;c&&(e=thrSvg.pathDataToRelative(a.pt1.x,a.pt1.y,e));a.pt1=f;"M"===d&&(a.sub0=$.extend({},a.pt0),a.sub1=$.extend({},a.pt1))}return e}var e={pt0:{x:0,y:0},pt1:{x:0,y:0},sub0:{x:0,y:0},sub1:{x:0,y:0},trafo:b},f=[];this.pathToData(a).forEach(function(a){var b=
/[achlmqstv]/.test(a[0]),c=e.pt0;a=b?this.pathDataToAbsolute(c.x,c.y,a):a;if("A"===a[0])for(c=this.pathAtoC(c.x,c.y,a[1],a[2],a[3],a[4],a[5],a[6],a[7]);6<=c.length;)f.push(d(e,["C"].concat(c.splice(0,6)),b));else f.push(d(e,a,b))},this);return this.dataToPath(f,c)}};V.prototype={move:function(a){if(a.clientX&&a.clientY){var b=this.textEd;b.sel(b.selStart,b.indexOfPoint(thrSvg.pointFromEvent(a,b.$svg[0],b.smgInv)))}},end:function(){this.textEd.$inp.focus()}};o.ThrSvgTextEditor=function(a,b,c,d,e,f){var g=
this;this.notifier=a;this.sd=b;this.selEnd=this.selStart=0;this.$svg=c.closest("svg");this.$inp=$("\x3ctextarea class\x3d'thrHiddenText' style\x3d'top: -1000px; left: 0px; width: "+d.width+"px; height: "+d.height+"px;'\x3e\x3c/textarea\x3e").appendTo(this.$svg.parent().parent()).blur(function(){g.close()}).on("input",function(a){g.input(a)}).css(e.getTextStyle()).keydown(function(a){g.keydown(a)});this.$g=c;this.mg=c[0].getCTM();c.parent().find(".sfsConnector").each(function(){thrSvg.addClass($(this),
"thrNoDisplay")});this.$cur=thrSvg.$appendElement(c.parent(),"rect",{width:"2"});this.mCurInv=this.$cur[0].getCTM().inverse();this.$selBkg=thrSvg.$appendElement(c.parent(),"g");thrSvg.addClass(this.$selBkg,"thrMultilineSelect");this.$selBkg.attr("fill",thrColors.colorStringToCssColor(thrColors.changeOpacity(e.color,30)));this.rect=d;this.text=e.clone();this.savText=e;this.padding=f;this.renderText()};ThrSvgTextEditor.prototype={renderText:function(){var a=this,b=this.$g.parent(),c=thr0.expandedRect(this.rect,
-this.padding.box);this.$g.remove();this.text.wi||(this.text.wi=this.text.getWrapInfos(b,c));this.tw=this.text.getTextWrapper();this.tw.tagInfos=[];this.$g=this.text.$createWrappedSvgText(b,c,this.padding.line,0,0,this.tw).dblclick(function(b){a.dblclick(b)});thrSvg.addClass(this.$g,"thrSelText");this.mg=this.$g[0].getCTM();this.smgInv=this.$g[0].getScreenCTM().inverse();this.$inp.val(this.text.tx)},adjustGui:function(a){this.$inp[0].selectionStart=Math.min(this.selStart,this.selEnd);this.$inp[0].selectionEnd=
Math.max(this.selStart,this.selEnd);this.selStart===this.selEnd?(this.hideMultilineSelect(),a?this.adjustCursor(this.selStart):this.showCursor()):(this.hideCursor(),this.showMultilineSelect())},adjustCursor:function(a){a=this.charExt(a);var b=this.mCurInv.multiply(this.mg),b="matrix("+b.a+","+b.b+","+b.c+","+b.d+","+b.e+","+b.f+")";this.$cur.attr({height:a.height,x:a.x-1,y:a.y,transform:b}).css("fill",this.$g.css("fill"));this.showCursor();this.$selBkg.empty().attr("transform",b)},showCursor:function(){thrSvg.removeClass(this.$cur,
"thrTextCursorOff");thrSvg.addClass(this.$cur,"thrTextCursorBlink")},hideCursor:function(){thrSvg.removeClass(this.$cur,"thrTextCursorBlink");thrSvg.addClass(this.$cur,"thrTextCursorOff")},hideMultilineSelect:function(){this.$selBkg.empty()},tagText:function(a){var b=this.tw.tagInfos;return this.text.tx.substring(b[a].ix,a+1<b.length?b[a+1].ix:void 0)},indexOfTagInfo:function(a){var b,c=this.tw.tagInfos;for(b=1;b<c.length&&!(c[b].ix>a);b++);return b-1},charExt:function(a){var b=this.tw.tagInfos,c=
this.indexOfTagInfo(a),d=b[c].box;a=a-b[c].ix-b[c].l;var e=this.tagText(c).trim();return 0>a?{x:d.x+this.tw.spaceWidth*a,y:d.y,height:d.height,width:this.tw.spaceWidth}:a<e.length?b[c].t.getExtentOfChar(a):{x:d.x+d.width+this.tw.spaceWidth*(a-e.length),y:d.y,height:d.height,width:this.tw.spaceWidth}},showMultilineSelect:function(){var a,b,c,d,e,f=this.tw.tagInfos,g=Math.min(this.selStart,this.selEnd),h=Math.max(this.selStart,this.selEnd);this.$selBkg.empty();c=this.indexOfTagInfo(g);d=this.indexOfTagInfo(h);
for(a=c;a<=d;a++)a===d&&f[a].ix>=h||(b=f[a].box,e={x:b.x,y:b.y,height:b.height},a===c&&g!==f[a].ix+f[a].l?e.x=this.charExt(g).x:a!==c&&f[a].l&&(e.x=this.charExt(f[a].ix).x),a<d||a+1>=f.length&&h>=this.text.tx.length||a+1<f.length&&h>=f[a+1].ix?(b=this.charExt((a<d?f[a+1].ix:h)-1),e.width=b.x+b.width-e.x):e.width=this.charExt(h).x-e.x,this.$selBkg.append(thrSvg.$createElement("rect",e)))},indexOfPoint:function(a,b){var c,d,e,f=0,g=this.tw.tagInfos;for(d=g.length-1;0<=d;d--)if(c=g[d].box,a.y>=c.y){if(f&&
g[f].box.y>c.y)break;f=d;if(a.x>=c.x)break}if(a.y<g[f].box.y){for(d=f+1;d<g.length&&g[d].box.y<=g[f].box.y&&g[d].box.x<a.x;d++);f=d-1}c=g[f].box;d=g[f].ix+g[f].l;if(a.x<=c.x)return d-Math.min(Math.round((c.x-a.x)/this.tw.spaceWidth),g[f].l);if(a.x>=c.x+c.width){if(!g[f].t)return d;e=this.tagText(f);return d+Math.min(e.trim().length+Math.round((a.x-(c.x+c.width))/this.tw.spaceWidth),e.length-(b?1:0)-g[f].l)}if(a.y<c.y||a.y>=c.y+c.height)a.y=c.y+c.height/2;c=g[f].t.getCharNumAtPosition(a);0<=c&&(f=
g[f].t.getExtentOfChar(c),2*(a.x-f.x)>f.width&&c++);return d+c},sel:function(a,b,c,d){this.selStart=a;this.selEnd=b;c&&this.renderText();this.adjustGui(!0);d&&this.$inp.focus()},startSelectText:function(a){if(a)return new V(this,a);this.sel(0,this.text.tx.length,!0,!0)},startTyping:function(a){a?(this.text.tx+=a,this.text.wi=void 0,a=this.text.tx.length,this.sel(a,a,!0,!0)):this.sel(0,this.text.tx.length,!0,!0)},close:function(a,b){a&&(this.text=this.savText,this.renderText());this.$inp.remove();
this.$cur.remove();this.$selBkg.remove();this.$g.parent().find(".sfsConnector").each(function(){thrSvg.removeClass($(this),"thrNoDisplay")});this.notifier&&this.notifier.notifyEndTextEdit(this.sd,a?this.savText:this.text,a||this.text.tx===this.savText.tx,b)},dblclick:function(){for(var a=/[\x00-\x26\x28-\x2f\x3a-\x40\x7b-\xbf]/,b=/[ \-]/,c=this.text.tx,d=this.selStart,e=d;0<d&&!a.test(c.charAt(d-1));)d--;for(;e<c.length&&!a.test(c.charAt(e));)e++;for(;e<c.length&&b.test(c.charAt(e));)e++;this.sel(d,
e)},input:function(){this.text.tx=this.$inp.val();this.text.wi=void 0;this.sel(this.$inp[0].selectionStart,this.$inp[0].selectionEnd,!0)},keydown:function(a){var b=a.which||a.keyCode;if(37<=b&&40>=b)this.arrowkeydown(b,a.shiftKey,a.ctrlKey),thr0.breakEvent(a);else if(a.ctrlKey&&65===b)this.sel(0,this.text.tx.length),thr0.breakEvent(a);else if(27===b||9===b)this.close(27===b,27===b?void 0:a.shiftKey?-b:b),thr0.breakEvent(a)},arrowkeydown:function(a,b,c){var d,e,f=!1;e=/[\s\-]/;d=!b&&(37===a||38===
a)?this.selStart:this.selEnd;var g=this.text.tx;if(37===a){if(!b&&this.selStart>this.selEnd&&(d=this.selEnd),0<d&&d--,c)for(;0<d&&!e.test(g.charAt(d-1));)d--}else if(39===a){if(!b&&this.selStart>this.selEnd&&(d=this.selStart),d<g.length&&d++,c){for(;d<g.length&&!e.test(g.charAt(d));)d++;for(;d<g.length&&e.test(g.charAt(d));)d++}}else c=this.$svg[0].createSVGPoint(),(e=0<d&&d!==Math.min(this.selStart,this.selEnd))&&d--,d=this.charExt(d),thr0.setXY(c,d.x+(e?d.width:0),d.y+d.height*(38==a?-1:3)/2),d=
this.indexOfPoint(c);this.selEnd=d;b||(this.selStart=d,f=!0);this.adjustGui(f)}};o.thrShapes={ntx:{text:"Text",justText:"just text",shapesDragHint:"Hint: Drag an item onto the diagram."},resources:[{url:"resources/images/thrShapes.json",vnr:14}],emptyMeta:{uuid:"meta",resources:[],groups:[]},shapesButton:{uuid:0,title:"Shape",d:"M 23.53,8.00345 A 16,16 0 0 0 8,24.0035 a 16,16 0 0 0 16,16 l 0,16 32,0 0,-32 -16,0 A 16,16 0 0 0 23.53,8.00345 z"},defaultShapeRect:{x:0,y:0,width:48,height:48},activeSubGroup:0,
init:function(a){this.getShape("meta",function(b){thrShapes.updateShapes(b,a)})},updateShapes:function(a,b){function c(){!--e&&b&&b()}var d=this,e=0;a||(a={uuid:"meta",resources:[],groups:[]});this.meta=a;this.resources.forEach(function(f){var g=f.url.split("/").pop(),g=a.resources?thr0.arrayObjByKey(a.resources,"filename",g):void 0;if((g?g.vnr:-1)<f.vnr)e++,$.getJSON(thr0.makeUrl(f.url),function(b){d.putShapesToBrowserDB(a,b,c)}).fail(c);!e&&b&&b()})},mergeMeta:function(a,b){var c,d,e=thr0.removeKeyFromArray(a.groups,
"uuid","root"),f=thr0.removeKeyFromArray(b.groups,"uuid","root"),g=thr0.removeKeyFromArray(a.groups,"uuid","000");b.resources&&(a.resources||(a.resources=[]),b.resources.forEach(function(b){thr0.removeKeyFromArray(a.resources,"filename",b.filename);a.resources.push($.extend({},b))}));if(e&&f){for(c=e.subgroups.length-1;0<=c;c--)d=thr0.arrayObjByKey(a.groups,"uuid",e.subgroups[c]),(!d||!d.subgroups)&&e.subgroups.splice(c,1);f.subgroups.forEach(function(a){0>e.subgroups.indexOf(a)&&e.subgroups.push(a)})}b.groups.forEach(function(b){thr0.removeKeyFromArray(a.groups,
"uuid",b.uuid)});a.groups=a.groups.concat(b.groups);if(g){for(c=g.shapes.length-1;0<=c;c--)this.firstShapeGroup(a.groups,g.shapes[c])&&g.shapes.splice(c,1);g.shapes.length&&a.groups.push(g)}a.groups.unshift(e||f)},putShapesToBrowserDB:function(a,b,c){function d(a){var d=thr0.removeKeyFromArray(b,"uuid","meta");d&&(thrShapes.mergeMeta(a,d),b.unshift(a));thrDatastore.brwsr.saveSimpleList("shapes",b,c)}a?d(a):this.getShape("meta",function(a){d(a||thrShapes.emptyMeta)})},getShape:function(a,b){thrDatastore.brwsr.loadSimpleData("shapes",
!0,a,b)},getMaxShapeId:function(){return this.meta.groups.reduce(function(a,b){var c=b.shapes?b.shapes.reduce(function(a,b){var c=parseInt(b,10);return isNaN(c)?a:Math.max(a,c)},-1):-1;return Math.max(a,c)},-1)},getRootSubGroups:function(){var a=this.meta;return thr0.arrayObjByKey(a.groups,"uuid","root").subgroups.map(function(b){return thr0.arrayObjByKey(a.groups,"uuid",b)})},firstShapeGroup:function(a,b){return thr0.findInArray(a,function(a){return a.shapes&&0<=a.shapes.indexOf(this.uuid)},{uuid:b})},
getGroupsTitles:function(a){return a.map(function(a){return a.title[thrNtx.iso639_1]||a.title.en})},getGroupedShapes:function(a,b){var c=[],d=this.meta,e=thr0.arrayObjByKey(d.groups,"uuid","root"),f=thr0.arrayObjByKey(d.groups,"uuid",e.subgroups[this.activeSubGroup]).subgroups.map(function(a){return thr0.arrayObjByKey(d.groups,"uuid",a)});(e=thr0.arrayObjByKey(d.groups,"uuid","000"))&&f.push(e);f.forEach(function(a){c=c.concat(a.shapes)});a&&0>a.indexOf("groups")&&a.push("groups");thrDatastore.brwsr.listSimpleData("shapes",
!0,a,function(a){var c=f.map(function(b){var c={uuid:b.uuid,title:b.title[thrNtx.iso639_1]||b.title.en,shapes:[]};b.shapes.forEach(function(b){if(b=thr0.arrayObjByKey(a,"uuid",b))b.title=b.title[thrNtx.iso639_1]||b.title.en,c.shapes.push(b)});return c});b(c)},function(a){return 0<=c.indexOf(a.uuid)})},getShapeTextCount:function(a){return!a?1:a.moreTexts?a.moreTexts.length+1:a.textrect?1:a.spec?a.spec.hasOwnProperty("tx")?1:a.spec.v?a.spec.v.length+1:a.spec.h?a.spec.h.length+1:1:1},getShapeTextrect:function(a,
b,c,d,e,f,g,h){var i=!b&&1<d&&6!==d,j=a?a.spec:void 0,k=b&&a&&a.moreTexts&&b<=a.moreTexts.length?a.moreTexts[b-1].rect:a?a.textrect:void 0;if(j&&"sankey"===j.cmd){if(j.n){var l=thr0.round100(Math.tan((180-(j.angle||120))*thr0.deg2rad/2)*c[j.auto]/2),m=j.rot||0;c["width"===j.auto?"height":"width"]+=l;315<=m||45>=m?c.x-=l:225<m&&(c.y-=l)}}else if(k)j=a&&a.bounds?a.bounds:this.defaultShapeRect,l=c.width/j.width,m=c.height/j.height,k={x:(k.x-j.x)*l+c.x,y:(k.y-j.y)*m+c.y,width:k.width*l,height:k.height*
m};else if(j)if(b=j.hasOwnProperty("tx")?j.tx:b||0,j.doubleLine&&(c=thr0.expandedRect(c,-Math.min(j.doubleLine,c.width/2,c.height/2))),k={x:c.x,y:c.y,width:c.width,height:c.height},j.h){var n=k.y;j.h.forEach(function(a,c){n=a.dy?n+a.dy*(a.relative?k.y+k.height-n:1):k.y+(0>a.y?k.height:0)+a.y*(a.relative?k.height:1);c===b?k.height=n-k.y:c+1===b&&(k.height-=n-k.y,k.y=n)})}else if(j.v){var p=k.x;j.v.forEach(function(a,c){p=a.dx?n+a.dx*(a.relative?k.x+k.width-p:1):k.x+(0>a.x?k.width:0)+a.x*(a.relative?
k.width:1);c===b?k.width=p-k.x:c+1===b&&(k.width-=p-k.x,k.x=p)})}if(!a||i||!k)k=thr0.expandedRect(c,-Math.round(c.width/24)),a&&a.bounds&&(a=a.bounds,a.cx&&(k.x+=(a.cx-(2*a.x+a.width/2))*c.width/a.width),a.cy&&(k.y=(a.cy-(2*a.y+a.height/2))*c.height/a.height));if(i){if(i=d&1)k.x-=(f-k.width)/2;k.width=f;k.height<h&&(k.height=h);i?(k.height=g,k.y=c.y+(5===d?c.height:-k.height)):(e=Math.round(e/3),2===d?(c.x<k.width+e&&(k.width=Math.max(c.x-e,h)),k.x=c.x-k.width-e):k.x=c.x+e+c.width,k.y+=(c.height-
k.height)/2);k.width<h&&(k.width=h)}return k},hasConPts:function(a){return a&&(a.pts||a.spec&&a.spec.auto)},getConPts:function(a,b,c){if(a.spec.auto){var d=thr0.rectCenter(b),e=thr0.normalizeAngle((a.spec.rot||0)-(b.rot||0));b=("width"===a.spec.auto?b.height:b.width)/2+c;a="sankey"===a.spec.cmd&&a.spec.n;return[$.extend(thr0.movedPt(d,e,-b),{dir:thr0.reverseAngle(e),std:!0,force:a?"in":void 0}),$.extend(thr0.movedPt(d,e,b),{dir:e,std:!0,force:a?"out":void 0})]}},canSnapToFrame:function(a){return!a||
!a.spec||"sankey"!==a.spec.cmd},getAutoProp:function(a){return a&&a.spec?a.spec.auto:void 0},getArrowAngle:function(a){return a&&a.spec&&"sankey"===a.spec.cmd?a.spec.angle||(1===a.spec.n?120:180):void 0},hasSizableAngle:function(a){return a&&a.spec&&"sankey"===a.spec.cmd&&1===a.spec.n},getShapeBounds:function(a,b,c){if(a=a&&a.spec?a.spec.auto:void 0){var d="width"===a?"x":"y";b[d]=thr0.rectCenter(b)[d]-c/2;b[a]=c}return b},getShapePath:function(a,b,c){return a?a.spec?this.specToPath(a.spec,b||a.bounds||
this.defaultShapeRect,c,!b):a.d:""},specToPath:function(a,b,c,d){function e(a,b,c,d,e,f){function g(b,c,d,e){var f=b.width*(c?1:0.375)/2;b=b.height*(c?0.375:1)/2;var h=thr0.rectCenter(a);return{x:h.x-(f-(c?0:e*b/d)),y:h.y-(b-(c?e*f/d:0)),width:2*f,height:2*b}}var h="width"===d;e=2*Math.tan(thr0.intoRange(e||(b?120:180),10,180)*thr0.deg2rad/2);f=thr0.rectPoints(f?g(a,h,e,10<c&&260>c?-1:1):a);h&&f.push(f.shift());if(b){b=thr0.centeredPt(f);var h=thr0.distance(f[0],f[1])/2,i=a[d]/e;10<c&&260>c&&(h=-h);
a.rot&&(c+=a.rot);f=f.map(function(a){return thr0.movedPt(a,c,-i)});f.splice(2,0,thr0.movedPt(b,c,h));f.splice(5,0,thr0.movedPt(b,c,-h))}return thrSvg.pathFromPtArray(f)+"Z"}for(var f="",g=a.doubleLine||0,h=a.rot||0,i=c?{x:0,y:0,width:b.width*c,height:b.height*c}:$.extend({},b),j=Math.min((a.rx||a.ry||0)+g/2,i.width/2),k=Math.min((a.ry||a.rx||0)+g/2,i.height/2),l=g?1:0;0<=l;l--){switch(a.cmd){case "sankey":f+=e(i.rot?{x:i.x,y:i.y,width:i.width,height:i.height}:i,a.n||0,h,a.auto,a.angle,d);break;case "ellipse":var m=
thr0.rectCenter(i),f=f+thrSvg.ellipsePath(m.x,m.y,i.width/2,i.height/2);break;case "polygon":f+=thrSvg.polygonPath(i,a.n||3,h);break;default:f+=thrSvg.rectPath(i.x,i.y,i.width,i.height,j,k)}l&&(f+=" ",j=Math.max(0,j-g),k=Math.max(0,k-g),i=thr0.expandedRect(i,-Math.min(g,i.width/2,i.height/2)))}if(a.h){var n=i.y;a.h.forEach(function(a){n=a.dy?n+a.dy*(a.relative?i.y+i.height-n:1):i.y+(0>a.y?i.height:0)+a.y*(a.relative?i.height:1);f+=" M "+i.x+","+n+" l "+i.width+",0 z"})}else if(a.v){var p=i.x;a.v.forEach(function(a){p=
a.dx?n+a.dx*(a.relative?i.x+i.width-p:1):i.x+(0>a.x?i.width:0)+a.x*(a.relative?i.width:1);f+=" M "+p+","+i.y+" l 0,"+i.height+" z"})}c&&(f=thrSvg.transformPath(f,new ThrSvgTrafo([1/c,0,0,1/c,b.x,b.y])));return f+(a.d||"")}};thrNtx.register(thrShapes);M.prototype={getThrEvent:function(a,b){return $.Event(b,{droptype:"shape",act:this,clientX:a.clientX,clientY:a.clientY,value:this.s,$g:this.$g})},startDragging:function(){var a,b={position:"absolute",cursor:"move","pointer-events":"none"};this.justText?
this.$drag=this.$tx.clone().appendTo($("body")).css(b):(a=this.$g.find("path"),this.$drag=$(thrSvg.svgHtml(24,24,"0 0 48 48",!0,"largeShape")).appendTo($("body")).css(b),a=$(a.get(0)),a.hasClass("thrNoLine")&&(thrSvg.$appendElement(this.$drag,"path",{"class":"thrSvgShape thrNoLine",d:a.attr("d")}),a=a.next()),thrSvg.$appendElement(this.$drag,"path",{"class":"thrSvgShape"+(a.hasClass("thrLineGraphic")?" thrLineGraphic":""),d:a.attr("d")}),a=a.next(),a.length&&"none"!==a.css("display")&&thrSvg.$appendElement(this.$drag,
"path",{"class":"thrSvgShape",d:a.attr("d")}))},move:function(a){if(this.s&&(this.$drag||5<Math.abs(this.pt.x-a.clientX)||5<Math.abs(this.pt.y-a.clientY))){var b=$(document.elementFromPoint(a.clientX,a.clientY));this.pt={x:a.clientX,y:a.clientY};this.$drag||this.startDragging();this.$drag.css({left:Math.max(this.pt.x-12,0),top:Math.max(this.pt.y-12,0)});this.acceptDropShape&&b.is(".thrAreaHead")&&b.closest(".thrAccordeon").length?thrUI.accordeon.expand(b.closest(".thrAccordeon"),b.parent()):b.trigger(this.getThrEvent(a,
"thrdragover"))}},end:function(a,b){this.$shapePicker&&this.$shapePicker.removeData("dragging");this.$drag&&(this.$drag.remove(),this.$temp&&this.$temp.remove(),b||$(document.elementFromPoint(a.clientX,a.clientY)).trigger(this.getThrEvent(a,"thrdrop")))}};thrUI.shapePickerPanel={fieldcount:2,create:function(a,b){var c,d=a.data("value"),e=a.data("preview-x");a.data("prop");var f=_h.div("",{"data-options":thrShapes.getGroupsTitles(thrShapes.getRootSubGroups()).join(","),"data-value":thrShapes.activeSubGroup,
style:"width: 120px; float: right;"});b=b||a;c=$(_h.div(_h.span(thrShapes.ntx.text,"thrShapePureText"),{style:"padding: 4px; margin: 8px 0;"})).appendTo(b).click(function(){var b=a.data("prop1")||"";b&&a.trigger($.Event("change",{prop:b,value:!0}))});thrUI.setActionMaker(c.find("span"),function(a){return new M(a,!0)});thrUI.dropdownSelect.create($(f).appendTo(c).change(function(a){thrShapes.activeSubGroup=a.value;thrUI.shapePicker.refresh($(a.target).parent().parent().closest("div").find(".thrIx0"),
void 0,!1,!0)}));c=$(_h.div("","thrIx0")).appendTo(b).change(function(b){var c=a.data("prop");c?b.prop=c.replace(/\.uuid$/,""):b.$g&&(thrUI.showHint(b.$g,thrShapes.ntx.shapesDragHint),thr0.breakEvent(b))});thrUI.shapePicker.create(c,b.innerWidth()-15);c.data("control","shapePicker");void 0!==e&&thrUI.shapePicker.setPreviewX(c,e);void 0!==d&&thrUI.shapePicker.fill(c,d);return b},fill:function(a,b,c,d){a.data("value"+(c?c:""),b);c?(a=a.find(".thrShapePureText"),b?a.addClass("thrSelected"):a.removeClass("thrSelected")):
(d=d||a.find(".thrIx0"),d.length&&thrUI.shapePicker.fill(d,b))},getValue:function(a,b){var c=a.data("value"+(b?b:""));return 0===b?parseInt(c,10):c}};thrUI.ddShapePicker={fieldcount:2,create:function(a){a.parent().parent().parent().hasClass("thrTabpanel")?thrUI.tabpanel.createLazyTab(a.parent(),"ddShapePicker"):(thrUI.dropdownButton.create(a),a=a.children().first());a.addClass("thrSvgIcon").append("\x3csvg width\x3d'24' height\x3d'24' viewBox\x3d'0 0 64 64'\x3e\x3cpath class\x3d'thrNoLine' d\x3d'' transform\x3d'translate(4,4)' style\x3d'display:none;'/\x3e\x3cpath d\x3d'"+
thrShapes.shapesButton.d+"' transform\x3d'translate(4,4)' /\x3e\x3cpath class\x3d'thrSvgIcon' d\x3d'' transform\x3d'translate(4,4)' style\x3d'display:none;'/\x3e\x3c/svg\x3e")},createLazySub:function(a,b){return thrUI.shapePickerPanel.create(a,b)},setButtonSvg:function(a,b){if(b){var c=a.parent(),d=c.find(".thrSvgIcon path:nth-child(2)").attr("d",thrShapes.getShapePath(b,void 0,2.25));b.lineGraphic?(thrSvg.addClass(d,"thrLineGraphic"),c.css("stroke-width",b.spec&&b.spec.boldLine?1.5*b.spec.boldLine:
"")):thrSvg.removeClass(d,"thrLineGraphic");c.find(".thrSvgIcon path:first-child").attr(b.nld?{d:b.nld}:{}).css("display",b.nld?"":"none");c.find(".thrSvgIcon path:last-child").attr(b.ld?{d:b.ld}:{}).css("display",b.ld?"":"none")}},fill:function(a,b,c){var d=this,e=a.parent().parent().parent(),e=(e.hasClass("thrTabpanel")?thrUI.tabpanel.tabToPanel(e,a.parent()):a.find("\x3e.thrDropdown")).find(".thrIx"+(c||0));!c&&a.hasClass("thrDropdownButton")&&(b?thrShapes.getShape(b,function(b){d.setButtonSvg(a,
b)}):this.setButtonSvg(a,this.shapesButton));return thrUI.shapePickerPanel.fill(a,b,c,e)},getValue:function(a,b){return thrUI.shapePickerPanel.getValue(a,b)}};thrUI.shapePicker={create:function(a,b,c,d){a.data("width",b);c&&a.data("prop",c);this.refresh(a,d,!0);a.click(function(a){thrUI.shapePicker.clickShape(a)}).change(function(a){thrUI.shapePicker.change(a)});thrUI.setActionMaker(a,function(a){if($(a.target).closest("g").length)return new M(a)})},refresh:function(a,b,c,d){thrShapes.getGroupedShapes("uuid title spec d ld nld bounds icon lineGraphic".split(" "),
function(e){var f=-1,g=Math.floor(a.data("width")/32),h,i=a.data("value"),j=thr0.getKeyArray(e,"title");c?(h=$(_h.div("","thrSmall")).appendTo(a.data("control","shapePicker")),thrUI.accordeon.create(h,j)):(h=a.find(".thrAccordeon"),f=d?-1:thrUI.accordeon.getValue(h),thrUI.accordeon.setHeadings(h.empty(),j));e.forEach(function(a,b){var c=h.find("\x3ediv:nth-child("+(b+1)+")").data("uuid",a.uuid),d=0,e=0,f=[],i=32*g,j=32*Math.ceil(a.shapes.length/g);a.uuid!==thrUI.shapePicker.expandedUuid&&c.addClass("thrCollapsed");
a.shapes.forEach(function(a,b){var c=" transform\x3d'"+(a.bounds&&a.bounds.initialSize&&0.5>=a.bounds.initialSize?"translate(20,20) scale(0.5,0.5)":"translate(8,8)")+"'";f.push("\x3cg data-uuid\x3d"+a.uuid+" class\x3d'thrSvgBtn' transform\x3d'translate("+d+","+e+")' data-title\x3d'"+a.title+"'\x3e\x3crect width\x3d'64' height\x3d'64' rx\x3d'3' ry\x3d'3' /\x3e"+(a.nld?"\x3cpath class\x3d'thrSvgShape thrNoLine' d\x3d'"+a.nld+"' "+c+" /\x3e":"")+"\x3cpath class\x3d'thrSvgShape"+(a.lineGraphic?" thrLineGraphic":
"")+"' d\x3d'"+(a.icon?a.icon:thrShapes.getShapePath(a,void 0,2.25))+"'"+c+(a.spec&&a.spec.boldLine?" style\x3d'stroke-width: "+1.5*a.spec.boldLine+";'":"")+" /\x3e"+(a.ld?"\x3cpath class\x3d'thrSvgShape' d\x3d'"+a.ld+"' "+c+" /\x3e":"")+"\x3c/g\x3e");0===(b+1)%g?(d=0,e+=64):d+=64});c.find("div").html("\x3csvg width\x3d'"+i+"' height\x3d'"+j+"' viewBox\x3d'0 0 "+2*i+" "+2*j+"'\x3e"+f.join("")+"\x3c/svg\x3e").mouseenter(function(a){thrUI.shapePicker.mouseenter(a)}).mouseleave(function(a){thrUI.shapePicker.mouseleave(a)}).find("g").mouseenter(function(a){thrUI.shapePicker.mouseenter(a)})});
0<=f&&thrUI.accordeon.fill(h,f);i&&thrUI.shapePicker.fill(a,i);b&&b()})},setPreviewX:function(a,b){var c=a.find(".thrShapePreview");a.data("preview-x",b);void 0===b?c.remove():(c.length||(c=$(_h.div(_h.div("","thrTitle"),"thrShapePreview")).appendTo(a),$(thrSvg.svgHtml(144,144,0,!0,"thrShapePreview","\x3cpath class\x3d'thrSvgShape thrNoLine'/\x3e\x3cpath class\x3d'thrSvgShape'/\x3e\x3cpath class\x3d'thrSvgShape'/\x3e")).prependTo(c)[0].setAttribute("viewBox","0 0 64 64")),c.css("left",b+"px").addClass("thrNoDisplay"))},
mouseenter:function(a){function b(a){return{d:a.attr("d"),transform:a.attr("transform")}}var c,d,e;e=$(a.currentTarget);a=e.closest(".thrAccordeon").parent();e.is("svg, g")&&!a.data("dragging")&&(a=a.find("\x3e.thrShapePreview"),a.length?(a.hasClass("thrNoDisplay")&&(a.removeClass("thrNoDisplay"),c=e.closest("svg")[0].getBoundingClientRect(),d=a[0].getBoundingClientRect(),a.css("top",c.top+(c.height-d.height)/2+"px")),e.is("g")&&(a.find(".thrTitle").text(e.data("title")),e=e.find(".thrSvgShape"),
c=$(e[0]).hasClass("thrNoLine"),a.find(".thrSvgShape:first-child").attr(c?b($(e[0])):{}).css("display",c?"":"none"),c=c?2:1,d=$(e[c-1]),d=a.find(".thrSvgShape:nth-child(2)").attr(b(d)).css("stroke-width",d.css("stroke-width")),e.hasClass("thrLineGraphic")?thrSvg.addClass(d,"thrLineGraphic"):thrSvg.removeClass(d,"thrLineGraphic"),a.find(".thrSvgShape:last-child").attr(e.length>c?b($(e[c])):{}).css("display",e.length>c?"":"none"))):e.is("g")&&e.closest("div").attr("title",e.data("title")))},mouseleave:function(a){$(a.currentTarget).closest(".thrAccordeon").parent().find("\x3e.thrShapePreview").addClass("thrNoDisplay")},
expandDefaultGroup:function(a,b){var c=this.expandedUuid,d=c?a.children().filter(function(){return $(this).data("uuid")===c}):b;d&&0<d.length&&thrUI.accordeon.expand(a,d)},fill:function(a,b){var c=a.find("\x3e.thrAccordeon"),d=c.find(".thrSelected");0<d.length&&thrSvg.removeClass(d,"thrSelected");a.data("value",b);b&&("0"!==b&&"("!==b.charAt(0)&&c.find(".thrArea").length)&&(d=c.find("[data-uuid\x3d"+b+"]"),thrSvg.addClass(d,"thrSelected"),this.expandDefaultGroup(c,d.parent().closest(".thrArea")))},
clickShape:function(a){var b,c;a=a||o.event;c=$(a.currentTarget);b=$(a.target).closest(".thrSvgBtn");0<b.length&&(thr0.breakEvent(a),thrShapes.getShape(b.attr("data-uuid"),function(a){var e=c.data("prop")||"";c.trigger($.Event("change",{isShape:!0,prop:e.replace(/\.uuid$/,""),value:a,$g:b}))}))},change:function(a){if(!a.isShape){var b=$(a.target);b.is(".thrAccordeon")&&(this.expandedUuid=b.find("\x3e*:not(.thrCollapsed)").data("uuid"));thr0.breakEvent(a)}}};o.thrRevisioning={defaultSuffix:".sankey",
ntx:{multipleValues:"(multiple values)",selected:"selected"},init:function(a,b){this.keyAdmin=a;this.objFactory=b;this.contextOp=new ThrContextOperator(a);this.diffOp=new ThrDiffOperator(a,b)}};thrNtx.register(thrRevisioning);o.ThrRevision=function(a){this.instantiate(a)};ThrRevision.prototype={instantiate:function(a){function b(a,b){var e=a[b];void 0!==e&&(""===e?a[b]=void 0:"string"===typeof e&&!/^(UNDO|_DELETE_)$/.test(e)&&(a[b]=JSON.parse(e)))}thr0.clearObject(this);this.dt=(new Date).toJSON();
a&&($.extend(this,a),b(this,"revData"),b(this,"diffData"),b(this,"undoData"))},getData:function(){var a={pos:this.pos};this.revData&&(a.revData=JSON.stringify(this.revData));this.diffData&&(a.diffData="string"===typeof this.diffData?this.diffData:JSON.stringify(this.diffData));return a}};o.ThrMetaRevision=function(a){this.instantiate(a)};ThrMetaRevision.prototype={pos:-1,userId:0,userName:"",instantiate:function(a){thr0.clearObject(this);if(!a||!a.dt)this.dt=(new Date).toJSON();a&&$.extend(this,a)},
getData:function(){var a={pos:this.pos,dt:this.dt,userId:this.userId};this.userName&&(a.userName=this.userName);this.gId&&(a.gId=this.gId);void 0!==this.undo&&(a.undo=this.undo);return a}};o.ThrTransaction=function(a,b){this.mc=a;this.diffOp=b};ThrTransaction.prototype={getRevObj:function(a,b){if(this.rev&&this.rev.objs)return thr0.findInArray(this.rev.objs,function(a){return a.id===this.id&&a.type===this.type},{id:a,type:b})},addRevision:function(a){a&&(this.rev?(!this.rev.meta&&a.meta&&(this.rev.meta=
a.meta),a.objs.forEach(function(a){var c=this.getRevObj(a.id,a.type);c?(c.diffData=this.diffOp.merge([c.diffData,a.diffData]),c.undoData&&a.undoData&&(c.undoData=this.diffOp.merge([a.undoData,c.undoData]))):this.rev.objs.push(a)},this)):a.objs&&a.objs.length&&(this.rev=a))}};o.ThrFileObject=function(a){this.instantiate(a)};ThrFileObject.prototype={type:"",id:0,instantiate:function(a){thr0.clearObject(this);this.loadedRevSlices=[];a&&$.extend(this,a);this.revisions=this.revisions?this.revisions.map(function(a){return new ThrRevision(a)}):
[];this.sessionRevs=this.sessionRevs?this.sessionRevs.map(function(a){return new ThrRevision(a)}):[]},initLoadedRevSlices:function(a){a.forEach(function(a){this.addLoadedRevSlice(a)},this)},removeUndoneRevs:function(a){function b(a){return!a.diffData&&a.revData}for(var c,d=0;d<a.length;)"UNDO"===a[d].diffData?d?a.splice(--d,2):a.splice(d,1):d++;for(d=a.length-1;0<=d;)(c=0<d&&"_DELETE_"===a[d].diffData)||0<d&&b(a[d])?(c=c&&a.slice(0,d).some(b),a.splice(0,c?d+1:d),d=-1):d--},removeSessionRevs:function(a){for(var b=
this.sessionRevs;0<b.length&&b[0].pos<=a;)b.shift()},removeNewerRevs:function(a){a&&void 0!==a.history?(this.sessionRevs=[],this.revisions=this.revisions.filter(function(b){return b.pos<=a.history})):a&&void 0!==a.done&&(this.sessionRevs=this.sessionRevs.filter(function(b){return b.pos<=a.done}),this.loadedRevSlices=this.loadedRevSlices.filter(function(a){if(a.a>this.done)return!1;a.z>this.done&&(a.z=this.done);return!0},a))},addLazyRevisions:function(a,b){var c,d=-1,e=this.revisions;if(a&&a.length){a[0].gId&&
(d=thr0.indexOfKey(e,"gId",a[0].gId));0>d&&(d=thr0.indexOfSorted(e,"pos",a[0].pos,!0));for(c=0;c<a.length;c++,d++){var f=a[c],g=d<e.length?e[d]:void 0;g&&(g.pos===f.pos||f.gId&&g.gId===f.gId)?(f.revData&&(g.revData=f.revData),f.diffData&&(g.diffData=f.diffData),f.gId&&(g.gId=f.gId)):e.splice(d,0,f)}}b&&b.forEach(function(a){this.addLoadedRevSlice(a)},this)},getLastRevDataIx:function(a){var b=this.revisions,c=thr0.indexOfSorted(b,"pos",a,!0);(c>=b.length||b[c].pos>a)&&c--;for(a=c;0<=a;a--)if(b[a].revData)return a;
return-1},getArrayData:function(a,b,c){a=this[a];var d=a.length;void 0===c&&(c=0<d?a[d-1].pos:-1);return a.filter(function(a){return a.pos>=this.a&&a.pos<=this.z},{a:Math.max(0,b||0),z:c}).map(function(a){return a.getData()})},isRevPosLoaded:function(a){return this.loadedRevSlices.some(function(a){return a.a<=this.pos&&this.pos<=a.z},{pos:a})},addLoadedRevSlice:function(a){this.loadedRevSlices.some(function(a){return a.a<=this.a&&a.z>=this.a?(a.z<this.z&&(a.z=this.z),!0):a.a<=this.z&&a.z>=this.z?
(a.a>this.a&&(a.a=this.a),!0):!1},a)||this.loadedRevSlices.push(a)}};o.ThrFile=function(a,b){this.instantiate(a);b&&(this.loader=b)};ThrFile.prototype={thrClsName:"File",userId:0,path:"",name:"",waitForResponse:!1,donePos:-1,synchDonePos:-1,undoIx:-1,redoIx:-1,lazyRevListPos:-1,instantiate:function(a){thr0.clearObject(this);this.transactions=[];a&&($.extend(this,a),void 0!==a.synchDonePos&&void 0===a.donePos&&(this.donePos=this.synchDonePos));this.uuid||(this.uuid=thr0.generateThrID(this.userId));
this.objs=(this.objs||[]).map(function(a){return new ThrFileObject(a)});this.metaRevs=(this.metaRevs||[]).map(function(a){return new ThrMetaRevision(a)});this.metaSesRevs=(this.metaSesRevs||[]).map(function(a){return new ThrMetaRevision(a)});this.updateUndoIx();this.undoIx!==this.metaSesRevs.length-1&&(this.redoIx=this.getUndoIx(this.metaSesRevs.length-1));this.synchDonePos=this.donePos},initLoadedRevSlices:function(){var a=[],b;this.metaRevs.forEach(function(c){b&&b.z+1===c.pos?b.z++:(b={a:c.pos,
z:c.pos},a.push(b))});this.objs.forEach(function(b){b.initLoadedRevSlices(a)})},removeUndoneMetas:function(a){for(var b=0;b<a.length;)a[b].undo?a.splice(--b,2):b++},getUndoIx:function(a){var b=0;for(a-=1;0<=a;a--)if(this.metaSesRevs[a].undo)b++;else if(0>--b)return a;return-1},updateUndoIx:function(){this.undoIx=this.getUndoIx(this.metaSesRevs.length)},getObjTypes:function(a){return(a||this.objs).reduce(function(a,c){0>a.indexOf(c.type)&&a.push(c.type);return a},[])},getObjList:function(a){return(a||
this.objs).map(function(a){return{type:a.type,id:a.id}})},indexOfObject:function(a,b){return thr0.findIndexInArray(b||this.objs,function(a){return a.type===this.type&&a.id===this.id},a)},getObject:function(a,b){var c=this.indexOfObject(a);if(0<=c)return this.objs[c];if(b)return c=new ThrFileObject({type:a.type,id:a.id}),this.objs.push(c),c},addLazyRevisions:function(a){a&&a.forEach(function(a){this.getObject(a,!0).addLazyRevisions(a.revisions,a.loadedRevSlices)},this)},loadlazyRevList:function(a,
b){if(-1===a||0<=this.lazyRevListPos||a===this.lazyRevListPos||!this.loader)b&&b(this);else{var c=this;this.loader.loadRevList(this,a,function(d){c.metaRevs=d.metaRevs.map(function(a){return a instanceof ThrMetaRevision?a:new ThrMetaRevision(a)});c.lazyRevListPos=a;b&&b(c)})}},loadLazyRevisions:function(a,b,c){var d=this;a={uuid:this.uuid,pos:b,objs:this.loader?a.filter(function(a){a=this.getObject(a);return!a||!a.isRevPosLoaded(b)},this):[]};if(a.objs.length){var e=thr0.indexOfSorted(this.metaRevs,
"pos",b);0<=e&&this.metaRevs[e].gId&&(a.gid=this.metaRevs[e].gId);this.loader.loadRevisions(a,function(a){d.addLazyRevisions(a.objs);c&&c()})}else c&&c()},getSuffixedName:function(a){return this.name.replace(thrRevisioning.defaultSuffix,"")+a},isEmptyRev:function(a){return!this.objs.some(function(b){return 0<=thr0.indexOfKey(b.revisions,"pos",a)})},getFileRev:function(a,b,c){var d=b?this.metaSesRevs:this.metaRevs,e=thr0.indexOfSorted(d,"pos",a);if(0<=e){var f={objs:[],meta:d[e].getData()};c&&d.splice(e,
1);this.objs.forEach(function(d){var e=b?d.sessionRevs:d.revisions,i=e?thr0.indexOfSorted(e,"pos",a):-1;0<=i&&(f.objs.push({type:d.type,id:d.id,revData:e[i].revData,diffData:e[i].diffData,undoData:e[i].undoData}),c&&e.splice(i,1))});return f}},getMainData:function(a){var b=this.editor;a=a?{uuid:this.uuid}:{uuid:this.uuid,userId:this.userId,path:this.path,name:this.name};b&&(a.editor={id:b.id,userId:b.userId,sessionId:b.sessionId,uuid:b.uuid});return a},getData:function(a){a=this.getMainData(a);a.metaRevs=
this.metaRevs.map(function(a){return a.getData()});a.metaSesRevs=this.metaSesRevs.map(function(a){return a.getData()});a.objs=this.objs.map(function(a){return{type:a.type,id:a.id,revisions:a.getArrayData("revisions"),sessionRevs:a.getArrayData("sessionRevs")}});return a},getSessionData:function(a,b){var c=this.metaSesRevs,d=c.length,d={a:Math.max(0,a||0),z:void 0!==b?b:0<d?c[d-1].pos:-1};return{metaSesRevs:c.filter(function(a){return a.pos>=this.a&&a.pos<=this.z},d).map(function(a){return a.getData()}),
objs:this.objs.map(function(a){return{type:a.type,id:a.id,sessionRevs:a.getArrayData("sessionRevs",this.a,this.z)}},d).filter(function(a){return a.sessionRevs&&a.sessionRevs.length})}},getLastRevPos:function(a){a=this[a||"metaRevs"];return a.length?a[a.length-1].pos:-1},getFileRevObj:function(a,b,c){var d=this.indexOfObject(b,a.objs);if(0<=d)return a.objs[d];if(c)return b={type:b.type,id:b.id,undoData:{}},a.objs.push(b),b},addRevision:function(a){var b=a.meta,c=b?b.pos:this.getLastRevPos()+1;this.metaRevs.push(b?
b instanceof ThrMetaRevision?b:new ThrMetaRevision(b):new ThrMetaRevision({userId:this.editor.userId,userName:this.editor.dispName,pos:c}));a.objs.forEach(function(a){var b=this.me.getObject(a,!0);b.revisions.push(new ThrRevision({pos:this.pos,diffData:a.diffData,revData:a.revData,undoData:a.undoData}));b.addLoadedRevSlice({a:this.pos,z:this.pos})},{me:this,pos:c})},addSessionRev:function(a){var b=a.meta,c=this.metaSesRevs;b?(c.push(b instanceof ThrMetaRevision?b:new ThrMetaRevision(b)),b.pos>this.donePos&&
(this.donePos=b.pos)):c.push(new ThrMetaRevision({userId:this.editor.userId,userName:this.editor.dispName,pos:++this.donePos}));a.objs.forEach(function(a){this.getObject(a,!0).sessionRevs.push(new ThrRevision({pos:this.donePos,diffData:a.diffData,revData:a.revData,undoData:a.undoData}))},this);this.updateUndoIx();this.redoIx=-1},removeSessionRevs:function(a){for(var b=this.metaSesRevs;0<b.length&&b[0].pos<=a;)b.shift();this.objs.forEach(function(b){b.removeSessionRevs(a)});b.length||(this.synchDonePos=
this.donePos=-1);this.updateUndoIx()},removeNewerRevs:function(a){a&&void 0!==a.history?(this.metaSesRevs=[],this.metaRevs=this.metaRevs.filter(function(b){return b.pos<=a.history}),this.donePos=-1):a&&void 0!==a.done&&(this.metaSesRevs=this.metaSesRevs.filter(function(b){return b.pos<=a.done}),this.donePos=a.done);this.synchDonePos=this.donePos;this.objs.forEach(function(b){b.removeNewerRevs(a)});this.updateUndoIx()},isHeadRevision:function(a,b){var c,d;c=this.metaRevs;var e=this.metaSesRevs;d=!a||
(e.length?e[e.length-1].pos===a.done:(c.length?c[c.length-1].pos:0)===a.history);if(!d&&b&&(void 0!==a.done||c.length&&c[c.length-1].pos===a.history)){c=void 0!==a.history?0:thr0.indexOfKey(e,"pos",a.done);for(d=0;c<e.length;c++)d+=e[c].undo?-1:1;d=0>=d}return d},getRevNo:function(a){return!a?this.metaRevs.length+this.metaSesRevs.length:void 0!==a.history?thr0.indexOfSorted(this.metaRevs,"pos",a.history)+1:thr0.indexOfSorted(this.metaSesRevs,"pos",a.history)+1+this.metaRevs.length},getObjsRevision:function(a,
b,c){var d,e=this,f=this.getLastRevPos("metaSesRevs");b?(d=void 0!==b.history?b.history:this.getLastRevPos(),f=void 0===b.done?-1:Math.min(b.done,f)):d=this.getLastRevPos();this.loadLazyRevisions(a,d,function(){var b=a.map(function(a){var b,c,g,l=e.getObject(a);l?(c=l.revisions,b=l.getLastRevDataIx(d),0<=b&&"_DELETE_"===c[b].revData&&(b=-1)):b=-1;if(0<=b){a=thrRevisioning.objFactory.newObject(a.type.toLowerCase()+"s");a.instantiate?a.instantiate(c[b].revData):$.extend(!0,a,c[b].revData);for(b+=1;a&&
b<c.length&&c[b].pos<=d;b++)g=c[b].diffData,"_DELETE_"===g?a=void 0:thrRevisioning.diffOp.apply(a,g);c=$.extend([],l.sessionRevs);l.removeUndoneRevs(c);for(b=0;a&&b<c.length&&c[b].pos<=f;b++)g=c[b].diffData,"_DELETE_"===g?a=void 0:(l=c[b].undoData?void 0:{},thrRevisioning.diffOp.apply(a,g,l),l&&(c[b].undoData=l))}else a=void 0;return a});c&&c(b)})},notifyDone:function(a,b){if(b&&b.objs&&b.objs.length){var c=this.transactions.length;if(0<c)this.transactions[c-1].addRevision(b);else{if(c=a.postProcessDiff(b,
thrRevisioning.diffOp))this.addSessionRev(b),thr0.notify("notifyFileChange",{file:a.file});return c}}},startTransaction:function(a){this.transactions.push(new ThrTransaction(a,thrRevisioning.diffOp))},cancelTransaction:function(){var a=this.transactions;a.length&&a.pop()},endTransaction:function(){var a=this.transactions,b=a.length;if(0<b){var c=a.pop();1<b&&a[b-2].addRevision(c.rev);this.notifyDone(c.mc,c.rev)}},hasSesRevConflict:function(a,b){b||(b=this.objs);return a.some(function(a){return b.some(function(b){var e;
if(e=a.type===b.type)if(e=a.id===b.id){var f=thrRevisioning.diffOp,g=b.sessionRevs||[{diffData:b.diffData}];e=(a.sessionRevs||[{diffData:a.diffData}]).some(function(a){return g.some(function(b){return f.isConflicting(a.diffData,b.diffData)})})}return e})})},applyFileRev:function(a,b){b.objs.forEach(function(b){var d=a.getManagedInstances(b);"_DELETE_"===b.diffData?(d.length&&(b.undoData=JSON.parse(JSON.stringify(d[0].obj))),a.deleteManagedInstances(b)):b.diffData?d.forEach(function(a){var d=b.undoData?
void 0:{};thrRevisioning.diffOp.apply(a.obj,b.diffData,d);d&&(b.undoData=d)}):(d.forEach(function(a){a.obj||(a.obj=thrRevisioning.objFactory.newObject(b.type.toLowerCase()+"s"));a.obj.instantiate(b.revData)}),b.undoData="_DELETE_")})},undoFileRev:function(a,b){b.objs.forEach(function(b){"_DELETE_"===b.undoData?a.deleteManagedInstances(b):b.undoData&&a.getManagedInstances(b).forEach(function(a){a.obj?thrRevisioning.diffOp.apply(a.obj,b.undoData):(a.obj=thrRevisioning.objFactory.newObject(b.type.toLowerCase()+
"s"),a.obj.instantiate(b.undoData))})});a.syncModel(b,!0,!0)},undo:function(a,b){var c,d=this.undoIx;0<=d&&(c=this.getFileRev(this.metaSesRevs[d].pos,!0),this.undoFileRev(a,c),c.meta.pos=++this.donePos,c.meta.undo=!0,c.objs.forEach(function(a){a.revData=void 0;a.undoData=void 0;a.diffData="UNDO"}),this.addSessionRev(c),this.redoIx=d,b||thr0.notify("notifyFileChange",{file:a.file,hint:"undo"}))},redo:function(a){if(0<=this.redoIx){var b=this.metaSesRevs[this.redoIx+1].undo?-1:this.redoIx+1,c=this.getFileRev(this.metaSesRevs[this.redoIx].pos,
!0);c.meta.pos=++this.donePos;this.applyFileRev(a,c);this.addSessionRev(c);a.syncModel(c,!0);this.redoIx=b;thr0.notify("notifyFileChange",{file:a.file,hint:"redo"})}},rollbackSessionRevs:function(a,b){var c,d,e=0;for(c=this.metaSesRevs.length-1;0<=c&&this.metaSesRevs[c].pos>=b;c--)d=this.getFileRev(this.metaSesRevs[c].pos,!0,!0),d.meta.undo?(this.applyFileRev(a,this.getFileRev(this.metaSesRevs[this.getUndoIx(c)].pos,!0)),a.syncModel(d,!0)):this.undoFileRev(a,d),this.donePos--,e++;0<e&&(0>=this.metaSesRevs.length&&
(this.donePos=-1),this.synchDonePos>this.donePos&&(this.synchDonePos=this.donePos))},applySyncSessionRevs:function(a,b){this.rollbackSessionRevs(a,b.metaSesRevs[0].pos);for(var c=0;c<b.metaSesRevs.length;c++){var d=b.getFileRev(b.metaSesRevs[c].pos,!0);d.meta.undo?this.undoFileRev(a,this.getFileRev(this.metaSesRevs[this.getUndoIx(this.metaSesRevs.length)].pos,!0)):(this.applyFileRev(a,d),a.syncModel(d,!0));this.addSessionRev(d)}this.synchDonePos=this.donePos;thr0.notify("notifyFileChange",{file:a.file})},
applySyncRevisions:function(a,b,c){b.metaRevs.forEach(function(a){this.me.addRevision(this.tf.getFileRev(a.pos,!1))},{me:this,tf:b});this.removeSessionRevs(c);thr0.notify("notifyFileChange",{file:a.file})},applySyncDelRevs:function(a,b){if(b.length){var c,d,e,f,g,h,i,j=this.metaRevs;c=j.length&&j[0].gId;d=0;for(c=c?thr0.indexOfKey(j,"gId",b[0]):thr0.indexOfSorted(j,"pos",parseInt(b[0],10),!0);c<j.length;){if(i)for(e=0;e<i.objs.length;e++)g=i.objs[e],f=this.getObject(g,!0),h=thr0.indexOfSorted(f.revisions,
"pos",j[c].pos),0<=h?(f=f.revisions[h],g.revData&&!f.revData&&("_DELETE_"===f.diffData?g.revData=f.diffData:thrRevisioning.diffOp.apply(g.revData,f.diffData,void 0,!0),f.revData=g.revData),f.diffData=thrRevisioning.diffOp.merge([g.diffData,f.diffData])):f.revisions.splice(h,0,new ThrRevision({pos:j[c].pos,revData:g.revData,diffData:g.diffData}));if(d<b.length&&(b[d]===j[c].gId||parseInt(b[d],10)===j[c].pos))i=this.getFileRev(j[c].pos,!1,!0),d++;else{i=void 0;if(d>=b.length)break;c++}}thr0.notify("notifyFileChange",
{file:a.file})}},errInvalidTransaction:{name:"InvalidTransaction",message:"Don't apply diffs to different model controllers in a transaction!"},applyDiff:function(a,b,c){var d=this.transactions.length;b={objs:[{type:b.type,id:b.id,diffData:c}]};if(0<d&&this.transactions[d-1].mc!==a)throw this.errInvalidTransaction;this.applyFileRev(a,b);return this.notifyDone(a,b)},applyNewObj:function(a,b,c){var d=this.transactions.length;b={objs:[{type:b.type,id:b.id,revData:c}]};if(0<d&&this.transactions[d-1].mc!==
a)throw this.errInvalidTransaction;this.applyFileRev(a,b);this.notifyDone(a,b)},mergeSessionRevsToRevision:function(a){var b=-1,c=this.metaSesRevs.length-1;if(0<=c){var b=this.metaSesRevs[c],d={meta:a||b.getData(),objs:[]};d.meta.hasOwnProperty("undo")&&delete d.meta.undo;d.meta.pos=this.getLastRevPos()+1;b=b.pos;this.objs.forEach(function(a){a.removeUndoneRevs(a.sessionRevs);if(0<a.sessionRevs.length){var b,c,h=[];a.sessionRevs.forEach(function(a){a.revData?(c=a.revData,h=[]):h.push(a.diffData)});
h.length&&(b=thrRevisioning.diffOp.merge(h));c?("_DELETE_"===b?c=b:b&&thrRevisioning.diffOp.apply(c,b,void 0,!0),d.objs.push({type:a.type,id:a.id,revData:c})):d.objs.push({type:a.type,id:a.id,diffData:b})}});this.addRevision(d);this.removeSessionRevs(b)}return b},mergeRevisions:function(){this.metaRevs.splice(0,this.metaRevs.length-1);this.metaRevs[0].pos=0;this.objs.forEach(function(a){var b,c=[],d=a.revisions,e=d.length;if(e){for(a=e-1;0<=a&&!d[a].revData;a--);b=0<=a?d[a].revData:void 0;for(a++;a<
e;a++){var f=d[a].diffData;b?"_DELETE_"===f?b=f:thrRevisioning.diffOp.apply(b,f,void 0,!0):c.push(f)}d.splice(0,e-1);b?(d[0].revData=b,d[0].diffData=void 0):d[0].diffData=thrRevisioning.diffOp.merge(c);d[0].pos=0}})},createRevDataIfNEx:function(a){this.objs.forEach(function(b){var c,d=b.revisions,e=thr0.indexOfKey(d,"pos",a);if(0<=e&&!d[e].revData){for(b=e-1;0<=b&&!d[b].revData;b--);if(0<=b){c=$.extend(!0,{},d[b].revData);for(b++;b<=e;b++){var f=d[b].diffData;"_DELETE_"===f?c=f:thrRevisioning.diffOp.apply(c,
f,void 0,!0)}d[e].revData=c}}})},isEditorOwner:function(){var a=this.editor&&this.shareInfos?thr0.arrayObjByKey(this.shareInfos.accessInfos,"userId",this.editor.userId):void 0;return a&&0===a.userRight}};o.ThrKeyAdmin=function(a,b){this.k=$.extend({},a);this.a=$.extend([],b||[])};ThrKeyAdmin.prototype={key:function(a){return this.k[a]},isAtomic:function(a){return 0<=this.a.indexOf(a)}};o.ThrObjFactory=function(a){$.extend(this,a)};ThrObjFactory.prototype={newObject:function(a){return this[a]?this[a]():
{}}};o.ThrDiffOperator=function(a,b){this.keyAdmin=a;this.objFactory=b};ThrDiffOperator.prototype={merging:0,getNewObj:function(a){return this.merging||!this.objFactory?{}:this.objFactory.newObject(a)},createDelUndoDiff:function(a,b,c,d,e){if(!d||0>d.indexOf(a))d=thr0.indexOfKey(c,b,a),0<=d&&(c=JSON.parse(JSON.stringify(c[d])),d=thr0.indexOfKey(e,b,a),0<=d?e.splice(d,1,this.apply(c,e[d])):e.push(c))},idArrayApply:function(a,b,c,d,e){var f,g,h,i,j,k,l,m=b[c];f=0;var n=-1;if(e){if(!e.hasOwnProperty(c)||
void 0===e[c])e[c]=[];i=e[c];0<i.length&&void 0!==i[0].delIds&&(l=i[0].delIds)}if(0<d.length&&void 0!==d[0].delIds&&(j=d[0].delIds,f=1,e&&(!e.hasOwnProperty(c)||void 0!==e[c])))for(b=0;b<j.length;b++)this.createDelUndoDiff(j[b],a,m,l,i);this.merging&&(j&&(1>m.length||void 0===m[0].delIds)&&m.unshift({delIds:[]}),1<=m.length&&void 0!==m[0].delIds&&(k=m[0].delIds));for(b=f;b<d.length;b++)h=void 0,f=d[b][a],g=thr0.indexOfKey(m,a,f),i&&(n=thr0.indexOfKey(i,a,f)),0>g?(e&&0>n&&(l||(l=[],i.unshift({delIds:l})),
0>l.indexOf(f)&&l.push(f)),g=m.length,m.push(this.getNewObj(c)),k&&thr0.removeFromArray(k,f)):e&&(0>n?(h={},h[a]=f,i.push(h)):h=i[n]),this.apply(m[g],d[b],h);if(void 0!==j)for(b=0;b<j.length;b++)c=j[b],thr0.removeKeyFromArray(m,a,c),k&&thr0.pushIfNEx(k,c);k&&!k.length&&m.shift()},arrayApply:function(a,b,c,d){var e=this.keyAdmin.key(b);a[b]||(d&&!d.hasOwnProperty(b)&&(d[b]="_DELETE_"),a[b]=[]);void 0!==e?this.idArrayApply(e,a,b,c,d):(d&&!d.hasOwnProperty(b)&&(d[b]=a[b].map(function(a){return"object"===
typeof a?JSON.parse(JSON.stringify(a)):a})),a[b]=c.map(function(a){return"object"===typeof a?this.apply(this.getNewObj(b),a):a},this))},propApply:function(a,b,c,d){if($.isArray(c))this.arrayApply(b,a,c,d);else if(!this.merging&&(void 0===c||"_DELETE_"===c))b.hasOwnProperty(a)&&(c=b[a],void 0!==c&&(d&&!d.hasOwnProperty(a))&&(d[a]="object"===typeof c?JSON.parse(JSON.stringify(c)):c),delete b[a]);else if("object"===typeof c){var e=this.keyAdmin.isAtomic(a);d&&!d.hasOwnProperty(a)&&(d[a]=!b.hasOwnProperty(a)||
void 0===b[a]?"_DELETE_":e?$.extend(!0,{},b[a]):{});e?b[a]=$.extend(!0,{},c):(b[a]||(b[a]=this.getNewObj(a)),this.apply(b[a],c,d&&"_DELETE_"!==d[a]?d[a]:void 0))}else if(b[a]!==c)if(e="set"+thr0.firstCharToUpperCase(a),d&&!d.hasOwnProperty(a)&&(d[a]=void 0===b[a]?"_DELETE_":b[a]),b[e])b[e](c);else b[a]=c},apply:function(a,b,c,d){if(b&&!$.isEmptyObject(b)){var e=this.objFactory;d&&(this.objFactory=void 0);try{if($.isArray(b))for(var f=0;f<b.length;f++)this.apply(a,b[f],c);else for(f in b)b.hasOwnProperty(f)&&
this.propApply(f,a,b[f],c)}finally{d&&(this.objFactory=e)}}return a},merge:function(a){if(0<a.length){this.merging++;try{return a.some(function(a){return"_DELETE_"===a})?"_DELETE_":a.reduce(function(a,c){a.d=a.d?a.me.apply(a.d,c):c;return a},{me:this}).d}finally{this.merging--}}},isConflictingIdArray:function(a,b,c){var d=0;if(0<b.length&&void 0!==b[0].delIds&&(d=1,b[0].delIds.some(function(b){return 0<=thr0.indexOfKey(c,a,b)}))||0<c.length&&void 0!==c[0].delIds&&c[0].delIds.some(function(c){return 0<=
thr0.indexOfKey(b,a,c)}))return!0;for(;d<b.length;d++){var e=thr0.arrayObjByKey(c,a,b[d][a]);if(e&&this.isConflicting(b[d],e))return!0}return!1},isConflictingArray:function(a,b,c){a=this.keyAdmin.key(a);return void 0!==a?this.isConflictingIdArray(a,b,c):JSON.stringify(b)!==JSON.stringify(c)},isConflictingProp:function(a,b,c){return $.isArray(b)?$.isArray(c)?this.isConflictingArray(a,b,c):!1:void 0===b||"_DELETE_"===b?void 0===c||"_DELETE_"===c:"object"===typeof b&&!$.isEmptyObject(b)?"object"===typeof c&&
!$.isEmptyObject(c)?this.keyAdmin.isAtomic(a)?JSON.stringify(b)!==JSON.stringify(c):this.isConflicting(b,c):!0:b!=c},isConflicting:function(a,b){if(!a||$.isEmptyObject(a)||!b||$.isEmptyObject(b))return!1;if("UNDO"===a||"UNDO"===b)return!0;if($.isArray(a))return this.isConflictingArray("",a,b);for(var c in a)if(a.hasOwnProperty(c)&&b.hasOwnProperty(c)&&this.isConflictingProp(c,a[c],b[c]))return!0;return!1},optimizeDiffArray:function(a,b,c){if(c){for(var d=b.length-1;0<=d;d--){var e=b[d],f=e[c],g=thr0.indexOfKey(a,
c,f);0<=g&&(this.optimizeDiff(a[g],e)?e[c]=f:b.splice(d,1))}return b.length?b:void 0}return JSON.stringify(a)===JSON.stringify(b)?void 0:b},optimizeDiff:function(a,b){if(b&&!$.isEmptyObject(b)){if("UNDO"===b)return b;for(var c in b)if(b.hasOwnProperty(c)){var d=b[c],e=a[c];e&&($.isArray(d)?!this.optimizeDiffArray(e,d,this.keyAdmin.key(c)):"object"===typeof d?!this.optimizeDiff(e,d):e===d)&&delete b[c]}return $.isEmptyObject(b)?void 0:b}},createIdArrayDiff:function(a,b,c){var d=c.map(function(c){return this.createDiff(thr0.arrayObjByKey(b,
a,c[a]),c,a)},this).filter(function(a){return void 0!==a}),e=thr0.getKeyArray(b,a,function(b){return 0>thr0.indexOfKey(c,a,b[a])});e.length&&d.unshift({delIds:e});if(d.length)return d},createArrayDiff:function(a,b,c){a=this.keyAdmin.key(a);return void 0!==a?this.createIdArrayDiff(a,b,c):thr0.equalObjects(b,c)?void 0:JSON.parse(JSON.stringify(c))},createPropDiff:function(a,b,c){if(void 0!==b||void 0!==c){if(void 0===c)return"_DELETE_";if($.isArray(b)||$.isArray(c))return this.createArrayDiff(a,b,c);
if("object"===typeof b||"object"===typeof c)return this.keyAdmin.isAtomic(a)?thr0.equalObjects(b,c)?void 0:JSON.parse(JSON.stringify(c)):this.createDiff(b,c);if(b!==c)return c}},createDiff:function(a,b,c,d){var e,f,g={};if(void 0===a||void 0===b)return void 0!==b?JSON.parse(JSON.stringify(b)):void 0!==a?"_DELETE_":void 0;for(f in b)if(b.hasOwnProperty(f)&&c!==f&&(!d||0>d.indexOf(f)))e=this.createPropDiff(f,a[f],b[f]),void 0!==e&&(g[f]=e);for(f in a)if(a.hasOwnProperty(f)&&!b.hasOwnProperty(f)&&c!==
f&&(!d||0>d.indexOf(f)))e=this.createPropDiff(f,a[f],void 0),void 0!==e&&(g[f]=e);if(!$.isEmptyObject(g))return c&&b.hasOwnProperty(c)&&(g[c]=b[c]),g},objectUnion:function(a,b,c){var d=$.isArray(a)?[]:{},e;for(e in a)if(a.hasOwnProperty(e)&&b.hasOwnProperty(e)){var f=a[e],g=b[e];if("object"===typeof f&&"object"===typeof g)f=this.objectUnion(f,g,c),$.isEmptyObject(f)||(d[e]=f);else if(c?c(f,g,e):f===g)d[e]=f}return d}};o.ThrContextOperator=function(a){this.keyAdmin=a};ThrContextOperator.prototype=
{propResolve:function(a,b,c){b=b?b[a]:void 0;if(!b)return[];if($.isArray(b)){var d=this.keyAdmin.key(a);if(d){var e=[];c=c[a];if($.isArray(c)){for(var f=0;f<c.length;f++){var g=c[f];"object"===typeof g?(a=thr0.arrayObjByKey(b,d,g[d]),void 0!==a&&(e=e.concat(this.resolve(a,g,d)))):(a=thr0.arrayObjByKey(b,d,g),void 0!==a&&e.push(a))}return e}a=thr0.arrayObjByKey(b,d,c);return void 0!==a?a:[]}return[]}return"object"===typeof b?this.resolve(b,c[a]):[]},resolve:function(a,b,c){var d,e=[];if(!b||!a||"object"!==
typeof b||$.isEmptyObject(b))return a?[a]:[];if($.isArray(b))for(c=0;c<b.length;c++)e=e.concat(this.resolve(a,b[c]));else for(d in b)b.hasOwnProperty(d)&&(a.hasOwnProperty(d)&&d!==c)&&(e=e.concat(this.propResolve(d,a,b)));e.length||e.push(a);return e},resolvePathProp:function(a,b){var c,d,e,f,g,h;if(!(void 0===a||void 0===b||$.isArray(a)&&0>=a.length||"object"!==typeof a)){if(!$.isArray(a)){g=b.split(".");f=a;for(c=0;c<g.length;c++){if("object"!==typeof f)return;h=g[c];d=h.indexOf("(");0<=d?(e=parseInt(h.slice(d+
1,h.indexOf(")")),10),h=h.slice(0,d),f=f[h],d=thr0.indexOfKey(f,this.keyAdmin.key(h),e),0<=d&&(f=f[d])):f=f[h]}return f}if("selection"===b)return a.length+" "+thr0.getThrClsCaption(a)+" "+thrRevisioning.ntx.selected;d=f="object"===typeof a[0]?this.resolvePathProp(a[0],b):void 0;for(c=1;c<a.length&&void 0!==f&&f===d;c++)d="object"===typeof a[c]?this.resolvePathProp(a[c],b):void 0;d!==f&&"number"!==typeof d&&(f=thrRevisioning.ntx.multipleValues);return f}},diffFromPropPathVal:function(a,b,c){function d(a,
b){var c={};c[a]=b;return c}if(void 0!==a&&"object"===typeof a){var e=b.shift(),f=e.indexOf("(");if(0<=f){var g=parseInt(e.slice(f+1,e.indexOf(")")),10),e=e.slice(0,f),f=this.keyAdmin.key(e);if(a=this.diffFromPropPathVal((a[e]?thr0.arrayObjByKey(a[e],f,g):void 0)||{},b,c))return a[f]=g,d(e,[a])}else if(b.length){if(g=this.diffFromPropPathVal(a[e]||{},b,c))return d(e,g)}else if(a[e]!==c)return d(e,void 0===c?"_DELETE_":c)}}};o.thrMath={ntx:{paramName:"Parameter name",mathError:"Math error",errInvalidExpr:"Invalid mathematical expression",
errUnknownParam:"Unknown parameter",errXExpected:" was expected",errFactor:"Number, function or parameter expected",errBoolExpr:"Invalid logical expression",errCircularref:"Unresolvable circular reference!",errReserved:"is a reserved denominator.",errInvalidCtx:"ERROR invalid context!",errSetIndirFixed:"Can't set the indirectly fixed value of",errEmptyFunc:"Function is not initialized!",rootType:"Diagram",selParam:"Select a parameter"},rexFixed:/^[xy]$/};thrNtx.register(thrMath);o.ThrMathOp=function(a){a&&
$.extend(this,a)};ThrMathOp.prototype={setOperands:function(a){void 0!==this.v&&delete this.v;void 0!==this.r&&delete this.r;this.x=a},addOperand:function(a){this.x?this.x.push(a):this.setOperands([a])},isEqual:function(a){return!(a instanceof ThrMathOp)?!1:this.r?a.r&&thr0.equalArrays(this.r,a.r):a.r?!1:this.f===a.f&&(this.x?this.x.length:0)===(a.x?a.x.length:0)&&(void 0===this.v||x(this.v,a.v))&&this.x.every(function(a,c){return a.isEqual(this[c])},a.x)},clone:function(){var a=new ThrMathOp;this.r?
a.r=$.extend(!0,[],this.r):(void 0!==this.v&&(a.v=this.v),this.f&&(a.f=this.f),this.x&&this.x.length&&(a.x=this.x.map(function(a){return a.clone()})));return a},value:function(a,b){var c,d=[],e=0,f=this.x?this.x.length:0;if(void 0!==this.v)return this.v;if(this.r)return a.valueOf(b,this.r);for(c=f-1;0<=c;c--){e=this.x[c].value(a,b);if("number"!==typeof e)return e;d.unshift(e)}e=f?d[0]:0;switch(this.f.toLowerCase()){case "(":return e;case "+":for(c=1;c<f;c++)e+=d[c];return e;case "-":for(c=1;c<f;c++)e=
x(e,d[c])?0:e-d[c];return e;case "*":for(c=1;c<f;c++)e*=d[c];return e;case "/":for(c=1;c<f;c++)e=0===d[c]?0:e/d[c];return e;case "^":if(0>e&&-1<d[1]&&1>d[1]||0===e&&0>d[1])break;return Math.pow(e,d[1]);case "and":for(c=0;c<f;c++)if(!d[c])return 0;return 1;case "or":for(c=0;c<f;c++)if(d[c])return 1;break;case "\x3e":return 1===(x(e,d[1])?0:e>d[1]?1:-1)?1:0;case "\x3c":return-1===(x(e,d[1])?0:e>d[1]?1:-1)?1:0;case "\x3d":return x(e,d[1])?1:0;case "#":return x(e,d[1])?0:1;case "\x3e\x3d":return-1!==
(x(e,d[1])?0:e>d[1]?1:-1)?1:0;case "\x3c\x3d":return 1!==(x(e,d[1])?0:e>d[1]?1:-1)?1:0;case "if":return d[0]?d[1]:d[2];case "sin":return Math.sin(e);case "cos":return Math.cos(e);case "tan":return Math.tan(e);case "asin":return Math.asin(e);case "acos":return Math.acos(e);case "atan":return Math.atan(e);case "rad":return e*thr0.deg2rad;case "deg":return e/thr0.deg2rad;case "ceil":return Math.ceil(e);case "floor":return Math.floor(e);case "abs":return Math.abs(e);case "exp":return Math.exp(e);case "int":case "round":return 1<
f&&d[1]?Math.round(e/d[1])*d[1]:Math.round(e);case "sqrt":return Math.sqrt(e);case "sqr":return e*e;case "max":return Math.max.apply(null,d);case "min":return Math.min.apply(null,d);case "log":return Math.log(e)}return 0},toString:function(a,b,c,d){var e,f,g;f=/^(display|edit)$/.test(c);if(void 0!==this.v)return f?thr0.formatLocalFloat(this.v,"edit"===c):this.v.toString();if(this.r){e=(d?d.length:0)-1;f=this.r.slice(0);for(g=!0;0<e;e--)g&&f.length&&".."===d[e]&&".."===f[0]?f.unshift():(g=!1,f.shift(d[e]));
return a.pathToString(b,f,c)}if(!this.x||!this.x.length)return this.f+"()";if("("===this.f)return"("+this.x[0].toString(a,b,c,d)+")";e=this.x.map(function(e){return e.toString(a,b,c,d)});return/^(\+|\-|\*|\/|\^|and|or|>|<|=|#|>=|<=)$/i.test(this.f)?e.join(f?" "+this.f+" ":this.f):this.f+"("+e.join(f?thr0.listSep+" ":",")+")"},uses:function(a,b,c){if(this.r){var d=q(b,this.r),e=a.getPO(d);return e===c?!0:e&&e.f&&e.f instanceof ThrMathOp?e.f.uses(a,d.slice(0,d.length-1),c):!1}return this.x&&this.x.some(function(d){return d.uses(a,
b,c)})},addUsages:function(a,b){this.r?a.addUsage(q(b,this.r,1),b):this.x&&this.x.forEach(function(c){c.addUsages(a,b)})},releaseUsages:function(a,b){this.r?a.releaseUsage(q(b,this.r,1),b):this.x&&this.x.forEach(function(c){c.releaseUsages(a,b)})},replaceRefByVal:function(a,b){this.r&&thr0.equalArrays(this.r,a)?(delete this.r,this.v=b):this.x&&this.x.forEach(function(c){c.replaceRefByVal(a,b)})},collectRefs:function(a,b,c){function d(a,b){return a.some(function(a){return thr0.arrayStartsWith(this,
a)},b)}if(this.r){var e=q(a,this.r,1);!d(b,e)&&!d(c,e)&&b.push(e)}else this.x&&this.x.forEach(function(d){d.collectRefs(a,b,c)})},createMathOp:function(a,b){var c=this.createExpressionOp(a,b,0,0);if(c.op&&(c.ix>=b.length||""===b.slice(c.ix).trim()))return c.op;c.err||(c.err=thrMath.ntx.errInvalidExpr);c.op&&delete c.op;return c},processFormula:function(a,b){var c=this.createMathOp(a,b);return c.err?b:c.toString(a.mEnv,a.ctx)},mergeCreateResults:function(a,b,c){a.op.f===b?a.op.addOperand(c.op):a.op=
new ThrMathOp({f:b,x:[a.op,c.op]});a.ix=c.ix},createExpressionOp:function(a,b,c,d){var e,f,g=d?2===d?/^[\^]$/:/^[\*\/]$/:/^[\+\-]$/,h=b.length;if(3<=d)return this.createFactorOp(a,b,c);for(e=this.createExpressionOp(a,b,c,d+1);e.op&&e.ix<h;){c=b.charAt(e.ix);if(!g.test(c))break;f=this.createExpressionOp(a,b,e.ix+1,d+1);if(!f.op)return f;this.mergeCreateResults(e,c,f)}return e},createFactorOp:function(a,b,c){var d=thr0.scanBlanks(b,c),e=this.createParenthesesOp(a,b,d.ix,0);!e.op&&!e.err&&(e=this.createNumberOp(a,
b,d.ix),!e.op&&!e.err&&(e=this.createFuncOp(a,b,d.ix),!e.op&&!e.err&&(e=this.createRefOp(a,b,d.ix))));!e.op&&!e.err&&(e.err=thrMath.ntx.errFactor,e.ix=c);return e},createBoolExprOp:function(a,b,c,d){var e=this.createParenthesesOp(a,b,thr0.scanBlanks(b,c).ix,1);if(!e.op)for(var f=b.length,g=d?/^(\=|<|>|<=|>=|#)$/:/^(and|or)$/i,e=d?this.createExpressionOp(a,b,c,0):this.createBoolExprOp(a,b,c,d+1);e.op&&e.ix<f;){var h,i=thr0.scanChars(b,"aAnNdDoOrR\x3d\x3c\x3e#",e.ix);i.result=i.result.toUpperCase();
if(i.ix===e.ix||!g.test(i.result))break;h=d?this.createExpressionOp(a,b,i.ix,0):this.createBoolExprOp(a,b,i.ix,d+1);if(!h.op)return h.err||(h.err=thrMath.ntx.errBoolExpr,h.ix=c),h;this.mergeCreateResults(e,i.result,h)}return e},createParenthesesOp:function(a,b,c,d){var e=b.length;if(c>=e||"("!==b.charAt(c))return{};a=d?this.createBoolExprOp(a,b,c+1,0):this.createExpressionOp(a,b,c+1,0);return!a.op?a:a.ix>=e||")"!==b.charAt(a.ix)?{err:")"+thrMath.ntx.errXExpected,ix:a.ix,ix2:a.ix+1}:{ix:thr0.scanBlanks(b,
a.ix+1).ix,op:new ThrMathOp({f:"(",x:[a.op]})}},createNumberOp:function(a,b,c){a=thr0.scanFloat(b,c,a.isUIString?thr0.decSep:".");return a.ix<=c?{}:{ix:thr0.scanBlanks(b,a.ix).ix,op:new ThrMathOp({v:a.result})}},createFuncOp:function(a,b,c){var d,e=a.isUIString?thr0.listSep:",",f=[],g=thr0.scanDenom(b,c),h=g.result,i=b.length;if(g.ix===c||g.ix>=i||"("!==b.charAt(g.ix))return{};g=thr0.scanBlanks(b,g.ix+1);for("if"===h.toLowerCase()&&(d=[1,0,0]);g.ix<i&&")"!==b.charAt(g.ix);){c=d&&d.length>f.length&&
d[f.length]?this.createBoolExprOp(a,b,g.ix,0):this.createExpressionOp(a,b,g.ix,0);if(!c.op)return c;f.push(c.op);g=thr0.scanBlanks(b,c.ix);if(g.ix<i)if(b.charAt(g.ix)===e)g=thr0.scanBlanks(b,g.ix+1);else if(")"!==b.charAt(g.ix))return{err:e+" or )"+thrMath.ntx.errXExpected,ix:g.ix,ix2:g.ix+1}}g=thr0.scanBlanks(b,g.ix+1);return{ix:g.ix,op:new ThrMathOp({f:h,x:f})}},createRefOp:function(a,b,c){var d,e,f,g=[];f=c;f+1<b.length&&("."===b[f]&&"."===b[f+1])&&(g.push(".."),f+=2);for(;;){c=thr0.scanDenom(b,
f);if(c.ix===f&&(c=thr0.scanQuotedStr(b,f),c.ix===f))if(1===g.length&&".."==g[0])break;else return 0<g.length?{err:thrMath.ntx.paramName+thrMath.ntx.errXExpected,ix:f}:{};if(!a.pathMap){d||(d=a.mEnv.getPO(q(a.ctx,g))||{});if(a.isUIString){f=thr0.unquotedString(c.result.toLowerCase());for(e in d)if(d.hasOwnProperty(e)&&d[e].t&&d[e].t.toLowerCase()===f){d=d[e];c.result=e;f=void 0;break}f&&(d={})}else d=d[c.result]||{};if($.isEmptyObject(d))return{err:thrMath.ntx.errUnknownParam,ix:c.ix-c.result.length,
ix2:c.ix}}g.push(c.result);f=c.ix;if("."===b.charAt(f))f++;else break}if(a.pathMap)if(e=q(a.ctx,g),d=thr0.findIndexInArray(a.pathMap,function(a){return thr0.arrayStartsWith(this,a.from)},e),0<=d)g=y(a.ctx,a.pathMap[d].to.concat(e.slice(a.pathMap[d].from.length,e.length)));else if(a.refVals&&!a.mEnv.getPO(e))for(d=a.refVals.length-1;0<=d;d--)if(thr0.equalArrays(a.refVals[d].p,e))return{ix:thr0.scanBlanks(b,f).ix,op:new ThrMathOp({v:a.refVals[d].v})};return{ix:thr0.scanBlanks(b,f).ix,op:new ThrMathOp({r:g})}}};
J.prototype={adj:0,group:"",clone:function(){var a=new J($.extend(!0,[],this.a),this.adj);void 0!==this.autoAdj&&(a.autoAdj=this.autoAdj);this.group&&(a.group=this.group);return a},setAdjustableIx:function(a){a<this.a.length&&(this.adj=a)},getAdjustableIx:function(){return void 0!==this.autoAdj?this.autoAdj:this.adj},indexOfPath:function(a){var b,c;if($.isArray(a))for(b=this.a.length-1;0<=b;b--){if(c=this.a[b][0],$.isArray(c)&&thr0.equalArrays(c,a))return b}else for(b=this.a.length-1;0<=b;b--)if(c=
this.a[b][0],!$.isArray(c)&&x(c,a))return b;return-1},addUsages:function(a,b){this.a.forEach(function(c){$.isArray(c[0])&&a.addUsage(q(b,c[0],1),b);0<c.length&&$.isArray(c[1])&&a.addUsage(q(b,c[1],1),b)})},releaseUsages:function(a,b){this.a.forEach(function(c){$.isArray(c[0])&&a.releaseUsage(q(b,c[0],1),b);0<c.length&&$.isArray(c[1])&&a.releaseUsage(q(b,c[1],1),b)})},isEqual:function(a){return a instanceof J&&this.a.length===a.a.length&&this.adj===a.adj&&this.group===a.group&&a.a.every(function(a){var c=
this.indexOfPath(a[0]);if(0>c||this.a[c].length!==a.length)return!1;if(0<a.length){c=this.a[c];if("number"===typeof c[1]){if("number"!==typeof a[1]||!x(c[1],a[1]))return!1}else if(!thr0.equalArrays(c[1],a[1]))return!1;if(3===a.length&&!x(c[2],a[2]))return!1}return!0},this)},getFactor:function(a,b,c){c=this.a[c];var d=c["number"===typeof c[0]?0:1];return"number"===typeof d?d:(2<c.length?c[2]:1)*a.valueOf(b,d)},getVal:function(a,b,c){var d=this.a[c][0];return"number"===typeof d?d:a.valueOf(b,d)*this.getFactor(a,
b,c)},invalidateElements:function(a,b,c){var d=!1,e=this.triggerIx;this.a.forEach(function(f,g){if(g!==c&&g!==e&&$.isArray(f[0])){var h=q(b,f[0],1),i=a.getPO(h);if(!i.d||3===i.d)d=!0,a.invalidatePath(h,b,!0)}});d||a.invalidEndNodes.push(b)},propagate:function(a,b){var c=this.getAdjustableIx();if(0<=c&&c<this.a.length){var d=q(b,this.a[c][0]),e=a.getPO(d);if(this.triggerIx===c||void 0===this.autoAdj&&e.d)this.reversePropagate(a,b),void 0!==this.triggerIx&&delete this.triggerIx,"i"===e.s&&delete e.s;
else{for(var f=0,g=-this.getFactor(a,b,c),h=0,i=this.a.length;h<i;h++)h!==c&&(f+=this.getVal(a,b,h));!g&&f?a.error(b,"overdetermined"):g?e&&a.setPO(e,d,f/g):e&&"i"===e.s&&delete e.s;void 0!==this.triggerIx&&delete this.triggerIx}}},isValid:function(a,b){var c,d,e,f=0,g=0;c=0;for(d=this.a.length;c<d;c++)e=this.getVal(a,b,c),f+=e,g=Math.max(g,Math.abs(e));return Math.abs(f)<1E-9*g},reversePropagate:function(a,b){var c,d,e;c=this.getAdjustableIx();var f=void 0===this.triggerIx?c:this.triggerIx,g=this.a.length,
h=[],i=[],j=[],k=0,l=0,m=0;if(0<=c&&c<this.a.length){for(c=0;c<g;c++)$.isArray(this.a[c][0])?(h.push(q(b,this.a[c][0])),e=a.getPO(h[c]),i.push(e||0),j.push(c===f?a.valueOf(b,this.a[c][0]):e?e.v||0:0),d=this.getFactor(a,b,c)*j[c],c!==f&&(e&&!e.d)&&(m++,l+=d)):(d=this.a[c][0],i.push(0),j.push(d)),k+=d;!m&&!this.isValid(a,b)&&a.error(b,"overdetermined");d=l?(l-k)/l:-k/(m||1);for(c=0;c<g;c++)e=i[c],!m||!k?e&&"i"===e.s&&delete e.s:c!==f&&(e&&!e.d)&&a.setPO(e,h[c],l?j[c]*d:j[c]+d*this.getFactor(a,b,c))}},
addMultiplier:function(a,b){var c=this.indexOfPath(a);0<=c&&this.a[c].unshift(b)},removeMultiplier:function(a){a=this.indexOfPath(a);0<=a&&this.a[a].shift()},changeElNames:function(a,b,c,d){this.a.forEach(function(e){if($.isArray(e[0])&&(e=a.getPO(q(b,e[0])))&&e.t)for(var f=c.length-1;0<=f;f--)if(c[f]===e.t.slice(0,c[f].length)){e.t=c[f]+d;break}})},addToMatrix:function(a,b,c){var d=0,e={},f=b.slice(0,b.length-1),g=y(c.ctx,f);this.a.forEach(function(b,i){var j=b[0];if($.isArray(j)){var j=c.getKey(g.length?
q(g,j):j,!0),k=c.keys[j],l=this.getFactor(a,f,i);c.isFixed(k)?d+=k.v*l:e[j]=(e[j]||0)+l}else d+=j},this);e.p=b.slice(0);d&&(e.v=d);c.addRow(e)},replaceRefByVal:function(a,b){var c,d;this.a.forEach(function(e){for(c=e.length-1;0<=c;c--)"number"!==typeof e[c]&&thr0.equalArrays(a,e[c])&&(e.splice(c,1),(d=e.length)?e[d-1]*=b:e.push(b))})}};O.prototype={clear:function(a,b){a&&(this.ctx=a);this.qp=[];this.inodes=b},addEq:function(a){this.qp.push(a)},clone:function(){var a=new O(this.ctx,this.d,$.extend(!0,
[],this.inodes));a.qp=$.extend(!0,[],this.qp);return a},invalidate:function(a){this.s||(a&&(this.tp=y(this.ctx,a)),this.s="i")},propagate:function(a,b){if(this.qp.length&&!this.active){this.active=!0;try{var c,d,e,f=a.getMatrix(this.ctx),g=f.keys,h=[];this.tp&&(d=q(this.ctx,this.tp),(e=a.getPO(d))&&(e.q&&0<=e.q.triggerIx)&&a.valueOf(d.slice(0,d.length-1),e.q.a[e.q.triggerIx][0]));this.inodes.forEach(function(a){g[f.addKey(a)].noGet=!0},this);b&&(g[f.getKey(y(this.ctx,b,0),!0)].noGet=!0);for(c=this.qp.length-
1;0<=c;c--)if(d=q(this.ctx,this.qp[c]),(e=a.getPO(d))&&e.q)e.q.addToMatrix(a,d,f),h.push(e);f.solve();f.setPOValues(a);h.forEach(function(a){"i"===a.s&&delete a.s;void 0!==a.q.triggerIx&&delete a.q.triggerIx});this.s&&delete this.s;this.tp&&delete this.tp}finally{this.active=!1}}}};W.prototype={clear:function(a){this.ctx=a;this.nodes=[];this.edges=[]},getNodeIx:function(a,b){for(var c,d=this.nodes,e=d.length-1;0<=e;e--)if(c=d[e],thr0.equalArrays(c.p,a))return b&&(c.d=1),e;c=this.mEnv.getPO(q(this.ctx,
a));return d.push({p:a,po:c,d:b||N(c)?1:0})-1},addEquation:function(a,b){for(var c={q:a,p:b,nIndexes:[]},d=b.slice(0,b.length-1),e=0,f=a.a.length;e<f;e++)c.nIndexes.push(this.getNodeIx(d.concat(a.a[e][0])));this.edges.push(c)},indexOfEdge:function(a){return thr0.findIndexInArray(this.edges,function(a){return thr0.equalArrays(a.p,this)},a)},addMult:function(a){this.edges.forEach(function(b){for(var c=b.nIndexes.length-1;0<=c;c--){var d=this.nodes[b.nIndexes[c]];thr0.arrayStartsWith(d.p,a.ctx)&&a.regExp.test(d.p[d.p.length-
1])&&(b.nIndexes[c]=this.nSc)}},{nodes:this.nodes,nSc:this.getNodeIx(q(a.ctx,a.p))})},removeMult:function(a){var b=q(a.ctx,a.p);a.eqsi.forEach(function(a){var b=this.mg.indexOfEdge(a.qp);if(0<=b){var e=this.mg.edges[b];e.nIndexes=e.nIndexes.filter(function(a){return a!==this.nSc},this);a.q.a.forEach(function(a){thr0.equalArrays(a[0],this.np)&&e.nIndexes.push(this.mg.getNodeIx(a[1]))},this)}},{mg:this,np:b,nSc:this.getNodeIx(b)})},applyChanges:function(a){[{p:"unfix",fn:function(a){this.nodes[this.getNodeIx(a)].d=
0}},{p:"removeMultiplier",fn:function(a){this.removeMult(a)}},{p:"removeEq",fn:function(a){a=this.indexOfEdge(a.qp);0<=a&&this.edges.splice(a,1)}},{p:"addEq",fn:function(a){this.edges.push({p:a.qp,nIndexes:a.pList.map(function(c,d){return this.getNodeIx(c,a.fixList&&a.fixList[d])},this)})}},{p:"removeFromEq",fn:function(a){thr0.removeFromArray(this.edges[this.indexOfEdge(a.qp)].nIndexes,this.getNodeIx(a.p))}},{p:"addToEq",fn:function(a){this.edges[this.indexOfEdge(a.qp)].nIndexes.push(this.getNodeIx(a.p,
a.fix))}},{p:"addMultiplier",fn:function(a){this.addMult(a)}},{p:"fix",fn:function(a){this.nodes[this.getNodeIx(a)].d=1}}].forEach(function(b){a.hasOwnProperty(b.p)&&a[b.p].forEach(b.fn,this)},this)},analyze:function(){var a={nTodo:[],eTodo:[]};this.detectIndirectFixes(a);this.detectSystems(a);this.detectIndirectFixes(a);this.syncSysInfos(a.sysInfos)},isOverDetermined:function(){var a={nTodo:[],eTodo:[]};if(this.detectIndirectFixes(a,!0))return!0;this.detectSystems(a);return this.detectIndirectFixes(a,
!0)},checkSys:function(a,b,c,d){var e={mg:this,sysCount:0};if(void 0!==d&&b.checking===d)return 0;c=c||[];if(b.passed++)return thr0.pushIfNEx(c,d),1;b.nIndexes.forEach(function(e){var g=this.mg.nodes[e].eIndexes;e!==d&&g&&g.forEach(function(d){d=this.mg.edges[d];d!==b&&void 0===d.sysno&&(b.checking=e,this.sysCount+=this.mg.checkSys(a,d,c,e),b.checking=void 0)},this)},e);e.sysCount&&(b.sysno=a.length,e.sysCount+=1-b.passed,!e.sysCount||void 0===d?a.push({nodes:[],inodes:c}):thr0.pushIfNEx(c,d));return e.sysCount},
detectSystems:function(a){a.sysInfos=[];a.nTodo.forEach(function(a){this[a].eIndexes=[]},this.nodes);this.edges.forEach(function(b,c){0<=a.eTodo.indexOf(b)?(b.passed=0,b.nTodo.forEach(function(a){a=this[a];a.eIndexes&&a.eIndexes.push(c)},this)):(b.passed=1,b.sysno=-1)},this.nodes);this.edges.forEach(function(b){b.passed||this.checkSys(a.sysInfos,b)},this);this.edges.forEach(function(b){0<=b.sysno&&thr0.appendToUniqueArray(a.sysInfos[b.sysno].nodes,b.nTodo)})},detectIndirectFixes:function(a,b){function c(a,
b,c,d){var e=b.indexOf(c);0<=e&&(b.splice(e,1),b.unshift(c));a[c].d=d;return e+1}function d(a){if(void 0!==thr0.removeFromArray(a.nTodo,this.n)&&2>a.nTodo.length){this.sysInfos&&0<=a.sysno&&thr0.removeFromArray(this.sysInfos[a.sysno].eTodo,a);if(a.nTodo.length){var b=a.nTodo[0];a.autoAdj=a.nIndexes.indexOf(b);this.mg.nodes[b].d?this.mg.overdet=!0:c(this.mg.nodes,this.nTodo,b,2)}delete a.nTodo;return!1}return!0}function e(a){if((void 0===this.n||void 0!==thr0.removeFromArray(a.nTodo,this.n))&&a.nTodo.length<=
a.eTodo.length)if(a.nTodo.length<a.eTodo.length||this.po&&0===this.po.v)this.mg.overdet=!0;else return a.d=a.nTodo.length?3:2,a.nTodo.forEach(function(b){this.mg.nodes[b].d?this.mg.overdet=!0:c(this.mg.nodes,this.nTodo,b,a.d)},this),delete a.nTodo,a.eTodo.forEach(function(a){thr0.removeFromArray(this,a)},this.eTodo),delete a.eTodo,!1;return!0}var f=a.sysInfos?a.sysInfos.slice(0):[];if(a.sysInfos){if(f.forEach(function(a){a.nTodo=a.nodes.slice(0);a.eTodo=[]}),this.edges.forEach(function(a){0<=a.sysno&&
this[a.sysno].eTodo.push(a)},f),f=f.filter(e,{mg:this,nTodo:a.nTodo,eTodo:a.eTodo}),b&&this.overdet)return!0}else this.edges.forEach(function(b){b.nTodo=b.nIndexes.slice(0);a.eTodo.push(b)}),this.nodes.forEach(function(a,b){a.d?this.unshift(b):this.push(b)},a.nTodo);for(;a.nTodo.length;){var g=a.nTodo.shift();if(!this.nodes[g].d){a.nTodo.unshift(g);break}a.eTodo=a.eTodo.filter(d,{mg:this,nTodo:a.nTodo,sysInfos:a.sysInfos,n:g});if(b&&this.overdet)return!0;f=f.filter(e,{mg:this,nTodo:a.nTodo,eTodo:a.eTodo,
n:g,po:this.nodes[g].po});if(b&&this.overdet)return!0}f.forEach(function(a){a.nTodo.forEach(function(a){var b=this.nodes[a].po;b&&0===b.v&&(this.nodes[a].d=2)},this)},this)},syncSysInfos:function(a){this.mEnv.eqSys=[];this.edges.forEach(function(a){a.q.sys&&delete a.q.sys});a.forEach(function(a){if(2!==a.d){var c=this.mEnv.eqSys;a.sys=c.push(new O(this.ctx,a.d,a.inodes.map(function(a){return this[a].p},this.nodes)));a.eqs=c[a.sys-1]}},this);this.edges.forEach(function(b){void 0===b.autoAdj?void 0!==
b.q.autoAdj&&delete b.q.autoAdj:b.q.autoAdj=b.autoAdj;if(0<=b.sysno){var c=a[b.sysno];c.eqs&&(c.eqs.addEq(b.p),b.q.sys=c.sys)}});this.nodes.forEach(function(a){a.d?a.po.d=a.d:a.po.d&&delete a.po.d})}};X.prototype={isFixed:function(a){return a&&(a.s||a.l&&this.isFixed(this.keys[a.l]))},addRow:function(a){var b,c,d=0;for(b in a)a.hasOwnProperty(b)&&("p"!==b&&"v"!==b)&&(a[b]?this.isFixed(this.keys[b])?(this.addRowVal(a,"v",this.keys[b].v*a[b]),delete a[b]):(c=b,d++):delete a[b]);1===d?(b=a.v||0,this.doFixKey(c,
-b/a[c])):1<d?this.rows.push(a):a.v&&this.overDet(a)},clear:function(){this.rows=[];this.keys={};this.kFree=[];this.nextKey=1},overDet:function(a){if(this.onError)this.onError(this.mEnv,"overdetermined",a)},underDet:function(){if(this.onWarning)this.onWarning(this.mEnv,"underdetermined")},setKeyVal:function(a,b,c){x(b,a.v)||(a.v=b);c&&(a.s=c)},addKey:function(a){var b="k"+this.nextKey++,c=q(this.ctx,a);a={p:a.slice(0),po:this.mEnv.getPO(c)};a.po&&(a.po.d&&3!==a.po.d?("i"===a.po.s&&this.mEnv.valueOf(c),
a.s="x"):"i"!==a.po.s&&(a.s="y"),a.v=void 0!==a.po.v?a.po.v:a.po.f?this.mEnv.valueOf(c):0);this.keys[b]=a;return b},getKey:function(a,b){for(var c in this.keys)if(this.keys.hasOwnProperty(c)&&thr0.equalArrays(this.keys[c].p,a))return c;return b?this.addKey(a):void 0},setRowVal:function(a,b,c){var d=this.keys[b];if(d&&d.l){var e=this.keys[d.l].v;void 0!==a[b]&&delete a[b];c&&(d.v&&e)&&this.addRowVal(a,d.l,c*d.v/e)}else c?a[b]=c:a[b]&&delete a[b]},addRowVal:function(a,b,c){if(c){var d=this.keys[b];
d&&d.l?(b=this.keys[d.l].v,c&&(d.v&&b)&&this.addRowVal(a,d.l,c*d.v/b)):(d=a[b]||0,this.setRowVal(a,b,x(d,-c)?0:d+c))}},subtractRow:function(a,b,c){var d,e;e=a[c]||0;c=b[c]||0;if(e&&c)for(d in e=-e/c,b)b.hasOwnProperty(d)&&"p"!==d&&this.addRowVal(a,d,b[d]*e)},adjustLinkedObjects:function(a,b,c){var d,e,f=!x(b,1);if(f||c)for(d in this.keys)this.keys.hasOwnProperty(d)&&(e=this.keys[d],e.l===a&&(f&&(e.v*=b),c&&(e.l=c)))},optimizeRowSingle:function(a,b,c){var d=this.rows[a],e=d.v||0,f=this.keys[b],g=d[b];
this.rows.splice(a,1);f.l&&(g*=f.v,f=f.l);this.isFixed(f)?x(f.v*g,e)?this.tryFixKey(b):this.overDet(d):g?this.doFixKey(b,-e/g,c):this.overDet(d)},optimizeRowPair:function(a,b,c){var d=this.rows[a];if(!d.v){var e=this.keys,f=e[b],g=e[c],h=-d[b]/d[c];this.rows.splice(a,1);f.l&&(h*=f.v,f=e[f.l]);g.l&&(h=g.v?h/g.v:0,c=g.l,g=e[c]);this.adjustLinkedObjects(c,h,b);g.l=b;this.setKeyVal(g,h);a=this.rows.length-1;for(f=this.isFixed(f)&&0===f.v;0<=a;a--)e=this.rows[a],e!==d&&e[c]&&(f?this.setRowVal(e,b,0):this.addRowVal(e,
b,e[c]*h),this.setRowVal(e,c,0))}},optimizeRows:function(){for(var a,b,c,d,e=0;e!==this.rows.length;){e=this.rows.length;for(a=e-1;0<=a;a--)b=this.rows[a],c=this.collectRowKeys(b,3),d=c.length,1===d?this.optimizeRowSingle(a,c[0]):2===d&&0===(b.v||0)?this.optimizeRowPair(a,c[0],c[1]):0===d&&(0===(b.v||0)?this.rows.splice(a,1):this.overDet(b))}},collectRowKeys:function(a,b){var c,d=[];for(c in a)if(a.hasOwnProperty(c)&&("p"!==c&&"v"!==c)&&(d.push(c),b&&d.length>=b))break;return d},matrixEliminate:function(){var a=
0,b=this.keys,c=this.rows,d=[],e=0,f;for(f in b)b.hasOwnProperty(f)&&(d.push(f),b[f].noGet||e++);for(f=d.shift();f;f=d.shift()){var g=b[f];if(!this.isFixed(g)&&!g.l){for(var h=-1,i=0,j=a;j<c.length;j++){var k=Math.abs(c[j][f]||0);k>i&&(h=j,i=k)}if(0>h)g.noGet?0<e?d.push(f):this.kFree.push(f):this.doFixKey(f,this.mEnv.valueOf(this.ctx,g.p),a);else{i=c[h];thr0.arraySwap(c,h,a);for(h=a+1;h<c.length;)j=c[h],this.subtractRow(j,i,f),0<this.collectRowKeys(j,2).length?h++:(0!==(j.v||0)&&this.overDet(j),c.splice(h,
1));a++}}g.noGet||e--}for(;c.length>a;)b=c.pop(),0!==(b.v||0)&&this.overDet(b)},doFixKey:function(a,b,c){var d,e;this.setKeyVal(this.keys[a],b,"y");if(void 0===c||c>this.rows.length)c=this.rows.length;for(d=c-1;0<=d;d--)d>=this.rows.length||(e=this.rows[d],e.hasOwnProperty(a)&&(this.addRowVal(e,"v",e[a]*b),delete e[a],e=this.collectRowKeys(e,2),1===e.length&&this.optimizeRowSingle(d,e[0],c)))},tryFixKey:function(a){var b;a=this.keys[a].l||a;b=this.keys[a];this.isFixed(b)||this.doFixKey(a,b.v)},preventSignChanges:function(a){function b(a,
b){return!thr0.numEqual(a,0)&&(thr0.numEqual(b,0)||thr0.sign(a)!==thr0.sign(b))}function c(a,c,d,h){c.some(function(c){var f=a[c.k],f=c.v+d*Math.abs(f)*(h===thr0.sign(f)?1:-1);if(!b(f,c.v))return c.v=f,c.free=2,!0})}var d=this.keys;$.extend(!0,[],this.rows).reverse().forEach(function(e,f,g){var h,i=e.v||0,j=[];this.collectRowKeys(e).forEach(function(b){var c=thr0.arrayObjByKey(a,"k",b);!c&&!h?h=b:(c?1===c.free&&j.push(c):(c={k:b,v:d[b].v},a.push(c)),i+=c.v*e[b])});if(h){var k=d[h],l=e[h],m=i/(l||
1);a.push({k:h,v:l&&b(k.v,m)&&c(e,j,i-k.v,thr0.sign(l))?k.v:m});for(k=g.length-1;k>f;k--)this.subtractRow(g[k],e,h)}},this)},solve:function(){this.optimizeRows();this.matrixEliminate();if(this.rows.length){var a=this.rows.pop(),b=this.collectRowKeys(a),c=b.filter(function(a){return 0>this.indexOf(a)},this.kFree);(b=c.length>(c.length<b.length?1:0)?c[0]:void 0)?a[b]?this.doFixKey(b,(a.v||0)/-a[b]):this.overDet(a):this.rows.push(a)}this.kFree.length&&(a=this.kFree.map(function(a){return{k:a,v:this[a].v,
free:1}},this.keys),this.preventSignChanges(a),a.filter(function(a){return a.free}).forEach(function(a){this.underDet();this.doFixKey(a.k,a.v)},this));for(var d in this.keys)this.keys.hasOwnProperty(d)&&(a=this.keys[d],a.l&&(a.v=parseFloat((a.v*this.keys[a.l].v).toPrecision(9),10)))},eachChange:function(a){var b,c=this.keys,d;for(d in c)c.hasOwnProperty(d)&&(b=c[d],(!b.po||void 0===b.po.v||!x(b.v,b.po.v))&&a(b))},setPOValues:function(a){var b,c,d=this.keys;for(b in d)d.hasOwnProperty(b)&&(c=d[b],
"i"===c.po.s&&a.setPO(c.po,q(this.ctx,c.p),c.v,""))}};o.ThrMathEnv=function(a,b,c,d){this.rexEquationCtx=a;this.rexParams=b;this.rexBaseUnit=c;this.onError=d;this.clear()};ThrMathEnv.prototype={poProps:/^[vwrqfcdstu]$/,skipCheck:!1,maxES:0,clear:function(){this.ctxTree={};this.changes=[];this.newPOs=[];this.changedEquationCtxs=[];this.lateSetPOs=[];this.invalidEndNodes=[];this.eqSys=[];this.errLog=[]},isEmpty:function(){return $.isEmptyObject(this.ctxTree)},hasChanges:function(){return this.changes.length||
this.newPOs.length},clone:function(){function a(b,d){var e={},f;for(f in d)d.hasOwnProperty(f)&&(e[f]=/^[qf]$/.test(f)?d[f].clone():b.poProps.test(f)?JSON.parse(JSON.stringify(d[f])):a(b,d[f]));return e}var b=new ThrMathEnv(this.rexEquationCtx,this.rexParams,this.rexBaseUnit,this.onError);b.ctxTree=a(this,this.ctxTree);b.eqSys=this.eqSys.map(function(a){return a.clone()});return b},getPO:function(a,b){var c,d,e,f,g=a.slice(0),h=this.ctxTree,i=h;c=0;for(d=g.length;c<d;c++){i=h[g[c]];if(void 0===i)break;
h=i}if(i||!b)return i;i=e=b();for(d-=1;d>c;d--){if(this.poProps.test(g[d]))throw thrMath.ntx.mathError+": '"+g[d]+"' "+thrMath.ntx.errReserved;f={};f[g[d]]=i;i=f}h[g[c]]=i;this.newPOs.push(e);return e},getPOByT:function(a){var b,c,d,e,f=!0,g=this.ctxTree;b=0;for(d=a.length;b<d;b++){e=a[b].toLowerCase();f=!1;for(c in g)if(g.hasOwnProperty(c)&&g[c].t&&g[c].t.toLowerCase()===e){g=g[c];f=!0;break}if(!f)break}if(f)return g},removePO:function(a,b){if(a){var c,d,e=this,f=this.ctxTree,g=[];c=0;for(d=a.length;c<
d;c++)if(g.push(f),f=f[a[c]],void 0===f)return;this.eachSubNode(f,a,function(a,b){e.replaceRefsByVal(b,a)});this.eachSubNode(f,a,function(a,b){(f.f||f.q||void 0!==f.v)&&e.changes.push(b.slice(0));a&&a.f&&a.f instanceof ThrMathOp?a.f.releaseUsages(e,b):a.q&&a.q.releaseUsages(e,b)});for(c=d-1;0<=c&&!(f=g.pop(),delete f[a[c]],!b||!$.isEmptyObject(f));c--);}},setPO:function(a,b,c,d){void 0!==c&&!x(a.v,c)&&(void 0!==a.v&&this.notifyChange(a,b),a.v=c);void 0!==d?d?(a.s=d,thrMath.rexFixed.test(d)?a.d=1:
a.d&&delete a.d):a.s&&(thrMath.rexFixed.test(a.s)&&a.d&&delete a.d,delete a.s):"i"===a.s&&delete a.s},isInnerPO:function(a){for(var b in a)if(a.hasOwnProperty(b)&&!this.poProps.test(b))return!0;return!1},getSubContexts:function(a,b,c){var d,e=[];if(a=c?this.getPOByT(a):this.getPO(a))for(d in a)a.hasOwnProperty(d)&&(!b||b.test(d))&&e.push({id:d,po:a[d]});return e},eachNode:function(a,b){var c=this.getPO(a);c&&this.eachSubNode(c,a,b)},eachSubNode:function(a,b,c){b=b.slice(0);var d=c(a,b);if(d)return!0;
if(!1!==d)for(var e in a)if(a.hasOwnProperty(e)&&!this.poProps.test(e)&&"object"===typeof a[e]){b.push(e);if(this.eachSubNode(a[e],b,c))return!0;b.pop()}},addUsage:function(a,b){var c=this.getPO(a,function(){return{v:0}});c.u||(c.u=[]);c.u.push(y(a,b,1))},releaseUsage:function(a,b){var c,d,e=this.getPO(a);if(e&&e.u){d=y(a,b,1);for(c=e.u.length-1;0<=c;c--)thr0.equalArrays(e.u[c],d)&&(e.u.splice(c,1),e.r&&thr0.equalArrays(e.r,d)&&delete e.r);e.u.length||delete e.u}},isReferenced:function(a,b){return a.some(function(c){var d=
this.getPO(c);return d&&d.u?d.u.some(function(c){c=q(this.p0,c,1);return 0>thr0.indexOfArrayInArray(a,c)&&!(b&&b.some(function(a){return thr0.arrayStartsWith(this,a)},c))},{p0:c}):!1},this)},replaceRefsByVal:function(a,b){var c=b.v||0;b.u&&(b.u.forEach(function(b){b=q(a,b,1);var e=this.getPO(b);e&&e.f&&e.f instanceof ThrMathOp?e.f.r?(delete e.f,e.v=c,e.s&&thrMath.rexFixed.test(e.s)?e.d=1:e.d&&delete e.d):e.f.replaceRefByVal(y(b,a,1),c):e&&e.q&&e.q.replaceRefByVal(y(b,a,1),c);e&&this.notifyChange(e,
b)},this),delete b.u)},collectRefs:function(a,b,c){var d=this.getPO(a);d&&this.eachSubNode(d,a,function(a,d){a.f&&a.f.collectRefs(d,b,c)})},error:function(a,b){this.errLog.push({path:a,msg:b});if(this.onError)this.onError(a,b)},notifyChange:function(a,b){a.c||(a.c=!0,this.changes.push(b))},notifyEquationChange:function(a){var b=a.slice(0,a.length-1);for(a=b.length-1;0<=a&&!this.rexEquationCtx.test(b[a]);a--)b.pop();0>thr0.indexOfArrayInArray(this.changedEquationCtxs,b)&&this.changedEquationCtxs.push(b)},
notifyUsingEquationChange:function(a,b){a.u&&a.u.forEach(function(a){a=q(b,a,1);var d=this.getPO(a);d&&d.q&&this.notifyEquationChange(a)},this)},clearChanges:function(){this.changes.forEach(function(a){if(a=this.getPO(a))a.c&&delete a.c,"i"===a.s&&delete a.s},this);this.changes=[];this.newPOs=[]},pathExists:function(a,b){return this.getPO(q(a,b))},pathToString:function(a,b,c,d){var e=[],f=[],g=this.ctxTree;d&&(b=y(a,b));if(!/^(display|edit)$/.test(c))return b.map(function(a){return".."===a?".":a}).join(".");
c=0;for(d=a.length;c<d;c++)if(f.push(g),g=g[a[c]],void 0===g)return thrMath.ntx.errInvalidCtx;c=0;for(d=b.length;c<d;c++)".."===b[c]?(e.push("."),g=f.pop()):(f.push(g),g&&(g=g[b[c]]),g&&g.t?e.push(thr0.scanDenom(g.t).ix!==g.t.length?thr0.quotedString(g.t):g.t):e.push(b[c]));return e.join(".")},getParamTree:function(a,b,c){var d,e=this,f=[];this.eachNode(a,function(a,h){d=h[h.length-1];h.length<=f.length&&(f=f.slice(0,h.length-1));if((!e.rexParams||e.rexParams.test(d))&&!a.q&&a.t&&(b?thrMath.rexFixed.test(a.s)&&
!a.f:!e.isInnerPO(a))){if(0>thr0.indexOfArrayInArray(c,h)){var i=f,j={name:a.t,p:h,id:d},k,l;for(k=0;k<i.length;k++)i[k]instanceof ThrTreeNode?l=i[k]:(l=l?l.addNode(i[k].po.t):new ThrTreeNode(i[k].po.t),l.id=i[k].id,i.splice(k,1,l));l.add([],j)}}else f.push({po:a,id:d})});return f[0]instanceof ThrTreeNode?f[0]:new ThrTreeNode(f.length?f[0].po.t:"")},set:function(a,b,c){var d=!1,e=void 0!==c.f,f=void 0!==c.q,g=void 0!==c.v;b=q(a,b);var h=this.getPO(b,function(){d=!0;return{}});d&&(!e&&!f&&!g)&&(c.v=
0,g=!0);d||(d=0<=this.newPOs.indexOf(h));if(e&&(!h.f||!(h.f instanceof ThrMathOp&&h.f.isEqual(c.f)))||f&&(!h.q||!h.q.isEqual(c.q))||g&&!f&&!e&&(h.f||h.q||!x(h.v,c.v))){a=b.slice(0,b.length-1);if(!this.skipCheck){if(!d&&!f&&(this.analyze(),2===h.d||"i"===h.s))throw thrMath.ntx.mathError+": "+thrMath.ntx.errSetIndirFixed+" '"+this.pathToString([],b,"display")+"'!";if(e&&c.f instanceof ThrMathOp&&c.f.uses(this,a,h))throw thrMath.ntx.errCircularref;}h.u&&(thrMath.rexFixed.test(c.s)||e)!==N(h)&&this.notifyUsingEquationChange(h,
b);if(e||f||g)h.f?(h.f instanceof ThrMathOp&&h.f.releaseUsages(this,b),delete h.f):h.q&&(h.q.releaseUsages(this,b),delete h.q,this.notifyEquationChange(b));e?(c.f instanceof ThrMathOp?c.f.addUsages(this,b):this.lateSetPOs.push(b),h.f=c.f,d||this.notifyChange(h,b)):f&&(c.q.addUsages(this,b),h.q=c.q,h.hasOwnProperty("v")&&delete h.v,this.lateSetPOs.length?this.lateSetPOs.push(b):h.q.isValid(this,a)||this.notifyChange(h,b),this.notifyEquationChange(b))}else h.u&&(thrMath.rexFixed.test(c.s)||e)!==N(h)&&
this.notifyUsingEquationChange(h,b);g&&2===h.d?h.v=c.v:this.setPO(h,b,c.v,c.s);c.w?h.w=c.w:h.w&&""===c.w&&delete h.w;c.t?h.t=c.t:h.t&&""===c.t&&delete h.t},syncObjParams:function(a,b,c){var d,e,f,g;d=0;for(f=c.length;d<f;d++)if(g=c[d],g.delIds)for(e=g.delIds.length-1;0<=e;e--)this.unset(a,[b+g.delIds[e]]);else e={},void 0!==g.name&&(e.t=g.name),void 0!==g.val&&("number"===typeof g.val?(e.v=g.val,e.s="x"):(e.f=g.val,e.s="")),void 0!==g.unit&&(e.w="_DELETE_"===g.unit?"":g.unit),this.set(a,b+g.id,e)},
syncObjEquation:function(a,b,c,d,e,f){var g=this.getPO(a),h=g?g[b]:void 0;if(!c||!d)h&&this.unset(a,b),this.set(a,b,{v:f});else{var i,j,k,l=[];void 0===e&&(e="sum_in"===this.titleOf(a,b));k=e?"sum_in":"sum_out";for(i in g)if(g.hasOwnProperty(i)&&!this.poProps.test(i)&&(c.test(i)||d.test(i))&&(g[i].f||void 0!==g[i].v))h=c.test(i),h===e&&(j=l.length),l.push([[i],h?1:-1]);this.set(a,b,l.length?{q:this.createEquation(l,j),t:k}:{v:f,t:k})}},isSet:function(a,b){return void 0!==this.getPO(q(a,b))},unset:function(a,
b){this.removePO(q(a,b),!0)},createEquation:function(a,b){return new J(a,b)},hasCircle:function(a,b,c){a=q(a,b);return(b=this.getPO(a))&&c.uses(this,a.slice(0,a.length-1),b)},canChange:function(a,b,c,d){function e(a){return!a||!a.d||!d&&1===a.d}this.analyze();if(b instanceof RegExp){a=this.getPO(a);for(var f in a)if(a.hasOwnProperty(f)&&!this.poProps.test(f)&&b.test(f)&&!e(a[f])&&0>=c--)return!1;return!0}return e(this.getPO(q(a,b)))},canChangeStructure:function(a,b){var c=this,d=this.getMathGraph(a);
b.removeMultiplier&&b.removeMultiplier.forEach(function(b){var d=q(a,q(b.ctx,b.p)),g,h,i,j=[],k=c.getPO(d);for(g=(k.u||[]).length-1;0<=g;g--)i=q(d,k.u[g],1),(h=c.getPO(i))&&h.q&&j.push({qp:y(a,i),q:h.q});b.eqsi=j});d.applyChanges(b);return!d.isOverDetermined()},canRemove:function(a,b){function c(a,b,c){if(b&&b.u)for(var d=b.u.length-1;0<=d;d--){var e=q(c,b.u[d],1),f=a.getPO(e);if(!f||!f.q)return!f;if(void 0!==f.q.autoAdj&&f.q.indexOfPath(y(e,c,1))===f.q.autoAdj)return!1}return!0}this.analyze();if(b instanceof
RegExp){var d=a.slice(0),e=this.getPO(d),f;for(f in e)if(e.hasOwnProperty(f)&&!this.poProps.test(f)&&b.test(f)){d.push(f);if(!c(this,e[f],d))return!1;d.pop()}return!0}d=q(a,b);return c(this,this.getPO(d),d)},getEquationInfos:function(a,b){var c=this.getPO(q(a,b)),d=c.q.getAdjustableIx();return c.q.a.map(function(b,f){return{ix:f,p:b[0],val:Math.abs(c.q.getVal(this,a,f)),calcType:this.getPO(q(a,b[0])).d,adj:f===d}},this)},changeQElNames:function(a,b,c,d){a=q(a,b);(b=this.getPO(a))&&b.q&&b.q.changeElNames(this,
a.slice(0,a.length-1),c,d)},toggleMultiplier:function(a,b,c,d){var e,f,g,h,i=!1,j=q(a,b),k=this.getPO(j,function(){i=!0;return{v:1}}),l=this.getPO(a);if(i)for(f in l){if(l.hasOwnProperty(f)&&!this.poProps.test(f)&&c.test(f)&&(l[f].f||void 0!==l[f].v)){b=q(a,f);for(e=l[f].u?l[f].u.length-1:-1;0<=e;e--)if(h=q(a,l[f].u[e]),(g=this.getPO(h))&&g.q)g.q.addMultiplier(y(h,b,1),y(h,j,1)),k.u||(k.u=[]),k.u.push(y(j,h,1)),this.notifyEquationChange(h);l[f].f||this.setPO(l[f],b,l[f].v,d)}}else{for(e=k.u?k.u.length-
1:-1;0<=e;e--)if(h=q(j,k.u[e],1),(g=this.getPO(h))&&g.q)g.q.removeMultiplier(y(h,j,1)),k.u.splice(e,1),this.notifyChange(g,h),this.notifyEquationChange(h);for(f in l)l.hasOwnProperty(f)&&(!this.poProps.test(f)&&c.test(f)&&void 0!==l[f].v&&!l[f].f)&&this.setPO(l[f],q(a,f),l[f].v*(k.v||1),d);this.unset(a,b)}},setFixed:function(a,b,c){function d(a,b,d){if((b.s||"")!==c)a.setPO(b,d,b.v,c),a.notifyUsingEquationChange(b,d)}var e=b instanceof RegExp;a=e?a.slice(0):q(a,b);var f=this.getPO(a);if(f)if(e)for(var g in f)f.hasOwnProperty(g)&&
(!this.poProps.test(g)&&b.test(g)&&void 0!==f[g].v)&&(a.push(g),d(this,f[g],a),a.pop());else d(this,f,a)},invalidatePath:function(a,b,c){var d=this.getPO(a);if(d&&"i"!==d.s&&(!b||!d.c))if(this.skipCheck&&d.q)b&&this.invalidEndNodes.push(b);else{var e,f;if(!d.s&&(b||d.f||d.q))d.s="i";c&&(d.r=y(a,b,1));if(d.q){if(b){b=y(a,b,1);for(e=d.q.a.length-1;0<=e;e--)if(thr0.equalArrays(b,d.q.a[e][0])){d.q.triggerIx=e;break}}if(d.q.sys){if((e=this.eqSys[d.q.sys-1])&&2!==e.d)e.invalidate(a),d.q.invalidateElements(this,
a)}else c=d.q.getAdjustableIx(),b=q(a,d.q.a[c][0],1),f=this.getPO(b),e!==c&&(!f||!f.d)||void 0!==d.q.autoAdj?this.invalidatePath(b,a,!0):d.q.invalidateElements(this,a,c)}e=0;for(b=d.u?d.u.length:0;e<b;e++)this.invalidatePath(q(a,d.u[e],1),a);d&&((!d.u||d.r&&1===d.u.length)&&!d.q)&&this.invalidEndNodes.push(a)}},invalidate:function(){this.changes.forEach(function(a){this.invalidatePath(a)},this)},evaluatePath:function(a,b){var c,d=this.getPO(a);d&&"i"===d.s&&(d.q?(d.q.sys&&(c=this.eqSys[d.q.sys-1]),
c&&2!==c.d?c.active?delete d.s:c.propagate(this,b):(d.q.propagate(this,a.slice(0,a.length-1)),delete d.s)):(d.f||d.r)&&this.valueOf(a))},evaluate:function(){this.invalidEndNodes.forEach(function(a){this.evaluatePath(a)},this);this.invalidEndNodes=[];this.eqSys.forEach(function(a){"i"===a.s&&a.propagate(this)},this)},getMathGraph:function(a){function b(a,d,e){if(d){var f=a.mEnv,g;for(g in d)d.hasOwnProperty(g)&&!f.poProps.test(g)&&(e.push(g),d[g].q?a.addEquation(d[g].q,e.slice(0)):f.rexEquationCtx.test(g)||
b(a,d[g],e),e.pop())}return a}return b(new W(this,a),this.getPO(a),[])},postProcessSet:function(){if(this.lateSetPOs.length){var a,b,c,d,e=[],f=[];for(a=this.lateSetPOs.length-1;0<=a;a--)if(d=this.lateSetPOs[a],(c=this.getPO(d))&&c.f){b=ThrMathOp.prototype.createMathOp({mEnv:this,ctx:d.slice(0,d.length-1),isUIString:!1},c.f);if(b.uses(this,d.slice(0,d.length-1),c))throw thrMath.ntx.errCircularref;c.f=b;c.f.addUsages(this,d);c.s="i";this.notifyChange(c,d);f.push({po:c,p:d})}else c&&c.q&&e.push({po:c,
p:d});for(a=f.length-1;0<=a;a--)c=f[a].po,"i"===c.s&&(d=f[a].p,b=c.f.value(this,d.slice(0,d.length-1)),"number"===typeof b?(this.rexBaseUnit&&(this.rexBaseUnit.test(d[d.length-1])&&c.w)&&(b/=thrUnits.getFactor(c.w)),this.setPO(c,d,b)):this.error(d,b+" is not a number."));for(a=e.length-1;0<=a;a--)d=e[a].p,e[a].po.q.isValid(this,d.slice(0,d.length-1))||this.notifyChange(e[a].po,d);this.lateSetPOs=[]}},analyze:function(){this.postProcessSet();this.changedEquationCtxs.forEach(function(a){this.getMathGraph(a).analyze()},
this);this.changedEquationCtxs=[]},calculate:function(a){var b=this.errLog.length;this.analyze();this.invalidate();this.evaluate();if(!a&&b!==this.errLog.length)throw"Math error";},titleOf:function(a,b){var c=this.getPO(q(a,b));return c?c.t||"":""},valueOf:function(a,b){var c,d=q(a,b),e=this.getPO(d);if(!e)return 0;if((e.f||e.r)&&("i"===e.s||void 0===e.v))e.f?(c=e.f instanceof ThrMathOp?e.f.value(this,d.slice(0,d.length-1)):thrMath.ntx.mathError+": "+thrMath.ntx.errEmptyFunc,"number"===typeof c?(this.rexBaseUnit&&
(this.rexBaseUnit.test(d[d.length-1])&&e.w)&&(c/=thrUnits.getFactor(e.w)),this.setPO(e,d,c)):this.error(d,c+" is not a number.")):(this.evaluatePath(q(d,e.r,1),d),delete e.r);return e.v},dataOf:function(a,b){var c=this.getPO(q(a,b));return c?c.f?{f:c.f}:c.r?{r:c.r}:{v:c.v}:{}},formulaOf:function(a,b,c){a=this.getPO(q(a,b));return c&&a&&2===a.d?"(#auto)":a?a.f:void 0},unitOf:function(a,b){for(var c,d=q(a,b),e=this.ctxTree;d.length;){e=e[d.shift()];if(void 0===e)break;void 0!==e.w&&(c=e.w)}return c},
statusOf:function(a,b){var c=this.getPO(q(a,b));return c?c.s:void 0},getMatrix:function(a){return new X(this,a,function(a,c,d){a.error(d.p,c)})},getCtxOptions:function(a,b,c,d){var e,f,g=[];a=q(a,b);a=this.getPO(a);var h="if sin cos tan asin acos atan rad deg ceil floor abs exp int round sqrt sqr max min log".split(" ");c=c.toLowerCase();f=c.length;if(a)for(e in a)a.hasOwnProperty(e)&&(!this.poProps.test(e)&&(!d||d.test(e))&&!a[e].q&&a[e].t&&a[e].t.slice(0,f).toLowerCase()===c)&&g.push(a[e].t);b||
h.forEach(function(a){a.slice(0,f)===c&&g.push(a+"()")});g.sort();return g}};thrUI.mathAutoComplete={create:function(a){thrUI.createControl(a,"mathAutoComplete","thrAutoComplete",["change","click","keydown","keypress","input"],"\x3cinput type\x3d'text'/\x3e\x3cspan class\x3d'thrInnerHint'\x3e\x3c/span\x3e\x3cul class\x3d'thrAutoDropdown'\x3e\x3c/ul\x3e").addClass("thrCollapsed").find("input").focus(function(a){thrUI.mathAutoComplete.focusChanged(a,!0)}).blur(function(a){thrUI.mathAutoComplete.focusChanged(a,
!1)});thrUI.setActionMaker(a,function(a){return $(a.target).parent().hasClass("thrAutoDropdown")});this.fill(a)},fill:function(a,b){var c=a.data("unit"),d=a.data("mscale"),e=a.find("input"),f=this.getMathEnv(a),g=a.data("mathctx").split("."),d=d?f.valueOf(g,["..",d]):1,h=f?f.valueOf(g):0;f&&(f.rexBaseUnit&&f.rexBaseUnit.test(g[g.length-1])&&c)&&(h*=thrUnits.getFactor(c));void 0===b&&(b=f?f.formulaOf(g,void 0,!0):0,"(#auto)"===b?e.attr("readonly","readonly"):e.removeAttr("readonly"),g.pop(),b=b?b.toString(f,
g,"display"):thr0.formatLocalFloat(h));a.data("sav",b);e.val(b);a.find(".thrInnerHint").text(thr0.formatLocalFloat(h*d))},getValue:function(a){return a.find("input").val()},getMathEnv:function(a){var b=$.Event("getMathEnv");a.trigger(b);return b.mEnv},setUnit:function(a,b){var c=a.find(".thrUnit");a.data("unit",b);b&&!c.length?a.append("\x3cspan class\x3d'thrUnit'\x3e "+b+"\x3c/span\x3e"):c.text(" "+b)},focusChanged:function(a,b){var c=$(a.target).closest(".thrAutoComplete");b?(c.find(".thrInnerHint").addClass("thrNoDisplay"),
c.data("vl",c.find("input").val().length)):(c.addClass("thrCollapsed"),c.find(".thrInnerHint").removeClass("thrNoDisplay"),!c.data("preventchange")&&c.data("sav")!==this.getValue(c)&&c.change())},input:function(a){var b,c,d,e;e=[];var f=$(a.target),g=$(a.currentTarget),h=g.find(".thrAutoDropdown"),i=this.getMathEnv(g);if(i){b=f.val();c=b.length<g.data("vl");g.data("vl",b.length);if(b=thr0.scanLastRef(b.slice(0,f[0].selectionEnd)))!c&&(!b.length&&!g.hasClass("thrCollapsed"))&&this.accept(g,!0),(d=
/[^.]*$/.exec(b))&&(d=d[0]);if(a.thrShowDD||d&&0<d.length)a=g.data("mathctx").split("."),a=a.slice(0,a.length-1),(c=b.slice(0,b.length-d.length).trim())?".."===c?c=[".."]:(c=ThrMathOp.prototype.createRefOp({mEnv:i,ctx:a,isUIString:!0},c.slice(0,-1),0),c.op?c=c.op.r:d=void 0):c=void 0,e=g.data("mfilter"),e=i.getCtxOptions(a,c,(d||"").trim(),e?RegExp(e):void 0)}e.length?(h.empty().append("\x3cli class\x3d'thrSelected'\x3e"+e.join("\x3c/li\x3e\x3cli\x3e")+"\x3c/li\x3e").data("tx",d),g.removeClass("thrCollapsed")):
g.addClass("thrCollapsed")},keydown:function(a){var b;b=a.keyCode||a.which;var c=$(a.currentTarget),d=c.find(".thrSelected");if(27===b)c.find("input").val(c.data("sav")),c.addClass("thrCollapsed"),thr0.breakEvent(a);else if(13===b)this.accept(c),thr0.breakEvent(a);else if(38===b||40===b)b=38===b?d.prev():d.next(),b.length&&(d.removeClass("thrSelected"),b.addClass("thrSelected"),b[0].scrollIntoView()),thr0.breakEvent(a)},keypress:function(a){var b=a.keyCode||a.which,c=String.fromCharCode(b),d=$(a.currentTarget),
e=d.hasClass("thrCollapsed");47<b&&(e&&a.ctrlKey&&" "===c?(a.thrShowDD=!0,this.input(a),thr0.breakEvent(a)):c&&(!/[a-zA-Z_\"\x7f-\xff0-9]/.test(c)&&!e)&&this.accept(d))},click:function(a){var b=$(a.currentTarget),c=$(a.target),d=c.parent().hasClass("thrAutoDropdown");if(d||c.hasClass("thrInnerHint"))d&&(b.find(".thrSelected").removeClass("thrSelected"),c.addClass("thrSelected"),this.accept(b)),b.find("input").focus().select(),thr0.breakEvent(a)},change:function(a){var b,c,d,e,f=$(a.currentTarget);
void 0===a.value&&!f.data("preventchange")&&(thr0.breakEvent(a),b=this.getValue(f),b!==f.data("sav")&&(e=this.getMathEnv(f),c=thr0.splitNumberUnit(b.trim()),a=f.data("mathctx").split("."),!c[1]||c[1].length!==b.length&&0>"+-*/^".indexOf(c[1].charAt(0))?(b=f.data("unit"),d=c[1]?thrUnits.getFactor(b)/thrUnits.getFactor(c[1]):1,e.rexBaseUnit&&(e.rexBaseUnit.test(a[a.length-1])&&b)&&(d/=thrUnits.getFactor(b)),a={v:c[0]*d}):a={tx:b,op:ThrMathOp.prototype.createMathOp({mEnv:e,ctx:a.slice(0,a.length-1),
isUIString:!0},b)},thrUI.triggerChange(f,"mathAutoComplete",a)&&this.fill(f)))},accept:function(a,b){if(a.hasClass("thrCollapsed"))a.change();else{var c=a.find(".thrSelected");if(c.length){var c=c.text(),d=a.find("input"),e=d[0],f=d.val(),g=b?-1:0,h=e.selectionStart+g-a.find(".thrAutoDropdown").data("tx").trim().length,i=e.selectionEnd+g;")"===c.charAt(c.length-1)?g++:thr0.scanDenom(c,0).ix<c.length&&(c=thr0.quotedString(c));b&&(c+=" ");d.val(f.slice(0,h)+c+f.slice(i));e.selectionStart=h+c.length-
g;e.selectionEnd=e.selectionStart;a.addClass("thrCollapsed")}}}};thrUI.mathDlgSelectParam={show:function(a,b,c,d,e){var f=thrUI.dialog.create(thrMath.ntx.selParam,1,_h.table(void 0,[[[thrUI.ihtml("folderList",{rootname:thrMath.ntx.rootType}),{colspan:2}],["",{colspan:2}]]])).addClass("thrMathDlgSelectParam"),g=f.find(".thrDialog"),h=g.find(".thrDlgBody");b=a.mEnv.getParamTree(a.ctx,b,d);b.sort();thrUI.setTempData(f,{cb:e,mInfo:a,pTree:b});thrUI.initControls(g);h.find(".thrListbox").css("height","200px");
thrUI.folderList.fill(h.find(".thrFolderList"),c&&!$.isEmptyObject(c)?this.getTreePath(b,y(a.ctx,c)):void 0,thrUI.getTempDataPath(f,"pTree"));thrUI.dialog.center(g);g.change(function(a){thrUI.mathDlgSelectParam.change(a)})},getTreePath:function(a,b){var c,d=[],e=a,f=b.length-1;b.forEach(function(a,b){b===f?d.push(thr0.indexOfKey(e.sub,"id",a)):(c=thr0.indexOfKey(e.sub,"id",a),0<=c&&(e=e.sub[c]),d.push(e.name))});return d},change:function(a){var b=$(a.currentTarget).parent(),c=0<=[thrUI.ntx.cancel,
thrUI.ntx.close].indexOf(a.dlgCmd),d=thrUI.getTempData(b,"cb");a.stopPropagation();!c&&d&&(a.value=thrUI.folderList.getValue(b.find(".thrFolderList")),void 0!==a.value&&(a=(c=thrUI.getTempData(b,"pTree"))?c.findItem(a.value):void 0)&&d(a.p));thrUI.dialog.close(b)}};o.thrPK={fb:{appId:"1425098274174234",xfbml:!0,version:"v2.8"},gapi:{appId:"thr-sankeyflowshow-prod",devKey:"AIzaSyCin-Nhwdvv8lLE4q5B4uMyg9E8wpRX2qA",oauthClientId:"1047958866295-nbdr0qd0v7kq58rkc1domu97hubkq4ck.apps.googleusercontent.com",
scope:"profile email https://www.googleapis.com/auth/drive https://www.googleapis.com/auth/drive.install"},stripe:{pk:"pk_live_8ULOacMVcvgOgbJ1q17jNOZu"}};var B={ntx:{total:"Total",connection:"Connection",connections:"Connections",newConName:"Untitled connection",item:"Item",items:"Items",newItemName:"Untitled item",diagram:"Diagram",diagrams:"Diagrams",newDiagramName:"Untitled diagram",legend:"legend"}};thrNtx.register(B);o.sfsIdPrefix={diagram:"a",item:"b",connection:"c",conPoint:"d",input:"i",
output:"o",parameter:"p",scale:"sc",io:function(a){return a?this.input:this.output},filterExtRef:function(){return"^["+this.diagram+this.item+this.connection+this.parameter+"]"},rexPre:function(a){return RegExp("^["+a+"][0-9]+$")},rexIo:function(){return RegExp("^["+this.input+this.output+"][0-9]+$")},rexParameters:function(){return RegExp("^["+this.input+this.output+this.conPoint+this.parameter+"][0-9]+$")},rexBaseUnit:function(){return RegExp("^["+this.input+this.output+this.conPoint+"][0-9]+$")},
prefixedId:function(a){var b=a instanceof SfsDiagram?this.diagram:a instanceof SfsItem?this.item:a instanceof SfsConnection?this.connection:void 0;return b?b+a.id:b},orderNo:function(a){a=a.charAt(0);return a===this.parameter?1:a===this.input||a===this.output||a===this.conPoint?2:3},isParameterPath:function(a){return a&&a.length&&RegExp("^"+this.parameter+"[0-9]+$").test(a[a.length-1])}};o.SfsLegend=function(a){this.instantiate(a)};SfsLegend.prototype={thrClsName:"Legend",visible:!1,x:10,y:100,r:5,
width:200,height:300,order:0,color:"#eee",innerEffect:0,outerEffect:0,minSize:15,instantiate:function(a){thr0.clearObject(this);a&&$.extend(this,a);this.text=new ThrText($.extend({hAlign:0},this.text?this.text:{}));this.line=new ThrLine(this.line)},getClsCaption:function(){return B.ntx.legend},getBoundsRect:function(){return{x:this.x,y:this.y,width:this.width,height:this.height}},getFormat:function(a){return thr0.copyProps({text:this.text.getFormat(a),line:this.line.getFormat(a)},this,["color","innerEffect",
"outerEffect"],a)}};o.SfsConnection=function(a){this.points=[];this.stretches=[];this.instantiate(a)};SfsConnection.prototype={thrClsName:"Connection",tagTypes:["lbl","ind","rel"],color:"thr(1)",innerEffect:0,outerEffect:0,tagColor:"rgba(255,255,255,0.5)",isBroken:!1,name:"",unit:"kg",curveFactor:20,arrowHeadAngle:90,minHeadSize:15,showInLegend:!0,indicatorUnits:!0,indDiagramUnits:!0,indPrecision:3,indFType:0,indRoundExp:0,indThousandsSep:!0,percPrecision:2,percFType:1,percRoundExp:0,hairline:!1,
baseType:0,arrowType:1,instantiate:function(a){thr0.clearObject(this);a&&(a.indInteger&&(delete a.indInteger,a.indFType=1),$.extend(!0,this,a));this.line=new ThrLine(this.line);this.tagText=new ThrText(this.tagText);this.tagLine=new ThrLine(this.tagLine)},idName:function(a){return B.ntx.connection+thr0.idStr("0000",a||this.id)},denom:function(){return this.name||this.idName()},getClsCaption:function(a){return a?B.ntx.connections:B.ntx.connection},getFormat:function(a){return thr0.copyProps({line:this.line.getFormat(a),
tagText:this.tagText.getFormat(a),tagLine:this.tagLine.getFormat(a)},this,"color gradient innerEffect outerEffect tagColor tagGradient curveFactor arrowHeadAngle minHeadSize hairline baseType arrowType".split(" "),a)},getDefaultData:function(){return thr0.copyProps(this.getFormat(),this,"indicatorUnits indDiagramUnits indPrecision indFType indRoundExp indThousandsSep percPrecision percFType percRoundExp".split(" "))},getCompareFn:function(a){var b=[function(a,b){var e=a.name||a.idName(),f=b.name||
b.idName();return e===f?0:e>f?1:-1},function(a,b){var e=a.name||a.idName(),f=b.name||b.idName();return e===f?0:e<f?1:-1},function(a,b){return a.z===b.z?0:a.z>b.z?1:-1},function(a,b){return a.z===b.z?0:a.z<b.z?1:-1},function(a,b){return-thr0.compareArrays(thrColors.colorStringToHsl(a.color),thrColors.colorStringToHsl(b.color))},function(a,b){return thr0.compareArrays(thrColors.colorStringToHsl(a.color),thrColors.colorStringToHsl(b.color))}];return b[a<b.length?a:0]},getStretchLine:function(a){var b=
this.points;a=this.stretches[a];return[b[a.a],b[a.b]]},getStretchLines:function(){var a=this.points;return this.stretches.map(function(b){return[a[b.a],a[b.b]]})},getStretchPt:function(a,b){return this.points[b?this.stretches[a].a:this.stretches[a].b]},otherStPt:function(a,b){var c=this.stretches[a];return c.a===b?c.b:c.a},countPtStretches:function(a){return thr0.countInArray(this.stretches,function(b){return b.a===a||b.b===a})},countWayPoints:function(a){return thr0.countInArray(this.points,function(b){return b.way===
a})},isPtAttached:function(a){return void 0!==this.points[a].itemId},isAttachedTo:function(a,b,c){var d=b?1:0;return this.points.some(function(b){return b.itemId===a&&b.way===d&&(void 0===c||b.port===c)})},isArrowEnd:function(a){a=a?this.baseType:this.arrowType;return 0<a&&3>=a},getBoundsRect:function(){return thr0.boundingRect(this.points)},nextPtStx:function(a,b,c){c=c||this.stretches;for(b=b||0;b<c.length;b++)if(c[b].a===a||c[b].b===a)return b;return-1},getShortestStLength:function(){var a=this.points;
return this.stretches.reduce(function(b,c){var d=thr0.distance(a[c.a],a[c.b]);return 0>b||d<b?d:b},-1)},getShortestInnerStx:function(a){var b=this.points,c=b[a];return this.stretches.reduce(function(d,e,f){e=(e=e.a===a?b[e.b]:e.b===a?b[e.a]:void 0)&&2===e.way?thr0.distance(c,e):d.d;return 0<=e&&(0>d.d||e<d.d)?{d:e,stx:f}:d},{d:-1,stx:-1}).stx},canDeleteEndPtSt:function(a){var b=this.points;if(0>a||a>=b.length||1<b[a].way)return!1;a=this.otherStPt(this.nextPtStx(a),a);return 1<b[a].way&&2===this.countPtStretches(a)},
findPathToStretch:function(a,b,c){if(void 0!==c){var d,e,f,g;if(c===b)return{stx:[c],ptx:[]};do d=void 0===b?a:(e=this.stretches[b].a===a)?this.stretches[b].b:this.stretches[b].a,g=this.nextPtStx(d,g+1),0<=g&&g!==b&&(f=this.findPathToStretch(d,g,c));while(0<=g&&!f);f&&void 0!==b&&(f.stx.unshift(b),f.ptx.unshift(d),void 0!==e&&(f.isConDir=e));return f}},allItemsIncluded:function(a,b,c){return this.points.every(function(a){var b=this.ways.indexOf(a.way);if(0<=b&&(this.free&&!a.itemId||a.itemId&&0>this.ids.indexOf(a.itemId))){if(!this.ow||
1===this.ways.length&&this.ways[0]===a.way)return!1;this.ways.splice(b,1)}return!0},{ids:a,ow:b,free:c,ways:[0,1]})},connectsAnItem:function(a){return this.points.some(function(a){return a.itemId&&0<=this.indexOf(a.itemId)},a)},getPointValue:function(a,b,c,d){return 0===c.way||1===c.way?void 0!==c.itemId?b.getItem(c.itemId).getValue(a,b,c.port,1===c.way,d):thrUnits.isConvertible(this.unit,d)?a.valueOf([sfsIdPrefix.diagram+b.id,sfsIdPrefix.connection+this.id,sfsIdPrefix.conPoint+c.id])*thrUnits.getFactor(d):
0:0},getTotalValue:function(a,b,c){return this.points.map(function(d){return d.way?0:this.getPointValue(a,b,d,c)},this).reduce(function(a,b){return a+b},0)},getDiffPointValue:function(a,b,c,d){var e=this.points[c],f=e.way;if(0===f||1===f){if(void 0!==e.itemId)return b.getItem(e.itemId).getDiffValue(a,b,e.port,1===f,d);a=$.extend(!0,[],this.points);a[c].val=d;return{connections:[{id:this.id,points:a}]}}},getPointUnit:function(a,b){return void 0!==b.itemId?a.getItem(b.itemId).getUnit(b.port,1===b.way):
void 0!==b.unit?b.unit:this.unit},getDiffQuantity:function(a,b,c){var d;if(!thrUnits.isConvertible(b,c)){var e,f=[],g=thrUnits.getFactor(b)/thrUnits.getFactor(c);d={connections:[{id:this.id,unit:c}]};this.points.forEach(function(b,i){if(2>b.way)if(void 0!==b.itemId){var j={port:b.port,unit:c},k=thr0.arrayObjByKey(f,"id",b.itemId),l=D(b.way);k||(k={id:b.itemId},f.push(k));k[l]||(k[l]=[]);if(1!==g){var m=a.getItem(b.itemId).portio(1===b.way,b.port);m&&"number"===typeof m.val&&(j.val=m.val*g)}k[l].push(j)}else e||
(e=$.extend(!0,[],this.points),d.connections[0].points=e),j=e[i],"number"===typeof j.val&&(j.val*=g),j.unit=c},this);f.length&&(d.items=f)}return d},getDiffPointUnit:function(a,b,c){var d=this.points[b],e=this.getPointUnit(a,d);c=thrUnits.getCaseSensitiveUnit(c);if(!thrUnits.isConvertible(e,c))return this.getDiffQuantity(a,e,c);if(0===d.way||1===d.way){if(void 0!==d.itemId)return a.getItem(d.itemId).getDiffUnit(a,d.port,1===d.way,c);a=$.extend(!0,[],this.points);a[b].unit=c;return{connections:[{id:this.id,
points:a}]}}},getStretchValues:function(a,b){function c(a,b,c){if(1===a.st.length){b=a.st[0].st;var d=a.st[0].stx,e=b.a===a.ptx?a.v:-a.v;if(0>e){var k=b.a;b.a=b.b;b.b=k;e=-e}a.st.pop();var l=e;this[d]=l;c.forEach(function(a){var b=thr0.indexOfKey(a.st,"stx",d);0<=b&&(a.v+=a.st[b].st.a===a.ptx?-l:l,a.st.splice(b,1))})}return 0<a.st.length}for(var d=this.stretches.map(function(){return 0}),e=this.points.map(function(a,b){return{pt:a,ptx:b,v:this.me.getPointValue(this.mEnv,this.diag,a,this.diag.dispUnit)*
(a.way?-1:1),st:this.sts.filter(function(a){return a.st.a===this.ptx||a.st.b===this.ptx},{ptx:b})}},{me:this,diag:b,mEnv:a,sts:this.stretches.map(function(a,b){return{stx:b,st:a}})});e.length;)e=e.filter(c,d);return d},getProducers:function(a,b){return this.getItems(a,b,0)},getConsumers:function(a,b){return this.getItems(a,b,1)},getItems:function(a,b,c){var d,e,f,g=[],h=0===c?"source":"sink",i=new ThrUnitValAggregator(this.unit);this.points.forEach(function(j,k){j.way===c&&(d=b.getItem(j.itemId),
e=this.getPointUnit(b,j),f=this.getPointValue(a,b,j),i.add(f,e,!0),g.push({id:k,way:h,item:d?d.denom():"-",value:f*thrUnits.getFactor(e),unit:e}))},this);e=i.majorUnit();g.push({id:"total",way:h,item:B.ntx.total,value:i.getSum(e),unit:e,isTotal:!0});return g},getDiffProducers:function(a,b,c,d,e){return this.getDiffItems(a,b,c,d,e)},getDiffConsumers:function(a,b,c,d,e){return this.getDiffItems(a,b,c,d,e)},getDiffItems:function(a,b,c,d,e){var f=this.points[c];if("item"===d){if(b.getItem(f.itemId))return{items:[{id:f.itemId,
text:{tx:e}}]}}else{if("value"===d)return this.getDiffPointValue(a,b,c,thr0.parseLocalUnitFloat(e,this.getPointUnit(b,f)));if("unit"===d)return this.getDiffPointUnit(b,c,e)}},initMathEnv:function(a,b){this.syncMathEnv(a,b,this,this.name||this.idName())},syncMathEnv:function(a,b,c,d){var e,f,g,h,i,j=-1,k=$.extend([],b),l=sfsIdPrefix.connection+c.id,m=c.name||(a.isSet(b,[l])?void 0:d),n=[],p=[],t=[];k.push(l);c.points?(d=void 0===m?d:m,void 0===d&&(d=a.titleOf(k)),g=a.getSubContexts(k,RegExp("^"+sfsIdPrefix.conPoint)),
c.points.forEach(function(c){2!==c.way&&(c.adj&&(j=t.length),0===c.way?n.push(t.length):p.push(t.length),f=1===c.way?1:-1,c.itemId?(e=sfsIdPrefix.item+c.itemId,h=[[e,sfsIdPrefix.io(1===c.way)+c.port],f],a.set(b,h[0],{t:(1===c.way?"in: ":"out: ")+d}),a.isSet(b,[e,sfsIdPrefix.scale])&&h.unshift([e,sfsIdPrefix.scale]),t.push(h)):(e=sfsIdPrefix.conPoint+c.id,i={t:(c.way?"\x3e--":"--\x3e")+c.id},"number"===typeof c.val?(i.v=c.val,i.s=["","y","x"][c.calcType||0]):(i.f=c.val,i.s=""),i.w=c.unit||"",a.set(k,
[e],i),t.push([[l,e],f]),thr0.removeKeyFromArray(g,"id",e)))}),-1===j&&(j=p.length<=n.length?p[0]:n[0]),a.set(b,l,{q:a.createEquation(t,j),w:c.unit})):void 0!==m&&a.changeQElNames(b,l,["in: ","out: "],m);void 0!==m&&a.set(k,void 0,{t:m});g&&g.length&&g.forEach(function(c){a.unset(b,[l,c.id])})}};o.SfsItem=function(a){this.inputs=[];this.outputs=[];this.instantiate(a)};SfsItem.prototype={thrClsName:"Item",id:0,x:100,y:100,r:5,width:150,height:100,color:"#d0d0d0",hiddenShape:!1,textPos:1,calcType:0,
sc:1,combiIn:!1,combiOut:!1,frozen:!1,innerEffect:0,outerEffect:0,showTotals:!1,showTotalsUnit:!0,totalsFType:0,totalsPrecision:3,totalsRoundExp:0,thousandsSep:!0,minSize:2,minTextSize:20,stdTextWidth:200,stdTextHeight:50,textDistance:10,instantiate:function(a){thr0.clearObject(this);a&&$.extend(!0,this,a);this.shape||(this.shape={id:1});this.text=new ThrText($.extend({tx:"",size:18,color:"#000"},this.text?this.text:{}));this.line=new ThrLine(this.line);this.params||(this.params=[]);4===this.outerEffect&&
(this.outerEffect=0)},mathId:function(){return sfsIdPrefix.item+this.id},idName:function(a){return B.ntx.item+thr0.idStr("0000",a||this.id)},denom:function(){return this.text.tx?thr0.firstLine(this.text.tx):this.idName()},getClsCaption:function(a){return a?B.ntx.items:B.ntx.item},ios:function(a){return a?this.inputs:this.outputs},hasIos:function(){return 0<this.inputs.length||0<this.outputs.length},getScale:function(a,b){return 2===this.calcType?a.valueOf([sfsIdPrefix.diagram+b.id,this.mathId(),sfsIdPrefix.scale]):
1},isFix:function(){return 1===this.calcType||5===this.calcType},isEquation:function(){return 3===this.calcType||4===this.calcType},portio:function(a,b){return thr0.arrayObjByKey(this.ios(a),"port",b)},getFormat:function(a){return thr0.copyProps({text:this.text.getFormat(a),line:this.line.getFormat(a)},this,["color","textPos","innerEffect","outerEffect","gradient"],a)},getDefaultData:function(){var a=thr0.copyProps(this.getFormat(),this,"width height hiddenShape avoidNoLine showTotals showTotalsUnit totalsPrecision".split(" "));
this.hasOwnProperty("shape")&&(a.shape=$.extend(!0,{},this.shape));return a},conBorderDelta:function(a){var b=this.id;a=a.connections.reduce(function(a,c){if(c.connectsAnItem([b])){var f=c.line,f=f&&f.style?f.width:0;return{min:Math.min(a.min,f),max:Math.max(a.max,f)}}return a},{min:9999,max:-1});var c=this.line,c=c&&c.style?c.width:0;return 0>a.max||c>=a.min&&c<=a.max?0:c>a.max?a.max-c:a.min-c},getTotal:function(a,b,c){var d=[sfsIdPrefix.diagram+b.id,this.mathId()],e=b.dispUnit;return this.ios(c).reduce(function(b,
g){return b+(thrUnits.isConvertible(g.unit,e)?a.valueOf(d,[sfsIdPrefix.io(c)+g.port]):0)},0)*this.getScale(a,b)*thrUnits.getFactor(e)},getTotalDelta:function(a,b,c){return this.getTotal(a,b,!c)-this.getTotal(a,b,c)},getInports:function(a,b){return this.getPorts(a,b,!0)},getOutports:function(a,b){return this.getPorts(a,b,!1)},getPorts:function(a,b,c){var d=this.getScale(a,b),e=new ThrUnitValAggregator(b.dispUnit),f=c?"in":"out",g=[sfsIdPrefix.diagram+b.id,this.mathId()],h=b.getPortConnections(this.id)[D(c)],
i=this.ios(c).map(function(b){var i=thr0.arrayObjByKey(h,"port",b.port),l=d*a.valueOf(g,[sfsIdPrefix.io(c)+b.port]);e.add(l,b.unit,!0);return{id:sfsIdPrefix.io(c)+b.port,way:f,name:i?i.con.name||i.con.idName():b.name,value:l*thrUnits.getFactor(b.unit),unit:b.unit,calcType:b.calcType}});b=e.majorUnit();i.push({id:"total",way:f,name:B.ntx.total,value:e.getSum(b),unit:b,isTotal:!0});return i},getDiffInports:function(a,b,c,d,e){return this.getDiffPorts(a,b,c,d,e,!0)},getDiffOutports:function(a,b,c,d,
e){return this.getDiffPorts(a,b,c,d,e,!1)},getDiffPorts:function(a,b,c,d,e,f){c=this.portio(f,parseInt(c.slice(1),10));if("name"===d){if(a=b.getPortConnection(this,f,c.port))return{connections:[{id:a.id,name:e}]};a={items:[{id:this.id}]};a.items[0][D(f)]=[{port:c.port,name:e}];return a}if("value"===d)return this.getDiffValue(a,b,c.port,f,thr0.parseLocalUnitFloat(e,c.unit));if("unit"===d)return this.getDiffUnit(b,c.port,f,e)},getValue:function(a,b,c,d,e){if(e){var f=thr0.arrayObjByKey(this.ios(d),
"port",c);if(!f||!thrUnits.isConvertible(f.unit,e))return 0}return this.getScale(a,b)*a.valueOf([sfsIdPrefix.diagram+b.id,this.mathId(),sfsIdPrefix.io(d)+c])*thrUnits.getFactor(e)},getDiffValue:function(a,b,c,d,e){var f={id:this.id},g=this.portio(d,c);if(g){if(2===this.calcType){a="number"===typeof g.val?g.val:a.valueOf([sfsIdPrefix.diagram+b.id,this.mathId(),sfsIdPrefix.io(d)+c]);if(0===a)return;f.sc=e/a}else f[D(d)]=[{port:c,val:e}];return{items:[f]}}},getUnit:function(a,b){var c=this.portio(b,
a);return c?c.unit:""},getDiffUnit:function(a,b,c,d){var e=this.portio(c,b);if(e){d=thrUnits.getCaseSensitiveUnit(d);var e=e.unit,f={id:this.id};if(!thrUnits.isConvertible(e,d)){var g=a.getPortConnection(this,c,b);if(g)return g.getDiffQuantity(a,e,d)}f[D(c)]=[{port:b,unit:d}];return{items:[f]}}},getShapeTransformation:function(a,b){var c=new ThrSvgTrafo;if(!a&&this.rot){var d=this.getCenter();c.rotate(this.rot,d.x,d.y)}if(!b){var d=this.getShapeBoundsRect(),e=this.width/(d.width||1),f=this.height/
(d.height||1);c.multiply({a:e,b:0,c:0,d:f,e:this.x-d.x*e,f:this.y-d.y*f})}return c},relativePt:function(a){var b=this.getCenter();return{x:thr0.round100((a.x-b.x)/(this.width||1)),y:thr0.round100((a.y-b.y)/(this.height||1))}},absolutePt:function(a){var b=this.getCenter();return{x:thr0.round100(b.x+a.x*this.width),y:thr0.round100(b.y+a.y*this.height)}},getCenter:function(){return{x:this.x+this.width/2,y:this.y+this.height/2}},getBoundsRect:function(a,b){var c={x:this.x,y:this.y,width:this.width,height:this.height},
d=this.shape;d&&(d.spec&&d.spec.auto)&&(c=thrShapes.getShapeBounds(d,c,a?a.getObjSize(this):this[d.spec.auto]));this.rot&&!b&&(c.rot=this.rot,c.cPt=this.getCenter());return c},getShapeBoundsRect:function(a){return this.shape&&this.shape.bounds?$.isArray(this.shape.bounds)?thr0.boundingRect(this.shape.bounds):this.shape.bounds:$.extend(this.getBoundsRect(a),{x:0,y:0})},getFrame:function(a,b){if(this.shape&&this.shape.frame){var c=$.isArray(this.shape.frame),d=this.getShapeTransformation(b||!c);if(c){var e=
b?0:this.rot||0;return this.shape.frame.map(function(a){var b=this.apply(a);void 0!==a.dir&&(b.dir=thr0.normalizeAngle(a.dir-e));return b},d)}c=d.applyToRect(this.shape.frame);this.rot&&(c.rot=this.rot,c.cPt=this.getCenter());return c}return this.getBoundsRect(a,b)},getConPts:function(a,b,c,d){var e=this.shape,f=c?0:this.rot||0,g=d?0:b.diagram.snapBoxBorder;a=$.isArray(a)?a.filter(function(a){return void 0!==a.dir}):void 0;if(!thrShapes.hasConPts(e))return a&&a.length?a:void 0;b=e.pts?e.pts.map(function(a){var b=
this.apply(a);a=thr0.normalizeAngle(a.dir-f);b=g?b:thr0.movedPt(b,a,g);b.dir=a;return b},this.getShapeTransformation(c)):thrShapes.getConPts(e,this.getBoundsRect(b,c),g);return a?a.concat(b):b},getText:function(a,b){var c,d;a?(c=this.text.clone(),(d=this["text"+a])?(c.tx=d.tx,c.wi=d.wi):(c.tx=this.shape&&this.shape.moreTexts&&a<=this.shape.moreTexts.length?this.shape.moreTexts[a-1].tx:"?",c.wi=void 0)):c=this.text;return b?c.clone():c},getTextrect:function(a,b,c,d){if(this.hiddenShape)return this.getBoundsRect(d);
a=this.textPos;var e=this.text;if(!c&&6===a&&(e.hasOwnProperty("x")||e.hasOwnProperty("y")||e.hasOwnProperty("width")||e.hasOwnProperty("height")))return{x:e.x+this.x,y:e.y+this.y,width:e.width,height:e.height};c=thrShapes.getShapeTextrect(this.shape,c,this.getBoundsRect(d),a,e.size,this.stdTextWidth,this.stdTextHeight,this.minTextSize);return b?thr0.expandedRect(c,-b):c},initMathEnv:function(a,b){function c(c){var d={w:c.unit};"number"===typeof c.val?(d.v=c.val,d.s=this.mix?["","y","x"][c.calcType||
0]:this.s):(d.f=c.val,d.s="");a.set(b,this.c+c.port,d)}var d=this.calcType,e=1===d?"y":5===d?"x":void 0===d?void 0:"";b.push(this.mathId());a.set(b,void 0,{w:this.unit,s:e,t:this.text.tx?thr0.firstLine(this.text.tx):this.idName()});2===d&&a.set(b,sfsIdPrefix.scale,{v:this.sc});a.syncObjParams(b,sfsIdPrefix.parameter,this.params);this.inputs.forEach(c,{c:sfsIdPrefix.input,s:e,mix:6===d});this.outputs.forEach(c,{c:sfsIdPrefix.output,s:e,mix:6===d});3===d||4===d?a.syncObjEquation(b,sfsIdPrefix.item,
RegExp("^["+sfsIdPrefix.input+"][0-9]+$"),RegExp("^["+sfsIdPrefix.output+"][0-9]+$"),4===d,d):a.set(b,sfsIdPrefix.item,{v:d});b.pop()},syncMathEnv:function(a,b,c){function d(c,d,e,f){if(d.delIds)d.delIds.forEach(function(d){a.unset(b,[c+d])});else if(void 0!==d.val||void 0!==d.unit||void 0!==d.calcType){var g={},h=c+d.port;e=f?void 0!==d.calcType?["","y","x"][d.calcType||0]:void 0:e;if(void 0!==d.val)"number"===typeof d.val?(g.v=d.val,g.s=e):(g.f=d.val,g.s="");else if(void 0!==d.calcType)if(f=a.dataOf(b,
h),void 0!==f.v)g.s=e,g.v=f.v;else if(void 0===d.unit)return;void 0!==d.unit&&(g.w="_DELETE_"===d.unit?"":d.unit);a.set(b,h,g)}}var e,f=sfsIdPrefix.scale,g=c.calcType,h=4===g?!0:3===g?!1:void 0,i=void 0!==h,j=1===g?"y":5===g?"x":"",k=6===g;b.push(sfsIdPrefix.item+c.id);c.text&&c.text.tx&&a.set(b,void 0,{t:thr0.firstLine(c.text.tx)});e=a.statusOf(b)||"";if(void 0!==g)e!==j&&a.setFixed(b,void 0,j),i||a.syncObjEquation(b,sfsIdPrefix.item,void 0,void 0,void 0,g),2===g!==a.isSet(b,f)?a.toggleMultiplier(b,
f,sfsIdPrefix.rexIo(),j):k||a.setFixed(b,sfsIdPrefix.rexIo(),j);else var l=a.valueOf(b,sfsIdPrefix.item),j=e,i=void 0===l,k=6===l;c.params&&a.syncObjParams(b,sfsIdPrefix.parameter,c.params);c.hasOwnProperty(f)&&"_DELETE_"!==c[f]&&a.set(b,f,{v:c[f]});c.inputs&&c.inputs.forEach(function(a){d(sfsIdPrefix.input,a,j,k)});c.outputs&&c.outputs.forEach(function(a){d(sfsIdPrefix.output,a,j,k)});i?a.syncObjEquation(b,sfsIdPrefix.item,sfsIdPrefix.rexPre(sfsIdPrefix.input),sfsIdPrefix.rexPre(sfsIdPrefix.output),
h,g):void 0!==g&&a.set(b,sfsIdPrefix.item,{v:g});b.pop()}};o.SfsDiagram=function(a){this.items=[];this.connections=[];this.instantiate(a)};SfsDiagram.prototype={thrClsName:"Diagram",id:0,hideSfsBrand:!1,maxConWidth:80,snapBoxBorder:10,name:"",palette:0,palSwap:0,color:"#fff",dispUnit:"kg",viewMode:0,nextConId:0,nextItemId:0,width:1200,height:800,comment:"",calcStatus:0,instantiate:function(a){var b,c;thr0.clearObject(this);a&&$.extend(this,a);this.line=new ThrLine(this.line);this.legend=new SfsLegend(this.legend?
this.legend:{});this.params=this.params&&this.params.length?$.extend(!0,[],this.params):[];this.items&&this.items.length?(c=1,this.items=this.items.map(function(a){0>=(a.id||0)?b=!0:a.id>=c&&(c=a.id+1);return new SfsItem(a)}),b&&this.items.forEach(function(a){if(0>=(a.id||0))a.id=c++}),this.nextItemId=c):this.items=[];this.connections&&this.connections.length?(b=!1,c=1,this.connections=this.connections.map(function(a){0>=(a.id||0)?b=!0:a.id>=c&&(c=a.id+1);return new SfsConnection(a)}),b&&this.connections.forEach(function(a){if(0>=
(a.id||0))a.id=c++}),this.nextConId=c):this.connections=[]},idName:function(a){return B.ntx.diagram+thr0.idStr("0000",a||this.id)},getClsCaption:function(a){return a?B.ntx.diagrams:B.ntx.diagram},newItemId:function(){this.nextItemId||(this.nextItemId=thr0.maxOfArray(this.items,"id",0)+1);return this.nextItemId},newConId:function(){this.nextConId||(this.nextConId=thr0.maxOfArray(this.connections,"id",0)+1);return this.nextConId},defaultItemPos:function(){function a(a){return a.x===this.x&&a.y===this.y}
for(var b={x:SfsItem.prototype.x,y:SfsItem.prototype.y};this.items.some(a,b);)thr0.addXY(b,{x:10,y:10});return b},defaultItemSize:function(){var a=this.defaultItem||{};return{width:a.width||SfsItem.prototype.width,height:a.height||SfsItem.prototype.height}},objSpec:function(){return{type:this.thrClsName,id:this.id}},isEmpty:function(){return!this.items.length&&!this.connections.length},getItem:function(a){return thr0.arrayObjByKey(this.items,"id",a)},maxGroupId:function(){return this.items.reduce(function(a,
b){return b.groups?Math.max(a,parseInt(b.groups.split(",").pop(),10)):a},0)},itemsOfGroup:function(a){return this.items.filter(function(b){return b.groups&&0<=b.groups.split(",").indexOf(a)})},itemFromPoint:function(a,b,c){for(var d=this.items.length-1;0<=d;d--)if(thr0.pointInRect(a,thr0.expandedRect(this.items[d],b))&&(!c||!this.items[d].frozen))return this.items[d]},getItemConPoints:function(a,b){var c=b?1:0,d=[];this.connections.forEach(function(b){b.points.forEach(function(f,g){f.itemId===a&&
f.way===c&&d.push({con:b,pt:f,ptx:g})})});return d},getInports:function(a){return this.getPorts(a,!0)},getOutports:function(a){return this.getPorts(a,!1)},getPorts:function(a,b){var c=b?"in":"out",d=new ThrUnitValAggregator(this.dispUnit),e=this.getPortConnections()[D(b)].map(function(b){var e=thr0.arrayObjByKey(b.con.points,"id",b.port),f=e?b.con.getPointUnit(this,e):this.dispUnit,e=e?b.con.getPointValue(a,this,e,f):0;d.add(e,f,!0);return{id:sfsIdPrefix.connection+b.con.id+"."+sfsIdPrefix.conPoint+
b.port,way:c,name:b.con.name||b.con.idName(),value:e,unit:f}},this),f=d.majorUnit();e.push({id:"total",way:c,name:B.ntx.total,value:d.getSum(f),unit:f,isTotal:!0});return e},isCombi:function(a,b){var c=this.getItem(a);return c&&(b?c.combiIn:c.combiOut)},isCombiStretch:function(a,b){var c=a.points,d=a.stretches[b];return void 0!==c[d.a].itemId&&!this.isCombi(c[d.a].itemId,1===c[d.a].way)||void 0!==c[d.b].itemId&&this.isCombi(c[d.b].itemId,1===c[d.b].way)},getConnection:function(a){return thr0.arrayObjByKey(this.connections,
"id",a)},getPortConnection:function(a,b,c){return thr0.findInArray(this.connections,function(a){return a.isAttachedTo(this.id,this.isIn,this.p)},{id:a.id,isIn:b,p:c})},getPortConnections:function(a){var b=void 0===a;return this.connections.reduce(function(c,d){d.points.forEach(function(e){2>e.way&&e.itemId===a&&c[D(b?!e.way:e.way)].push({port:b?e.id:e.port,con:d})});return c},{inputs:[],outputs:[]})},getMaxZindex:function(){return thr0.maxOfArray(this.connections,"z",thr0.maxOfArray(this.items,"z",
0))},getElementFromZindex:function(a){return thr0.arrayObjByKey(this.connections,"z",a)||thr0.arrayObjByKey(this.items,"z",a)},setWidth:function(a){this.width=this.items.reduce(function(a,c){return Math.max(a,c.x+c.width)},a)},setHeight:function(a){this.height=this.items.reduce(function(a,c){return Math.max(a,c.y+c.height)},a)},findUsedFilters:function(){function a(a){a.innerEffect&&thr0.pushIfNEx(this[0],a.innerEffect-1);a.outerEffect&&thr0.pushIfNEx(this[1],a.outerEffect-1)}var b=[[],[]];this.legend&&
this.legend.visible&&a.apply(b,[this.legend]);this.connections.forEach(a,b);this.items.forEach(a,b);return b},initMathEnv:function(a,b){function c(c){c.initMathEnv(a,b)}b.push(sfsIdPrefix.diagram+this.id);a.set(b,void 0,{t:this.name||this.idName()});this.params&&a.syncObjParams(b,sfsIdPrefix.parameter,this.params);this.items.forEach(c);this.connections.forEach(c);b.pop()},syncMathEnv:function(a,b,c){function d(a,c,d){(c=c&&c.length?c[0].delIds:void 0)&&c.forEach(function(c){b.unset(a,[d+c])})}var e=
[sfsIdPrefix.diagram+a];c.name&&b.set(e,void 0,{t:c.name});c.params&&b.syncObjParams(e,sfsIdPrefix.parameter,c.params);d(e,c.connections,sfsIdPrefix.connection);d(e,c.items,sfsIdPrefix.item);c.items&&c.items.forEach(function(a){a.delIds||this.syncMathEnv(b,e,a)},new SfsItem);c.connections&&c.connections.forEach(function(a){a.delIds||this.syncMathEnv(b,e,a)},new SfsConnection)}};o.SfsModelController=function(){this.managedInstances=[];this.mathEnv=new ThrMathEnv(RegExp("^["+sfsIdPrefix.diagram+"][0-9]+$"),
sfsIdPrefix.rexParameters(),sfsIdPrefix.rexBaseUnit())};SfsModelController.prototype={rootObjSpecs:[{type:"Diagram",id:1},{type:"Userform",id:1},{type:"Scenarioenv",id:1}],file:void 0,getKeyAdmin:function(a){var b={items:"id",connections:"id",diagrams:"id",params:"id",inputs:"port",outputs:"port"};return new ThrKeyAdmin(a?$.extend(b,a):b,["shape","gradient"])},getObjFactory:function(a){var b={items:function(){return new SfsItem},connections:function(){return new SfsConnection},diagrams:function(){return new SfsDiagram},
legend:function(){return new SfsLegend},text:function(){return new ThrText},tagText:function(){return new ThrText},line:function(){return new ThrLine},tagLine:function(){return new ThrLine}};return new ThrObjFactory(a?$.extend(b,a):b)},openFile:function(a){this.file&&this.closeFile();a&&a instanceof ThrFile&&(this.file=a)},closeFile:function(){var a=this.file;a&&(this.mathEnv.clear(),this.removeManagedInstances(),this.file=void 0,thr0.notify("notifyFileClosed",a))},startTransaction:function(){this.file.startTransaction(this)},
applyDiff:function(a,b){var c=thr0.cleanDiff(b);return c?this.file.applyDiff(this,a,c):!1},cancelTransaction:function(){this.file.cancelTransaction()},endTransaction:function(){this.file.endTransaction()},setManagedInstance:function(a,b,c){var d=this.mathEnv,e=this.getManagedInstance(a,c);e?e.obj=b:this.managedInstances.push({type:a.type,id:a.id,obj:b,ctx:c});if(d.isEmpty()&&b instanceof SfsDiagram){d.skipCheck=!0;try{b.initMathEnv(d,c),d.postProcessSet(),d.hasChanges()&&(d.calculate(!0),d.clearChanges())}finally{d.skipCheck=
!1}}else b instanceof ThrUserform&&b.sort()},getManagedInstance:function(a,b){return thr0.findInArray(this.managedInstances,function(a){return a.type===this.type&&a.id===this.id&&thr0.equalArrays(a.ctx,this.ctx)},{type:a.type,id:a.id,ctx:b})},getManagedInstances:function(a){return a?this.managedInstances.filter(function(a){return a.type===this.type&&a.id===this.id},a):[]},deleteManagedInstances:function(a){this.managedInstances.forEach(function(b){b.type===a.type&&b.id===a.id&&(b.obj=void 0)})},removeManagedInstance:function(a){this.managedInstances=
this.managedInstances.filter(function(b){return b.obj!==a})},removeManagedInstances:function(a){this.managedInstances=a?this.managedInstances.filter(function(b){return b.type!==a.type||b.id!==a.id}):[]},getWrapInfoDiff:function(a,b){var c=thr0.notifiers;if(c)for(var d=0;d<c.length;d++)if("function"===typeof c[d].getWrapInfoDiff)return c[d].getWrapInfoDiff(a,b)},syncModel:function(a,b,c){if(a.objs){var d=this.mathEnv;b&&(d.skipCheck=!0);try{a.objs.forEach(function(a){"Diagram"===a.type?(new SfsDiagram).syncMathEnv(a.id,
this.mathEnv,c?a.undoData:a.diffData):"Userform"===a.type&&this.getManagedInstances(a).forEach(function(a){a.obj&&a.obj.sort()})},this),b&&(d.postProcessSet(),d.hasChanges()&&(d.calculate(!0),d.clearChanges()))}finally{b&&(d.skipCheck=!1)}}},processValueChanges:function(a,b){function c(a){this.op.apply(a.obj,this.d)}var d,e,f,g;e=this.mathEnv;a&&this.syncModel(a,this.pasting);if(e.hasChanges()&&(a||(a={objs:[]},b=thrRevisioning.diffOp),e.calculate(),f={},e.changes.forEach(function(a){this.compileDiffsFromMathEnv(a,
f)},this),e.clearChanges(),!$.isEmptyObject(f)))for(d in f)f.hasOwnProperty(d)&&(g={type:"Diagram",id:parseInt(d.slice(1),10)},e=this.getManagedInstances(g),this.applyPostProcessDiff(e.shift().obj,f[d],this.file.getFileRevObj(a,g,!0),b),e.forEach(c,{op:b,d:f[d]}));return a},compileDiffsFromMathEnv:function(a,b){function c(a,b){var c=a.formulaOf(b);return c?c.toString(a,b):a.valueOf(b)}function d(a,b){return"number"===typeof a&&"number"===typeof b?thr0.numEqual(a,b):a===b}var e,f,g,h,i,j,k=sfsIdPrefix.diagram;
f=0;for(g=a.length;f<g;f++){var l=a[f].charAt(0),m=parseInt(a[f].slice(1),10);if(l===k){var n=this.getManagedInstances({type:"Diagram",id:m});j&&$.isEmptyObject(e)&&delete b[k+j.id];e=(j=n.length?n[0].obj:void 0)?thr0.assertProp(b,k+j.id,{}):void 0}if(j&&l===sfsIdPrefix.item)h=j.getItem(m),i=void 0;else if(j&&l===sfsIdPrefix.connection)i=j.getConnection(m),h=void 0;else if(h&&(l===sfsIdPrefix.input||l===sfsIdPrefix.output)){if(this.mathEnv.isSet(a)){var n=c(this.mathEnv,a),l=D(l===sfsIdPrefix.input),
p=thr0.arrayObjByKey(h[l],"port",m);p&&!d(p.val,n)&&(thr0.assertArrayObj(thr0.assertProp(thr0.assertArrayObj(thr0.assertProp(e,"items",[]),"id",h.id),l,[]),"port",m).val=n)}}else if(h&&a[f]===sfsIdPrefix.scale)thr0.assertArrayObj(thr0.assertProp(e,"items",[]),"id",h.id).sc=this.mathEnv.isSet(a)?this.mathEnv.valueOf(a):"_DELETE_";else if(l===sfsIdPrefix.parameter&&(h||j)){if(n=c(this.mathEnv,a),(l=thr0.arrayObjByKey(h?h.params:j.params,"id",m))&&!d(l.val,n))thr0.assertArrayObj(thr0.assertProp(h?thr0.assertArrayObj(thr0.assertProp(e,
"items",[]),"id",h.id):e,"params",[]),"id",m).val=n}else if(i&&(l===sfsIdPrefix.conPoint&&this.mathEnv.isSet(a))&&(n=c(this.mathEnv,a),(l=thr0.arrayObjByKey(i.points,"id",m))&&!d(l.val,n)))if(l=thr0.assertArrayObj(thr0.assertProp(e,"connections",[]),"id",i.id),l.points||(l.points=$.extend(!0,[],i.points)),l=thr0.arrayObjByKey(l.points,"id",m))l.val=n}j&&$.isEmptyObject(e)&&delete b[k+j.id]},applyPostProcessDiff:function(a,b,c,d){var e=c.undoData?{}:void 0;d.apply(a,b,e);c.diffData=c.diffData?d.merge([c.diffData,
b]):b;e&&(c.undoData=d.merge([e,c.undoData]))},postProcessDiff:function(a,b){a.objs.forEach(function(a){var c=this.getManagedInstances(a);if(c.length&&"Diagram"===a.type){var f=c.pop().obj,g=this.getWrapInfoDiff(f,a.diffData);g&&(this.applyPostProcessDiff(f,g,a,b),c.forEach(function(a){b.apply(a.obj,g)}))}},this);try{return this.processValueChanges(a,b),!0}catch(c){return this.file.undoFileRev(this,a),this.handleMathError(c),!1}},getChangedPtx:function(a,b,c){var d=c&&a===c.from?c.to:a;return b.reduce(function(a,
b){return b<d?--a:a},d)},getObjsRevision:function(a,b,c){var d=[],e=this;if(b&&b.clear||!this.file)c&&c(d);else{if(!b&&c&&(a.forEach(function(a){a=this.getManagedInstances(a);a.length&&d.push(a[0].obj)},this),d.length===a.length)){c(d);return}this.file.getObjsRevision(a,b,function(d){!b&&d.length===a.length&&d.forEach(function(b,c){this.setManagedInstance(a[c],b,[])},e);c&&c(d)})}},applyChangedObject:function(a,b){function c(a,b){"Userform"===a.type?(delete b.idPrefix,delete b.isAuto):"Scenarioenv"===
a.type&&(thr0.removeKeyFromArray(b.scenarios,"isBase",!0),delete b.maxId,delete b.attrOrder)}var d,e=this.getManagedInstances(a);d=e.length?e[0].obj:void 0;var f="Userform"===a.type&&b.isAuto||"Scenarioenv"===a.type&&1>=b.scenarios.length;if(d){if(d=f?"_DELETE_":thrRevisioning.diffOp.createDiff(d,b,"id",["idPrefix","isAuto"]))!f&&"Scenarioenv"===a.type&&c(a,d),this.file.applyDiff(this,a,d)}else f||(d=JSON.parse(JSON.stringify(b)),c(a,d),this.file.applyNewObj(this,a,d),e.length&&(e[0].obj="Scenarioenv"===
a.type?new ThrScenarioEnvironment(d):"Userform"===a.type?new ThrUserform(d):d))},handleMathError:function(a){var b=this.getManagedInstance({type:"Diagram",id:1},[]);if(b&&b.obj)this.mathEnv.clear(),b.obj.initMathEnv(this.mathEnv,[]),thr0.notify("notifyApplyError");else throw a;},applySetMathVals:function(a,b,c){b&&b.length&&b.forEach(function(a){this.set(a.p,void 0,{v:a.v})},this.mathEnv);try{var d=this.file.donePos;this.startTransaction();this.file.notifyDone(this,this.processValueChanges());c&&
this.applyDiff(a.objSpec(),c);this.endTransaction();return this.file.donePos>d}catch(e){return this.cancelTransaction(),this.handleMathError(e),!1}},undo:function(){this.file.undo(this)},redo:function(){this.file.redo(this)},paintToDefault:function(a,b){var c=b instanceof SfsItem,d=b instanceof SfsConnection;if(c||d){var d=b.getDefaultData(),e=c?a.defaultItem:a.defaultCon;e&&(d=thrRevisioning.diffOp.createDiff(e,d,void 0,["id"]));this.applyDiff(a.objSpec(),c?{defaultItem:d}:{defaultCon:d})}},defaultDispUnit:function(){return SfsDiagram.prototype.dispUnit},
getNewDiagram:function(a){a=$.extend(!0,{},a);a.id=1;return new SfsDiagram(a)}};o.sfsSvgDiagram={diagrams:[],ntx:{firstStepsHint:"Hint 1: First set 'Design -\x3e Shown unit' to your desired unit.\nHint 2: Open the user guidelines in a second tab (menu button -\x3e tutorials -\x3e my first Sankey diagram).\nHint 3: Find 'Design -\x3e Tab \x3cAdd item\x3e' and drag an item onto the white space."},svgBrand:function(a,b,c){var d=b.line&&b.line.style?b.line.width:0;return{tag:"a",attrs:{id:a+"Brand","class":"sfsBrand",
transform:"translate("+(b.width-(d+24))+","+d+")","xlink:href":"http://www.sankeyflowshow.com",style:"cursor: pointer;"},subs:[{tag:"path",attrs:{d:"M 0,24 l 0,-5 a 13,13 0 0 1 13,-13 l 1.25,0 3.75,3.75 -3.75,3.75 -1.25,0 a 5.5,5.5 0 0 0 -5.5,5.5 l 0,5 Z",fill:"#535d03"}},{tag:"path",attrs:{d:"M 7.5,24 l 0,-5 a 5.5,5.5 0 0 1 5.5,-5.5 l 1.25,0 2.5,2.5 -2.5,2.5 -1.25,0 a 0.5,0.5 0 0 0 -0.5,0.5 l 0,5 Z",fill:"#a9bf04"}},{tag:"text",attrs:{"text-anchor":"end",x:-5,y:21,style:"fill: "+thrColors.contrastBlackWhite(c)+
"; font-family: Arial,sans-serif; font-size: 12px; font-weight: normal; cursor: pointer;"},text:"created with www.sankeyflowshow.com"}]}},newDiagram:function(a,b){var c=new Z(a,b,thr0.maxOfArray(this.diagrams,"id",-1)+1);this.diagrams.push(c);return c},disposeDiagram:function(a){a.cleanup();thr0.removeFromArray(this.diagrams,a)},getDiagram:function(a){return thr0.arrayObjByKey(this.diagrams,"id",a)},findDiagram:function(a){return thr0.findInArray(this.diagrams,function(a){return a.$svg.is(this)},
a)}};thrNtx.register(sfsSvgDiagram);P.prototype={rSt:[],rPt:[],maxVal:0,isStart:function(a,b){return this.con.stretches[b].a===a},stretchWidth:function(a){return this.con.hairline?0:Math.max(1,this.sd.diagram.viewMode?this.sd.diagram.maxConWidth:this.rSt[a].val*this.sd.conWidthScale)},z:function(){return this.con?this.con.z:-1},isCombiPt:function(a){return this.rPt&&a<this.rPt.length&&void 0!==this.rPt[a].combiPt},getPtCenter:function(a,b){return this.rSt[b].center*this.sd.conWidthScale*(this.isStart(a,
b)?1:-1)},isSankey:function(){return!this.con.hairline&&!this.sd.diagram.viewMode&&this.maxVal},getPt:function(a,b){if(this.rPt&&a<this.rPt.length){var c=this.rPt[a];if(c=b?c.combiPt||c.pt:c.pt)return c}return this.con.points[a]},isCombiSequel:function(a){if(this.rPt&&a<this.con.stretches.length)return a=this.con.stretches[a],this.isCombiPt(a.a)!==this.isCombiPt(a.b)},prepareSetPt:function(a,b,c){a<this.con.points.length&&(thr0.addXY(b,this.con.points[a]),thr0.addXY(b,this.getPt(a,c),-1))},getStretchLine:function(a,
b){return!this.rPt||!this.rPt.length?this.con.getStretchLine(a):[this.getPt(this.con.stretches[a].a,b),this.getPt(this.con.stretches[a].b,b)]},getStretchLines:function(a){return this.con.stretches.map(function(b,c){return this.getStretchLine(c,a)},this)},isCurveToLeft:function(a,b){return 180>thr0.normalizeAngle(this.rSt[b].angle-this.rSt[a].angle)},relativeOffset:function(a,b,c){return this.rSt[a].center*(this.isCurveToLeft(b,a)?1:-1)*(c?-1:1)*this.sd.conWidthScale+this.stretchWidth(a)/2},pushAngleOrdered:function(a,
b,c){b={stx:b,angle:this.isStart(c,b)?this.rSt[b].angle:thr0.reverseAngle(this.rSt[b].angle)};a.splice(thr0.indexOfSorted(a,"angle",b.angle,!0),0,b)},hasTCrossing:function(){return this.rPt.some(function(a){return 2<a.st.length&&(1===a.countStart||1===a.countEnd)})},getTCrossingTrunc:function(a){var b=this.rPt[a];if(1===b.countStart&&1<b.countEnd||1===b.countEnd&&1<b.countStart)return(b=thr0.findInArray(b.st,function(b){return this.me.isStart(a,b.stx)===this.isA},{me:this,isA:1===b.countStart}))?
b.stx:void 0},getStretchPath:function(a,b,c){a=c||this.getStretchLine(a,!1);b=100*this.sd.settings.selPathWidth/b;c=thr0.lineAngle(a)+90;return thrSvg.pathFromCmds([{pt:a[0],a:c,m:b},{pt:a[0],a:c,m:-b},{pt:a[1],a:c,m:-b},{pt:a[1],a:c,m:b}])+"Z"},getClosestStx:function(a){var b=this;return this.con.stretches.reduce(function(c,d,e){d=thr0.distanceToLine(a,[b.getPt(d.a),b.getPt(d.b)]);return 0>c.d||d<c.d?{d:d,stx:e}:c},{d:-1,stx:-1}).stx},hasExcenteredStretch:function(){return this.rSt.some(function(a){return a.center})},
getArrowLength:function(a,b,c,d){var e=this.con;if(c){d=(90-(d||e.arrowHeadAngle)/2)*thr0.deg2rad;var f=Math.tan(d)/2;return!b||a>=e.minHeadSize?f*(b?a:e.minHeadSize):1===c?f*((2*e.minHeadSize+a)/3):2===c?f*e.minHeadSize:f*a+Math.atan(d)*(e.hairline?2*e.line.width:8>a?2*a:a)}return 0},prepareRenderInfo:function(a,b){var c=this.con,d=c.hairline?c.stretches.map(function(){return 0}):c.getStretchValues(a,this.sd.diagram);this.maxVal=thr0.maxOfArray(d,0);this.rSt=d.map(function(a,b){return{angle:thr0.lineAngle(this.getStretchLine(b)),
val:a}},this);this.rPt=c.points.map(function(a,d){var g={st:[],countStart:0,countEnd:0},h=0<a.itemId?thr0.indexOfKey(b,"id",a.itemId):-1;0<=h&&(g.aa=b[h].aa);c.stretches.forEach(function(a,b){if(a.a===d||a.b===d)this.pushAngleOrdered(g.st,b,d),a.a===d?g.countStart++:g.countEnd++},this);2>a.way&&(g.countStart?g.isBase=!0:g.countEnd&&(g.isHead=!0),g.endType=void 0===g.aa?g.isBase?c.baseType:c.arrowType:g.isBase?0:3);return g},this).filter(function(a){return 0<a.st.length})},adjustAngles:function(){var a=
this.con.stretches;this.rSt.forEach(function(b,c){var d;d=a[c];var e=this.rPt[d.a],f=this.rPt[d.b];if(e.pt||f.pt){b.angle=thr0.angle(this.getPt(d.a),this.getPt(d.b));if(d=thr0.arrayObjByKey(e.st,"stx",c))d.angle=b.angle;if(d=thr0.arrayObjByKey(f.st,"stx",c))d.angle=thr0.reverseAngle(b.angle)}},this)},adjustStretches:function(){function a(b,c,d,e){var f={d:0,x:!1},g=b.rPt[d];if(!g.countStart||!g.countEnd){var h=b.rSt[c].angle%90;f.freeAngle=1<=h&&89>=h}else if(2>g.countStart||2>g.countEnd){var h=b.rSt[c],
i=h.angle,j=b.isStart(d,c),k=j?-1:1,l=-1,m=0;g.st.forEach(function(a){if(a.stx!==c){var d=b.rSt[a.stx],e=thr0.normalizeAngle(d.angle-i);1>e||359<e?l=a.stx:180!==e&&(m+=(180>e?-1:1)*d.val*k)}});if(0<=l){var n=b.con.points,p=b.con.otherStPt(l,d),t=void 0!==n[p].itemId,g=b.rSt[l];e&&t?(f={d:-m/2,x:!0},g.center=0,h.center=f.d):!e&&b.rPt[p].combiPt?(e=thr0.verticalAngle(i,j),p=n[d],d=n[b.con.otherStPt(c,d)],m&&(p=thr0.movedPt(p,e,m/2)),h.center&&(d=thr0.movedPt(p,e,h.center)),h.angle=thr0.angle(j?p:d,
j?d:p),g.center=0,h.center=0):(g.center=h.center+m/2,t||(f=a(b,l,p,e),f.x&&(f.d-=m/2,h.center=f.d)))}else f.freeAngle=!0}return f}this.isSankey()?this.rSt.map(function(a,c){return{rSt:a,stx:c,st:this[c]}},this.con.stretches).sort(function(a,c){return a.rSt.val-c.rSt.val}).forEach(function(b){if(void 0===b.rSt.center){b.rSt.center=0;var c=b.st.a,d=b.st.b,e=a(this,b.stx,c,this.con.isPtAttached(d)&&!this.rPt[c].combiPt);a(this,b.stx,d,!e.x&&this.con.isPtAttached(c)&&!this.rPt[d].combiPt).freeAngle&&
e.freeAngle&&(b.rSt.freeAngle=!0)}},this):this.rSt.forEach(function(a){a.center=0})},prepareStretchPts:function(){function a(a,c,d,e,f,g,h,i,j){var k=a.isStart(c,d),l=0<=f&&a.isStart(c,f),m=a.getPt(c),n=a.rSt[d];c=0<=f?a.rSt[f]:n;var p=thr0.normalizeAngle(n.angle-c.angle);if(0>f||1>p||359<p)e=m=thr0.movedPt(m,thr0.verticalAngle(n.angle,!k),e),k?n.ptA=e:n.ptB=e,!h&&0<=f&&(h=m,l?c.ptA=h:c.ptB=h);else{d=thr0.movedLine(a.getStretchLine(d),thr0.verticalAngle(n.angle,!k),e);f=thr0.movedLine(i||a.getStretchLine(f),
thr0.verticalAngle(c.angle,!l),g);k&&(d=d.reverse());l&&(f=f.reverse());m=thr0.lineIntersection(d,f);if(!m||15*(Math.abs(e)+Math.abs(g))<=thr0.distance(m,d[1])||thr0.pointInLineRect(d[0],[d[1],m])||thr0.pointInLineRect(f[0],[f[1],m])||j&&thr0.distance(f[0],m)<thr0.distance(f[0],f[1]))m=f[1];e=m;k?n.ptA=e:n.ptB=e;h||(h=m,l?c.ptA=h:c.ptB=h)}}this.rPt.forEach(function(b,c){var d=this.con.points[c],e=b.st[0].stx,f=b.st.length;if(2<f)if(e=this.getTCrossingTrunc(c),void 0!==e){var g,f=this.isSankey(),h=
this.rPt[c].st,i=this.stretchWidth(e)/2,j=thr0.indexOfKey(h,"stx",e),k=h.length;g=this.rSt[e];a(this,c,e,this.getPtCenter(c,e),-1,0,!0);g=[g.ptA||thr0.movedPt(g.ptB,g.angle,-200),g.ptB||thr0.movedPt(g.ptA,g.angle,200)];for(var l=1;l<k;l++){var m=h[(j+l)%k].stx,n=this.stretchWidth(m),p=this.rSt[m].freeAngle&&this.isCurveToLeft(m,e)?1<l:l<k-1;a(this,c,m,this.getPtCenter(c,m),e,i-n/2,!0,g,p);f&&(i-=n)}}else b.st.forEach(function(a){var b=a.stx,e=this.getPtCenter(c,b);a=this.rSt[b];b=this.isStart(c,b);
e=e?thr0.movedPt(d,thr0.verticalAngle(a.angle),e):$.extend({},d);b?a.ptA=e:a.ptB=e},this);else h=-1,i=0,2===f&&(h=b.st[1].stx,i=this.getPtCenter(c,h)),a(this,c,e,this.getPtCenter(c,e),h,i)},this);this.rSt.forEach(function(a,c){var d=thr0.angle(a.ptA,a.ptB);if(d!==a.angle){var e=this.con.stretches[c];a.angle=d;thr0.arrayObjByKey(this.rPt[e.a].st,"stx",c).angle=d;thr0.arrayObjByKey(this.rPt[e.b].st,"stx",c).angle=thr0.reverseAngle(d)}},this)},maxCurve:function(a,b,c){var d,e,f;e=this.con.stretches[a.stx];
d=this.rSt[a.stx];b?(b=d.ptA,d=d.ptB,e=this.rPt[e.b]):(b=d.ptB,d=d.ptA,e=this.rPt[e.a]);f=thr0.distance(b,d);c=c?f-thr0.distance(thr0.movedPtDelta(b,c),d):0;e.isHead||e.isBase?this.con.isArrowEnd(e.isBase)&&(f-=this.innerArrowLength(e,a.stx,e.aa)):f/=2;return Math.max(1,f-c)},innerArrowLength:function(a,b,c){return this.getArrowLength(a.combiWidth||this.stretchWidth(b),!0,a.endType,c)},setCurveSpec:function(a,b,c){var d,e,f;d=a.a;var g=a.b;f=d.stx;var h=this.con.stretches[f].a===a.ptx;e=h?this.rSt[f].ptA:
this.rSt[f].ptB;var i=Math.abs(g.angle-d.angle);180<i&&(i=360-i);f=thr0.movedPt(e,a.angle,(b-a.cw/2)/Math.max(0.001,Math.cos((90-i/2)*thr0.deg2rad)));e=thr0.distance(f,e)*Math.sin((90-i/2)*thr0.deg2rad);d=Math.min(this.maxCurve(d,h,a.delta),this.maxCurve(g,!h));if(c&&d<e&&c<e-d)return!1;if(c||d>=e||!this.setCurveSpec(a,b*d/e,e-d))a.spec={r0:b>a.cw?b-a.cw:0,r1:b,cc:f};return!0},getCurveInfo:function(a,b,c,d,e,f){var g=thr0.normalizeAngle(b.angle-a.angle),h=180<g;b={ptx:c,a:a,b:b,dAngle:g,angle:(a.angle+
g/2+(h?180:0))%360,isCL:h,cw:this.stretchWidth(a.stx),cc:e,rPrev:f};d=(b.cw+d)/2;a=Math.abs(Math.sin(Math.abs(b.angle-a.angle)*thr0.deg2rad));this.setCurveSpec(b,Math.min(700,d+0.41421*this.con.curveFactor/(1-(0.71<a?0.71+(a-0.71)/1.5:a)))*a+d,0);return b},preparePointInfos:function(){function a(a,b,c){var g=a.rSt[b],h=g.ptA,i=g.ptB,g=g.angle+90;a=a.stretchWidth(b)/2;h=[thr0.movedPt(h,g,a),thr0.movedPt(h,g,-a),thr0.movedPt(i,g,a),thr0.movedPt(i,g,-a)];return{ptSL:h[c?3:0],ptSR:h[c?2:1],ptEL:h[c?1:
2],ptER:h[c?0:3]}}function b(a,b,c,g,h,i){function j(a,b,c,d,e,f,g,h,i,j){var k=thr0.lineIntersection(b,c),l=a[h];if(k&&0<l&&thr0.pointInLineRect(k,b)){b=a.cc;if(l=thr0.lineCircleIntersection(c,b,l)){var k=thr0.pointInLineRect(l[0],c),o=1<l.length&&thr0.pointInLineRect(l[1],c);if(k&&!o)g=l[0];else if(!k&&o)g=l[1];else{var q,k=thr0.angle(b,l[0]);thr0.isAngleBetween(k,d,e,g)&&(q=l[0],g?d=k:e=k);g=1<l.length&&thr0.isAngleBetween(thr0.angle(b,l[1]),d,e,g)?l[1]:q}}else g=void 0;g||(g=thr0.lineIntersection(c,
thr0.getLine(a[j],f)),a[h]=0,g&&(a[j]=g));g&&(a[i]=g)}}var k=g.st[0];g=[g.isBase?k.pt0l:k.pt1r,g.isBase?k.pt0r:k.pt1l];c=c!==i;var k=thr0.verticalAngle(i?a.angle:b.angle,c),l=thr0.verticalAngle(i?b.angle:a.angle,!c);b=i?b.angle:a.angle;j(a,[h,i?a.oPt0:a.oPt1],g,k,l,b,c,"r1",i?"oPt0":"oPt1",i?"oPt1":"oPt0");j(a,[h,i?a.iPt0:a.iPt1],g,k,l,b,c,"r0",i?"iPt0":"iPt1",i?"iPt1":"iPt0")}var c=this;this.rPt.forEach(function(b,e){var f=b.endType;if(void 0!==f&&(0===f||3<f)){var f=c.rPt[e],g=f.isBase,h=f.st[0],
i=h.stx,j=a(c,i,!g),k=j.ptSL,l=j.ptSR,m=c.sd.diagram.getItem(c.con.points[e].itemId);if(m){var i=c.stretchWidth(i),n=c.getPt(e),p=f.combiOrtho;void 0===p&&(p=thr0.associatedFrameLine(n,m.getCenter(),m.getFrame(c.sd)),p=p.l?thr0.lineAngle(p.l):thr0.verticalAngle(p.dir,!1));thr0.isSmallAngleDelta180(h.angle,p)||(m=thr0.getLine(n,p),k=thr0.lineIntersection([k,j.ptEL],m)||k,l=thr0.lineIntersection([l,j.ptER],m)||l,thr0.distance(k,l)>4*i&&(l=thr0.centeredPt([k,l]),k=thr0.movedPt(l,p,2*i),l=thr0.movedPt(l,
p,2*-i)),f.aa&&(j=void 0!==f.combiOrtho,p=thr0.verticalAngle(thr0.lineAngle([k,l]),!0),m=Math.tan((180-f.aa)*thr0.deg2rad/2),n=j?f.cw0-f.combiWidth/2:-i/2,i=n+i,0>n!==0>i&&(h[g?"pt0c":"pt1c"]=j?f.combiPt:thr0.centeredPt([k,l])),k=thr0.movedPt(k,p,Math.abs(n)*m),l=thr0.movedPt(l,p,Math.abs(i)*m)))}h[g?"pt0l":"pt1r"]=k;h[g?"pt0r":"pt1l"]=l}});this.rPt.forEach(function(d,e){if(!d.isHead&&!d.isBase){var f=c.getTCrossingTrunc(e),g=void 0!==f;if(2===d.st.length||g){var h=function(a){var b=c.getCurveInfo(a.a,
a.b,e,this.offset,this.cc,this.r1);this.hasOffset&&(this.offset+=a.cw,this.cc=b.spec.cc,this.r1=b.spec.r1);return b},i=c.rPt[e],j=i.st,k=void 0!==f,l=(k||i.cw0)&&c.isSankey(),i=l?i.cw0||0:0,m=k?thr0.indexOfKey(j,"stx",f):0,n=j.length,p=j.map(function(a,b){if(k?a.stx!==f:!b){var d=j[k?m:(b+1)%n];return{a:a,b:d,dAngle:thr0.normalizeAngle(d.angle-a.angle),cw:c.stretchWidth(a.stx)}}}).filter(function(a){return void 0!==a}),t=p.filter(function(a){return 180<a.dAngle}).sort(function(a,b){return b.dAngle-
a.dAngle}),p=p.filter(function(a){return 180>=a.dAngle}).sort(function(a,b){return a.dAngle-b.dAngle});t.map(h,{offset:i,hasOffset:l}).concat(p.map(h,{offset:i,hasOffset:l})).forEach(function(a){var d=$.extend(a.a,a.spec),e=a.b,f=c.con,h=d.cc,i=d.r1,j=i-a.cw,k=thr0.verticalAngle(d.angle,!a.isCL),l=thr0.verticalAngle(e.angle,a.isCL),m=a.ptx,n=thr0.movedPt(h,k,j),p=0>=j&&!thr0.numEqual(d.angle,e.angle)?thr0.lineIntersection(thr0.getLine(h,(d.angle+e.angle)/2,1E4),thr0.getLine(n,d.angle,1E4)):void 0;
g&&(p&&thr0.distance(f.points[m],p)>Math.max(thr0.distance(f.points[m],f.points[f.otherStPt(d.stx,m)]),thr0.distance(f.points[m],f.points[f.otherStPt(e.stx,m)])))&&(p=n);$.extend(d,{isCL:a.isCL,oPt0:thr0.movedPt(h,k,i),iPt0:p||n,oPt1:thr0.movedPt(h,l,i),iPt1:p||thr0.movedPt(h,l,j)});g||$.extend(e,a.spec,{isCL:!d.isCL,oPt0:d.oPt1,iPt0:d.iPt1,oPt1:d.oPt0,iPt1:d.iPt0});a=c.rPt[f.otherStPt(d.stx,m)];0===a.endType&&b(d,e,d.isCL,a,f.points[m],!0);a=c.rPt[f.otherStPt(e.stx,m)];0===a.endType&&b(d,e,d.isCL,
a,f.points[m],!1)})}else if(2<d.st.length){var r,h=c.rPt[e].st,s=h[h.length-1],o=a(c,s.stx,!c.isStart(e,s.stx));h.forEach(function(b){r=a(c,b.stx,!c.isStart(e,b.stx));s.pt0=thr0.lineIntersection([o.ptSL,o.ptEL],[r.ptSR,r.ptER])||thr0.centeredPt([o.ptEL,r.ptSR]);s=b;o=r})}}});this.rPt.forEach(function(b,e){var f,g,h=b.endType;if(void 0!==h&&0<h&&3>=h){var i=0,j=c.rPt[e];c.sd.diagram.getItem(c.con.points[e].itemId);var k=j.aa,l=void 0!==j.combiOrtho,h=j.st[0],m=h.angle,n=j.isHead,p=h.stx,t=a(c,p,!n);
g=t;if((f=thr0.arrayObjByKey(c.rPt[c.con.otherStPt(p,e)].st,"stx",p))&&f.iPt0&&f.oPt0){var r=[f.iPt0,f.oPt0];f=thr0.lineIntersection([g.ptSL,g.ptEL],r)||g.ptSL;g=thr0.lineIntersection([g.ptSR,g.ptER],r)||g.ptSR}else f=g.ptSL,g=g.ptSR;var s=c.innerArrowLength(j,p,k),o=s,r=l?j.combiPt:thr0.centeredPt([t.ptER,t.ptEL]);if(l){var z=c.rSt[p],w=z[n?"ptB":"ptA"],i=thr0.distance(w,r),i=i*Math.sin((m-thr0.angle(r,w)-90)*thr0.deg2rad);0.1<Math.abs(i)&&(z[n?"ptB":"ptA"]=thr0.movedPt(w,m,i),t=a(c,p,!n))}void 0!==
k&&l&&(k=Math.tan((180-k)*thr0.deg2rad/2),j=j.cw0-j.combiWidth/2,p=j+c.stretchWidth(p),0>j===0>p&&(r=void 0),o=Math.abs(j)*k,s=Math.abs(p)*k);r&&(h[n?"pt0c":"pt1c"]=r);h[n?"pt0r":"pt1l"]=thr0.movedPt(t.ptER,m,o,g);h[n?"pt0l":"pt1r"]=thr0.movedPt(t.ptEL,m,s,f)}})},ptsAroundPath:function(a,b,c,d){return b+c.x+" "+c.y+a+"L"+d.x+" "+d.y},renderArrowHeadPath:function(a,b,c,d,e,f){c=this.stretchWidth(c);var g=this.con.minHeadSize,h=this.rPt[d];d=h.st[0];var i=e?d.pt1c:d.pt0c,j=i?"L"+i.x+" "+i.y:"";if(f&&
this.con.hairline)return i=thr0.movedPt(i||h.pt,d.angle,this.con.line.width/1),b+i.x+","+i.y;if(c<g&&!h.combiPt){var k=this.getArrowLength(c,!1,h.endType,h.aa);f=thr0.reverseAngle(d.angle);h=f+90;i=thr0.movedPt(thr0.movedPt(i,h,-g/2),f,-k);g=thr0.movedPt(i,h,g);j=this.ptsAroundPath(j,"L",i,g);3===a&&(a=Math.atan((90-this.con.arrowHeadAngle/2)*thr0.deg2rad)*(this.con.hairline?2*this.con.line.width:8>c?2*c:c),j=this.ptsAroundPath(j,"L",thr0.movedPt(i,f,-a),thr0.movedPt(g,f,-a)))}return this.ptsAroundPath(j,
b,e?d.pt1l:d.pt0r,e?d.pt1r:d.pt0l)},renderEndDiamond:function(a,b,c,d){var e=thr0.movedPt(b,d+30,c+15);c=thr0.movedPt(b,d-30,c+15);b=this.ptsAroundPath("L"+b.x+","+b.y,"L",e,c);return this.ptsAroundPath(b,a,thr0.movedPt(e,d-30,15),thr0.movedPt(c,d+30,15))},renderEndCircle:function(a,b,c,d){var e="",f=thr0.round100((c+(8>c?10:15))/2),g=Math.asin(c/(2*f))/thr0.deg2rad,h=thr0.movedPt(b,d+g,f);b=thr0.movedPt(b,d-g,f);c||(c=thr0.movedPt(h,d,-2*f),e="A"+f+","+f+" 0 1 0 "+c.x+","+c.y);return a+h.x+","+h.y+
e+"A"+f+","+f+" 0 1 0 "+b.x+","+b.y},renderEndSquare:function(a,b,c,d){var e=(c+(8>c?10:15))/2;b=thr0.movedPt(thr0.movedPt(b,d,-e),d+90,e);var f=thr0.movedPt(b,d-90,2*e),g="L"+b.x+","+b.y+" "+f.x+","+f.y;b=thr0.movedPt(b,d,2*e);f=thr0.movedPt(f,d,2*e);g=this.ptsAroundPath(g,"L",b,f);return this.ptsAroundPath(g,a,thr0.movedPt(b,d-90,e-c/2),thr0.movedPt(f,d+90,e-c/2))},renderEndCrowbar:function(a,b,c,d,e,f){var g,h,i=thr0.normalizeAngle(d-e),j=c/(8>c?1:2),k=Math.max(8,j);if(c){g=thr0.movedPt(b,e+90,
j/2);h=thr0.movedPt(g,e-90,j);d=this.ptsAroundPath(" "+g.x+","+g.y+" "+h.x+","+h.y," ",thr0.movedPt(g,e,2*k),thr0.movedPt(h,e,2*k));g=thr0.movedPt(g,e+90,k);h=thr0.movedPt(h,e-90,k);d=this.ptsAroundPath(this.ptsAroundPath(d," ",g,h),"L",thr0.movedPt(g,e+90,j),thr0.movedPt(h,e-90,j));b=thr0.movedPt(b,e,2*(k+1.5*j)-1.7321*(c/2));g=thr0.movedPt(b,e+90,c/2);h=thr0.movedPt(b,e-90,c/2);d=this.ptsAroundPath(d,"",g,h);1===f?d=this.renderEndCuttingLine("","L"+d,b,c,k+j,e,90):2===f&&(j=thr0.round100(0.66667*
(j+k)),k=2*Math.sqrt(j*j-c*c/4),g=thr0.movedPt(g,e,k),h=thr0.movedPt(h,e,k),d=g.x+","+g.y+"A"+j+","+j+" 0 0 0 "+d+"A"+j+","+j+" 0 0 0 "+h.x+","+h.y);if(3>Math.abs(i))return a+d;if(180<i)return g=thr0.movedPt(g,e,(1===f?j:0)-c*Math.sin(i*thr0.deg2rad)),a+g.x+","+g.y+"L"+d;h=thr0.movedPt(h,e,(1===f?j:0)+c*Math.sin(i*thr0.deg2rad));return a+d+"L"+h.x+","+h.y}i="M"===a;j=this.con.line.width;k=Math.max(8,j);g=thr0.movedPt(b,e,2*(k+j));d=this.ptsAroundPath("L"+g.x+","+g.y,"M",thr0.movedPt(b,e+90,k+j),thr0.movedPt(b,
e-90,k+j));b=b.x+","+b.y;b=(i?b+"L":"")+g.x+","+g.y+(i?"":"L"+b);1===f?d=this.renderEndCuttingLine("M",d,g,c,k+j,e,90):2===f&&(k*=0.66667,h=thr0.movedPt(g,e,2*k),d+="M"+g.x+","+g.y+"A"+k+","+k+" 0 0 0 "+h.x+","+h.y,b=(i?b:h.x+","+h.y)+"A"+k+","+k+" 0 0 "+(i?"1 "+h.x+","+h.y:" 0"+b));return i?d+a+b:a+b+d},renderEndFitting:function(a,b,c,d,e,f){var g=c||2*this.con.line.width,h=g/(8>g?1:2),i=Math.max(2*h,8)*(c?1.5:1),j=thr0.movedPt(b,e+90,h+(g+i)/2),k=thr0.movedPt(b,e-90,h+(g+i)/2);if(c)return c=this.ptsAroundPath("",
"L",j,k),j=thr0.movedPt(j,d,h+i),k=thr0.movedPt(k,d,h+i),c=this.ptsAroundPath(c,"L",j,k),f?(j=thr0.movedPt(thr0.movedPt(j,e-90,i),d,-i),k=thr0.movedPt(thr0.movedPt(k,e+90,i),d,-i),c=this.ptsAroundPath(c,"L",j,k),j=thr0.movedPt(j,e+90,h),k=thr0.movedPt(k,e-90,h),c=this.ptsAroundPath(c,"L",j,k),b=i-2*h,j=thr0.movedPt(thr0.movedPt(j,e+90,b),d,b),k=thr0.movedPt(thr0.movedPt(k,e-90,b),d,b),c=this.ptsAroundPath(c,"L",j,k),j=thr0.movedPt(j,d,-b),k=thr0.movedPt(k,d,-b)):(j=thr0.movedPt(j,e-90,h),k=thr0.movedPt(k,
e+90,h),c=this.ptsAroundPath(c,"L",j,k),j=thr0.movedPt(j,d,-i),k=thr0.movedPt(k,d,-i)),this.ptsAroundPath(this.ptsAroundPath(c,"L",j,k),a,thr0.movedPt(j,e-90,i/2),thr0.movedPt(k,e+90,i/2));i*=2;c=this.ptsAroundPath("L"+j.x+","+j.y+" "+k.x+","+k.y,f?"L":"M",thr0.movedPt(j,d,i),thr0.movedPt(k,d,i));f&&(j=thr0.movedPt(b,d,g/2),c=this.ptsAroundPath(c,"M",j,j));d=a+b.x+","+b.y;return"M"===a?c+d:d+c},renderEndCuttingLine:function(a,b,c,d,e,f,g){var h=g*thr0.deg2rad,i=d&&8>d?2*d:d,j=d/(2*Math.sin(h)),k=
i/(2*Math.sin(h)),l=k*Math.cos(h)/2,h=thr0.movedPt(c,f+g,j);c=thr0.movedPt(c,f+g-180,j);j=thr0.movedPt(h,f+g,e+l);e=thr0.movedPt(c,f+g-180,e-l);if(d)return b=this.ptsAroundPath(this.ptsAroundPath(b,"L",h,c),"L",j,e),b=this.ptsAroundPath(b,"L",thr0.movedPt(j,f+g-90,i/2),thr0.movedPt(e,f+g-90,i/2)),this.ptsAroundPath(b,a,thr0.movedPt(h,f,k),thr0.movedPt(c,f,k));d=this.ptsAroundPath("","M",j,e);return"M"===a?d+b:b+d},renderBasePath:function(a,b,c,d,e){d=this.rPt[d].st[0];var f=e?d.pt1r:d.pt0l,g=e?d.pt1l:
d.pt0r,h=e?d.pt1c:d.pt0c;if(a){d=d.angle;var i=[f,g],h=thr0.centeredPt(i);c=this.stretchWidth(c);if(0<=[1,2].indexOf(a))return this.renderEndDiamond(b,h,c,d);if(0<=[3,4].indexOf(a))return this.renderEndCircle(b,h,c,d);if(0<=[5,6].indexOf(a))return this.renderEndSquare(b,h,c,d);if(0<=[10,11].indexOf(a))return this.renderEndFitting(b,h,c,d,thr0.verticalAngle(thr0.lineAngle(i),!1),a-10);if(0<=[12,13,14].indexOf(a))return this.renderEndCrowbar(b,h,c,d,thr0.verticalAngle(thr0.lineAngle(i),!1),a-12);e=
c?this.ptsAroundPath("","L",f,g):(e?"L":"M")+f.x+","+f.y;f=c||2*this.con.line.width;g=Math.max(f,8);h=thr0.movedPt(h,d,7!==a?g:g+f/2);return 7===a?this.renderEndCuttingLine(b,e,h,c,1.41421*g,d,135):8===a?(e=this.renderEndCuttingLine("L",e,h,c,g,d,90),this.renderEndCuttingLine(b,e,thr0.movedPt(h,d,((c&&8>c?2*f:f)+g)/2),c,g,d,90)):this.renderEndCuttingLine(b,e,h,c,1.5*g,d,90)}return this.ptsAroundPath(h?"L"+h.x+","+h.y:"",b,f,g)},renderBasePathShape:function(a,b,c,d){var e,f,g=this.rPt[b].st[0];b=d?
g.pt1r:g.pt0l;d=d?g.pt1l:g.pt0r;f=thr0.centeredPt([b,d]);var h=g.angle,g=this.stretchWidth(g.stx);if(0<=[1,2].indexOf(a))return c=c?1.41421*(8>g?g:g/2):0,e=g+15-c/0.8660254,f=thr0.movedPt(f,h,c),b=thr0.movedPt(f,h+30,e),d=thr0.movedPt(f,h-30,e),a=thr0.movedPt(b,h-30,e),"M"+f.x+","+f.y+"L"+b.x+","+b.y+" "+a.x+","+a.y+" "+d.x+","+d.y+"Z";14===a?(c=g/(8>g?1:2),e=Math.max(8,c),f=thr0.movedPt(f,thr0.angle(b,d)+90,3.66667*c+2.66667*e-g),c=thr0.round100(0.66667*e-0.33333*c)):c=c?8>g?5-(5>g?g/2:0):7.5:(g+
(8>g?10:15))/2;if(0<=[3,4,14].indexOf(a))return"M"+thr0.round100(f.x-c)+","+f.y+"a"+c+","+c+" 0 0 1 "+2*c+",0 "+c+","+c+" 0 0 1 "+-2*c+",0Z";b=thr0.movedPt(thr0.movedPt(f,h,-c),h-90,c);d=thr0.movedPt(b,h+90,2*c);a=thr0.movedPt(d,h,2*c);f=thr0.movedPt(b,h,2*c);return"M"+b.x+","+b.y+"L"+d.x+","+d.y+" "+a.x+","+a.y+" "+f.x+","+f.y+"Z"},renderLineEndPath:function(a,b,c){var d=this.rPt[c],e=d.isHead,d=d.endType;return 0<d&&3>=d?this.renderArrowHeadPath(d,a,b,c,!e,!0):this.renderBasePath(d?d-3:0,a,b,c,
e)},renderStretchesPath:function(a,b){function c(a,b,c,d){a=thr0.distance(a,b);if(0===a)return"";if(0===c)return"L"+b.x+" "+b.y;a>2*c&&(c=a/2+0.01);c=thr0.round100(c);return"A"+c+" "+c+" 0 0 "+(d?"0":"1")+" "+b.x+" "+b.y}function d(a,b,c,d,e,f){var g,h,i,j,k,l={},p=!1,t=m.isCL?m.r1:m.r0,r=n.isCL?n.r0:n.r1,o=e.angle,q=f.angle,u=a.con.points[s],v=thr0.distance(u,b),x=thr0.distance(u,c),y=thr0.distance(u,d);i=thr0.normalizeAngle(f.angle-e.angle);if(90>=i||270<=i)if(g=thr0.movedPt(u,thr0.verticalAngle(e.angle,
!1),a.stretchWidth(e.stx)/2),d=thr0.getLine(g,e.angle),g=thr0.movedPt(g,thr0.verticalAngle(f.angle,!0),a.stretchWidth(f.stx)/2),h=thr0.getLine(g,f.angle),k=(g=thr0.lineIntersection(d,h))?thr0.distance(u,g):Math.max(v,x)+1,k>=v&&k<x){j=thr0.lineCircleIntersection(d,f.cc,r)||(a.con.hairline?thr0.lineCircleIntersection(d,f.cc,r+1):void 0);if(void 0!==j)return l.noCurve0=!0,o=thr0.verticalAngle(e.angle,!f.isCL),q=thr0.verticalAngle(f.angle,!f.isCL),a=thr0.angle(f.cc,j[0]),thr0.isAngleBetween(a,q,o,!f.isCL)&&
(l.pt=j[0],o=a),1<j.length&&thr0.isAngleBetween(thr0.angle(f.cc,j[1]),q,o,!f.isCL)&&(l.pt=j[1]),l.pt?l:void 0;o+=180;p=!0}else if(k<v&&k>=x){j=thr0.lineCircleIntersection(h,e.cc,t);if(void 0!==j)return l.noCurve1=!0,o=thr0.verticalAngle(e.angle,!e.isCL),q=thr0.verticalAngle(f.angle,!e.isCL),a=thr0.angle(e.cc,j[0]),thr0.isAngleBetween(a,o,q,!f.isCL)&&(l.pt=j[0],q=a),1<j.length&&thr0.isAngleBetween(thr0.angle(e.cc,j[1]),o,q,!f.isCL)&&(l.pt=j[1]),l.pt?l:void 0;q+=180;p=!0}else if(k>=v&&k>=x)return{pt:g||
thr0.centeredPt([b,c]),noCurve0:!0,noCurve1:!0};if(15<=i&&345>=i)return j=j||thr0.circleIntersection(e.cc,t,f.cc,r,!0),j.length&&(g=thr0.centeredPt(j)),(g=thr0.findInArray(j,function(a){return thr0.isAngleBetween(thr0.angle(g,a),o,q,p)||thr0.distance(u,a)<y}))?{pt:g}:{hasLine:!0}}var e,f,g,h,i,j,k,l,m,n,p,t="",r=this.isSankey(),s=b?this.con.stretches[a].b:this.con.stretches[a].a;if(1<this.rPt[s].st.length){k=a;f=thr0.indexOfKey(this.rPt[s].st,"stx",a);m=this.rPt[s].st[f];g=this.rPt[s].st.length;for(e=
f+1;e<=f+g;e++){l=this.rPt[s].st[e%g].stx;h=this.getTCrossingTrunc(s);if(2===this.rPt[s].st.length||k===h||l===h){if(k===h?(m=this.rPt[s].st[e%g],h=(i=!m.isCL)?m.oPt1:m.iPt1,j=i?m.oPt0:m.iPt0):(h=(i=m.isCL)?m.oPt0:m.iPt0,j=i?m.oPt1:m.iPt1),!this.con.hairline||!this.isStart(s,k))t+="L"+h.x+" "+h.y+c(h,j,i?m.r1:m.r0,i)}else if(void 0!==h){h=m.isCL?m.oPt0:m.iPt0;n=this.rPt[s].st[e%g];i=n.isCL?n.iPt0:n.oPt0;j=m.isCL?m.oPt1:m.iPt1;if(!r&&(p=d(this,h,i,j,m,n))&&p.pt)j=p.pt;t=this.con.hairline&&this.isStart(s,
k)?t+("M"+j.x+" "+j.y):t+("L"+h.x+" "+h.y+(p&&p.noCurve0?"L"+j.x+" "+j.y:c(h,j,m.isCL?m.r1:m.r0,m.isCL)));m=n;r||!p||!p.hasLine?h=r?m.isCL?m.iPt1:m.oPt1:j:(h=n.isCL?n.iPt1:n.oPt1,1<thr0.distance(h,j)&&(t+="L"+h.x+" "+h.y));j=i;if(!this.con.hairline||this.isStart(s,k))t+=(r?"L"+h.x+" "+h.y:"")+(p&&p.noCurve1?"L"+j.x+" "+j.y:c(h,j,n.isCL?n.r0:n.r1,!m.isCL))}else t+=(this.con.hairline&&this.isStart(s,k)?"M":"L")+m.pt0.x+" "+m.pt0.y;e<f+g&&(t+=this.renderStretchesPath(l,this.isStart(s,l)));m=this.rPt[s].st[e%
g];k=l}}else if(this.rPt[s].isHead||this.rPt[s].isBase)t+=this.renderLineEndPath(this.con.hairline&&this.rPt[s].isBase?"M":"L",a,s);return t},renderPathShapes:function(a){var b="",c=this;a=a?[1,3,5,14]:[2,4,6];var d=this.con.baseType-3;0<=a.indexOf(d)&&this.con.points.forEach(function(a,f){a.way||(b+=c.renderBasePathShape(d,f,!0))});d=this.con.arrowType-3;0<=a.indexOf(d)&&this.con.points.forEach(function(a,f){1===a.way&&(b+=c.renderBasePathShape(d,f,!0,!0))});return b},renderTags:function(a,b){function c(b,
c,f,g,h,i,j){var k=f.stretches[g],l=b.getPt(k.a);b=b.getPt(k.b);k=k[h];g=a.attr("id")+"_"+h+g;i=thrSvg.$appendElement(a,"text",{id:g+"tx","class":"sfsTag",x:(l.x+b.x)/2+k.dx+j,y:(l.y+b.y)/2+k.dy+j},i).css(f.tagText.getTextStyle());l=thrSvg.bboxToRect(i[0].getBBox());f.tagText.orientation&&i.attr("transform","rotate("+90*f.tagText.orientation+" "+Math.round(l.x+l.width/2)+" "+Math.round(l.y+l.height/2)+")");0<=[1,3].indexOf(f.tagText.orientation)&&(l=thr0.rotatedRect(l));thrSvg.$appendElement(a,"rect",
$.extend(thr0.expandedRect(l,j),{id:g},c.getStyleAttrs({color:f.tagColor,line:f.tagLine,gradient:f.tagGradient})));a.append(i)}this.con.stretches.forEach(function(a,e){var f=this.sd,g=this.con,h=f.settings.tagBoxPadding;a.lbl&&c(this,f,g,e,"lbl",g.name||g.idName(),h);if(a.ind||a.rel){var i,j;i=g.points[a.a];var k=f.diagram;2<=i.way&&(i=g.points[a.b]);j=g.indDiagramUnits?k.dispUnit:g.getPointUnit(k,i);i=2>i.way?g.getPointValue(b,k,i,j):this.rSt[e].val*thrUnits.getConversion(k.dispUnit,j);a.ind&&c(this,
f,g,e,"ind",thr0.formatUV(i,g.indFType,g.indPrecision,g.indRoundExp,g.indThousandsSep,g.indicatorUnits?j:void 0),h);a.rel&&(i&&(i*=100/(g.indDiagramUnits?f.maxConVal:g.getTotalValue(b,k,j))),c(this,f,g,e,"rel",thr0.formatUV(i,g.percFType,g.percPrecision,g.percRoundExp,!1,"%"),h))}},this)},render:function(a){var b,c,d=this.con,e=this.sd,f=e.$getSubGroup("C",d.id).empty();this.adjustAngles();this.adjustStretches();this.prepareStretchPts();this.preparePointInfos();if(6>(d.hairline?d.line.width:(e.diagram.viewMode?
1:this.maxVal)*e.conWidthScale))b={id:e.getHtmlId("C",d.id)+"c",stroke:"#000","stroke-opacity":1E-4,"stroke-width":9,d:d.stretches.map(function(a,b){var c=this.getStretchLine(b);return"M"+thr0.round100(c[0].x)+","+thr0.round100(c[0].y)+"L"+thr0.round100(c[1].x)+","+thr0.round100(c[1].y)},this).join("")},thrSvg.$appendElement(e.$getGroup("C"),"path",b);b=thr0.indexOfKey(this.rPt,"isBase",!0);c=this.rPt[b].st[0].stx;e.renderShape(f,d,this.renderLineEndPath("M",c,b)+this.renderStretchesPath(c,!0)+(d.hairline?
"":"Z"+this.renderPathShapes(!0)));if(d.hairline){var g=[];b=this.renderPathShapes(!1);d.points.forEach(function(a,b){var c=this.rPt[b].endType;void 0!==c&&(0<c&&3>=c)&&g.push(this.renderArrowHeadPath(c,"M",this.con.nextPtStx(b),b,!a.way,!1)+" z")},this);(g.length||""!==b)&&e.renderShape(f,d.line,g.join(" ")+b)}this.renderTags(f,a)}};Y.prototype={z:function(){return this.item?this.item.z:-1},getBoundsRect:function(){return this.item.getBoundsRect(this.sd)},render:function(a){var b=this.item,c=this.sd.$getSubGroup("I",
b.id).empty();b.hiddenShape||this.sd.renderShape(c,b);this.renderText(c,a)},renderText:function(a,b,c){var d=this.item;if(0<d.textPos){var e=this.sd,f=e.diagram,g=e.settings.itemBoxPadding,h=e.settings.textLinePadding,i=d.text.dispText(e.attrs,d.showTotals),j=d.getTextrect(f,i.size*g,0,e),k=(c=c?0:d.rot)?d.getCenter():0;if(!i.wi||i.p)i.wi=i.getWrapInfos(a,j);if(d.showTotals){var l=f.dispUnit,m=thr0.formatUV(d.getTotal(b,f,!0),d.totalsFType,d.totalsPrecision,d.totalsRoundExp,d.thousandsSep,d.showTotalsUnit?
l:void 0),l=(b=thr0.formatUV(d.getTotal(b,f,!1),d.totalsFType,d.totalsPrecision,d.totalsRoundExp,d.thousandsSep,d.showTotalsUnit?l:void 0))&&m!==b;m&&i.addLine((l?"in: ":"")+m);l&&i.addLine((m?"out: ":"")+b)}m=1;for(b=thrShapes.getShapeTextCount(d.shape);m<b;m++){var l=d.getText(m).dispText(e.attrs,!1),n=d.getTextrect(f,l.size*g,m,e);if(!l.wi||l.p)l.wi=l.getWrapInfos(a,n);l.$createWrappedSvgText(a,n,h,c,k).attr("id",a.attr("id")+"_tx"+m)}return i.$createWrappedSvgText(a,j,h,c,k)}}};Z.prototype={maxConVal:0,
defaultSize:{width:1200,height:800},effectsStandby:!1,cleanup:function(){this.clearGUI();this.$svg.remove()},fileChanged:function(a){if(this.activeRev&&void 0!==this.activeRev.history){a=a.file.metaRevs;var b=this.activeRev.history;if(0>thr0.indexOfSorted(a,"pos",b))throw thr0.indexOfSorted(a,"pos",b,!0);}else this.activeSc?"undo"===a.hint&&this.getUserform().applyScenario({mEnv:this.activeSc.mathEnv,ctx:this.ctx},this.getScenarioenv().getScenario(this.activeSc.scId)):this.activeRev||(this.cachedAutoUF=
void 0);this.render()},createSvg:function(a){this.$svg=$(thrSvg.svgHtml(this.defaultSize.width,this.defaultSize.height,0,!1,"sfs"+this.id,"\x3cdefs\x3e\x3c/defs\x3e")).appendTo(a)},clearGUI:function(){var a=this,b=this.activeAction?["E","L"]:"HSBELC".split("");this.conRenderers=[];this.itemRenderers=[];this.gradients=[];b.forEach(function(b){a.$getGroup(b).empty()});this.$svg.prepend(this.$svg.find("defs"))},clearSelection:function(){this.selection={}},select:function(a){this.hoverElement=void 0;
if("object"!==typeof a||!this.diagram)this.clearSelection();else{var b;a.connections?(b={connections:a.connections},a.add&&(!a.sub&&this.selection.connections)&&this.selection.connections.forEach(function(a){void 0===thr0.removeFromArray(this,a)&&this.push(a)},b.connections),b.connections.length||(b={})):a.items?(b={items:a.items},a.add&&(!a.sub&&this.selection.items)&&this.selection.items.forEach(function(a){void 0===thr0.removeFromArray(this,a)&&this.push(a)},b.items),b.items.length||(b={})):b=
{};a.sub&&(b.sub=a.sub);this.selection=b}},isSelectionEmpty:function(){return!this.selection||$.isEmptyObject(this.selection)},isSelected:function(a){if(a instanceof SfsDiagram)return this.isSelectionEmpty();var b=a instanceof SfsItem?"items":a instanceof SfsConnection?"connections":0;return b&&this.selection&&this.selection[b]&&0<=this.selection[b].indexOf(a.id)},selectedObjects:function(){var a=this.selection;return a&&a.sub&&"l"===a.sub.toLowerCase()?[this.diagram.legend]:thrRevisioning.contextOp.resolve(this.diagram,
a)},getCaption:function(a,b){return"i"===a?this.diagram.getItem(b).text.tx:this.diagram.getConnection(b).name},selStrokeWidth:function(){return 100*this.settings.selLineWidth/thrSvg.getZoom(this.$svg)},getObjSize:function(a){if(a instanceof SfsItem){var b=this.getMathEnv(),c=this.diagram;return a.hasIos()?Math.max(Math.max(Math.abs(a.getTotal(b,c,!0)),Math.abs(a.getTotal(b,c,!1)))*this.conWidthScale,1)+a.conBorderDelta(c):c.maxConWidth}return 1},conStFromPoint:function(a,b){for(var c=this.conRenderers.length-
1;0<=c;c--)for(var d=this.conRenderers[c],e=d.con.stretches.length-1;0<=e;e--){var f=d.getStretchLine(e,!0);if(thr0.distanceToLine(a,f)<=b)return{con:d.con,cr:d,stx:e,l:f}}},adjustToDiagram:function(a){function b(a){return!a.z}var c=a||this.defaultSize,d=100;this.clearGUI();thr0.changeProperty(this,"diagram",a)?this.clearSelection():d=a?void 0:100;this.autoSize||this.zoom(d);this.$svg[0].setAttribute("viewBox","0 0 "+c.width+" "+c.height);if(a&&(c=a.connections,a=a.items,this.conRenderers=c.map(function(a){return new P(this,
a)},this),this.itemRenderers=a.map(function(a){return new Y(this,a)},this),c.some(b)||a.some(b))){var e=Math.max(thr0.maxOfArray(c,"z",0),thr0.maxOfArray(a,"z",0));c.forEach(function(a){a.z||(a.z=++e)});a.forEach(function(a){a.z||(a.z=++e)})}this.renderDiagram();this.gradients.length&&thrColors.setActiveGradients(this.gradients.reduce(function(a,b){0>thrColors.indexOfGradient(a,b.gradient)&&a.push(b.gradient);return a},[]))},getStyleAttrs:function(a){var b=a?a.hairline?{fill:"none"}:a.gradient?this.renderGradient(a.gradient,
a.color):thrColors.colorStringToSvgCss(a.color||"#000","fill"):thrColors.colorStringToSvgCss("rgba(255,255,255,0)","fill");if(a&&a.line&&(0!==a.line.style||a.avoidNoLine||a.hairline)){var c=a.line.width;b["stroke-width"]=c;$.extend(b,thrColors.colorStringToSvgCss(a.line.color,"stroke"));1<a.line.style&&(b["stroke-dasharray"]=4===a.line.style?7*c+", "+Math.round(2.5*c)+", "+c+", "+Math.round(2.5*c):2===a.line.style?5*c+", "+Math.round(2.5*c):c+", "+c)}else b["stroke-width"]=0;return b},getLegendContent:function(a){return a.connections.filter(function(a){return a.showInLegend}).sort(SfsConnection.prototype.getCompareFn(a.legend.order))},
getLegendWrapInfos:function(a){var b=this.getLegendContent(a);if(b.length){var c=this.$getGroup("L"),d=$.extend({},a.legend.text),e={x:0,y:0,height:1E3,width:a.legend.width-30-this.settings.legendBoxPadding};d.vAlign=0;d.orientation=0;return b.map(function(a){d.tx=a.name||a.idName();return d.getWrapInfos(c,e)}).join(";")}},getWrapInfoDiff:function(a,b){var c={};if(b.items){var d=b.items.map(function(b){if(b.id)if(b=a.getItem(b.id),0<b.textPos){var c,d=0,h=b.text.size*this.settings.itemBoxPadding,
i={id:b.id},j=thrShapes.getShapeTextCount(b.shape),k=this.$getGroup("E"),l=1<j?new ThrText(JSON.parse(JSON.stringify(b.text))):0,m=b.text.getWrapInfos(k,b.getTextrect(this.diagram,h,0,this)),n=b.text.isParameterized();m!==b.text.wi&&(d++,i.text={wi:m});b.text.p!==n&&(0>=d++?i.text={p:n}:i.text.p=n);for(var p=1;p<j;p++)c="text"+p,b.hasOwnProperty(c)&&(l.tx=b[c].tx,m=l.getWrapInfos(k,b.getTextrect(this.diagram,h,p,this)),m!==b[c].wi&&(d++,i[c]={wi:m}),n=l.isParameterized(),l.p!==n&&(d++,i[c]?i[c].p=
n:i[c]={p:n}));b=d?i:void 0}else b=void 0;else b=void 0;return b},this).filter(function(a){return a});d.length&&(c.items=d)}if(a.legend&&a.legend.visible&&(b.legend||b.connections))d=this.getLegendWrapInfos(a),d!==a.legend.wi&&(c.legend={wi:d});if(c.items||c.legend)return c},findItemRenderer:function(a){return thr0.findInArray(this.itemRenderers,function(a){return a.item.id===this.id},{id:a})},findConRenderer:function(a){return thr0.findInArray(this.conRenderers,function(a){return a.con.id===this.id},
{id:a})},makeConRenderer:function(a){return new P(this,a)},setFilterDefs:function(){!this.effectsStandby&&this.diagram&&this.diagram.findUsedFilters().forEach(function(a,b){a.forEach(function(a){(new ThrSvgSpec(thrSvg.filterSpecs[b][a])).$appendTo(this)},this)},this.$svg.find("defs").empty())},prepareAttrs:function(){var a=this.getUserform(!0),b=this.diagram;this.attrs=a?a.getAttrs():[];this.attrs.forEach(function(a){a.v=this?this.getAttr(a.id):b["att"+a.id]||""},this.activeSc?this.getScenarioenv().getScenario(this.activeSc.scId):
void 0)},getItemCombiInfo:function(a,b,c){function d(a,b,c){var d,e,f=a.con.stretches,g=a.rPt[c];f[b].a===c?(d="a",e="b"):(d="b",e="a");for(var h=g.st.length-1;0<=h;h--){var o=g.st[h].stx;if(o!==b&&f[o][e]===c)return a.con.points[f[o][d]]}return a.con.points[c]}var e=99999,f=b?a.combiInfoIn:a.combiInfoOut,g=void 0!==a.ios(b)[0].ord;b&&c.reverse();if(f)f=JSON.parse(f),f.pt=a.absolutePt(f.pt);else{var h=c.reduce(function(a,b){return a?[{x:Math.min(a[0].x,b.pt.x),y:Math.min(a[0].y,b.pt.y)},{x:Math.max(a[1].x,
b.pt.x),y:Math.max(a[1].y,b.pt.y)}]:[{x:b.pt.x,y:b.pt.y},{x:b.pt.x,y:b.pt.y}]},void 0),f={dir:h[1].x-h[0].x<=h[1].y-h[0].y?180:90,pt:thr0.centeredPt(h)};f.ptDir=f.dir}f.w=0;c.forEach(function(a){var b=a.con,c=b.nextPtStx(a.ptx);a.cr=this.findConRenderer(b.id);a.stx=c;a.ptx2=b.otherStPt(c,a.ptx);a.pt2=b.points[a.ptx2];e=Math.min(e,thr0.distance(f.pt,a.pt2));a.cw=a.cr.stretchWidth(c);f.w+=a.cw},this);f.ortho=thr0.verticalAngle(f.ptDir,!0);thr0.isSmallAngleDelta180(f.dir,f.ortho)&&(f.ortho=thr0.verticalAngle(f.dir,
!0));g?c.forEach(function(c,d){var e=a.portio(b,c.pt.port);c.ord=e?e.ord:d}):c.forEach(function(a){a.ord=thr0.normalizeAngle(f.ortho-90-thr0.angle(this,d(a.cr,a.stx,a.ptx2)))},thr0.movedPt(f.pt,f.dir,e));c.sort(function(a,b){return a.ord-b.ord});return f},prepareItemCombiIOs:function(a,b){var c=this.diagram.getItemConPoints(a.id,b);if(c.length){var d=0,e=this.getItemCombiInfo(a,b,c),f=e.pt,g=e.dir,h=e.ortho,i=e.w;a.getCenter();var j=Math.sin((g-h)*thr0.deg2rad),k=thr0.movedPt(f,h,-i/(2*j));c.forEach(function(a){var b=
a.cr.rPt[a.ptx],c=a.cr.rPt[a.ptx2];b.pt=thr0.movedPt(k,h,a.cw/(2*j));b.combiPt=f;b.combiWidth=i;b.combiOrtho=h;b.cw0=d;c.pt=thr0.lineIntersection(thr0.getLine(b.pt,g),thr0.getLine(a.pt2,g-90));c.combiPt=thr0.lineIntersection(thr0.getLine(f,g),thr0.getLine(a.pt2,g-90));if(2===c.st.length){var e=c.st[0].stx;e===a.stx&&(e=c.st[1].stx);b=a.cr.con.stretches[e];a.cr.rSt[e].angle=thr0.angle(a.cr.getPt(b.a),a.cr.getPt(b.b));c.cw0=a.cr.isCurveToLeft(a.stx,e)?d:i-(a.cw+d)}k=thr0.movedPt(k,h,a.cw/j);d+=a.cw})}},
prepareCombiIOs:function(){this.diagram.items.forEach(function(a){a.combiIn&&this.prepareItemCombiIOs(a,!0);a.combiOut&&this.prepareItemCombiIOs(a,!1)},this)},renderDiagram:function(){var a=this.getMathEnv(),b=this.diagram;this.prepareAttrs();thrColors.setActivePalette(b?b.palette:0,b?b.palSwap:0);this.setFilterDefs();this.renderBackground();if(b){var c=b.items.map(function(a){return{id:a.id,aa:thrShapes.getArrowAngle(a.shape)}}).filter(function(a){return a.aa});this.renderLegend();this.conRenderers.forEach(function(b){b.prepareRenderInfo(a,
c)});this.conWidthScale=(this.maxConVal=thr0.maxOfArray(this.conRenderers,"maxVal",0))?b.maxConWidth/this.maxConVal:1;this.prepareCombiIOs();this.conRenderers.concat(this.itemRenderers).sort(function(a,b){return a.z()-b.z()}).forEach(function(b){b.render(a)})}this.$svg.find(".sfsBrand").remove();if(!b||!b.hideSfsBrand)(new ThrSvgSpec(sfsSvgDiagram.svgBrand("sfs"+this.id,b||this.defaultSize,b?b.color:"#fff"))).$appendTo(this.$svg);thr0.notify("notifyDiagramRendered",this)},filterUrl:function(a,b){var c=
thrSvg.filterSpecs[a?0:1];return"url(#"+c[Math.min(b,c.length)-1].attrs.id+")"},indexOfGradient:function(a,b){return thr0.findIndexInArray(this.gradients,function(a){return a.color===this.cl&&thr0.equalObjects(a.gradient,this.g)},{g:a,cl:b})},renderGradient:function(a,b){var c,d,e,f=new ThrColor(b),g=f.opacity;f.opacity=100;e=f.toColorString();d=this.indexOfGradient(a,e);c="gradient"+this.id+"_"+(0>d?this.gradients.length:d);0>d&&(d=thrColors.gradientSpec(a,f),d.attrs.id=c,this.gradients.push({id:c,
gradient:a,color:e}),(new ThrSvgSpec(d)).$appendTo(this.$svg.find("\x3edefs")));c={fill:"url(#"+c+")"};100>g&&(c["fill-opacity"]=g/100);return c},renderShape:function(a,b,c){var d,e,f,g,h=b.shape,i=this.getStyleAttrs(b);c||(!h||!h.d||h.spec?(c=b.getBoundsRect?b.getBoundsRect(this):{x:0,y:0,width:1,height:1},c=h&&h.spec?thrShapes.getShapePath(h,c):thrSvg.rectPath(c.x,c.y,c.width,c.height,b.r),b.rot&&(c=thrSvg.transformPath(c,b.getShapeTransformation(!1,!0)))):(e=b.getShapeTransformation(),c=thrSvg.transformPath(h.d,
e),h.spec&&(h.spec.boldLine&&i.hasOwnProperty("stroke-width"))&&(i["stroke-width"]*=h.spec.boldLine),d=h.nld?thrSvg.transformPath(h.nld,e):void 0,e=h.ld?thrSvg.transformPath(h.ld,e):void 0));this.effectsStandby||(b.outerEffect&&(g=a,f=$.extend({filter:this.filterUrl(!1,b.outerEffect)},i)),b.innerEffect&&(i.filter=this.filterUrl(!0,b.innerEffect)));i.d=c;g&&(f.d=d||c,thrSvg.$appendElement(g,"path",f));d&&(f=this.getStyleAttrs({color:b.color}),f.d=d,i.filter&&(f.filter=i.filter),thrSvg.$appendElement(a,
"path",f));(this.effectsStandby||3!==b.outerEffect||b.innerEffect)&&thrSvg.$appendElement(a,"path",i);e&&(b=this.getStyleAttrs({color:b.line.color,line:b.line}),b.d=e,i.filter&&(b.filter=i.filter),thrSvg.$appendElement(a,"path",b))},renderBackground:function(){var a=this.diagram,b=a||this.defaultSize,c="sfs"+this.id+"_0background",d=this.$svg.find("#"+c),e=a&&0!==a.line.style?a.line.width:0,f=e/2;d.length||(d=thrSvg.$createElement("rect",{id:c}),this.$svg.prepend(d));d.css("fill-opacity","").css(this.getStyleAttrs(a)).attr({x:f,
y:f,width:b.width-e,height:b.height-e})},renderLegend:function(){var a=this.diagram.legend;if(a.visible){var b,c,d,e;e=0;b=2===a.text.hAlign;var f=this.settings.textLinePadding,g=this.settings.legendBoxPadding;c=a.text.size+g;var h={x:a.x+g+(b?0:c),y:0,height:1E3,width:a.width-c-2*g},i={x:a.x+(b?a.width-c:g),y:1,width:a.text.size,height:a.text.size},j=this.getLegendContent(this.diagram),k=thrSvg.$appendElement(this.$getGroup("L").empty(),"g",{"class":"sfsLegend"});this.renderShape(k,a);k.children().attr("id",
"legendBkg");c=(a.wi||this.getLegendWrapInfos(this.diagram)).split(";");d=c.map(function(a){return(new ThrTextWrapper(a)).totalHeight()});e=d.reduce(function(a,b){return a+b},0);for(b=c.length;b<j.length;b++)c.push("0,0,0"),d.push(a.text.size+2),e+=a.text.size+2;e=(a.height-e-2*g)/(c.length||1);h.y=a.y+g+e/2;a=$.extend({},a.text);for(b=a.vAlign=0;b<j.length;b++)i.y=h.y+1,a.tx=j[b].name||j[b].idName(),a.wi=c[b],a.$createWrappedSvgText(k,h,f),thrSvg.$appendElement(k,"rect",i).css(thrColors.colorStringToSvgCss(j[b].color,
"fill")),h.y+=e+d[b]}},getHtmlId:function(a,b){return a&&b&&"number"===typeof b?"sfs"+this.id+a+b:"thrError"},$getGroup:function(a){a="sfs"+this.id+a;var b=$("#"+a);return b.length?b:$("#sfs"+this.id).prepend(thrSvg.$createElement("g",{id:a})).find("#"+a)},$getSubGroup:function(a,b,c){b=this.getHtmlId(a,b);var d=$("#"+b);d.length||(a=/^[CI]/.test(a)?"E":a[0],a=this.$getGroup(a),d=thrSvg.$createElement("g",{id:b}),c?d.prependTo(a):d.appendTo(a));return d},render:function(){this.adjustToDiagram(this.diagram)},
getMathEnv:function(){return this.activeSc?this.activeSc.mathEnv:this.activeRev?this.activeRev.mathEnv:this.mc.mathEnv},getUserform:function(a){if(this.diagram){var b=this.activeRev?this.activeRev.userform:this.cachedAutoUF||this.mc.getManagedInstance({type:"Userform",id:this.diagram.id},this.ctx.slice(0,this.ctx.length-1)).obj;!b&&!a&&(b=new ThrUserform({id:this.diagram.id}),b.initFromMathEnv({mEnv:this.getMathEnv(),ctx:this.ctx}),this.activeRev?this.activeRev.userform=b:this.cachedAutoUF=b);return b}},
setUserform:function(a){this.activeRev?this.activeRev.userform=a:(this.cachedAutoUF=void 0,this.mc.applyChangedObject(a.objSpec(),a))},getMEnvValue:function(a){var b=1;a=a.split(".");var c=this.getMathEnv(),d=c.unitOf(a);a&&a.length&&(RegExp("^["+sfsIdPrefix.input+sfsIdPrefix.output+"][0-9]+$").test(a[a.length-1])?(b=a.slice(0,a.length-1),b.push("sc"),b=c.pathExists(b)?c.valueOf(b):1):RegExp("^["+sfsIdPrefix.parameter+"][0-9]+$").test(a[a.length-1])&&(b=thrUnits.getFactor(d))&&(b=1/b));return{val:c.valueOf(a)*
b,unit:d}},getUserformValue:function(a){if(a=this.getUserform().getElementProp(parseInt(a.substring(8),10))){if("att"===a.substring(0,3)){if(this.activeSc){var b=this.getScenarioenv().getScenario(this.activeSc.scId);return b?b.getAttr(parseInt(a.substring(3),10)):""}return this.diagram[a]}return this.getMEnvValue(a)}return 0},handleMEnvChange:function(a,b){var c,d=this.activeSc?{id:this.activeSc.scId}:void 0,e=[];if("userform"===a.substring(0,8)){var f=parseInt(a.substring(8),10),g=this.getUserform(),
h=g.getElementProp(f);"att"===h.substring(0,3)?(b=b.trim(),this.activeSc||(c||(c={}),c[h]=b,h=void 0)):(h=h.split("."),sfsIdPrefix.isParameterPath(h)&&(b*=thrUnits.getFactor(this.getMathEnv().unitOf(h))));this.activeSc?(c||(c={scenarios:[d]}),g.addElToScDiff(d,f,b)):h&&e.push({p:h,v:b})}else e.push({p:a.split("."),v:b});return this.applyMVals(e,c)},applyMVals:function(a,b){var c=this.diagram,d=this.activeSc?this.getScenarioenv():void 0;b=thrRevisioning.diffOp.optimizeDiff(d||c,b);if(!b&&!a.length)return!1;
if(this.activeSc){var e={},f=d.getScenario(this.activeSc.scId)||d.getBaseScenario(),g=this.activeSc.mathEnv,h={mEnv:g,ctx:this.ctx};thrRevisioning.diffOp.apply(d,b,e);try{return this.getUserform().applyScenario(h,f),thrRevisioning.diffOp.apply(d,e),this.mc.applyDiff(d.objSpec(),b),!0}catch(i){return thrRevisioning.diffOp.apply(d,e),g.clear(),c.initMathEnv(g,[]),this.getUserform().applyScenario(h,f),thr0.notify("notifyApplyError"),!1}}else return this.mc.applySetMathVals(c,a,b)},getScenarioenv:function(a){var b=
{type:"Scenarioenv",id:this.diagram?this.diagram.id:1},c=this.activeRev?this.activeRev.scenarioEnv:this.mc.getManagedInstance(b,this.ctx.slice(0,this.ctx.length-1)).obj;!c&&(!a&&this.diagram)&&(c=new ThrScenarioEnvironment({id:b.id}));c&&!c.getBaseScenario()&&this.getUserform().initScenarioenv({mEnv:this.getMathEnv(),ctx:this.ctx},c);return c},setScenarioEnv:function(a){this.activeRev?this.activeRev.scenarioEnv=a:this.mc.applyChangedObject(a.objSpec(),a)},activateScenario:function(a){function b(a,
b){if(b.isBase)a.activeSc&&delete a.activeSc;else{var c,d=a.activeSc?a.activeSc.scId:-1;a.activeSc?a.activeSc.scId=b.id:a.activeSc={mathEnv:a.getMathEnv().clone(),scId:b.id};c={mEnv:a.activeSc.mathEnv,ctx:a.ctx};try{a.getUserform().applyScenario(c,b)}catch(e){0<d?(a.activeSc.scId=d,a.activeSc.mathEnv.clear(),a.diagram.initMathEnv(a.activeSc.mathEnv,[]),a.getUserform().applyScenario(c,a.getScenarioenv().getScenario(d))):delete a.activeSc,thr0.notify("notifyApplyError")}}a.adjustToDiagram(a.diagram)}
var c=this,d=this.getScenarioenv(),e=void 0===a?d.getBaseScenario():d.getScenario(a);if(e&&(!this.activeSc||this.activeSc.scId!==a)&&(this.activeSc||!e.isBase))this.activeRev?this.setDiagram(this.diagram?this.diagram.id:1,void 0,function(){b(c,e)}):b(c,e)},setDiagram:function(a,b,c){var d,e=this;this.ctx=[sfsIdPrefix.diagram+a];this.cachedAutoUF=this.activeSc=void 0;this.mc.getObjsRevision([{type:"Diagram",id:a},{type:"Userform",id:a},{type:"Scenarioenv",id:a}],b,function(a){if(a.length){if(e.activeRev=
b)d=new ThrMathEnv(RegExp("^["+sfsIdPrefix.diagram+"][0-9]+$"),sfsIdPrefix.rexParameters(),sfsIdPrefix.rexBaseUnit()),b.mathEnv=d,a[0].initMathEnv(d,[]),d.postProcessSet(),d.hasChanges()&&(d.calculate(!0),d.clearChanges()),b.userform=a[1];e.adjustToDiagram(a[0])}else e.adjustToDiagram();c&&c(e)})},zoom:function(a){a="number"===typeof a?a:thrSvg.getZoom(this.$svg,a);var b=this.diagram||this.defaultSize;this.$svg.width(b.width*a/100).height(b.height*a/100);this.$getGroup("H").css("font-size",1E3/a+
"pt")},asSvgText:function(a,b){var c=this.diagram||this.defaultSize,d=c.width,c=c.height,e=0;a&&1!==a&&(e="0 0 "+d+" "+c,d=Math.round(d*a),c=Math.round(c*a));["C","S","B"].forEach(function(a){this.$getGroup(a).empty()},this);this.$svg.find(".thrTextBkg").remove();b(thrSvg.svgDoctype+thrSvg.svgHtml(d,c,e,!0,void 0,thrSvg.getInnerSVG(this.$svg)));thr0.notify("notifyDiagramRendered",this)}};var I={ntx:{scenario:"Scenario",scenarios:"Scenarios",name:"Name",addScenario:"Add scenario"}};thrNtx.register(I);
o.ThrScenarioEnvironment=function(a){this.instantiate(a)};ThrScenarioEnvironment.prototype={thrClsName:"Scenarioenv",id:0,instantiate:function(a){this.clear();a&&$.extend(this,a);this.attrOrder||(this.attrOrder=[]);this.scenarios&&this.scenarios.length?(this.scenarios=this.scenarios.map(function(a){return new ThrScenario(a,this)},this),this.sort()):this.scenarios=[]},objSpec:function(){return{type:this.thrClsName,id:this.id}},clear:function(){this.scenarios=[];this.maxId=0},clone:function(){return new ThrScenarioEnvironment(JSON.parse(JSON.stringify(this)))},
getBaseScenario:function(){return thr0.findInArray(this.scenarios,function(a){return a.isBase})},sort:function(){var a,b,c,d=this.attrOrder,e=d.length;this.scenarios.sort(function(f,g){for(a=0;a<e;a++)if(b=f.getAttr(d[a]),c=g.getAttr(d[a]),b!==c)return b>c?1:-1;return 0})},addScenario:function(a){var b=a?thr0.arrayObjByKey(this.scenarios,"isBase",!0):void 0;b||(b=new ThrScenario(a?{isBase:!0,id:1}:void 0,this),this.scenarios.push(b));return b},removeScenario:function(a){return thr0.removeKeyFromArray(this.scenarios,
"id",a)},getScenario:function(a){return thr0.arrayObjByKey(this.scenarios,"id",a)},getScenarioTree:function(){var a=new ThrTreeNode(I.ntx.scenarios),b=this.attrOrder.length?this.attrOrder:[0];this.scenarios.forEach(function(c){a.add(c.getPath(b),{name:c.getCaption(b,!0),sc:c})});return a},getScenarioPath:function(a){return(a=void 0===a?this.getBaseScenario():this.getScenario(a))?a.getPath(this.attrOrder):void 0},getScenarioSelHtml:function(a){function b(a,c){return a.items().map(function(a){return"\x3cli"+
(c===a.sc?" class\x3d'thrSelected'":"")+" data-scid\x3d'"+a.sc.id+"'\x3e"+a.name+(a.sc.isBase?"":"\x3cdiv class\x3d'thrDelButton' tabindex\x3d'0' style\x3d'float: right;'\x3e\x3c/div\x3e\x3cdiv style\x3d'clear:both;'\x3e\x3c/div\x3e")+"\x3c/li\x3e"}).concat(a.nodes().map(function(a){return"\x3cli class\x3d'thrCollapsed'\x3e\x3cdiv\x3e"+a.name+"\x3c/div\x3e\x3cul\x3e"+b(a,c,!1)+"\x3c/ul\x3e\x3c/li\x3e"})).join("")}var c=this.getScenarioTree();c.sort();return"\x3cul class\x3d'thrInitControl thrScenarioSel' data-control\x3d'treeview'\x3e"+
b(c,a)+"\x3c/ul\x3e"},addScenarioDialog:function(a){var b=this,c=this.attrOrder.length?this.attrOrder:[0],d=this.getBaseScenario(),e=c.map(function(a){return[a?d.getAttrTitle(a):I.ntx.name,_h.inp({"class":"thrDlgResult",value:d.getAttr(a),"data-prop":"attr"+a})]});thrUI.dialog.show(I.ntx.addScenario,function(d){var e=b.addScenario();c.forEach(function(a){e.setAttr(a,void 0,d["attr"+a])});e.adjustToBase(b.getBaseScenario());a&&a(e)},1,_h.table(void 0,e))}};o.ThrScenario=function(a,b){this.instantiate(a);
!this.id&&b?this.id=++b.maxId:b&&b.maxId<this.id&&(b.maxId=this.id)};ThrScenario.prototype={id:0,isBase:!1,instantiate:function(a){a&&$.extend(this,a);this.attrs||(this.attrs=[]);this.vals||(this.vals=[])},clear:function(){this.attrs=[];this.vals=[]},setValue:function(a,b,c,d){var e=void 0!==c?thr0.arrayObjByKey(this.vals,"id",a):thr0.removeKeyFromArray(this.vals,"id",a);void 0!==c&&(e?(e.v=c,void 0!==d&&(e.unit=d)):(a={id:a,t:b,v:c},void 0!==d&&(a.unit=d),this.vals.push(a)))},getValue:function(a){return(a=
thr0.arrayObjByKey(this.vals,"id",a))?a.v:0},setAttr:function(a,b,c,d){var e=void 0!==c?thr0.arrayObjByKey(this.attrs,"id",a):thr0.removeKeyFromArray(this.attrs,"id",a);void 0!==c&&(e?(e.v=c,e.groupAtt=d):this.attrs.push({id:a,t:b,v:c,groupAtt:d}))},getAttr:function(a){a=thr0.indexOfKey(this.attrs,"id",a);return 0<=a?this.attrs[a].v:""},getAttrTitle:function(a){a=thr0.indexOfKey(this.attrs,"id",a);return 0<=a?this.attrs[a].t:""},adjustToBase:function(a){function b(a){a=$.extend(!0,{},a);void 0!==
a.t&&delete a.t;return a}a.vals.forEach(function(a){0>thr0.indexOfKey(this.vals,"id",a.id)&&this.vals.push(b(a))},this);a.attrs.forEach(function(a){0>thr0.indexOfKey(this.attrs,"id",a.id)&&this.attrs.push(b(a))},this)},getPath:function(a){return this.isBase?[]:a&&a.length?a.slice(0,a.length-1).map(function(a){return this.getAttr(a)},this):[this.getAttr(0)]},getCaption:function(a,b){var c,d=b?[]:this.getPath(a);if(this.isBase)return"_Base_";a&&a.length&&d.push(this.getAttr(a[a.length-1]));(c=d.length)&&
!d[c-1]&&(d[c-1]=this.getAttr(0)||I.ntx.scenario+"_"+this.id);return d.join(", ")}};var A={ntx:{save:"Save",close:"Close",cancel:"Cancel",clear:"Clear",auto:"Auto",empty:"Empty",editForm:"Edit form",addText:"Add text",addAttribute:"Add attribute",addValueIn:"Add value input",addValueDisp:"Add value display",addGroup:"Add group",enterText:"Enter text here.",untitledGroup:"Untitled group",untitledSel:"Untitled selection",untitledOpt:"Untitled option",producers:"Producers",consumers:"Consumers",hint:"Hint",
emptyUfContent:"The diagram contains no values classified as 'user input'.",detailDataHint:"Select an item or connection to view data details."}};thrNtx.register(A);o.thrUserformEditor={show:function(a,b,c){var d=thrUI.dialog.create(A.ntx.editForm,[A.ntx.save,thrUI.ntx.cancel]).addClass("thrUserformEditor"),e=d.find(".thrDialog");a.deleteInconsistentElements(b);thrUI.setTempData(d,{userform:a,mInfo:b,cb:c});e.find(".thrDlgBody").append(a.getHtml(1,b)).click(function(a){thrUI.hideDropdowns();a.stopPropagation()}).on("getUserform",
function(a){a.userform=thrUI.getTempData($(a.currentTarget).closest(".thrDlgBack"),"userform")}).on("getMathInfo",function(a){a.mInfo=thrUI.getTempData($(a.currentTarget).closest(".thrDlgBack"),"mInfo")});e.change(function(a){thrUserformEditor.change(a)});$(_h.div("",{"class":"thrInitControl thrPopup",style:"margin-right: 3px;","data-control":"ddFunctions","data-iconix":"45","data-fnnames":A.ntx.addText+","+A.ntx.addAttribute+","+A.ntx.addValueIn+","+A.ntx.addValueDisp+","+A.ntx.addGroup,"data-functions":"tx,att,in,out,g"})+
_h.div(A.ntx.clear,{"class":"thrButton","data-cmd":"clear"})+_h.div(A.ntx.auto,{"class":"thrButton","data-cmd":"auto"})).appendTo(e.find("\x3e.thrDlgButtons\x3etbody\x3etr\x3etd:first-child")).click(function(a){var b=$(a.target).data("cmd");thrUI.hideDropdowns();b&&thrUserformEditor.cmd(b,$(a.target).closest(".thrDlgBack").find(".thrUserform"))}).change(function(a){thrUserformEditor.cmdAdd($(a.target).closest(".thrDlgBack").find(".thrUserform"),a.func);$(a.target).addClass("thrCollapsed");a.stopPropagation()}).find("\x3ediv").attr("tabindex",
0).filter(".thrButton").css({position:"relative",top:"-2px"});thrUI.initControls(e);thrUI.dialog.center(e)},cmdAdd:function(a,b){var c=a.closest(".thrDlgBack"),d=thrUI.getTempData(c,"userform"),e=$(d.addElement(b).getRowHtml(1,Q(a))).appendTo(a);d.notifyChange();thrUI.initControls(e);thrUI.ufTreeTable.select(a,e);thrUI.dialog.center(c.find(".thrDialog"));e[0].scrollIntoView()},cmd:function(a,b){var c=b.parent(),d=c.closest(".thrDlgBack"),e=thrUI.getTempData(d,"userform"),f=thrUI.getTempData(d,"mInfo");
e.clear();e.notifyChange();"auto"===a&&e.initFromMathEnv(f);b.remove();c.append(e.getHtml(1,f));thrUI.initControls(c);thrUI.dialog.center(d.find(".thrDialog"))},change:function(a){var b=$(a.currentTarget).parent(),c=thrUI.ntx,c=[c.cancel,c.close,A.ntx.save].indexOf(a.dlgCmd);if(0<=c){var d=thrUI.getTempData(b),e=d.userform;a.stopPropagation();d.cb&&(2===c&&e.isChanged)&&(delete e.isChanged,e.deleteInconsistentElements(d.mInfo),e.refreshOrderInfos(),d.cb(e));thrUI.dialog.close(b)}}};ba.prototype={doMoveRow:function(a,
b){if(b){var c=a.find("\x3etr:nth-child("+b+")");c.is(this.$tr)||this.$tr.insertAfter(c)}else this.$tr.prependTo(a);this.rowRect=this.$tr[0].getBoundingClientRect();this.doSelect=!1},doScrollCheck:function(a){var b=this.scrollTop;a!==this.lastY&&(a<this.scrollBoxRect.top&&0<this.scrollTop?this.scrollTop=Math.max(0,this.scrollTop-20):a>this.scrollBoxRect.top+this.scrollBoxRect.height&&this.scrollTop<this.scrollMax&&(this.scrollTop=Math.min(this.scrollMax,this.scrollTop+20)),b!==this.scrollTop&&(this.$scrollBox.scrollTop(this.scrollTop),
this.rowRect=this.$tr[0].getBoundingClientRect(),this.formRect=this.$formtbody[0].getBoundingClientRect(),this.lastY+=b-this.scrollTop))},move:function(a){var b,c,d,e=a.clientY;e===this.lastY||e>=this.rowRect.top&&e<=this.rowRect.top+this.rowRect.height?this.doScrollCheck(e):(a=$(document.elementFromPoint(this.formRect.left+100,e)),b=a.closest("tr"),b.is(this.$tr)?this.doScrollCheck(e):(e<=this.formRect.top||e>=this.formRect.top+this.formRect.height?(c=this.$formtbody,d=e<=this.formRect.top?0:c.children().length):
a.is("td")&&a.find("\x3etable").length?(c=a.find("\x3etable\x3etbody"),d=e>this.lastY?0:c.children().length):(b.parent().is("thead")&&(e<=this.lastY?b=b.parent().closest("tr"):(c=b.closest("table").find("\x3etbody"),d=0)),!c&&(e!==this.lastY&&b.length&&!b.is(this.$tr))&&(c=b.parent(),d=b.index()+(e<this.lastY?0:1))),c&&this.doMoveRow(c,d),this.doScrollCheck(e),this.lastY=e))},end:function(a,b){var c;if(b){if(this.$savParent.is(this.$tr.parent())){c=this.$tr.index();if(this.savIx===c)return;c<this.savIx&&
this.savIx++}this.doMoveRow(this.$savParent,this.savIx)}else if(this.$savParent.is(this.$tr.parent())?c=this.savIx!==this.$tr.index():(c=!0,this.$tr.parent().find("\x3e.thrUfEmptyRow").remove(),this.$savParent.children().length||this.$savParent.append(ThrUserformElement.prototype.getEmptyRowHtml(3))),this.wasSelected||this.$tr.removeClass("thrSelected"),c){if(c=G(this.$tr))c.moveElement(this.$tr.data("id"),this.$tr.parent().closest("tr").data("id"),this.$tr.index()),c.notifyChange()}else this.doSelect&&
!this.wasSelected&&thrUI.ufTreeTable.select(this.$formtbody.parent(),this.$tr)}};thrUI.ufTreeTable={create:function(a){thrUI.setActionMaker(a,function(a){if(!$(a.target).is("input, textarea, label, .thrButton, .thrDelButton"))return $(document.activeElement).blur(),thrUI.hideDropdowns(),new ba(a)});a.click(function(a){thrUI.ufTreeTable.click(a)}).change(function(a){thrUI.ufTreeTable.change(a)}).addClass("thrUfTreeTable")},select:function(a,b){function c(a,b,c,d){if(c=c.getElement(a.data("id")))"g"===
c.type?a.find("\x3etd\x3etable\x3ethead\x3etr").html(c.getHtml_thead(b)):a.html(c.getHtml(b,d)),thrUI.initControls(a),"att"===c.type&&2===b&&thrUI.checkbox.fill(a.find(".thrCheckbox"),c.groupAtt)}var d=a.find(".thrSelected"),e=G(a),f=Q(a);b&&(b.length&&e)&&(b.addClass("thrSelected"),c(b,2,e,f),thrUI.setFocus(b));d.length&&e&&(d.removeClass("thrSelected"),c(d,1,e,f))},click:function(a){var b,c,d,e,f,g,h,i=$(a.target),j=i.closest("tr");j.parent().is("thead")&&(j=j.parent().closest("tr"));if(i.is(".thrDelButton")){if(b=
G(j))b.deleteElement(j.data("id")),b.notifyChange();j.remove()}else i.is(".thrButton")&&"OK"===i.text()?this.select(j.closest(".thrUfTreeTable")):i.is(".thrButton")&&"mpath"===i.data("prop")&&(g=Q(j),b=G(j),c=(e=i.data("readonly"))?[]:b.getUsedPaths(),(d=i.data("path"))?(d=d.split("."),f=thr0.indexOfArrayInArray(c,d),0<=f&&c.splice(f,1)):d=[],thrUI.mathDlgSelectParam.show(g,!e,d,c,function(a){b=G(j);if((h=b.getElement(j.data("id")))&&a&&h.p.join(".")!==a.join("."))h.p=a,b.notifyChange(),j.html(h.getHtml(2,
g))}));"checkbox"!==i.closest("div").data("control")&&thr0.breakEvent(a)},change:function(a){var b,c=$(a.target);b=c.data("prop");var d=c.closest("tr"),e=G(d);"userform"===b.substring(0,8)&&(b=e.getElementProp(parseInt(b.substring(8),10)));d.parent().is("thead")&&(d=d.parent().closest("tr"));"title"===b&&e?(b=e.getElement(d.data("id")),a=c.is("input, textarea")?c.val():c.text(),b.t!==a&&(b.t=a,e.notifyChange())):"groupAtt"===b&&(b=e.getElement(d.data("id")),b.groupAtt!==a.value&&(b.groupAtt=a.value,
e.notifyChange()))}};thrUI.ufTextInput={create:function(a){var b=a.data("value");void 0===b&&(b="_");a.append(_h.div(b,"thrValue")).addClass("thrUfInput")}};thrUI.ufNumberInput={create:function(a){var b=a.data("value"),b=void 0===b?"_":thr0.formatLocalFloat(b);a.append(_h.div(b,"thrValue")+_h.div(a.data("unit")||"","thrUnit")).addClass("thrUfInput")}};thrUI.ufNumberOutput={create:function(a){var b=a.data("value"),b=void 0===b?"_":thr0.formatLocalFloat(b);a.append(_h.div(b,"thrValue")+_h.div(a.data("unit")||
"","thrUnit")).addClass("thrUfOutput")},fill:function(a,b){var c=a.data("unit")||"";a.text(thr0.formatLocalFloat(b*thrUnits.getFactor(c))+(c?" "+c:""))}};thrUI.ufSelection={create:function(a){var b=a.data("value")||0,c=(a.data("options")||"").split(",");a.append(_h.div(c[b],"thrDropdownValue")).addClass("thrUfSelection")}};o.ThrUserformOption=function(a,b){a&&$.extend(this,a);this.id||(this.id=++b.maxOptId)};ThrUserformOption.prototype={id:0,t:"",p:"",v:0};o.ThrUserformElement=function(a,b){a&&$.extend(this,
a);!this.id&&b&&(this.id=++b.maxId);this.c?this.c=this.c.map(function(a){return new ThrUserformElement(a,b)}):"g"===this.type&&(this.c=[]);/^(in|out)$/.test(this.type)&&!this.p&&(this.p=[]);"att"===this.type&&!this.att&&(this.att="att"+this.id,this.groupAtt=!0);"sel"===this.type&&(this.maxOptId=this.maxOptId||0,this.opts=this.opts?this.opts.map(function(a){return new ThrUserformElement(a,this)},this):[])};ThrUserformElement.prototype={id:0,type:"in",ord:3,v:0,h:"",isConsistent:function(a){if("in"===
this.type){if(!this.p||$.isEmptyObject(this.p))return!1;if(!a)return!0;if(!a.mEnv.pathExists(this.p))return!1;var b=this.p.length;if((b=sfsIdPrefix.rexBaseUnit().test(this.p[b-1]))&&"y"!==a.mEnv.statusOf(this.p)||!b&&!a.mEnv.canChange(this.p)||a.mEnv.formulaOf(this.p))this.type="out";return!0}return"out"===this.type?this.p&&!$.isEmptyObject(this.p)&&(!a||a.mEnv.pathExists(this.p)):!0},eachElement:function(a){var b=a(this);void 0===b&&this.c&&$.each(this.c,function(c,d){return b=d.eachElement(a)});
return b},eachGroupContent:function(a){if(this.c){var b=a(this.c,this);if(void 0!==b)return b;$.each(this.c,function(c,d){return b=d.eachGroupContent(a)});return b}},collectUsedPaths:function(a,b){(b||"out"!==this.type)&&(this.p&&!$.isEmptyObject(this.p))&&a.push(this.p)},getUnitValue:function(a){var b,c;b="";/^(in|out)$/.test(this.type)?this.p&&this.p.length?(c=a.mEnv.unitOf(this.p),b=sfsIdPrefix.isParameterPath(this.p)?1:thrUnits.getFactor(c),b=thr0.formatLocalFloat(a.mEnv.valueOf(this.p)*b)):b=
"_":"att"===this.type?b=a.sc?a.sc.getAttr(parseInt(this.att.substring(3),10)):a.diagram?a.diagram[this.att]:"":"sel"===this.type&&(b="number"===typeof this.v?thr0.getKeyArray(this.opts,"t")[this.v]:"");return[b,c||""]},getText:function(a){return this.t||(this.p&&this.p.length?a.mEnv.titleOf(this.p):"untitled")},getHtml:function(a,b,c,d){return this["getHtml_"+({g:"table",tx:"tx",att:"att",sel:"sel"}[this.type]||"io")](a,b,1+(a?2:c?c.length:1),c,d)},getRowHtml:function(a,b,c,d){return"\x3ctr data-id\x3d'"+
this.id+"'\x3e"+this.getHtml(a,b,c,d)+"\x3c/tr\x3e"},getEmptyRowHtml:function(a){return"\x3ctr class\x3d'thrUfEmptyRow'\x3e\x3ctd colspan\x3d'"+a+"'\x3e\x3cem\x3eEmpty\x3c/em\x3e\x3c/td\x3e\x3c/tr\x3e"},getBtnHtml:function(a){return a?_h.delBtn():_h.btn(thrUI.ntx.ok,{"class":"thrAccent"})},getHtml_thead:function(a,b){void 0===b&&(b=a?3:2);return"\x3cth colspan\x3d'"+(b-(a?1:0))+"'\x3e"+(2===a?_h.inp({value:this.t,"data-prop":"title"}):this.t)+"\x3c/th\x3e"+(a?_h.tag("th",this.getBtnHtml(1===a)):"")},
getHtml_table:function(a,b,c,d,e){var f=!e||0>e.indexOf(this.t),g=_h.tags(["thead","tr"],this.getHtml_thead(a,c)),h=this.c.filter(function(b){return a||b.isConsistent(this)},b).map(function(c){return c.getRowHtml(a,b,d,e)});!h.length&&a&&h.push(this.getEmptyRowHtml(c));return"\x3ctd colspan\x3d'"+c+"'\x3e\x3ctable class\x3d'thrInitControl"+(f?" thrCollapsed":"")+"' data-control\x3d'"+["treeTable","ufTreeTable","ufTreeTable"][a]+"'\x3e"+g+"\x3ctbody\x3e"+h.join("")+"\x3c/tbody\x3e\x3c/table\x3e\x3c/td\x3e"},
getHtml_io:function(a,b,c,d){function e(a,b,c,d){if(2===b)return b=c.mEnv.pathToString(c.ctx,a.p,"display",!0),d=b.length,30<d&&(b=b.slice(0,14)+"..."+b.slice(d-14,d)),_h.div(b,{"class":"thrButton",tabindex:"0","data-prop":"mpath","data-path":a.p.join("."),"data-readonly":("out"===a.type).toString()});c=a.getUnitValue(c);return _h.div("",{"class":"thrInitControl","data-control":d[b],"data-prop":"userform"+a.id,"data-value":c[0],"data-unit":c[1]})}var f;c=this.getText(b);var g="in"===this.type?["numberInput",
"ufNumberInput","ufNumberInput"]:["ufNumberOutput","ufNumberOutput","ufNumberOutput"];if(a)return _h.tag("td",2===a?_h.inp({value:c,"data-prop":"title"}):_h.div(c,"thrUfCaption"))+_h.tag("td",e(this,a,b,g))+_h.tag("td",this.getBtnHtml(1===a));f=[_h.tag("td",c)];d?d.forEach(function(){f.push(_h.tag("td","TODO"))}):f.push("\x3ctd class\x3d'thrInitControl' data-control\x3d'"+g[a]+"' data-prop\x3d'userform"+this.id+"' data-unit\x3d'"+(this.p&&this.p.length?b.mEnv.unitOf(this.p)||"":"")+"'\x3e\x3c/td\x3e");
return f.join("")},getHtml_att:function(a,b,c,d){function e(a,b){var c=a.t||"untitled";return 2===b?_h.inp({value:c,"data-prop":"title"}):_h.div(c,"thrUfCaption")}var f=[];a?(f.push(_h.tag("td",e(this,a))),f.push(_h.tag("td",2===a?"\x3cdiv class\x3d'thrInitControl' data-control\x3d'checkbox' data-prop\x3d'groupAtt'\x3escenario name\x3c/div\x3e":_h.div("",{"class":"thrInitControl","data-control":"ufTextInput","data-prop":"userform"+this.id}))),f.push(_h.tag("td",this.getBtnHtml(1===a)))):(f.push(_h.tag("td",
this.t)),d?d.forEach(function(){f.push(_h.tag("td","TODO"))}):f.push("\x3ctd class\x3d'thrInitControl' data-control\x3d'textInput' data-prop\x3d'userform"+this.id+"'\x3e\x3c/td\x3e"));return f.join("")},getHtml_tx:function(a,b,c){b=[];a&&c--;b.push("\x3ctd"+(c?" colspan\x3d'"+c+"'":"")+"\x3e"+(2===a?"\x3ctextarea rows\x3d'3' data-prop\x3d'title'\x3e"+this.t+"\x3c/textarea\x3e":_h.div(this.t,"thrUfText"))+"\x3c/td\x3e");a&&b.push(_h.tag("td",this.getBtnHtml(1===a)));return b.join("")},getHtml_sel:function(a,
b,c){b=[];c-=2;var d=["dropdownSelect","ufSelection","ufSelection"],e=thr0.getKeyArray(this.opts,"t");a&&(b.push("\x3ctd\x3e\x3cdiv class\x3d'thrUfCaption'\x3e"+this.t+"\x3c/div\x3e\x3c/td\x3e"),b.push("\x3ctd"+(c?" colspan\x3d'"+c+"'":"")+"\x3e\x3cdiv class\x3d'thrInitControl' data-control\x3d'"+d[a]+"' data-value\x3d'"+this.v+"' data-options\x3d'"+e.join(",")+"'\x3e\x3c/div\x3e\x3c/td\x3e"),b.push(_h.tag("td",this.getBtnHtml(1===a))));return b.join("")},levelPrefix:function(a,b){if(a.format){for(var c=
"",d=b-1;0<=d;d--)c+=a.sep;return c}return b+a.sep},addToScDiff:function(a,b){var c={"in":"vals",att:"attrs"}[this.type];c&&(a[c]||(a[c]=[]),a[c].push({id:this.id,v:b}))},getExString:function(a,b,c){var d=this.getUnitValue(a);return this.levelPrefix(b,c)+this.getText(a)+b.sep+d[0]+b.sep+(1<d.length?d[1]:"")+("g"===this.type?"\r\n"+this.c.map(function(c){return c.getExString(a,b,this)},c+1).join("\r\n"):"")},getMValDiff:function(a,b,c){if("g"===this.type)b instanceof ThrTreeNode&&aa(a,this.c,b,c);
else{var d=$.isArray(b.val)&&0<b.val.length?b.val[0]:void 0;if(void 0!==d){var e=this.p;"in"===this.type&&(d=thr0.parseLocalFloat(d)*(sfsIdPrefix.isParameterPath(e)?thrUnits.getFactor(a.mEnv.unitOf(e)):1)/(1<b.val.length?thrUnits.getFactor(b.val[1]):1));a.sc?(c=c.diff,c.hasOwnProperty("scenarios")||(c.scenarios=[]),b=thr0.arrayObjByKey(c.scenarios,"id",a.sc.id),b||(b={id:a.sc.id},c.scenarios.push(b)),this.addToScDiff(b,d)):"att"===this.type?c.diff[this.att]=d:"in"===this.type&&c.mvals.push({p:e,v:d})}}},
getProp:function(){return/^(in|out)$/.test(this.type)?this.p.join("."):"att"===this.type?this.att:void 0},setScenarioVals:function(a,b){"in"===this.type&&this.p&&this.p.length?a.setValue(this.id,this.t||b.mEnv.titleOf(this.p),b.mEnv.valueOf(this.p)):"att"===this.type&&a.setAttr(this.id,this.t||"untitled","",this.groupAtt)},applyScenarioVal:function(a,b){"in"===this.type&&(this.p&&this.p.length)&&b.mEnv.set(this.p,void 0,{v:a.v})}};o.ThrUserform=function(a){this.instantiate(a)};ThrUserform.prototype=
{thrClsName:"Userform",id:0,instantiate:function(a){this.clear();a&&$.extend(this,a);this.content&&this.content.length?(this.content=this.content.map(function(a){return new ThrUserformElement(a,this)},this),this.sort()):this.content=[]},objSpec:function(){return{type:this.thrClsName,id:this.id}},clear:function(){this.content=[];this.maxId=0},notifyChange:function(){this.isChanged=!0;this.isAuto=!1},initFromMathEnv:function(a){var b,c=[],d=0,e=!0,f=this,g=sfsIdPrefix.rexPre(sfsIdPrefix.item),h=sfsIdPrefix.rexPre(sfsIdPrefix.input+
sfsIdPrefix.output+sfsIdPrefix.item+sfsIdPrefix.conPoint);this.content=[];a.mEnv.eachNode(a.ctx,function(a,i){var j,n=i.length;if(a.hasOwnProperty("x")&&5===a.x.v)return!1;3<n&&(e=!1);if(n>d&&b)c.push({po:b});else if(n<d)for(j=d;j>n;j--)c.pop();b=a;d=n;if(("y"===a.s&&!g.test(i[n-1])||"x"===a.s&&!h.test(i[n-1]))&&void 0!==a.t){var p=f.content;for(j=1;j<c.length;j++){var t=c[j];t.el||(t.el=new ThrUserformElement({type:"g",t:t.po.t},f),p.push(t.el));p=t.el.c}j=sfsIdPrefix.orderNo(i[n-1]);p.push(new ThrUserformElement({type:"in",
ord:j,t:a.t,p:i.slice(0),v:a.v},f));if(1<p.length||2!==j)e=!1}});if(e){var i=new ThrUserformElement({type:"g",ord:1,t:A.ntx.producers},this),j=new ThrUserformElement({type:"g",ord:2,t:A.ntx.consumers},this);this.content.forEach(function(a){var b="out"===a.c[0].t.slice(0,3)?i:j;a.c[0].t=a.t;b.c.push(a.c[0])});this.content=[];i.c.length&&this.content.push(i);j.c.length&&this.content.push(j)}this.sort();this.isAuto=!0},addElement:function(a){var b={type:a};"tx"===a?b.t=A.ntx.enterText:"g"===a?b.t=A.ntx.untitledGroup:
"sel"===a&&(b.t=A.ntx.untitledSel,b.opts=[{t:A.ntx.untitledOpt}]);a=new o.ThrUserformElement(b,this);this.content.push(a);return a},getElement:function(a){var b;this.eachGroupContent(function(c){if(b=thr0.arrayObjByKey(c,"id",a))return!1});return b},moveElement:function(a,b,c){var d,e,f,g=-1;this.eachGroupContent(function(c,i){i instanceof ThrUserform?void 0===b&&(f=c):i.id===b&&(f=c);0>g&&(g=thr0.indexOfKey(c,"id",a),0<=g&&(e=c,d=c[g]));if(f&&d)return!1});d&&f&&(0>c?c=0:c>f.length&&(c=f.length),
e.splice(g,1),f.splice(c,0,d))},deleteElement:function(a){this.eachGroupContent(function(b){if(thr0.removeKeyFromArray(b,"id",a))return!1})},deleteInconsistentElements:function(a){this.eachGroupContent(function(b){for(var c=b.length-1;0<=c;c--)b[c].isConsistent(a)||b.splice(c,1)})},lineCount:function(){var a=0;this.eachElement(function(){a++});return a},sort:function(){this.eachGroupContent(function(a){a.sort(function(a,c){return a.ord!==c.ord?a.ord>c.ord?1:-1:a.t===c.t?0:a.t>c.t?1:-1});a.forEach(function(a,
c){a.ord=c+1})})},refreshOrderInfos:function(){this.eachGroupContent(function(a){a.forEach(function(a,c){a.ord=c+1})})},eachElement:function(a){this.content.forEach(function(b){return b.eachElement(a)})},eachGroupContent:function(a){var b=a(this.content,this);if(void 0!==b)return b;$.each(this.content,function(c,d){return b=d.eachGroupContent(a)});return b},getUsedPaths:function(a){var b=[];this.eachElement(function(c){c.collectUsedPaths(b,a)});return b},getAttrs:function(){var a=[];this.eachElement(function(b){"att"===
b.type&&a.push({id:b.id,key:(b.t||"").toLowerCase()})});return a},getElementProp:function(a){return(a=this.getElement(a))?a.getProp():void 0},addElToScDiff:function(a,b,c){(b=this.getElement(b))&&b.addToScDiff(a,c)},getHtml:function(a,b,c,d){var e=[],f=A.ntx;if(!this.content.length)return a?_h.div(_h.tag("em",f.empty),{"class":"thrUserform",style:"min-width: 400px;"}):_h.tag("p",f.emptyUfContent)+_h.tag("p",_h.tag("strong",f.hint+": ")+f.detailDataHint);15>=this.lineCount()&&(d=[],this.eachElement(function(a){"g"===
a.type&&d.push(a.t)}));this.content.forEach(function(f){(a||f.isConsistent(b))&&e.push(f.getRowHtml(a,b,c,d))},this);return"\x3ctable class\x3d'thrInitControl thrUserform"+(a?"":" thrSmall")+"' data-control\x3d'"+["treeTable","ufTreeTable"][a]+"'\x3e\x3ctbody\x3e"+e.join("")+"\x3c/tbody\x3e\x3c/table\x3e"},getExString:function(a,b){return this.content.map(function(c){return c.getExString(a,b,0)},this).join("\r\n")},getMValDiff:function(a,b,c){return aa(a,this.content,thr0.parseTree(b,c),{mvals:[],
diff:{},err:[]})},initScenarioenv:function(a,b){var c=b.addScenario(!0);b.attrOrder=[];this.eachElement(function(b){b.setScenarioVals(c,a)});c.attrs.forEach(function(a){a.groupAtt&&b.attrOrder.push(a.id)});b.scenarios.forEach(function(a){a.isBase||a.adjustToBase(c)});return b},applyScenario:function(a,b){b.vals.forEach(function(b){var d=this.getElement(b.id);d&&d.applyScenarioVal(b,a)},this);a.mEnv.hasChanges()&&(a.mEnv.calculate(),a.mEnv.clearChanges())}};o.ThrIDBStore=function(a,b,c){this.init(a,
b,c)};ThrIDBStore.prototype={db:void 0,combineIds:function(a,b,c){return a+"_"+thr0.idStr("000000",b)+(void 0!==c?"_"+thr0.idStr("000000",c):"")},init:function(a,b,c){function d(){c&&c(thrDatastore.ntx.errBrowserDbCreate)}try{var e=this,f=o.indexedDB.open(a.dbName,a.vnr);!f||f.hasOwnProperty("error")&&f.error?d():(this.config=a,f.onupgradeneeded=function(b){e.doUpgrade(b.target.result,a)},f.onsuccess=function(){e.db=f.result;e.db?b&&b(e):d()},f.onerror=d)}catch(g){d()}},doUpgrade:function(a,b){function c(b,
c,f,g){a.objectStoreNames.contains(b)||a.createObjectStore(b,{keyPath:c}).createIndex(f,f,{unique:g})}b.objTypes&&b.objTypes.length&&(c("buckets","uuid","userId",!1),c("metarevs","idrev","idrev",!0),c("metasesrevs","idrev","idrev",!0),b.objTypes.forEach(function(a){a=a.name.toLowerCase();c(a+"revs","ididrev","ididrev",!0);c(a+"sesrevs","ididrev","ididrev",!0)}));b.simpleTables&&b.simpleTables.length&&b.simpleTables.forEach(function(a){c(a.name,"uuid",a.isSysTable?"uuid":"userId",!0)})},deleteDB:function(a){var b=
o.indexedDB;b&&b.deleteDatabase(a)},getFileTree:function(a,b){var c=[];this.db?this.db.transaction("buckets").objectStore("buckets").index("userId").openCursor(IDBKeyRange.only(thr0.getUserInfo().id)).onsuccess=function(d){(d=d.target.result)?(c.push($.extend(d.value,{uuid:"ib:"+d.value.uuid})),d["continue"]()):b(R(2===a,c,thrDatastore.ntx.localDB))}:b()},saveRevs:function(a,b,c,d){var e,f,g,h,i,j,k,l,m;for(h=0;2>h;h++){if(d&&(k=h?d.sesrevs:d.revs,!k))continue;f=h?b.metaSesRevs:b.metaRevs;l=h?"sesrevs":
"revs";if(f.length){e=f[0].pos;for(f=f[f.length-1].pos;e<=f;e++)if(!k||!(void 0!==k.posA&&k.posA>e||void 0!==k.posZ&&k.posZ<e)){m=b.getFileRev(e,h);a.objectStore("meta"+l).add({idrev:this.combineIds(c,e),data:m.meta});for(g=m.objs.length-1;0<=g;g--)i=m.objs[g],j={pos:e},void 0!==i.revData&&(j.revData=i.revData),h&&void 0!==i.diffData&&(j.diffData=i.diffData),a.objectStore(i.type.toLowerCase()+l).add({ididrev:this.combineIds(c,i.id,e),type:i.type,id:i.id,data:j})}}}},loadMetaRevs:function(a,b,c,d,
e){var f=[];d?b.metaSesRevs=f:b.metaRevs=f;a.objectStore(d?"metasesrevs":"metarevs").openCursor(IDBKeyRange.bound(c,c+"_999999")).onsuccess=function(a){(a=a.target.result)?(f.push(a.value.data),a["continue"]()):e&&e(b)}},loadObjRevs:function(a,b,c,d,e,f){function g(a){d||(b.loadedRevSlices=[a.length?{a:a[0].pos,z:Math.max(a[a.length-1].pos,e)}:{a:0,z:999999}]);f&&f(b)}var h=[];c=this.combineIds(c,b.id);c=IDBKeyRange.bound(c,c+"_"+(void 0===e?"999999":thr0.idStr("000000",e)));d?b.sessionRevs=h:b.revisions=
h;a.objectStore(b.type.toLowerCase()+(d?"sesrevs":"revs")).openCursor(c,IDBCursor.prev||"prev").onsuccess=function(a){if(a=a.target.result)if(h.unshift(a.value.data),void 0===e||!a.value.data.revData)a["continue"]();else g(h);else g(h)}},createFile:function(a,b,c){var d=this,e=v(a.uuid),f=this.db.transaction(E(this,a.getObjTypes()),"readwrite");"ib:"===a.path.substring(0,3)&&(a.path=a.path.substring(3));a.uuid="ib:"+e;f.oncomplete=function(){b&&(a.editor=d.getEditor(a.uuid));c&&c(a)};f.objectStore("buckets").add({uuid:e,
userId:a.userId,path:a.path,name:a.name,objs:a.getObjList()});this.saveRevs(f,a,e)},getHead:function(a,b,c){var d,e=this,f=v(a.uuid),g={editor:a.editor},h=this.db.transaction(E(this),"readonly");h.oncomplete=function(){g=new ThrFile(g);g.donePos=g.getLastRevPos("metaSesRevs");g.synchDonePos=g.donePos;b&&0<=g.donePos?(d=g.mergeSessionRevsToRevision(),e.saveRevision(f,g,d,function(){c(g)})):c(g)};h.objectStore("buckets").get(f).onsuccess=function(a){$.extend(g,a.target.result);g.uuid="ib:"+f;e.loadMetaRevs(h,
g,f,!1);e.loadMetaRevs(h,g,f,!0);g.objs.forEach(function(a){e.loadObjRevs(h,a,f,!1,999999);e.loadObjRevs(h,a,f,!0)})}},addSessionRevs:function(a,b){var c,d,e=this,f=v(a.uuid),g={posA:a.synchDonePos+1,posZ:a.donePos},h=this.db.transaction(E(this,a.getObjTypes()),"readwrite");h.oncomplete=function(){b&&b()};h.onerror=function(){b&&b()};d=h.objectStore("buckets");d.get(f).onsuccess=function(b){a.objs.forEach(function(a){this.every(function(a){return this.id!==a.id||this.type!==a.type},a)&&(this.push({type:a.type,
id:a.id}),c=!0)},b.target.result.objs);c&&d.put(b.target.result);e.saveRevs(h,a,f,{sesrevs:g})}},loadRevList:function(a,b,c){var d={uuid:a};this.loadMetaRevs(this.db.transaction("metarevs","readonly"),d,v(a),!1,function(){c&&c(d)})},loadRevisions:function(a,b){var c=this,d=v(a.uuid),e={},f=this.db.transaction(E(this),"readonly");f.oncomplete=function(){e.metaRevs=e.metaRevs.filter(function(b){return b.pos<=a.pos});b&&b(e)};f.objectStore("buckets").get(d).onsuccess=function(b){$.extend(e,b.target.result);
e.uuid="ib:"+a.uuid;c.loadMetaRevs(f,e,d,!1);e.objs.forEach(function(b){c.loadObjRevs(f,b,d,!1,a.pos)})}},saveRevision:function(a,b,c,d){var e,f=this,g=v(a),h="_"+thr0.idStr("000000",c),i=this.db.transaction(E(this),"readwrite");if(!b.metaRevs||!b.metaRevs.length||!b.objs||!b.objs.length)throw"IndexedDB store needs prepared revision for saving!";i.oncomplete=function(){d&&d()};i.objectStore("buckets").get(g).onsuccess=function(a){a.target.result&&(f.delStoreRange(i,"metasesrevs",IDBKeyRange.bound(g,
g+h)),a.target.result.objs.forEach(function(a){var b=g+"_"+thr0.idStr("000000",a.id);f.delStoreRange(i,a.type.toLowerCase()+"sesrevs",IDBKeyRange.bound(b,b+h))}),e=b.metaRevs[b.metaRevs.length-1].pos,b.isEmptyRev(e)?b.metaRevs.pop():(b.createRevDataIfNEx(e),f.saveRevs(i,b,g,{revs:{posA:e,posZ:e}})))}},assertObjRevEx:function(a,b,c,d,e,f){var g,h=this,i=a.objectStore(c.type.toLowerCase()+"revs");a=this.combineIds(b,c.id);i.openCursor(IDBKeyRange.bound(a,a+"_"+thr0.idStr("000000",d)),IDBCursor.prev||
"prev").onsuccess=function(a){if((a=a.target.result)&&a.value.data.pos!==d&&a.value.data.pos>=e[0])g=a.value.data,g.pos=d,i.add({ididrev:h.combineIds(b,c.id,d),type:c.type,id:c.id,data:g});f&&f(c)}},prepareRemoveRevs:function(a,b,c,d,e){var f,g=this,h=[];this.loadMetaRevs(a,{},b,!1,function(i){f=thr0.indexOfKey(i.metaRevs,"pos",d[d.length-1]);0<=f&&f+1<i.metaRevs.length&&c.forEach(function(j){g.assertObjRevEx(a,b,j,i.metaRevs[f+1].pos,d,function(a){h.push(a);h.length===c.length&&e&&e(c)})})})},removeRevs:function(a,
b,c){var d=thr0.getKeyArray(b.metaRevs,"pos");if(d.length){var e=this,f=v(a),g=this.db.transaction(E(this),"readwrite");g.oncomplete=function(){c&&c(d)};g.objectStore("buckets").get(f).onsuccess=function(a){e.prepareRemoveRevs(g,f,a.target.result.objs,d,function(a){a.forEach(function(a){b.metaRevs.forEach(function(b){this["delete"](e.combineIds(f,a.id,b.pos))},g.objectStore(a.type.toLowerCase()+"revs"))});b.metaRevs.forEach(function(a){g.objectStore("metarevs")["delete"](e.combineIds(f,a.pos))})})}}},
renameFile:function(a,b){var c=this.db.transaction(["buckets"],"readwrite").objectStore("buckets");c.get(v(a.uuid)).onsuccess=function(a){c.put($.extend(a.target.result,{name:b}))}},moveFile:function(a,b){var c=this.db.transaction(["buckets"],"readwrite").objectStore("buckets");c.get(v(a.uuid)).onsuccess=function(a){a.target.result&&c.put($.extend(a.target.result,{path:"ib:"===b.substring(0,3)?b.substring(3):b}))}},delStoreRange:function(a,b,c){var d=a.objectStore(b);d.openCursor(c).onsuccess=function(a){if(a=
a.target.result)d["delete"](a.primaryKey),a["continue"]()}},deleteFile:function(a){var b=E(this,this.config.objTypes.map(function(a){return a.name.toLowerCase()}).concat(["meta"]),!1),c=this.db.transaction(b,"readwrite"),d=v(a.uuid);c.objectStore("buckets")["delete"](d);b.forEach(function(a){this.delStoreRange(c,a,IDBKeyRange.bound(d,d+"_99999"))},this)},getEditor:function(a,b){return ca(a,b)},releaseEditor:function(){},importFile:function(a,b,c,d,e,f){da(this,a,b,c,d,e,f)},downloadFile:function(a,
b){ea(this,a,b)},saveSimpleData:function(a,b,c){var d=this.db.transaction(a,"readwrite");d.objectStore(a).put(b);c&&(d.oncomplete=c)},saveSimpleList:function(a,b,c){var d=this.db.transaction(a,"readwrite"),e=d.objectStore(a);b.forEach(function(a){e.put(a)});c&&(d.oncomplete=c)},loadSimpleData:function(a,b,c,d){a=this.db.transaction(a).objectStore(a).get(c);a.onsuccess=function(a){d&&d(a.target.result)};a.onerror=function(){d&&d()}},deleteSimpleData:function(a,b){this.db.transaction(a,"readwrite").objectStore(a)["delete"](b)},
clearSimpleData:function(a,b){this.delStoreRange(this.db.transaction(a,"readwrite"),a,b?null:IDBKeyRange.only(thr0.getUserInfo().id))},listSimpleData:function(a,b,c,d,e){var f=[];this.db?this.db.transaction(a).objectStore(a).index(b?"uuid":"userId").openCursor(b?null:IDBKeyRange.only(thr0.getUserInfo().id)).onsuccess=function(a){var h,i=a.target.result;i?(c?(h={uuid:i.value.uuid},b||(h.userId=i.value.userId),c.forEach(function(a){i.value.hasOwnProperty(a)&&(h[a]=i.value[a])})):h=i.value,(!e||e(h))&&
f.push(h),i["continue"]()):d(f)}:d(f)},changeShareInfos:function(){},startCollaboration:function(){thr0.startPing()},stopCollaboration:function(a,b){b&&thr0.stopPing()},sendChatMsg:function(){}};o.ThrWebSQLStore=function(a,b){this.init(a,b)};ThrWebSQLStore.prototype={db:void 0,errRollback:function(){return!0},init:function(a,b){var c=this;(this.db=o.openDatabase?o.openDatabase(a.dbName,"1.0",a.dbDescription||a.dbName,524288E3):void 0)?(this.config=a,this.db.transaction(function(b){b.executeSql("CREATE TABLE IF NOT EXISTS files (id INTEGER PRIMARY KEY AUTOINCREMENT, uuid TEXT, userId INTEGER, path TEXT, name TEXT)");
b.executeSql("CREATE TABLE IF NOT EXISTS metarevs (id INTEGER, pos INTEGER, dt DATETIME, userId INTEGER)");b.executeSql("CREATE TABLE IF NOT EXISTS metasesrevs (id INTEGER, pos INTEGER, dt DATETIME, userId INTEGER, isUndo BOOLEAN DEFAULT false)");a.objTypes.forEach(function(a){a=a.name.toLowerCase();b.executeSql("CREATE TABLE IF NOT EXISTS "+a+"revs (id INTEGER, objId INTEGER, pos INTEGER, revData TEXT, diffData TEXT)");b.executeSql("CREATE TABLE IF NOT EXISTS "+a+"sesrevs (id INTEGER, objId INTEGER, pos INTEGER, revData TEXT, diffData TEXT)")});
a.simpleTables&&a.simpleTables.length&&a.simpleTables.forEach(function(a){b.executeSql("CREATE TABLE IF NOT EXISTS "+a.name+" (uuid TEXT"+(a.isSysTable?"":", userId INTEGER")+", data TEXT)")})},function(){c.db=void 0;b&&b(c)},function(){b&&b(c)})):b&&b(c)},deleteDB:function(a){(a=o.openDatabase(a,"1.0",a,2097152))&&a.transaction(function(a){a.executeSql("SELECT tbl_name FROM sqlite_master WHERE type \x3d 'table';",[],function(a,b){for(var e=b.rows.length-1;0<=e;e--){var f=b.rows.item(e).tbl_name;
0<=f.indexOf("__")||0<=f.indexOf("sqlite")||a.executeSql("DROP TABLE "+f)}})})},getFileTree:function(a,b){this.db?this.db.transaction(function(c){c.executeSql("SELECT * FROM files WHERE userId\x3d?",[thr0.getUserInfo().id],function(c,e){for(var f=[],g=0;g<e.rows.length;g++){var h=e.rows.item(g);f.push({id:h.id,uuid:"ib:"+h.uuid,path:h.path,name:h.name})}b(R(2===a,f,thrDatastore.ntx.localDB))})}):b()},saveRevs:function(a,b,c,d){var e,f,g,h,i,j,k,l,m;for(h=0;2>h;h++){if(d&&(k=h?d.sesrevs:d.revs,!k))continue;
f=h?b.metaSesRevs:b.metaRevs;l=h?"sesrevs":"revs";if(f.length){e=f[0].pos;for(f=f[f.length-1].pos;e<=f;e++)if(!k||!(void 0!==k.posA&&k.posA>e||void 0!==k.posZ&&k.posZ<e)){m=b.getFileRev(e,h);j=[c,e,m.meta.dt,m.meta.userId];h&&j.push(m.meta.undo?!0:!1);a.executeSql("INSERT INTO meta"+l+" (id, pos, dt, userId"+(h?", isUndo":"")+") VALUES (?,?,?,?"+(h?",?":"")+")",j,void 0,this.errRollback);for(g=m.objs.length-1;0<=g;g--)i=m.objs[g],j=[c,i.id,e,i.revData?JSON.stringify(i.revData):null],h&&i.diffData&&
j.push(JSON.stringify(i.diffData)),a.executeSql("INSERT INTO "+i.type.toLowerCase()+l+"(id, objId, pos, revData"+(h?", diffData":"")+") VALUES (?,?,?,?"+(h?",?":"")+")",j,void 0,this.errRollback)}}}},loadMetaRevs:function(a,b,c,d,e){var f=[],g=thr0.getUserInfo();d?b.metaSesRevs=f:b.metaRevs=f;a.executeSql("SELECT * FROM "+(d?"metasesrevs":"metarevs")+" WHERE id\x3d?",[c],function(a,c){for(var d=0;d<c.rows.length;d++){var k=c.rows.item(d);f.push({pos:k.pos,dt:k.dt,userId:k.userId,userName:g.dispName,
undo:k.isUndo})}e&&e(b)})},loadObjRevs:function(a,b,c,d,e,f){var g=[];d?b.sessionRevs=g:b.revisions=g;a.executeSql("SELECT * FROM "+b.type.toLowerCase()+(d?"sesrevs":"revs")+" WHERE id\x3d?"+(void 0===e?"":" AND pos\x3c\x3d"+e),[c],function(a,c){for(var j=c.rows.length-1;0<=j;j--){var k=c.rows.item(j),l={pos:k.pos};k.revData&&(l.revData=JSON.parse(k.revData));k.diffData&&(l.diffData=JSON.parse(k.diffData));g.unshift(l);if(void 0!==e&&l.revData)break}d||(b.loadedRevSlices=[g.length?{a:g[0].pos,z:Math.max(g[g.length-
1].pos,e)}:{a:0,z:999999}]);f&&f(b)})},createFile:function(a,b,c){var d=this,e=v(a.uuid);"ib:"===a.path.substring(0,3)&&(a.path=a.path.substring(3));a.uuid="ib:"+e;this.db.transaction(function(b){b.executeSql("INSERT INTO files (uuid, userId, path, name) VALUES (?,?,?,?)",[e,a.userId,a.path,a.name],function(b){d.getFileId(b,e,function(c){d.saveRevs(b,a,c)})},d.errRollback)},void 0,function(){b&&(a.editor=d.getEditor(a.uuid));c&&c(a)})},getFileId:function(a,b,c){a.executeSql("SELECT id FROM files WHERE uuid\x3d?",
[b],function(a,b){b.rows.length&&c(b.rows.item(0).id)})},getFileObjs:function(a,b,c){var d=[];this.config.objTypes.forEach(function(a){d.push("SELECT DISTINCT objId, '"+a.name+"' as type FROM "+a.name.toLowerCase()+"revs WHERE id\x3d"+b);d.push("SELECT DISTINCT objId, '"+a.name+"' as type FROM "+a.name.toLowerCase()+"sesrevs WHERE id\x3d"+b)});a.executeSql(d.join(" UNION "),void 0,function(a,b){for(var d=[],h=[],i=0;i<b.rows.length;i++){var j=b.rows.item(i),k=j.type+j.objId;0>h.indexOf(k)&&(h.push(k),
d.push({type:j.type,id:j.objId}))}c(d)})},getHead:function(a,b,c){var d=this,e=v(a.uuid),f={editor:a.editor};this.db.transaction(function(a){a.executeSql("SELECT * FROM files WHERE uuid\x3d?",[e],function(a,b){if(0<b.rows.length){var c=b.rows.item(0),g=c.id;f.id=g;f.uuid="ib:"+e;f.name=c.name;f.path=c.path;f.userId=c.userId;d.loadMetaRevs(a,f,g,!1);d.loadMetaRevs(a,f,g,!0);d.getFileObjs(a,g,function(b){f.objs=b;b.forEach(function(b){d.loadObjRevs(a,b,g,!1,999999);d.loadObjRevs(a,b,g,!0)})})}})},void 0,
function(){f=new ThrFile(f);f.donePos=f.metaSesRevs.length?f.metaSesRevs[f.metaSesRevs.length-1].pos:-1;f.synchDonePos=f.donePos;if(b&&0<=f.donePos){var a=f.mergeSessionRevsToRevision();d.saveRevision(e,f,a,function(){c(f)})}else c(f)})},addSessionRevs:function(a,b){var c=this,d=v(a.uuid),e={posA:a.synchDonePos+1,posZ:a.donePos};this.db.transaction(function(b){c.getFileId(b,d,function(d){c.saveRevs(b,a,d,{sesrevs:e})})},function(){b&&b()},function(){b&&b()})},loadRevList:function(a,b,c){var d=this,
e={uuid:a};this.db.transaction(function(b){d.getFileId(b,v(a),function(a){d.loadMetaRevs(b,e,a,!1,function(){c&&c(e)})})})},loadRevisions:function(a,b){var c=this,d={},e=v(a.uuid);this.db.transaction(function(b){b.executeSql("SELECT * FROM files WHERE uuid\x3d?",[e],function(b,f){if(f.rows.length){var i=f.rows.item(0);d.id=i.id;d.uuid="ib:"+e;d.name=i.name;d.path=i.path;d.userId=i.userId;c.loadMetaRevs(b,d,i.id,!1);c.getFileObjs(b,i.id,function(e){d.objs=e;e.forEach(function(d){c.loadObjRevs(b,d,
i.id,!1,a.pos)})})}})},void 0,function(){d.metaRevs=d.metaRevs.filter(function(b){return b.pos<=a.pos});b&&b(d)})},saveRevision:function(a,b,c,d){var e,f=this;if(!b.metaRevs||!b.metaRevs.length||!b.objs||!b.objs.length)throw"WebSQL store needs prepared revision for saving!";this.db.transaction(function(d){f.getFileId(d,v(a),function(a){d.executeSql("DELETE FROM metasesrevs WHERE id\x3d? AND pos\x3c\x3d?",[a,c],void 0,f.errRollback);f.config.objTypes.forEach(function(b){d.executeSql("DELETE FROM "+
b.name.toLowerCase()+"sesrevs WHERE id\x3d? AND pos\x3c\x3d?",[a,c],void 0,f.errRollback)});e=b.metaRevs[b.metaRevs.length-1].pos;b.isEmptyRev(e)?b.metaRevs.pop():(b.createRevDataIfNEx(e),f.saveRevs(d,b,a,{revs:{posA:e,posZ:e}}))})},void 0,function(){d&&d()})},assertObjRevEx:function(a,b,c,d,e,f){var g=this,h=c.type.toLowerCase()+"revs";a.executeSql("SELECT * FROM "+h+" WHERE id\x3d? AND objId\x3d? AND pos\x3c\x3d? ORDER BY pos ASC",[b,c.id,d],function(a,j){if(j.rows.length){var k=j.rows.item(j.rows.length-
1);k.pos!==d&&k.pos>=e[0]?a.executeSql("INSERT INTO "+h+" (id, objId, pos, revData, diffData) VALUES (?,?,?,?,?)",[b,c.id,d,k.revData||null,k.diffData||null],f,g.errRollback):f()}else f()})},prepareRemoveRevs:function(a,b,c,d){var e,f=this,g=0;this.loadMetaRevs(a,{},b,!1,function(h){e=thr0.indexOfKey(h.metaRevs,"pos",c[c.length-1]);0<=e&&e+1<h.metaRevs.length&&f.getFileObjs(a,b,function(i){i.forEach(function(j){f.assertObjRevEx(a,b,j,h.metaRevs[e+1].pos,c,function(){++g>=i.length&&d&&d()})})})})},
removeRevs:function(a,b,c){var d=this,e=thr0.getKeyArray(b.metaRevs,"pos");e.length&&this.db.transaction(function(c){d.getFileId(c,v(a),function(a){d.prepareRemoveRevs(c,a,e,function(){d.config.objTypes.forEach(function(e){b.metaRevs.forEach(function(b){c.executeSql("DELETE FROM "+e.name.toLowerCase()+"revs WHERE id\x3d? AND pos\x3d?",[a,b.pos],void 0,d.errRollback)})});b.metaRevs.forEach(function(b){c.executeSql("DELETE FROM metarevs WHERE id\x3d? AND pos\x3d?",[a,b.pos],void 0,d.errRollback)})})})},
void 0,function(){c&&c(e)})},renameFile:function(a,b){this.db.transaction(function(c){c.executeSql("UPDATE files SET name\x3d? WHERE uuid\x3d?",[b,v(a.uuid)])})},moveFile:function(a,b){this.db.transaction(function(c){c.executeSql("UPDATE files SET path\x3d? WHERE uuid\x3d?",["ib:"===b.substring(0,3)?b.substring(3):b,v(a.uuid)])})},deleteFile:function(a){var b=this;this.db.transaction(function(c){b.getFileId(c,v(a.uuid),function(a){E(b,b.config.objTypes.map(function(a){return a.name.toLowerCase()}).concat(["meta"]),
!1).concat(["files"]).forEach(function(e){c.executeSql("DELETE FROM "+e+" WHERE id\x3d?",[a],void 0,b.errRollback)})})})},getEditor:function(a,b){return ca(a,b)},releaseEditor:function(){},importFile:function(a,b,c,d,e,f){da(this,a,b,c,d,e,f)},downloadFile:function(a,b){ea(this,a,b)},doSaveSimpleData:function(a,b,c,d){var e=[d.uuid];c||e.push(d.userId);a.executeSql("SELECT uuid FROM "+b+" WHERE uuid\x3d?"+(c?"":" AND userId\x3d?"),e,function(a,g){g.rows.length?(e.unshift(JSON.stringify(d)),a.executeSql("UPDATE "+
b+" SET data\x3d? WHERE uuid\x3d?"+(c?"":" AND userId\x3d?"),e)):(e.push(JSON.stringify(d)),a.executeSql("INSERT INTO "+b+" (uuid, "+(c?"":"userId, ")+" data) VALUES (?,"+(c?"":"?,")+"?)",e))})},saveSimpleData:function(a,b,c){var d=this;this.db.transaction(function(c){d.doSaveSimpleData(c,a,fa(a,d.config),b)},void 0,c)},saveSimpleList:function(a,b,c){var d=this,e=fa(a,this.config);this.db.transaction(function(c){b.forEach(function(b){d.doSaveSimpleData(c,a,e,b)})},void 0,c)},loadSimpleData:function(a,
b,c,d){this.db.transaction(function(e){var f=[c];b||f.push(thr0.getUserInfo().id);e.executeSql("SELECT data FROM "+a+" WHERE uuid\x3d?"+(b?"":" AND userId\x3d?"),f,function(a,b){d&&d(b.rows.length?JSON.parse(b.rows.item(0).data):void 0)},function(){d&&d()})})},deleteSimpleData:function(a,b){this.db.transaction(function(c){c.executeSql("DELETE FROM "+a+" WHERE uuid\x3d?",[b])})},clearSimpleData:function(a,b){this.db.transaction(function(c){c.executeSql("DELETE FROM "+a+(b?"":" WHERE userId\x3d?"),
b?void 0:[thr0.getUserInfo().id])})},listSimpleData:function(a,b,c,d,e){this.db?this.db.transaction(function(f){f.executeSql("SELECT data FROM "+a+(b?"":" WHERE userId\x3d?"),b?void 0:[thr0.getUserInfo().id],function(a,f){var i,j,k,l,m=[];for(i=0;i<f.rows.length;i++){l=JSON.parse(f.rows.item(i).data);if(c){k={uuid:l.uuid};b||(k.userId=l.userId);for(j=0;j<c.length;j++){var n=c[j];l.hasOwnProperty(n)&&(k[n]=l[n])}}else k=l;(!e||e(k))&&m.push(k)}d(m)})}):d([])},changeShareInfos:function(){},startCollaboration:function(){thr0.startPing()},
stopCollaboration:function(a,b){b&&thr0.stopPing()},sendChatMsg:function(){}};o.ThrServerStore=function(a){this.init(a)};ThrServerStore.prototype={url:{file:"file"},init:function(a){this.errorCallback=a},fileSvc:function(a,b){return this.url.file+"/"+encodeURI(a)+(b?"/"+b:"")},getFileTree:function(a,b){thr0.ajax("GET",this.fileSvc("*","list?mode\x3d"+a)).done(function(c){b(R(2===a,c))}).fail(function(){b(new ThrTreeNode(""))})},createFile:function(a,b,c){thr0.ajax("POST",this.fileSvc(a.uuid,b?"editor":
void 0),a.getData()).done(c)},notifyFileCreated:function(a){thr0.ajax("PUT",this.fileSvc(a.uuid,"notifyFileCreated"))},copyTo:function(a,b){thr0.ajax("PUT",this.fileSvc(a.uuid,"copyto"),a).done(b).fail(function(){b&&b(!1)})},getHead:function(a,b,c){thr0.ajax("GET",this.fileSvc(a.uuid,"head"+(a.editor?"?editorid\x3d"+a.editor.id:""))).done(function(a){c&&c(new ThrFile(a,thrDatastore))})},addSessionRevs:function(a,b){var c=this,d=$.extend(a.getSessionData(a.synchDonePos+1,a.donePos),{editor:a.editor});
thr0.ajax("PUT",this.fileSvc(a.uuid,"sessionRevs"),d).fail(function(b){var f,g,h,i;try{f=b.responseText&&"SESREV_POSITION_ALREADYEXISTING"===JSON.parse(b.responseText).code}catch(j){}if(f&&!d.metaSesRevs[0].undo){h={meta:{pos:d.metaSesRevs[0].pos},objs:[]};for(b=0;b<d.objs.length;b++){g=d.objs[b];i=[];for(f=0;f<g.sessionRevs.length;f++)i.push(JSON.parse(g.sessionRevs[f].diffData));i.length&&h.objs.push({type:g.type,id:g.id,diffData:1===i.length?i[0]:thrRevisioning.diffOp.merge(i)})}setTimeout(function(){c.retryAddSessionRevs(a,
h)},500)}else this.collabCallback(a.uuid,{rollbackPos:a.synchDonePos+1})}).always(b)},retryAddSessionRevs:function(a,b){var c,d,e=a.metaSesRevs;for(c=e.length-1;0<=c&&!d&&e[c].pos>=b.meta.pos;c--)d=e[c].undo?e[a.getUndoIx(c)].pos:e[c].pos,d=a.hasSesRevConflict(a.getFileRev(d,!0).objs,b.objs);d||this.collabCallback(a.uuid,{retryRev:b})},loadRevList:function(a,b,c){thr0.ajax("GET",this.fileSvc(a,"revList?pos\x3d"+b)).done(c)},loadRevisions:function(a,b){var c=a.objs&&a.objs.length?"\x26objs\x3d"+encodeURIComponent(a.objs.map(function(a){return a.type+
":"+a.id}).join(",")):"";thr0.ajax("GET",this.fileSvc(a.uuid,"revisions?pos\x3d"+a.pos+(a.gid?"\x26gid\x3d"+a.gid:"")+c)).done(b)},saveRevision:function(a,b,c,d){thr0.ajax("PUT",this.fileSvc(a,"newRevision?editorid\x3d"+b.editor.id+"\x26pos\x3d"+c)).done(d)},removeRevs:function(a,b,c){thr0.ajax("DELETE",this.fileSvc(a,"revisions"),b).done(c)},renameFile:function(a,b){thr0.ajax("PUT",this.fileSvc(a.uuid,"name"),{uuid:a.uuid,name:b})},moveFile:function(a,b){thr0.ajax("PUT",this.fileSvc(a.uuid,"path"),
{uuid:a.uuid,path:b})},deleteFile:function(a){thr0.ajax("DELETE",this.fileSvc(a.uuid))},getEditor:function(a,b){thr0.ajax("PUT",this.fileSvc(a,"editor")).done(b)},releaseEditor:function(a,b){thr0.ajax("DELETE",this.fileSvc(a,"editor?editorid\x3d"+b.id))},getResource:function(a,b){thr0.ajax("GET","resources/"+a).done(b)},importFile:function(a,b,c,d,e,f){$.ajax({type:"POST",url:thr0.makeUrl(this.fileSvc(b)),contentType:"application/octet-stream",data:c+"/"+a+"#/"+d}).done(e).fail(f)},exportFile:function(a,
b,c,d,e){c={svg:c,printQuality:e};a&&(c.destination=a);thr0.ajax("POST","svg/"+b+"/"+d,c,/^(jpg|png|wmf|pdf)$/.test(d)).done(function(c,d,e){a||thr0.triggerDownloadLink(b,c,e.getResponseHeader("content-type"))})},downloadFile:function(a,b){thr0.ajax("GET",this.fileSvc(a),void 0,!0).done(function(a,d,e){thr0.triggerDownloadLink(b,a,e.getResponseHeader("content-type"))})},changeShareInfos:function(a,b){var c=this;this.collabCallback(a,{shareInfos:b});thr0.ajax("PUT",this.fileSvc(a,"shareInfos"),{uuid:a,
shareInfos:b}).done(function(b){c.collabCallback(a,b)})},getPublicationList:function(a){thr0.ajax("GET","public/"+thr0.getUserInfo().id+"/list").done(a)},getPublicationInfos:function(a,b){thr0.ajax("GET","public/"+encodeURI(a)+"/infos").done(b)},unpublish:function(a,b){thr0.ajax("DELETE","public/"+encodeURI(a)).done(b).fail(function(){b&&b()})},publish:function(a,b,c){a.userId=thr0.getUserInfo().id;b&&(a.data=JSON.stringify(b),a.revDt=b.metaRevs[b.metaRevs.length-1].dt);thr0.ajax("POST","public/"+
encodeURI(a.uuid),a).done(c).fail(function(){c&&c()})},startCollaboration:function(a,b){var c=a?a.uuid:"ping",d=this;this.collab={uuid:c,editor:a.editor,callback:b,liveEditorsCount:0,isStart:!0};this.pingCollaboration();thr0.ajax("GET",this.fileSvc(c,"shareInfos")).done(function(a){b&&b(c,{shareInfos:a});d.startPingCollaboration(12E4);d.startLiveCollaboration(c)})},stopCollaboration:function(a,b){var c=this.collab;if(c&&(a=a||c.editor,!a&&!c.editor||c.uuid===a.uuid))c.socket&&c.socket.close(),c.pingTimer&&
clearInterval(c.pingTimer),b||thr0.startPing()},startPingCollaboration:function(a){var b=this,c=this.collab;c.pingDelay=a;c.pingTimer&&clearInterval(c.pingTimer);c.pingTimer=setInterval(function(){b.pingCollaboration()},a)},pingCollaboration:function(){var a=this.collab;if(a)if(thr0.hasActivity()){var b=this,c=a.uuid;thr0.ajax("GET",this.fileSvc(c,"liveChanges?editorid\x3d"+a.editor.id)).done(function(a){a&&a.editors&&b.collabCallback(c,a)}).fail(function(){b.errorCallback&&b.errorCallback()})}else thr0.signOut(2)},
startLiveCollaboration:function(a){var b,c=this,d="wss://"+o.location.host+thr0.makeUrl("livecollab");this.collab||(this.collab={});if("WebSocket"in o)b=new WebSocket(d);else if("MozWebSocket"in o)b=new MozWebSocket(d);else{c.collabCallback(a,thrDatastore.ntx.noLiveCollab);return}this.collab.socket=b;b.onopen=function(){b.send(JSON.stringify({editors:[c.collab.editor]}))};b.onclose=function(){c.collab&&c.collab.uuid===a&&delete c.collab.socket};b.onmessage=function(b){function d(a){a&&a.forEach(function(a){"UNDO"!==
a.diffData&&(a.diffData=JSON.parse(a.diffData))})}b=JSON.parse(b.data);b.objs&&b.objs.forEach(function(a){d(a.revisions);d(a.sessionRevs)});c.collabCallback(a,b)}},collabCallback:function(a,b){var c=this.collab;c&&c.callback&&(c.callback(a,b,c.isStart),b.chatMessages&&(c.isStart=!1))},sendChatMsg:function(a,b){var c=this.collab;c&&(c.socket?c.socket.send(b):thr0.ajax("PUT",this.fileSvc(a.uuid,"chatMsg"),{uuid:a.uuid,editor:a,sessionInfo:{chatMessages:[b]}}))}};o.thrDatastore={ntx:{open:"Open",rename:"Rename",
move:"Move",copy:"Copy",download:"Download",error:"Error",username:"User name",filename:"Filename",title:"Title",shownUnit:"Shown unit",name:"Name",newName:"New name",newFilename:"new.sankey",emailAddress:"Email address",isOwner:"is owner",untitledFile:"Untitled sankey diagram",copyOf:"Copy of",copyToFolder:"Copy to folder",selectedFolder:"selected folder",selGdFolder:"Folder on Google Drive",invalidFilename:"Invalid file name",validFilenameHint:"Please enter a valid file name!",invalidChars:"Following special characters are not allowed",
toFolder:"to folder",copyFile:"Copy diagram",copySuccess:"Successfully copied",copyFail:"Failed to copy diagram.",selFolder:"Select folder for",selFileCopy:"Select diagram to copy",noLiveCollab:"Live collaboration is not supported by this browser.",cloudStore:"Cloud storage",notAvailLic:" is not available with your current license.",gSigninRequired:"Signin required",dataStoreHelp:"Where is my data stored? (security/safety/speed)",openFromGDrive:"Open from Google Drive",copyFromGDrive:"Copy from Google Drive",
selectFileHint:"Please select a diagram before you press",downloadMsg:"The download will start in a moment.",confirmDel:"will be deleted finally. Please confirm!",delHistoryHint:"The revision history of your diagram will be lost, when you move it between local browser database and cloud storage! Do you like to continue?",unpublish:"Cancel publication",confirmUnpublish:"Publication will be cancelled. Please confirm!",shareFile:"Share diagramm with",unknownUser:"Unknown user",noUserFound:"There is no account for email address",
canEdit:"can edit",canView:"can view",notAvailFor:"is not available for",remove:"Remove",localDB:"Local browser database",cloudDB:"Cloud storage",published:"Published",backupHint:"NO automatic backup of LOCALLY stored diagrams: Please download them regularly as .sankey files and store them in a safe place.",errBrowserDbCreate:"Your browser does not allow access to the browser database. A probable cause is a deactivated history. Please activate the history in your browser settings."},mimeTypes:{gfiles:"application/vnd.google.drive.ext-type.sankey"},
init:function(a,b,c){thr0.addNotifier(this);thr0.setResCache(this);a&&(a.objTypes&&(this.objTypes=$.extend([],a.objTypes)),this.brwsr=!o.indexedDB?new ThrWebSQLStore(a,b):new ThrIDBStore(a,b,c));this.srvr=new ThrServerStore(c)},finish:function(){this.stopCollaboration(void 0,!0);thr0.removeResCache(this);thr0.removeNotifier(this)},notifyFileChange:function(a){this.synchronizeSessionRevs(a.file)},notifyFileClosed:function(a){this.stopCollaboration(a.editor);this.releaseEditor(a.uuid,a.editor)},getOAuthToken:function(a){var b=
thr0.getUserInfo();b.authToken&&"G"===b.authId?thr0.ajax("GET","ssoauth/gaccesstoken").done(function(b){a&&a(b.token)}):thr0.gRegisterClick(function(c){thr0.ajax("POST","ssoauth/lateglogin?code\x3d"+encodeURIComponent(c)).done(function(c){b.authToken="X";b.authId="G";thr0.setUserInfo(b,!0);a&&a(c.token)})})},getResource:function(a,b){this.srvr.getResource(a,b)},synchronizeSessionRevs:function(a){var b=this;!a.waitForResponse&&a.donePos>a.synchDonePos&&(a.waitForResponse=!0,this.getStoreInstance(a.uuid).addSessionRevs(a,
function(){a.waitForResponse=!1;b.synchronizeSessionRevs(a)}),a.synchDonePos=a.donePos)},getFileTree:function(a,b){var c=this.brwsr;this.srvr.getFileTree(a,function(d){c.getFileTree(a,function(a){a&&d.sub.unshift(a);b(d)})})},getFilePath:function(a){var b=a.uuid.substring(0,3);return("ib:"===b?thrDatastore.ntx.localDB:"gd:"===b?"Google Drive":thrDatastore.ntx.cloudStore)+":"+(a.path?"\\"+a.path.replace(/\//ig,"\\")+"\\":"")+a.name},getStoreInstance:function(a){return"ib:"===(a||"").slice(0,3)?this.brwsr:
this.srvr},getHead:function(a,b,c){this.getStoreInstance(a.uuid).getHead(a,b,c)},createFile:function(a,b,c){var d=this.getStoreInstance(a.path);d.createFile(a,b,c);d!==this.srvr&&this.srvr.notifyFileCreated(a)},importFile:function(a,b,c,d,e,f){var g=this.srvr;c=c.join("/");var h=this.getStoreInstance(c);h.importFile(a,b,c,d,function(a){h!==g&&g.notifyFileCreated(a);e&&e(a)},f)},moveFile:function(a,b){var c,d=this,e=this.getStoreInstance(a.uuid),f=this.getStoreInstance(b);e===f?e.moveFile(a,b):(thr0.notify("notifyBeforeFileStoreChange",
a.uuid),c=$.extend(!0,{},a),this.copyTo(c,void 0,function(a){a&&d.deleteFile(c)}),":"===a.uuid.charAt(2)&&(a.uuid=a.uuid.substring(3)),a.uuid=(":"===b.charAt(2)?b.slice(0,3):"")+a.uuid)},renameFile:function(a,b){this.getStoreInstance(a.uuid).renameFile(a,b)},deleteFile:function(a){this.getStoreInstance(a.uuid).deleteFile(a)},removeRevision:function(a,b,c){if(void 0!==b.history){var d=a.getMainData(!0);d.metaRevs=[{pos:b.history}];a.metaRevs.length&&a.metaRevs[0].gId&&(b=thr0.indexOfSorted(a.metaRevs,
"pos",b.history),0<=b&&a.metaRevs[b].gId&&(d.metaRevs[0].gId=a.metaRevs[b].gId));this.getStoreInstance(a.uuid).removeRevs(a.uuid,d,c)}},removeOlderRevisions:function(a,b,c){if(void 0!==b.history){var d=a.getMainData(!0);d.metaRevs=a.metaRevs.filter(function(a){return a.pos<this},b.history).map(function(a){return this?{pos:a.pos,gId:a.gId}:{pos:a.pos}},a.metaRevs.length&&a.metaRevs[0].gId);d.metaRevs.length&&this.getStoreInstance(a.uuid).removeRevs(a.uuid,d,c)}},loadRevList:function(a,b,c){0<=b&&this.getStoreInstance(a.uuid).loadRevList(a.uuid,
b,function(a){c&&c(new ThrFile(a))})},loadRevisions:function(a,b){this.getStoreInstance(a.uuid).loadRevisions(a,function(a){b&&b(new ThrFile(a))})},saveRevision:function(a,b){var c=thr0.getUserInfo(),c=a.mergeSessionRevsToRevision({userId:c.id,userName:c.dispName});0<=c&&this.getStoreInstance(a.uuid).saveRevision(a.uuid,a,c,b)},copyTo:function(a,b,c){function d(d,e,f,g){var h=thr0.getUserInfo();d.path=a.path;d.name=a.name;d.uuid=(":"===d.path.charAt(2)?d.path.slice(0,3):"")+v(b?b:a.uuid);d.userId=
h.id;d.editor={uuid:d.uuid,userId:h.id,id:1,sessionId:1,dispName:h.dispName,userRight:0};d.removeNewerRevs(e);d.metaSesRevs.length&&d.mergeSessionRevsToRevision();d.metaRevs.length||d.metaRevs.push(new ThrMetaRevision({pos:0,userId:h.id,userName:h.dispName}));d.mergeRevisions();f.createFile(d,!1,c);f!==g&&g.notifyFileCreated(d)}var e=this.srvr,f=this.getStoreInstance(a.uuid),g=this.getStoreInstance(a.path),h={history:a.metaRevs&&a.metaRevs.length?a.metaRevs[0].pos:void 0,done:a.metaSesRevs&&a.metaSesRevs.length?
a.metaSesRevs[0].pos:void 0};f===g&&f===e?(b&&(a.path+="/uuid:"+b),f.copyTo(a,c)):void 0===h.history?f.getHead({uuid:a.uuid},!1,function(a){d(a,h,g,e)}):f.loadRevisions({uuid:a.uuid,pos:h.history},function(a){d(new ThrFile(a),h,g,e)})},downloadFile:function(a,b){this.getStoreInstance(a).downloadFile(a,b)},exportFile:function(a,b,c,d,e){!a&&(!d||"svg"===d)?thr0.triggerDownloadLink(b,c,"image/svg+xml"):/^(jpg|png)$/.test(d)&&!thr0.isIE()&&!a?thrSvg.clientSideSvgAs(b,c,d):this.srvr.exportFile(a,b,c,
d,e)},getPublicationInfos:function(a,b){this.srvr.getPublicationInfos(a,b)},publish:function(a,b){var c=this,d=this.getStoreInstance(a.uuid);d===this.srvr||a.data?this.srvr.publish(a,void 0,b):d.loadRevisions({uuid:a.uuid,pos:a.revPos},function(d){d=new ThrFile(d);d.removeNewerRevs({history:a.revPos});d.mergeRevisions();c.srvr.publish(a,d.getData(),b)})},unpublish:function(a,b){this.srvr.unpublish(a,b)},fileTabpanelHtml:function(a,b){var c=[{t:thrDatastore.ntx.localDB,ico:72},{t:thrDatastore.ntx.cloudDB,
ico:73},{t:"Google Drive",ico:74}];b&&c.push({t:thrDatastore.ntx.published,ico:89});return _h.div(_h.tag("ul",c.map(function(a){return _h.tag("li",_h.icon(a.ico),{title:a.t})}).join(""))+_h.div(c.map(function(){return _h.div("")}).join("")),{"class":"thrTabpanel",style:"min-width:"+a+"px;"})},createFileTabpanel:function(a,b,c,d,e,f,g,h,i){var j,k=$(this.fileTabpanelHtml(450,f)).appendTo(a),l=thr0.isLicensed("cloudStore");h={"class":"thrLine",style:"padding: "+h+"px 0; min-width: 600px;"};thrUI.tabpanel.create(k);
l&&!thrUI.gDriveInitialized&&k.data("triggerchange",1).change(function(a){$(a.target).hasClass("thrTabpanel")&&(2===a.value&&thrUI.initGDrive(),thr0.breakEvent(a))});thrUI.tabpanel.activateTabNo(k,0);j=$(_h.div("")).appendTo(k.find("\x3ediv\x3ediv:first-child")).data("rootname",thrDatastore.ntx.localDB);thrUI.folderList.create(j,d,2===c?168:248);j.append(_h.div(thrDatastore.ntx.backupHint,{style:"width: 590px; margin: 5px 0; color: #888;"}));this.brwsr.getFileTree(c,function(a){thrUI.setTempData(b,
"folderTreeDB",a);thrUI.folderList.fill(j,[],thrUI.getTempDataPath(b,"folderTreeDB"));thrUI.dialog.center(b.find(".thrDialog"))});if(l){var m=$(_h.div("")).appendTo(k.find("\x3ediv\x3ediv:nth-child(2)")).data("rootname",thrDatastore.ntx.cloudDB);thrUI.folderList.create(m,d,2===c?116:void 0);this.srvr.getFileTree(c,function(a){thrUI.setTempData(b,"folderTreeCloud",a);thrUI.folderList.fill(m,[],thrUI.getTempDataPath(b,"folderTreeCloud"));thrUI.dialog.center(b.find(".thrDialog"))})}else $(_h.div(_h.tag("p",
thrDatastore.ntx.cloudStore+thrDatastore.ntx.notAvailLic)+_h.upgradeBtn(),h)).appendTo(k.find("\x3ediv\x3ediv:nth-child(2)"));d=$(_h.div("",h)).appendTo(k.find("\x3ediv\x3ediv:nth-child(3)"));l?thrUI.$GPickerButton(g,e).appendTo(d).click(i):$(_h.tag("p","Google Drive"+thrDatastore.ntx.notAvailLic)+_h.upgradeBtn()).appendTo(d);if(f)if(thr0.isLicensed("publish")){var n=k.find("\x3ediv\x3ediv:last-child").append(_h.tag("p",thrDatastore.ntx.published)+_h.div("",{"class":"thrPublished",style:"height: "+
(2===c?200:280)+"px; min-width: 600px;"})).find("\x3ediv");thrUI.listbox.create(n);this.srvr.getPublicationList(function(a){n.append(a.map(function(a){return _h.div(_h.div("","thrIconApp")+(JSON.parse(a.meta).filePath||a.uuid),{"data-uuid":a.uuid,"data-url":a.url})}))})}else $(_h.div(_h.tag("p",thrDatastore.ntx.published+thrDatastore.ntx.notAvailLic)+_h.upgradeBtn(),h)).appendTo(k.find("\x3ediv\x3ediv:last-child"));a.append(_h.div(_h.span(thrDatastore.ntx.dataStoreHelp,{"class":"thrLink",onclick:'thrUI.openTab("pages/help01.html#topic1");'}),
{style:"margin-top:5px;"}));return k},getEditor:function(a,b){this.getStoreInstance(a).getEditor(a,b)},releaseEditor:function(a,b){this.getStoreInstance(a).releaseEditor(a,b)},changeShareInfos:function(a,b){this.getStoreInstance(a).changeShareInfos(a,b)},startCollaboration:function(a,b){a&&a.editor&&(thr0.stopPing(),this.stopCollaboration(void 0,!0),this.getStoreInstance(a.uuid).startCollaboration(a,b))},stopCollaboration:function(a,b){var c=this.getStoreInstance(a?a.uuid:"");c&&c.stopCollaboration(a,
b)},sendChatMsg:function(a,b){this.getStoreInstance(a.uuid).sendChatMsg(a,b)},getCachedRes:function(a,b,c,d){this.brwsr.loadSimpleData("resCache",!0,a,function(e){"string"===typeof e&&(e=JSON.parse(e));e&&e.version>=b?c(e.data):thr0.ajax("GET",a).done(function(d){thrDatastore.brwsr.saveSimpleData("resCache",{version:b,uuid:a,data:d});c(d)}).fail(d)})}};thrNtx.register(thrDatastore);thrUI.$GPickerButton=function(a,b){return $(_h.btn("\x3cimg src\x3d'"+thr0.makeUrl("resources/images/google/drive/product16.png")+
"' /\x3e\x3cdiv class\x3d'thrButtonText'\x3e"+a+"\x3c/div\x3e")+(b?"\x3cspan class\x3d'thrGdFolder thrDlgResult' data-prop\x3d'gdFolderId'\x3e[]\x3c/span\x3e":""),void 0,"div")};thrUI.selGdFolderClick=function(a,b){thrDatastore.getOAuthToken(function(c){thrUI.gPicker.create(c,b,function(b){b[google.picker.Response.ACTION]===google.picker.Action.PICKED&&(b=b[google.picker.Response.DOCUMENTS][0],a.find(".thrGdFolder").text("["+b[google.picker.Document.NAME]+"]").data("value",b[google.picker.Document.ID]))},
!0)})};thrUI.fileOpenDialog={show:function(a,b){var c=thrUI.dialog.create(a,[thrDatastore.ntx.open,thrUI.ntx.cancel]);thrUI.setTempData(c,"foCallback",b);thrDatastore.createFileTabpanel(c.find(".thrDlgBody"),c,0,!1,!1,!1,thrDatastore.ntx.openFromGDrive,116,function(a){thrUI.fileOpenDialog.gdriveclick(a)});thrUI.dialog.center(c.find(".thrDialog"));c.find(".thrDialog").change(function(a){thrUI.fileOpenDialog.change(a)})},change:function(a){var b,c,d=$(a.currentTarget).parent(),e=0<=[thrUI.ntx.cancel,
thrUI.ntx.close].indexOf(a.dlgCmd),f=thrUI.getTempData(d,"foCallback");a.stopPropagation();b=d.find(".thrTabpanel\x3ediv\x3ediv:not(.thrNoDisplay)");e||(a.value=thrUI.folderList.getValue(b.find(".thrFolderList")));a.value&&(c=(b=thrUI.getTempData(d,b.index()?"folderTreeCloud":"folderTreeDB"))?b.findItem(a.value):void 0);thrUI.dialog.close(d);f&&!e&&f(c?c.uuid:void 0)},gdriveclick:function(a){var b=$(a.target).closest(".thrDlgBack");thrDatastore.getOAuthToken(function(a){thrUI.gPicker.create(a,b.find(".thrDlgTitle").clone().children().remove().end().text(),
function(a){thrUI.fileOpenDialog.gpickerCallback(b,a)})})},gpickerCallback:function(a,b){var c;b[google.picker.Response.ACTION]===google.picker.Action.PICKED&&(c=thrUI.getTempData(a,"foCallback"),thrUI.dialog.close(a),c&&c("gd:"+b[google.picker.Response.DOCUMENTS][0][google.picker.Document.ID]))}};thrUI.fileNewDialog={show:function(a,b,c,d){var e,f=[[thrDatastore.ntx.filename,_h.inp({size:"45",value:c||thrDatastore.ntx.newFilename,name:"name",style:"width:98%;"})],[["\x3cdiv class\x3d'thrDropdownTreeview' data-charlimit\x3d'60' style\x3d'width:100%;'\x3e\x3c/div\x3e",
{colspan:2}]],[["",{colspan:2}]]],g=thrUI.dialog.create(a,[b+" "+thrDatastore.ntx.selectedFolder,thrUI.ntx.cancel]);a=g.find(".thrDlgBody");c&&f.splice(1,2);thrUI.setTempData(g,"fnCallback",d);e=$(_h.table(void 0,f,{style:"width: 100%; margin-bottom: 5px;"})).appendTo(a);c||this.getTemplatesData(function(a){var b=new ThrTreeNode,c=e.find(".thrDropdownTreeview"),d=thrNtx.iso639_1;b.initFromObject(a,{items:"items",nodes:"groups",name:"name",nameProps:[d,"en"],val:"res",valProps:[d,"en"]});thrUI.dropdownTreeview.create(c,
b);thrUI.dropdownTreeview.fill(c,a.std.res[d]||a.std.res.en,a.std.name[d]||a.std.name.en)});thrDatastore.createFileTabpanel(a,g,2,!0,thr0.isLicensed("cloudStore"),!1,thrDatastore.ntx.selGdFolder,95,function(){thrUI.selGdFolderClick(g,thrDatastore.ntx.selFolder+" '"+thrUI.fileNewDialog.getName(g)+"'")});thrUI.dialog.center(g.find(".thrDialog"));g.find(".thrDialog").change(function(a){thrUI.fileNewDialog.change(a)});a.find("input[name\x3d'name']").focus().select()},change:function(a){var b=!1,c=$(a.currentTarget).parent(),
d=c.find(".thrTabpanel\x3ediv\x3ediv:not(.thrNoDisplay)"),e=d.find(".thrPath"),f={name:this.getName(c),path:e.length?thrUI.path.getValue(e):void 0},e=c.find(".thrGdFolder").data("value");a.stopPropagation();if(void 0!==a.dlgCmd)if(0<=[thrUI.ntx.cancel,thrUI.ntx.close].indexOf(a.dlgCmd))thrUI.dialog.close(c);else if(thr0.isValidFilename(f.name)){d.index()||(f.path.length?f.path[0]="ib:"+f.path[0]:f.path.unshift("ib:"));if(!f.path){if(!thr0.isLicensed("cloudStore"))return;f.path=["gd:"+(e||"")];b=void 0===
e}b?thrDatastore.getOAuthToken(function(){thrUI.fileNewDialog.finish(c,f)}):this.finish(c,f)}else thrUI.dialog.show(thrDatastore.ntx.invalidFilename,0,0,thrDatastore.ntx.validFilenameHint+"\x3cbr/\x3e"+thrDatastore.ntx.invalidChars+': \\ / : * ? " \x3c \x3e |')},finish:function(a,b){var c=a.find(".thrDropdownTreeview"),c=c.length?thrUI.dropdownTreeview.getValue(c):void 0,d=thrUI.getTempData(a,"fnCallback");c?thrDatastore.getResource("files/"+c,function(a){d&&d($.extend(a,b))}):(c={metaRevs:[{pos:0,
undo:!1}],objs:thrDatastore.objTypes.map(function(a){var b={type:a.name,id:1,revisions:[],sessionRevs:[]};a.initialData&&b.revisions.push({pos:0,revData:JSON.stringify($.extend({id:1},a.initialData))});return b})},d($.extend(c,b)));thrUI.dialog.close(a)},getTemplatesData:function(a){var b=thr0.strToPojo(sessionStorage.thrTemplatesList);b?a(b):thrDatastore.getResource("files/templatelist.json",function(b){sessionStorage.thrTemplatesList=JSON.stringify(b);a(b)})},getName:function(a){a=a.find("input[name\x3d'name']").val();
""===a&&(a="New");/.sankey+$/.test(a)||(a+=".sankey");return a}};thrUI.fileManageDialog={show:function(a,b,c,d,e){var f=thrDatastore.ntx,g=[f.open,f.rename,f.move,f.copy,f.download,thrUI.ntx.del].map(function(a){return _h.btn(a)});a=thrUI.dialog.create(a,2);var h=a.find(".thrDlgBody");thrUI.setTempData(a,{fcl:b,fmoCallback:c,fmrCallback:d,fmdCallback:e});thrDatastore.createFileTabpanel(h,a,1,!0,!1,!0,f.copyFromGDrive,116,function(a){thrUI.fileManageDialog.gdriveclick($(a.target))});h.next().find("\x3etbody\x3etr\x3etd:first-child").append(g.join("")).click(function(a){thrUI.fileManageDialog.cmdClick(a)});
thrUI.dialog.center(a.find(".thrDialog"));a.find(".thrDialog").change(function(a){thrUI.fileManageDialog.change(a)})},change:function(a){var b=$(a.currentTarget).parent();a.stopPropagation();0<=[thrUI.ntx.close,thrUI.ntx.cancel].indexOf(a.dlgCmd)?thrUI.dialog.close(b):$(a.target).is(".thrPublished")||b.find(".thrButtonLine\x3etbody\x3etr\x3etd:first-child\x3e.thrButton").click()},fillFolderLists:function(a,b,c,d,e,f){var g,h,i,j=!f||"ib:"===f.substring(0,3);f&&(f=j?thrDatastore.ntx.localDB+"/"+f.substring(3):
thrDatastore.ntx.cloudDB+"/"+f);thrUI.tabpanel.create(c.addClass("thrDlgResult").data("prop","treeNo"));thrUI.tabpanel.activateTabNo(c,j?0:1);b.find(".thrFolderList").each(function(){g=$(this).parent().index();h=thrUI.getTempData(a,g?"folderTreeCloud":"folderTreeDB");i=c.find("\x3ediv\x3ediv:nth-child("+(g+1)+")").css("height","150px").addClass("thrDlgResult").data("prop","fldr"+g);thrUI.listbox.create(i);d.push(h.getPathList(g?thrDatastore.ntx.cloudDB:thrDatastore.ntx.localDB));thrUI.listbox.setOptions(i,
d[d.length-1]);g===(j?0:1)?(g=d[g].indexOf(f),0>g&&(g=0)):g=0;thrUI.listbox.fill(i,g);i.change(function(a){a.stopPropagation()})});b.find("\x3ediv\x3ediv:nth-child(2) .thrFolderList").length||b.find("\x3ediv\x3ediv:nth-child(2)\x3ediv").clone().appendTo(c.find("\x3ediv\x3ediv:nth-child(2)")).css("padding","30px 0");e||c.find("\x3eul\x3eli:last-child").addClass("thrNoDisplay")},cmdClick:function(a){var b,c,d,e,f,g=[];f=$(a.target);var h=$(a.currentTarget).closest(".thrDlgBack"),i=h.find(".thrTabpanel\x3ediv\x3ediv:not(.thrNoDisplay)");
c=i.index();var j=f.is(".thrButton")?f.index():-1;thr0.breakEvent(a);e=(d=2>c?thrUI.getTempData(h,c?"folderTreeCloud":"folderTreeDB"):void 0)?d.findItem(thrUI.folderList.getValue(i.find(".thrFolderList"))):void 0;if(3===c){if(0<=j){var k=i.find(".thrListbox\x3e.thrSelected"),l=k.data("uuid");l&&0===j?o.open(k.data("url")||thr0.makeUrl("public/"+encodeURI(l)),"_blank"):l&&5===j?(c=thrDatastore.ntx.unpublish,thrUI.dialog.show(c,function(){thrDatastore.unpublish(l,function(){k.remove()})},[c,thrUI.ntx.cancel],
"\x3cdiv class\x3d'thrDlgText'\x3e\x3cstrong\x3e"+k.text()+"\x3c/strong\x3e\x3cp\x3e"+thrDatastore.ntx.confirmUnpublish+"\x3c/p\x3e\x3c/div\x3e")):thrUI.dialog.show(f.text(),0,0,"\x3cdiv\x3e"+f.text()+" "+thrDatastore.ntx.notAvailFor+" '"+k.text()+"'.\x3c/div\x3e")}}else if(e)switch(j){case 0:a=thrUI.getTempData(h,"fmoCallback");thrUI.dialog.close(h);a&&a(e.uuid);break;case 1:c=thrDatastore.ntx.rename;thrUI.dialog.show(c,function(a){thrUI.fileManageDialog.renameFile(h,i,e,a.name)},[c,thrUI.ntx.cancel],
"\x3cdiv class\x3d'thrDlgText'\x3e"+c+" '"+e.name+"'\x3c/div\x3e\x3cdiv\x3e"+thrDatastore.ntx.newName+": \x3cinput class\x3d'thrDlgResult' data-prop\x3d'name' type\x3d'text' size\x3d30 value\x3d'"+e.name+"' /\x3e\x3c/div\x3e");break;case 2:c=thrDatastore.ntx.move;b=thrUI.dialog.show(c,function(a){j=a["fldr"+a.treeNo];void 0!==j&&thrUI.fileManageDialog.moveFile(h,i,e,d,g[a.treeNo][j])},[c,thrUI.ntx.cancel],"\x3cdiv class\x3d'thrDlgText'\x3e"+c+" '"+e.name+"' "+thrDatastore.ntx.toFolder+":\x3c/div\x3e"+
thrDatastore.fileTabpanelHtml(400));this.fillFolderLists(h,i.closest(".thrTabpanel"),b.find(".thrTabpanel"),g,!1);thrUI.dialog.center(b);break;case 3:c=thrDatastore.ntx.copy;a=thr0.getUserInfo();f=thrUI.getTempData(h,"fcl");if(a.fileCount>=f){thrUI.dialog.checkShowCreateRestriction("diagrams",a.fileCount,f);break}b=thrUI.dialog.show(c,function(a){2>a.treeNo?thrUI.fileManageDialog.copyFile(h,e,a.name,g[a.treeNo][a["fldr"+a.treeNo]]):thr0.isLicensed("cloudStore")&&(e.path="gd:"+(a.gdFolderId||""),a.gdFolder?
thrUI.fileManageDialog.copyFileToGd(e):thrDatastore.getOAuthToken(function(){thrUI.fileManageDialog.copyFileToGd(e)}))},[c,thrUI.ntx.cancel],"\x3cdiv\x3e"+thrDatastore.ntx.newName+": \x3cinput class\x3d'thrDlgResult' data-prop\x3d'name' type\x3d'text' size\x3d30 value\x3d'"+thrDatastore.ntx.copyOf+" "+e.name+"' /\x3e\x3c/div\x3e\x3cdiv class\x3d'thrDlgText' style\x3d'margin:10px 0;'\x3e"+thrDatastore.ntx.copyToFolder+":\x3c/div\x3e"+thrDatastore.fileTabpanelHtml(400));this.fillFolderLists(h,i.closest(".thrTabpanel"),
b.find(".thrTabpanel"),g,!0,(":"===e.uuid.charAt(2)?e.uuid.substring(0,3):"")+e.path);c=$("\x3cdiv class\x3d'thrLine' style\x3d'margin:30px 0;'\x3e\x3c/div\x3e").appendTo(b.find(".thrTabpanel\x3ediv\x3ediv:last-child"));thrUI.initGDrive();thrUI.$GPickerButton(thrDatastore.ntx.selGdFolder,thr0.isLicensed("cloudStore")).appendTo(c).click(function(){thrUI.selGdFolderClick(b,thrDatastore.ntx.selFolder+" '"+e.name+"'")});thrUI.dialog.center(b);thrUI.dialog.checkShowCreateRestriction("diagrams",a.fileCount,
f);break;case 4:thrUI.message.show(thrDatastore.ntx.downloadMsg,!0,3E3);thrDatastore.downloadFile(e.uuid,e.name);break;case 5:c=thrUI.ntx.del,thrUI.dialog.show(c,function(){thrUI.fileManageDialog.deleteFile(h,i,e,d)},[c,thrUI.ntx.cancel],"\x3cdiv class\x3d'thrDlgText'\x3e'"+e.name+"' "+thrDatastore.ntx.confirmDel+"\x3c/div\x3e")}else 0<=j&&thrUI.dialog.show(f.text(),0,0,"\x3cdiv\x3e"+thrDatastore.ntx.selectFileHint+" '"+f.text()+"'.\x3c/div\x3e")},renameFile:function(a,b,c,d){a=thrUI.getTempData(a,
"fmrCallback");c.name=d+(/.sankey+$/.test(d)?"":".sankey");this.refreshFolderList(b);thrDatastore.renameFile(c,c.name);a&&a(c.uuid,c.name)},copyFile:function(a,b,c,d){var e=d.split("/"),f=e.shift()===thrDatastore.ntx.localDB;d=$.extend(!0,{},b);var g=thrUI.getTempData(a,"fmrCallback");/.sankey+$/.test(c)||(c+=".sankey");d.name=c;d.path=(f?"ib:":"")+e.join("/");thrDatastore.copyTo(d,thr0.generateThrID(b.userId),function(b){b&&(thr0.notifyUserCreatedFile(),thrUI.getTempData(a,f?"folderTreeDB":"folderTreeCloud").add(e,
b),e.push(-1),thrUI.folderList.fill(a.find(".thrTabpanel\x3ediv\x3ediv:nth-child("+(f?1:2)+") .thrFolderList"),e),thrUI.tabpanel.activateTabNo(a.find(".thrTabpanel"),f?0:1),g&&g(b.uuid,b.name))})},copyFileToGd:function(a){thrDatastore.copyTo(a,void 0,function(b){thrUI.fileManageDialog.showFeedback(b,a.name)})},moveFile:function(a,b,c,d,e){function f(a,b,c,e,f){d.deleteItem(c);c.path=(f?"ib:":"")+e.join("/");d=thrUI.getTempData(a,f?"folderTreeDB":"folderTreeCloud");d.add(e,c);e.push(-1);b.index()!==
(f?0:1)&&thrUI.fileManageDialog.refreshFolderList(b);thrUI.folderList.fill(a.find(".thrTabpanel\x3ediv\x3ediv:nth-child("+(f?1:2)+") .thrFolderList"),e);thrUI.tabpanel.activateTabNo(a.find(".thrTabpanel"),f?0:1);thrDatastore.moveFile(c,c.path)}var g=e.split("/");e=0===c.uuid.indexOf("ib:");var h=g.shift()===thrDatastore.ntx.localDB;e===h?f(a,b,c,g,h):thrUI.dialog.show(thrDatastore.ntx.move+" "+c.name,function(){f(a,b,c,g,h)},[thrDatastore.ntx.move,thrUI.ntx.cancel],"\x3cdiv class\x3d'thrDlgText'\x3e"+
thrDatastore.ntx.delHistoryHint+"\x3c/div\x3e")},deleteFile:function(a,b,c,d){a=thrUI.getTempData(a,"fmdCallback");d.deleteItem(c);this.refreshFolderList(b);thrDatastore.deleteFile(c);a&&a(c.uuid)},refreshFolderList:function(a){var b=thrUI.path.getValue(a.find(".thrPath"));b.push(-1);thrUI.folderList.fill(a.find(".thrFolderList"),b)},gdriveclick:function(a){var b=thr0.getUserInfo(),c=a.closest(".thrDlgBack");a=thrUI.getTempData(c,"fcl");b.fileCount>=a?thrUI.dialog.checkShowCreateRestriction("diagrams",
b.fileCount,a):thrDatastore.getOAuthToken(function(a){thrUI.gPicker.create(a,thrDatastore.ntx.selFileCopy,function(a){thrUI.fileManageDialog.gpickerCallback(c,a)})})},showFeedback:function(a,b){a?(thrUI.dialog.show(thrDatastore.ntx.copyFile,0,0,thrDatastore.ntx.copySuccess+" '"+b+"'."),thr0.notifyUserCreatedFile()):thrUI.dialog.show(thrDatastore.ntx.error,0,0,thrDatastore.ntx.copyFail)},gpickerCallback:function(a,b){if(b[google.picker.Response.ACTION]===google.picker.Action.PICKED)if(1!==b[google.picker.Response.DOCUMENTS].length)thrUI.fileManageDialog.showFeedback(!1);
else{var c=[],d="gd:"+b[google.picker.Response.DOCUMENTS][0][google.picker.Document.ID],e=b[google.picker.Response.DOCUMENTS][0][google.picker.Document.NAME],e=thrUI.dialog.show("Copy '"+e+"'",function(b){var e=b["fldr"+b.treeNo];void 0!==e&&thrUI.fileManageDialog.copyFromGdrive(a,d,b.name,c[b.treeNo][e])},[thrDatastore.ntx.copy,thrUI.ntx.cancel],"\x3cdiv\x3e"+thrDatastore.ntx.newName+": \x3cinput class\x3d'thrDlgResult' data-prop\x3d'name' type\x3d'text' size\x3d30 value\x3d'"+thrDatastore.ntx.copyOf+
" "+e+"' /\x3e\x3c/div\x3e\x3cdiv class\x3d'thrDlgText' style\x3d'margin:10px 0;'\x3e"+thrDatastore.ntx.copyToFolder+":\x3c/div\x3e"+thrDatastore.fileTabpanelHtml(400));this.fillFolderLists(a,a.find("\x3e.thrDialog\x3e.thrDlgBody\x3e.thrTabpanel"),e.find(".thrTabpanel"),c,!1);thrUI.dialog.center(e)}},copyFromGdrive:function(a,b,c,d){var e,f=d.split("/"),g=f.shift()===thrDatastore.ntx.localDB;thrUI.hourglass.show(a);thrDatastore.copyTo({uuid:b,name:c,path:(g?"ib:":"")+f.join("/")},thr0.generateThrID(thr0.getUserInfo().id),
function(b){thrUI.hourglass.hide(a);b?(e=thrUI.getTempData(a,g?"folderTreeDB":"folderTreeCloud"),e.add(f,b),f.push(-1),thrUI.folderList.fill(a.find(".thrTabpanel\x3ediv\x3ediv:nth-child("+(g?1:2)+") .thrFolderList"),f),thrUI.tabpanel.activateTabNo(a.find(".thrTabpanel"),g?0:1),thrUI.fileManageDialog.showFeedback(!0,b.name)):thrUI.fileManageDialog.showFeedback(!1)})}};thrUI.fileShareDialog={show:function(a,b,c){c=$.extend(!0,{},c);a=thrUI.dialog.create(a,1,_h.table(void 0,[],{style:"width: 100%; margin: 10px 0 50px 0;"}));
a.data("uuid",b).find(".thrDialog").change(function(a){thrUI.fileShareDialog.change(a)}).find(".thrDlgBody\x3etable").click(function(a){thrUI.fileShareDialog.tblClick(a)});thrUI.setTempData(a,"shareInfos",c);$(_h.iconBtn(45,{"data-cmd":"add",style:"margin: 0;"})).appendTo(a.find(".thrDlgButtons\x3etbody\x3etr\x3etd:first-child")).click(function(a){thrUI.fileShareDialog.addClick(a)});this.refresh(a,c)},change:function(a){var b=$(a.currentTarget).parent();a.stopPropagation();"userRight"===a.prop?(thrUI.getTempData(b,
"shareInfos").accessInfos[$(a.target).closest("tr").index()].userRight=a.value,b.data("changed",1)):(0<=[thrUI.ntx.close,thrUI.ntx.ok].indexOf(a.dlgCmd)&&b.data("changed")&&thrDatastore.changeShareInfos(b.data("uuid"),thrUI.getTempData(b,"shareInfos")),thrUI.dialog.close(b))},tblClick:function(a){var b=$(a.target);thr0.breakEvent(a);if(b.hasClass("thrDelButton")){a=$(a.currentTarget).closest(".thrDlgBack");var c=thrUI.getTempData(a,"shareInfos");c.accessInfos.splice(b.closest("tr").index(),1);this.refresh(a,
c,!0)}},addClick:function(a){var b=this,c=$(a.target).closest(".thrDlgBack"),d=thrDatastore.ntx;thrUI.dialog.showValueQuestion(d.shareFile,function(a){a&&a.val&&thr0.ajax("GET","accountsvc/dispname?usermail\x3d"+encodeURIComponent(a.val.toLowerCase())).done(function(a){var d=thrUI.getTempData(c,"shareInfos");0>thr0.indexOfKey(d.accessInfos,"userId",a.id)&&(d.accessInfos.push({userId:a.id,dispName:thr0.getUserDispname(a),userRight:1}),b.refresh(c,d,!0),c.find(".thrDlgBody\x3etable\x3etbody\x3etr:last-child\x3etd\x3e.thrDropdownSelect").focus())}).fail(function(){thrUI.dialog.show(d.unknownUser,
0,0,d.noUserFound+" '"+a.val+"'!")})},void 0,d.emailAddress,"")},refresh:function(a,b,c){c&&a.data("changed",1);thrUI.initControls(a.find(".thrDlgBody\x3etable\x3etbody").html(b.accessInfos.map(function(a){var b=[a.userRight?thrUI.ihtml("dropdownSelect",{prop:"userRight",options:[thrDatastore.ntx.canEdit,thrDatastore.ntx.canView],values:[1,2],value:a.userRight}):thrDatastore.ntx.isOwner,{width:"110px"}],c=[a.userRight?_h.delBtn():"",{width:"24px"}];return _h.tableRow([a.dispName,b,c])}).join("")));
thrUI.dialog.center(a.find(".thrDialog"))}};o.sfsEditorMC={canDeletePt:function(a,b,c,d){c={removeFromEq:[{qp:[sfsIdPrefix.connection+c.id],p:this.getPtPath(a,b,c,d)}]};return a.canChangeStructure(b,c)},canConnect:function(a,b,c,d){var e=sfsIdPrefix.connection,f=c instanceof SfsConnection,g=d instanceof SfsConnection,h={};if(!f&&(!c||!c.calcType)||!g&&(!d||!d.calcType))return!0;f||g?(g=f?c:d,c=f?d:c,h.addToEq=[{qp:[e+g.id],p:this.getSimPtPath(g,c,1),fix:c.isFix()}]):h.addEq=[{qp:[e+"New"],pList:[this.getSimPtPath(void 0,
c,"o"),this.getSimPtPath(void 0,d,"i")],fixList:[c.isFix(),d.isFix()]}];return a.canChangeStructure(b,h)},canChangeConnection:function(a,b,c,d,e){var f=sfsIdPrefix.connection,g=sfsIdPrefix.item,h=a.mc.mathEnv,i=this.getPtPath(h,b,c,d),j=c.points[d].itemId;a=j?a.diagram.getItem(j):void 0;j=this.getSimPtPath(c,e,"io");c={removeFromEq:[{qp:[f+c.id],p:i}],addToEq:[{qp:[f+c.id],p:j,fix:e?e.isFix():c.points[d].calcType}]};a&&a.isEquation()&&c.removeFromEq.push({qp:[g+a.id,g],p:i});e&&e.isEquation()&&c.addToEq.push({qp:[g+
e.id,g],p:j});return h.canChangeStructure(b,c)},isPortChangeAllowed:function(a,b,c,d){return"value"!==d.prop||c.every(function(a){return this.mEnv.canChange(this.ctx,[a.mathId(),2===a.calcType?sfsIdPrefix.scale:this.ptx])},{mEnv:a,ctx:b,ptx:d.rowid})},isConValChangeAllowed:function(a,b,c,d){return"value"!==d.prop||c.every(function(a){return this.mEnv.canChange(b,this.me.getPtPath(this.mEnv,this.ctx,a,this.ptx))},{me:this,mEnv:a,ctx:b,ptx:d.rowid})},isCalcTypeChangeAllowed:function(a,b,c,d){function e(a,
b){return b.map(function(b){return[a,b]})}var f={},g=[],h=1===d||5===d,i=2===d,j=3===d||4===d,k=sfsIdPrefix.input,l=sfsIdPrefix.output,m=RegExp("^("+sfsIdPrefix.input+"|"+sfsIdPrefix.output+")[0-9]{1,5}$");if(!d)return!0;d=c.map(function(a){return{o:a,p:a.mathId(),pIds:a.inputs.map(function(a){return k+a.port}).concat(a.outputs.map(function(a){return l+a.port}))}});d.forEach(function(a){if((1===a.o.calcType||5===a.o.calcType)!==h)g=g.concat(e(a.p,a.pIds))});h?f.fix=g:f.unfix=g;g=[];c.forEach(function(a){2===
a.calcType!==i&&g.push({ctx:[a.mathId()],p:sfsIdPrefix.scale,regExp:m})});i?f.addMultiplier=g:f.removeMultiplier=g;g=[];d.forEach(function(a){(3===a.o.calcType||4===a.o.calcType)!==j&&g.push({qp:[a.o.mathId(),this],pList:e(a.p,a.pIds)})},sfsIdPrefix.item);j?f.addEq=g:f.removeEq=g;return a.canChangeStructure(b,f)},isConCalcTypeChangeAllowed:function(a,b,c,d,e){return!e||a.canChangeStructure(b,{fix:[[sfsIdPrefix.connection+c.id,sfsIdPrefix.conPoint+c.points[d].id]]})},getPtPath:function(a,b,c,d){d=
c.points[d];void 0!==d.itemId?(c=[sfsIdPrefix.item+d.itemId,sfsIdPrefix.scale],a.isSet(b,c)||(c[1]=sfsIdPrefix.io(1===d.way)+d.port)):c=[sfsIdPrefix.connection+c.id,sfsIdPrefix.conPoint+d.id];return c},getSimPtPath:function(a,b,c){return b?[b.mathId(),2===b.calcType?sfsIdPrefix.scale:c+"New"]:[sfsIdPrefix.connection+(a?a.id:"New"),sfsIdPrefix.conPoint+"New"]},getConPtInfos:function(a,b,c){var d=a.getEquationInfos(b,sfsIdPrefix.connection+c.id);c.points.forEach(function(e,f){2>e.way&&$.extend(d[thr0.indexOfArrayPropInArray(d,
"p",this.getPtPath(a,b,c,f))],{way:e.way?"sink":"source",ptx:f,pt:e,unit:e.unit||c.unit})},this);return d},getDiffAttachCon:function(a,b,c,d,e,f,g){var h={id:b.id},i=f.points[g],j=b.ios(c),k=j.length&&void 0!==j[0].ord;d={port:thr0.maxOfArray(j,"port",0)+1,val:d/(b.sc||1),unit:e};6===b.calcType&&(d.calcType=0);i.port=d.port;i.itemId=b.id;h[c?"inputs":"outputs"]=[d];k&&(c?(d.ord=0,j.forEach(function(a){h.inputs.push({port:a.port,ord:a.ord+1})})):d.ord=thr0.maxOfArray(j,"ord",0));if(c?b.combiIn:b.combiOut)j=
!f.stretches,k=c?"combiInfoIn":"combiInfoOut",j&&(f.stretches=$.extend(!0,[],a.diagram.getConnection(f.id).stretches)),b[k]?(c=JSON.parse(b[k]),c.pt=b.absolutePt(c.pt),$.extend(i,c.pt),j=!this.combiConDiff(a.diagram,new SfsConnection(f),g,c.dir,c.pt,f)&&j):(i={con:new SfsConnection(f),pt:i,ptx:g},c=this.getAssociatedCombiLine(a,b,[i],c,!0),h[k]=JSON.stringify({pt:b.relativePt(c.pt),dir:c.dir,ptDir:c.dir}),j=!this.combiConDiff(a.diagram,i.con,g,c.dir,c.pt,f)&&j),j&&delete f.stretches;return h},getDiffDetachCon:function(a,
b,c){var d=b?"inputs":"outputs";if(0<=thr0.indexOfKey(a[d],"port",c)){var e={id:a.id};b=b?"combiInfoIn":"combiInfoOut";e[d]=[{delIds:[c]}];1>=a[d].length&&a[b]&&(e[b]="_DELETE_");return e}},getDiffDetachCons:function(a,b,c){var d;b.forEach(function(b){b.points.forEach(function(b){b.itemId===a.id&&(b=this.getDiffDetachCon(a,1===b.way,b.port),d=d?c.merge([d,b]):b)},this)},this);return d},applyDelete:function(a,b,c){var d,e,f,g,h,i,j=a.mc,k=a.diagram;if(!b.length||b[0]instanceof SfsDiagram)return!1;
if(b[0]instanceof SfsLegend)return j.applyDiff(k.objSpec(),{legend:{visible:!1}});if(1===b.length&&(b[0]instanceof SfsConnection&&c)&&(g=c.slice(0,3),0<=SfsConnection.prototype.tagTypes.indexOf(g))){this.applyDeleteTag(j,k,b[0],parseInt(c.slice(3),10),g);return}j.startTransaction();c=thr0.filterArrayByType(b,SfsItem).map(function(a){return a.id});g=thr0.filterArrayByType(b,SfsConnection);i=g.map(function(a){return a.id});for(b=k.connections.length-1;0<=b;b--)if(h=k.connections[b],0>i.indexOf(h.id))if(h.allItemsIncluded(c,
!0,!0))g.push(h),i.push(h.id);else if(h.connectsAnItem(c)){f=k.connections.length;for(d=0;d<c.length&&f===k.connections.length;d++)e=thr0.indexOfKey(h.points,"itemId",c[d]),0<=e&&(this.canDeletePt(j.mathEnv,[sfsIdPrefix.prefixedId(k)],h,e)?this.applyDeleteConPt(j,k,h,e):this.applyMoveConPt(a,h,h.points[e],e,-1,void 0,!1))}if(0<c.length||0<g.length){a={};0<c.length&&(a.items=[{delIds:c}]);if(0<g.length){a.connections=[{delIds:i}];for(b=k.items.length-1;0<=b;b--)if(0>c.indexOf(k.items[b].id)&&(i=this.getDiffDetachCons(k.items[b],
g,thrRevisioning.diffOp)))a.items||(a.items=[]),a.items.push(i)}j.applyDiff(k.objSpec(),a)}j.endTransaction()},applyAddItem:function(a,b,c){function d(a,b){thr0.setXY(b,Math.max(0,Math.min(a.width-b.width,b.x)),Math.max(0,Math.min(a.height-b.height,b.y)))}function e(a,b,c,d){var f=b.points.length;b.points.push($.extend({},a.points[c]));for(var g=a.stretches.length-1;0<=g;g--)if(g!==d){var h=a.stretches[g];h.a===c?b.stretches.push({a:f,b:e(a,b,h.b,g)}):h.b===c&&b.stretches.push({a:e(a,b,h.a,g),b:f})}return f}
var f={},g=a.diagram,h=g.defaultItem?JSON.parse(JSON.stringify(g.defaultItem)):{};b&&(b.shape&&h.avoidNoLine)&&delete h.avoidNoLine;(b.shape||b.hiddenShape)&&h.shape&&delete h.shape;h.shape&&(h.shape.spec&&"sankey"===h.shape.spec.cmd)&&(h.combiIn=!0,h.combiOut=!0);h=$.extend(!0,h,b);h.id=g.newItemId();b=new SfsItem(h);d(g,b);if(c){var i,j,k,l,m,n,p=c.con.stretches[c.stx];n=c.con.points[p.a];var t=c.con.points[p.b],o={id:c.con.id,points:[],stretches:[]};m=c.con.getStretchValues(a.mc.mathEnv,g);var s=
$.extend(c.con.getFormat(),{id:g.newConId(),unit:c.con.unit,points:[],stretches:[]});i=b.getCenter();var q=thr0.closestLinePt(i,c.l),z=thr0.lineAngle(c.l);thr0.addXY(b,q);thr0.addXY(b,i,-1);b.combiIn=!1;b.combiOut=!1;if(h.shape&&h.shape.bounds&&h.shape.bounds.hasOwnProperty("orientation")){var w=thr0.normalizeAngle(h.shape.bounds.orientation-z);80<=w&&260>w&&(w=thr0.normalizeAngle(h.shape.bounds.orientation-thr0.reverseAngle(z)));0!==w&&(b.rot=w)}d(g,b);h=thr0.expandedFrame(b.getFrame(a),i,a);if((i=
b.getConPts(h,a))&&i.length)if(j=i.filter(function(a){return void 0!==a.std}),k=thr0.closestPt(n,j.length?j:i),k={x:k.x,y:k.y,dir:void 0!==k.dir?k.dir:thr0.reverseAngle(z)},l=thr0.closestPt(t,j.length?j:i),l={x:l.x,y:l.y,dir:void 0!==l.dir?l.dir:z},i=thr0.centeredPt([k,l]),i.x!==q.x||i.y!==q.y)w=thr0.deltaVec(i,q),thr0.addXY(b,w),thr0.addXY(k,w),thr0.addXY(l,w),j.length||(h=thr0.expandedFrame(b.getFrame(a),i,g.snapBoxBorder));if(!j||!j.length){if((j=thr0.cutFrameLine(q,thr0.reverseAngle(z),h))&&(!k||
thr0.distance(k,n)>thr0.distance(n,j.pt)+10))k=$.extend({dir:j.dir},j.pt);if((j=thr0.cutFrameLine(q,z,h))&&(!l||thr0.distance(l,t)>thr0.distance(t,j.pt)+10))l=$.extend({dir:j.dir},j.pt)}j=c.con.unit;n=m[c.stx]/thrUnits.getFactor(j);m=e(c.con,o,p.a,c.stx);o.stretches.push({a:m,b:o.points.length});o.points.push($.extend(k,{way:1,itemId:b.id,port:1}));b.inputs.push({port:1,val:n,unit:j});m=e(c.con,s,p.b,c.stx);s.stretches.push({a:s.points.length,b:m});s.points.push($.extend(l,{way:0,itemId:b.id,port:1}));
b.outputs.push({port:1,val:n,unit:j});f.connections=[o,s];f.nextConId=s.id+1}b.z=g.getMaxZindex()+1;f.nextItemId=b.id+1;f.items=[JSON.parse(JSON.stringify(b))];c&&(f.connections[1].z=b.z+1);a.mc.applyDiff(g.objSpec(),f);return b.id},applyAddConnection:function(a,b,c,d,e,f,g,h){var i=a.diagram,j={connections:[],items:[]};h=thr0.splitNumberUnit(h);h=h[0]/(""===h[1]?1:thrUnits.getFactor(h[1])||1);if(b instanceof SfsConnection||e instanceof SfsConnection){var k=b instanceof SfsConnection,l=k?e:b,m=k?
c:f;f=k?d:g;var n=k?{x:g.x,y:g.y,way:1,dir:g.dir}:{x:d.x,y:d.y,way:0,dir:d.dir};c=k?b:e;b={id:c.id,points:$.extend(!0,[],c.points),stretches:$.extend(!0,[],c.stretches)};e=b.stretches[m];g=thr0.angle(d,g);thr0.significantAngleDelta(g,thr0.angle(b.points[e.a],b.points[e.b]))||$.extend(n,thr0.movedPt(n,thr0.verticalAngle(g),20));j.connections.push(b);g=b.points.length;b.points.push({x:f.x,y:f.y,way:2});b.stretches.push({a:e.a,b:g});e.a=g;b.points.push(n);b.stretches.push({a:k?g:g+1,b:k?g+1:g});l?j.items.push(this.getDiffAttachCon(a,
l,k,h,c.unit,b,g+1)):(n.val=h,n.id=c.points.reduce(function(a,b){return Math.max(a,b.id||0)},0)+1)}else k={x:d.x,y:d.y,way:0,dir:d.dir},g={x:g.x,y:g.y,way:1,dir:g.dir},c=JSON.parse(JSON.stringify(new SfsConnection($.extend(!0,i.defaultCon?JSON.parse(JSON.stringify(i.defaultCon)):{},{id:i.newConId(),z:i.getMaxZindex()+1,unit:i.dispUnit})))),j.connections.push(c),j.nextConId=c.id+1,c.points.push(k),c.points.push(g),c.stretches.push({a:0,b:1}),b?j.items.push(this.getDiffAttachCon(a,b,!1,h,c.unit,c,0)):
(k.val=h,k.id=1),e?j.items.push(this.getDiffAttachCon(a,e,!0,h,c.unit,c,1)):(g.val=h,g.id=b?1:2);a.mc.applyDiff(i.objSpec(),j);return c.id},getCombiInfo:function(a,b,c,d,e){var f,g,h,i=-1,j=$.extend(!0,{},b.points[c]);d&&void 0!==d.itemId&&(j.itemId=0>d.itemId?void 0:d.itemId);if(void 0!==j.itemId){f=a.getItem(j.itemId);g=1===j.way;if(f&&!(g?f.combiIn:f.combiOut))return;i=c;h=b.otherStPt(b.nextPtStx(c),i)}else{h=c;for(var k=b.nextPtStx(c);0<=k;k=b.nextPtStx(c,k+1))if(i=b.otherStPt(k,c),j=b.points[i],
void 0!==j.itemId){f=a.getItem(j.itemId);g=1===j.way;if(f&&(g?f.combiIn:f.combiOut))break;f=void 0}}if(f)return a=b.points[h],!e&&d&&(c===i?j=thr0.movedPtDelta(j,d):a=thr0.movedPtDelta(a,d)),{item:f,isInput:g,con:b,isItemPoint:c===i,angle:thr0.round100(thr0.angle(j,a)),delta:d,itemPt:j}},addCombiSyncDiff:function(a,b,c,d,e){if(b&&(b.delta.x||b.delta.y)&&void 0===b.delta.itemId){var f=b.item.getCenter();a=a.getItemConPoints(b.item.id,b.isInput);var g=a.length/2;a.forEach(function(a){a.ord=thr0.normalizeAngle(thr0.angle(f,
a.pt)+180-d)});a.sort(function(a,b){return a.ord-b.ord}).forEach(function(a,d){var f=a.con,k=a.ptx,l=f.otherStPt(f.nextPtStx(k),k),m=b.con.id===f.id,n=m?thr0.arrayObjByKey(e.connections,"id",f.id):{id:f.id,points:$.extend(!0,[],f.points)},p=n.points[k];b.isItemPoint&&$.extend(p,thr0.movedPt(c,b.angle-90,5*(g-d)));(b.isItemPoint||!m)&&$.extend(n.points[l],thr0.movedPt(p,b.angle,thr0.distance(f.points[k],n.points[l])));m||e.connections.push(n)})}},applyMoveConPt:function(a,b,c,d,e,f,g,h,i){function j(a,
b){var c=b.stretches.map(function(a,b){return $.extend({stx:b},a)}).filter(function(b){return b.a===a||b.b===a});if(2===c.length&&3>Math.abs(thr0.angle(b.points[c[0].a],b.points[c[0].b])-thr0.angle(b.points[c[1].a],b.points[c[1].b]))){var d=c[0],c=b.stretches[c[1].stx],e=d.a===a?d.b:d.a;c.a===a?c.a=e:c.b=e;b.points.splice(a,1);b.stretches.splice(d.stx,1);b.stretches.forEach(function(b){b.a>a&&b.a--;b.b>a&&b.b--});return!0}}var k,l,m,n,p=b.points[d],o=(f||void 0!==p.itemId)&&(!f||void 0===p.itemId||
f.id!==p.itemId),r=a.mc,s=a.diagram,q=[],z=[],w={},u={connections:[w],items:[]};2>p.way&&(e=void 0);if(k=b.findPathToStretch(d,void 0,e))for(var v=0;v<k.ptx.length;v++)if(z.push(k.stx[v]),3>b.countPtStretches(k.ptx[v]))q.push(k.ptx[v]);else break;if(o||q.length||c.x!==p.x||c.y!==p.y){w.id=b.id;w.points=$.extend(!0,[],b.points);p=w.points[d];m=thr0.deltaVec(p,c);o&&(m.itemId=f?f.id:-1);thr0.setXY(p,thr0.round100(c.x),thr0.round100(c.y));void 0!==c.dir?p.dir=c.dir:void 0!==p.dir&&delete p.dir;h&&h.forEach(function(a){w.points[a.ptx][a.dim]=
p[a.dim]});if(g||q.length||z.length)w.id=b.id,w.stretches=[],b.stretches.forEach(function(a,b){if(0>z.indexOf(b)){var c=b===e,f=w.stretches,g=$.extend(!0,{},a);if(c&&0<k.ptx.length){var h=k.ptx.pop();g.a===h?(c=k.isConDir?{a:d,b:g.a}:{a:g.a,b:d},g.a=d):(c=k.isConDir?{a:g.b,b:d}:{a:d,b:g.b},g.b=d);0>q.indexOf(h)&&(c.a=r.getChangedPtx(c.a,q),c.b=r.getChangedPtx(c.b,q),f.push(c))}g.a=r.getChangedPtx(g.a,q);g.b=r.getChangedPtx(g.b,q);f.push(g)}}),z.length&&(c=b.stretches[z[z.length-1]],(0<=q.indexOf(c.a)||
!j(r.getChangedPtx(c.a,q),w))&&0>q.indexOf(c.b)&&j(r.getChangedPtx(c.b,q),w));if(o){c=b.getPointValue(r.mathEnv,s,b.points[d]);g=b.getPointUnit(s,b.points[d]);if(void 0!==p.itemId){var x=s.getItem(p.itemId);if(v=this.getDiffDetachCon(x,1===p.way,p.port))x=thr0.arrayObjByKey(x.ios(1===p.way),"port",p.port),u.items.push(v),x&&(n=x.vt)}f?(p.vt&&(n=p.vt,delete p.vt),void 0!==p.val&&delete p.val,void 0!==p.unit&&delete p.unit,void 0!==p.id&&delete p.id,l=this.getDiffAttachCon(a,f,1===p.way,c,g,w,d),u.items.push(l),
n&&((l.inputs||l.outputs)[0].vt=n)):(delete p.itemId,delete p.port,p.id=thr0.maxOfArray(b.points,"id",0)+1,p.val=c,p.unit=g,n&&(p.vt=n))}q.length&&(w.points=w.points.filter(function(a,b){return 0>q.indexOf(b)}))}if(!$.isEmptyObject(w)){if(b=o?void 0:this.getCombiInfo(s,b,d,m,h))f=b.isInput?"combiInfoIn":"combiInfoOut",h=b.item,n=h.hasOwnProperty(f)?JSON.parse(h[f]):{pt:h.relativePt(i),dir:b.angle,ptDir:b.angle},m=n.ptDir,b.isItemPoint?(a=thr0.associatedFrameLine(i,h.getCenter(),h.getFrame(a)),n={pt:h.relativePt(i),
dir:b.angle,ptDir:thr0.round100(a.dir)}):n.dir=b.angle,l||(l={id:h.id},u.items.push(l)),l[f]=JSON.stringify(n),this.addCombiSyncDiff(s,b,i,m,u);return r.applyDiff(s.objSpec(),u)}},applyDeleteConPt:function(a,b,c,d,e){var f,g,h;h=!1;var i=d,j=[],k=[],l={id:c.id,points:[],stretches:[]};if(e)f=c.nextPtStx(d),i=c.otherStPt(f,d),j.push(d),k.push(f);else if(2>c.points[d].way)if(1===c.countWayPoints(c.points[d].way))h=!0;else{i=d;f=-1;do h=c.nextPtStx(i),j.push(i),h===f&&(h=c.nextPtStx(i,h+1)),k.push(h),
i=c.otherStPt(h,i),f=h;while(2<=c.points[i].way&&2===c.countPtStretches(i));2>c.points[i].way&&j.push(i);h=j.length>=c.points.length}else f=2===c.countPtStretches(d)?c.nextPtStx(d,0):c.getShortestInnerStx(d),0<=f?(i=c.otherStPt(f,d),g={from:d,to:i},j.push(d),k.push(f)):h=!0;h?j=c.points.map(function(a,b){return b}):(c.points.forEach(function(f,g){if(0>j.indexOf(g)){var h=$.extend({},f);if(e&&g===i){var k=c.points[d];h.way=k.way;h.id=k.id||thr0.maxOfArray(c.points,"id",0)+1;h.val=c.getPointValue(a.mathEnv,
b,k);h.unit=c.getPointUnit(b,k);k.vt&&(h.vt=k.vt)}l.points.push(h)}}),c.stretches.forEach(function(b,c){if(0>k.indexOf(c)){var d=$.extend({},b);d.a=a.getChangedPtx(d.a,j,g);d.b=a.getChangedPtx(d.b,j,g);l.stretches.push(d)}}));h=j.map(function(a){a=c.points[a];if(void 0!==a.itemId)return this.getDiffDetachCon(b.getItem(a.itemId),1===a.way,a.port)},this).filter(function(a){return a});f={connections:[l.points.length?l:{delIds:[c.id]}]};h.length&&(f.items=h);a.applyDiff(b.objSpec(),f)},applyMovePropObj:function(a,
b,c,d){var e={};e[d]=thr0.movedPtDelta(b[d],c);a.applyDiff(b.objSpec(),e)},applyMoveConTag:function(a,b,c,d,e,f,g,h){var i,j,k,l,m;0<=e&&c.stretches.length>e&&(k=c.stretches[e][d],void 0!==k&&(l=c.getStretchLine(e),m=thr0.centeredPt(l),i=f.x-m.x-k.dx,j=f.y-m.y-k.dy,f=thr0.movedRect(f,g.x,g.y),m={x:f.x+f.width/2,y:f.y+f.height/2},l=c.stretches.reduce(function(a,b,e){if(b[d])return a;b=thr0.distanceToLine(m,c.getStretchLine(e));return b<a.d?{d:b,stx:e}:a},{d:thr0.distanceToLine(m,l),stx:e}).stx,g={id:c.id,
stretches:$.extend(!0,[],c.stretches)},k=g.stretches[e][d],e!==l&&(g.stretches[l][d]=k,delete g.stretches[e][d]),m=thr0.centeredPt(c.getStretchLine(l)),e=h(c,e,l),k.dx=thr0.round100(f.x-m.x-i+e.x),k.dy=thr0.round100(f.y-m.y-j+e.y),a.applyDiff(b.objSpec(),{connections:[g]})))},applyConPtChanges:function(a,b,c,d,e){var f=!1,g=$.extend(!0,[],c.points);void 0!==d&&(d=e[d].ptx,g.some(function(a,b){if(b===d&&a.adj)return!0;b===d?f=a.adj=!0:a.adj&&(delete a.adj,f=!0);return!1}));e.forEach(function(a){var b=
g[a.ptx];b.calcType!==a.calcType&&(f=!0);a.calcType?b.calcType=a.calcType:b.calcType&&delete b.calcType});f&&a.applyDiff(b.objSpec(),{connections:[{id:c.id,points:g}]})},getObjCopies:function(a,b,c){b=thr0.filterArrayByType(b,SfsItem);if(b.length){var d=[],e=[],f=[],g={items:[],connections:[],refVals:[]},h=a.mc.mathEnv,i=a.diagram;b.forEach(function(b){e.push(b.id);d.push([sfsIdPrefix.diagram+i.id,b.mathId()]);f.push(b.getBoundsRect(a));g.items.push($.extend(JSON.parse(JSON.stringify(b)),{x:b.x,y:b.y}))});
i.connections.forEach(function(a){a.allItemsIncluded(e)?(f.push(a.getBoundsRect()),g.connections.push(JSON.parse(JSON.stringify(a)))):a.connectsAnItem(e)&&a.points.forEach(function(a){if(void 0!==a.itemId&&0<=e.indexOf(a.itemId)){var b=thr0.arrayObjByKey(g.items,"id",a.itemId);b&&thr0.removeKeyFromArray(a.way?b.inputs:b.outputs,"port",a.port)}})});c||(b=thr0.boundingRect(f),c={x:10-b.x,y:10-b.y});g.items.forEach(function(a){h.collectRefs([sfsIdPrefix.diagram+i.id,sfsIdPrefix.item+a.id],g.refVals,
d);thr0.addXY(a,c)});g.connections.forEach(function(a){a.points.forEach(function(a){thr0.addXY(a,c)})});g.connections.length||delete g.connections;g.refVals.length?g.refVals=g.refVals.map(function(a){return{v:h.valueOf(a),p:a}}):delete g.refVals;return g}},applyPaste:function(a,b,c){function d(a){"number"!==typeof a.val&&(a.val=ThrMathOp.prototype.processFormula(m,a.val))}function e(a){return 1>=Math.abs(a.x-this.x)&&1>=Math.abs(a.y-this.y)}var f,g,h,i=[],j={x:0,y:0},k=[],l=[],m={mEnv:a.mathEnv,pathMap:[],
refVals:c.refVals},n=b.getMaxZindex(),p=c.connections?c.connections.length:0,o=b.newItemId(),r=b.newConId();if(c.items&&c.items.length){for(c.items.forEach(function(a){f=a.id;k.push(f);a.id=o++;l.push(a.id);m.pathMap.push({from:[sfsIdPrefix.diagram+b.id,sfsIdPrefix.item+f],to:[sfsIdPrefix.diagram+b.id,sfsIdPrefix.item+a.id]});if(!g||g.y>a.y||g.y===a.y&&g.x>a.x)g=a;a.groups&&(a.groups=a.groups.split(",").map(function(a){a=parseInt(a,10);var c=thr0.indexOfKey(i,"id",a);if(0<=c)return i[c].id2;h||(h=
b.maxGroupId()+1);i.push({id:a,id2:h});return h++}).join(","))});b.items.some(e,{x:g.x+j.x,y:g.y+j.y});)thr0.addXY(j,{x:10,y:10});c.nextItemId=o;c.items.forEach(function(a){thr0.addXY(a,j);m.ctx=[sfsIdPrefix.diagram+b.id,sfsIdPrefix.item+a.id];a.inputs.forEach(d);a.outputs.forEach(d);a.params.forEach(d)})}p&&(c.connections.forEach(function(a){a.id=r++;a.points.forEach(function(a){thr0.addXY(a,j);void 0!==a.itemId&&(a.itemId=l[k.indexOf(a.itemId)])})}),c.nextConId=r,!b.connections.length&&(!c.dispUnit&&
!thrUnits.isConvertible(b.dispUnit,c.connections[0].unit))&&(c.dispUnit=c.connections[0].unit));(c.items&&c.connections?c.items.concat(c.connections):c.items||c.connections||[]).sort(function(a,b){return(a.z||0)-(b.z||0)}).forEach(function(a){a.z=++n});a.pasting=!0;try{a.applyDiff(b.objSpec(),c)}finally{a.pasting=!1}},prepareItemChange:function(a,b,c){var d=thr0.getKeyArray(b,"id"),e="object"===typeof c?c:0>c?{moves:b.map(function(b){var c=a.getItem(b.id);return{id:b.id,delta:c?{x:b.x?b.x-c.x:0,y:b.y?
b.y-c.y:0}:{x:0,y:0}}})}:{sizes:b.map(function(b){var c=a.getItem(b.id);return{id:b.id,delta:c?{x:b.width?b.width-c.width:0,y:b.height?b.height-c.height:0}:{x:0,y:0}}}),szType:c};e.diagram=a;e.cons=(d?a.connections.filter(function(a){return a.connectsAnItem(this)},d):[]).map(function(b){var c=e.allMovedDelta||void 0!==e.allRotate,h=(c||e.allSizedDelta)&&b.allItemsIncluded(d,!1,!c);return{con:b,points:b.points.map(function(c,g){var k=k=c.itemId,l=e.selRect,m=void 0!==k&&0<=d.indexOf(k),n=m?a.getItem(k):
void 0,l=h||m||void 0===k&&l&&thr0.pointInRect(c,l);if(void 0===k){for(var k=b.points,m={},p=b.nextPtStx(g,0);0<=p;p=b.nextPtStx(g,p+1)){var o=k[b.otherStPt(p,g)],r=o.itemId;if(void 0!==r&&0<=d.indexOf(r)){var s=b.getStretchLine(p);thr0.isVertical(s)&&(m.vert={id:r,pt:o,it:a.getItem(r)});thr0.isHorizontal(s)&&(m.horz={id:r,pt:o,it:a.getItem(r)})}}k=m}else k=void 0;return{pt:c,it:n,fullyAffected:l,on:k}}),allPts:h}});return e},adjustConsToChangedItems:function(a,b){function c(a,b,c){var d=b<a?-1:1;
a=(b-a-c)*d;return 20>a?(20-a)*d:0}function d(a,b){if(a){var c=b.on,c=thr0.indexOfKey(a,"id",c?c.vert?c.vert.id:c.horz?c.horz.id:-1:b.pt.itemId);return 0<=c?a[c].delta:void 0}}function e(a,b,c,d,e){var f=b.selRect||d;e=thr0.sizedRect(f,c,d,b.szType,e);a.x=a.x<f.x?a.x+(e.x-f.x):a.x>f.x+f.width?a.x+(e.x+e.width-f.x-f.width):thr0.sizedPt(a,c,d,b.szType).x;a.y=a.y<f.y?a.y+(e.y-f.y):a.y>f.y+f.height?a.y+(e.y+e.height-f.y-f.height):thr0.sizedPt(a,c,d,b.szType).y}var f=a.diagram;b.items&&thr0.getKeyArray(b.items,
"id");a.cons.length&&(b.connections=a.cons.map(function(g){return{id:g.con.id,points:g.points.map(function(h){var i=h.pt,j=$.extend(!0,{},i),k=a.allMovedDelta||d(a.moves,h),l=a.allSizedDelta||d(a.sizes,h);if(void 0!==a.allRotate){if(h.fullyAffected)return void 0!==j.dir&&(j.dir-=a.allRotate),$.extend(j,thr0.rotatePt(j,a.cPt,a.allRotate))}else if(k){if(h.fullyAffected)return $.extend(j,thr0.movedPtDelta(j,k));if(void 0===j.itemId&&(l=h.on,l.horz||l.vert))return $.extend(j,thr0.movedPtDelta(j,{x:l.vert?
k.x:l.horz?c(l.horz.pt.x,i.x,k.x):0,y:l.horz?k.y:l.vert?c(l.vert.pt.y,i.y,k.y):0}))}else if(a.allSizedDelta||a.sizes){var k=h.it,m=a.boundsRect||k;if(l&&k&&k.rot)l=j.itemId,i=f.getItem(l),(l=thr0.arrayObjByKey(b.items,"id",l))?(i={x:void 0===l.x?i.x:l.x,y:void 0===l.y?i.y:l.y,width:void 0===l.width?i.width:l.width,height:void 0===l.height?i.height:l.height,rot:i.rot},i.cPt=thr0.rectCenter(i)):i=i.getCenter(),l=k.getCenter(),m=thr0.rotatePt(j,l,-k.rot),$.extend(j,thr0.rotatePt({x:i.cPt.x+(m.x-l.x)*
i.width/k.width,y:i.cPt.y+(m.y-l.y)*i.height/k.height},i.cPt,k.rot));else{if(l&&m&&(g.allPts||a.selRect&&thr0.pointInRect(j,a.selRect)))return $.extend(j,thr0.sizedPt(j,l,m,a.szType));if(l&&void 0!==j.itemId)k&&e(j,a,l,m,k.minSize);else if((k=h.on)&&(k.horz||k.vert)){if(!a.allSizedDelta){var n=k.vert?k.vert.it:k.horz.it;n&&(l=d(a.sizes,h),m=n)}if(l){h=thr0.sizedPt(j,{x:k.vert?l.x:0,y:k.horz?l.y:0},m,a.szType);if(n=!k.vert?k.horz:!k.horz?k.vert:0){var p=$.extend({},n.pt);e(p,a,l,m,n.it.minSize);k.horz?
h.x+=c(n.pt.x,i.x,p.x-n.pt.x):h.y+=c(n.pt.y,i.y,p.y-n.pt.y)}return $.extend(j,h)}}}}return j})}}));return b},getDiffMoveItems:function(a,b){if(b.length){var c=a.allMovedDelta;return this.adjustConsToChangedItems(a,{items:b.map(function(a){return $.extend(thr0.movedPtDelta(a,c),{id:a.id})})})}},applyMoveItemText:function(a,b,c){var d=b.getTextrect(a.diagram,0,0,a);if(b.rot){var e=b.getCenter(),f=thr0.rotatePt({x:d.x,y:d.y},e,b.rot);$.extend(d,thr0.deltaVec(b,thr0.rotatePt(thr0.movedPtDelta(f,c),e,
-b.rot)))}else d.x+=thr0.round100(c.x-b.x),d.y+=thr0.round100(c.y-b.y);a.mc.applyDiff(a.diagram.objSpec(),{items:[{id:b.id,textPos:6,text:d}]})},applySizePropObj:function(a,b,c,d){var e={};e[d]=c;a.applyDiff(b.objSpec(),e)},getDiffSizeItems:function(a,b){function c(a,b,c){var d=0>a?0.5:-0.5;return 0.5>=Math.abs(a)||thr0.numEqual(b,c)?a:(a+d)*b/(c||1)-d}function d(a,b,d){var h=a[d];h&&(h=JSON.parse(h),thr0.setXY(h.pt,c(h.pt.x,a.width,b.width),c(h.pt.y,a.height,b.height)),b[d]=JSON.stringify(h))}if(b.length)return this.adjustConsToChangedItems(a,
{items:b.map(function(b){var c=thr0.sizedRect(b,a.allSizedDelta,a.boundsRect,a.szType,b.minSize);c.cPt&&delete c.cPt;c.id=b.id;d(b,c,"combiInfoIn");d(b,c,"combiInfoOut");return c})})},applySizeItemText:function(a,b,c,d,e){c=thr0.sizedRect(b.getTextrect(a.diagram,0,0,a),c,d,e,b.minTextSize);c.x-=b.x;c.y-=b.y;a.mc.applyDiff(a.diagram.objSpec(),{items:[{id:b.id,textPos:6,text:c}]})},applyArrowAngle:function(a,b,c){var d=$.extend(!0,{},b.shape);d.spec.angle=c;a.mc.applyDiff(a.diagram.objSpec(),{items:[{id:b.id,
shape:d}]})},getDiffRotate:function(a,b){if(0<b.length){var c=a.allRotate,d=a.cPt;return this.adjustConsToChangedItems(a,{items:b.map(function(a){var b=a.getCenter(),g={id:a.id,rot:(a.rot||0)+c};if(!thr0.numEqual(d.x,b.x)||!thr0.numEqual(d.y,b.y))b=thr0.rotatePt(b,d,c),thr0.setXY(g,b.x-a.width/2,b.y-a.height/2);return g})})}},applyChangeZindex:function(a,b,c,d){function e(a,b){return a.z-b.z}if(0<c.length){var f=c.slice(0).sort(e),g=f[0].z,h=f[f.length-1].z;0<d?h=10===d?b.getMaxZindex():Math.min(b.getMaxZindex(),
h+1):g=-10===d?1:Math.max(1,g-1);c=b.items.concat(b.connections).filter(function(a){return a.z>=g&&a.z<=h&&0>f.indexOf(a)}).sort(e);c=0>d?f.concat(c):c.concat(f);a.applyDiff(b.objSpec(),c.reduce(function(a,b,c){b.z!==g+c&&(b instanceof SfsItem?a.items.push({id:b.id,z:g+c}):b instanceof SfsConnection&&a.connections.push({id:b.id,z:g+c}));return a},{items:[],connections:[]}))}},applyItemLayout:function(a,b,c){var d,e,f,g=[-1,-1,7,1,0,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1];d=[0,0,0,0,0,-1,2,1,0,0,-1,2,1,0,0];
f=thr0.filterArrayByType(b,SfsItem).map(function(b){var c=thr0.boundingRect(b.getFrame(a));return $.extend(c,{id:b.id,dx:b.x-c.x,dy:b.y-c.y})});var h=[0,0,function(a){return a.width},function(a){return a.height},function(a){return(a.width+a.height)/2},function(a){return a.x},function(a){return{min:a.x,max:a.x+a.width}},function(a){return a.x+a.width},0,0,function(a){return a.y},function(a){return{min:a.y,max:a.y+a.height}},function(a){return a.y+a.height},0,0],i=[0,0,function(a,b){return{id:a.id,
width:b}},function(a,b){return{id:a.id,height:b}},function(a,b){return{id:a.id,width:b,height:b}},function(a,b){return{id:a.id,x:b+a.dx}},function(a,b){return{id:a.id,x:b-a.width/2+a.dx}},function(a,b){return{id:a.id,x:b-a.width+a.dx}},0,0,function(a,b){return{id:a.id,y:b+a.dy}},function(a,b){return{id:a.id,y:b-a.height/2+a.dy}},function(a,b){return{id:a.id,y:b-a.height+a.dy}},0,0];if(f.length&&(2>c||1<f.length)){if(2>c){var j=new ThrSvgTrafo(c?[1,0,0,-1,0,0]:[-1,0,0,1,0,0]);f=b.filter(function(a){return a.shape&&
a.shape.d}).map(function(b){var d=b.getShapeBoundsRect(a);c?j.f=2*d.y+d.height:j.e=2*d.x+d.width;return{id:b.id,shape:[{p:"d",t:1},{p:"uuid",t:0},{p:"ld",t:1},{p:"nld",t:1},{p:"textrect",t:2},{p:"bounds",t:2},{p:"frame",t:2},{p:"pts",t:2}].reduce(function(a,e){if(b.shape[e.p])[function(a,b,c){b[c]=a[c]},function(a,b,c){b[c]=thrSvg.transformPath(a[c],j)},function(a,b,e){b[e]=thr0.mirrorFrame(a[e],c,thr0.rectCenter(d))}][e.t](b.shape,a,e.p);return a},{})}})}else if(h[c]){var h=h[c],i=i[c],k=d[c],l,
m;b=[];var n=h(f[0]);for(d=1;d<f.length;d++)0===k?n+=h(f[d]):1===k?n=Math.max(n,h(f[d])):(l=h(f[d]),-1===k?n=Math.min(n,l):(n.min=Math.min(n.min,l.min),n.max=Math.max(n.max,l.max)));2===k?n=(n.min+n.max)/2:k||(n/=f.length);n=Math.round(n);for(d=0;d<f.length;d++)for(m in h=i(f[d],n),h)if(h.hasOwnProperty(m)&&h[m]!==f[d][m]){b.push(h);break}f=b}else{d=9>=c?6:11;e=h[d-1];f.sort(function(a,b){return e(a)-e(b)});m=h[d];h=i[d];b=f.length-1;l=0<=[8,13].indexOf(c);for(var p=m(f[0]),n=(p.min+p.max)/2,o=l?
n:p.min,r=l?n:p.max,s=r-o,k=[],i=b;0<i;i--){d=m(f[i]);if(l){var q=(d.min+d.max)/2;q<o&&(o=q);q>r&&(r=q)}else d.min<o&&(o=d.min),d.max>r&&(r=d.max);s+=d.max-d.min}if(l){l=(r-o)/b;for(i=1;i<b;i++)n+=l,k.push(h(f[i],Math.round(n)))}else{d=p;l=(r-o-s)/b;for(i=1;i<b;i++)n=d.max+l,d=m(f[i]),k.push(h(f[i],Math.round(n+(d.max-d.min)/2))),d.max=n+(d.max-d.min)}f=k}f&&f.length&&(m={items:f},1<c&&this.adjustConsToChangedItems(this.prepareItemChange(a.diagram,f,g[c]),m),a.mc.applyDiff(a.diagram.objSpec(),m))}},
applyGroupItems:function(a,b,c){a.applyDiff(b.objSpec(),{items:c.map(function(a){return{id:a.id,groups:a.groups?a.groups+","+this:this}},(b.maxGroupId()+1).toString())})},applyUngroupItems:function(a,b,c){a.applyDiff(b.objSpec(),{items:b.items.reduce(function(a,b){if(b.groups){var f=b.groups.split(",");0<=c.indexOf(f.pop())&&a.push({id:b.id,groups:f.length?f.join(","):"_DELETE_"})}return a},[])})},applyMagneticBorder:function(a,b,c,d){function e(a,c,e){e=thr0.expandedFrame(e.getFrame(d),e.getCenter(),
b.snapBoxBorder);c=thr0.snapInLineToFrame(a,c,e);if(0.7<=thr0.distance(a,c))return thr0.setXYFromPt(a,c,!0),!0}function f(a,b,c,d){if(0<=c.indexOf(b.id)&&b[d]){c=JSON.parse(b[d]);var f=b.absolutePt(c.pt);e(f,thr0.movedPt(f,c.dir,1E4),b)&&(c.pt=b.relativePt(f),a[d]=JSON.stringify(c))}}var g,h=!c||!c.length||c[0]instanceof SfsDiagram,i=(h?b.items:thr0.filterArrayByType(c,SfsItem)).map(function(a){return a.id}),j=$.extend([],i);h||thr0.filterArrayByType(c,SfsConnection).forEach(function(a){a.points.forEach(function(a){if(a.itemId){var c=
b.getItem(a.itemId);1===a.way&&c.combiInfoIn&&thr0.pushIfNEx(i,a.itemId);0===a.way&&c.combiInfoOut&&thr0.pushIfNEx(j,a.itemId)}})});g=b.connections.filter(function(a){return h||0<=c.indexOf(a)||a.connectsAnItem(i)||a.connectsAnItem(j)}).map(function(a){var d=!1,f=h||0<=c.indexOf(a),g=a.points.map(function(c,g,h){var k=$.extend({},c),p=1===c.way?i:j;if(c.itemId&&(f||0<=p.indexOf(c.itemId)))e(k,h[a.otherStPt(a.nextPtStx(g),g)],b.getItem(c.itemId))&&(d=!0);return k});return d?{id:a.id,points:g}:void 0}).filter(function(a){return a});
if(g.length){g={connections:g};if(i.length||j.length){var k=b.items.map(function(a){var b={id:a.id};f(b,a,i,"combiInfoIn");f(b,a,j,"combiInfoOut");return b.combiInfoIn||b.combiInfoOut?b:void 0}).filter(function(a){return a});k.length&&(g.items=k)}a.applyDiff(b.objSpec(),g)}},applySetCoordinates:function(a,b,c){if(b=thr0.cleanDiff(this.getDiffSetProps(a,b,c)))this.adjustConsToChangedItems(this.prepareItemChange(a.diagram,b.items,void 0!==c.width?7:void 0!==c.height?1:-1),b),a.mc.applyDiff(a.diagram.objSpec(),
b)},getDiffSetProps:function(a,b,c){return this.getObjDiffs(a.diagram,b,function(a){var b,f={};for(b in c)if(c.hasOwnProperty(b)){var g=c[b];0<=b.indexOf(".")?$.extend(!0,f,thrRevisioning.contextOp.diffFromPropPathVal(a,b.split("."),g)):a[b]!==g&&(f[b]=void 0===g?"_DELETE_":g)}return f})},applySetProps:function(a,b,c){a.mc.applyDiff(a.diagram.objSpec(),this.getDiffSetProps(a,b,c))},getObjDiffs:function(a,b,c){if(b&&b.length){var d=[],e=[],f={items:d,connections:e};b.forEach(function(b){var h=c(b);
h&&!$.isEmptyObject(h)&&(b instanceof SfsItem?d.push($.extend(!0,{id:b.id},h)):b instanceof SfsConnection?e.push($.extend(!0,{id:b.id},h)):b instanceof SfsLegend?f.legend=h:b===a&&$.extend(!0,f,h))});return f}},applySetItemCalcType:function(a,b,c){function d(a){return this!==a.calcType?{port:a.port,calcType:void 0===this?"_DELETE_":this}:void 0}a.mc.applyDiff(a.diagram.objSpec(),{items:b.map(function(a){var b=6===c?1===a.calcType?1:5===a.calcType?2:0:void 0;return a.calcType===c?void 0:thr0.cleanDiff({id:a.id,
calcType:c,inputs:a.inputs.map(d,b).filter(thr0.isDefined),outputs:a.outputs.map(d,b).filter(thr0.isDefined)},"id")}).filter(thr0.isDefined)})},applySetOpacity:function(a,b,c,d){var e=a.diagram;a.mc.applyDiff(e.objSpec(),this.getObjDiffs(e,b,function(a){var b=thrRevisioning.contextOp,e=thrColors.changeOpacity(b.resolvePathProp(a,c),d);if(0<=c.indexOf("."))return b.diffFromPropPathVal(a,c.split("."),e);a={};a[c]=e;return a}))},getAssociatedCombiLine:function(a,b,c,d,e){var f,g,h=[],i=a.mc.mathEnv,
j=a.diagram,k=b.getFrame(a),l=b.getCenter();c.forEach(function(a){var c=thr0.associatedFrameLine(a.pt,l,k);if(c.l){var f=a.con.points[a.con.otherStPt(a.con.nextPtStx(a.ptx),a.ptx)];thr0.isSmallAngleDelta180(thr0.lineAngle(c.l),thr0.angle(a.pt,f))&&(c=thr0.associatedFrameLine(f,l,k))}f=a.pt;a=e?1:b.getValue(i,j,a.pt.port,d);var g;0<=c.ix?(g=thr0.indexOfKey(h,"ix",c.ix),0>g?(c.val=a,h.push(c)):h[g].val+=a):(g=thr0.findIndexInArray(h,function(a){return 0>a.ix&&a.dir===this.dir&&thr0.distance(this.pt,
a.pt)<this.d},{dir:c.dir,pt:f,d:2*thr0.snapTolerance}),0>g?h.push({ix:-1,dir:c.dir,pt:f,l:thr0.getLine(f,c.dir-90),val:a}):h[g].val+=a)});f=h.reduce(function(a,b){return b.val>a.val?b:a},{val:0,l:[l,{x:l.x,y:l.y+1}],dir:0});f.id=b.id;if(!f.pt&&(j.snapBoxBorder&&void 0!==f.dir&&(f.l=thr0.movedLine(f.l,f.dir,j.snapBoxBorder)),a=c.map(function(a){return thr0.lineIntersection(f.l,thr0.getLine(a.pt,f.dir))}),g=45<f.dir&&135>f.dir||225<f.dir&&315>f.dir?"x":"y",a=a.reduce(function(a,b){return a?[a[0][g]>
b[g]?b:a[0],a[1][g]<b[g]?b:a[1]]:[b,b]},void 0)))f.pt=thr0.centeredPt(a);k.ellipse&&(f.dir=thr0.round100(thr0.ellipseOrtho(k,f.pt)));void 0===f.dir&&(f.dir=thr0.round100(thr0.normalizeAngle(thr0.lineAngle(f.l)+90)));return f},combiConDiff:function(a,b,c,d,e,f){function g(a,b){if(a.x!==b.x||a.y!==b.y)return thr0.setXYFromPt(a,b),!0}var h=Math.max(50,Math.min(200,2*a.maxConWidth)),i=f.points,j=f.stretches;f=i[c];e=g(f,e);var k=b.nextPtStx(c,0,j),l=b.otherStPt(k,c);if(2===i[l].way&&j.every(function(b){b=
b.a===l?b.b:b.b===l?b.a:c;var d=i[b];return b===c||void 0===d.itemId||!a.isCombi(d.itemId,1===d.way)})){j=i[l];b=thr0.lineIntersection(thr0.getLine(f,d),thr0.getLine(j,d+90));k=thr0.normalizeAngle(thr0.angle(f,b)-d);if(thr0.distance(b,f)<h||15<k&&345>k)b=thr0.movedPt(f,d,h);g(j,b)&&(e=!0)}else e=j[k],b=i.length,h=Math.min(h,thr0.distance(i[e.a],i[e.b])/(2>i[l].way?3:2)),j.push({a:b,b:e.b}),e.b=b,i.push($.extend(thr0.movedPt(f,d,h),{way:2})),e=!0;return e},applySetCombi:function(a,b,c,d){var e=a.diagram;
b=(b||[]).filter(function(a){return a instanceof SfsItem&&(c&&a.combiIn!==d||!c&&a.combiOut!==d)});if(b.length){var f=c?{combiIn:d}:{combiOut:d},g=c?"combiInfoIn":"combiInfoOut";if(d){var h={items:[]},i=[],j=e.connections.filter(function(a){return a.connectsAnItem(this)},b.map(function(a){return a.id})).map(function(a){return{id:a.id,points:$.extend(!0,[],a.points),stretches:$.extend(!0,[],a.stretches)}});b.forEach(function(b){var d=$.extend({id:b.id},f),m=e.getItemConPoints(b.id,c);if(m.length){var n=
this.getAssociatedCombiLine(a,b,m,c);d[g]=JSON.stringify({pt:b.relativePt(n.pt),dir:n.dir,ptDir:n.dir});m.forEach(function(a){this.combiConDiff(e,a.con,a.ptx,n.dir,n.pt,thr0.arrayObjByKey(j,"id",a.con.id))&&thr0.pushIfNEx(i,a.con.id)},this)}h.items.push(d)},this);h.connections=j.filter(function(a){return 0<=this.indexOf(a.id)},i);a.mc.applyDiff(e.objSpec(),h)}else f[g]="_DELETE_",this.applySetProps(a,b,f)}},applyAddTag:function(a,b,c,d){a.applyDiff(b.objSpec(),{connections:c.map(function(a){var b=
thr0.indexOfKey(a.stretches,this.tt);if(0<=b)return a={id:a.id,stretches:$.extend(!0,[],a.stretches)},a.stretches[b][this.tt]={dx:0,dy:0},a},{tt:d}).filter(function(a){return a})})},applyDeleteTag:function(a,b,c,d,e){c.stretches.length>d&&void 0!==c.stretches[d][e]&&(c={id:c.id,stretches:$.extend(!0,[],c.stretches)},delete c.stretches[d][e],a.applyDiff(b.objSpec(),{connections:[c]}))},getWizLayout:function(a,b,c,d,e,f){a=b.width;var g=b.height,h=SfsItem.prototype.width*(3>c?1:3/(c+1));e=2>c?0:Math.min((a-
100-h)/(c-1),e);f=2>d?0:Math.min((g-100-50)/(d-1),f);return{x0:50,y0:50,h:50,w:h,dx:e,dy:f,x:Math.round((a-h-(c-1)*e)/2),y:Math.round((g-50-(d-1)*f)/2),dxSt:Math.round((e-h-2*b.snapBoxBorder)/3),nextItemId:b.newItemId(),nextConId:b.newConId()}},buildWizItemCon:function(a,b,c,d,e,f,g,h,i,j,k){a=k?1-h:h;i={y:e.y+e.height/2+(1<i?5*(j-(i-1)/2):0),itemId:e.id,port:g.port,way:h};"string"===typeof c&&(c={id:f.nextConId++,name:c,points:[],stretches:[]});h?(e.inputs||(e.inputs=[]),e.inputs.push(g)):(e.outputs||
(e.outputs=[]),e.outputs.push(g));i.x=a?e.x-b.snapBoxBorder:e.x+e.width+b.snapBoxBorder;b=c.points.length;c.points.push(i);c.points.push({x:a?i.x-f.dxSt:i.x+f.dxSt,y:i.y,way:2});c.stretches.push({a:b,b:b+1});0<=d&&c.stretches.push({a:d,b:b+1});return c},applyWizIOItem:function(a,b,c){var d,e,f,g,h,i,j=thrUnits.getFactor(c.unit),k=1,l=this.getWizLayout(a,b,3,c.inputs.length,400,100),m=1.3*l.w,n={id:l.nextItemId++,x:(b.width-m)/2,y:(b.height-m)/2,width:m,height:m,text:{tx:c.name},calcType:1,showTotals:!0,
inputs:[],outputs:[],shape:$.extend({},thrShapes.getShape(5)),innerEffect:2},p=[n],o=[];this.wizSetCombi(a,b,n,!0,180);this.wizSetCombi(a,b,n,!1,0);l.x+=(l.w-m)/2;for(f=0;2>f;f++){g=f?c.outputs:c.inputs;d=0;for(e=g.length;d<e;d++)i={id:l.nextItemId++,x:l.x,y:l.y+l.dy*d,width:l.w,height:l.h,text:{tx:g[d].name,color:"#000",size:14},color:"#eee",hiddenShape:!0,showTotals:!0},h=this.buildWizItemCon(a,b,g[d].name,-1,n,l,{port:k+d,val:g[d].val/j,unit:c.unit},f?0:1,e,d),this.buildWizItemCon(a,b,h,1,i,l,
{port:1,val:g[d].val/j,unit:c.unit},f,1,1),h.color="thr("+f+","+(70-2*d)%7+")",h.arrowHeadAngle=135,h.outerEffect=1,p.push(i),o.push(h);k=g.length+1;l.x+=2*l.dx+(m-l.w);d=c.outputs.length;l.dy=2>d?0:Math.min((b.height-2*l.y0-l.h)/(d-1),100);l.y=Math.round((b.height-l.h-(d-1)*l.dy)/2)}a.applyDiff(b.objSpec(),{dispUnit:c.unit,nextItemId:l.nextItemId,nextConId:l.nextConId,items:p,connections:o})},applyWizIOCon:function(a,b,c){var d,e,f,g,h,i,j,k=-1,l=[0,0],m=thrUnits.getFactor(c.unit),n=this.getWizLayout(a,
b,2,c.inputs.length,600,100),p=[],o=[];n.dxSt*=0.6;for(f=0;2>f;f++){g=f?c.outputs:c.inputs;d=0;for(e=g.length;d<e;d++)h={id:n.nextItemId++,x:n.x,y:n.y+n.dy*d,width:n.w,height:n.h,text:{tx:g[d].name},color:"#ccc",showTotals:!0},i=this.buildWizItemCon(a,b,i||c.name,k,h,n,{port:1,val:g[d].val/m,unit:c.unit},f,1,1),l[f]+=g[d].val/m,o.length||(j={x:i.points[1].x+n.dxSt,y:b.height/2,way:2},i.points.push(j),i.stretches.push({a:1,b:2}),i.points.push({x:j.x+n.dxSt,y:j.y,way:2}),i.stretches.push({a:2,b:3}),
k=2,i.outerEffect=1,o.push(i)),p.push(h);n.x+=n.dx;d=c.outputs.length;n.dy=2>d?0:Math.min((b.height-2*n.y0-n.h)/(d-1),100);n.y=Math.round((b.height-n.h-(d-1)*n.dy)/2);k=3}thr0.numEqual(l[0],l[1])||(k=i.points.length,j={x:(i.points[2].x+i.points[3].x)/2,y:i.points[2].y,way:2},i.points.push(j),i.stretches[2].b=k,i.stretches.push({a:k,b:3}),i.points.push({x:j.x,y:j.y+150,way:l[0]<l[1]?0:1,val:Math.abs(l[0]-l[1]),unit:c.unit}),i.stretches.push({a:l[0]<l[1]?k:k+1,b:l[0]<l[1]?k+1:k}));a.applyDiff(b.objSpec(),
{dispUnit:c.unit,nextItemId:n.nextItemId,nextConId:n.nextConId,items:p,connections:o})},wizSetCombi:function(a,b,c,d,e){a={pt:{x:0,y:0},dir:e,ptDir:e};90===e||270===e?a.pt.y=(c.height/2+b.snapBoxBorder)/c.height*(90===e?-1:1):a.pt.x=(c.width/2+b.snapBoxBorder)/c.width*(180===e?-1:1);c[d?"combiIn":"combiOut"]=!0;c[d?"combiInfoIn":"combiInfoOut"]=JSON.stringify(a)},applyWizComparison:function(a,b,c){var d,e,f,g,h,i,j=thrUnits.getFactor(c.unit),k=this.getWizLayout(a,b,3,c.valNames.length,400,100);d=
1.3*k.w;var l=[{id:k.nextItemId++,x:k.x+k.w-d,y:(b.height-d)/2,width:d,height:d,text:{tx:c.names[0]},calcType:1,showTotals:!0,shape:$.extend(!0,{},thrShapes.getShape(5)),innerEffect:2},{id:k.nextItemId++,x:b.width-k.x-k.w,y:(b.height-d)/2,width:d,height:d,text:{tx:c.names[1]},calcType:1,showTotals:!0,shape:$.extend(!0,{},thrShapes.getShape(5)),innerEffect:2}],m=[];this.wizSetCombi(a,b,l[0],c.isInput,0);this.wizSetCombi(a,b,l[1],c.isInput,180);k.x+=(k.w-d)/2;d=0;for(e=c.valNames.length;d<e;d++){h=
{id:k.nextItemId++,x:(b.width-k.w)/2,y:k.y+k.dy*d,width:k.w,height:k.h,text:{tx:c.valNames[d],color:"#000"},color:"#ddd"};l.push(h);for(f=0;2>f;f++)i=c.isInput?!f:f,g=this.buildWizItemCon(a,b,c.valNames[d],-1,l[f],k,{port:d+1,val:c.values[f][d]/j,unit:c.unit},c.isInput?1:0,e,d,i),this.buildWizItemCon(a,b,g,1,h,k,{port:f+1,val:c.values[f][d]/j,unit:c.unit},c.isInput?0:1,1,1,i),g.color="thr(0,"+(70-2*d)%7+")",g.arrowHeadAngle=135,g.outerEffect=1,g.stretches[1].ind={dx:f?0:-15,dy:0},m.push(g)}a.applyDiff(b.objSpec(),
{dispUnit:c.unit,nextItemId:k.nextItemId,nextConId:k.nextConId,items:l,connections:m})},applyWizDrillDown:function(a,b,c){function d(a){return a?a.reduce(function(a,b){return Math.max(a,d(b.data)+1)},0):1}function e(a){return a?a.reduce(function(a,b){return a+e(b.data)},0):1}function f(a){return a?void 0!==a.val?a.val:a.data.reduce(function(a,b){return a+f(b)},0):0}function g(a,c,d,e,h,i){var o,r,s={id:h.nextItemId++,x:h.x,width:h.w,height:h.h,text:{tx:e.name},calcType:1},q=thrUnits.getFactor(i);
d.items.push(s);h.x+=h.dx;r=e.data?e.data.map(function(b){return g(a,c,d,b,h,i)}):void 0;h.x=s.x;s.y=r?(r[0].y+r[r.length-1].y)/2:h.y;h.y=(r?r[r.length-1].y:h.y)+h.dy;r&&(s.calcType=2,o=a.buildWizItemCon(c,b,e.name,-1,s,h,{port:1,val:f(e)/q,unit:i},0,1,1),r.forEach(function(d,g){a.buildWizItemCon(c,b,o,1,d,h,{port:2,val:f(e.data[g])/q,unit:i},1,1,1)}),d.connections.push(o));return s}var h=this.getWizLayout(a,b,d(c.data),e(c.data),600,200),i={items:[],connections:[]};g(this,a,i,c,h,c.unit);i.dispUnit=
c.unit;i.nextItemId=h.nextItemId;i.nextConId=h.nextConId;a.applyDiff(b.objSpec(),i)},applyWizMeshedCols:function(a,b,c){var d,e,f,g,h,i,j,k,l=thrUnits.getFactor(c.unit),m=this.getWizLayout(a,b,c.length,3,600,200),n=[],p=[];d=0;for(h=c.length;d<h;d++){f=c[d];m.dy=1<f.length?Math.min((b.height-2*m.y0-m.h)/f.length,200):0;m.y=Math.round((b.height-m.h-(f.length-1)*m.dy)/2);for(e=0;e<f.length;e++)k={id:m.nextItemId++,x:m.x,y:m.y,width:m.w,height:m.h,text:{tx:f[e].name}},0<d&&(k.inputs=[],this.wizSetCombi(a,
b,k,!0,180)),d<h-1&&(k.outputs=[]),f[e].item=k,n.push(k),m.y+=m.dy;m.x+=m.dx}d=1;for(h=c.length;d<h;d++)for(e=0;e<c[d-1].length;e++){g=void 0;k=c[d-1][e].item;for(f=0;f<c[d].length;f++)if(i=c[d][f].vals[e]/l){if(!g){for(j=g=0;g<c[d].length;g++)j+=c[d][g].vals[e]/l;g=this.buildWizItemCon(a,b,k.text.tx,-1,k,m,{port:1,val:j,unit:c.unit},0,1,1);g.color="thr(0,"+(70-2*e)%7+")";p.push(g)}this.buildWizItemCon(a,b,g,1,c[d][f].item,m,{port:e+2,val:i,unit:c.unit},1,c[d-1].length,e)}}a.applyDiff(b.objSpec(),
{dispUnit:c.unit,nextItemId:m.nextItemId,nextConId:m.nextConId,items:n,connections:p})}};o.sfsEditorUI={ntx:{unconnectedHint:"unconnected - press \x3cctrl\x3e to add a new item",unconnected:"unconnected",connectedTo:"connected to",connectedTo2:"a new item",addItemHint:"press \x3cctrl\x3e to add a new item",inbound:"inbound",outbound:"outbound",delRefHint1:"ATTENTION: You try to delete one ore many items with referenced parameters.",delRefHint2:"References will be replaced by the respective parameter values.",
readOnly:"Read only mode",conDataDetails:"Connection data details",trunk:"Trunk",unconnectedPts:"Unconnected end points",way:"Way",value:"Value",type:"type",cmodeAuto:"auto adjust",cmodeFixed:"fixed values",cmodeRatio:"fix ratio",cmodeIO:"sum up (in-\x3eout)",cmodeOI:"sum up (out-\x3ein)",cmodeUser:"user input",cmodeMixed:"mixed",cmodeSAuto:"auto",cmodeSFixed:"fix",cmodeSUser:"input",allPtsConnected:"All end points are connected to items"},icons:{link:"m 9.13,15.78 c -5.06,0 -9.13,3.67 -9.13,8.22 0,4.56 4.07,8.22 9.13,8.22 l 5.66,0 c 3.57,0 6.62,-1.82 8.13,-4.49 l -14.7,0 c -2.05,0 -3.74,-1.67 -3.74,-3.74 0,-2.07 1.69,-3.74 3.74,-3.74 l 14.7,0 C 21.41,17.6 18.35,15.78 14.79,15.78 l -5.66,0 z m 24.09,0 c -3.56,0 -6.64,1.82 -8.15,4.48 l 14.71,0 c 2.07,0 3.74,1.67 3.74,3.74 0,2.07 -1.67,3.74 -3.74,3.74 l -14.71,0 c 1.51,2.67 4.58,4.49 8.15,4.49 l 5.65,0 c 5.06,0 9.13,-3.67 9.13,-8.22 0,-4.56 -4.07,-8.22 -9.13,-8.22 l -5.65,0 z m -20.07,5.61 c -1.45,0 -2.61,1.17 -2.61,2.62 0,1.45 1.16,2.62 2.61,2.62 l 21.68,0 c 1.45,0 2.62,-1.17 2.62,-2.62 0,-1.45 -1.17,-2.62 -2.62,-2.62 l -21.68,0 z",
rotate:"m -18.84,-18.53 c -1.82,1.82 -3.04,4.27 -3.38,7.07 l -3.17,-0.03 4.33,7.65 4.46,-7.57 -3.24,-0.03 c 0.61,-4.43 3.685,-7.55 8.1,-8.01 l 0.03,3.15 7.57,-4.462 -7.65,-4.33 0.03,3.17 c -2.81,0.35 -5.25,1.56 -7.08,3.39 z"},layoutShortCuts:[76,67,82,84,77,66],layoutFuncNos:[3,4,5,8,9,10],rectRotateHandle:{x:-26,y:-26,width:21,height:21},init:function(a){thrUI.setActionMaker(a.$svg,function(a){return sfsEditorUI.makeAction(a)});a.$svg.mousemove(function(a){sfsEditorUI.mousemove(a)}).on("thrdrop",
function(a){sfsEditorUI.thrdrop(a)}).on("thrdragover",function(a){sfsEditorUI.thrdragover(a)});thr0.addNotifier(this)},finish:function(){thr0.removeNotifier(this)},setReadonly:function(a,b,c,d,e){a.$svg.parent().find(".sfsReadOnlyHint").remove();if(a.readonly=b)a.$svg.before(_h.div(_h.div((d?"":_h.tags(["p","strong"],sfsEditorUI.ntx.readOnly))+c,e),"sfsReadOnlyHint")),this.select(a)},isReadonly:function(a){return a&&a.readonly},findInReadonlyHint:function(a,b){return a.$svg.parent().find(".sfsReadOnlyHint").find(b)},
setSnapClass:function(a,b){b?thrSvg.addClass(a,"sfsSnap"):thrSvg.removeClass(a,"sfsSnap")},keydown:function(a,b){function c(a){var b=a.selectedObjects(),c=a.selection.sub;c&&delete a.selection.sub;sfsEditorMC.applyDelete(a,b,c);sfsEditorUI.select(a)}var d=!0,e=b.keyCode||b.which;if(46===e||8===e){var f=[],e=a.selectedObjects().map(function(b){b.params&&b.params.length&&b.params.forEach(function(c){f.push([sfsIdPrefix.prefixedId(a.diagram),sfsIdPrefix.prefixedId(b),sfsIdPrefix.parameter+c.id])});return[sfsIdPrefix.prefixedId(a.diagram),
sfsIdPrefix.prefixedId(b)]});f.length&&a.mc.mathEnv.isReferenced(f,e)?thrUI.dialog.show(thrUI.ntx.del,function(){c(a)},3,_h.tags(["p","strong"],sfsEditorUI.ntx.delRefHint1)+_h.tag("p",sfsEditorUI.ntx.delRefHint2)):c(a)}else if(9===e)this.selectNextElement(a,!b.shiftKey);else if(b.altKey&&(38===e||40===e)){var g=a.selectedObjects();0<g.length&&(!(g[0]instanceof SfsDiagram)&&!(g[0]instanceof SfsLegend))&&sfsEditorMC.applyChangeZindex(a.mc,a.diagram,g,40===e?b.shiftKey?-10:-1:b.shiftKey?10:1)}else 37<=
e&&40>=e&&!a.selection.connections?(e=this.selectionBounds(a))?(g=a.$svg[0].createSVGPoint(),thr0.setXYFromPt(g,e),g=g.matrixTransform(a.$svg[0].getScreenCTM()),b.clientX=g.x,b.clientY=g.y,this.scMove(a,b)):d=!1:b.ctrlKey?88===e?(this.copyToClipboard(a),c(a)):67===e?this.copyToClipboard(a):86===e?this.pasteFromClipboard(a):81===e?this.selectSimilarItems(a):65===e?b.shiftKey?this.select(a):b.altKey?this.selectAllConnections(a):this.selectAllItems(a):d=!1:b.altKey?(e=this.layoutShortCuts.indexOf(e),
0<=e?sfsEditorMC.applyItemLayout(a,thr0.filterArrayByType(a.selectedObjects(),SfsItem),this.layoutFuncNos[e]):d=!1):(32===e||48<=e)&&!b.ctrlKey&&!b.altKey?(g=a.$svg.find(".thrSelText"),1===g.length?(e=String.fromCharCode(e),this.startTextEdit(a,new C(g),b.shiftKey?e.toUpperCase():e.toLowerCase())):d=!1):d=!1;d&&b.preventDefault()},mousemove:function(a){if(!thrUI.action&&(!a.target.id||!/^sfs[0-9]*S/.test(a.target.id))){var b=$(a.currentTarget);if(b=sfsSvgDiagram.findDiagram(b)){var c;for(c=a.target;c&&
!c.id;)c=c.parentElement;(c=(c=c?c.id.match(/^sfs[0-9]+I([0-9]*)/):0)&&1<c.length?b.diagram.getItem(parseInt(c[1],10)):void 0)&&c.frozen&&(c=void 0);c=this.itemFromEvent(b,a,c?c.z:0)||c;b.isSelected(c)&&(c=void 0);b.hoverElement!==c&&(b.hoverElement=c,this.renderHoverSelectors(b))}}},startTextEdit:function(a,b,c){var d,e,f,g,h={box:0,line:a.settings.textLinePadding},i=a.selection;a.textEd&&a.textEd.close();if("I"===b.elementType){e=b.getObj();if(!i.items||0>i.items.indexOf(b.id))i={items:e.groups?
thr0.getKeyArray(a.diagram.itemsOfGroup(e.groups.split(",").pop()),"id"):[b.id]},!b.subId&&1<e.textPos&&(i.sub="tx"),this.select(a,i);d=a.$getSubGroup("SI",b.id);d=b.subId?d.find("#"+d.attr("id")+"_tx"+b.subId):d.find(".thrSelText");b.$hideTemp=a.$getSubGroup("I",b.id).find("text").closest("g");f=e.getText(b.subId,!0);g=e.getTextrect(a.diagram,0,b.subId,a);h.box=e.hiddenShape||6===e.textPos?0:f.size*a.settings.itemBoxPadding}if(d&&d.length)return b.$hideTemp&&thrSvg.addClass(b.$hideTemp,"thrNoDisplay"),
a.$svg.find(".sfsSizer, .sfsConnector").attr("opacity",0.4),thrUI.standby=!0,a.textEdInfo=b,a.textEd=new ThrSvgTextEditor(this,a,d,g,f,h),"string"===typeof c?a.textEd.startTyping(c):a.textEd.startSelectText(c)},notifyEndTextEdit:function(a,b,c,d){var e=a.textEdInfo;e.$hideTemp&&thrSvg.removeClass(e.$hideTemp,"thrNoDisplay");a.textEdInfo=void 0;a.textEd=void 0;a.$svg.find(".sfsSizer, .sfsConnector").removeAttr("opacity");thrUI.standby=void 0;c?this.renderSelection(a):"I"===e.elementType&&(c={id:e.id},
c["text"+(e.subId?e.subId:"")]={tx:b.tx,wi:b.wi},a.mc.applyDiff(a.diagram.objSpec(),{items:[c]}));d?this.editNextText(a,e,0<d):a.$svg.closest("[tabindex \x3d '0']").focus()},editNextText:function(a,b,c){var d=[],e=!0,f=a.selectedObjects(),g=a.diagram,h=a.settings.itemBoxPadding;1>=f.length&&(f=g.items,e=!1);f.forEach(function(b){if(b instanceof SfsItem&&!b.frozen&&b.textPos)for(var c=thr0.rectCenter(b.getTextrect(g,b.text.size*h,e,a)),e=0,f=thrShapes.getShapeTextCount(b.shape);e<f;e++)d.push({id_n:b.id+
"_"+e,item:b,n:e,x:c.x,y:Math.round(c.y/10)})});1<d.length&&(d.sort(function(a,b){return a.y===b.y?a.n===b.n?a.x-b.x:a.n-b.n:a.y-b.y}),b=thr0.indexOfKey(d,"id_n",b.id+"_"+(b.subId||"0")),b=0>b?0:(b+(c?1:d.length-1))%d.length,c=$.extend(new C($()),{sd:a,elementType:"I",id:d[b].item.id,subId:d[b].n,isText:!0,isSelector:!0}),e||this.select(a,c.toSelSpec()),this.startTextEdit(a,c,""))},notifyDiagramRendered:function(a){this.renderSelection(a)},itemFromEvent:function(a,b,c){var d,e=thrSvg.pointFromEvent(b,
a.$svg[0]);a.itemRenderers.forEach(function(a){var g=a.getBoundsRect();a=a.item;if((b.shiftKey||!a.frozen)&&(!c||a.z>c)&&(b.shiftKey?thr0.pointInRect(e,g):thr0.pointInEllipse(e,g)))d=a,c=a.z});return d},makeAction:function(a){var b;b=$(a.target);var c=new C(b),d=c.sd;if(d&&!this.touchMode){if(d.textEd&&b.closest("g").is(d.textEd.$g))return d.textEd.startSelectText(a);if("_"===c.elementType||c.isSelector&&a.shiftKey){var e=this.itemFromEvent(d,a,(c.getObj()||{z:0}).z);e&&(c=new C($("#"+d.getHtmlId("I",
e.id))))}d.$svg.parent().focus();if(d.readonly)"0"===c.elementType&&(a=b.closest("a").attr("xlink:href"))&&o.open(a,"_blank");else{"0"===c.elementType&&(c.elementType="_");if(c.isEdText&&!a.shiftKey)return this.startTextEdit(d,c,a)||!0;b=c.getObj();if((!b||!b.frozen||a.shiftKey)&&(!c.isSelector||a.shiftKey&&"I"===c.elementType&&(!c.subType||"tx"===c.subType))&&/^[ICL]$/.test(c.elementType)){if(this.select(d,c.toSelSpec(a.shiftKey)),!c.isSelector&&(!a.shiftKey||"C"===c.elementType)){if(/^[IL]$/.test(c.elementType)||
c.subType&&0<=SfsConnection.prototype.tagTypes.indexOf(c.subType))return new L(d,a,c,!0);if("C"===c.elementType)return c=d.findConRenderer(b.id),c=thr0.indexOfClosestLine(thrSvg.pointFromEvent(a,d.$svg[0]),c.getStretchLines()),a.shiftKey?new S(d,a,b,c,!1):new K(d,a,b,c,void 0,!0)}}else{if(b&&b.frozen&&!c.isSelector||/^_?$/.test(c.elementType))return new ha(d,a,b&&b.frozen?b:void 0);if(c.isSelector||"C"!==c.elementType||c.subType){if(/^(in|out|st)$/.test(c.subType))return!a.shiftKey&&"st"===c.subType?
new K(d,a,b,c.subId):new S(d,a,b,c.subId,"out"===c.subType);if(/^(pt|np)$/.test(c.subType))return new K(d,a,b,c.subId,a.target,!1,"np"===c.subType);if("aa"===c.subType)return new ia(d,a,c);if("sz"===c.subType)return new T(d,a,c,!0);if("rt"===c.subType)return new ja(d,a,c);if(""===c.subType||0<=SfsConnection.prototype.tagTypes.indexOf(c.subType)||/^[IL]$/.test(c.elementType)){if((!c.subType||"tx"===c.subType)&&(!d.selection.sub||"tx"===d.selection.sub)&&d.selection.sub!==c.subType)b=$.extend({},d.selection),
c.subType?b.sub=c.subType:delete b.sub,this.select(d,b);return new L(d,a,c,!0)}}}}}},select:function(a,b){a&&a.textEd&&a.textEd.close();a.select(b);this.renderSelection(a);thr0.notify("notifySelect",a)},selectSimilarItems:function(a){var b=a.selectedObjects().filter(function(a){return a instanceof SfsItem&&(a.hiddenShape||a.shape&&a.shape.uuid)}).map(function(a){return a.hiddenShape?-1:a.shape.uuid});b.length&&this.select(a,{items:thr0.getKeyArray(a.diagram.items.filter(function(a){return a.shape&&
0<=b.indexOf(a.hiddenShape?-1:a.shape.uuid)}),"id")})},selectAllItems:function(a){this.select(a,{items:thr0.getKeyArray(a.diagram.items,"id")})},selectAllConnections:function(a){this.select(a,{connections:thr0.getKeyArray(a.diagram.connections,"id")})},selectionBounds:function(a,b,c,d){function e(a,b,e){if(b&&!(b instanceof SfsDiagram))return b.rot&&c&&!d?(e=b.getCenter(),thr0.boundingRect(thr0.rectPoints(b.getTextrect(a.diagram,0,0,a)).map(function(a){return this.apply(a)},new ThrSvgTrafo(thrSvg.strRotate(b.rot,
e))))):e?b.getTextrect(a.diagram,0,0,a):b.getBoundsRect(a)}b=b||a.selectedObjects();void 0===c&&(c="tx"===a.selection.sub);return 1===b.length?e(a,b[0],c):thr0.boundingRect(b.map(function(b){return e(a,b,c)}))},selectNextElement:function(a,b){if(a.selection){var c=a.selection.connections,d=(c?a.diagram.connections:a.diagram.items).filter(function(a){return!a.frozen}).map(function(b){var c=b.getBoundsRect(a);return{o:b,id:b.id,x:c.x,y:Math.round(c.y)}},a).sort(function(a,b){return a.y===b.y?a.x-b.x:
a.y-b.y}),e=(a.selectedObjects().reduce(function(a,b){return Math.max(thr0.indexOfKey(d,"id",b.id),a)},-1)+(b?1:d.length-1))%d.length,c=$.extend(new C($()),{sd:a,elementType:c?"C":"I",id:d[e].o.id});this.select(a,c.toSelSpec())}},renderHoverSelectors:function(a){a.$getGroup("S").find(".thrHover").remove();a.hoverElement instanceof SfsItem&&(20<=a.hoverElement.height||20<=a.hoverElement.width)&&this.renderItemSelector(a,a.hoverElement.id,{prepend:!0,connectors:!0,cls:"thrHover"})},renderSelection:function(a,
b){var c,d=a.diagram,e="tx"===a.selection.sub,f=thrSvg.getZoom(a.$svg),g=!1,h=a.getMathEnv(),i=a.selectedObjects().sort(function(a,b){return(a.z||0)-(b.z||0)}),j=this.selectionBounds(a,i,void 0,!0),k=2>i.length,l=a.$getGroup("S");if(!a.activeAction&&(l.empty().attr("transform",""),c=a.$getGroup("B").empty(),d&&(d.isEmpty()&&(new ThrText({tx:sfsSvgDiagram.ntx.firstStepsHint,size:18})).$createWrappedSvgText(c,{x:50,y:50,width:d.width-100,height:d.height-100},a.settings.textLinePadding),"l"===a.selection.sub&&
!d.legend.visible&&delete a.selection.sub,i.forEach(function(c){c instanceof SfsItem?(sfsEditorUI.renderItemSelector(a,c.id,{box:!0,mEnv:h,zoom:f,textBox:k&&1<c.textPos&&(e||c.text.tx),connectors:k&&!c.frozen&&!e,connectorDistance:(20<=j.height&&20<=j.width?2E3:1500)/f}),g=!0):c instanceof SfsConnection?sfsEditorUI.renderConSelector(a,c.id,f,b&&b.con.id===c.id?b:void 0):c instanceof SfsLegend&&(sfsEditorUI.appendSelectorBox(a,l,d.legend.getBoundsRect(),"SL0",f),k=g=!0)}),g))){var m="nwse-resize ns-resize nesw-resize ew-resize nwse-resize ns-resize nesw-resize ew-resize".split(" "),
n=1===i.length&&i[0]instanceof SfsItem?i[0]:void 0,p=n&&!e?thrShapes.getAutoProp(n.shape):void 0,o=l[0].id+(n?"I"+n.id:"S0"),r={id0:o+"_sz",$g:n?l.find("#"+o):l,rect:j,r:100*a.settings.selSize/(2*f),sw:100*a.settings.selLineWidth/f};j.rot=0;if(1E3>j.height*f||1E3>j.width*f)r.r/=3.75,r.sw/=2;else if(5E3>j.height*f||5E3>j.width*f)r.r/=1.5;m.forEach(function(a,b){if(p?"width"===p?1===b||5===b:3===b||7===b:(20<=j.height||3!==b&&7!==b)&&(20<=j.width||1!==b&&5!==b)){var c=thr0.boundsPt(this.rect,b);thrSvg.$appendElement(this.$g,
"circle",{id:this.id0+b,"stroke-width":this.sw/2,"class":"sfsSizer",cx:c.x,cy:c.y,r:this.r,style:"cursor: "+a})}},r);if(k){if(n&&thrShapes.hasSizableAngle(n.shape)){c=thrShapes.getArrowAngle(n.shape);var s=n.shape.spec.rot||0,n=45>s||315<s?2:135>s?0:225>s?6:4;c=thr0.movedPt(thr0.boundsPt(r.rect,n),thr0.reverseAngle(s),r.rect[p]/(2*Math.tan(c*thr0.deg2rad/2))-r.rect["width"===p?"height":"width"]/2);thrSvg.$appendElement(r.$g,"circle",{id:o+"_aa"+n,"stroke-width":r.sw/2,"class":"sfsSizer",cx:c.x,cy:c.y,
r:r.r,style:"cursor: "+m[n+1]})}}else this.appendSelectorBox(a,c,j,"SB0",f);i.length&&(i[0]instanceof SfsItem&&!e)&&(m=thrSvg.$appendElement(r.$g,"g",{id:o+"_rt","class":"sfsRotate"}),o=new ThrSvgTrafo([1,0,0,1,j.x,j.y]),thrSvg.$appendElement(m,"rect",o.applyToRect(this.rectRotateHandle)),o.a=100/f,o.d=o.a,thrSvg.$appendElement(m,"path",{d:thrSvg.transformPath(this.icons.rotate,o)}));1===i.length&&i[0].rot&&l.find(".sfsSizer").css("cursor","pointer")}},defaultConPts:function(a,b,c){var d=thr0.round100(a.x+
a.width/2),e=thr0.round100(a.y+a.height/2),d=[{x:d,y:a.y,dir:90},{x:a.x+a.width,y:e,dir:0},{x:d,y:a.y+a.height,dir:270},{x:a.x,y:e,dir:180}];b&&(a=thr0.rectCenter(a),d=d.map(function(a){var c=this.apply(a);c.dir=thr0.normalizeAngle(a.dir-b);return c},new ThrSvgTrafo(thrSvg.strRotate(b,a))));return c?d.map(function(a){var b=thr0.movedPt(a,a.dir,c);b.dir=a.dir;return b}):d},renderItemSelector:function(a,b,c){var d=a.findItemRenderer(b);if(d){var e=c.zoom||100,f=d.getBoundsRect(),g=a.$getSubGroup("SI",
b,c.prepend).empty();c.box&&(this.appendSelectorBox(a,g,f,"SI"+b+"_",e),c.textBox&&this.appendSelectorBox(a,g,d.item.getTextrect(a.diagram,0,0,a),"SI"+b+"_tx",e),(b=d.renderText(g,c.mEnv,!0))&&thrSvg.addClass(b,"thrSelText"));if(c.connectors){var h=50*a.settings.selLineWidth/e;b=2E3/e;var i=100*a.settings.selSize/((f.width<b&&f.height<b?1.5:1)*e);(d.item.getConPts(d.item.getFrame(a,!0),a,!0,!0)||this.defaultConPts(f)).forEach(function(a,b){var d=a;c.connectorDistance&&void 0!==d.dir&&(d=thr0.movedPt(d,
d.dir,c.connectorDistance),d.dir=a.dir);thrSvg.$appendElement(g,"path",{id:g[0].id+"_out"+b,"stroke-width":h,"class":"sfsConnector",d:thrSvg.pathFromPtArray(thr0.triangle(d,i))+"Z"})})}d.item.rot?(a=thr0.rectCenter(f),g.attr("transform",thrSvg.strRotate(d.item.rot,a))):g.removeAttr("transform");c.cls&&thrSvg.addClass(g,c.cls)}},renderConSelector:function(a,b,c,d){var e=d||a.findConRenderer(b);if(e){var f=100*a.settings.selSize/((e.forceSmallHandles||20>e.con.getShortestStLength()?4:2)*c),g=50*a.settings.selLineWidth/
c,h=SfsConnection.prototype.tagTypes;d=e.con.stretches;var i=a.$getSubGroup("SC",b),j=i[0].id;i.empty();d.forEach(function(a,b){thrSvg.$appendElement(i,"path",{id:j+"_st"+b,"stroke-width":g,"class":"sfsRouteSt",d:e.getStretchPath(b,c)})});e.con.points.forEach(function(a,b){var c=e.getPt(b,!1);thrSvg.$appendElement(i,"circle",{id:j+"_pt"+b,"stroke-width":g,"class":"sfsRoutePt",cx:c.x,cy:c.y,r:f});if(2>a.way&&!a.itemId){var d=e.getPt(e.con.otherStPt(e.con.nextPtStx(b),b),!0),d=thr0.movedPt(c,thr0.angle(d,
c),2*f);thrSvg.$appendElement(i,"circle",{id:j+"_np"+b,"stroke-width":g,"class":"sfsNewRoutePt",cx:d.x,cy:d.y,r:f/2})}});d.forEach(function(c,d){h.forEach(function(e){if(c[e]){var f=a.$svg.find("#"+a.getHtmlId("C",b)+"_"+e+d);f.length&&thrSvg.$appendElement(i,"rect",$.extend({id:j+"_"+e+d,"stroke-width":g,"class":"sfsSel"},thrSvg.bboxToRect(f[0].getBBox())))}})})}},conSkeletonPath:function(a,b){function c(a,b,d,h,i){var j=a.nextPtStx(d,0),k=b[d],k=k.x+" "+k.y;j===h&&(j=a.nextPtStx(d,j+1));for(i=[i+
k+(0<=j?c(a,b,a.otherStPt(j,d),j,"L"):"")];0<=j;)j=a.nextPtStx(d,j+1),0<=j&&j!==h&&i.push("M"+k+c(a,b,a.otherStPt(j,d),j,"L"));return i.join("")}var d;for(d=b.length-1;0<=d&&b[d].way;d--);return 0<=d?c(a,b,d,-99,"M"):""},renderConSkeletons:function(a,b,c,d){d||a.$getGroup("H");var e=d?0:100*a.settings.selLineWidth/thrSvg.getZoom(a.$svg);return b.cons.map(function(b,g){var h=this.conSkeletonPath(b.con,c.connections[g].points);if(d){var i=d[g];i.attr("d",h);return i}return thrSvg.$appendElement(a.$getGroup("H"),
"path",{"class":"sfsConSkeleton","stroke-width":e,d:h})},this)},appendSelectorBox:function(a,b,c,d,e,f){return thrSvg.$appendElement(b,"rect",{x:c.x,y:c.y,width:c.width,height:c.height,"stroke-width":100*a.settings.selLineWidth/e,id:"sfs"+a.id+d,"class":f?"sfsSelIndicator":"sfsSel"})},$findSelectorBox:function(a){a=$("#sfs"+a.id+"SB0");return a.length?a:$(".sfsSel")},createItem:function(a){a&&!a.readonly&&this.addItem(a,a.diagram.defaultItemPos())},addItem:function(a,b,c,d){d=sfsEditorMC.applyAddItem(a,
b,d);this.select(a,{items:[d]});b=a.$svg.find(".thrSelText");b.length&&this.startTextEdit(a,new C(b.eq(0)),c);return d},scMove:function(a,b){var c=b.keyCode||b.which,d=b.shiftKey?10:1,e=b.ctrlKey?new T(a,b,void 0,!1):new L(a,b,void 0,!1);switch(c){case 37:b.clientX-=d;break;case 39:b.clientX+=d;break;case 38:b.clientY-=d;break;default:b.clientY+=d}e.changed=!0;b.shiftKey=!1;b.ctrlKey=!1;e.end(b,!1)},copyToClipboard:function(a){if(a=sfsEditorMC.getObjCopies(a,a.selectedObjects()))localStorage.thrClipboard=
JSON.stringify({context:"sfsDiagram",data:a})},pasteFromClipboard:function(a){var b,c=thr0.strToPojo(localStorage.thrClipboard);c&&("sfsDiagram"===c.context&&(b=a.diagram.nextItemId,sfsEditorMC.applyPaste(a.mc,a.diagram,c.data)),this.select(a,{items:thr0.getKeyArray(a.diagram.items,"id",function(a){return a.id>=b})}))},getDragDropInfo:function(a,b){if(a){var c=thrSvg.pointFromEvent(b,a.$svg[0]),d=a.conStFromPoint(c,10),e=Math.max(b.act.r.width,b.act.r.height)/1.5;return{pt:c,conSt:!b.act.justText&&
d&&thr0.distance(d.l[0],c)>e&&thr0.distance(d.l[1],c)>e?d:void 0}}},dragovershape:function(a,b){if(a){var c=this.getDragDropInfo(a,b);if(c.conSt){if(!b.act.conSt||b.act.conSt.con!==c.conSt.con||b.act.conSt.stx!==c.conSt.stx){var d=a.findConRenderer(c.conSt.con.id),e=thrSvg.getZoom(a.$svg),f=100*a.settings.selLineWidth/e;b.act.$temp&&b.act.$temp.remove();b.act.$temp=thrSvg.$appendElement(a.$getGroup("H"),"path",{"class":"sfsConnect","stroke-width":f,d:d.getStretchPath(c.conSt.stx,e)});b.act.conSt=
c.conSt}}else b.act.$temp&&(b.act.$temp.remove(),b.act.$temp=void 0,b.act.conSt=void 0)}},dropshape:function(a,b){if(a){var c=b.value,d=this.getDragDropInfo(a,b),e={x:d.pt.x-b.act.r.width/2,y:d.pt.y-b.act.r.height/2,width:b.act.r.width,height:b.act.r.height};if(b.act.justText)e.text={color:"#000",tx:c},e.hiddenShape=!0;else{var f=c.textrect?c.textrect.stdPos:c.spec&&c.spec.auto?"width"===c.spec.auto?4:5:void 0;delete c.title;e.shape=c;c.lineGraphic&&(e.avoidNoLine=!0);c.spec&&"sankey"===c.spec.cmd&&
(e.combiIn=!0,e.combiOut=!0);void 0!==f&&(e.textPos=f,c.textrect&&c.textrect.stdPos&&delete c.textrect.stdPos,2<=f&&5>=f&&(e.text={hAlign:2===f?2:4===f?0:1,vAlign:3===f?2:5===f?0:1}))}this.addItem(a,e,void 0,d.conSt)}},thrdragover:function(a){"shape"===a.droptype&&this.dragovershape(sfsSvgDiagram.findDiagram($(a.currentTarget)),a)},thrdrop:function(a){"shape"===a.droptype&&this.dropshape(sfsSvgDiagram.findDiagram($(a.currentTarget)),a)},conDataDialog:{show:function(a,b,c,d){var e=thrUI.dialog.create(sfsEditorUI.ntx.conDataDetails,
1),f=e.find(".thrDlgBody"),g={style:"width: 30px; text-align: left;"},h={style:"width: 130px; text-align: left;"};thrUI.setTempData(e,{ptInfos:c,sd:b,invalidChangeCB:d});f.append(_h.tag("h5",a)+_h.table(0,[[sfsEditorUI.ntx.trunk,_h.div("",{"class":"thrcddTrunc","data-control":"dropdownSelect","data-prop":"trunc",style:"width:300px"})]])+_h.tag("h5",sfsEditorUI.ntx.unconnectedPts));f.append(_h.table([[sfsEditorUI.ntx.way,g],["Id",g],[sfsEditorUI.ntx.value,h],[sfsEditorUI.ntx.type,h]],[],"thrTable"));
this.refreshPointInfos(e,b,c);e.data("changes",0).find(".thrDialog").change(function(a){sfsEditorUI.conDataDialog.change(a)})},valStr:function(a){return thr0.formatLocalFloat(a.val*thrUnits.getFactor(a.unit))+" "+a.unit},refreshPointInfos:function(a,b,c){var d=[],e=[],f=0,g=sfsEditorUI.ntx,h=a.find(".thrDlgBody\x3e.thrTable\x3etbody"),i=a.find(".thrcddTrunc");c&&c.length&&c.forEach(function(a){if(!a.calcType||a.adj){var c=a.pt.itemId?thr0.limitedText(b.getCaption("i",a.pt.itemId),25):sfsEditorUI.ntx.unconnected;
a.adj&&(f=e.length);e.push((a.pt.way?"--\x3e":"\x3e--")+" "+(c+" ("+this.valStr(a)+")").replace(",","."))}a.calcType=a.pt.calcType;void 0===a.pt.itemId&&d.push(a)},this);i.addClass("thrInitControl").data("options",e.join(","));thrUI.initControls(a);thrUI.dropdownSelect.fill(i,f);a.data("trunc",f);d.length?(thrUI.setTempData(a,"unconnected",d),h.html(d.map(function(a){return _h.tableRow([_h.span("",{"class":"thrIcon",style:"background-position: -"+("source"===a.way?"816":"792")+"px 0px; margin: 1px 4px;"}),
a.pt.id,this.valStr(a),thrUI.ihtml("dropdownSelect",{"class":"thrPopup",options:g.cmodeSAuto+","+g.cmodeSFixed+","+g.cmodeSUser,values:"0,2,1",value:a.calcType||0,prop:"calcType."+a.pt.id})])},this).join("")),thrUI.initControls(h)):h.html(_h.tableRow([[sfsEditorUI.ntx.allPtsConnected,{colspan:4}]]));thrUI.dialog.center(a.find(".thrDialog"))},applyChange:function(a){var b=thrUI.getTempData(a,"sd");sfsEditorMC.applyConPtChanges(b.mc,b.diagram,b.selectedObjects()[0],a.data("trunc"),thrUI.getTempData(a,
"ptInfos"));a.data("changes",a.data("changes")+1)},change:function(a){var b=$(a.currentTarget).parent();a.stopPropagation();if("trunc"===a.prop)b.data("trunc",a.value),this.applyChange(b);else if(/^calcType\./.test(a.prop)){var c=thr0.findInArray(thrUI.getTempData(b,"unconnected"),function(a){return a.pt.id===this},parseInt(a.prop.substring(9),10)),d=thrUI.getTempData(b,"sd");sfsEditorMC.isConCalcTypeChangeAllowed(d.mc.mathEnv,d.ctx,d.selectedObjects()[0],c.ptx,a.value)?(c.calcType=a.value,this.applyChange(b)):
(a.err=!0,(b=thrUI.getTempData(b,"invalidChangeCB"))&&b())}else if(0<=[thrUI.ntx.close,thrUI.ntx.cancel,thrUI.ntx.ok].indexOf(a.dlgCmd)){if((c=b.data("changes"))&&a.dlgCmd===thrUI.ntx.cancel)for(a=thrUI.getTempData(b,"sd").mc;c--;)a.undo();thrUI.dialog.close(b)}else a.dlgCmd===thrUI.ntx.cancel&&thrUI.dialog.close(b)}}};thrNtx.register(sfsEditorUI);C.prototype={id:0,subType:"",subId:0,getObj:function(){var a=this.sd;if(a)return"I"===this.elementType?a.diagram.getItem(this.id):"C"===this.elementType?
a.diagram.getConnection(this.id):void 0},toSelSpec:function(a){var b,c,d=this.elementType;if("L"===d)b={sub:"l"};else{var e=this.subType;b=""===d?{}:"I"===d?{items:[this.id]}:{connections:[this.id]};"I"===d&&(c=this.getObj(),c.groups&&(b.items=thr0.getKeyArray(this.sd.diagram.itemsOfGroup(c.groups.split(",").pop()),"id")));"I"===d&&"tx"===e?1!==c.textPos&&(b.sub=e):e&&!a&&(b.sub=e+(this.subId||""))}a&&(b.add=!0);return b}};H.prototype={standBy:!0,clear:function(){this.zoom=100;this.sd=void 0;["v",
"vc","h","hc","oPts"].forEach(function(a){this[a]=[]},this);this.$sl&&this.cleanup()},initSnapLines:function(a){var b=a.$getGroup("H");this.sd=a;this.zoom=thrSvg.getZoom(a.$svg);this.sw=100*a.settings.selLineWidth/this.zoom;this.$sl=this.appendSnapLine(b,0,0,0,1).add(this.appendSnapLine(b,0,0,0,1)).add(this.appendSnapLine(b,0,0,0,1)).add(this.appendSnapLine(b,0,1,0,0)).add(this.appendSnapLine(b,0,1,0,0)).add(this.appendSnapLine(b,0,1,0,0));return this},initFromItems:function(a,b,c,d){var e=a.diagram;
d&&c&&(this.clear(),c.forEach(function(c){this.addFromRect(thr0.boundingRect(c.getFrame(a)),b)},this),["v","vc","h","hc"].forEach(function(a){this["_"+a]=this[a]},this));this.clear();(!b||0<=b.indexOf("vc"))&&this.addLineInfo(e.width/2,[0,e.height],this.vc);(!b||0<=b.indexOf("hc"))&&this.addLineInfo(e.height/2,[0,e.width],this.hc);e.items.forEach(function(d){(!c||0>c.indexOf(d))&&this.addFromRect(thr0.boundingRect(d.getFrame(a)),b)},this);d&&c&&["v","vc","h","hc"].forEach(function(a){this["_"+a]=
this["_"+a].filter(function(a){return 0>thr0.indexOfKey(this,"pos",a.pos)},this[a])},this);return this.initSnapLines(a)},initFromConTags:function(a,b){function c(a,b,c){0<=["v","vc"].indexOf(b)?a.addLineInfo(c.x,[c.y,c.y],a[b]):a.addLineInfo(c.y,[c.x,c.x],a[b])}var d=a.$getGroup("E"),e=SfsConnection.prototype.tagTypes;this.clear();a.diagram.connections.forEach(function(f){f.stretches.forEach(function(g,h){e.forEach(function(c){if(g[c]&&(f.id!==b.id||c!==b.subType||h!==b.subId))c=d.find("#sfs"+a.id+
"C"+f.id+"_"+c+h),c.length&&this.addFromRect(thrSvg.bboxToRect(c[0].getBBox()))},this);if(f.id===b.id){var i=[f.points[g.a],f.points[g.b]],j=thr0.centeredPt(i),k=thr0.isVertical(i)?"h":"v";c(this,"vc",j);c(this,"hc",j);c(this,k,i[0]);c(this,k,i[1])}},this)},this);return this.initSnapLines(a)},addOrthoPts:function(a){var b=this.oPts,c=thr0.getKeyArray(a,"id",function(a){return a instanceof SfsItem});this.sd.diagram.connections.forEach(function(a){a.points.forEach(function(e,f){void 0!==e.itemId&&0<=
c.indexOf(e.itemId)&&b.push([e,a.points[a.otherStPt(a.nextPtStx(f),f)]])})});return this},initFromConnection:function(a,b,c){this.clear();var d=a.findConRenderer(b.id);for(b=b.points.length-1;0<=b;b--)if(0>c.indexOf(b)){var e=d.getPt(b,!0);this.addLineInfo(e.x,[e.y,e.y],this.vc);this.addLineInfo(e.y,[e.x,e.x],this.hc)}return this.initSnapLines(a)},addLineInfo:function(a,b,c){var d=c.length,e=thr0.round100(a);a=thr0.indexOfSorted(c,"pos",a,!0);a+1<d&&1>c[a+1].pos-e&&a++;a<d&&1>Math.abs(c[a].pos-e)?
(c=c[a].info,b[0]<c[0]&&(c[0]=b[0]),b[1]>c[1]&&(c[1]=b[1])):c.splice(a,0,{pos:e,info:b})},addFromRect:function(a,b){if(a){var c=a.x,d=c+a.width,e=a.y,f=e+a.height;[{s:"v",p:c,i:[e,f]},{s:"v",p:d,i:[e,f]},{s:"vc",p:(c+d)/2,i:[e,f]},{s:"h",p:e,i:[c,d]},{s:"h",p:f,i:[c,d]},{s:"hc",p:(e+f)/2,i:[c,d]}].forEach(function(a){(!b||0<=b.indexOf(a.s))&&this.addLineInfo(a.p,a.i,this[a.s])},this)}},setTarget:function(a,b,c){if(a!==this.target&&(!a||!a.con||!this.target||a.con!==this.target.con||a.stx!==this.target.stx)){var d,
e=this.sd,f=this.zoom,g=100*e.settings.selLineWidth/f;this.$snapFrame&&(this.$snapFrame.remove(),this.$snapFrame=void 0);this.snapFrame&&(this.target&&!this.target.rot&&(this.vc.pop(),this.hc.pop()),this.snapFrame=void 0);this.mustSnapToPt=!1;this.target=a;this.targetDelta=c;this.$snapPts&&(this.$snapPts.remove(),this.$snapPts=void 0);this.$target&&(this.$target.remove(),this.$target=void 0);if(a instanceof SfsItem){c=thrShapes.canSnapToFrame(a.shape);var h=this.targetBoundsRect(),i=100*Math.min(48,
2*h.width/3,2*h.height/3)/(48*f),j=new ThrSvgTrafo([i,0,0,i,h.x+h.width/2-24*i,h.y+h.height/2-24*i]),i=700/f;this.$target=thrSvg.$appendElement(e.$getGroup("H"),"path",{"class":"sfsLinked","stroke-width":g,d:thrSvg.transformPath(sfsEditorUI.icons.link,j)});a.rot||this.addFromRect(thr0.expandedRect(h,100),["vc","hc"]);this.snapFrame=c?thr0.expandedFrame(a.getFrame(e),thr0.rectCenter(h),e.diagram.snapBoxBorder):void 0;this.snapPts=a.getConPts(this.snapFrame,e)||sfsEditorUI.defaultConPts(a,a.rot,e.diagram.snapBoxBorder);
a=e.$getGroup("H");this.snapPts&&(this.mustSnapToPt=!c,this.$snapPts=d=thrSvg.$appendElement(a,"g",{"class":"sfsSnapPoints"}),this.snapPts.forEach(function(a){thrSvg.$appendElement(d,"circle",{cx:thr0.round100(a.x),cy:thr0.round100(a.y),r:500/f,visibility:"hidden"})}));this.snapFrame&&(this.$snapFrame=thrSvg.$appendBounds(a,this.snapFrame,{"class":"sfsSnapFrame","stroke-width":g/2,visibility:"hidden"}).add(thrSvg.$appendBounds(a,this.snapFrame,{"class":"sfsSnapFrame2","stroke-width":g,"stroke-dasharray":i+
","+i,visibility:"hidden"})))}else a&&a.cr?this.$target=thrSvg.$appendElement(e.$getGroup("H"),"path",{"class":"sfsConnect","stroke-width":g,d:a.cr.getStretchPath(a.stx,f,a.l)}):a&&(this.$target=sfsEditorUI.appendSelectorBox(e,e.$getGroup("H"),a,"",f,!0));b&&b.hint&&b.hint.setText(b.getHintTx(this.targetCaption()))}},targetObj:function(){return this.target?this.target.con||this.target:void 0},targetBoundsRect:function(){return this.target instanceof SfsItem?this.target.getBoundsRect(this.sd):void 0},
targetCaption:function(){if(this.target){var a=this.targetObj();return thr0.limitedText("object"===typeof a&&"function"===typeof a.denom?a.denom():sfsEditorUI.ntx.connectedTo2)}},setStandBy:function(a){a!==this.standBy&&(["v","vc","h","hc"].forEach(function(b){this["_"+b]&&this["_"+b].forEach(function(c){a?thr0.removeKeyFromArray(this[b],"pos",c.pos):this.addLineInfo(c.pos,c.info,this[b])},this)},this),this.standBy=a)},beginSnap:function(a){this.snapData={objs:[],pt0:a};this.target&&this.target.l&&
this.addSnapData(this.target.l,thr0.closestLinePt(a,this.target.l));return this},addSnapData:function(a,b,c){var d=this.snapData.objs,e=2>d.length;1===d.length&&(e=void 0!==c&&a[0]&&$.isArray(d[0])?thr0.significantAngleDelta(c,thr0.lineAngle(d[0]),15):$.isArray(d[0])||d[0].ellipse);e&&(this.snapData.pt1=d.length?void 0:b,d.push(a));return e},canSnapToLine:function(a){var b=this.snapData.objs;return 1!==b.length?!b.length:void 0===a?!0:$.isArray(b[0])?thr0.significantAngleDelta(a?90:0,thr0.lineAngle(b[0]),
15):b[0].ellipse},endSnap:function(a){var b,c=this.snapData.pt0;b=this.snapData.objs;var d=a?this.targetDelta:void 0;d&&(c={x:c.x+d.x,y:c.y+d.y});this.snapData.pt1?c=this.snapData.pt1:1===b.length?c=thr0.closestLinePt(c,b[b.length-1]):2===b.length&&((a=$.isArray(b[0])?$.isArray(b[1])?void 0:b[1]:b[0])?(b=a===b[0]?b[1]:b[0],a.rot&&(b=[thr0.rotatePt(b[0],a.cPt,-a.rot),thr0.rotatePt(b[1],a.cPt,-a.rot)]),b=thr0.lineEllipseIntersection(b,thr0.rectCenter(a),a.width/2,a.height/2),(c=!b||1===b.length||thr0.distance(c,
b[0])<=thr0.distance(c,b[1])?b[0]:b[1])&&a.rot&&(c=thr0.rotatePt(c,a.cPt,a.rot))):c=thr0.lineIntersection(b[0],b[1])||c);this.snapData=void 0;return d?{x:c.x-d.x,y:c.y-d.y,dir:c.dir}:c},snapToTarget:function(a){var b=this.snapData.pt0,c=this.targetDelta;c&&(b={x:b.x+c.x,y:b.y+c.y});if(this.$snapPts){var c=this.snapPts,d=thr0.snapTolerance;a=thr0.indexOfKey(c,"force",a?"out":"in");this.$snapPts.find("\x3e*").attr("visibility","hidden");for(var e=c.length-1;0<=e;e--){var f=thr0.distance(b,c[e]);if(this.mustSnapToPt)0>
a?(a=e,d=f):f<d&&(a=e);else if(f<=d){a=e;break}}if(0<=a)return b=c[a],this.addSnapData(b,b),this.$snapPts.find("\x3e*:nth-child("+(a+1)+")").attr("visibility","visible"),this.snapFrame&&this.$snapFrame.attr("visibility","visible"),this}this.snapFrame&&(c=thr0.snapToFrame(b,this.snapFrame,thr0.snapTolerance),this.$snapFrame.attr("visibility",b===c.pt?"hidden":"visible"),c.snapObj&&this.addSnapData(c.snapObj,c.pt));return this},findLine:function(a,b){var c=thr0.indexOfSorted(b,"pos",a,!0),d=0<c?a-b[c-
1].pos:thr0.snapTolerance+1,e=c<b.length?b[c].pos-a:thr0.snapTolerance+1;if(d<thr0.snapTolerance&&d<=e)return{pos:b[c-1].pos,info:b[c-1].info,delta:-d};if(e<thr0.snapTolerance)return{pos:b[c].pos,info:b[c].info,delta:e}},adjustSnapLine:function(a,b,c){$(this.$sl[a]).attr(b?$.extend({visibility:"visible"},3>a?{x1:b.pos,x2:b.pos,y1:thr0.minOfArray(c,void 0,b.info[0]),y2:thr0.maxOfArray(c,void 0,b.info[1])}:{x1:thr0.minOfArray(c,void 0,b.info[0]),x2:thr0.maxOfArray(c,void 0,b.info[1]),y1:b.pos,y2:b.pos}):
{visibility:"hidden"})},snapToLine:function(a){var b=this.snapData.pt0;(a=a?this.targetDelta:void 0)&&(b={x:b.x+a.x,y:b.y+a.y});for(a=1;0<=a;a--){var c=this.canSnapToLine(a)?a?this.findLine(b.x,this.vc):this.findLine(b.y,this.hc):void 0;if(c){var d=a?{x:c.pos,y:b.y}:{x:b.x,y:c.pos};this.addSnapData(a?[{x:d.x,y:0},{x:d.x,y:100}]:[{x:0,y:d.y},{x:100,y:d.y}],d)}this.adjustSnapLine(a?1:4,c,[a?b.y:b.x])}return this},appendSnapLine:function(a,b,c,d,e){return thrSvg.$appendElement(a,"line",{x1:b,y1:d,x2:c,
y2:e,"class":"sfsSnapLine","stroke-width":this.sw/4,"stroke-dasharray":5*this.sw+","+2.5*this.sw})},doSnap:function(a,b,c,d,e){function f(a,b){var c=a.reduce(function(a,b){return a?b?Math.abs(b.delta)<Math.abs(a.delta)?b:a:a:b});return c?c.delta:b}function g(a,b,c){return a.length?a.reduce(function(a,c){return Math.abs(c[b])<Math.abs(a[b])?c:a})[b]:c}if(d)this.$sl.attr("visibility","hidden");else{var h=this,i=[this.v,this.vc,this.v,this.h,this.hc,this.h],j=this.sd.$getGroup("H");d=thr0.snapTolerance;
var k=d+1,l=this.oPts.map(function(a){return{x0:a[0].x+b.x,x1:a[1].x,x:a[1].x-(a[0].x+b.x),y0:a[0].y+b.y,y1:a[1].y,y:a[1].y-(a[0].y+b.y)}}),m=[a.x+b.x,a.x+b.x+a.width/2,a.x+b.x+a.width,a.y+b.y,a.y+b.y+a.height/2,a.y+b.y+a.height].map(function(a,b){return c[b]?a:void 0}),n=m.map(function(a,b){return void 0!==a?this.findLine(a,i[b]):void 0},this),p=thr0.minAbs(g(l,"x",k),f(n.slice(0,3),k)),o=thr0.minAbs(g(l,"y",k),f(n.slice(3),k));this.$ol&&this.$ol.remove();this.$ol=l.reduce(function(a,b){thr0.numEqual(b.x,
p)&&(a=a.add(h.appendSnapLine(j,b.x1,b.x1,Math.min(b.y0,b.y1)-50,Math.max(b.y0,b.y1)+50)));thr0.numEqual(b.y,o)&&(a=a.add(h.appendSnapLine(j,Math.min(b.x0,b.x1)-50,Math.max(b.x0,b.x1)+50,b.y1,b.y1)));return a},$());n.forEach(function(b,c){this.adjustSnapLine(c,b&&Math.abs(b.delta)<=Math.abs(3>c?p:o)?b:void 0,3>c?m[4]?[m[3]-50,m[5]+50]:[a.y-50,a.y+a.height+50]:m[1]?[m[0]-50,m[2]+50]:[a.x+50,a.x+a.width+50])},this);e&&(Math.abs(p)>Math.abs(o)?p=k:o=k);Math.abs(p)<=d&&(b.x+=p);Math.abs(o)<=d&&(b.y+=
o)}return b},cleanup:function(){this.$sl.remove();this.$ol&&this.$ol.remove();this.$snapFrame&&this.$snapFrame.remove();this.$target&&this.$target.remove();this.$snapPts&&this.$snapPts.remove()}};ga.prototype={limitRect:{x:0,y:0,width:100,height:100},containerPt:function(a,b){if(a&&void 0!==a.clientX&&void 0!==a.clientY){var c,d=this.limitRect;c=thrSvg.pointFromEvent(a,this.sd.$svg[0],this.invCtm);d.rot&&(c=thr0.rotatePt(c,d.cPt,d.rot));b&&(thr0.addXY(d,c),thr0.addXY(d,b,-1));c={x:thr0.intoRange(c.x,
d.x,d.x+d.width),y:thr0.intoRange(c.y,d.y,d.y+d.height)};d.rot&&(c=thr0.rotatePt(c,d.cPt,-d.rot));this.lastContainerPt=c}return this.lastContainerPt}};F.prototype={adjustToPt:function(a,b){this.$tx.attr(a);void 0!==b&&this.$tx.text(b);this.$bkg.attr(thrSvg.bboxToRect(this.$tx[0].getBBox()))},adjustToLineAngle:function(a){var b=thr0.lineAngle(a);a=thr0.movedPt(thr0.centeredPt(a),b+90,2E3/this.zoom);this.adjustToPt({x:a.x-1400/this.zoom,y:a.y+400/this.zoom},thr0.formatLocalFloat(Math.round(10*b)/10)+
"\u00b0")},setText:function(a){this.$tx.text(a)},clear:function(){this.$tx.remove();this.$bkg.remove()}};var u={initialize:function(a,b,c,d,e,f){a.ctx=new ga(b,f);a.startPt=a.ctx.containerPt(c);a.sd=b;a.zoom=thrSvg.getZoom(b.$svg);a.hintDelta=2E3/a.zoom;b.activeAction=a;a.changed=!1;d&&(a.conflictTestObj={type:"Diagram",id:b.diagram.id,diffData:[d]});void 0!==e&&(a.hint=new F(b,e,{x:a.startPt.x+a.hintDelta,y:a.startPt.y+a.hintDelta},a.zoom));a.hiddenElements&&$(a.hiddenElements).css("display","none")},
getPt:function(a,b,c){b=a.ctx.containerPt(b);if(!a.changed){var d=thr0.deltaVec(a.startPt,b);a.changed=10<=Math.abs(d.x)+Math.abs(d.y)}c&&a.hint.adjustToPt({x:b.x+a.hintDelta,y:b.y+a.hintDelta},c);return a.changed?b:void 0},cleanup:function(a,b,c){a.sd.activeAction=void 0;b&&b.remove();a.hint&&a.hint.clear();c&&c.forEach(function(a){a&&a.clear()});a.hiddenElements&&$(a.hiddenElements).css("display","");a.$conSkeletons&&a.$conSkeletons.forEach(function(a){a.remove()})}};S.prototype={hiddenElements:".sfsSizer, .sfsConnector, .sfsRotate, .thrSelText",
newItemPos:function(a,b,c){var d=this.sd.diagram,e={x:0,y:0},f=thr0.reverseAngle(b);b=this.i0Cpts?thr0.arrayObjByKey(this.i0Cpts,"force",c?"in":"out")||this.bestAnglePt(this.i0Cpts,c?f:b):thr0.cutFrameLine(e,f,this.i0Frame).pt;return{x:thr0.intoRange(d.width-this.i0.width,0,a.x+this.i0.x-b.x),y:thr0.intoRange(d.height-this.i0.height,0,a.y+this.i0.y-b.y)}},getLine:function(a,b){return a?[this.startPt,b]:[b,this.startPt]},snapPtAngle15:function(a){var b=thr0.angle(this.startPt,a);return(this.snappedToAngle=
2>=(b+1)%15)?thr0.movedPt(this.startPt,15*Math.round(b/15),thr0.distance(this.startPt,a)):a},getHintTx:function(a){return a?sfsEditorUI.ntx.connectedTo+" "+a:sfsEditorUI.ntx.unconnectedHint},doSnap:function(a,b){var c=this.snapInfo.beginSnap(b).snapToTarget(a).endSnap();c===b&&(c=this.snapPtAngle15(b));return c},bestAnglePt:function(a,b){return a.reduce(function(a,d){var e=thr0.absAngleDelta(d.dir,"object"===typeof b?thr0.angle(d,b):b);return e<a.d?{pt:d,d:e}:a},{pt:this.startPt,d:361}).pt},adjustStartPt:function(a,
b){if(this.itemPts){var c=thr0.arrayObjByKey(this.itemPts,"force",a?"out":"in");c||(c=this.startPt,c=!c||void 0===c.dir?thr0.closestPt(b,this.itemPts):85>thr0.absAngleDelta(c.dir,thr0.angle(c,b))?c:this.bestAnglePt(this.itemPts,b));this.startPt=c}else this.itemFrame&&(this.startPt=thr0.snapToFrame(b,this.itemFrame).pt)},move:function(a){var b=u.getPt(this,a);if(b){var c=this.snapInfo,d=this.isSource!==a.shiftKey;this.newStartPt&&(this.startPt=this.newStartPt,this.newStartPt=void 0,b=u.getPt(this,
a));if(a.ctrlKey)c.setTarget($.extend(this.newItemPos(b,thr0.lineAngle(this.getLine(d,b)),d),{width:this.i0.width,height:this.i0.height}),this);else{var e=c.targetBoundsRect(),f=this.sd.diagram;if(c.target&&c.target.con&&10<Math.abs(thr0.distanceToLine(b,c.target.l))||!e||!thr0.pointInRect(b,thr0.expandedRect(e,Math.max(50,f.snapBoxBorder+10))))e=f.itemFromPoint(b,5,!0),!e&&this.el instanceof SfsItem?e=this.sd.conStFromPoint(b,10):e===this.el&&(e=void 0),e!==c.target&&c.setTarget(e,this)}if(!a||!a.altKey)b=
this.doSnap(!d,b);this.adjustStartPt(d,b);a=this.getLine(d,b);this.angleHint.adjustToLineAngle(a);this.hint.adjustToPt({x:b.x+this.hintDelta,y:b.y+this.hintDelta});sfsEditorUI.setSnapClass(this.$connectLine.attr("d",this.getSelectorPath(a,this.snapInfo.zoom)),this.snappedToAngle)}},end:function(a,b){var c=this,d=this.sd,e=d.diagram,f=u.getPt(this,a);u.cleanup(this,this.$connectLine,[this.angleHint]);this.isSource=this.isSource!==a.shiftKey;f||(b=!0);!b&&(!a.ctrlKey&&!sfsEditorMC.canConnect(d.mc.mathEnv,
["a"+e.id],this.el,this.snapInfo.targetObj()))&&(thr0.showMsgNotifier(d,1),b=!0);if(b)sfsEditorUI.renderSelection(d);else{if(!a||!a.altKey)f=this.doSnap(!this.isSource,f);this.adjustStartPt(this.isSource,f);e.viewMode?this.doAddConnection(a,f,1/thrUnits.getFactor(e.dispUnit)):(e=(this.el instanceof SfsItem?Math.max(0,this.el.getTotalDelta(d.getMathEnv(),e,!this.isSource)):0)||(this.snapInfo.target instanceof SfsItem?Math.max(0,this.snapInfo.target.getTotalDelta(d.getMathEnv(),e,this.isSource)):1)||
1,thr0.askNotifier(d,"connectVal",function(b){b.cmd===thrUI.ntx.ok&&c.doAddConnection(a,f,b.val)},e))}this.snapInfo.cleanup()},doAddConnection:function(a,b,c){var d,e,f=this.sd,g=0;f.mc.startTransaction();if(a.ctrlKey)d=sfsEditorMC.applyAddItem(f,this.newItemPos(b,thr0.lineAngle(this.getLine(this.isSource,b)),this.isSource)),e=f.diagram.getItem(d);else if((e=this.snapInfo.target)&&e.con)g=e.stx,e=e.con;b=this.isSource?sfsEditorMC.applyAddConnection(f,this.el,this.stx,this.startPt,e,g,b,c):sfsEditorMC.applyAddConnection(f,
e,g,b,this.el,this.stx,this.startPt,c);f.mc.endTransaction();a.ctrlKey?(sfsEditorUI.select(f,{items:[d]}),a=f.$svg.find(".thrSelText"),a.length&&sfsEditorUI.startTextEdit(f,new C(a.eq(0)),"")):sfsEditorUI.select(f,{connections:[b]})},getSelectorPath:function(a,b){var c=100*this.sd.settings.selHeadSize/b,d=100*this.sd.settings.selPathWidth/b,e=thr0.lineAngle(a)+90;return thrSvg.pathFromCmds([{pt:a[0],a:e,m:d},[{pt:a[1],a:e,m:d},{a:e-90,m:-c}],{a:e,m:c-d},{pt:a[1]},{ptx:2,a:e,m:2*-c},{a:e,m:c-d},{pt:a[0],
a:e,m:-d}])+"Z"}};ha.prototype={getHintTx:function(a){return a.ctrlKey?"+":this.isEmpty?sfsEditorUI.ntx.addItemHint:""},move:function(a){this.$lassoRect.attr(thr0.deltaRect(u.getPt(this,a,this.getHintTx(a)),this.startPt))},end:function(a,b){u.cleanup(this,this.$lassoRect);if(!b){var c=this.sd,d=thr0.deltaRect(u.getPt(this,a),this.startPt);if(a.ctrlKey&&10<d.width&&10<d.height)sfsEditorUI.addItem(c,d);else if(a.altKey)sfsEditorUI.select(c,{connections:thr0.getKeyArray(c.diagram.connections,"id",function(a){return thr0.rectInRect(a.getBoundsRect(),
d)}),add:a.shiftKey});else{var e=[],f=c.diagram.items.filter(function(a){return!a.frozen&&thr0.rectInRect(a,d)});f.length?(c.diagram.items.forEach(function(a){a.groups&&0>f.indexOf(a)&&thr0.pushIfNEx(e,a.groups.split(",").pop())}),f=thr0.getKeyArray(f,"id",function(a){return!a.groups||0>e.indexOf(a.groups.split(",").pop())})):this.defaultSelObj&&(5>=d.width&&5>=d.height)&&(f=this.defaultSelObj.groups?c.diagram.itemsOfGroup(this.defaultSelObj.groups.split(",").pop()).map(function(a){return a.id}):
[this.defaultSelObj.id]);sfsEditorUI.select(c,f.length?{items:f,add:a.shiftKey}:void 0)}}}};K.prototype={snapDelta:5,way:2,selectorId:function(a,b){return"sfs"+this.sd.id+"SC"+this.con.id+(b?"_pt":"_st")+a},showNewPt:function(){var a,b=this.con,c=this.isNewEndPt?b.nextPtStx(this.ptx):this.stxNewPt,c=b.stretches[c],d=b.points.length,e=void 0!==b.points[c.a].itemId?c.a:c.b;void 0!==b.points[e].itemId&&(this.ptx2=e===c.a?c.b:c.a);if(a=this.conRenderer.getPt(e,!1))if(a=thr0.deltaVec(a,b.points[e]),a.x||
a.y)this.offset=a;this.isNewEndPt?this.startPt=this.conRenderer.getPt(this.ptx,!1):this.ptx=d;b.points.push({x:this.startPt.x,y:this.startPt.y,way:2});b.stretches.push({a:c.a,b:d});c.a=d;this.conRenderer.con=b;this.sd.activeAction=void 0;this.conRenderer.prepareRenderInfo(this.sd.getMathEnv(),[]);this.conRenderer.forceSmallHandles=!0;sfsEditorUI.renderSelection(this.sd,this.conRenderer);this.conRenderer.forceSmallHandles=!1;this.sd.activeAction=this;this.$selPt=$("#"+this.selectorId(this.ptx,!0));
this.initSnapInfo();this.sd.$svg.find(".sfsNewRoutePt").remove();this.stxNewPt=void 0},initSnapInfo:function(a){function b(a,b,c){a.stx.push(b);a.$selSt.push($("#"+a.selectorId(b,!1)));c&&a.angleHint.push(a.conRenderer.isCombiSequel(b)?void 0:new F(a.sd,"0\u00b0",void 0,a.zoom))}var c=[],d=this.conRenderer;if(this.alignedPts)this.alignedPts.forEach(function(a){c.push(a.ptx);b(this,a.stx);a.$pt=$("#"+this.selectorId(a.ptx,!0));a.adjacentStx.forEach(function(a){b(this,a)},this)},this);else for(var e=
this.con.nextPtStx(this.ptx,0);0<=e;e=this.con.nextPtStx(this.ptx,e+1))b(this,e,!0),c.push(this.con.otherStPt(e,this.ptx));this.snapStx=[];c.push(this.ptx);this.snapInfo=(new H).initFromConnection(this.sd,d.con,c);a&&this.snapInfo.setTarget(a,this,d.isCombiPt?thr0.deltaVec(d.getPt(this.ptx,!1),d.getPt(this.ptx,!0)):void 0);2>this.way&&(this.hint=new F(this.sd,this.getHintTx(this.snapInfo.targetCaption()),{x:this.startPt.x+this.hintDelta,y:this.startPt.y+this.hintDelta},this.zoom))},getHintTx:function(a){return a?
sfsEditorUI.ntx.connectedTo+" "+a:sfsEditorUI.ntx.unconnected},findOrthoAlignments:function(a){function b(a,c,d,e,f,g){var n,p,o={stx:e,ptx:f,dim:g?"x":"y",adjacentStx:[]};d.push(o);for(n=a.nextPtStx(f,0);0<=n;n=a.nextPtStx(f,n+1))n!==e&&(p=c.getStretchLine(n,!0),g&&thr0.isVertical(p)||!g&&thr0.isHorizontal(p)?b(a,c,d,n,a.otherStPt(n,f),g):o.adjacentStx.push(n))}if(void 0!==a.itemId){a=this.con;var c=this.conRenderer,d=a.nextPtStx(this.ptx,0),e=a.otherStPt(d,this.ptx);if(!a.points[e].itemId){var f=
c.getStretchLine(d,!0),g=thr0.isVertical(f);if(g||thr0.isHorizontal(f))this.alignedPts=[],b(a,c,this.alignedPts,d,e,g),this.alignedPts.length||(this.alignedPts=void 0)}}},findSnapStretch:function(a){if(2<=this.way)for(var b=0;b<this.con.stretches.length;b++)if(0>this.stx.indexOf(b)&&thr0.distanceToLine(a,this.conRenderer.getStretchLine(b,!0))<=this.snapDelta)return b},doSnap:function(a){var b,c,d,e,f,g=this.snapInfo;b=this.findSnapStretch(a,this.snapDelta,this.stx);g.beginSnap(a);this.snapStx=[];
2<=this.way&&void 0!==b?(this.snapStx.push(b),d=this.con.stretches[b],g.addSnapData(this.conRenderer.getStretchLine(b,!0))):2>this.way&&g.target instanceof SfsItem&&g.snapToTarget(0===this.way);g.snapToLine(!0);if(!this.alignedPts)for(b=0;b<this.stx.length&&g.canSnapToLine();b++)c=this.con.stretches[this.stx[b]],this.conRenderer.isCombiSequel(this.stx[b])||d&&(c.a===d.a||c.a===d.b||c.b===d.a||c.b===d.b)||(c=c.a===this.ptx?this.conRenderer.getPt(c.b,!1):this.conRenderer.getPt(c.a,!1),e=thr0.angle(c,
a),f=(e+1)%15-1,2>f&&(e-=f,g.addSnapData(thr0.getLine(c,e,1E4),void 0,e)&&this.snapStx.push(this.stx[b])));this.snapStx.forEach(function(a){sfsEditorUI.setSnapClass($("#"+this.selectorId(a,!1)),!0)},this);return g.endSnap(!0)},getMovedPt:function(a){return thr0.movedPtDelta(this.isNewPt?void 0!==this.ptx?this.con.points[this.ptx]:this.startPt:this.conRenderer.getPt(this.ptx,!1),a)},getChangedPt:function(a,b,c){return a===this.ptx?b:this.alignedPts&&!c&&(c=thr0.arrayObjByKey(this.alignedPts,"ptx",
a))?"x"===c.dim?{x:b.x,y:this.conRenderer.getPt(a,!1).y}:{x:this.conRenderer.getPt(a,!1).x,y:b.y}:this.conRenderer.getPt(a,!1)},deletePt:function(){var a,b,c=this.sd,d=c.diagram;(a=sfsEditorMC.getCombiInfo(d,this.con,this.ptx))&&a.item&&!a.isItemPoint?thr0.showMsgNotifier(c,2,[a.isInput?sfsEditorUI.ntx.inbound:sfsEditorUI.ntx.outbound,a.item.denom()]):(a=this.con.points[this.ptx],b=this.con.canDeleteEndPtSt(this.ptx),!b&&2>a.way&&1===this.con.countWayPoints(a.way)?sfsEditorMC.applyDelete(c,this.con):
1<a.way||b||sfsEditorMC.canDeletePt(c.mc.mathEnv,["a"+d.id],this.con,this.ptx)?sfsEditorMC.applyDeleteConPt(c.mc,d,this.con,this.ptx,b):sfsEditorUI.thr0(c,1))},move:function(a){var b=u.getPt(this,a);if(b){var c=this.getMovedPt(thr0.deltaVec(this.startPt,b));void 0!==this.stxNewPt&&this.showNewPt();this.snapStx.forEach(function(a){sfsEditorUI.setSnapClass($("#"+this.selectorId(a,!1)),!1)},this);if(2>this.way){var d=this.snapInfo.targetBoundsRect(),e=this.sd.diagram;(!d||!thr0.pointInRect(b,thr0.expandedRect(d,
Math.max(50,e.snapBoxBorder+10))))&&this.snapInfo.setTarget(e.itemFromPoint(b,5,!0),this)}if(!a||!a.altKey)c=this.doSnap(c);this.hint&&this.hint.adjustToPt({x:c.x+this.hintDelta,y:c.y+this.hintDelta});this.$selPt.attr({cx:c.x,cy:c.y});this.alignedPts&&this.alignedPts.forEach(function(b){var d=this.getChangedPt(b.ptx,c,a.altKey);b.$pt.attr({cx:d.x,cy:d.y})},this);this.stx.forEach(function(b,d){var e=[this.getChangedPt(this.con.stretches[b].a,c,a.altKey),this.getChangedPt(this.con.stretches[b].b,c,
a.altKey)];this.$selSt[d].attr("d",this.conRenderer.getStretchPath(b,this.snapInfo.zoom,e));this.angleHint.length>d&&this.angleHint[d]&&this.angleHint[d].adjustToLineAngle(e)},this);sfsEditorUI.setSnapClass(this.$selPt,this.snapInfo.target)}},end:function(a,b){var c,d=this.snapInfo,e=this.sd,f=e.diagram,g=u.getPt(this,a),h=this.con.points[this.stxNewPt?0:this.ptx];u.cleanup(this,void 0,this.angleHint);g?c=thr0.deltaVec(this.startPt,g):(!b&&(!this.isNewPt&&1E3>new Date-this.dt)&&this.deletePt(),b=
!0);if(!b&&(0!==c.x||0!==c.y)&&this.con){c=this.getMovedPt(c);if(!a||!a.altKey)c=this.doSnap(c);b||(g=void 0===h.itemId?void 0:f.getItem(h.itemId),d.target!==g&&!sfsEditorMC.canChangeConnection(e,["a"+f.id],this.con,this.ptx,d.target)&&(thr0.showMsgNotifier(e,1),b=!0));b||(f=this.snapStx.length&&0>this.stx.indexOf(this.snapStx[0])?this.snapStx[0]:void 0,this.conRenderer.prepareSetPt(this.ptx,c,!1),this.offset&&(thr0.addXY(c,this.offset),void 0!==this.ptx2&&(g=this.conRenderer.rPt[this.ptx2].pt)&&
thr0.setXYFromPt(this.con.points[this.ptx2],g)),b=!sfsEditorMC.applyMoveConPt(e,this.con,c,this.ptx,f,d.target,this.isNewPt,a.altKey?void 0:this.alignedPts,$.extend({},c)))}else b=!0;b&&sfsEditorUI.renderSelection(e);this.snapInfo&&this.snapInfo.cleanup()}};L.prototype={adjustPosInd:function(a){if(!this.hidePosInd){a=thr0.movedRect(this.bounds,a.x,a.y);var b=thr0.rectCenter(a),c=this.posInd,d=500/this.zoom;c[0].adjustToPt({x:b.x-2*d,y:Math.max(a.y-2*d,3*d)},Math.round(a.y).toString());c[1].adjustToPt({x:Math.max(a.x-
6*d,d),y:b.y+d},Math.round(a.x).toString());c[2].adjustToPt({x:b.x-2*d,y:Math.min(a.y+a.height+4*d,this.sd.diagram.height-2*d)},Math.round(a.y+a.height).toString());c[3].adjustToPt({x:Math.min(a.x+a.width+d,this.sd.diagram.width-7*d),y:b.y+d},Math.round(a.x+a.width).toString())}},move:function(a){var b=u.getPt(this,a);if(b){var c=thr0.deltaVec(this.startPt,b),d=this.selTransform;this.snapInfo&&(this.snapInfo.setStandBy(!a.ctrlKey),c=this.snapInfo.doSnap(this.bounds,c,[1,1,1,1,1,1],a.altKey));this.$selectors.each(function(a){$(this).attr("transform",
"translate("+c.x+","+c.y+") "+d[a])});this.hint.adjustToPt({x:b.x+this.hintDelta,y:b.y+this.hintDelta},a.ctrlKey?"+":"");this.adjustPosInd(c);this.icInfo&&(a.ctrlKey?this.$conSkeletons&&this.$conSkeletons.forEach(function(a){a.attr("d","")}):(this.icInfo.allMovedDelta=c,this.$conSkeletons=sfsEditorUI.renderConSkeletons(this.sd,this.icInfo,sfsEditorMC.getDiffMoveItems(this.icInfo,this.objs),this.$conSkeletons)))}},end:function(a,b){var c,d,e=this.sd,f=e.mc,g=e.diagram,h=u.getPt(this,a),i=this.selTransform;
u.cleanup(this,void 0,this.posInd);this.$selectors.each(function(a){$(this).attr("transform",i[a])});if(!h&&!b){if(this.isConTag&&this.mouseInfo&&this.mouseInfo.isSelector&&1E3>new Date-this.dt)sfsEditorMC.applyDeleteTag(f,g,g.getConnection(this.mouseInfo.id),this.mouseInfo.subId,this.mouseInfo.subType);else if(!this.isText&&(1!==this.objs.length||!this.objs[0].hiddenShape)){var h=e.$getGroup("B").add(e.$getGroup("S")).css("display","none"),j=document.elementFromPoint(this.e0.clientX,this.e0.clientY);
if(j&&j!==e.$svg[0]){var j=new C($(j)),k=j.getObj();k&&(!(k instanceof SfsDiagram)&&0>this.objs.indexOf(k))&&sfsEditorUI.select(e,j.toSelSpec())}h.css("display","")}b=!0}else b||(d=thr0.deltaVec(this.startPt,h));!b&&this.snapInfo&&(this.snapInfo.setStandBy(!a.ctrlKey),this.snapInfo.doSnap(this.bounds,d,[1,1,1,1,1,1],a.altKey));if(!b&&(0!==d.x||0!==d.y||a.ctrlKey))if(this.isLegend)sfsEditorMC.applyMovePropObj(f,g,d,"legend");else if(this.isConTag)sfsEditorMC.applyMoveConTag(f,g,this.objs[0],this.mouseInfo.subType,
this.mouseInfo.subId,thrSvg.bboxToRect(this.$selectors[0].getBBox()),d,function(a,b,d){if(b===d)return{x:0,y:0};c=e.findConRenderer(a.id);return thr0.movedPtDelta(thr0.deltaVec(thr0.centeredPt(a.getStretchLine(b)),thr0.centeredPt(c.getStretchLine(b))),thr0.deltaVec(thr0.centeredPt(c.getStretchLine(d)),thr0.centeredPt(a.getStretchLine(d))))});else if(this.isText)sfsEditorMC.applyMoveItemText(e,this.objs[0],d);else if(a.ctrlKey){var l=g.nextItemId;sfsEditorMC.applyPaste(f,g,sfsEditorMC.getObjCopies(e,
this.objs,d));sfsEditorUI.select(e,{items:thr0.getKeyArray(g.items,"id",function(a){return a.id>=l})})}else this.icInfo.allMovedDelta=d,e.mc.applyDiff(g.objSpec(),sfsEditorMC.getDiffMoveItems(this.icInfo,this.objs));this.snapInfo&&this.snapInfo.cleanup();this.$tempCreated&&this.$tempCreated.remove();this.$tempHidden.css("display","")}};T.prototype={startPt:{x:0,y:0},bounds:{x:0,y:0,width:0,height:0},hiddenElements:".sfsSizer, .sfsConnector, .sfsRotate, .thrSelText",minWidth:0,minHeight:0,adjustSizeInd:function(a){a=
thr0.sizedRect(this.bounds,a,this.bounds,this.szType,1);this.sizeInd.adjustToPt(thr0.movedPtDelta(a.cPt||thr0.rectCenter(a),{x:-this.hintDelta,y:this.hintDelta/4}),Math.round(a.width)+" x "+Math.round(a.height))},assertWHRatio:function(a,b,c){var d,e=this.szType;thr0.szLeft[e]&&(a.x=-a.x);thr0.szTop[e]&&(a.y=-a.y);d=thr0.sizedRect(this.bounds,a,this.bounds,e,1);(void 0===c?d.width>d.height*b:c)?a.x=d.height*b-this.bounds.width:a.y=d.width/b-this.bounds.height;thr0.szLeft[e]&&(a.x=-a.x);thr0.szTop[e]&&
(a.y=-a.y)},ptDeltaToSizeDelta:function(a,b){var c,d,e=this.szType,f=!(e&1)&&(b.shiftKey||b.ctrlKey),g=b.shiftKey?1:this.origWHRatio;f&&(this.assertWHRatio(a,g),c=a.x,d=a.y);this.snapInfo&&(this.snapInfo.doSnap(this.bounds,a,this.snapRelevants,b.altKey,f),f&&(c!==a.x||d!==a.y)&&this.assertWHRatio(a,g,d!==a.y));thr0.szLeft[e]&&(a.x=-a.x);thr0.szTop[e]&&(a.y=-a.y)},setSelRect:function(a,b){b.rot&&($(this.$selectors[a]).parent().attr("transform",thrSvg.strRotate(b.rot,b.cPt)),b={x:b.x,y:b.y,width:b.width,
height:b.height});$(this.$selectors[a]).attr(b)},move:function(a){var b=u.getPt(this,a);if(b){b=thr0.deltaVec(this.startPt,b);this.ptDeltaToSizeDelta(b,a);for(a=0;a<this.$selectors.length;a++)this.setSelRect(a,thr0.sizedRect(this.selRects[a],b,this.bounds,this.szType,this.objs.length>a?this.objs[a].minSize:1));this.adjustSizeInd(b);this.icInfo&&(this.icInfo.allSizedDelta=b,this.$conSkeletons=sfsEditorUI.renderConSkeletons(this.sd,this.icInfo,sfsEditorMC.getDiffSizeItems(this.icInfo,this.objs),this.$conSkeletons))}},
end:function(a,b){var c;u.getPt(this,a)||(b=!0);b||(c=thr0.deltaVec(this.startPt,this.ctx.containerPt(a)),this.ptDeltaToSizeDelta(c,a));this.selRects.forEach(function(a,b){this.setSelRect(b,a)},this);u.cleanup(this,void 0,[this.sizeInd]);this.snapInfo&&this.snapInfo.cleanup();if(!b&&(0!==c.x||0!==c.y)){var d=this.sd,e=d.diagram;this.isLegend?sfsEditorMC.applySizePropObj(d.mc,e,thr0.sizedRect(e.legend.getBoundsRect(),c,this.bounds,this.szType,e.legend.minSize),"legend"):this.isText?sfsEditorMC.applySizeItemText(d,
this.objs[0],c,this.bounds,this.szType):(this.icInfo.allSizedDelta=c,d.mc.applyDiff(e.objSpec(),sfsEditorMC.getDiffSizeItems(this.icInfo,this.objs)))}}};ia.prototype={startPt:{x:0,y:0},hiddenElements:".sfsSel, .thrSelText, .sfsSizer, .sfsConnector, .sfsRotate",getPreviewPath:function(a){return"M"+this.previewPts.map(function(a,c){var d=thr0.movedPt(a,this.dir,(1===c||4===c?0:this.d)+(3>c?this.d0:-this.d0));return d.x+","+d.y},{dir:this.dir,d:-this.size*Math.tan((180-a)*thr0.deg2rad/2),d0:2.5/Math.sin(a*
thr0.deg2rad/2)}).join("L")+"Z"},getArrowAngle:function(a,b){var c=thr0.closestLinePt(a,this.cLine,!0),d=thr0.normalizeAngle(this.dir-thr0.lineAngle([c,a]));return 90>=d||270<=d?180:thr0.roundAngle(Math.max(20,2*Math.atan2(this.size,thr0.distance(c,a))/thr0.deg2rad),b)},move:function(a){var b=u.getPt(this,a);b&&(a=this.getArrowAngle(b,!a.altKey),this.hint.adjustToPt({x:b.x+30,y:b.y-5},thr0.formatLocalFloat(a)+"\u00b0"),this.$arrowAngle.attr("d",this.getPreviewPath(a)))},end:function(a,b){var c=u.getPt(this,
a),d=this.sd;this.$arrowAngle.remove();u.cleanup(this);!b&&c&&sfsEditorMC.applyArrowAngle(d,this.obj,this.getArrowAngle(c,!a.altKey))}};ja.prototype={startPt:{x:0,y:0},hiddenElements:".thrSelText, .sfsSizer, .sfsConnector, .sfsRotate",getRotation:function(a,b){return thr0.roundAngle(thr0.normalizeAngle(this.rot+this.startAngle-thr0.angle(this.cPt,a)),b)},move:function(a){var b=u.getPt(this,a);if(b){a=this.getRotation(b,!a.altKey);var b=thrSvg.strRotate(a,this.cPt),c=this.hintDelta/2;this.hint.adjustToPt({x:this.startPt.x-
c,y:this.startPt.y-c},thr0.formatLocalFloat(a)+"\u00b0");this.$sel.attr("transform",b);this.$b.attr("transform",b);this.icInfo.allRotate=a-this.rot;this.$conSkeletons=sfsEditorUI.renderConSkeletons(this.sd,this.icInfo,sfsEditorMC.getDiffRotate(this.icInfo,this.objs),this.$conSkeletons)}},end:function(a,b){var c=u.getPt(this,a);this.rot?this.$sel.attr("transform",thrSvg.strRotate(this.rot,this.cPt)):this.$sel.removeAttr("transform");this.$b.removeAttr("transform");u.cleanup(this);!b&&c&&(this.icInfo.allRotate=
this.getRotation(c,!a.altKey)-this.rot,this.sd.mc.applyDiff(this.sd.diagram.objSpec(),sfsEditorMC.getDiffRotate(this.icInfo,this.objs)))}};o.sfsGUI={disabledCmds:[],$workingArea:void 0,sd:void 0,savedDiagramFormExpdTables:[],designTab:0,promoIx:-1,dbConfig:{dbName:"sfs",vnr:2,objTypes:[{name:"Diagram",initialData:{}},{name:"Userform"},{name:"Scenarioenv"}],simpleTables:[{name:"shapes",isSysTable:!0},{name:"images"},{name:"imgCache"},{name:"resCache",isSysTable:!0}]},ntx:{openDiag:"Open diagram",create:"Create",
remove:"Remove",continue_:"Continue",removeLevel:"Remove level",closeDiag:"Close diagram",closeApp:"Close the app",connect:"Connect",add:"Add",value:"Value",multipleValues:"(multiple values)",scale:"Scale",inputs:"Inputs",outputs:"Outputs",unit:"unit",untitled:"Untitled",item:"Item",name:"Name",comment:"comment",subtitle:"Attractive flow diagrams made in minutes",newDiag:"New diagram",createNewDiag:"Create a new diagram",createIn:"Create in",openADiag:"Open a diagram",manageDiags:"Manage my diagrams",
saveRevCopy:"Save a copy of this revision",saveIn:"Save in",saveSuccess:"Successfully saved",copyOf:"Copy of",copyFailed:"Copy failed",uploadFile:"Upload file",uploadTo:"Upload to",export_:"Export",expToGD:"Export to Google Drive",fmt:"Format",res:"Resolution",dest:"Destination",screenRes:"Screen (160dpi)",printRes:"Print (300dpi)",fmtSankey:"Native data format for sankey diagram data",fmtSvg:"XML based vector graphics file format supported by all major modern web browsers. As the name tells, svg images are scalable without pixel effects. SVG is a very memory efficient format.",
fmtPng:"Raster graphics file format with lossless data compression and a possible alpha channel.",fmtJpg:"Raster graphics file format with lossy data compression without an alpha channel.",fmtPdf:"File format used to present documents in a manner independent of application software, hardware and operating systems.",fmtHintSankey:"Use this format, if you want to create a backup on your local computer or somewhere else. At a later time you can upload the .sankey file to edit it again with Sankey Flow Show.",
fmtHintSvg:"Use this format, if you want to embed it into html or if your target application (e. g. text processing) supports svg.",fmtHintPng:"Use this format, in case that your image contains transparent areas or areas with an opacity lower than 100 %.",fmtHintJpg:"Use this format, in case that your image contains no transparent areas and no areas with an opacity lower than 100 % and if you need smaller files than png.",fmtHintPdf:"Use this format, i.e. for communication with other persons. - TIP TIP TIP: Most modern browsers have a way to 'Print as PDF'. This option is faster and often produces better results. Try it: Menu -\x3e Print",
selFolderFor:"Select folder for",revision:"Revision",noChange:"No change.",link:"Link",visible:"visible",hidden:"hidden",publish:"Publish",published:"Published",unpublish:"Cancel publication",unpublished:"Unpublished",publishTitle:"Publish (interactive) diagram",pubStatus:"Current state of publication",pubDate:"Publication date",pubSample:"Sample code to embed in your web page",pubTabForm:"Tab 'input form'",pubTabScenarios:"Tab 'scenarios'",pubTabMore:"Tab 'print \x26 download'",loading:"loading ...",
cons:"Connections",total:"Total",params:"Parameters",addParam:"Add parameter",editForm:"Edit form",scenarios:"Scenarios",activeScenario:"Active Scenario",deactScenario:"Deactivate scenario",selScenario:"Select a scenario",saveRev:"Save revision",unsavedChangesHint:"The diagram was changed in the current session. Do you want to save the changes in a new revision?",removeRev:"Remove this revision",removeOlderRevs:"Remove older revisions",confirmRemoveRevs:"revision(s) will be removed finally. Please confirm!",
revLimitReached:"Limit of revision history reached.",clearRevs:"Clear revision history",urgentMsg:"Urgent message",message:"Message",unknownDate:"Unknown date",unknownEditor:"Unknown editor",shareDiag:"Share my diagram",sharedView:"Shared with permission to view.",notOwner:"You are not the owner",notOwnerHint:"A diagram can be shared just by its owner.",notShared:"Private only to me",sharedWith1:"Shared with",sharedWith2:"others",serverConnLost:"Server connection terminated",serverConnLostHint:"The connection to server has been terminated (30 min of no activity or logout in another tab or connection problem with server). Please restart the application!",
welcomeToSfs:"Welcome to Sankey Flow Show!",uploadFailExt1:"Upload failed: Extension of",uploadFailExt2:"is not '.sankey'!",uploadFailData1:"Upload failed:",uploadFailData2:"contains no valid diagram data!",downloadMsg:"The download will start in a moment.",gExportMsg:"The exported file will be available on your Google Drive\u2122 in a moment.",selObjBeforeFuncHint:"Please select one or more items/connections before you use this function.",paintedMsg:"Painted current selection to default.",extStore:"External storage provider",
extStoreHint:"Please use the app of the storage provider to share your diagram: Google Drive\u2122.",localStore:"Local browser database",localStoreHint:"Locally stored diagrams can't be shared.",changeViewMode:"Change view mode",conWidth:"Connection width",readOnly:"Read only mode",readOnlyHint:"Changes cannot be applied in read only mode!",autoCalcVal:"Automatically calculated value",autoCalcValHint:"Your change cannot be applied! Possible solution: Set a dependent item to 'auto adustable'.",requiredPt:"Required point",
requiredPtHint:"Please deactivate the combination of #sfs1 connections from item '#sfs2' before you delete this point.",autoDepCalc:"Automatic dependency calculation",unchangable:"is not changable!",autoDepCalcHint:"Possible solution: Set a dependent item to 'auto adustable'.",invalidMathExpr:"Invalid mathematical expression",formulaNotApp:"Formula not applicable",circularRef:"Unresolvable circular reference:",delRefParam:"Delete referenced parameter",delRefParamHint:"ATTENTION: You try to delete one ore many referenced parameters.",
delRefHint2:"References will be replaced by the respective parameter values.",notApplicable:"Changes not applicable",notApplicableHint:"The changes can not be accepted. Please check the logical and mathematical dependencies in the diagram.",wizIO:"Create In-Out item",wizProdCon:"Create producers vs. consumers",wizCompare:"Create comparison",wizDrillDown:"Create drill down tree",wizMeshed:"Create meshed columns",column:"Column",alternative:"Alternative",compare:"Compare",benchmark:"Benchmark",myData:"My data",
addCol:"Add column",removeLastCol:"Remove last column",level:"Level",levelName:"Level name",addLevel:"Add level",conOrder:"Sort orcer",conOrdHint:"The order only affects COMBINED incoming and outgoing connections and is clockwise: So connections left from bottom to top, connections right from top to bottom.",errUnexpected:"An unexpected error occured",errImportLines:"The following lines could not be mapped:",promoTexts:["Get more features!","Remove license restrictions!","Do you like Sankey Flow Show?"]},
notifyNtxChanged:function(){this.mc&&(!this.mc.file&&sfsEditorUI.isReadonly(this.sd))&&this.setReadonlyStatus()},fileCreateLimit:function(){return thr0.isLicensed("unlimitedFiles")?99999:10},checkFuncAvail:function(a){(a=thr0.isLicensed(a))||thrUI.dialog.showLicenseRestriction();return a},initState:{},init:function(a){var b="sfsPro sfsSPro sfsPublish sfsSPublish sfsAdmin sfsDev".split(" "),c=new SfsModelController;thrNtx.register(sfsGUI);thr0.addNotifier(sfsGUI);thr0.thrSysId=1;thr0.funcLicenses=
{unlimitedFiles:b,showWizard:b,cloudStore:b,mathFormulas:b,userform:b,scenarios:b,logicalDependencies:b,diagSize:b,hideBrand:["sfsPro","sfsPublish","sfsAdmin","sfsDev"],publish:["sfsPublish","sfsSPublish","sfsAdmin","sfsDev"]};$("#SITE_HEADER .thrSubject\x3espan").text(this.ntx.subtitle).click(function(){sfsGUI.cmdRenameCurrent()});thr0.setSignedIn(!0);thr0.initUserInfo();thr0.startPing();thrUI.registerShortCut(90,!1,!0,!1,function(){sfsGUI.cmdUndo()});thrUI.registerShortCut(89,!1,!0,!1,function(){sfsGUI.cmdRedo()});
thrUI.form.initialize($("#SITE_SIDEBAR\x3ediv"),function(a,b,c,g,h){return sfsGUI.formChangesAllowed(a,b,c,g,h)},function(a,b,c,g,h){return sfsGUI.notifyFormChange(a,b,c,g,h)},function(a,b,c){"dgrm"===b&&sfsGUI.savDiagramDataFormSettings(c)},function(a,b,c){"shapes"===a&&(a=c.find("\x3ediv[data-control\x3dshapePickerPanel]"),/^item$/i.test(b)?a.data("prop","shape.uuid").data("prop1","hiddenShape"):(a.removeData("prop").removeData("prop1"),thrUI.shapePickerPanel.fill(a,void 0,0),thrUI.shapePickerPanel.fill(a,
!1,1)))});thrUI.form.addToCache("dataDiagram","mathEnv",function(){return sfsGUI.getDiagramDataForm()});thrUI.devTools=thrUI.devTools.concat([{caption:"Dump model",onclick:'sfsGUI.cmdDoExport("diagram");'},{caption:"Dump rawFile",onclick:'sfsGUI.cmdDoExport("rawFile");'},{caption:"Dump session revisions",onclick:'sfsGUI.cmdDoExport("sessionRevs");'},{caption:"Dump undo diffs",onclick:'sfsGUI.cmdDoExport("undoDiffs");'},{caption:"Dump math environment",onclick:'sfsGUI.cmdDoExport("mathEnv");'}]);this.chatMessages=
[];this.mc=c;thrRevisioning.init(c.getKeyAdmin({content:"id",c:"id",scenarios:"id",vals:"id",attrs:"id"}),c.getObjFactory({userforms:function(){return new ThrUserform},content:function(){return new ThrUserformElement},c:function(){return new ThrUserformElement},scenarioenvs:function(){return new ThrScenarioEnvironment},scenarios:function(){return new ThrScenario}}));thrDatastore.init(this.dbConfig,function(){thrShapes.init(function(){sfsGUI.setInitState("dbOk",!0)})},function(a){a?thrUI.dialog.show(sfsGUI.ntx.errUnexpected,
function(){thr0.signOut(1)},0,a):thr0.signOut(1)});this.$workingArea=a.focus(function(){thrUI.hideDropdowns()}).keydown(function(a){sfsEditorUI.keydown(sfsGUI.sd,a,sfsGUI.startTyping)});this.sd=sfsSvgDiagram.newDiagram(a,c);sfsEditorUI.init(this.sd);$("#sfsChatMsg").keydown(function(a){if(13===(a.keyCode||a.which))sfsGUI.cmdSendChatMsg($("#sfsChatMsg").val()),$("#sfsChatMsg").val(""),a.preventDefault()});$("body").keydown(function(a){!$(a.target).is("input, textarea")&&8===(a.keyCode||a.which)&&a.preventDefault()});
$(o).resize(function(){sfsGUI.resize()});this.notifyFileClosed();this.setInitState("guiOk",!0)},setInitState:function(a,b){var c=this.initState,d=c.userOk&&c.guiOk&&c.dbOk;c[a]=b;!d&&(c.userOk&&c.guiOk&&c.dbOk)&&this.notifyInitialized()},finish:function(){this.promoteIntervall&&clearInterval(this.promoteIntervall);this.mc.closeFile();thrDatastore.finish();sfsEditorUI.finish();sfsSvgDiagram.disposeDiagram(this.sd);this.sd=void 0;$(".thrDetailsForm").each(function(){thrUI.form.finalize($(this))});thrUI.form.clearCache();
thrUI.unregisterShortCuts();thr0.removeNotifier(sfsGUI);thrNtx.unregister(sfsGUI)},renderRevisionHistory:function(a){function b(a,b){return _h.tag("p",_h.tag("strong",a.dt?thr0.formatDateTime(new Date(a.dt)):sfsGUI.ntx.unknownDate)+"\x3cbr /\x3e"+_h.tag("small",a.userName||sfsGUI.ntx.unknownEditor),{"class":"thrClickable"+(b?" thrSelected":""),"data-pos":a.pos})}var c,d=this.sd.activeRev,e=this.mc.file,f=$("#sfsDoneHistory").empty(),g=$("#sfsRevisionHistory").empty();if(a){if(e&&g.length){c=$.extend([],
e.metaSesRevs);e.removeUndoneMetas(c);if(!f.parent().hasClass("thrCollapsed")){a=d?d.done:c.length-1;var h=void 0!==a&&0<=a&&a<c.length?c[a].pos:-1;a=c.length?c.map(function(a){return b(a,a.pos===h)}).reverse().join(""):_h.tag("p",_h.tag("strong",this.ntx.noChange));f.empty().append(a)}g.parent().hasClass("thrCollapsed")||e.loadlazyRevList(0,function(a){var e=d?d.history:c.length?-1:a.metaRevs[a.metaRevs.length-1].pos;g.append(a.metaRevs.map(function(a){return b(a,a.pos===e)}).reverse().join(""))})}}else thrUI.accordeon.expand(f.parent().parent(),
f.parent())},showRevision:function(a,b){this.resetPaintFormat();if(this.mc&&this.mc.file){var c=this;this.mc.file.isHeadRevision(a,!0)&&(a=void 0);this.setReadonlyStatus(a?b.html():void 0,a);this.sd.setDiagram(1,a,function(){c.notifyFileChange({file:c.mc.file,hint:"initShowRev"});c.siteLayout()})}},revisionClick:function(a){var b=$(a.target).closest("p"),c=b.data("pos");void 0!==c&&($(a.currentTarget).parent().parent().find(".thrSelected").removeClass("thrSelected"),b.addClass("thrSelected"),this.showRevision("sfsRevisionHistory"===
a.currentTarget.id?{history:c}:{done:c},b))},setTouchMode:function(a){var b=this.sd.$svg.parent();this.sd.$svg.css("touch-action",a?"":"none");b.find(".thrSelected").removeClass("thrSelected");sfsEditorUI.touchMode=a;$(b.find(".thrIconButton").get(a)).addClass("thrSelected")},touchmodeControlVisible:function(a){var b=this.sd.$svg.parent();b.find(".thrTouchmode").length?a||b.remove():a&&b.append("\x3cdiv class\x3d'thrTouchmode' style\x3d'position: absolute; bottom: 0; left: 0;'\x3e\x3cdiv class\x3d'thrIconButton' onclick\x3d'sfsGUI.setTouchMode(0);'\x3e"+
_h.icon(98)+"\x3c/div\x3e\x3cbr/\x3e\x3cdiv class\x3d'thrIconButton' onclick\x3d'sfsGUI.setTouchMode(1);'\x3e"+_h.icon(99)+"\x3c/div\x3e\x3c/div\x3e")},setScrolltype:function(a){localStorage.sfsScrolltype=a;this.touchmodeControlVisible(a);a&&this.setTouchMode(0)},detectScrolltype:function(){var a=this.sd.$svg,b=a.parent()[0],c=b.getBoundingClientRect();a.height()>c.height?this.setScrolltype(c.width-2<=b.clientWidth?1:0):a.width()>c.width&&this.setScrolltype(c.height-2<=b.clientHeight?1:0)},siteLayout:function(){var a=
this.sd.$svg.parent(),b=this.sd.$svg,c=$("#SITE_MAIN"),d=$("#SITE_SIDEBAR"),e=$("#SITE_NAVIGATION"),f=o.innerHeight,g=o.innerWidth,h=thrUI.elementsHeight(c.parent().children().not("#SITE_MAIN"))+thrUI.elementsHeight(c.find("\x3e.thrButtonBar")),c=f-h,i=e.hasClass("thrCollapsed")?0:200,j=g-(d.hasClass("thrCollapsed")?0:300)-i,k=Math.round((j-b.outerWidth())/2),l=Math.round((c-b.outerHeight())/2);thrUI.setElementDisplay($("#SITE_HEADER .thrTitle"),480<g);a.css({height:c,width:j,left:i+"px"});b.css({"margin-left":0<
k?k+"px":"0","margin-top":0<l?l+"px":"0"});d.each(function(){thrUI.setElementSubHeight($(this),f-h,"height")});e.each(function(){thrUI.setElementSubHeight($(this).find("div"),f-h)});$(".thrDialog").each(function(){thrUI.dialog.center($(this))});this.sd.diagram?(a=localStorage.sfsScrolltype,void 0!==a?(a=parseInt(a,10),this.touchmodeControlVisible(a),a&&this.setTouchMode(0)):this.detectScrolltype()):this.touchmodeControlVisible()},resize:function(){var a=o.innerWidth;$("#SITE_SIDEBAR");580>a?sfsGUI.navVisiblilty(!1):
this.siteLayout()},startTyping:function(){var a=$("#SITE_SIDEBAR"),b=a.find("\x3ediv:first-child");thrUI.accordeon.expand(a,b);thrUI.tabpanel.activateTabNo(b.find(".thrTabpanel"),0);b.find("\x3ediv").find("input[type\x3dtext], textarea").first().focus().select()},updateCmdEnableState:function(){function a(a,b,c){var g=$(".thr"+thr0.firstCharToUpperCase(b));c?(g.removeClass("thrDisabled"),thr0.removeFromArray(a.disabledCmds,b)):(g.addClass("thrDisabled"),thr0.pushIfNEx(a.disabledCmds,b))}var b=this.mc.file,
c=!sfsEditorUI.isReadonly(this.sd)||sfsEditorUI.findInReadonlyHint(this.sd,".sfsScenarioView").length;a(this,"undo",b&&0<=b.undoIx&&c);a(this,"redo",b&&0<=b.redoIx&&c);a(this,"open",b&&c)},autoLoad:function(a){"opengdrivefile"===a.cmd?a.ff&&a.ff.length&&this.cmdLoad("gd:"+a.ff[0]):"open"===a.cmd?a.ff&&a.ff.length&&this.cmdLoad(a.ids[0]):("creategdrivefile"===a.cmd||"create"===a.cmd)&&a.ff&&this.cmdNewDiagram()},notifyInitialized:function(){var a=sessionStorage.thrIntent;a&&("string"===typeof a&&(a=
JSON.parse(a)),sessionStorage.removeItem("thrIntent"),this.autoLoad(a))},notifyUserChange:function(a){a?(a.roles&&a.roles.length?($(".thrFooter").empty(),this.sd&&this.siteLayout(),this.promoteIntervall&&clearInterval(this.promoteIntervall)):this.promoteIntervall=setInterval(function(){sfsGUI.promote()},6E4),this.setInitState("userOk",!0)):this.notifyServerError()},notifySystemMsg:function(a){this.notifyCollabEvent(void 0,{chatMessages:[a]})},notifyServerError:function(){thrDatastore.stopCollaboration();
1!==thr0.signoutMode&&thrUI.dialog.show(sfsGUI.ntx.serverConnLost,function(){o.location.href=thr0.makeUrl()},0,sfsGUI.ntx.serverConnLostHint);this.cmdClose()},notifyBeforeFileStoreChange:function(a){this.mc.file&&this.mc.file.uuid===a&&this.cmdClose()},promote:function(){this.promoIx=(this.promoIx+1)%this.ntx.promoTexts.length;$("#sfsPromote").text(this.ntx.promoTexts[this.promoIx])},cmdNewDiagram:function(){var a,b=this.fileCreateLimit(),c=this,d=thr0.getUserInfo();d.fileCount>=b||thrUI.fileNewDialog.show(sfsGUI.ntx.createNewDiag,
sfsGUI.ntx.createIn,0,function(b){c.$workingArea.focus();b.uuid&&delete b.uuid;a=new ThrFile($.extend(b,{name:b.name,path:b.path.join("/"),userId:d.id,editor:{id:-1,userId:d.id,dispName:d.dispName}}));a.metaRevs.forEach(function(a){a.dt=new Date;a.userId=d.id;a.userName=d.dispName});thrDatastore.createFile(a,!0,function(b){thr0.notifyUserCreatedFile();a.uuid=b.uuid;a.editor=b.editor;a.loader=thrDatastore;a.initLoadedRevSlices();c.setGuiDiagram(a)})});thrUI.dialog.checkShowCreateRestriction("diagrams",
d.fileCount,b)},cmdOpenDiagram:function(){thrUI.fileOpenDialog.show(sfsGUI.ntx.openADiag,function(a){a&&sfsGUI.cmdLoad(a)})},cmdLoad:function(a){this.$workingArea.focus();this.cmdClose();thrUI.hourglass.show(this.$workingArea);thrDatastore.getEditor(a,function(b){thrDatastore.getHead({uuid:a,editor:b},!0,function(a){a.editor=b;a.loader=thrDatastore;sfsGUI.setGuiDiagram(a);thrUI.hourglass.hide(sfsGUI.$workingArea)})})},cmdClose:function(){this.mc.file&&this.mc.closeFile()},cmdRenameCurrent:function(){var a=
this.mc.file;if(a){var b=thrDatastore.ntx.rename;thrUI.dialog.show(b,function(b){b=b.name+(/.sankey+$/.test(b.name)?"":".sankey");thrDatastore.renameFile(a,b);sfsGUI.notifyRenameDiagram(a.uuid,b)},[b,thrUI.ntx.cancel],_h.div(b+" '"+a.name+"'","thrDlgText")+_h.div(thrDatastore.ntx.newName+": "+_h.inp({"class":"thrDlgResult","data-prop":"name",size:"30",value:a.name})))}},cmdManageDiagrams:function(){thrUI.fileManageDialog.show(sfsGUI.ntx.manageDiags,sfsGUI.fileCreateLimit(),function(a){a&&sfsGUI.cmdLoad(a)},
function(a,b){sfsGUI.notifyRenameDiagram(a,b)},function(a){sfsGUI.notifyDeleteDiagram(a)})},cmdSaveRevisionCopy:function(a){var b=thr0.getUserInfo(),c=this.fileCreateLimit(),d=this.mc.file;b.fileCount>=c||thrUI.fileNewDialog.show(sfsGUI.ntx.saveRevCopy,sfsGUI.ntx.saveIn,sfsGUI.ntx.copyOf+" "+d.name,function(c){var f=void 0!==a.history||!d.metaSesRevs.length,g=f?a.history:a.done,f=f?"metaRevs":"metaSesRevs",g=void 0!==g?thr0.indexOfSorted(d[f],"pos",g):d[f].length-1;if(0<=g){var g=d[f][g],h=d.getMainData(!0);
h.name=c.name;h.path=c.path.join("/");c="gd:"!==h.path.slice(0,3)?thr0.generateThrID(b.id):void 0;h[f]=[g.gId?{pos:g.pos}:{pos:g.pos,gId:g.gId}];thrDatastore.copyTo(h,c,function(a){a?(sfsGUI.showSaveSuccess(sfsGUI.ntx.saveRevCopy,h.name,a.uuid),thr0.notifyUserCreatedFile()):thrUI.dialog.show(sfsGUI.ntx.saveRevCopy,0,0,_h.div(sfsGUI.ntx.copyFailed+": '"+h.name+"'!"))})}});thrUI.dialog.checkShowCreateRestriction("diagrams",b.fileCount,c)},cmdRemoveRevision:function(a){var b=this.mc,c=b.file;thrUI.dialog.show(sfsGUI.ntx.removeRev,
function(){thrDatastore.removeRevision(c,a,function(a){c.applySyncDelRevs(b,a)})},[sfsGUI.ntx.remove,thrUI.ntx.cancel],_h.div("1 "+sfsGUI.ntx.confirmRemoveRevs,"thrDlgText"))},cmdRemoveOlderRevisions:function(a){var b=this,c=b.mc.file;thrUI.dialog.show(sfsGUI.ntx.removeOlderRevs,function(){thrDatastore.removeOlderRevisions(c,a,function(a){c.applySyncDelRevs(b.mc,a);b.sd.activeRev||b.setReadonlyStatus()})},[sfsGUI.ntx.remove,thrUI.ntx.cancel],_h.div(c.getRevNo(a)-1+" "+sfsGUI.ntx.confirmRemoveRevs,
"thrDlgText"))},showSaveSuccess:function(a,b,c){thrUI.dialog.show(a,function(a){a.cmd===sfsGUI.ntx.openDiag&&sfsGUI.cmdLoad(c)},[sfsGUI.ntx.openDiag,thrUI.ntx.ok],_h.div(sfsGUI.ntx.saveSuccess+" '"+b+"'."))},setReadonlyStatus:function(a,b,c,d){var e,f=this.ntx,g=this.mc.file,h=!g||2===g.editor.userRight;g?a?(!h&&b?(e=[_h.tag("p",f.revision+":\x3cbr /\x3e"+a),_h.btn(f.saveRevCopy,{"class":"thrAccent",style:"margin-bottom: 10px;",onclick:"sfsGUI.cmdSaveRevisionCopy("+JSON.stringify(b)+");"})],void 0!==
b.history&&(g.metaRevs[g.metaRevs.length-1].pos!==b.history&&e.push(_h.btn(f.removeRev,{onclick:"sfsGUI.cmdRemoveRevision("+JSON.stringify(b)+");"})),g.metaRevs[0].pos!==b.history&&e.push(_h.btn(f.removeOlderRevs,{onclick:"sfsGUI.cmdRemoveOlderRevisions("+JSON.stringify(b)+");"})))):e=[a],h=!0):h?e=[_h.tag("p",f.sharedView)]:g.metaRevs.length>=this.fileCreateLimit()&&(h=!0,e=[_h.tag("p",f.revLimitReached),_h.btn(f.clearRevs,{onclick:"sfsGUI.cmdRemoveOlderRevisions("+JSON.stringify({history:g.metaRevs[g.metaRevs.length-
1].pos})+");"}),_h.upgradeBtn()]):e=[_h.tag("p",f.welcomeToSfs),_h.btn(f.newDiag,{"class":"thrAccent",onclick:"sfsGUI.cmdNewDiagram();"}),_h.btn(f.openADiag,{"class":"thrAccent",onclick:"sfsGUI.cmdOpenDiagram();"}),_h.btn(f.closeApp,{href:thr0.makeUrl("thx.html"),style:"margin-top: 10px;"})];sfsEditorUI.setReadonly(this.sd,h,e?e.join(""):void 0,!g||c,d);this.updateCmdEnableState()},setGuiDiagram:function(a){var b=this;this.mc.openFile(a);this.mc.getObjsRevision([{type:"Diagram",id:1},{type:"Userform",
id:1},{type:"Scenarioenv",id:1}],void 0,function(){b.notifyFileChange({file:a,hint:"open"})})},cmdSaveRevision:function(){0>this.disabledCmds.indexOf("undo")&&(thrDatastore.saveRevision(this.mc.file),thr0.notify("notifyFileChange",{file:this.mc.file}),this.$workingArea.focus())},cmdImport:function(){var a,b,c=sfsGUI.ntx.uploadFile,d=thr0.getUserInfo(),e=this.fileCreateLimit();d.fileCount>=e?thrUI.dialog.checkShowCreateRestriction("diagrams",d.fileCount,e):(a=$(_h.div("\x3cinput type\x3d'file' id\x3d'sfsFileUpload' accept\x3d'.sankey'/\x3e")).css("display",
"none").appendTo("body"),b=a.find("input"),b.change(function(){var e=sfsGUI.ntx,g=b[0].files[0];a.remove();if(g.name.match(/.sankey$/i)){var h=new FileReader;h.onload=function(){thrUI.fileNewDialog.show(c,e.uploadTo,g.name,function(a){thrDatastore.importFile(a.name,thr0.generateThrID(d.id),a.path,h.result,function(a){sfsGUI.showSaveSuccess(c,g.name,a.uuid)},function(){thrUI.dialog.show(c,0,0,_h.div(e.uploadFailData1+" '"+g.name+"' "+e.uploadFailData2))})})};h.readAsDataURL(g)}else thrUI.dialog.show(e.uploadFile,
0,0,_h.div(e.uploadFailExt1+" '"+g.name+"' "+e.uploadFailExt2))}),b.click())},cmdExport:function(){var a,b;a=this.mc.file.name.replace(/[^.]+$/,"");var c=sfsGUI.ntx,d=["sankey","svg","png","jpg","pdf"],e=[0,"Scalable Vector Graphics","Portable Network Graphics","Joint Photographic Experts Group","Portable Document Format"],f=[c.fmtSankey,c.fmtSvg,c.fmtPng,c.fmtJpg,c.fmtPdf],g=[c.fmtHintSankey,c.fmtHintSvg,c.fmtHintPng,c.fmtHintJpg,c.fmtHintPdf];thrUI.initGDrive();a=thrUI.dialog.show(c.export_,function(a){var b=
a.dest?"gd:"+(a.gdFolderId||""):void 0,e=function(){thrUI.message.show(a.dest?c.gExportMsg:c.downloadMsg,!0,3E3);sfsGUI.cmdDoExport(d[a.fmt],[1,1.875][a.res],b)};"gd:"===b?thrDatastore.getOAuthToken(e):e()},[thrDatastore.ntx.download,thrUI.ntx.cancel],_h.table(0,[[[_h.tag("h2",a+d[1],{"class":"thrFilename","data-rawname":a,style:"text-align: right; margin: 10px; color: #a9bf04;"}),{colspan:2}]],[[_h.tag("h5",c.fmt+":"),{width:"100px"}],[thrUI.ihtml("optionGroup",{"class":"thrDlgResult",options:d.join(","),
prop:"fmt",value:"1"}),{width:"400px"}]],[_h.tag("h5",c.res+":"),thrUI.ihtml("optionGroup",{"class":"thrDlgResult",options:c.screenRes+","+c.printRes,prop:"res",value:"0"})],[_h.tag("h5",c.dest+":"),thrUI.ihtml("optionGroup",{"class":"thrDlgResult",options:thrDatastore.ntx.download+","+c.expToGD,prop:"dest",value:"0"})],["",""],[[_h.div(" ",{style:"height: 10px;"}),{colspan:2}]],[_h.span(d[1],{"class":"thrFmtShort",style:"font-weight: bold;'"}),[_h.span(e[1]+"\x3c/br\x3e"+f[1],"thrFmt"),{width:"400px"}]],
[[_h.tag("p",g[1],{"class":"thrFmtHint",style:"padding: 15px 5px;"}),{width:"500px",colspan:2}]]]),!0);b=a.find("table\x3etbody");b.find("\x3etr\x3etd\x3eh5").css({"text-align":"right",margin:"10px 5px"}).parent().css("vertical-align","middle");b.find("\x3etr:nth-child(2) .thrOptionGroup\x3espan").css("min-width","40px");b.find("\x3etr:nth-child(3) .thrOptionGroup\x3espan").css("min-width","120px");b.find("\x3etr:nth-child(4) .thrOptionGroup\x3espan").css("min-width","100px");thrUI.$GPickerButton(thrDatastore.ntx.selGdFolder,
!0).appendTo(b.find("\x3etr:nth-child(5)").addClass("thrNoDisplay").find("\x3etd:last-child")).css({display:"inline-block","margin-left":"0"}).click(function(){thrUI.selGdFolderClick(b,thrDatastore.ntx.selFolder+" '"+b.find(".thrFilename").text()+"'")});b.find("\x3etr:nth-child(7), \x3etr:nth-child(8)").css("background-color","#fff").first().find("\x3etd").css("padding","15px 5px").first().css("text-align","center");thrUI.dialog.center(a.find("\x3e.thrDialog"));b.change(function(a){switch(a.prop){case "fmt":var c=
b.find(".thrFilename"),j=a.value;c.text(c.data("rawname")+d[j]);b.find(".thrFmtShort").text(d[j]);b.find(".thrFmt").html((e[j]?e[j]+"\x3c/br\x3e":"")+f[j]);b.find(".thrFmtHint").text(g[j]);break;case "dest":thrUI.setElementDisplay(b.find("\x3etr:nth-child(5)"),a.value),b.closest(".thrDialog").find("\x3e.thrDlgButtons .thrButton.thrAccent").text($(a.target).find("\x3espan:nth-child("+(a.value+1)+")").text())}thr0.breakEvent(a)})},cmdDoExport:function(a,b,c){var d,e="file rawFile diagram sessionRevs undoDiffs mathEnv".split(" ").indexOf(a);
this.$workingArea.focus();0<=e?(1<e?d=2===e?this.sd.diagram:4>=e?this.mc.file[a]:this.mc.mathEnv.ctxTree:(d=new ThrFile(this.mc.file.getData()),d.metaSesRevs.length&&d.mergeSessionRevsToRevision(),d.metaRevs.length||d.metaRevs.push(new ThrMetaRevision({pos:0,userId:0,userName:"SankeyFlowShow"})),d.mergeRevisions(),d=d.getData(),e&&(delete d.userId,delete d.editor,delete d.path,d.metaRevs[0].userId=0,d.metaRevs[0].userName="SankeyFlowShow",d.metaRevs[0].dt=(new Date).toJSON())),thrDatastore.exportFile(c,
this.mc.file.getSuffixedName("."+a+".txt"),d)):"sankey"===a?c?(d=this.mc.file.getMainData(!0),d.path=c,thrDatastore.copyTo(d)):thrDatastore.downloadFile(this.mc.file.uuid,this.mc.file.name):this.sd.asSvgText("pdf"===a?1:b,function(d){thrDatastore.exportFile(c,sfsGUI.mc.file.getSuffixedName("."+a),d,a,"pdf"===a&&1<b)})},cmdPublish:function(){this.checkFuncAvail("publish")&&sfsGUI.publicationDialog.show()},cmdPrint:function(){this.sd.diagram&&this.sd.asSvgText(1,function(a){var b=o.open("","_blank");
b.document.writeln(a);b.document.close();b.print();b.close()})},cmdNewItem:function(){this.$workingArea.focus();sfsEditorUI.createItem(this.sd)},triggerKeydown:function(a){this.sd.diagram&&!sfsEditorUI.isReadonly(this.sd)&&this.$workingArea.focus().trigger($.Event("keydown",a))},cmdZIndex:function(a){this.$workingArea.focus().trigger($.Event("keydown",{keyCode:0>a?40:38,shiftKey:10===Math.abs(a),altKey:!0}))},cmdUndo:function(){this.$workingArea.focus();if((!sfsEditorUI.isReadonly(this.sd)||sfsEditorUI.findInReadonlyHint(this.sd,
".sfsScenarioView").length)&&0>this.disabledCmds.indexOf("undo"))this.mc.undo(),this.siteLayout()},cmdRedo:function(){this.$workingArea.focus();if((!sfsEditorUI.isReadonly(this.sd)||sfsEditorUI.findInReadonlyHint(this.sd,".sfsScenarioView").length)&&0>this.disabledCmds.indexOf("redo"))this.mc.redo(),this.siteLayout()},resetPaintFormat:function(a){this.savedFormat=void 0;(a||$(".thrPaintFormat")).removeClass("thrSelected")},cmdPaintFormat:function(a){if(a.hasClass("thrSelected"))this.resetPaintFormat(a);
else{var b=this.sd.selectedObjects();b&&b.length&&void 0!==b[0].getFormat?(this.savedFormat=b.reduce(function(a,b){return b.getFormat?a?thrRevisioning.diffOp.objectUnion(a,b.getFormat(!0)):b.getFormat(!0):a},0)||void 0,a.addClass("thrSelected")):thrUI.showHint(a,sfsGUI.ntx.selObjBeforeFuncHint)}},cmdPaintToDefault:function(a){var b=this.sd.selectedObjects();!b.length||!(b[0]instanceof SfsItem)&&!(b[0]instanceof SfsConnection)?thrUI.showHint(a,sfsGUI.ntx.selObjBeforeFuncHint):(this.mc.paintToDefault(this.sd.diagram,
b[0]),thrUI.showHint(a,sfsGUI.ntx.paintedMsg))},cmdEffectsStandby:function(a){this.sd.effectsStandby=a.toggleClass("thrSelected").hasClass("thrSelected");this.sd.render()},cmdSetProps:function(a){var b=this.sd.selectedObjects();0<b.length&&(b[0]instanceof SfsItem&&thr0.hasKey(a,["x","y","width","height"])?sfsEditorMC.applySetCoordinates(this.sd,b,a):(a.hasOwnProperty("shape")&&thrRevisioning.contextOp.resolvePathProp(b,"hiddenShape")&&(a.hiddenShape=!1),sfsEditorMC.applySetProps(this.sd,b,a)),b[0]instanceof
SfsDiagram&&thr0.hasKey(a,["width","height"])&&this.siteLayout())},cmdSetCombiIn:function(a){sfsEditorMC.applySetCombi(this.sd,this.sd.selectedObjects(),!0,a)},cmdSetCombiOut:function(a){sfsEditorMC.applySetCombi(this.sd,this.sd.selectedObjects(),!1,a)},cmdCombiOrder:function(a){var b=this.sd.selectedObjects();if(1===b.length&&b[0]instanceof SfsItem){var c=sfsGUI.ntx,d=b[0],e=this.sd,f=!a;a=e.diagram.getItemConPoints(d.id,f);(f?d.combiIn:d.combiOut)?e.getItemCombiInfo(d,f,a):(f&&a.reverse(),a.forEach(function(a,
b){void 0===a.ord&&(a.ord=b)}),a.sort(function(a,b){return a.ord-b.ord}));a=_h.div(_h.tag("p",c.conOrdHint,{"class":"thrDlgResult","data-prop":"changed","data-value":"false"})+_h.div(a.map(function(a){return _h.div(_h.span("",{"class":"thrColorRect",style:"background-color: "+thrColors.colorStringToCssColor(a.con.color)+";"})+_h.span(a.con.name||a.con.idName()),{"data-value":a.pt.port,style:"padding: 5px;"})}).join(""),{"class":"thrInitControl thrDlgResult","data-control":"orderbox","data-prop":"ord"}),
{style:"max-width: 500px;"});thrUI.dialog.show(c.conOrder+" "+(f?"IN":"OUT"),function(a){if(a.changed){var b={id:d.id};b[f?"inputs":"outputs"]=a.ord.map(function(a,b){return{port:a,ord:b}});e.mc.applyDiff(e.diagram.objSpec(),{items:[b]})}},1,a,!0).find(".thrDlgBody").change(function(a){$(a.currentTarget).find("p").data("value",!0)})}},layoutToolClick:function(a){var b=$(a.target).closest(".thrIconButton").data("funcno");thr0.breakEvent(a);void 0!==b&&$(a.currentTarget).trigger($.Event("change",{func:"cmdLayout",
value:b}))},cmdLayout:function(a){sfsEditorMC.applyItemLayout(this.sd,this.sd.selectedObjects(),a)},cmdSetOpacity:function(a,b){sfsEditorMC.applySetOpacity(this.sd,this.sd.selectedObjects(),a,b)},cmdAddConTag:function(a){var b=thr0.filterArrayByType(this.sd.selectedObjects(),SfsConnection);b.length&&(sfsEditorMC.applyAddTag(this.mc,this.sd.diagram,b,a),this.$workingArea.focus())},cmdGroup:function(){var a=thr0.filterArrayByType(this.sd.selectedObjects(),SfsItem);a.length&&(!a[0].groups||a.some(function(a,
c){return c&&(!a.groups||a.groups.split(",").pop()!==this.g)},{g:a[0].groups.split(",").pop()}))&&sfsEditorMC.applyGroupItems(this.mc,this.sd.diagram,a)},cmdUngroup:function(){var a=thr0.filterArrayByType(this.sd.selectedObjects(),SfsItem);a.length&&(a=a.reduce(function(a,c){c.groups&&thr0.pushIfNEx(a,c.groups.split(",").pop());return a},[]),a.length&&sfsEditorMC.applyUngroupItems(this.mc,this.sd.diagram,a))},cmdApplyMBorder:function(){sfsEditorMC.applyMagneticBorder(this.mc,this.sd.diagram,this.sd.selectedObjects(),
this.sd)},cmdShowWizard:function(a){if(this.checkFuncAvail("showWizard")){var b=this;this.wizards.show(a,b.sd.diagram.dispUnit,function(c){sfsEditorMC["applyWiz"+["IOItem","IOCon","Comparison","DrillDown","MeshedCols"][a]](b.mc,b.sd.diagram,c)})}},cmdShare:function(){var a=sfsGUI.ntx;this.mc.file&&this.mc.file.uuid&&"gd:"===this.mc.file.uuid.slice(0,3)?thrUI.dialog.show(a.extStore,0,0,a.extStoreHint):this.mc.file.shareInfos?this.mc.file.isEditorOwner()?thrUI.fileShareDialog.show(a.shareDiag,this.mc.file.uuid,
this.mc.file.shareInfos):thrUI.dialog.show(a.notOwner,0,0,a.notOwnerHint):thrUI.dialog.show(a.localStore,0,0,a.localStoreHint)},cmdSendChatMsg:function(a,b){if(this.mc&&this.mc.file&&""!==a){var c=this.mc.file.editor,d=thrColors.cssColorFromNumber(c.id,0);thrDatastore.sendChatMsg(c,_h.tag("strong",c.dispName+": ",{style:"color: "+d+";"})+_h.span(a,{"class":b?"sfsUrgent":void 0,style:"color: "+d+";"}))}},navVisibility:function(a){var b=$("#SITE_NAVIGATION"),c=$("#SITE_MAIN\x3e.thrButtonBar\x3e.thrIconHistory");
(a=void 0===a?!c.hasClass("thrSelected"):a)?(c.addClass("thrSelected"),b.removeClass("thrCollapsed")):(c.removeClass("thrSelected"),b.addClass("thrCollapsed"),this.sd.activeRev&&this.showRevision());this.renderRevisionHistory(a);this.siteLayout();this.$workingArea.focus()},setSideBar:function(a){var b=$("#SITE_SIDEBAR"),c=$("#SITE_MAIN\x3e.thrButtonBar\x3eli.thrRight");thr0.notifyActivity();c.filter(".thrSelected").removeClass("thrSelected");if(a){var d=c.filter(".thrIcon"+thr0.firstCharToUpperCase(a)).removeClass("thrBlinkingBack").addClass("thrSelected");
b.find("h1").find("\x3espan:first-child").html(d.attr("title")).data("ntx",d.data("ntx1"));this.updateSidebar(a)}b.hasClass("thrCollapsed")!==!a&&(thrUI.setElementDisplay(c.filter(".thrIconDArrRight"),a),a?b.removeClass("thrCollapsed"):b.addClass("thrCollapsed"),this.siteLayout(),this.$workingArea.focus())},uiCmdZoom:function(a){thr0.notifyActivity();this.sd.zoom(a);sfsEditorUI.renderSelection(this.sd);this.siteLayout();this.$workingArea.focus()},ask:function(a,b,c){if("connectVal"===a)return a=this.sd.diagram.dispUnit,
thrUI.dialog.showValueQuestion(sfsGUI.ntx.connect,b,void 0,sfsGUI.ntx.value,(void 0!==c?c:0)/thrUnits.getFactor(a),a),!0},adjustToFile:function(){var a=this.mc.file;$("#SITE_NAVIGATION");var b=$("#SITE_HEADER .thrSubject"),c=b.find(".thrDlgClose");$("#SITE_MAIN\x3e.thrButtonBar\x3e.thrIconHistory").hasClass("thrSelected")&&this.navVisibility(!1);this.$workingArea.focus();this.editors=void 0;this.chatMessages=[];$(".sfsCollabSummary, .sfsCollabOnline, .sfsCollabChat").text("");this.showShareInfos();
b.find("span").text(a?a.name:this.ntx.subtitle);a?c.length||b.append(_h.div("x",{"class":"thrDlgClose",title:sfsGUI.ntx.closeDiag,onclick:"sfsGUI.cmdClose();"})):c.remove();this.resize();this.notifySelect(this.sd);this.setReadonlyStatus();a&&(thrDatastore.startCollaboration(a,function(a,b,c){sfsGUI.notifyCollabEvent(a,b,c)}),thr0.isLicensed("cloudStore")||a.loadlazyRevList(0,function(){sfsGUI.setReadonlyStatus()}))},getWrapInfoDiff:function(a,b){if(this.sd.diagram===a)return this.sd.getWrapInfoDiff(a,
b)},notifyFileChange:function(a){var b,c,d=this,e="initShowRev"===a.hint;if(this.mc.file===a.file){if("open"===a.hint)this.sd.setDiagram(1,void 0,function(){d.adjustToFile()});else if(!e)try{this.sd.fileChanged(a),sfsEditorUI.isReadonly(this.sd)&&sfsEditorUI.findInReadonlyHint(this.sd,".sfsScenarioView").length&&this.refreshScenarioReadOnlyHint(!0)}catch(f){c={history:a.file.metaRevs[f].pos},a.file.isHeadRevision(c)&&(c=void 0),this.sd.setDiagram(1,c),b=!0}this.updateCmdEnableState();a=$("#sfsDoneHistory").parent();
a.is(":visible")&&(e||this.renderRevisionHistory(!0),b&&this.setReadonlyStatus(c?a.parent().find(".thrSelected").html():void 0,c));this.savedFormat&&this.resetPaintFormat();this.notifySelect(this.sd)}a=$(".sfsParamDialog");a.length&&this.paramDialog.refresh(a.find(".thrDialog"))},notifyFileClosed:function(){this.sd&&this.sd.setDiagram(1,{clear:!0},function(){sfsGUI.adjustToFile()});this.updateSidebar()},notifySelect:function(a){var b=this.savedFormat;if(b){var c=a.selectedObjects(),d={items:[],connections:[]};
c&&c.forEach(function(a){if(a.getFormat){var c=thrRevisioning.diffOp.objectUnion(b,a.getFormat(!0),function(a,b){return a!==b});c&&!$.isEmptyObject(c)&&(c.id=a.id,a instanceof SfsItem?d.items.push(c):a instanceof SfsConnection?d.connections.push(c):a instanceof SfsLegend&&(d.legend=c))}});this.resetPaintFormat();this.mc.applyDiff(a.diagram.objSpec(),d)}sfsGUI.updateSidebar()},notifyRenameDiagram:function(a,b){this.mc.file&&this.mc.file.uuid===a&&(this.mc.file.name=b,$("#SITE_HEADER .thrSubject\x3espan").text(b))},
notifyDeleteDiagram:function(a){this.mc.file&&this.mc.file.uuid===a&&this.mc.closeFile()},notifyApplyError:function(){thrUI.dialog.show(this.ntx.notApplicable,0,0,this.ntx.notApplicableHint);this.notifySelect(this.sd)},updateSidebar:function(a){var b=$("#SITE_SIDEBAR\x3ediv");if(b.length){var c=this.sd.selectedObjects(),d=thr0.getThrClsName(c),e=$("#SITE_SIDEBAR\x3eh1\x3espan:last-child");if(d){a=a||b.data("formtype");var f="data"===a&&/^diagram$/i.test(d);/^(design|data)$/i.test(a)?e.html(": "+thr0.getThrClsCaption(c)):
e.empty();if(!this.keepDataDgrm||!f)thrUI.form.setHtml(b,a,d,"design"===a?this.designTab:void 0);b.data("formtype",a).data("cls",f?"dgrm":d);"share"===a?this.showShareInfos():"shortcuts"!==a&&thrUI.form.fill(b,b.data("ctx"),function(a,b){return sfsGUI.getValue(a,b)},function(a,b){return sfsGUI.getGridValues(a,b)})}else e.empty(),a&&b.data("formtype",a),b.empty().removeData("cls")}},getValue:function(a,b){var c,d;if("mathEnv"===b&&"selection"!==a)return"userform"===a.substring(0,8)?this.sd.getUserformValue(a):
this.sd.getMEnvValue(a);".."===a.substring(0,2)?(d=[this.sd.diagram],a=a.substring(2)):d=this.sd.selectedObjects();c=thrRevisioning.contextOp.resolvePathProp(d,a);return!c&&1===d.length&&(d=d[0],(d instanceof SfsConnection||d instanceof SfsDiagram)&&"name"===a||d instanceof SfsItem&&"text.tx"===a)?d.idName():c},getGridValues:function(a){var b=this.sd.selectedObjects(),c="get"+thr0.firstCharToUpperCase(a);return 1!==b.length?sfsGUI.ntx.multipleValues:b[0][c]?b[0][c](this.sd.getMathEnv(),this.sd.diagram):
b[0][a]},getDiagramDataForm:function(){var a=sfsGUI.ntx,b=thrUI.ntx,c=this.sd,d=c.getUserform(),e={width:"28px"};return _h.table(0,[["\x3ch5 data-prop\x3d'selection'\x3e\x3c/h5\x3e",[_h.iconBtn(41,{title:a.params,onclick:"sfsGUI.editParameters();"}),e],[_h.iconBtn(48,{title:a.editForm,onclick:"sfsGUI.editUserform();"}),e],[_h.iconBtn(49,{title:a.scenarios,onclick:"sfsGUI.toggleScenarioView();"}),e]]])+d.getHtml(0,{mEnv:c.getMathEnv(),ctx:[sfsIdPrefix.prefixedId(c.diagram)]},void 0,this.savedDiagramFormExpdTables)+
(d.content.length?_h.div(_h.div(_h.iconBtn(100,{title:b.copyToClipboard,onclick:'sfsGUI.clpbrdImEx("userform", true);'})+_h.iconBtn(101,{title:b.pasteFromClipboard,onclick:'sfsGUI.clpbrdImEx("userform", false)'}),{style:"display: inline-block; margin: 5px; float: right;"})):"")},editParameters:function(){this.checkFuncAvail("mathFormulas")&&this.paramDialog.show()},editUserform:function(){if(sfsEditorUI.isReadonly(this.sd))this.showMsg(0);else if(this.checkFuncAvail("userform")){var a,b=this,c={mEnv:this.sd.getMathEnv(),
ctx:this.sd.ctx},d=new ThrUserform(JSON.parse(JSON.stringify(this.sd.getUserform())));thrUserformEditor.show(d,c,function(d){d.isAuto?b.mc.applyDiff(d.objSpec(),"_DELETE_"):(b.sd.cachedAutoUF=void 0,b.mc.applyChangedObject(d.objSpec(),d));(a=b.sd.getScenarioenv(!0))&&b.sd.getUserform().initScenarioenv(c,a)})}},savDiagramDataFormSettings:function(a){this.savedDiagramFormExpdTables=a.find(".thrTreeTable:not(.thrCollapsed)\x3ethead\x3etr\x3eth").map(function(){return $(this).text()}).get()},clpbrdImEx:function(a,
b){if("userform"===a){var c=this.sd;thrUI.dialog.showImExport({sd:c,uf:c.getUserform(),mInfo:{mEnv:c.getMathEnv(),ctx:c.ctx,diagram:c.diagram,sc:c.activeSc?c.getScenarioenv().getScenario(c.activeSc.scId):void 0},getExString:function(a){return this.uf.getExString(this.mInfo,a)},setFromExString:function(a,b){var c=this.uf.getMValDiff(this.mInfo,a,b);this.sd.applyMVals(c.mvals,c.diff);sfsGUI.showImErr(c.err,b.sep)}},b)}},showImErr:function(a,b){a.length&&thrUI.dialog.show(thrUI.ntx.pasteFromClipboard,
0,0,_h.tags(["p","strong"],this.ntx.errImportLines)+_h.tag("p",a.map(function(a){return a.name+(a.val?b+a.val.join(b):"")}).join("\x3cbr/\x3e")))},toggleScenarioView:function(){sfsEditorUI.isReadonly(this.sd)&&!sfsEditorUI.findInReadonlyHint(this.sd,".sfsScenarioView").length?this.showMsg(0):this.checkFuncAvail("scenarios")&&this.refreshScenarioReadOnlyHint(!sfsEditorUI.isReadonly(this.sd))},refreshScenarioReadOnlyHint:function(a){var b=this.sd,c=b.getScenarioenv(),d=_h.table(0,[[[sfsGUI.ntx.scenarios,
{style:"padding: 8px; color: #defa14; font-size: larger; font-weight: bold; text-align: center;"}],[_h.div("+",{"class":"thrCharButton",tabindex:"0",onclick:"sfsGUI.addScenario();"}),{style:"padding-left: 6px;"}],[_h.div("\u00d7",{"class":"thrCharButton",tabindex:"0",onclick:"sfsGUI.toggleScenarioView();"}),{style:"padding-left: 6px;"}]]],{style:"width: 100%;"});this.setReadonlyStatus(a?d+c.getScenarioSelHtml(b.activeSc?c.getScenario(b.activeSc.scId):c.getBaseScenario()):void 0,void 0,!0,"sfsScenarioView");
if(a){a=sfsEditorUI.findInReadonlyHint(this.sd,".sfsScenarioView").change(function(a){sfsGUI.activateScenario(a.value.closest("li").data("scid"))});a.find(".thrDelButton").mousedown(function(a){a.stopPropagation()}).click(function(a){thr0.breakEvent(a);sfsGUI.removeScenario($(a.currentTarget).closest("li").data("scid"))});thrUI.initControls(a);for(a=a.find(".thrSelected").closest(".thrTreenode");a.length;)a.removeClass("thrCollapsed"),a=a.parent().closest(".thrTreenode")}else b.activeSc&&this.activateScenario()},
addScenario:function(){var a=this,b=this.sd.getScenarioenv(!0),c=!b;c&&(b=this.sd.getScenarioenv());b.addScenarioDialog(function(d){c?a.mc.applyChangedObject(b.objSpec(),b):(b.removeScenario(d.id),a.mc.applyDiff(b.objSpec(),{scenarios:[JSON.parse(JSON.stringify(d))]}));a.activateScenario(d.id);a.refreshScenarioReadOnlyHint(!0)})},removeScenario:function(a){var b=this.sd.getScenarioenv();this.sd.activeSc&&this.sd.activeSc.scId===a&&this.activateScenario();this.mc.applyDiff(b.objSpec(),2>=b.scenarios.length&&
b.getScenario(a)?"_DELETE_":{scenarios:[{delIds:[a]}]});this.refreshScenarioReadOnlyHint(!0)},activateScenario:function(a){var b=this.sd.getScenarioenv();a=void 0===a?b.getBaseScenario():b.getScenario(a);this.sd.activateScenario(!a||a.isBase?void 0:a.id);sfsGUI.updateSidebar()},getSelectedConPtInfos:function(){var a=thr0.filterArrayByType(this.sd.selectedObjects(),SfsConnection);return 1===a.length?sfsEditorMC.getConPtInfos(this.mc.mathEnv,this.sd.ctx,a[0]):void 0},notifyFormChange:function(a,b,c,
d,e){var f={},g=this;if("mathEnv"===a)return this.keepDataDgrm=!0,a=this.sd.handleMEnvChange(b,d),this.keepDataDgrm=!1,a;if("designTab"===c)this.designTab=d;else{if("setOpacity"===c)return this.cmdSetOpacity(b,thrColors.getOpacity(d));if(c)return this[c](d);if(e)f[b]=d,this.setGridProps(f);else if("viewMode"===b&&1===d&&20<this.sd.diagram.maxConWidth)thrUI.dialog.showValueQuestion(sfsGUI.ntx.changeViewMode,function(a){f[b]=d;f.maxConWidth=parseInt(a.val,10);g.cmdSetProps(f)},void 0,sfsGUI.ntx.conWidth,
8,"px");else if("calcType"===b)sfsEditorMC.applySetItemCalcType(this.sd,$.isArray(a)?a:this.sd.selectedObjects(),d);else return"dispUnit"===b?d=thrUnits.getCaseSensitiveUnit(d):"textPos"===b?2<=d&&5>=d&&(f["text.hAlign"]=2===d?2:4===d?0:1,f["text.vAlign"]=3===d?2:5===d?0:1):"shape"===b?(delete d.title,f.avoidNoLine=d.lineGraphic?!0:"_DELETE_"):"line.style"===b&&(f.avoidNoLine="_DELETE_"),f[b]=d,this.cmdSetProps(f)}},setGridProps:function(a){var b=this.sd.selectedObjects();if(1===b.length){var c,d=
b[0];for(c in a)a.hasOwnProperty(c)&&(b=a[c],this.mc.applyDiff(this.sd.diagram.objSpec(),d["getDiff"+thr0.firstCharToUpperCase(c)](this.sd.getMathEnv(),this.sd.diagram,b.rowid,b.prop,b.value)))}},showConDataDlg:function(){sfsEditorUI.conDataDialog.show(this.getValue("name"),this.sd,this.getSelectedConPtInfos(),function(){sfsGUI.showMsg(1)})},showMsg:function(a,b){var c=sfsGUI.ntx,c=[{t:c.readOnly,msg:c.readOnlyHint},{t:c.autoCalcVal,msg:c.autoCalcValHint},{t:c.requiredPt,msg:c.requiredPtHint}],d=
0<=a&&a<c.length;if(d){var e=c[a].msg;b&&b.forEach(function(a,b){e=e.replace("#sfs"+(b+1),a)});thrUI.dialog.show(c[a].t,0,0,e)}return d},formChangesAllowed:function(a,b,c,d,e){if("mathEnv"===a&&!this.sd.activeRev)return this.mc.mathEnv.canChange(b.split("."));if(sfsEditorUI.isReadonly(this.sd)&&(!sfsEditorUI.findInReadonlyHint(this.sd,".sfsScenarioView").length||"userform"!==b.substring(0,8)))return!this.showMsg(0);a=$.isArray(a)?a:this.sd.selectedObjects();c=a[0]instanceof SfsDiagram;if(e){if(/^(inports|outports)$/.test(b)&&
!sfsEditorMC.isPortChangeAllowed(this.mc.mathEnv,this.sd.ctx,a,d)||/^(producers|consumers)$/.test(b)&&!sfsEditorMC.isConValChangeAllowed(this.mc.mathEnv,this.sd.ctx,a,d))return!this.showMsg(1)}else if(c&&/^(width|height|hideSfsBrand)$/.test(b)||"calcType"===b){if("hideSfsBrand"===b)return this.checkFuncAvail("hideBrand");if("calcType"===b){if(!this.checkFuncAvail("logicalDependencies"))return!1;if(!sfsEditorMC.isCalcTypeChangeAllowed(this.mc.mathEnv,this.sd.ctx,a,d))return!this.showMsg(1)}else if(/^(width|height)$/.test(b))return this.checkFuncAvail("diagSize")}return!0},
startEditItemData:function(a){var b=this.sd.selectedObjects();if(1===b.length&&b[0]instanceof SfsItem&&"value"===a.gridprop&&this.mc.mathEnv.formulaOf(this.sd.ctx,[b[0].mathId(),a.rowid]))return this.editParameters(),!0},startEditConData:function(a){var b=this.sd.selectedObjects(),c=sfsEditorMC.getPtPath(this.mc.mathEnv,this.sd.ctx,b[0],a.rowid);if(1===b.length&&b[0]instanceof SfsConnection&&"value"===a.gridprop&&this.mc.mathEnv.formulaOf(this.sd.ctx,c))return c.length&&"b"===c[0].charAt(0)&&(sfsEditorUI.select(this.sd,
{items:[parseInt(c[0].slice(1),10)]}),this.editParameters()),!0},showShareInfos:function(){var a=$("#SITE_SIDEBAR\x3ediv");if("share"===a.data("formtype")){var b=this.mc&&this.mc.file?this.mc.file.shareInfos:void 0,b=b?b.accessInfos:void 0,c=sfsGUI.ntx,d=a.find(".sfsCollabChat").empty();a.find(".sfsCollabSummary").text(b?1>=b.length?c.notShared:c.sharedWith1+" "+(b.length-1)+" "+c.sharedWith2:"("+c.extStore+")");a.find(".sfsCollabOnline").html(this.editors?_h.span(this.editors.map(function(a){return a.dispName}).join(", ")):
"");d.length&&(this.chatMessages.forEach(function(a){a=_h.tag("p",a);0<$(a).appendTo(d).find(".sfsUrgent").length&&(thrUI.endAction(void 0,!0),thrUI.dialog.show(c.urgentMsg,0,0,a))}),d.scrollTop(d[0].scrollHeight))}},notifyCollabEvent:function(a,b,c){var d=this.mc.file;!d&&a||d&&a&&d.uuid!==a||("string"===$.type(b)?sfsEditorUI.setReadonly(this.sd,!0,b):(thrUI.action&&(a=thrUI.action.conflictTestObj,(b.metaRevs||b.metaSesRevs&&a&&d.hasSesRevConflict([a],b.objs))&&thrUI.endAction(void 0,!0)),b.shareInfos&&
(d.shareInfos=b.shareInfos),b.editors&&(this.editors=b.editors),b.chatMessages&&(a=$("#SITE_MAIN\x3e.thrButtonBar\x3eli.thrIconShare"),!c&&!a.hasClass("thrSelected")&&a.addClass("thrBlinkingBack"),this.chatMessages=this.chatMessages.concat(b.chatMessages)),(b.shareInfos||b.editors||b.chatMessages)&&this.showShareInfos(),b.retryRev&&(b.retryRev.meta=void 0,d.applyFileRev(this.mc,b.retryRev),d.addSessionRev(b.retryRev),thr0.notify("notifyFileChange",{file:this.mc.file}),this.showRevision()),b.metaRevs&&
(d.applySyncRevisions(this.mc,new ThrFile(b),b.mergedSessionRevPos),this.showRevision()),b.metaSesRevs&&d.applySyncSessionRevs(this.mc,new ThrFile(b)),b.delRevs&&d.applySyncDelRevs(this.mc,b.delRevs),void 0!==b.rollbackPos&&(d.rollbackSessionRevs(this.mc,b.rollbackPos),thr0.notify("notifyFileChange",{file:this.mc.file}))))},paramDialog:{show:function(){var a=sfsGUI.sd,b=a.diagram.dispUnit,c=sfsGUI.ntx,d=sfsEditorUI.ntx,e=a.selectedObjects(),f=thrUI.dialog.create(c.params,2).addClass("sfsParamDialog").find(".thrDialog"),
g=f.find(".thrDlgBody"),e=1===e.length&&e[0]instanceof SfsItem?e[0]:a.diagram;f.change(function(a){sfsGUI.paramDialog.change(a)}).click(function(a){sfsGUI.paramDialog.click(a)}).on("getMathEnv",function(a){a.mEnv=sfsGUI.mc.mathEnv});g.append(thrUI.ihtml("dropdownSelect",{prop:"ctx",style:"width: 400px; margin-bottom: 6px;"})+this.paramTableHtml(c.params,b)+_h.table(void 0,[[c.cons,thrUI.ihtml("dropdownSelect",{prop:"calcType",options:[d.cmodeAuto,d.cmodeFixed,d.cmodeRatio,d.cmodeIO,d.cmodeOI,d.cmodeUser,
d.cmodeMixed],values:[0,5,2,3,4,1,6]}),_h.div(_h.span(c.scale),{"class":"sfsScale",style:"padding: 0 0 0 20px;"}),_h.inp({"class":"sfsScale",style:"width: 50px;"})+_h.div()]],{"class":"sfsCalcType",style:"margin: 10px 0 5px auto; border-spacing: 0;"})+this.ioTableHtml(c.inputs,"sfsInput",b)+this.ioTableHtml(c.outputs,"sfsOutput",b));thrUI.initControls(g);g.find("\x3etable:not(.sfsCalcType)").css("width","690px").each(function(){thrUI.treeTable.create($(this))});this.fill(f,e)},refresh:function(a){this.fill(a,
this.currentObj(a))},fill:function(a,b){function c(a,b){return a.name===b.name?0:a.name<b.name?-1:1}var d,e,f,g=sfsIdPrefix.diagram+sfsGUI.sd.diagram.id;d=a.find("\x3e.thrDlgBody\x3e.sfsCalcType");var h=b.getInports(sfsGUI.mc.mathEnv,sfsGUI.sd.diagram,!0),i=b.getOutports(sfsGUI.mc.mathEnv,sfsGUI.sd.diagram,!0);h.pop();i.pop();this.setContext(a.find(".thrDropdownSelect[data-prop\x3d'ctx']"),b,sfsGUI.sd);b instanceof SfsItem?(thrUI.dropdownSelect.fill(d.removeClass("thrNoDisplay").find(".thrDropdownSelect"),
b.calcType),g+="."+b.mathId(),f=d.find(".sfsScale"),2===b.calcType?(e=g.split("."),d=sfsGUI.mc.mathEnv.valueOf(e,[sfsIdPrefix.scale]),e="(#auto)"===sfsGUI.mc.mathEnv.formulaOf(e,[sfsIdPrefix.scale],!0),f.parent().removeClass("thrNoDisplay"),f=f.filter("input").val(thr0.formatLocalFloat(d)+(e?" (#auto)":"")),e?f.attr("readonly","readonly"):f.removeAttr("readonly")):f.parent().addClass("thrNoDisplay")):d.addClass("thrNoDisplay");a.data("ctx",g);h.sort(c);i.sort(c);this.addParamRows(a.find(".thrParams\x3etbody"),
g,b);this.addIOrows(a.find(".sfsInput\x3etbody"),g,b,h);this.addIOrows(a.find(".sfsOutput\x3etbody"),g,b,i);a.find(".sfsOutput .thrAutoDropdown").addClass("thrAbove");thrUI.dialog.center(a.css("height","").css("width",""))},currentObj:function(a){a=a.data("ctx").split(".");return 1>=a.length?sfsGUI.sd.diagram:sfsGUI.sd.diagram.getItem(parseInt(a[1].slice(1),10))},setContext:function(a,b,c){var d=c.diagram.items.map(function(a){return{tx:a.text.tx?thr0.firstLine(a.text.dispText(c.attrs).tx):a.idName(),
id:a.id}},c).sort(function(a,b){return a.tx<b.tx?-1:a.tx>b.tx?1:0});d.unshift({tx:thrMath.ntx.rootType,id:-1});thrUI.dropdownSelect.setOptions(a.data("ids",d.map(function(a){return a.id}).join(",")),d.map(function(a){return a.tx}));thrUI.dropdownSelect.fill(a,b instanceof SfsItem?thr0.indexOfKey(d,"id",b.id):0)},paramTableHtml:function(a){return _h.table([[a,{colspan:4}]],[[[_h.div(_h.btn(sfsGUI.ntx.addParam,{"data-func":"addParam"})),{colspan:2}],"",""]],"thrParams")},ioTableHtml:function(a,b,c){return _h.table([[a,
{colspan:"4"}]],[["",this.totalCell(c),"",""]],"thrIOs "+b)},addParamRows:function(a,b,c){var d,e,f,g=sfsIdPrefix.filterExtRef(),h=a.find("\x3etr:last-child");a.find("\x3etr:not(:last-child)").addClass("thrInvalid");c.params.forEach(function(c){d=c.unit||"";e=a.find("\x3etr[data-id\x3d'"+c.id+"']");e.length?(f=e.find(".sfsParamName"),f.is(":focus")||f.val(c.name),f=e.find(".thrAutoComplete"),f.data("unit",d),f.find("input").is(":focus")||thrUI.mathAutoComplete.fill(f),f=e.find(".thrUnit"),f.is(":focus")||
f.val(d),e.removeClass("thrInvalid"),e=e.next(),f=e.find(".sfsParamComment"),f.is(":focus")||f.val(c.comment||""),e.removeClass("thrInvalid")):(e=$(_h.tableRow([_h.inp({"class":"sfsParamName",value:c.name,style:"width: 116px;"}),_h.div("",{"class":"thrInitControl","data-control":"mathAutoComplete","data-prop":"val","data-mathctx":b+"."+sfsIdPrefix.parameter+c.id,"data-mfilter":g,"data-unit":d}),_h.inp({"class":"thrUnit",placeholder:sfsGUI.ntx.unit,value:d}),[_h.delBtn({"data-func":"removeParam"}),
{style:"width: 70px; padding: 3px 0 0 0;"}]],!1,{"data-id":c.id})).insertBefore(h),thrUI.initControls(e),e=$(_h.tableRow(["",[_h.inp({"class":"sfsParamComment",placeholder:sfsGUI.ntx.comment,value:c.comment||""}),{colspan:"2"}]])).insertBefore(h),thrUI.initControls(e))});a.find(".thrInvalid").remove()},addIOrows:function(a,b,c,d){var e,f,g=0,h=sfsIdPrefix.filterExtRef(),i=sfsEditorUI.ntx,j=2===c.calcType?sfsIdPrefix.scale:void 0,k=a.find("\x3etr:last-child"),l=k.find(".thrUnit").text();a.find("\x3etr:not(:last-child)").addClass("thrInvalid");
d.forEach(function(d){var n=6===c.calcType,p=n&&void 0!==d.calcType?d.calcType:2>c.calcType?c.calcType:5===c.calcType?2:0;g+=d.value*thrUnits.getConversion(d.unit,l);e=a.find("\x3etr[data-id\x3d'"+d.id+"']");e.length?(e.find("td:first-child").text(d.name),f=e.find(".thrAutoComplete"),f.data("mscale",2===c.calcType?sfsIdPrefix.scale:""),f.find("input").is(":focus")||thrUI.mathAutoComplete.fill(f),f.data("unit",d.unit),f=e.find(".thrUnit"),f.is(":focus")||f.val(d.unit),d=e.find(".thrDropdownSelect"),
thrUI.dropdownSelect.fill(d,p),thrUI.setElementDisplay(d,n),e.removeClass("thrInvalid")):(p=[[d.name,{style:"width: 130px;"}],_h.div("",{"class":"thrInitControl","data-control":"mathAutoComplete","data-prop":"val","data-mathctx":b+"."+d.id,"data-mscale":j,"data-mfilter":h,"data-unit":d.unit}),_h.inp({"class":"thrUnit",value:d.unit}),[thrUI.ihtml("dropdownSelect",{prop:"ioCt",options:[i.cmodeSAuto,i.cmodeSFixed,i.cmodeSUser],values:[0,2,1],value:p,style:"width: 60px;"}),{style:"width: 64px;"}]],e=
$(_h.tableRow(p,!1,{"data-id":d.id})).insertBefore(k),thrUI.initControls(e),n||e.find(".thrDropdownSelect").addClass("thrNoDisplay"))});a.find(".thrInvalid").remove();k.find(".thrTotal").text(thr0.formatLocalFloat(g))},totalCell:function(a){return[sfsGUI.ntx.total+": "+_h.span("0","thrTotal")+" "+_h.span(a,"thrUnit"),{style:"text-align: right; font-weight: bolder;"}]},getValTitle:function(a){a=a.closest("tr").find("td:first-child");var b=a.find("input");return b.length?b.val():a.text()},change:function(a){function b(a,
b,c){var d,e={};a=a.closest("tr");d=a.data("id");a.closest("table").hasClass("thrIOs")?(a="i"===d.charAt(0)?"inputs":"outputs",d={port:parseInt(d.slice(1),10)}):(a="params",d={id:parseInt(d,10)});d[b]=c;e[a]=[d];return e}function c(a,b,c){c.data("preventchange","1");thrUI.dialog.show(a,function(){c.find("input").focus();c.removeData("preventchange")},0,b)}var d,e,f,g;g=$(a.target);d=sfsGUI.sd.diagram;var h=sfsGUI.mc.mathEnv,i=g.closest(".thrDialog"),j=this.currentObj(i);if(0<g.closest(".thrDlgBody").length)if(e=
g.data("prop"),a.stopPropagation(),"ctx"===e)i.find(".thrParams\x3etbody\x3etr:not(:last-child), .sfsInput\x3etbody\x3etr:not(:last-child), .sfsOutput\x3etbody\x3etr:not(:last-child)").remove(),a.value?(g=g.data("ids").split(","),j=d.getItem(parseInt(g[a.value],10))):j=d,this.fill(i,j);else if(g.hasClass("sfsParamName"))this.doApplyDiff(j,b(g,"name",g.val()));else if(g.hasClass("thrUnit"))this.doApplyDiff(j,b(g,"unit",g.val()));else if(g.hasClass("sfsParamComment"))this.doApplyDiff(j,b(g.closest("tr").prev(),
"comment",g.val()));else if(g.hasClass("thrAutoComplete"))if(i=sfsGUI.ntx,f=g.data("mathctx").split("."),e=f.slice(0,f.length-1),h.canChangeStructure(f.slice(0,f.length-2),{fix:[f.slice(f.length-2)]}))if(a.value.hasOwnProperty("v"))this.doApplyDiff(j,b(g,"val",a.value.v));else if(a.err=!0,d=a.value.op,d.err)a=a.value.tx,void 0!==d.ix&&(a=a.slice(0,d.ix)+_h.span(a.slice(d.ix,d.ix2),"thrError")+(d.ix2?a.slice(d.ix2):"")),c(i.invalidMathExpr,_h.tags(["p","strong"],d.err)+_h.tag("p",a),g);else if(h.hasCircle(f,
void 0,d))c(i.formulaNotApp,_h.tag("p",_h.tag("strong",i.circularRef)+" "+a.value.tx),g);else try{this.doApplyDiff(j,b(g,"val",d.toString(h,e))),a.err=!1}catch(k){c(i.formulaNotApp,_h.tag("p",k),g)}else c(i.autoDepCalc,_h.tag("p",_h.tag("strong",this.getValTitle(g)+" "+i.unchangable)+i.autoDepCalcHint),g),a.err=!0;else"ioCt"===e?(f=g.closest("tr").find(".thrAutoComplete").data("mathctx"))&&h.canChange(f.split("."))?this.doApplyDiff(j,b(g,"calcType",a.value)):(sfsGUI.showMsg(1),a.err=!0):"calcType"===
e&&(sfsGUI.formChangesAllowed([j],"calcType",void 0,a.value,!1)?sfsGUI.notifyFormChange([j],"calcType",void 0,a.value,!1):a.err=!0)},click:function(a){var b=$(a.target);if(!b.hasClass("thrDlgTitle")&&!b.closest(".thrDlgButtons").length&&(a.stopPropagation(),a.preventDefault(),a=b.data("func")))this[a](b)},doApplyDiff:function(a,b){a instanceof SfsItem&&(b.id=a.id,b={items:[b]});sfsGUI.mc.applyDiff(sfsGUI.sd.diagram.objSpec(),b)},addParam:function(a){var b;b=1;for(var c="New",d=this.currentObj(a.closest(".thrDialog"));0<=
thr0.indexOfKey(d.params,"name",c);)c="New"+ ++b;b=thr0.maxOfArray(d.params,"id",0)+1;this.doApplyDiff(d,{params:[{id:b,name:c,val:0}]});a.closest("tbody").find("\x3etr[data-id\x3d'"+b+"']\x3etd:first-child\x3einput").focus().select()},removeParam:function(a){var b=this,c=a.closest(".thrDialog"),d=sfsGUI.ntx,e=this.currentObj(c),f=parseInt(a.closest("tr").data("id"),10);a=c.data("ctx").split(".");a.push(sfsIdPrefix.parameter+f);sfsGUI.mc.mathEnv.isReferenced([a])?thrUI.dialog.show(d.delRefParam,function(){b.doApplyDiff(e,
{params:[{delIds:[f]}]})},3,_h.tags(["p","strong"],d.delRefParamHint)+_h.tag("p",d.delRefHint2)):this.doApplyDiff(e,{params:[{delIds:[f]}]})}},publicationDialog:{show:function(){if(0>sfsGUI.disabledCmds.indexOf("undo")){var a=this,b=sfsGUI.ntx;thrUI.dialog.show(b.publishTitle,function(c){c.cmd===b.saveRev&&sfsGUI.cmdSaveRevision();a.showDlg()},[b.saveRev,b.continue_,thrUI.ntx.cancel],b.unsavedChangesHint)}else this.showDlg()},showDlg:function(){var a=sfsGUI.ntx,b={colspan:"3",style:"text-align: left;"},
b=[[[_h.tag("strong",sfsGUI.mc.file.name,{style:"font-size: larger;"})]],[["",{"class":"thrTdRevisions",style:"width: 260px;"}],["",{style:"min-width: 100px;"}],[_h.btn(a.publish,{"class":"thrBnPublish"}),{style:"width: 210px;"}]],[a.pubTabForm,thrUI.ihtml("optionGroup",{"class":"thrCbTabForm",options:a.visible+","+a.hidden,value:0}),""],[a.pubTabScenarios,thrUI.ihtml("optionGroup",{"class":"thrCbTabScenarios",options:a.visible+","+a.hidden,value:0}),""],[a.pubTabMore,thrUI.ihtml("optionGroup",{"class":"thrCbTabMore",
options:a.visible+","+a.hidden,value:0}),""],[["",{colspan:"3",style:"height: 30px;"}]],[[_h.tag("strong",a.pubStatus),{colspan:"3",style:"height:25px;background-color:#444;text-align:center;color:#fff;"}]],[[_h.tag("strong",a.loading+" ","thrStatusInfo")+_h.tag("strong",""),{colspan:2,style:"text-align: left;"}],""],[[_h.span(a.pubDate+": ")+_h.span(""),b]],[[_h.span(a.link+": ")+_h.span(),b]],[[a.pubSample,b]],[[_h.tag("textarea","",{readonly:"readonly",style:"width:98%; height: 100px; font-family: Courier,monospace;"}),
{colspan:3}]]],c=thrUI.dialog.show(a.publishTitle,0,2,_h.table(0,b,"thrLayoutTable"),!0);c.find(".thrBnPublish").click(function(a){sfsGUI.publicationDialog.publish($(a.target).closest(".thrDlgBack"))});sfsGUI.mc.file.loadlazyRevList(0,function(b){var e=c.find(".thrTdRevisions");b=b.metaRevs.map(function(b){return a.revision+" "+b.pos+": "+(b.dt?thr0.formatDateTime(new Date(b.dt)).replace(/,/g," -"):a.unknownDate)}).reverse();e=$(_h.div("",{"data-options":b.join(","),"data-value":"0",style:"width:280px;"})).appendTo(e.empty()).change(function(a){thr0.breakEvent(a)});
thrUI.dropdownSelect.create(e)});thrDatastore.getPublicationInfos(sfsGUI.mc.file.uuid,function(a){sfsGUI.publicationDialog.refreshInfos(c,a)})},refreshInfos:function(a,b){var c=sfsGUI.ntx,d=0<=b.revPos,e=a.find(".thrStatusInfo").empty(),f=thr0.strToPojo(b.meta);e.append(d?c.published+": "+c.revision+" "+b.revPos+" ("+thr0.formatDateTime(new Date(b.revDt))+")":c.unpublished+".");e=e.closest("td").next().empty();d&&$(_h.div(c.unpublish,"thrButton")).appendTo(e).click(function(a){sfsGUI.publicationDialog.unpublish($(a.target).closest(".thrDlgBack"))});
e=e.closest("tr").next().find("td\x3espan:last-child").empty();d&&e.append(thr0.formatDateTime(new Date(b.dt)));e=e.closest("tr").next().find("td\x3espan:last-child").empty();d&&(c=b.url,e.append(_h.tag("a",c.substring(0,20)+"..."+c.substring(c.length-20),{href:b.url,target:"_blank"})));e=a.find("table textarea");e.val(d?'\x3cdiv style\x3d"width: '+f.width+'px; margin: 50px auto; border: 1pt solid #a9bf04;"\x3e\x3ciframe src\x3d"'+b.url+'" width\x3d"'+f.width+'" height\x3d"'+f.height+'" style\x3d"border: none;"\x3e\x3c/iframe\x3e\x3c/div\x3e':
"");thrUI.dialog.center(a.find(".thrDialog"))},publish:function(a){function b(a,b){thrUI.hourglass.show(a.find(".thrDialog"));thrDatastore.publish(b,function(b){b&&sfsGUI.publicationDialog.refreshInfos(a,b);thrUI.hourglass.hide(a)})}function c(a){return 0===thrUI.optionGroup.getValue(a)}var d=sfsGUI.mc.file,e={width:sfsGUI.sd.diagram.width,height:sfsGUI.sd.diagram.height,autoSize:!0,filePath:thrDatastore.getFilePath(d),showFormTab:c(a.find(".thrCbTabForm")),showScenariosTab:c(a.find(".thrCbTabScenarios")),
showMoreTab:c(a.find(".thrCbTabMore"))},f=d.metaRevs[d.metaRevs.length-1-thrUI.dropdownSelect.getValue(a.find(".thrTdRevisions\x3ediv"))],g={uuid:d.uuid,gId:f.gId,revPos:f.pos,revDt:f.dt,meta:JSON.stringify(e)};!e.showFormTab&&!e.showScenariosTab&&!e.showMoreTab?sfsGUI.sd.asSvgText(1,function(c){g.data=c;g.url="svg";b(a,g)}):b(a,g)},unpublish:function(a){thrUI.hourglass.show(a.find(".thrDialog"));thrDatastore.unpublish(sfsGUI.mc.file.uuid,function(b){b&&sfsGUI.publicationDialog.refreshInfos(a,b);
thrUI.hourglass.hide(a)})}},wizards:{show:function(a,b,c){var d=this,e=sfsGUI.ntx,f=thrUI.dialog.create([e.wizIO,e.wizProdCon,e.wizCompare,e.wizDrillDown,e.wizMeshed][a],[e.create,thrUI.ntx.cancel]).data("wizno",a).data("unit",b),g=f.find(".thrDialog"),h=g.find(".thrDlgBody");thrUI.setTempData(f,"callback",c);g.change(function(a){sfsGUI.wizards.change(a)}).click(function(a){sfsGUI.wizards.click(a)});switch(a){case 0:case 1:h.append(this.wizHeadHtml(a,b,e.untitled)+this.ioTableHtml("IN",b)+this.ioTableHtml("OUT",
b));h.find("\x3etable").each(function(){thrUI.treeTable.create($(this));d.addIORow($(this))});break;case 2:h.append(this.wizHeadHtml(a,b)+this.ioTableHtml(e.alternative+" 1",b)+this.ioTableHtml(e.alternative+" 2",b));thrUI.optionGroup.create($(_h.tableRow([_h.span(e.compare),_h.div("",{style:"margin-bottom: 5px;","data-options":e.inputs+","+e.outputs,"data-value":1})])).prependTo(h.find(".thrWizHead\x3etable\x3etbody")).find("div"));h.find("\x3etable").each(function(){thrUI.treeTable.create($(this));
$(_h.tableRow([[_h.inp({value:[e.benchmark,e.myData][$(this).index()-1],style:"width: 230px;"}),{colspan:"2"}],""])).insertBefore($(this).find("\x3etbody\x3etr:last-child"));d.addIORow($(this))});break;case 3:h.append(this.wizHeadHtml(a,b)+this.treeNodeeHtml(0,b));h.find(".thrDelButton").remove();h.find("\x3etable").each(function(){thrUI.treeTable.create($(this));d.addIORow($(this))});break;default:h.append(this.wizHeadHtml(a,b)+_h.table(0,[[this.colTableHtml(1,b)+_h.btn(e.addCol)+_h.btn(e.removeLastCol),
this.colTableHtml(2,b)]],"thrColumnLayout")),h.find("\x3etable\x3etbody\x3etr\x3etd\x3etable").each(function(){thrUI.treeTable.create($(this))}),this.addColTableEntry(g,1,"A1"),this.addColTableEntry(g,1,"A2"),this.addColTableEntry(g,2,"B1"),this.addColTableEntry(g,2,"B2")}h.find("input").first().focus().select();thrUI.dialog.center(g)},click:function(a){var b,c,d,e=this;b=$(a.target);d=b.closest(".thrItem");c=b.hasClass("thrButton")&&!b.closest(".thrDlgButtons").length;var f=b.hasClass("thrDelButton"),
g=b.closest(".thrDialog"),h=g.parent().data("wizno");if(c||f)c&&b.hasClass("thrNode")?(d=$(_h.tableRow([[this.treeNodeeHtml(b.closest("table").data("level")+1,g.parent().data("unit")),{colspan:"3"}]])).insertBefore(b.closest("tr")),c=d.find("table"),thrUI.treeTable.create(c),c.find("\x3etbody\x3etr\x3etd\x3einput").focus().select(),this.addIORow(c)):c&&4===h?(c=b.closest("table"),c.hasClass("thrColumnLayout")?1===b.index()?(d=b.closest("td"),b=d.parent().children().length+1,d=$(_h.tag("td",this.colTableHtml(b,
g.parent().data("unit")))).appendTo(d.parent()),c=d.find("table"),thrUI.treeTable.create(c),this.addColTableEntry(g,b,sfsGUI.ntx.untitled),c.find("\x3etbody\x3etr\x3etd\x3etable\x3etbody\x3etr:first-child\x3etd\x3einput").focus().select()):b.closest("td").parent().find("\x3etd:last-child").remove():(b=this.addColTableEntry(g,c.closest("td").index()+1,sfsGUI.ntx.untitled).find("input"),b.length&&$(b[0]).focus().select())):c&&2===h?(c=g.find(".thrTreeTable"),e.addIORow(c.first()).find("\x3etd:first-child input").focus().select(),
e.addIORow(c.last())):c?this.addIORow(b.closest("table")).find("\x3etd:first-child input").focus().select():f&&4===h?(c=d.closest("table"),c.closest("td").next().find("\x3etable\x3etbody\x3etr\x3etd\x3etable\x3etbody\x3etr:nth-child("+(d.index()+2)+")").remove(),d.remove(),c.find(".thrItem\x3etd\x3etable\x3ethead\x3etr\x3eth").each(function(){$(this).text(sfsGUI.ntx.item+" "+($(this).closest(".thrItem").index()+1))})):f&&2===h?(c=g.find(".thrTreeTable"),c.find("\x3etbody\x3etr:nth-child("+(b.closest("tr").index()+
1)+")").remove(),c.each(function(){e.setTotal($(this))})):(c=this.findLevel0Table(b),b.hasClass("thrNode")?b.closest("table").remove():b.closest("tr").remove(),this.setTotal(c)),thrUI.dialog.center(g),thr0.breakEvent(a)},change:function(a){var b=$(a.currentTarget).parent(),c=$(a.target),d=b.data("unit"),e=b.data("wizno");a.stopPropagation();if(a.dlgCmd===sfsGUI.ntx.create){if(d=thrUI.getTempData(b,"callback"))(a=this.createData(b))&&d(a);thrUI.dialog.close(b)}else if(0<=[thrUI.ntx.cancel,thrUI.ntx.close].indexOf(a.dlgCmd))thrUI.dialog.close(b);
else if(c.hasClass("thrUnit")){a=c.val().trim();if(thrUnits.isConvertible(d,a)){var f=thrUnits.getConversion(d,a);b.find(".thrValue").each(function(){var a=$(this);a.val(thr0.parseLocalFloat(a.val())*f)});b.find(".thrTotal").each(function(){var a=$(this);a.text(thr0.parseLocalFloat(a.text())*f)})}b.data("unit",a);b.find("tspan.thrUnit").text(a)}else 4===e&&!c.next().hasClass("thrUnit")?c.closest(".thrItem").closest("td").next().find("\x3etable\x3etbody\x3etr\x3etd\x3etable\x3etbody\x3etr:nth-child("+
(c.closest(".thrItem").index()+2)+")\x3etd:first-child").text(c.val().trim()):2===e&&!c.hasClass("thrValue")&&0<c.closest("tr").index()?b.find(".thrTreeTable\x3etbody\x3etr:nth-child("+(c.closest("tr").index()+1)+")\x3etd:first-child\x3einput").val(c.val().trim()):c.hasClass("thrValue")&&(c.val(thr0.formatLocalFloat(thr0.parseLocalUnitFloat(c.val(),d)*thrUnits.getFactor(d))),this.setTotal(this.findLevel0Table(c)))},wizHeadHtml:function(a,b,c){b=[["Unit",_h.inp({value:b,"class":"thrUnit",style:"width: 107px;"})]];
void 0!==c&&b.unshift(["Name",_h.inp({value:c,style:"width: 150px;"})]);return _h.div(_h.span("",{"class":"sfsWizImage",style:"background-position: 0 -"+100*a+"px;"})+_h.table(0,b,{style:"float: right; margin-top: 32px;"}),"thrWizHead")},ioTableHtml:function(a,b){return _h.table([[a,{colspan:"3"}]],[[_h.btn(sfsGUI.ntx.add),this.totalCell(b),""]])},addIORow:function(a){return $(_h.tableRow([_h.inp({value:"untitled",style:"width: 230px;"}),_h.tag("label",sfsGUI.ntx.value)+" "+_h.inp({value:"0","class":"thrValue"})+
" "+_h.span(a.closest(".thrDlgBack").data("unit"),"thrUnit"),_h.delBtn()])).insertBefore(a.find("\x3etbody\x3etr:last-child"))},treeNodeeHtml:function(a,b){return _h.table([[sfsGUI.ntx.level+" "+a,{colspan:"3"}]],[[[_h.tag("label",sfsGUI.ntx.levelName,{style:"font-weight: bolder;"})+" "+_h.inp({value:sfsGUI.ntx.untitled,style:"width: 144px;"})],["",{colspan:"2"}]],[_h.div(_h.btn(sfsGUI.ntx.add)+_h.btn(sfsGUI.ntx.addLevel,"thrNode")),this.totalCell(b),_h.delBtn({title:sfsGUI.ntx.removeLevel,"class":"thrNode"})]],
{"data-level":a})},totalCell:function(a){return[sfsGUI.ntx.total+_h.span("0","thrTotal")+" "+_h.span(a,"thrUnit"),{style:"text-align: right; font-weight: bolder;"}]},colTableHtml:function(a){var b={colspan:"3"};return _h.table([[sfsGUI.ntx.column+" "+a,b]],[[[_h.btn(sfsGUI.ntx.add,{style:"width: 70px;"}),b]]])},colTableRowHtml:function(a,b,c,d){b=[sfsGUI.ntx.name,_h.inp({value:b,style:"width: 160px;"}),_h.delBtn()];c&&(c=c.map(function(a){return this.colSubRow(a,d)},this),c.unshift(b),c.push(["",
this.totalCell(d)]),b=[[_h.table([[sfsGUI.ntx.item+" "+a,{colspan:"3"}]],c),{colspan:"3"}]]);return _h.tableRow(b,!1,"thrItem")},colSubRow:function(a,b){return[a,_h.inp({value:"0","class":"thrValue"})+" "+_h.span(b,"thrUnit")]},findColTableEntries:function(a){return a.length?a.find("\x3etbody\x3etr:not(:last-child)").map(function(){var a=$(this).find("\x3etd\x3etable");return a.length?a.find("\x3etbody\x3etr:first-child\x3etd\x3einput").val():$(this).find("\x3etd\x3einput").val()}).get():void 0},
addColTableEntry:function(a,b,c){function d(a,b){return a.find(".thrColumnLayout\x3etbody\x3etr\x3etd:nth-child("+b+")\x3etable")}var e=this,f=a.closest(".thrDlgBack").data("unit"),g=d(a,b),h=d(a,b+1),i=this.findColTableEntries(g);h.length&&h.find("table").each(function(){$(_h.tableRow(e.colSubRow(c,f))).insertBefore($(this).find("\x3etbody\x3etr:last-child"))});a=$(this.colTableRowHtml(i.length+1,c,this.findColTableEntries(d(a,b-1)),f)).insertBefore(g.find("\x3etbody\x3etr:last-child"));b=a.find("table");
b.length&&thrUI.treeTable.create(b);return a},findLevel0Table:function(a){for(a=a.closest("table");a.data("level");)a=a.parent().closest("table");return a},setTotal:function(a){var b=0,c=this;a.find(".thrValue").each(function(){b+=thr0.parseLocalFloat($(this).val())});a.find("\x3etbody\x3etr\x3etd\x3e.thrTotal").text(thr0.formatLocalFloat(b));a.find("table").each(function(){c.setTotal($(this))})},createTreeData:function(a){var b=this,c={data:[]};a.find("\x3etbody\x3etr").each(function(){if($(this).index()){var a=
$(this).find("\x3etd\x3etable");a.length?(a=b.createTreeData(a))&&c.data.push(a):b.addIOData(c.data,$(this))}else c.name=$(this).find("\x3etd\x3einput").val()});if(c.data.length)return c},createColData:function(a){return a.get().map(function(a){return $(a).find(".thrItem").map(function(){var a=$(this).find("table");return a.length?{name:a.find("\x3etbody\x3etr:first-child input").val().trim(),vals:a.find("\x3etbody\x3etr:not(:first-child) input").map(function(){return $(this).val()}).get()}:{name:$(this).find("input").val().trim()}}).get()})},
addIOData:function(a,b){var c=b.find("\x3etd\x3einput");c.length&&a.push({name:$(c[0]).val(),val:thr0.parseLocalFloat($(c[1]).val())})},createData:function(a){var b,c,d,e=this;switch(a.data("wizno")){case 0:case 1:b={name:a.find(".thrWizHead\x3etable\x3etbody\x3etr:first-child\x3etd\x3einput").val().trim(),inputs:[],outputs:[]};d=a.find(".thrTreeTable");d.first().find("\x3etbody\x3etr").each(function(){e.addIOData(b.inputs,$(this))});d.last().find("\x3etbody\x3etr").each(function(){e.addIOData(b.outputs,
$(this))});if(!b.inputs.length&&!b.outputs.length)return;break;case 2:d=a.find(".thrTreeTable");b={isInput:!thrUI.optionGroup.getValue(a.find(".thrWizHead\x3etable\x3etbody\x3etr:first-child\x3etd\x3ediv")),names:d.map(function(){return $(this).find("\x3etbody\x3etr:first-child\x3etd\x3einput").val().trim()}).get(),valNames:[],values:[[],[]]};c=[];d.first().find("\x3etbody\x3etr:not(:first-child)").each(function(){e.addIOData(c,$(this))});c.forEach(function(a){b.valNames.push(a.name);b.values[0].push(a.val)});
if(!b.valNames.length)return;c=[];d.last().find("\x3etbody\x3etr:not(:first-child)").each(function(){e.addIOData(c,$(this))});c.forEach(function(a){b.values[1].push(a.val)});break;case 3:b=this.createTreeData(a.find(".thrDlgBody\x3etable"));break;default:b=this.createColData(a.find(".thrColumnLayout\x3etbody\x3etr\x3etd\x3etable"))}b&&(b.unit=a.data("unit"));return b}}}}})(window);